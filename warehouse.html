<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>PBK 생산창고 관리 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.7.2/umd/Recharts.js"></script>
  <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    /* 모바일 터치 최적화 */
    @media (max-width: 768px) {
      .mobile-scroll { -webkit-overflow-scrolling: touch; }
      button, input, select { font-size: 16px !important; } /* iOS 줌 방지 */
    }
    /* 스크롤바 스타일 */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// ═══ CDN 글로벌 → 로컬 변수 매핑 ═══
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// ═══ Recharts 컴포넌트 ═══
const { ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, ComposedChart, Bar, Line, Cell } = window.Recharts || {};

// ═══ Lucide 아이콘 래퍼 ═══
const makeLucideIcon = (name) => {
  return ({className, ...props}) => {
    const icon = window.lucide?.icons?.[name];
    if(!icon) return React.createElement('span', {className, ...props});
    const [tag, attrs, children] = icon;
    const svgProps = {
      xmlns: 'http://www.w3.org/2000/svg', width: 24, height: 24,
      viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor',
      strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
      className, ...props
    };
    return React.createElement('svg', svgProps,
      (children||[]).map(([cTag, cAttrs], i) => React.createElement(cTag, {key:i, ...cAttrs}))
    );
  };
};
const Package=makeLucideIcon('package'), Clock=makeLucideIcon('clock'), Warehouse=makeLucideIcon('warehouse');
const BarChart3=makeLucideIcon('bar-chart-3'), Database=makeLucideIcon('database'), Plus=makeLucideIcon('plus');
const X=makeLucideIcon('x'), Search=makeLucideIcon('search'), Filter=makeLucideIcon('filter');
const TrendingUp=makeLucideIcon('trending-up'), AlertTriangle=makeLucideIcon('alert-triangle'), Upload=makeLucideIcon('upload');
const FileSpreadsheet=makeLucideIcon('file-spreadsheet'), Save=makeLucideIcon('save'), RefreshCw=makeLucideIcon('refresh-cw');
const Scale=makeLucideIcon('scale'), Edit2=makeLucideIcon('edit-2'), Check=makeLucideIcon('check');
const Download=makeLucideIcon('download'), Play=makeLucideIcon('play'), Pause=makeLucideIcon('pause');
const Bell=makeLucideIcon('bell'), BellOff=makeLucideIcon('bell-off'), Calendar=makeLucideIcon('calendar');
const List=makeLucideIcon('list'), ChevronLeft=makeLucideIcon('chevron-left'), ChevronRight=makeLucideIcon('chevron-right');
const ChevronDown=makeLucideIcon('chevron-down'), ChevronUp=makeLucideIcon('chevron-up'), ExternalLink=makeLucideIcon('external-link');
const Thermometer=makeLucideIcon('thermometer'), Printer=makeLucideIcon('printer'), FileText=makeLucideIcon('file-text');
const Moon=makeLucideIcon('moon'), Sun=makeLucideIcon('sun'), History=makeLucideIcon('history');
const Info=makeLucideIcon('info'), Keyboard=makeLucideIcon('keyboard'), Zap=makeLucideIcon('zap');
const ArrowRight=makeLucideIcon('arrow-right'), Lightbulb=makeLucideIcon('lightbulb'), Archive=makeLucideIcon('archive');
const Box=makeLucideIcon('box');

// ═══ 메인 코드 시작 ═══
// PBK Warehouse Management System

const APP_VERSION = 'v18.2';
// lucide icons loaded from CDN
// recharts loaded from CDN
// safeStorage: localStorage 사용 가능하면 localStorage, 아니면 인메모리 대체
const safeStorage = (() => {
  try {
    localStorage.setItem('__pbk_test__', '1');
    localStorage.removeItem('__pbk_test__');
    return localStorage; // ✅ localStorage 정상 작동 → 그대로 반환 (데이터 영구 저장)
  } catch {
    // 접근 불가 환경: 인메모리 대체 (세션 내에서만 유지)
    const _data = {};
    return {
      getItem: (k) => Object.prototype.hasOwnProperty.call(_data, k) ? _data[k] : null,
      setItem: (k, v) => { _data[k] = String(v); },
      removeItem: (k) => { delete _data[k]; },
    };
  }
})();



// 과거 온습도 데이터 (2022-12 ~ 2026-02)
const HISTORICAL_TEMP_HUMIDITY_DATA = {"2022-12-01": {"temp": "24.1", "humidity": "40.1"}, "2022-12-02": {"temp": "25.4", "humidity": "39.5"}, "2022-12-05": {"temp": "24.8", "humidity": "36.4"}, "2022-12-06": {"temp": "23.9", "humidity": "25.6"}, "2022-12-07": {"temp": "23.6", "humidity": "30.9"}, "2022-12-08": {"temp": "23.6", "humidity": "28.1"}, "2022-12-09": {"temp": "23.7", "humidity": "25.1"}, "2022-12-12": {"temp": "24.8", "humidity": "24.7"}, "2022-12-13": {"temp": "25.4", "humidity": "23.5"}, "2022-12-14": {"temp": "24.7", "humidity": "22.9"}, "2022-12-15": {"temp": "25.2", "humidity": "23.7"}, "2022-12-16": {"temp": "24.9", "humidity": "22.8"}, "2022-12-19": {"temp": "23.2", "humidity": "22.4"}, "2022-12-20": {"temp": "20.2", "humidity": "14.8"}, "2022-12-21": {"temp": "23.2", "humidity": "20.1"}, "2022-12-22": {"temp": "24.6", "humidity": "19.5"}, "2022-12-23": {"temp": "22.6", "humidity": "14.4"}, "2023-01-01": {"temp": "22.8", "humidity": "16.4"}, "2023-01-02": {"temp": "22.7", "humidity": "15.7"}, "2023-01-03": {"temp": "24.8", "humidity": "16.6"}, "2023-01-04": {"temp": "24.1", "humidity": "18.6"}, "2023-01-05": {"temp": "24.6", "humidity": "22.3"}, "2023-01-09": {"temp": "25.0", "humidity": "24.2"}, "2023-01-10": {"temp": "23.2", "humidity": "28.0"}, "2023-01-11": {"temp": "23.1", "humidity": "29.0"}, "2023-01-12": {"temp": "23.4", "humidity": "30.0"}, "2023-01-13": {"temp": "22.8", "humidity": "28.0"}, "2023-01-16": {"temp": "23.1", "humidity": "32.0"}, "2023-01-17": {"temp": "22.9", "humidity": "28.0"}, "2023-01-18": {"temp": "23.4", "humidity": "26.0"}, "2023-01-19": {"temp": "24.2", "humidity": "27.0"}, "2023-01-20": {"temp": "24.1", "humidity": "26.0"}, "2023-02-13": {"temp": "23.2", "humidity": "29.8"}, "2023-02-14": {"temp": "22.8", "humidity": "32.6"}, "2023-02-15": {"temp": "22.9", "humidity": "31.4"}, "2023-02-16": {"temp": "23.5", "humidity": "34.2"}, "2023-02-17": {"temp": "22.8", "humidity": "34.5"}, "2023-02-20": {"temp": "23.6", "humidity": "35.2"}, "2023-02-21": {"temp": "23.2", "humidity": "35.5"}, "2023-02-22": {"temp": "23.4", "humidity": "35.8"}, "2023-02-23": {"temp": "21.0", "humidity": "22.9"}, "2023-02-24": {"temp": "20.8", "humidity": "27.1"}, "2023-02-27": {"temp": "22.2", "humidity": "19.8"}, "2023-02-28": {"temp": "23.2", "humidity": "24.9"}, "2023-03-02": {"temp": "22.1", "humidity": "18.2"}, "2023-03-03": {"temp": "23.8", "humidity": "24.0"}, "2023-03-06": {"temp": "23.8", "humidity": "23.1"}, "2023-03-07": {"temp": "24.6", "humidity": "33.1"}, "2023-03-08": {"temp": "22.1", "humidity": "33.8"}, "2023-03-09": {"temp": "22.1", "humidity": "42.7"}, "2023-03-10": {"temp": "22.4", "humidity": "24.7"}, "2023-03-13": {"temp": "20.4", "humidity": "24.7"}, "2023-03-14": {"temp": "23.7", "humidity": "32.7"}, "2023-03-15": {"temp": "23.0", "humidity": "32.5"}, "2023-03-16": {"temp": "23.6", "humidity": "23.0"}, "2023-03-17": {"temp": "21.8", "humidity": "18.2"}, "2023-03-20": {"temp": "23.7", "humidity": "33.1"}, "2023-03-21": {"temp": "22.7", "humidity": "26.6"}, "2023-03-22": {"temp": "22.4", "humidity": "38.2"}, "2023-03-23": {"temp": "24.3", "humidity": "38.1"}, "2023-03-24": {"temp": "27.6", "humidity": "21.2"}, "2023-03-27": {"temp": "26.6", "humidity": "22.2"}, "2023-03-28": {"temp": "28.8", "humidity": "23.2"}, "2023-03-29": {"temp": "29.2", "humidity": "22.8"}, "2023-03-30": {"temp": "30.0", "humidity": "22.7"}, "2023-03-31": {"temp": "23.3", "humidity": "26.0"}, "2023-04-03": {"temp": "23.7", "humidity": "28.5"}, "2023-04-04": {"temp": "24.2", "humidity": "26.1"}, "2023-04-05": {"temp": "23.9", "humidity": "36.5"}, "2023-04-06": {"temp": "24.1", "humidity": "35.9"}, "2023-04-07": {"temp": "23.7", "humidity": "37.5"}, "2023-04-10": {"temp": "22.9", "humidity": "40.1"}, "2023-04-11": {"temp": "22.8", "humidity": "42.7"}, "2023-04-12": {"temp": "25.4", "humidity": "30.9"}, "2023-04-13": {"temp": "28.9", "humidity": "23.9"}, "2023-04-14": {"temp": "23.7", "humidity": "42.7"}, "2023-04-17": {"temp": "24.1", "humidity": "37.7"}, "2023-04-18": {"temp": "25.3", "humidity": "39.8"}, "2023-04-19": {"temp": "24.8", "humidity": "41.4"}, "2023-04-20": {"temp": "23.9", "humidity": "40.2"}, "2023-04-21": {"temp": "24.6", "humidity": "39.9"}, "2023-04-24": {"temp": "25.4", "humidity": "40.1"}, "2023-04-25": {"temp": "24.4", "humidity": "38.7"}, "2023-04-26": {"temp": "23.8", "humidity": "40.4"}, "2023-04-27": {"temp": "25.1", "humidity": "42.1"}, "2023-04-28": {"temp": "24.2", "humidity": "36.4"}, "2023-05-08": {"temp": "23.7", "humidity": "36.0"}, "2023-05-09": {"temp": "24.1", "humidity": "37.0"}, "2023-05-10": {"temp": "24.0", "humidity": "37.0"}, "2023-05-11": {"temp": "23.6", "humidity": "38.0"}, "2023-05-12": {"temp": "23.7", "humidity": "37.0"}, "2023-05-15": {"temp": "23.4", "humidity": "41.0"}, "2023-05-16": {"temp": "23.7", "humidity": "42.0"}, "2023-05-17": {"temp": "25.0", "humidity": "41.1"}, "2023-05-18": {"temp": "25.0", "humidity": "46.0"}, "2023-05-19": {"temp": "23.8", "humidity": "42.0"}, "2023-05-22": {"temp": "23.9", "humidity": "41.0"}, "2023-05-23": {"temp": "23.7", "humidity": "42.0"}, "2023-05-24": {"temp": "24.0", "humidity": "46.0"}, "2023-05-25": {"temp": "23.9", "humidity": "42.0"}, "2023-05-26": {"temp": "24.1", "humidity": "43.0"}, "2023-05-30": {"temp": "24.2", "humidity": "42.0"}, "2023-05-31": {"temp": "24.1", "humidity": "41.0"}, "2023-06-01": {"temp": "23.4", "humidity": "42.6"}, "2023-06-02": {"temp": "24.5", "humidity": "45.9"}, "2023-06-07": {"temp": "25.0", "humidity": "43.4"}, "2023-06-08": {"temp": "25.9", "humidity": "48.4"}, "2023-06-09": {"temp": "24.8", "humidity": "47.6"}, "2023-06-12": {"temp": "24.9", "humidity": "42.6"}, "2023-06-13": {"temp": "24.8", "humidity": "43.0"}, "2023-06-14": {"temp": "24.9", "humidity": "47.3"}, "2023-06-15": {"temp": "24.6", "humidity": "46.0"}, "2023-06-16": {"temp": "24.9", "humidity": "48.2"}, "2023-06-19": {"temp": "26.2", "humidity": "45.5"}, "2023-06-20": {"temp": "25.4", "humidity": "43.0"}, "2023-06-21": {"temp": "25.0", "humidity": "51.8"}, "2023-06-26": {"temp": "26.4", "humidity": "47.7"}, "2023-06-27": {"temp": "26.1", "humidity": "52.9"}, "2023-06-28": {"temp": "25.9", "humidity": "50.6"}, "2023-06-29": {"temp": "24.9", "humidity": "49.3"}, "2023-06-30": {"temp": "24.0", "humidity": "51.1"}, "2023-07-03": {"temp": "25.4", "humidity": "50.0"}, "2023-07-04": {"temp": "25.1", "humidity": "48.3"}, "2023-07-05": {"temp": "25.1", "humidity": "49.6"}, "2023-07-06": {"temp": "24.5", "humidity": "48.9"}, "2023-07-07": {"temp": "24.4", "humidity": "49.8"}, "2023-07-10": {"temp": "25.0", "humidity": "52.4"}, "2023-07-11": {"temp": "24.1", "humidity": "46.7"}, "2023-07-12": {"temp": "24.6", "humidity": "48.2"}, "2023-07-13": {"temp": "23.3", "humidity": "51.3"}, "2023-07-14": {"temp": "22.9", "humidity": "53.2"}, "2023-07-17": {"temp": "24.6", "humidity": "54.3"}, "2023-07-18": {"temp": "24.0", "humidity": "55.2"}, "2023-07-19": {"temp": "24.7", "humidity": "53.3"}, "2023-07-20": {"temp": "24.1", "humidity": "52.1"}, "2023-07-21": {"temp": "24.9", "humidity": "50.9"}, "2023-07-24": {"temp": "25.6", "humidity": "55.8"}, "2023-07-25": {"temp": "25.0", "humidity": "51.5"}, "2023-07-26": {"temp": "24.9", "humidity": "49.6"}, "2023-07-27": {"temp": "25.4", "humidity": "53.9"}, "2023-07-28": {"temp": "25.6", "humidity": "52.6"}, "2023-07-31": {"temp": "26.5", "humidity": "52.0"}, "2023-08-01": {"temp": "26.0", "humidity": "50.0"}, "2023-08-02": {"temp": "25.7", "humidity": "58.0"}, "2023-08-03": {"temp": "26.6", "humidity": "57.0"}, "2023-08-04": {"temp": "25.3", "humidity": "55.0"}, "2023-08-07": {"temp": "27.2", "humidity": "51.4"}, "2023-08-08": {"temp": "28.1", "humidity": "54.7"}, "2023-08-09": {"temp": "26.1", "humidity": "50.3"}, "2023-08-10": {"temp": "26.0", "humidity": "52.8"}, "2023-08-11": {"temp": "25.0", "humidity": "48.6"}, "2023-08-16": {"temp": "26.9", "humidity": "47.9"}, "2023-08-17": {"temp": "25.7", "humidity": "49.9"}, "2023-08-18": {"temp": "26.6", "humidity": "50.7"}, "2023-08-21": {"temp": "25.2", "humidity": "45.0"}, "2023-08-22": {"temp": "25.4", "humidity": "51.3"}, "2023-08-23": {"temp": "25.7", "humidity": "52.7"}, "2023-08-24": {"temp": "26.0", "humidity": "52.7"}, "2023-08-25": {"temp": "25.7", "humidity": "50.4"}, "2023-08-28": {"temp": "26.0", "humidity": "52.0"}, "2023-08-29": {"temp": "25.3", "humidity": "52.8"}, "2023-08-30": {"temp": "25.4", "humidity": "51.0"}, "2023-08-31": {"temp": "25.4", "humidity": "49.1"}, "2023-09-01": {"temp": "24.0", "humidity": "42.0"}, "2023-09-04": {"temp": "26.2", "humidity": "50.0"}, "2023-09-05": {"temp": "24.7", "humidity": "46.0"}, "2023-09-06": {"temp": "24.9", "humidity": "47.0"}, "2023-09-07": {"temp": "25.1", "humidity": "45.0"}, "2023-09-08": {"temp": "24.3", "humidity": "41.0"}, "2023-09-11": {"temp": "27.0", "humidity": "46.0"}, "2023-09-12": {"temp": "26.2", "humidity": "45.7"}, "2023-09-13": {"temp": "26.2", "humidity": "48.6"}, "2023-09-14": {"temp": "25.1", "humidity": "44.0"}, "2023-09-15": {"temp": "26.1", "humidity": "48.0"}, "2023-09-18": {"temp": "26.3", "humidity": "53.0"}, "2023-09-19": {"temp": "24.4", "humidity": "47.0"}, "2023-09-20": {"temp": "24.7", "humidity": "50.0"}, "2023-09-21": {"temp": "24.1", "humidity": "47.0"}, "2023-09-22": {"temp": "24.5", "humidity": "48.0"}, "2023-09-25": {"temp": "25.3", "humidity": "39.0"}, "2023-09-26": {"temp": "25.1", "humidity": "40.0"}, "2023-09-27": {"temp": "25.0", "humidity": "40.0"}, "2023-10-04": {"temp": "25.4", "humidity": "43.5"}, "2023-10-05": {"temp": "25.0", "humidity": "43.0"}, "2023-10-06": {"temp": "26.0", "humidity": "44.0"}, "2023-10-10": {"temp": "25.5", "humidity": "43.2"}, "2023-10-11": {"temp": "24.6", "humidity": "42.5"}, "2023-10-12": {"temp": "25.2", "humidity": "41.1"}, "2023-10-13": {"temp": "25.6", "humidity": "43.3"}, "2023-10-16": {"temp": "25.4", "humidity": "43.1"}, "2023-10-17": {"temp": "25.1", "humidity": "35.8"}, "2023-10-18": {"temp": "25.5", "humidity": "36.5"}, "2023-10-19": {"temp": "25.3", "humidity": "44.2"}, "2023-10-20": {"temp": "24.9", "humidity": "37.4"}, "2023-10-23": {"temp": "24.9", "humidity": "40.1"}, "2023-10-24": {"temp": "24.7", "humidity": "43.2"}, "2023-10-25": {"temp": "24.5", "humidity": "43.7"}, "2023-10-26": {"temp": "23.9", "humidity": "47.9"}, "2023-10-27": {"temp": "24.2", "humidity": "43.6"}, "2023-10-30": {"temp": "24.9", "humidity": "38.4"}, "2023-10-31": {"temp": "24.3", "humidity": "45.0"}, "2023-11-01": {"temp": "24.9", "humidity": "50.4"}, "2023-11-02": {"temp": "25.3", "humidity": "43.0"}, "2023-11-03": {"temp": "25.2", "humidity": "48.0"}, "2023-11-06": {"temp": "25.1", "humidity": "55.3"}, "2023-11-07": {"temp": "22.8", "humidity": "34.0"}, "2023-11-08": {"temp": "24.2", "humidity": "29.6"}, "2023-11-09": {"temp": "23.8", "humidity": "31.6"}, "2023-11-10": {"temp": "23.5", "humidity": "30.6"}, "2023-11-13": {"temp": "22.9", "humidity": "24.3"}, "2023-11-14": {"temp": "23.5", "humidity": "28.8"}, "2023-11-15": {"temp": "22.2", "humidity": "30.2"}, "2023-11-16": {"temp": "21.8", "humidity": "32.6"}, "2023-11-17": {"temp": "21.5", "humidity": "31.8"}, "2023-11-20": {"temp": "20.5", "humidity": "30.9"}, "2023-11-21": {"temp": "21.1", "humidity": "29.8"}, "2023-11-22": {"temp": "21.4", "humidity": "33.7"}, "2023-11-23": {"temp": "23.4", "humidity": "37.8"}, "2023-11-24": {"temp": "23.1", "humidity": "24.1"}, "2023-11-27": {"temp": "21.6", "humidity": "26.2"}, "2023-11-28": {"temp": "21.7", "humidity": "27.1"}, "2023-11-29": {"temp": "21.9", "humidity": "20.8"}, "2023-11-30": {"temp": "21.3", "humidity": "16.4"}, "2023-12-01": {"temp": "22.5", "humidity": "23.4"}, "2023-12-04": {"temp": "22.7", "humidity": "34.9"}, "2023-12-05": {"temp": "22.1", "humidity": "34.5"}, "2023-12-06": {"temp": "21.4", "humidity": "37.9"}, "2023-12-07": {"temp": "21.9", "humidity": "37.1"}, "2023-12-08": {"temp": "22.5", "humidity": "36.7"}, "2023-12-11": {"temp": "23.0", "humidity": "46.2"}, "2023-12-12": {"temp": "24.2", "humidity": "41.6"}, "2023-12-13": {"temp": "21.9", "humidity": "37.7"}, "2023-12-14": {"temp": "22.2", "humidity": "39.7"}, "2023-12-15": {"temp": "22.0", "humidity": "44.1"}, "2023-12-18": {"temp": "20.7", "humidity": "22.9"}, "2023-12-19": {"temp": "21.5", "humidity": "27.1"}, "2023-12-20": {"temp": "23.7", "humidity": "25.4"}, "2023-12-21": {"temp": "21.7", "humidity": "20.4"}, "2023-12-22": {"temp": "22.0", "humidity": "21.1"}, "2024-01-02": {"temp": "21.2", "humidity": "36.0"}, "2024-01-03": {"temp": "21.4", "humidity": "32.0"}, "2024-01-04": {"temp": "21.5", "humidity": "33.2"}, "2024-01-05": {"temp": "20.7", "humidity": "34.5"}, "2024-01-08": {"temp": "21.2", "humidity": "27.0"}, "2024-01-09": {"temp": "21.1", "humidity": "29.0"}, "2024-01-10": {"temp": "21.0", "humidity": "29.0"}, "2024-01-11": {"temp": "21.4", "humidity": "28.1"}, "2024-01-12": {"temp": "21.2", "humidity": "27.4"}, "2024-01-15": {"temp": "21.2", "humidity": "27.3"}, "2024-01-16": {"temp": "21.4", "humidity": "28.2"}, "2024-01-17": {"temp": "22.1", "humidity": "27.4"}, "2024-01-18": {"temp": "22.4", "humidity": "24.1"}, "2024-01-19": {"temp": "21.7", "humidity": "27.2"}, "2024-01-22": {"temp": "22.8", "humidity": "25.4"}, "2024-01-23": {"temp": "21.4", "humidity": "21.4"}, "2024-01-24": {"temp": "22.1", "humidity": "22.3"}, "2024-01-25": {"temp": "22.1", "humidity": "21.2"}, "2024-01-26": {"temp": "22.3", "humidity": "20.4"}, "2024-01-29": {"temp": "21.4", "humidity": "20.2"}, "2024-01-30": {"temp": "23.1", "humidity": "29.7"}, "2024-01-31": {"temp": "23.4", "humidity": "30.2"}, "2024-02-01": {"temp": "22.0", "humidity": "25.8"}, "2024-02-02": {"temp": "21.6", "humidity": "26.3"}, "2024-02-05": {"temp": "21.2", "humidity": "28.6"}, "2024-02-06": {"temp": "21.2", "humidity": "32.6"}, "2024-02-07": {"temp": "21.7", "humidity": "29.6"}, "2024-02-08": {"temp": "21.2", "humidity": "29.9"}, "2024-02-13": {"temp": "21.3", "humidity": "30.4"}, "2024-02-14": {"temp": "20.7", "humidity": "35.2"}, "2024-02-15": {"temp": "21.1", "humidity": "43.6"}, "2024-02-16": {"temp": "21.4", "humidity": "31.9"}, "2024-02-19": {"temp": "20.2", "humidity": "39.2"}, "2024-02-20": {"temp": "21.2", "humidity": "38.7"}, "2024-02-21": {"temp": "21.6", "humidity": "36.6"}, "2024-02-22": {"temp": "19.9", "humidity": "36.6"}, "2024-02-23": {"temp": "20.6", "humidity": "34.8"}, "2024-02-26": {"temp": "20.0", "humidity": "31.3"}, "2024-02-27": {"temp": "21.1", "humidity": "31.6"}, "2024-02-28": {"temp": "21.4", "humidity": "28.3"}, "2024-02-29": {"temp": "22.0", "humidity": "30.0"}, "2024-03-04": {"temp": "21.5", "humidity": "26.2"}, "2024-03-05": {"temp": "21.8", "humidity": "23.0"}, "2024-03-06": {"temp": "19.8", "humidity": "28.0"}, "2024-03-07": {"temp": "22.2", "humidity": "26.5"}, "2024-03-08": {"temp": "22.3", "humidity": "24.6"}, "2024-03-11": {"temp": "19.2", "humidity": "26.2"}, "2024-03-12": {"temp": "22.2", "humidity": "31.4"}, "2024-03-13": {"temp": "22.1", "humidity": "30.3"}, "2024-03-14": {"temp": "23.1", "humidity": "28.4"}, "2024-03-15": {"temp": "23.0", "humidity": "30.0"}, "2024-03-18": {"temp": "21.7", "humidity": "22.6"}, "2024-03-19": {"temp": "22.2", "humidity": "22.8"}, "2024-03-20": {"temp": "22.7", "humidity": "25.1"}, "2024-03-21": {"temp": "22.8", "humidity": "21.8"}, "2024-03-22": {"temp": "21.9", "humidity": "24.1"}, "2024-03-25": {"temp": "22.5", "humidity": "31.8"}, "2024-03-26": {"temp": "23.3", "humidity": "33.0"}, "2024-03-27": {"temp": "22.4", "humidity": "35.7"}, "2024-03-28": {"temp": "21.9", "humidity": "29.4"}, "2024-03-29": {"temp": "20.0", "humidity": "30.5"}, "2024-04-01": {"temp": "23.1", "humidity": "30.0"}, "2024-04-02": {"temp": "23.4", "humidity": "26.0"}, "2024-04-03": {"temp": "23.1", "humidity": "40.0"}, "2024-04-04": {"temp": "23.0", "humidity": "39.0"}, "2024-04-05": {"temp": "23.4", "humidity": "30.0"}, "2024-04-08": {"temp": "23.2", "humidity": "31.0"}, "2024-04-09": {"temp": "23.9", "humidity": "32.3"}, "2024-04-11": {"temp": "23.5", "humidity": "38.4"}, "2024-04-12": {"temp": "24.0", "humidity": "39.4"}, "2024-04-15": {"temp": "23.6", "humidity": "41.1"}, "2024-04-16": {"temp": "23.7", "humidity": "43.1"}, "2024-04-17": {"temp": "24.5", "humidity": "39.7"}, "2024-04-18": {"temp": "24.9", "humidity": "39.8"}, "2024-04-19": {"temp": "24.8", "humidity": "34.4"}, "2024-04-22": {"temp": "24.1", "humidity": "38.1"}, "2024-04-23": {"temp": "24.4", "humidity": "37.4"}, "2024-04-24": {"temp": "23.7", "humidity": "38.2"}, "2024-04-25": {"temp": "24.0", "humidity": "39.1"}, "2024-04-26": {"temp": "23.4", "humidity": "37.2"}, "2024-04-29": {"temp": "24.7", "humidity": "38.4"}, "2024-04-30": {"temp": "24.1", "humidity": "39.9"}, "2024-05-02": {"temp": "25.3", "humidity": "37.4"}, "2024-05-03": {"temp": "25.0", "humidity": "39.3"}, "2024-05-07": {"temp": "24.4", "humidity": "45.2"}, "2024-05-08": {"temp": "24.7", "humidity": "37.7"}, "2024-05-09": {"temp": "24.6", "humidity": "39.5"}, "2024-05-10": {"temp": "24.8", "humidity": "41.4"}, "2024-05-13": {"temp": "24.1", "humidity": "45.0"}, "2024-05-14": {"temp": "25.0", "humidity": "38.5"}, "2024-05-16": {"temp": "24.0", "humidity": "36.2"}, "2024-05-17": {"temp": "24.0", "humidity": "38.6"}, "2024-05-20": {"temp": "25.2", "humidity": "44.0"}, "2024-05-21": {"temp": "25.2", "humidity": "47.0"}, "2024-05-22": {"temp": "25.4", "humidity": "47.8"}, "2024-05-23": {"temp": "24.9", "humidity": "44.3"}, "2024-05-24": {"temp": "25.2", "humidity": "47.5"}, "2024-05-27": {"temp": "26.6", "humidity": "50.1"}, "2024-05-28": {"temp": "26.0", "humidity": "42.4"}, "2024-05-29": {"temp": "25.6", "humidity": "42.4"}, "2024-05-30": {"temp": "24.6", "humidity": "42.7"}, "2024-05-31": {"temp": "25.5", "humidity": "41.7"}, "2024-06-03": {"temp": "26.2", "humidity": "39.2"}, "2024-06-04": {"temp": "26.1", "humidity": "34.0"}, "2024-06-05": {"temp": "26.1", "humidity": "36.1"}, "2024-06-10": {"temp": "27.3", "humidity": "44.0"}, "2024-06-11": {"temp": "26.6", "humidity": "44.1"}, "2024-06-12": {"temp": "25.9", "humidity": "39.2"}, "2024-06-14": {"temp": "26.8", "humidity": "43.0"}, "2024-06-17": {"temp": "27.7", "humidity": "38.9"}, "2024-06-18": {"temp": "27.0", "humidity": "38.5"}, "2024-06-19": {"temp": "26.1", "humidity": "39.2"}, "2024-06-20": {"temp": "26.1", "humidity": "40.9"}, "2024-06-21": {"temp": "26.4", "humidity": "39.0"}, "2024-06-24": {"temp": "26.9", "humidity": "49.7"}, "2024-06-25": {"temp": "26.1", "humidity": "40.7"}, "2024-06-26": {"temp": "26.2", "humidity": "42.9"}, "2024-06-27": {"temp": "26.7", "humidity": "41.9"}, "2024-06-28": {"temp": "25.4", "humidity": "40.8"}, "2024-07-01": {"temp": "25.7", "humidity": "45.1"}, "2024-07-02": {"temp": "25.1", "humidity": "43.9"}, "2024-07-03": {"temp": "25.8", "humidity": "50.8"}, "2024-07-04": {"temp": "24.8", "humidity": "46.5"}, "2024-07-05": {"temp": "25.4", "humidity": "49.4"}, "2024-07-08": {"temp": "25.3", "humidity": "48.0"}, "2024-07-09": {"temp": "25.1", "humidity": "50.1"}, "2024-07-10": {"temp": "26.2", "humidity": "53.1"}, "2024-07-11": {"temp": "25.2", "humidity": "49.0"}, "2024-07-12": {"temp": "24.8", "humidity": "48.3"}, "2024-07-15": {"temp": "26.9", "humidity": "46.2"}, "2024-07-16": {"temp": "27.2", "humidity": "47.7"}, "2024-07-17": {"temp": "24.8", "humidity": "49.9"}, "2024-07-18": {"temp": "25.4", "humidity": "52.3"}, "2024-07-19": {"temp": "25.0", "humidity": "53.4"}, "2024-07-22": {"temp": "26.3", "humidity": "53.3"}, "2024-07-23": {"temp": "25.3", "humidity": "49.9"}, "2024-07-24": {"temp": "26.2", "humidity": "55.7"}, "2024-07-25": {"temp": "25.9", "humidity": "50.9"}, "2024-07-26": {"temp": "26.9", "humidity": "54.5"}, "2024-07-29": {"temp": "26.6", "humidity": "49.7"}, "2024-07-30": {"temp": "26.7", "humidity": "48.1"}, "2024-07-31": {"temp": "26.4", "humidity": "48.7"}, "2024-08-01": {"temp": "26.7", "humidity": "49.1"}, "2024-08-02": {"temp": "26.0", "humidity": "47.4"}, "2024-08-05": {"temp": "27.8", "humidity": "48.7"}, "2024-08-06": {"temp": "26.1", "humidity": "45.5"}, "2024-08-07": {"temp": "26.9", "humidity": "48.9"}, "2024-08-08": {"temp": "26.4", "humidity": "49.6"}, "2024-08-09": {"temp": "26.6", "humidity": "50.8"}, "2024-08-12": {"temp": "27.1", "humidity": "50.9"}, "2024-08-13": {"temp": "26.9", "humidity": "47.5"}, "2024-08-14": {"temp": "27.0", "humidity": "47.0"}, "2024-08-19": {"temp": "27.1", "humidity": "47.0"}, "2024-08-20": {"temp": "27.0", "humidity": "43.3"}, "2024-08-21": {"temp": "27.1", "humidity": "48.2"}, "2024-08-22": {"temp": "27.2", "humidity": "48.1"}, "2024-08-23": {"temp": "27.0", "humidity": "47.9"}, "2024-08-26": {"temp": "27.7", "humidity": "49.7"}, "2024-08-27": {"temp": "27.3", "humidity": "53.7"}, "2024-08-28": {"temp": "27.2", "humidity": "47.7"}, "2024-08-29": {"temp": "26.6", "humidity": "42.9"}, "2024-08-30": {"temp": "26.4", "humidity": "42.8"}, "2024-09-02": {"temp": "27.1", "humidity": "43.1"}, "2024-09-03": {"temp": "27.2", "humidity": "44.0"}, "2024-09-04": {"temp": "27.4", "humidity": "45.1"}, "2024-09-05": {"temp": "27.1", "humidity": "47.1"}, "2024-09-06": {"temp": "26.2", "humidity": "53.9"}, "2024-09-09": {"temp": "27.4", "humidity": "48.0"}, "2024-09-10": {"temp": "27.2", "humidity": "48.3"}, "2024-09-11": {"temp": "27.2", "humidity": "51.3"}, "2024-09-12": {"temp": "26.5", "humidity": "52.5"}, "2024-09-13": {"temp": "27.0", "humidity": "64.7"}, "2024-09-23": {"temp": "28.3", "humidity": "39.0"}, "2024-09-24": {"temp": "27.3", "humidity": "39.3"}, "2024-09-25": {"temp": "27.5", "humidity": "42.7"}, "2024-09-26": {"temp": "25.7", "humidity": "44.9"}, "2024-09-27": {"temp": "24.9", "humidity": "42.5"}, "2024-09-30": {"temp": "27.4", "humidity": "41.3"}, "2024-10-01": {"temp": "24.0", "humidity": "40.0"}, "2024-10-07": {"temp": "25.0", "humidity": "41.8"}, "2024-10-08": {"temp": "24.9", "humidity": "43.5"}, "2024-10-10": {"temp": "25.5", "humidity": "43.4"}, "2024-10-11": {"temp": "25.3", "humidity": "43.1"}, "2024-10-14": {"temp": "25.0", "humidity": "42.8"}, "2024-10-15": {"temp": "24.5", "humidity": "46.8"}, "2024-10-16": {"temp": "24.4", "humidity": "49.8"}, "2024-10-17": {"temp": "24.4", "humidity": "46.9"}, "2024-10-18": {"temp": "23.0", "humidity": "47.3"}, "2024-10-21": {"temp": "24.7", "humidity": "35.5"}, "2024-10-22": {"temp": "24.9", "humidity": "46.8"}, "2024-10-23": {"temp": "24.5", "humidity": "50.3"}, "2024-10-24": {"temp": "24.6", "humidity": "39.6"}, "2024-10-25": {"temp": "24.8", "humidity": "40.6"}, "2024-10-28": {"temp": "24.7", "humidity": "48.2"}, "2024-10-29": {"temp": "24.6", "humidity": "44.0"}, "2024-10-30": {"temp": "24.4", "humidity": "46.2"}, "2024-10-31": {"temp": "24.0", "humidity": "43.5"}, "2024-11-01": {"temp": "24.0", "humidity": "45.2"}, "2024-11-04": {"temp": "25.0", "humidity": "48.6"}, "2024-11-05": {"temp": "24.6", "humidity": "29.6"}, "2024-11-06": {"temp": "24.2", "humidity": "26.5"}, "2024-11-07": {"temp": "24.0", "humidity": "24.7"}, "2024-11-08": {"temp": "23.8", "humidity": "25.8"}, "2024-11-11": {"temp": "23.5", "humidity": "38.5"}, "2024-11-12": {"temp": "23.8", "humidity": "39.8"}, "2024-11-13": {"temp": "23.3", "humidity": "38.0"}, "2024-11-14": {"temp": "23.8", "humidity": "39.5"}, "2024-11-15": {"temp": "23.3", "humidity": "42.6"}, "2024-11-18": {"temp": "22.6", "humidity": "20.6"}, "2024-11-19": {"temp": "22.5", "humidity": "23.2"}, "2024-11-20": {"temp": "22.2", "humidity": "28.1"}, "2024-11-21": {"temp": "22.3", "humidity": "35.5"}, "2024-11-22": {"temp": "22.1", "humidity": "34.5"}, "2024-11-25": {"temp": "21.9", "humidity": "31.4"}, "2024-11-26": {"temp": "22.2", "humidity": "38.3"}, "2024-11-27": {"temp": "21.3", "humidity": "34.7"}, "2024-11-28": {"temp": "20.8", "humidity": "36.9"}, "2024-11-29": {"temp": "20.5", "humidity": "31.5"}, "2024-12-02": {"temp": "21.1", "humidity": "41.8"}, "2024-12-03": {"temp": "20.1", "humidity": "34.1"}, "2024-12-04": {"temp": "20.2", "humidity": "30.1"}, "2024-12-05": {"temp": "20.0", "humidity": "30.0"}, "2024-12-06": {"temp": "20.1", "humidity": "29.9"}, "2024-12-09": {"temp": "20.8", "humidity": "34.2"}, "2024-12-10": {"temp": "26.2", "humidity": "30.1"}, "2024-12-11": {"temp": "20.3", "humidity": "28.2"}, "2024-12-12": {"temp": "20.1", "humidity": "28.1"}, "2024-12-13": {"temp": "20.1", "humidity": "28.4"}, "2024-12-16": {"temp": "20.2", "humidity": "27.0"}, "2024-12-17": {"temp": "20.5", "humidity": "24.4"}, "2024-12-18": {"temp": "20.1", "humidity": "27.3"}, "2024-12-19": {"temp": "21.0", "humidity": "24.3"}, "2024-12-20": {"temp": "21.1", "humidity": "25.4"}, "2024-12-23": {"temp": "20.1", "humidity": "24.6"}, "2024-12-24": {"temp": "20.0", "humidity": "27.2"}, "2025-01-02": {"temp": "19.3", "humidity": "25.9"}, "2025-01-03": {"temp": "21.9", "humidity": "19.6"}, "2025-01-06": {"temp": "19.8", "humidity": "34.2"}, "2025-01-07": {"temp": "19.0", "humidity": "25.6"}, "2025-01-08": {"temp": "19.7", "humidity": "21.5"}, "2025-01-09": {"temp": "19.7", "humidity": "19.3"}, "2025-01-10": {"temp": "19.9", "humidity": "19.1"}, "2025-01-13": {"temp": "18.5", "humidity": "22.6"}, "2025-01-14": {"temp": "21.1", "humidity": "29.2"}, "2025-01-15": {"temp": "20.4", "humidity": "23.4"}, "2025-01-16": {"temp": "19.5", "humidity": "20.4"}, "2025-01-17": {"temp": "18.6", "humidity": "24.3"}, "2025-01-20": {"temp": "19.7", "humidity": "30.0"}, "2025-01-21": {"temp": "20.6", "humidity": "31.4"}, "2025-01-22": {"temp": "20.2", "humidity": "33.2"}, "2025-01-23": {"temp": "20.6", "humidity": "29.7"}, "2025-01-24": {"temp": "19.5", "humidity": "26.7"}, "2025-02-03": {"temp": "17.7", "humidity": "31.5"}, "2025-02-04": {"temp": "20.2", "humidity": "21.6"}, "2025-02-05": {"temp": "21.5", "humidity": "18.3"}, "2025-02-06": {"temp": "18.6", "humidity": "23.2"}, "2025-02-07": {"temp": "19.6", "humidity": "27.2"}, "2025-02-10": {"temp": "18.1", "humidity": "27.3"}, "2025-02-11": {"temp": "20.1", "humidity": "27.1"}, "2025-02-12": {"temp": "20.8", "humidity": "30.4"}, "2025-02-13": {"temp": "19.9", "humidity": "29.5"}, "2025-02-14": {"temp": "23.3", "humidity": "30.3"}, "2025-02-18": {"temp": "19.3", "humidity": "30.7"}, "2025-02-19": {"temp": "20.4", "humidity": "24.5"}, "2025-02-20": {"temp": "19.4", "humidity": "19.9"}, "2025-02-21": {"temp": "19.6", "humidity": "20.8"}, "2025-02-24": {"temp": "19.3", "humidity": "19.9"}, "2025-02-25": {"temp": "18.4", "humidity": "26.5"}, "2025-02-26": {"temp": "20.1", "humidity": "34.1"}, "2025-02-27": {"temp": "19.2", "humidity": "25.2"}, "2025-02-28": {"temp": "20.3", "humidity": "25.3"}, "2025-03-04": {"temp": "19.6", "humidity": "35.9"}, "2025-03-05": {"temp": "20.2", "humidity": "37.5"}, "2025-03-06": {"temp": "21.2", "humidity": "34.2"}, "2025-03-07": {"temp": "21.7", "humidity": "31.5"}, "2025-03-10": {"temp": "21.9", "humidity": "35.2"}, "2025-03-11": {"temp": "21.6", "humidity": "34.3"}, "2025-03-12": {"temp": "21.5", "humidity": "36.0"}, "2025-03-13": {"temp": "21.2", "humidity": "38.2"}, "2025-03-14": {"temp": "21.5", "humidity": "32.1"}, "2025-03-17": {"temp": "22.0", "humidity": "24.1"}, "2025-03-18": {"temp": "21.4", "humidity": "31.5"}, "2025-03-26": {"temp": "23.3", "humidity": "38.2"}, "2025-03-27": {"temp": "23.2", "humidity": "39.6"}, "2025-03-28": {"temp": "22.9", "humidity": "33.1"}, "2025-03-31": {"temp": "22.5", "humidity": "26.5"}, "2025-04-01": {"temp": "21.7", "humidity": "33.1"}, "2025-04-02": {"temp": "22.0", "humidity": "30.2"}, "2025-04-04": {"temp": "23.0", "humidity": "45.2"}, "2025-04-07": {"temp": "22.7", "humidity": "45.1"}, "2025-04-08": {"temp": "21.8", "humidity": "46.1"}, "2025-04-09": {"temp": "22.6", "humidity": "44.2"}, "2025-04-10": {"temp": "22.9", "humidity": "46.2"}, "2025-04-11": {"temp": "22.8", "humidity": "46.0"}, "2025-04-14": {"temp": "21.8", "humidity": "40.6"}, "2025-04-15": {"temp": "21.7", "humidity": "43.7"}, "2025-04-16": {"temp": "21.8", "humidity": "45.2"}, "2025-04-17": {"temp": "22.9", "humidity": "47.4"}, "2025-04-18": {"temp": "23.5", "humidity": "49.9"}, "2025-04-21": {"temp": "22.8", "humidity": "47.6"}, "2025-04-22": {"temp": "23.8", "humidity": "50.6"}, "2025-04-23": {"temp": "24.2", "humidity": "51.4"}, "2025-04-24": {"temp": "23.2", "humidity": "45.4"}, "2025-04-25": {"temp": "23.6", "humidity": "43.2"}, "2025-04-28": {"temp": "23.6", "humidity": "45.6"}, "2025-04-29": {"temp": "23.6", "humidity": "44.1"}, "2025-04-30": {"temp": "23.1", "humidity": "41.0"}, "2025-05-07": {"temp": "22.5", "humidity": "47.2"}, "2025-05-08": {"temp": "23.0", "humidity": "48.0"}, "2025-05-09": {"temp": "23.5", "humidity": "48.9"}, "2025-05-12": {"temp": "23.2", "humidity": "44.8"}, "2025-05-13": {"temp": "24.0", "humidity": "47.3"}, "2025-05-14": {"temp": "23.9", "humidity": "46.4"}, "2025-05-15": {"temp": "24.0", "humidity": "48.3"}, "2025-05-16": {"temp": "23.8", "humidity": "49.2"}, "2025-05-19": {"temp": "23.8", "humidity": "39.4"}, "2025-05-20": {"temp": "24.0", "humidity": "49.8"}, "2025-05-21": {"temp": "24.2", "humidity": "52.5"}, "2025-05-22": {"temp": "24.7", "humidity": "56.6"}, "2025-05-23": {"temp": "24.1", "humidity": "46.5"}, "2025-05-26": {"temp": "24.8", "humidity": "44.9"}, "2025-05-27": {"temp": "24.7", "humidity": "43.7"}, "2025-05-28": {"temp": "24.3", "humidity": "48.5"}, "2025-05-29": {"temp": "24.8", "humidity": "46.4"}, "2025-05-30": {"temp": "24.7", "humidity": "44.5"}, "2025-06-02": {"temp": "24.9", "humidity": "45.5"}, "2025-06-04": {"temp": "25.1", "humidity": "45.5"}, "2025-06-05": {"temp": "24.3", "humidity": "42.2"}, "2025-06-09": {"temp": "25.9", "humidity": "44.9"}, "2025-06-10": {"temp": "25.6", "humidity": "48.0"}, "2025-06-11": {"temp": "21.4", "humidity": "47.5"}, "2025-06-12": {"temp": "22.5", "humidity": "49.0"}, "2025-06-16": {"temp": "21.4", "humidity": "52.3"}, "2025-06-17": {"temp": "22.2", "humidity": "54.0"}, "2025-06-18": {"temp": "22.0", "humidity": "51.4"}, "2025-06-20": {"temp": "22.1", "humidity": "56.9"}, "2025-06-23": {"temp": "22.6", "humidity": "49.4"}, "2025-06-24": {"temp": "24.1", "humidity": "56.2"}, "2025-06-25": {"temp": "21.9", "humidity": "56.5"}, "2025-06-26": {"temp": "22.8", "humidity": "57.7"}, "2025-06-27": {"temp": "21.0", "humidity": "52.9"}, "2025-06-30": {"temp": "22.8", "humidity": "52.5"}, "2025-07-01": {"temp": "22.4", "humidity": "56.1"}, "2025-07-02": {"temp": "21.4", "humidity": "55.3"}, "2025-07-03": {"temp": "21.3", "humidity": "55.4"}, "2025-07-04": {"temp": "21.6", "humidity": "56.8"}, "2025-07-07": {"temp": "22.8", "humidity": "56.9"}, "2025-07-08": {"temp": "24.0", "humidity": "56.4"}, "2025-07-09": {"temp": "23.2", "humidity": "55.4"}, "2025-07-10": {"temp": "23.4", "humidity": "52.6"}, "2025-07-11": {"temp": "22.4", "humidity": "47.5"}, "2025-07-14": {"temp": "24.8", "humidity": "46.4"}, "2025-07-15": {"temp": "22.8", "humidity": "54.3"}, "2025-07-16": {"temp": "22.9", "humidity": "55.3"}, "2025-07-17": {"temp": "21.3", "humidity": "55.8"}, "2025-07-18": {"temp": "21.7", "humidity": "58.9"}, "2025-07-21": {"temp": "24.0", "humidity": "65.5"}, "2025-07-22": {"temp": "23.0", "humidity": "54.5"}, "2025-07-23": {"temp": "22.7", "humidity": "55.9"}, "2025-07-24": {"temp": "22.7", "humidity": "59.1"}, "2025-07-25": {"temp": "23.7", "humidity": "54.4"}, "2025-07-28": {"temp": "25.3", "humidity": "58.2"}, "2025-07-29": {"temp": "24.2", "humidity": "57.5"}, "2025-07-30": {"temp": "24.9", "humidity": "59.7"}, "2025-07-31": {"temp": "23.1", "humidity": "54.8"}, "2025-08-01": {"temp": "22.8", "humidity": "52.8"}, "2025-08-04": {"temp": "22.7", "humidity": "53.6"}, "2025-08-05": {"temp": "22.6", "humidity": "54.5"}, "2025-08-06": {"temp": "22.4", "humidity": "55.9"}, "2025-08-07": {"temp": "23.0", "humidity": "57.3"}, "2025-08-08": {"temp": "23.0", "humidity": "52.8"}, "2025-08-11": {"temp": "23.5", "humidity": "55.8"}, "2025-08-12": {"temp": "23.9", "humidity": "54.6"}, "2025-08-13": {"temp": "24.4", "humidity": "56.6"}, "2025-08-14": {"temp": "24.0", "humidity": "58.0"}, "2025-08-18": {"temp": "24.6", "humidity": "58.4"}, "2025-08-19": {"temp": "24.3", "humidity": "53.0"}, "2025-08-20": {"temp": "24.0", "humidity": "51.7"}, "2025-08-21": {"temp": "24.3", "humidity": "56.1"}, "2025-08-22": {"temp": "23.8", "humidity": "54.9"}, "2025-08-25": {"temp": "24.0", "humidity": "56.2"}, "2025-08-26": {"temp": "24.8", "humidity": "53.3"}, "2025-08-27": {"temp": "25.0", "humidity": "53.8"}, "2025-08-28": {"temp": "24.3", "humidity": "53.2"}, "2025-08-29": {"temp": "23.3", "humidity": "55.6"}, "2025-09-01": {"temp": "23.9", "humidity": "54.3"}, "2025-09-02": {"temp": "23.5", "humidity": "54.0"}, "2025-09-03": {"temp": "23.6", "humidity": "50.0"}, "2025-09-04": {"temp": "23.4", "humidity": "51.9"}, "2025-09-05": {"temp": "23.2", "humidity": "53.8"}, "2025-09-08": {"temp": "24.8", "humidity": "50.0"}, "2025-09-09": {"temp": "24.3", "humidity": "49.1"}, "2025-09-10": {"temp": "23.2", "humidity": "51.5"}, "2025-09-11": {"temp": "23.5", "humidity": "50.0"}, "2025-09-12": {"temp": "23.7", "humidity": "50.8"}, "2025-09-15": {"temp": "24.2", "humidity": "51.4"}, "2025-09-16": {"temp": "23.1", "humidity": "51.3"}, "2025-09-17": {"temp": "22.5", "humidity": "54.2"}, "2025-09-18": {"temp": "22.1", "humidity": "50.0"}, "2025-09-19": {"temp": "22.8", "humidity": "49.5"}, "2025-09-20": {"temp": "23.7", "humidity": "51.5"}, "2025-09-21": {"temp": "23.0", "humidity": "50.8"}, "2025-09-23": {"temp": "22.7", "humidity": "45.8"}, "2025-09-24": {"temp": "21.9", "humidity": "47.4"}, "2025-09-25": {"temp": "23.2", "humidity": "49.2"}, "2025-09-26": {"temp": "22.5", "humidity": "48.3"}, "2025-09-29": {"temp": "21.9", "humidity": "48.3"}, "2025-09-30": {"temp": "22.8", "humidity": "49.5"}, "2025-10-01": {"temp": "23.4", "humidity": "47.6"}, "2025-10-02": {"temp": "21.7", "humidity": "48.5"}, "2025-10-10": {"temp": "23.5", "humidity": "49.9"}, "2025-10-13": {"temp": "21.9", "humidity": "50.4"}, "2025-10-14": {"temp": "22.6", "humidity": "49.6"}, "2025-10-15": {"temp": "23.5", "humidity": "51.9"}, "2025-10-16": {"temp": "22.9", "humidity": "55.4"}, "2025-10-17": {"temp": "23.6", "humidity": "51.8"}, "2025-10-20": {"temp": "23.4", "humidity": "36.0"}, "2025-10-21": {"temp": "22.0", "humidity": "31.7"}, "2025-10-22": {"temp": "22.0", "humidity": "34.2"}, "2025-10-23": {"temp": "23.8", "humidity": "36.0"}, "2025-10-24": {"temp": "23.0", "humidity": "35.5"}, "2025-10-27": {"temp": "21.0", "humidity": "31.5"}, "2025-10-28": {"temp": "23.3", "humidity": "28.1"}, "2025-10-29": {"temp": "23.0", "humidity": "35.1"}, "2025-10-30": {"temp": "22.5", "humidity": "38.1"}, "2025-10-31": {"temp": "22.8", "humidity": "43.7"}, "2025-11-03": {"temp": "22.9", "humidity": "23.5"}, "2025-11-04": {"temp": "23.9", "humidity": "26.0"}, "2025-11-05": {"temp": "23.5", "humidity": "28.4"}, "2025-11-06": {"temp": "23.6", "humidity": "26.0"}, "2025-11-07": {"temp": "23.4", "humidity": "28.0"}, "2025-11-10": {"temp": "23.7", "humidity": "30.0"}, "2025-11-11": {"temp": "25.2", "humidity": "26.8"}, "2025-11-12": {"temp": "23.2", "humidity": "37.1"}, "2025-11-13": {"temp": "23.8", "humidity": "38.0"}, "2025-11-14": {"temp": "22.7", "humidity": "29.4"}, "2025-11-17": {"temp": "24.2", "humidity": "26.0"}, "2025-11-18": {"temp": "23.9", "humidity": "23.5"}, "2025-11-19": {"temp": "23.7", "humidity": "20.1"}, "2025-11-20": {"temp": "23.3", "humidity": "27.3"}, "2025-11-21": {"temp": "22.3", "humidity": "28.1"}, "2025-11-24": {"temp": "20.9", "humidity": "42.2"}, "2025-11-25": {"temp": "19.8", "humidity": "32.0"}, "2025-11-26": {"temp": "23.0", "humidity": "28.9"}, "2025-11-27": {"temp": "22.9", "humidity": "34.2"}, "2025-11-28": {"temp": "25.0", "humidity": "27.2"}, "2025-12-01": {"temp": "23.0", "humidity": "37.9"}, "2025-12-02": {"temp": "23.7", "humidity": "38.7"}, "2025-12-03": {"temp": "25.4", "humidity": "34.6"}, "2025-12-04": {"temp": "23.0", "humidity": "36.7"}, "2025-12-05": {"temp": "24.0", "humidity": "35.4"}, "2025-12-08": {"temp": "24.7", "humidity": "29.4"}, "2025-12-09": {"temp": "26.5", "humidity": "25.3"}, "2025-12-10": {"temp": "23.0", "humidity": "34.6"}, "2025-12-11": {"temp": "24.3", "humidity": "38.1"}, "2025-12-12": {"temp": "26.2", "humidity": "35.0"}, "2025-12-15": {"temp": "22.3", "humidity": "31.4"}, "2025-12-16": {"temp": "21.8", "humidity": "37.5"}, "2025-12-17": {"temp": "22.4", "humidity": "34.4"}, "2025-12-18": {"temp": "23.2", "humidity": "27.7"}, "2025-12-19": {"temp": "21.3", "humidity": "39.2"}, "2025-12-22": {"temp": "23.5", "humidity": "24.2"}, "2025-12-23": {"temp": "24.2", "humidity": "24.8"}, "2025-12-24": {"temp": "22.8", "humidity": "38.0"}, "2025-12-26": {"temp": "21.5", "humidity": "30.2"}, "2025-12-29": {"temp": "20.2", "humidity": "40.8"}, "2025-12-30": {"temp": "22.6", "humidity": "32.6"}, "2025-12-31": {"temp": "27.2", "humidity": "20.8"}, "2026-01-05": {"temp": "21.6", "humidity": "30.0"}, "2026-01-06": {"temp": "22.7", "humidity": "24.2"}, "2026-01-07": {"temp": "20.8", "humidity": "27.5"}, "2026-01-08": {"temp": "20.3", "humidity": "25.0"}, "2026-01-09": {"temp": "20.5", "humidity": "24.8"}, "2026-01-12": {"temp": "23.0", "humidity": "22.7"}, "2026-01-13": {"temp": "21.6", "humidity": "32.3"}, "2026-01-14": {"temp": "22.9", "humidity": "21.1"}, "2026-01-15": {"temp": "23.4", "humidity": "20.0"}, "2026-01-16": {"temp": "21.8", "humidity": "22.1"}, "2026-01-19": {"temp": "22.6", "humidity": "21.8"}, "2026-01-20": {"temp": "22.4", "humidity": "21.1"}, "2026-01-21": {"temp": "22.9", "humidity": "18.9"}, "2026-01-22": {"temp": "21.2", "humidity": "20.5"}, "2026-01-23": {"temp": "23.7", "humidity": "19.6"}, "2026-01-26": {"temp": "22.9", "humidity": "20.5"}, "2026-01-27": {"temp": "24.6", "humidity": "19.7"}, "2026-01-28": {"temp": "21.4", "humidity": "22.3"}, "2026-01-29": {"temp": "22.0", "humidity": "20.8"}, "2026-01-30": {"temp": "22.9", "humidity": "18.9"}, "2026-02-02": {"temp": "25.7", "humidity": "21.2"}, "2026-02-03": {"temp": "22.3", "humidity": "22.9"}, "2026-02-04": {"temp": "23.2", "humidity": "24.9"}, "2026-02-05": {"temp": "26.4", "humidity": "27.5"}};

// Promega 로고 (Base64)
// 로고 제거됨

// v16.0: 랙 스펙 데이터 (물리적 랙 단위)
const RACK_SPEC = {
  'A1': [
    { rackNum: 1, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A1-01', binEnd: 'A1-03' },
    { rackNum: 2, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A1-01', binEnd: 'A1-03' },
    { rackNum: 3, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A1-04', binEnd: 'A1-06' },
    { rackNum: 4, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A1-04', binEnd: 'A1-06' },
  ],
  'A2': [
    { rackNum: 1, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A2-01', binEnd: 'A2-02', notes: 'A2-02는 2단,3단사용' },
    { rackNum: 2, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A2-01', binEnd: 'A2-02' },
    { rackNum: 3, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A2-03', binEnd: 'A2-05' },
    { rackNum: 4, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A2-03', binEnd: 'A2-05' },
  ],
  'A3': [
    { rackNum: 1, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 4, maxWeight: 300, binStart: 'A3-01', binEnd: 'A3-04' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 4, maxWeight: 300, binStart: 'A3-01', binEnd: 'A3-04' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 4, maxWeight: 300, binStart: 'A3-01', binEnd: 'A3-04' },
  ],
  'A5': [
    { rackNum: 1, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A5-01', binEnd: 'A5-03' },
    { rackNum: 2, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A5-04', binEnd: 'A5-06' },
  ],
  'A6': [
    { rackNum: 1, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A6-01', binEnd: 'A6-03' },
    { rackNum: 2, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 3, maxWeight: 300, binStart: 'A6-04', binEnd: 'A6-06' },
  ],
  'A7': [
    { rackNum: 1, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 2, maxWeight: 300, binStart: 'A7-01', binEnd: 'A7-01', notes: 'A7-01을 2단 사용' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'A7-02', binEnd: 'A7-02' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'A7-02', binEnd: 'A7-02' },
  ],
  'B1': [
    { rackNum: 1, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'B1-01', binEnd: 'B1-05' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'B1-01', binEnd: 'B1-05' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'B1-06', binEnd: 'B1-10' },
    { rackNum: 4, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'B1-06', binEnd: 'B1-10' },
    { rackNum: 5, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 150, binStart: 'B1-11', binEnd: 'B1-11' },
    { rackNum: 6, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 150, binStart: 'B1-12', binEnd: 'B1-12' },
    { rackNum: 7, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'B1-14', binEnd: 'B1-14', notes: 'B1-13은 BIN 없음' },
  ],
  'B2': [
    { rackNum: 1, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'B2-01', binEnd: 'B2-05' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'B2-06', binEnd: 'B2-10' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'B2-11', binEnd: 'B2-15' },
    { rackNum: 4, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 150, binStart: 'B2-18', binEnd: 'B2-18', notes: 'B2-16~17 없음' },
  ],
  'B3': [
    { rackNum: 1, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 150, binStart: 'B3-01', binEnd: 'B3-01' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 150, binStart: 'B3-01', binEnd: 'B3-01' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 150, binStart: 'B3-02', binEnd: 'B3-02' },
    { rackNum: 4, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 150, binStart: 'B3-02', binEnd: 'B3-02' },
    { rackNum: 5, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'B3-03', binEnd: 'B3-03' },
    { rackNum: 6, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'B3-04', binEnd: 'B3-04' },
    { rackNum: 7, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'B3-05', binEnd: 'B3-05' },
    { rackNum: 8, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'B3-06', binEnd: 'B3-06' },
  ],
  'B4': [
    { rackNum: 1, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'B4-01', binEnd: 'B4-04', notes: 'B4-03은 2단 사용' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 6, maxWeight: 150, binStart: 'B4-05', binEnd: 'B4-10' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 2, maxWeight: 150, binStart: 'B4-11', binEnd: 'B4-12' },
    { rackNum: 4, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 2, maxWeight: 150, binStart: 'B4-13', binEnd: 'B4-14' },
    { rackNum: 5, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 2, maxWeight: 150, binStart: 'B4-15', binEnd: 'B4-16' },
    { rackNum: 6, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 1, maxWeight: 150, binStart: 'B4-17', binEnd: 'B4-17' },
  ],
  'C1': [
    { rackNum: 1, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C1-01', binEnd: 'C1-07' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C1-01', binEnd: 'C1-07' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C1-08', binEnd: 'C1-14' },
    { rackNum: 4, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C1-08', binEnd: 'C1-14' },
  ],
  'C2': [
    { rackNum: 1, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C2-01', binEnd: 'C2-07' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C2-08', binEnd: 'C2-14' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 4, maxWeight: 150, binStart: 'C2-15', binEnd: 'C2-18' },
    { rackNum: 4, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'C2-19', binEnd: 'C2-23' },
  ],
  'C3': [
    { rackNum: 1, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C3-01', binEnd: 'C3-07' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C3-01', binEnd: 'C3-07' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C3-08', binEnd: 'C3-14' },
    { rackNum: 4, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 7, maxWeight: 150, binStart: 'C3-08', binEnd: 'C3-14' },
    { rackNum: 5, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 6, maxWeight: 150, binStart: 'C3-15', binEnd: 'C3-20' },
    { rackNum: 6, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 6, maxWeight: 150, binStart: 'C3-15', binEnd: 'C3-20' },
    { rackNum: 7, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'C3-21', binEnd: 'C3-25' },
    { rackNum: 8, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 5, maxWeight: 150, binStart: 'C3-21', binEnd: 'C3-25' },
  ],
  'D2': [
    { rackNum: 1, type: '볼트랙', width: 0, depth: 0, height: 0, levels: 1, maxWeight: 1000, binStart: 'D2', binEnd: 'D2' },
  ],
  'E3': [
    { rackNum: 1, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 4, maxWeight: 150, binStart: 'E3', binEnd: 'E3' },
    { rackNum: 2, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 4, maxWeight: 150, binStart: 'E3', binEnd: 'E3' },
    { rackNum: 3, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 4, maxWeight: 150, binStart: 'E3', binEnd: 'E3' },
    { rackNum: 4, type: '경량랙', width: 900, depth: 450, height: 1800, levels: 4, maxWeight: 150, binStart: 'E3', binEnd: 'E3' },
  ],
  'S1': [
    { rackNum: 1, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'S1', binEnd: 'S1' },
    { rackNum: 2, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'S1', binEnd: 'S1' },
    { rackNum: 3, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'S1', binEnd: 'S1' },
    { rackNum: 4, type: '중량랙', width: 1800, depth: 450, height: 1800, levels: 1, maxWeight: 300, binStart: 'S1', binEnd: 'S1' },
  ],
  'F1': [
    { rackNum: 1, type: 'Unknown', width: 0, depth: 0, height: 0, levels: 1, maxWeight: 0, binStart: 'F1', binEnd: 'F1' },
  ],
  'LABEL': [
    { rackNum: 1, type: 'Unknown', width: 0, depth: 0, height: 0, levels: 1, maxWeight: 0, binStart: 'LABEL', binEnd: 'LABEL' },
  ],
};

// v16.0: 박스 타입 데이터
const BOX_TYPES = {
  'PLASTIC-XL': { name: '특대형 플라스틱', material: 'Plastic', color: 'YELLOW', width: 400, depth: 195, height: 600, maxStack: 30, maxWeight: 20 },
  'PLASTIC-M': { name: '중형 플라스틱', material: 'Plastic', color: 'YELLOW', width: 380, depth: 100, height: 480, maxStack: 30, maxWeight: 20 },
  'PLASTIC-S': { name: '소형 플라스틱', material: 'Plastic', color: 'YELLOW', width: 240, depth: 100, height: 380, maxStack: 30, maxWeight: 20 },
  'PCB BOX-L': { name: '단프라 박스 L', material: 'N/A', color: 'BLACK', width: 510, depth: 230, height: 615, maxStack: 15, maxWeight: 20 },
  'PCB BOX-M': { name: '단프라 박스 M', material: 'N/A', color: 'BLACK', width: 440, depth: 140, height: 605, maxStack: 1, maxWeight: 20 },
  'PAPER-L': { name: '종이박스', material: 'PAPER', color: '', width: 0, depth: 0, height: 0, maxStack: 20, maxWeight: 10, variable: true },
  '712896': { name: 'Supplier 종이박스', material: 'PAPER', width: 210, depth: 85, height: 400, maxStack: 1, maxWeight: 20 },
  '714420': { name: 'Supplier 종이박스', material: 'PAPER', width: 295, depth: 310, height: 480, maxStack: 1, maxWeight: 10 },
  '711110': { name: 'Supplier 종이박스', material: 'PAPER', width: 230, depth: 75, height: 520, maxStack: 1, maxWeight: 10 },
  '711956': { name: 'Supplier 종이박스', material: 'PAPER', width: 260, depth: 180, height: 510, maxStack: 1, maxWeight: 10 },
  '048-9805': { name: 'Supplier 종이박스', material: 'PAPER', width: 260, depth: 150, height: 460, maxStack: 1, maxWeight: 10 },
  '712664': { name: 'Supplier 종이박스', material: 'PAPER', width: 290, depth: 195, height: 520, maxStack: 1, maxWeight: 10 },
  '159-9801': { name: 'Supplier 종이박스', material: 'PAPER', width: 290, depth: 300, height: 485, maxStack: 1, maxWeight: 10 },
  '714645': { name: 'Supplier 종이박스', material: 'PAPER', width: 360, depth: 235, height: 550, maxStack: 1, maxWeight: 10 },
  '716150': { name: 'Supplier 종이박스', material: 'PAPER', width: 320, depth: 220, height: 320, maxStack: 1, maxWeight: 10 },
  '712949': { name: 'Supplier 종이박스', material: 'PAPER', width: 300, depth: 300, height: 190, maxStack: 1, maxWeight: 10 },
};

// v16.1: Material별 박스 타입 매핑 (엑셀 4_Material_Box 기준, 290개)
const MATERIAL_BOX_MAP = {
  '712626': 'PLASTIC-XL',
  '712944': 'PLASTIC-XL',
  '712591': 'PLASTIC-XL',
  '712630': 'PLASTIC-XL',
  '714162': 'PLASTIC-XL',
  '712624': 'PLASTIC-XL',
  '712613': 'PLASTIC-XL',
  '712618': 'PLASTIC-XL',
  '712627': 'PLASTIC-XL',
  '712608': 'PLASTIC-XL',
  '712602': 'PLASTIC-XL',
  '712603': 'PLASTIC-XL',
  '712606': 'PLASTIC-XL',
  '712607': 'PLASTIC-XL',
  '712604': 'PLASTIC-XL',
  '712620': 'PLASTIC-XL',
  '712929': 'PLASTIC-XL',
  '712696': '712696',
  '714420': '714420',
  '715713': 'PLASTIC-XL',
  '715715': 'PLASTIC-XL',
  '714060': 'PLASTIC-XL',
  'KB0781': 'PAPER-L',
  '712594': 'PLASTIC-XL',
  '712611': 'PLASTIC-XL',
  '712664': '712664',
  '712896': '712896',
  '714413': 'PAPER-L',
  '710343': 'PLASTIC-XL',
  '710344': 'PLASTIC-XL',
  '710359': 'PLASTIC-XL',
  '710375': 'PLASTIC-XL',
  '710347': 'PLASTIC-XL',
  '710335': 'PLASTIC-XL',
  '710362': 'PLASTIC-XL',
  '710361': 'PLASTIC-XL',
  '710318': 'PLASTIC-XL',
  '710346': 'PLASTIC-XL',
  '710350': 'PLASTIC-XL',
  '710348': 'PLASTIC-XL',
  '710339': 'PLASTIC-XL',
  '710338': 'PLASTIC-XL',
  '710337': 'PLASTIC-XL',
  '710333': 'PLASTIC-XL',
  '710334': 'PLASTIC-XL',
  '710332': 'PLASTIC-XL',
  '710336': 'PLASTIC-XL',
  '711124': 'PLASTIC-XL',
  '711102': 'PLASTIC-XL',
  '711103': 'PLASTIC-XL',
  '711101': 'PLASTIC-XL',
  '711111': 'PLASTIC-XL',
  '711114': 'PLASTIC-XL',
  '711142': 'PLASTIC-XL',
  '711131': 'PLASTIC-XL',
  '711950': 'PLASTIC-XL',
  '711110': '711110',
  '711956': '711956',
  '048-9805': '048-9805',
  '9800-830': 'PCB BOX-M',
  'KB0746': 'PCB BOX-M',
  'KB0838': 'PCB BOX-L',
  '712589': 'PLASTIC-XL',
  '712590': 'PLASTIC-XL',
  '712592': 'PLASTIC-XL',
  '712593': 'PLASTIC-XL',
  '712605': 'PLASTIC-XL',
  '712955': 'PLASTIC-XL',
  '712628': 'PLASTIC-XL',
  '712588': 'PLASTIC-XL',
  '712609': 'PLASTIC-XL',
  '715045': 'PLASTIC-XL',
  '714421': 'PLASTIC-XL',
  '712647': 'PLASTIC-XL',
  '714422': 'PLASTIC-XL',
  '714164': 'PLASTIC-XL',
  '714165': 'PLASTIC-XL',
  '712622': 'PLASTIC-XL',
  '714163': 'PLASTIC-XL',
  'KB0798': 'PLASTIC-XL',
  '9800-880': 'PCB BOX-M',
  'KB0784': 'PCB BOX-M',
  '711115': 'PLASTIC-XL',
  '711112': 'PLASTIC-XL',
  '711126': 'PLASTIC-XL',
  '711132': 'PLASTIC-XL',
  '711951': 'PLASTIC-XL',
  '711107': 'PLASTIC-XL',
  '711130': 'PLASTIC-XL',
  '711109': 'PLASTIC-XL',
  '711108': 'PLASTIC-XL',
  '715046': 'PLASTIC-XL',
  '159-9801': '159-9801',
  'KB0782': 'PCB BOX-M',
  'KB0783': 'PCB BOX-M',
  'KB0785': 'PCB BOX-M',
  'KB0786': 'PCB BOX-M',
  'KB0837': 'PCB BOX-L',
  '711919': 'PLASTIC-M',
  '710319': 'PLASTIC-M',
  '710345': 'PLASTIC-M',
  'SP1083': 'PLASTIC-M',
  '710395': 'PLASTIC-M',
  '710331': 'PLASTIC-M',
  '710420': 'PLASTIC-M',
  '710407': 'PLASTIC-M',
  '710376': 'PLASTIC-M',
  '710403': 'PLASTIC-M',
  '710394': 'PLASTIC-M',
  '710367': 'PLASTIC-M',
  '710371': 'PLASTIC-M',
  '710408': 'PCB BOX-M',
  '710409': 'PCB BOX-M',
  '710410': 'PCB BOX-M',
  '710411': 'PCB BOX-M',
  '710360': 'PLASTIC-M',
  '710364': 'PLASTIC-M',
  '710366': 'PLASTIC-M',
  '710365': 'PLASTIC-M',
  '711201': 'PLASTIC-S',
  '9000-375': 'PLASTIC-S',
  '716152': 'PLASTIC-S',
  '711293': 'PLASTIC-S',
  '712771': 'PLASTIC-S',
  '711190': 'PLASTIC-S',
  '711116': 'PLASTIC-S',
  '711117': 'PLASTIC-S',
  '081-9801': 'PLASTIC-S',
  '711104': 'PLASTIC-S',
  '711105': 'PLASTIC-S',
  '711214': 'PLASTIC-S',
  '712621': 'PLASTIC-S',
  '711192': 'PLASTIC-S',
  '711133': 'PLASTIC-S',
  '711134': 'PLASTIC-S',
  '712623': 'PLASTIC-S',
  '711119': 'PLASTIC-S',
  '711136': 'PLASTIC-S',
  'KB0801': 'PLASTIC-S',
  '711143': 'PLASTIC-S',
  'KB0800': 'PLASTIC-S',
  '711194': 'PLASTIC-S',
  '711191': 'PLASTIC-S',
  '711193': 'PLASTIC-S',
  '711123': 'PLASTIC-S',
  '711198': 'PLASTIC-S',
  '711196': 'PLASTIC-S',
  '114-9804': 'PLASTIC-S',
  '711113': 'PLASTIC-S',
  '711120': 'PLASTIC-S',
  '711144': 'PLASTIC-S',
  '711138': 'PLASTIC-S',
  '711121': 'PLASTIC-S',
  '711157': 'PLASTIC-S',
  '021-0608': 'PLASTIC-S',
  '711275': 'PLASTIC-S',
  '716652': 'PLASTIC-S',
  '713730': 'PLASTIC-S',
  '091-0190': 'PLASTIC-S',
  '021-9804': 'PLASTIC-S',
  '711195': 'PLASTIC-S',
  '712021': 'PLASTIC-S',
  '711141': 'PLASTIC-S',
  '711135': 'PLASTIC-S',
  '021-1006': 'PLASTIC-S',
  '201-9802': 'PLASTIC-S',
  '711203': 'PLASTIC-S',
  '711957': 'PLASTIC-S',
  '716430': 'PLASTIC-S',
  'KB0673': 'PLASTIC-S',
  '710326': 'PLASTIC-S',
  '710322': 'PLASTIC-S',
  '710340': 'PLASTIC-S',
  '710341': 'PLASTIC-S',
  '710353': 'PLASTIC-S',
  '710342': 'PLASTIC-S',
  '710349': 'PLASTIC-S',
  '710356': 'PLASTIC-S',
  '710354': 'PLASTIC-S',
  '710355': 'PLASTIC-S',
  '710368': 'PLASTIC-S',
  '710363': 'PLASTIC-S',
  '710369': 'PLASTIC-S',
  '710396': 'PLASTIC-S',
  '710393': 'PLASTIC-S',
  '710398': 'PLASTIC-S',
  '710399': 'PLASTIC-S',
  '710397': 'PLASTIC-S',
  '710402': 'PLASTIC-S',
  '710400': 'PLASTIC-S',
  '710401': 'PLASTIC-S',
  '710405': 'PLASTIC-S',
  '710404': 'PLASTIC-S',
  '710406': 'PLASTIC-S',
  '710412': 'PLASTIC-S',
  '710357': 'PLASTIC-S',
  '710413': 'PLASTIC-S',
  '710439': 'PLASTIC-S',
  '710358': 'PLASTIC-S',
  '710438': 'PLASTIC-S',
  '713683': 'PLASTIC-S',
  'KB0382': 'PLASTIC-S',
  'KB0381': 'PLASTIC-S',
  'KB0379': 'PLASTIC-S',
  'KB0436': 'PLASTIC-S',
  'KB0402': 'PLASTIC-S',
  '9FB134': 'PLASTIC-S',
  '017785': 'PLASTIC-S',
  '710317': 'PLASTIC-S',
  '710316': 'PLASTIC-S',
  'KB0446': 'PLASTIC-S',
  '713682': 'PLASTIC-S',
  '712581': 'PLASTIC-S',
  '712583': 'PLASTIC-S',
  '712580': 'PLASTIC-S',
  '712600': 'PLASTIC-S',
  '712587': 'PLASTIC-S',
  '712586': 'PLASTIC-S',
  '712636': 'PLASTIC-S',
  '712612': 'PLASTIC-S',
  '712584': 'PLASTIC-S',
  '712585': 'PLASTIC-S',
  'KB0802': 'PLASTIC-S',
  '712634': 'PLASTIC-S',
  '712635': 'PLASTIC-S',
  '712633': 'PLASTIC-S',
  '712632': 'PLASTIC-S',
  '712640': 'PLASTIC-S',
  '712639': 'PLASTIC-S',
  '714027': 'PLASTIC-S',
  '712631': 'PLASTIC-S',
  '712821': 'PLASTIC-S',
  '712701': 'PLASTIC-S',
  '712668': 'PLASTIC-S',
  '712595': 'PLASTIC-S',
  '712682': 'PLASTIC-S',
  '712669': 'PLASTIC-S',
  '712686': 'PLASTIC-S',
  '712667': 'PLASTIC-S',
  '712697': 'PLASTIC-S',
  '712687': 'PLASTIC-S',
  '712681': 'PLASTIC-S',
  '712680': 'PLASTIC-S',
  '712649': 'PLASTIC-S',
  '712055': 'PLASTIC-S',
  '712689': 'PLASTIC-S',
  '712683': 'PLASTIC-S',
  '714406': 'PLASTIC-S',
  '712691': 'PLASTIC-S',
  '715047': 'PLASTIC-S',
  '712934': 'PLASTIC-S',
  '712933': 'PLASTIC-S',
  '715714': 'PLASTIC-S',
  '716151': 'PLASTIC-S',
  '714063': 'PLASTIC-S',
  '713412': 'PLASTIC-S',
  '712949': '712949',
  '712930': 'PLASTIC-S',
  '715851': 'PLASTIC-S',
  '712935': 'PLASTIC-S',
  '714157': 'PLASTIC-S',
  '714167': 'PLASTIC-S',
  '714820': 'PLASTIC-S',
  '716150': '716150',
  '714995': 'PLASTIC-S',
  '713790': 'PLASTIC-S',
  '714682': 'PLASTIC-S',
  '714686': 'PLASTIC-S',
  '714681': 'PLASTIC-S',
  '714087': 'PLASTIC-S',
  '714981': 'PLASTIC-S',
  '712685': 'PLASTIC-S',
  '714646': 'PLASTIC-S',
  '714647': 'PLASTIC-S',
  '714645': '714645',
  '714352': 'PLASTIC-XL',
  '714350': 'PLASTIC-XL',
  '714378': 'PLASTIC-XL',
  '714356': 'PLASTIC-XL',
  '714355': 'PLASTIC-XL',
  '714373': 'PLASTIC-XL',
  '714377': 'PLASTIC-XL',
  '714372': 'PLASTIC-XL',
  '714375': 'PLASTIC-XL',
  '714370': 'PLASTIC-XL',
  '714376': 'PLASTIC-XL',
  '714371': 'PLASTIC-XL',
  '714351': 'PLASTIC-XL',
  '714353': 'PLASTIC-XL',
  'KB0840': 'PLASTIC-XL',
  'KB0835': 'PLASTIC-XL',
  'KB0778': 'PLASTIC-XL',
  'KB0768': 'PLASTIC-XL',
  'KB0749': 'PLASTIC-XL',
  'KB0731': 'PLASTIC-XL',
  '711202': 'PLASTIC-S',
  'KB0776': 'PLASTIC-XL',
  'KB0770': 'PLASTIC-XL',
  'KB0780': 'PLASTIC-XL',
  'KB0771': 'PLASTIC-XL',
  'KB0775': 'PLASTIC-XL',
  'KB0727': 'PLASTIC-XL',
  'KB0733': 'PLASTIC-XL',
  'KB0737': 'PLASTIC-XL',
  'KB0724': 'PLASTIC-XL',
  'KB0788': 'PLASTIC-XL',
};

// v16.0: Material별 박스당 수량 (Qty/Box)
// v16.1: Material별 Qty/Box (엑셀 4_Material_Box 시트 기준, 290개)
const MATERIAL_QTY_PER_BOX = {
  '712626': 20,
  '712944': 40,
  '712591': 5,
  '712630': 20,
  '714162': 10,
  '712624': 20,
  '712613': 10,
  '712618': 10,
  '712627': 10,
  '712608': 10,
  '712602': 20,
  '712603': 20,
  '712606': 20,
  '712607': 20,
  '712604': 10,
  '712620': 10,
  '712929': 20,
  '712696': 5,
  '714420': 12,
  '715713': 20,
  '715715': 20,
  '714060': 20,
  'KB0781': 10,
  '712594': 20,
  '712611': 20,
  '712664': 50,
  '712896': 20,
  '714413': 50,
  '710343': 20,
  '710344': 20,
  '710359': 20,
  '710375': 20,
  '710347': 20,
  '710335': 20,
  '710362': 5,
  '710361': 5,
  '710318': 5,
  '710346': 20,
  '710350': 20,
  '710348': 20,
  '710339': 20,
  '710338': 20,
  '710337': 20,
  '710333': 20,
  '710334': 20,
  '710332': 20,
  '710336': 3,
  '711124': 10,
  '711102': 20,
  '711103': 20,
  '711101': 5,
  '711111': 20,
  '711114': 20,
  '711142': 20,
  '711131': 20,
  '711950': 20,
  '711110': 40,
  '711956': 18,
  '048-9805': 12,
  '9800-830': 60,
  'KB0746': 70,
  'KB0838': 20,
  '712589': 40,
  '712590': 40,
  '712592': 40,
  '712593': 40,
  '712605': 40,
  '712955': 100,
  '712628': 40,
  '712588': 80,
  '712609': 40,
  '715045': 20,
  '714421': 30,
  '712647': 60,
  '714422': 30,
  '714164': 80,
  '714165': 80,
  '712622': 40,
  '714163': 40,
  'KB0798': 40,
  '9800-880': 40,
  'KB0784': 40,
  '711115': 50,
  '711112': 50,
  '711126': 40,
  '711132': 50,
  '711951': 50,
  '711107': 40,
  '711130': 50,
  '711109': 50,
  '711108': 40,
  '715046': 40,
  '159-9801': 50,
  'KB0782': 15,
  'KB0783': 15,
  'KB0785': 15,
  'KB0786': 15,
  'KB0837': 10,
  '711919': 50,
  '710319': 50,
  '710345': 50,
  'SP1083': 50,
  '710395': 50,
  '710331': 50,
  '710420': 50,
  '710407': 50,
  '710376': 50,
  '710403': 50,
  '710394': 50,
  '710367': 50,
  '710371': 50,
  '710408': 12,
  '710409': 20,
  '710410': 20,
  '710411': 20,
  '710360': 4,
  '710364': 4,
  '710366': 4,
  '710365': 4,
  '711201': 200,
  '9000-375': 200,
  '716152': 200,
  '711293': 400,
  '712771': 200,
  '711190': 200,
  '711116': 5000,
  '711117': 10000,
  '081-9801': 1000,
  '711104': 200,
  '711105': 200,
  '711214': 200,
  '712621': 5000,
  '711192': 200,
  '711133': 200,
  '711134': 200,
  '712623': 50000,
  '711119': 5000,
  '711136': 200,
  'KB0801': 200,
  '711143': 200,
  'KB0800': 200,
  '711194': 5000,
  '711191': 10000,
  '711193': 200,
  '711123': 200,
  '711198': 200,
  '711196': 200,
  '114-9804': 200,
  '711113': 200,
  '711120': 200,
  '711144': 200,
  '711138': 200,
  '711121': 200,
  '711157': 200,
  '021-0608': 200,
  '711275': 200,
  '716652': 400,
  '713730': 200,
  '091-0190': 200,
  '021-9804': 200,
  '711195': 200,
  '712021': 200,
  '711141': 200,
  '711135': 1000,
  '021-1006': 200,
  '201-9802': 200,
  '711203': 200,
  '711957': 200,
  '716430': 10,
  'KB0673': 2000,
  '710326': 100,
  '710322': 100,
  '710340': 100,
  '710341': 100,
  '710353': 100,
  '710342': 100,
  '710349': 100,
  '710356': 100,
  '710354': 100,
  '710355': 100,
  '710368': 100,
  '710363': 100,
  '710369': 100,
  '710396': 100,
  '710393': 100,
  '710398': 100,
  '710399': 100,
  '710397': 100,
  '710402': 100,
  '710400': 100,
  '710401': 100,
  '710405': 100,
  '710404': 100,
  '710406': 100,
  '710412': 100,
  '710357': 100,
  '710413': 100,
  '710439': 100,
  '710358': 100,
  '710438': 100,
  '713683': 100,
  'KB0382': 100,
  'KB0381': 100,
  'KB0379': 100,
  'KB0436': 100,
  'KB0402': 100,
  '9FB134': 100,
  '017785': 100,
  '710317': 100,
  '710316': 100,
  'KB0446': 1000,
  '713682': 1000,
  '712581': 50,
  '712583': 50,
  '712580': 50,
  '712600': 1000,
  '712587': 50,
  '712586': 50,
  '712636': 50,
  '712612': 400,
  '712584': 400,
  '712585': 50,
  'KB0802': 500,
  '712634': 400,
  '712635': 40,
  '712633': 400,
  '712632': 50,
  '712640': 200,
  '712639': 500,
  '714027': 500,
  '712631': 200,
  '712821': 500,
  '712701': 500,
  '712668': 200,
  '712595': 50,
  '712682': 150,
  '712669': 200,
  '712686': 200,
  '712667': 500,
  '712697': 300,
  '712687': 300,
  '712681': 500,
  '712680': 500,
  '712649': 300,
  '712055': 100000,
  '712689': 200,
  '712683': 150,
  '714406': 150,
  '712691': 100,
  '715047': 1000,
  '712934': 50,
  '712933': 150,
  '715714': 200,
  '716151': 150,
  '714063': 50,
  '713412': 500,
  '712949': 100,
  '712930': 200,
  '715851': 300,
  '712935': 350,
  '714157': 50,
  '714167': 150,
  '714820': 50,
  '716150': 400,
  '714995': 100,
  '713790': 100,
  '714682': 100,
  '714686': 100,
  '714681': 100,
  '714087': 100,
  '714981': 400,
  '712685': 200,
  '714646': 200,
  '714647': 200,
  '714645': 200,
  '714352': 500,
  '714350': 500,
  '714378': 500,
  '714356': 500,
  '714355': 500,
  '714373': 500,
  '714377': 500,
  '714372': 500,
  '714375': 500,
  '714370': 500,
  '714376': 500,
  '714371': 500,
  '714351': 500,
  '714353': 500,
  'KB0840': 10,
  'KB0835': 10,
  'KB0778': 10,
  'KB0768': 10,
  'KB0749': 10,
  'KB0731': 10,
  '711202': 4000,
  'KB0776': 10,
  'KB0770': 10,
  'KB0780': 10,
  'KB0771': 10,
  'KB0775': 10,
  'KB0727': 10,
  'KB0733': 10,
  'KB0737': 10,
  'KB0724': 10,
  'KB0788': 10,
};

// v16.1 FINAL: Bin별 랙 정보
// Bin = 1개 선반(1단). rackCount = 같은 Bin을 공유하는 랙 수
// 최대 박스/Bin = BOXES_PER_SHELF[rackType][boxType] × rackCount
const BIN_RACK_INFO = {
  'A1-01': { rackType: '중량랙', rackCount: 2 },
  'A1-02': { rackType: '중량랙', rackCount: 2 },
  'A1-03': { rackType: '중량랙', rackCount: 2 },
  'A1-04': { rackType: '중량랙', rackCount: 2 },
  'A1-05': { rackType: '중량랙', rackCount: 2 },
  'A1-06': { rackType: '중량랙', rackCount: 2 },
  'A2-01': { rackType: '중량랙', rackCount: 2, shelves: 2 },  // Notes: 1단,2단사용
  'A2-02': { rackType: '중량랙', rackCount: 2, shelves: 1 },  // A2-01이 2단 쓰므로 나머지 1단
  'A2-03': { rackType: '중량랙', rackCount: 2 },
  'A2-04': { rackType: '중량랙', rackCount: 2 },
  'A2-05': { rackType: '중량랙', rackCount: 2 },
  'A3-01': { rackType: 'mixed', rackCount: 3, mixed: [{ type: '중량랙', count: 1 }, { type: '경량랙', count: 2 }] },
  'A3-02': { rackType: 'mixed', rackCount: 3, mixed: [{ type: '중량랙', count: 1 }, { type: '경량랙', count: 2 }] },
  'A3-03': { rackType: 'mixed', rackCount: 3, mixed: [{ type: '중량랙', count: 1 }, { type: '경량랙', count: 2 }] },
  'A3-04': { rackType: 'mixed', rackCount: 3, mixed: [{ type: '중량랙', count: 1 }, { type: '경량랙', count: 2 }] },
  'A5-01': { rackType: '중량랙', rackCount: 1 },
  'A5-02': { rackType: '중량랙', rackCount: 1 },
  'A5-03': { rackType: '중량랙', rackCount: 1 },
  'A5-04': { rackType: '중량랙', rackCount: 1 },
  'A5-05': { rackType: '중량랙', rackCount: 1 },
  'A5-06': { rackType: '중량랙', rackCount: 1 },
  'A6-01': { rackType: '중량랙', rackCount: 1 },
  'A6-02': { rackType: '중량랙', rackCount: 1 },
  'A6-03': { rackType: '중량랙', rackCount: 1 },
  'A6-04': { rackType: '중량랙', rackCount: 1 },
  'A6-05': { rackType: '중량랙', rackCount: 1 },
  'A6-06': { rackType: '중량랙', rackCount: 1 },
  'A7-01': { rackType: '중량랙', rackCount: 1, shelves: 2 },  // Notes: 2단 사용
  'A7-02': { rackType: '경량랙', rackCount: 2 },
  'B1-01': { rackType: '경량랙', rackCount: 4 },
  'B1-02': { rackType: '경량랙', rackCount: 4 },
  'B1-03': { rackType: '경량랙', rackCount: 4 },
  'B1-04': { rackType: '경량랙', rackCount: 4 },
  'B1-05': { rackType: '경량랙', rackCount: 4 },
  'B1-06': { rackType: '경량랙', rackCount: 4 },
  'B1-07': { rackType: '경량랙', rackCount: 4 },
  'B1-08': { rackType: '경량랙', rackCount: 4 },
  'B1-09': { rackType: '경량랙', rackCount: 4 },
  'B1-10': { rackType: '경량랙', rackCount: 4 },
  'B1-11': { rackType: '경량랙', rackCount: 1 },
  'B1-12': { rackType: '경량랙', rackCount: 1 },
  'B1-14': { rackType: '중량랙', rackCount: 1 },
  'B2-01': { rackType: '경량랙', rackCount: 1 },
  'B2-02': { rackType: '경량랙', rackCount: 1 },
  'B2-03': { rackType: '경량랙', rackCount: 1 },
  'B2-04': { rackType: '경량랙', rackCount: 1 },
  'B2-05': { rackType: '경량랙', rackCount: 1 },
  'B2-06': { rackType: '경량랙', rackCount: 1 },
  'B2-07': { rackType: '경량랙', rackCount: 1 },
  'B2-08': { rackType: '경량랙', rackCount: 1 },
  'B2-09': { rackType: '경량랙', rackCount: 1 },
  'B2-10': { rackType: '경량랙', rackCount: 1 },
  'B2-11': { rackType: '경량랙', rackCount: 1 },
  'B2-12': { rackType: '경량랙', rackCount: 1 },
  'B2-13': { rackType: '경량랙', rackCount: 1 },
  'B2-14': { rackType: '경량랙', rackCount: 1 },
  'B2-15': { rackType: '경량랙', rackCount: 1 },
  'B2-18': { rackType: '경량랙', rackCount: 1 },
  'B3-01': { rackType: '경량랙', rackCount: 2, maxBoxes: 16 },  // 100%=20, 80%=16
  'B3-02': { rackType: '경량랙', rackCount: 2, maxBoxes: 16 },  // 100%=20, 80%=16
  'B3-03': { rackType: '중량랙', rackCount: 1, maxBoxes: 24 },  // 100%=30, 80%=24
  'B3-04': { rackType: '중량랙', rackCount: 1, maxBoxes: 24 },  // 100%=30, 80%=24
  'B3-05': { rackType: '중량랙', rackCount: 2, maxBoxes: 29 },  // 100%=36, 80%=29
  'B4-01': { rackType: '경량랙', rackCount: 1 },
  'B4-02': { rackType: '경량랙', rackCount: 1 },
  'B4-03': { rackType: '경량랙', rackCount: 1, shelves: 2 },  // Notes: 2단 사용
  'B4-04': { rackType: '경량랙', rackCount: 1 },
  'B4-05': { rackType: '경량랙', rackCount: 1 },
  'B4-06': { rackType: '경량랙', rackCount: 1 },
  'B4-07': { rackType: '경량랙', rackCount: 1 },
  'B4-08': { rackType: '경량랙', rackCount: 1 },
  'B4-09': { rackType: '경량랙', rackCount: 1 },
  'B4-10': { rackType: '경량랙', rackCount: 1 },
  'B4-11': { rackType: '경량랙', rackCount: 1 },
  'B4-12': { rackType: '경량랙', rackCount: 1 },
  'B4-13': { rackType: '경량랙', rackCount: 1 },
  'B4-14': { rackType: '경량랙', rackCount: 1 },
  'B4-15': { rackType: '경량랙', rackCount: 1 },
  'B4-16': { rackType: '경량랙', rackCount: 1 },
  'B4-17': { rackType: '경량랙', rackCount: 1 },
  'C1-01': { rackType: '경량랙', rackCount: 2 },
  'C1-02': { rackType: '경량랙', rackCount: 2 },
  'C1-03': { rackType: '경량랙', rackCount: 2 },
  'C1-04': { rackType: '경량랙', rackCount: 2 },
  'C1-05': { rackType: '경량랙', rackCount: 2 },
  'C1-06': { rackType: '경량랙', rackCount: 2 },
  'C1-07': { rackType: '경량랙', rackCount: 2 },
  'C1-08': { rackType: '경량랙', rackCount: 2 },
  'C1-09': { rackType: '경량랙', rackCount: 2 },
  'C1-10': { rackType: '경량랙', rackCount: 2 },
  'C1-11': { rackType: '경량랙', rackCount: 2 },
  'C1-12': { rackType: '경량랙', rackCount: 2 },
  'C1-13': { rackType: '경량랙', rackCount: 2 },
  'C1-14': { rackType: '경량랙', rackCount: 2 },
  'C2-01': { rackType: '경량랙', rackCount: 1 },
  'C2-02': { rackType: '경량랙', rackCount: 1 },
  'C2-03': { rackType: '경량랙', rackCount: 1 },
  'C2-04': { rackType: '경량랙', rackCount: 1 },
  'C2-05': { rackType: '경량랙', rackCount: 1 },
  'C2-06': { rackType: '경량랙', rackCount: 1 },
  'C2-07': { rackType: '경량랙', rackCount: 1 },
  'C2-08': { rackType: '경량랙', rackCount: 1 },
  'C2-09': { rackType: '경량랙', rackCount: 1 },
  'C2-10': { rackType: '경량랙', rackCount: 1 },
  'C2-11': { rackType: '경량랙', rackCount: 1 },
  'C2-12': { rackType: '경량랙', rackCount: 1 },
  'C2-13': { rackType: '경량랙', rackCount: 1 },
  'C2-14': { rackType: '경량랙', rackCount: 1 },
  'C2-15': { rackType: '경량랙', rackCount: 1 },
  'C2-16': { rackType: '경량랙', rackCount: 1 },
  'C2-17': { rackType: '경량랙', rackCount: 1 },
  'C2-18': { rackType: '경량랙', rackCount: 1 },
  'C2-19': { rackType: '경량랙', rackCount: 1 },
  'C2-20': { rackType: '경량랙', rackCount: 1 },
  'C2-21': { rackType: '경량랙', rackCount: 1 },
  'C2-22': { rackType: '경량랙', rackCount: 1 },
  'C2-23': { rackType: '경량랙', rackCount: 1 },
  'C3-01': { rackType: '경량랙', rackCount: 2 },
  'C3-02': { rackType: '경량랙', rackCount: 2 },
  'C3-03': { rackType: '경량랙', rackCount: 2 },
  'C3-04': { rackType: '경량랙', rackCount: 2 },
  'C3-05': { rackType: '경량랙', rackCount: 2 },
  'C3-06': { rackType: '경량랙', rackCount: 2 },
  'C3-07': { rackType: '경량랙', rackCount: 2 },
  'C3-08': { rackType: '경량랙', rackCount: 2 },
  'C3-09': { rackType: '경량랙', rackCount: 2 },
  'C3-10': { rackType: '경량랙', rackCount: 2 },
  'C3-11': { rackType: '경량랙', rackCount: 2 },
  'C3-12': { rackType: '경량랙', rackCount: 2 },
  'C3-13': { rackType: '경량랙', rackCount: 2 },
  'C3-14': { rackType: '경량랙', rackCount: 2 },
  'C3-15': { rackType: '경량랙', rackCount: 2 },
  'C3-16': { rackType: '경량랙', rackCount: 2 },
  'C3-17': { rackType: '경량랙', rackCount: 2 },
  'C3-18': { rackType: '경량랙', rackCount: 2 },
  'C3-19': { rackType: '경량랙', rackCount: 2 },
  'C3-20': { rackType: '경량랙', rackCount: 2 },
  'C3-21': { rackType: '경량랙', rackCount: 2 },
  'C3-22': { rackType: '경량랙', rackCount: 2 },
  'C3-23': { rackType: '경량랙', rackCount: 2 },
  'C3-24': { rackType: '경량랙', rackCount: 2 },
  'C3-25': { rackType: '경량랙', rackCount: 2 },
  'D2': { rackType: '볼트랙', rackCount: 1 },
  'E3': { rackType: '경량랙', rackCount: 4 },
  'S1': { rackType: '중량랙', rackCount: 6, maxBoxes: 72 },  // 6랙×3단×8개=144, 50%적용(제품별 분리보관)
};

// 랙 스펙 기반 Bin별 단수(l) + 단 위치(p) 매핑
const BIN_LEVEL_MAP = {
  'A1-01':{l:3,p:1},'A1-02':{l:3,p:2},'A1-03':{l:3,p:3},'A1-04':{l:3,p:1},'A1-05':{l:3,p:2},'A1-06':{l:3,p:3},
  'A2-01':{l:3,p:1},'A2-02':{l:3,p:2},'A2-03':{l:3,p:1},'A2-04':{l:3,p:2},'A2-05':{l:3,p:3},
  'A3-01':{l:4,p:1},'A3-02':{l:4,p:2},'A3-03':{l:4,p:3},'A3-04':{l:4,p:4},
  'A3-05':{l:4,p:1},'A3-06':{l:4,p:2},'A3-07':{l:4,p:3},'A3-08':{l:4,p:4},
  'A5-01':{l:3,p:1},'A5-02':{l:3,p:2},'A5-03':{l:3,p:3},'A5-04':{l:3,p:1},'A5-05':{l:3,p:2},'A5-06':{l:3,p:3},
  'A6-01':{l:3,p:1},'A6-02':{l:3,p:2},'A6-03':{l:3,p:3},'A6-04':{l:3,p:1},'A6-05':{l:3,p:2},'A6-06':{l:3,p:3},
  'A7-01':{l:2,p:1},'A7-02':{l:1,p:1},
  'B1-01':{l:5,p:1},'B1-02':{l:5,p:2},'B1-03':{l:5,p:3},'B1-04':{l:5,p:4},'B1-05':{l:5,p:5},
  'B1-06':{l:5,p:1},'B1-07':{l:5,p:2},'B1-08':{l:5,p:3},'B1-09':{l:5,p:4},'B1-10':{l:5,p:5},
  'B1-11':{l:1,p:1},'B1-12':{l:1,p:1},'B1-14':{l:1,p:1},
  'B2-01':{l:5,p:1},'B2-02':{l:5,p:2},'B2-03':{l:5,p:3},'B2-04':{l:5,p:4},'B2-05':{l:5,p:5},
  'B2-06':{l:5,p:1},'B2-07':{l:5,p:2},'B2-08':{l:5,p:3},'B2-09':{l:5,p:4},'B2-10':{l:5,p:5},
  'B2-11':{l:5,p:1},'B2-12':{l:5,p:2},'B2-13':{l:5,p:3},'B2-14':{l:5,p:4},'B2-15':{l:5,p:5},
  'B2-18':{l:1,p:1},
  'B3-01':{l:1,p:1},'B3-02':{l:1,p:1},'B3-03':{l:1,p:1},'B3-04':{l:1,p:1},'B3-05':{l:1,p:1},
  'B4-01':{l:5,p:1},'B4-02':{l:5,p:2},'B4-03':{l:5,p:3},'B4-04':{l:5,p:4},
  'B4-05':{l:6,p:1},'B4-06':{l:6,p:2},'B4-07':{l:6,p:3},'B4-08':{l:6,p:4},'B4-09':{l:6,p:5},'B4-10':{l:6,p:6},
  'B4-11':{l:2,p:1},'B4-12':{l:2,p:2},'B4-13':{l:2,p:1},'B4-14':{l:2,p:2},'B4-15':{l:2,p:1},'B4-16':{l:2,p:2},'B4-17':{l:1,p:1},
  'C1-01':{l:7,p:1},'C1-02':{l:7,p:2},'C1-03':{l:7,p:3},'C1-04':{l:7,p:4},'C1-05':{l:7,p:5},'C1-06':{l:7,p:6},'C1-07':{l:7,p:7},
  'C1-08':{l:7,p:1},'C1-09':{l:7,p:2},'C1-10':{l:7,p:3},'C1-11':{l:7,p:4},'C1-12':{l:7,p:5},'C1-13':{l:7,p:6},'C1-14':{l:7,p:7},
  'C2-01':{l:7,p:1},'C2-02':{l:7,p:2},'C2-03':{l:7,p:3},'C2-04':{l:7,p:4},'C2-05':{l:7,p:5},'C2-06':{l:7,p:6},'C2-07':{l:7,p:7},
  'C2-08':{l:7,p:1},'C2-09':{l:7,p:2},'C2-10':{l:7,p:3},'C2-11':{l:7,p:4},'C2-12':{l:7,p:5},'C2-13':{l:7,p:6},'C2-14':{l:7,p:7},
  'C2-15':{l:4,p:1},'C2-16':{l:4,p:2},'C2-17':{l:4,p:3},'C2-18':{l:4,p:4},
  'C2-19':{l:5,p:1},'C2-20':{l:5,p:2},'C2-21':{l:5,p:3},'C2-22':{l:5,p:4},'C2-23':{l:5,p:5},
  'C3-01':{l:7,p:1},'C3-02':{l:7,p:2},'C3-03':{l:7,p:3},'C3-04':{l:7,p:4},'C3-05':{l:7,p:5},'C3-06':{l:7,p:6},'C3-07':{l:7,p:7},
  'C3-08':{l:7,p:1},'C3-09':{l:7,p:2},'C3-10':{l:7,p:3},'C3-11':{l:7,p:4},'C3-12':{l:7,p:5},'C3-13':{l:7,p:6},'C3-14':{l:7,p:7},
  'C3-15':{l:6,p:1},'C3-16':{l:6,p:2},'C3-17':{l:6,p:3},'C3-18':{l:6,p:4},'C3-19':{l:6,p:5},'C3-20':{l:6,p:6},
  'C3-21':{l:5,p:1},'C3-22':{l:5,p:2},'C3-23':{l:5,p:3},'C3-24':{l:5,p:4},'C3-25':{l:5,p:5},
  'D2':{l:1,p:1},'E3':{l:1,p:1},'S1':{l:3,p:1}
};

// v16.1 FINAL: 1개 랙의 1단(1선반)에 들어가는 박스 수
const BOXES_PER_SHELF = {
  '중량랙': {
    'PLASTIC-XL': 8, 'PLASTIC-M': 16, 'PLASTIC-S': 28,
    'PCB BOX-L': 3, 'PCB BOX-M': 12, 'PAPER-L': 10,
    '712696': 32, '712896': 40, '714420': 6, '711110': 20, '711956': 10,
    '048-9805': 15, '712664': 12, '159-9801': 6, '714645': 5,
    '716150': 10, '712949': 6,
  },
  '경량랙': {
    'PLASTIC-XL': 2, 'PLASTIC-M': 8, 'PLASTIC-S': 2,
    'PCB BOX-L': 1, 'PCB BOX-M': 6, 'PAPER-L': 4,
    '712696': 16, '712896': 20, '714420': 3, '711110': 10, '711956': 5,
    '048-9805': 7, '712664': 6, '159-9801': 3, '714645': 2,
    '716150': 4, '712949': 3,
  },
  '볼트랙': {
    'PLASTIC-XL': 4, 'PLASTIC-M': 10, 'PLASTIC-S': 20,
    'PCB BOX-L': 2, 'PCB BOX-M': 3, 'PAPER-L': 4,
    '712696': 20, '712896': 20, '714420': 3, '711110': 24, '711956': 6,
    '048-9805': 9, '712664': 6, '159-9801': 3, '714645': 4,
    '716150': 6, '712949': 3,
  },
};

// 모델별 BOM 무게 (kg) - 실제 BOM 계산값
const MODEL_WEIGHTS = {
  // 48 시리즈
  'RSC48': { name: 'Maxwell RSC48', code: 'AS8500', avgWeight: 40.66, bomItems: 234, series: '48' },
  'CSC48': { name: 'Maxwell CSC48', code: 'AS8000', avgWeight: 41.09, bomItems: 235, series: '48' },
  // 16 시리즈
  'RSC16': { name: 'Maxwell RSC16', code: 'AS4500', avgWeight: 18.47, bomItems: 159, series: '16' },
  'FSC16': { name: 'Maxwell FSC16', code: 'AS4600', avgWeight: 18.29, bomItems: 158, series: '16' },
  'CSC16': { name: 'Maxwell CSC16', code: 'AS6000', avgWeight: 18.35, bomItems: 160, series: '16' },
  // HSM
  'HSM3': { name: 'HSM 3.0', code: 'A2715', avgWeight: 30.99, bomItems: 145, series: 'HSM' }
};

// 모델별 BOM 데이터 (Material: 필요수량) - BOM최종_020426 기준
const MODEL_BOM_DATA = {
  'RSC48': {
    '712582': 1, '716652': 4, '712586': 1, '712696': 3, '712636': 1, '712701': 3, '712821': 3, '712655': 38,
    '715024': 1, 'KB0673': 3, '712588': 2, '712587': 1, '712635': 1, '712641': 10, '712646': 2, '713646': 1,
    '712634': 1, '712583': 1, '712680': 3, '712585': 1, '712584': 1, '712929': 1, '712896': 2, '712930': 2,
    '081-9801': 2, 'KB0438': 56, '712658': 65, '712660': 43, '710381': 8, 'KB0132': 20, '711106': 7, '714027': 3,
    '714028': 3, '714930': 3, '712591': 1, 'KB0782': 1, '800-0430': 400, '712600': 8, '712662': 24, 'KB0783': 1,
    '712589': 1, '711135': 6, '712590': 1, '712592': 1, '712593': 1, '712682': 1, '712647': 2, '712598': 8,
    '710389': 25, '710385': 10, '712653': 8, '713123': 1, '713124': 1, '713722': 6.5, '711673': 8, '712618': 1,
    '712664': 2, '081-0802': 2, '075-9821': 16, '712613': 1, '714162': 1, '714163': 2, '712640': 2, '714164': 1,
    '714165': 1, '712639': 6, '712632': 1, '712631': 1, '714157': 2, 'KB0798': 2, '713942': 4, '714167': 4,
    '075-9822': 4, 'KB0064': 8, '712580': 4, '712581': 4, '713046': 8, '712633': 4, '712612': 4, '713645': 4,
    'KB0802': 4, '712661': 6, '712657': 48, '71242': 15, '712607': 1, '712606': 1, '712603': 1, '712602': 1,
    'KB0768': 1, '712608': 1, '712609': 2, '712669': 2, '712667': 2, '099-9303': 28.74, '711202': 48, '712604': 1,
    '712659': 16, '712630': 1, 'KB0835': 1, '712627': 1, '716150': 1, '712695': 2, 'KB0837': 1, '716151': 1,
    '712683': 1, '714420': 1, '714422': 1, '714413': 1, '712654': 56, '714406': 1, '714421': 1, '716153': 70,
    'KB0775': 1, '712628': 1, 'KB0784': 1, '712697': 1, '712681': 2, '711293': 2, '712687': 1, '712945': 1,
    '711125': 4, '712772': 6, '712624': 1, '711204': 19, '079-0800': 19, '017678': 1, 'KB0771': 1, '715045': 1,
    '715047': 2, '9800-880': 1, '712689': 1, '712948': 2, '712691': 1, '712622': 1, '712935': 6, '713412': 4,
    '712937': 2, '713413': 2, '712939': 1, '712940': 1, '713125': 4, '017680': 1, '018141': 1, '017681': 1,
    '017677': 1, '017899': 1, '712941': 1, '712942': 1, '712943': 1, '712944': 2, 'KB0780': 1, '712932': 1,
    '712626': 1, 'KB0785': 1, '712686': 1, '712947': 2, '712955': 2, 'KB0840': 1, '714060': 1, '712949': 1,
    '714400': 4, '715713': 1, '715714': 1, '715715': 1, '714444': 2, '715298': 1, '715299': 1, 'KB0770': 2,
    '712605': 2, '712621': 48, '711119': 48, '711118': 96, '712623': 48, '711251': 1, '712648': 6, 'KB0776': 1,
    '712611': 1, '712668': 2, '712055': 800, '712649': 2, '712595': 2, '711191': 48, '711194': 48, '711143': 4,
    '050-0029': 4, '71885': 2, '713139': 2, 'KB0778': 1, '712594': 1, '715851': 1, '712620': 1, 'KB0786': 1,
    '714645': 1, '714646': 1, '714647': 1, '714087': 1, '714681': 1, '714682': 1, '714683': 2, '714684': 2,
    '714686': 1, '714981': 6, '711668': 4, '710377': 6, '712685': 1, '713780': 1, '710437': 1, '713129': 1,
    '713130': 1, '713131': 1, '713132': 1, '713133': 1, '713134': 1, '713135': 1, '713136': 1, '713137': 1,
    '713138': 1, '713140': 1, '713141': 1, '713220': 4, '050-9811': 1, '71331': 1, '713142': 1, '050-0040': 2,
    '71790': 1, '713242': 4, '9LT314': 1, '9BR300': 1, '9FB216': 1, '9GE817': 1, '713682': 1, '714904': 1,
    '716551': 1, '72410': 1,
  },
  'CSC48': {
    '712582': 1, '716652': 4, '712586': 1, '712696': 3, '712636': 1, '712701': 3, '712821': 3, '712655': 38,
    '715024': 1, 'KB0673': 3, '712588': 2, '712587': 1, '712635': 1, '712641': 10, '712646': 2, '713646': 1,
    '712634': 1, '712583': 1, '712680': 3, '712585': 1, '712584': 1, '712929': 1, '712896': 2, '712930': 2,
    '081-9801': 2, 'KB0438': 56, '712658': 65, '712660': 43, '710381': 8, 'KB0132': 20, '711106': 7, '714027': 3,
    '714028': 3, '714930': 3, '712591': 1, 'KB0782': 1, '800-0430': 400, '712600': 8, '712662': 24, 'KB0783': 1,
    '712589': 1, '711135': 6, '712590': 1, '712592': 1, '712593': 1, '712682': 1, '712647': 2, '712598': 8,
    '710389': 25, '710385': 10, '712653': 8, '713123': 1, '713124': 1, '713722': 6.5, '711673': 8, '712618': 1,
    '712664': 2, '081-0802': 2, '075-9821': 16, '712613': 1, '714162': 1, '714163': 2, '712640': 2, '714164': 1,
    '714165': 1, '712639': 6, '712632': 1, '712631': 1, '714157': 2, 'KB0798': 2, '713942': 4, '714167': 4,
    '075-9822': 4, 'KB0064': 8, '712580': 4, '712581': 4, '713046': 8, '712633': 4, '712612': 4, '713645': 4,
    'KB0802': 4, '712661': 6, '712657': 48, '71242': 15, '712607': 1, '712606': 1, '712603': 1, '712602': 1,
    'KB0768': 1, '712608': 1, '712609': 2, '712669': 2, '712667': 2, '099-9303': 28.74, '711202': 48, '712604': 1,
    '712659': 16, '712630': 1, 'KB0835': 1, '712627': 1, '716150': 1, '712695': 2, 'KB0837': 1, '716151': 1,
    '712683': 1, '714420': 1, '714422': 1, '714413': 1, '712654': 56, '714406': 1, '714421': 1, '716153': 70,
    'KB0775': 1, '712628': 1, 'KB0784': 1, '712697': 1, '712681': 2, '711293': 2, '712687': 1, '712945': 1,
    '711125': 4, '712772': 6, '712624': 1, '711204': 19, '079-0800': 19, '017678': 1, 'KB0771': 1, '715045': 1,
    '715047': 2, '9800-880': 1, '712689': 1, '712948': 2, '712691': 1, '712622': 1, '712935': 6, '713412': 4,
    '712937': 2, '713413': 2, '714141': 1, '712940': 1, '713125': 4, '017680': 1, '018141': 1, '017681': 1,
    '017677': 1, '017899': 1, '71385': 1, '714140': 1, '714158': 1, '714159': 1, '712944': 2, 'KB0780': 1,
    '712932': 1, '712626': 1, 'KB0785': 1, '712686': 1, '712947': 2, '712955': 2, 'KB0840': 1, '714060': 1,
    '712949': 1, '714400': 4, '715713': 1, '715714': 1, '715715': 1, '714444': 2, '715298': 1, '715299': 1,
    'KB0770': 2, '712605': 2, '712621': 48, '711119': 48, '711118': 96, '712623': 48, '711251': 1, '712648': 6,
    'KB0776': 1, '712611': 1, '712668': 2, '712055': 800, '712649': 2, '712595': 2, '711191': 48, '711194': 48,
    '711143': 4, '050-0029': 4, '71885': 2, '713139': 2, 'KB0778': 1, '712594': 1, '715851': 1, '712620': 1,
    'KB0786': 1, '714645': 1, '714646': 1, '714647': 1, '714087': 1, '714681': 1, '714682': 1, '714683': 2,
    '714684': 2, '714686': 1, '714981': 6, '711668': 4, '710377': 6, '712685': 1, '713780': 1, '710437': 1,
    '713129': 1, '713130': 1, '713131': 1, '713132': 1, '713133': 1, '713134': 1, '713135': 1, '713136': 1,
    '713137': 1, '713138': 1, '713140': 1, '713141': 1, '713220': 4, '050-9811': 1, '71331': 1, '713142': 1,
    '73727': 2, '713242': 4, '713682': 1, '714904': 1, '716551': 1, '72320': 1, '9FB231': 1, '9LT312': 1,
    '9BR320': 1, '72410': 1, '9FDC008': 1,
  },
  'RSC16': {
    '050-0040': 2, '050-0029': 3, '71300': 1, '71242': 16, 'KB0788': 1, '711115': 1, '712621': 16, '712623': 16,
    '711118': 32, '711119': 16, '711251': 0.25, 'KB0125': 3, 'KB0737': 1, '711142': 1, '711191': 16, '711194': 16,
    '711201': 1, '075-9805': 23, '711141': 1, 'KB0438': 8, '711143': 2, '71290': 1, '712055': 250, '71885': 1,
    '715851': 1, '716655': 1, '716648': 1, '711101': 1, '711102': 1, '711103': 1, '711104': 2, '711105': 2,
    '711106': 19, '716652': 4, '711120': 1, '9000-375': 1, 'KB0392': 23, 'KB0749': 1, '711123': 1, '711956': 1,
    '712658': 46, '711121': 1, '711190': 1, '711192': 1, '074-9802': 1, '079-9803': 2, '712660': 9, '081-9801': 1,
    '711131': 1, '711135': 2, '711132': 1, '711133': 3, '711134': 3, '710388': 3, '9800-830': 1, '082-0306': 11,
    '711214': 1, '711136': 2, 'KB0389': 8, '201-9802': 1, '711203': 1, '075-9815': 32, '132-9800': 1, '800-0430': 150,
    '711138': 2, 'KB0140': 4, 'KB0800': 1, '073-9800': 1, 'KB0801': 1, '711137': 4, '075-9822': 4, 'KB0724': 1,
    '711114': 1, '048-9805': 2, '713046': 28, '711107': 1, '711108': 1, '711109': 1, '711110': 4, '711111': 1,
    '114-9804': 1, '099-9303': 10, '711202': 16, '711193': 1, '711112': 1, '075-9825': 14, '711113': 1, '711144': 2,
    'KB0733': 1, '715046': 1, '715047': 2, '9800-880': 1, '711130': 1, '021-0608': 1, '712948': 2, '091-0190': 1,
    '713047': 14, '711196': 1, '711157': 2, '711293': 2, 'KB0731': 1, '711124': 1, '716150': 1, '159-9801': 1,
    '711126': 1, '129-9800': 2, '713730': 1, '716152': 1, '081-0802': 4, '021-9804': 1, '037-0055': 2, '716153': 70,
    '711125': 3, 'KB0838': 1, '711139': 2, 'KB0673': 2, '021-1006': 1, 'KB0746': 1, '711950': 1, '017678': 1,
    '079-0800': 5, '711204': 5, '059-9800': 1, '711100': 1, '711140': 1, '019-9803': 2, '017680': 1, '018141': 1,
    '017681': 1, '017677': 1, '017899': 1, '078-9800': 2, '711195': 2, '711198': 4, '712021': 1, '711957': 1,
    '71286': 1, '71289': 1, '71321': 1, '711145': 1, '711146': 1, '711147': 1, '711151': 1, '711152': 1,
    '9FB168': 1, '9BR264': 1, '9LT311': 1, '050-9811': 1, '712959': 1, '71331': 1, 'E6150': 1, '711638': 1,
    '71443': 1, '71444': 1, '71445': 1, '713683': 1, '714904': 1, '716551': 1, '72410': 1,
  },
  'FSC16': {
    '050-0040': 2, '71242': 16, 'KB0788': 1, '711115': 1, '712621': 16, '712623': 16, '711118': 32, '711119': 16,
    '711251': 0.25, 'KB0125': 3, 'KB0737': 1, '711142': 1, '711191': 16, '711194': 16, '711201': 1, '075-9805': 23,
    '711141': 1, 'KB0438': 8, '711143': 2, '71290': 1, '050-0029': 3, '712055': 250, '71885': 1, '715851': 1,
    '716655': 1, '716648': 1, '711101': 1, '711102': 1, '711103': 1, '711104': 2, '711105': 2, '711106': 19,
    '716652': 4, '711120': 1, '9000-375': 1, 'KB0392': 23, 'KB0749': 1, '711123': 1, '711956': 1, '712658': 46,
    '711121': 1, '711190': 1, '711192': 1, '074-9802': 1, '079-9803': 2, '712660': 9, '081-9801': 1, '711131': 1,
    '711135': 2, '711132': 1, '711133': 3, '711134': 3, '710388': 3, '9800-830': 1, '082-0306': 11, '711214': 1,
    '711136': 2, 'KB0389': 8, '201-9802': 1, '711203': 1, '075-9815': 32, '132-9800': 1, '800-0430': 150, '711138': 2,
    'KB0140': 4, 'KB0800': 1, '073-9800': 1, 'KB0801': 1, '711137': 4, '075-9822': 4, 'KB0724': 1, '711114': 1,
    '048-9805': 2, '713046': 28, '711107': 1, '711108': 1, '711109': 1, '711110': 4, '711111': 1, '114-9804': 1,
    '099-9303': 10, '711202': 16, '711193': 1, '711112': 1, '075-9825': 14, '711113': 1, '711144': 2, 'KB0733': 1,
    '715046': 1, '715047': 2, '9800-880': 1, '711130': 1, '021-0608': 1, '712948': 2, '091-0190': 1, '713047': 14,
    '711196': 1, '711157': 2, '711293': 2, 'KB0731': 1, '711124': 1, '716150': 1, '159-9801': 1, '711126': 1,
    '129-9800': 2, '713730': 1, '716152': 1, '081-0802': 4, '021-9804': 1, '037-0055': 2, '716153': 70, '711125': 3,
    'KB0838': 1, '711139': 2, 'KB0673': 2, '021-1006': 1, 'KB0746': 1, '711950': 1, '017678': 1, '079-0800': 5,
    '711204': 5, '059-9800': 1, '711100': 1, '712290': 1, '712021': 1, '019-9803': 2, '017680': 1, '018141': 1,
    '017681': 1, '017677': 1, '017899': 1, '078-9800': 2, '711195': 2, '711198': 4, '711957': 1, '71286': 1,
    '711638': 1, '71289': 1, '71321': 1, '711145': 1, '711146': 1, '711147': 1, '711151': 1, '711152': 1,
    '050-9811': 1, '712959': 1, '71331': 1, '71443': 1, '71444': 1, '71445': 1, '713780': 1, '71654': 1,
    '9BR283': 1, '9FB194': 1, '9LT313': 1, '713683': 1, '714904': 1, '72410': 1,
  },
  'CSC16': {
    '73727': 2, '050-0029': 3, '050-9809': 1, '71242': 16, 'KB0125': 3, 'KB0737': 1, '711142': 1, '711191': 16,
    '711194': 16, '711201': 1, '075-9805': 23, '711141': 1, 'KB0438': 8, '711143': 2, '71290': 1, '712055': 250,
    '71885': 1, '715298': 1, '715851': 1, '715299': 1, '711101': 1, '711102': 1, '711103': 1, '711104': 2,
    '711105': 2, '711106': 19, '716652': 4, '711120': 1, '9000-375': 1, 'KB0392': 23, 'KB0749': 1, '711123': 1,
    '711956': 1, '712658': 46, '711121': 1, '711190': 1, '711192': 1, '074-9802': 1, '079-9803': 2, '712660': 9,
    '081-9801': 1, '711131': 1, '711135': 2, '711951': 1, '711133': 3, '711134': 3, '710388': 3, '9800-830': 1,
    '082-0306': 11, '711214': 1, '711136': 2, 'KB0389': 8, '201-9802': 1, '711203': 1, '075-9815': 32, '132-9800': 1,
    '800-0430': 150, '711138': 2, 'KB0140': 4, 'KB0800': 1, '073-9800': 1, 'KB0801': 1, '711137': 4, '075-9822': 4,
    'KB0724': 1, '711114': 1, '048-9805': 2, '713046': 28, '711107': 1, '711108': 1, '711109': 1, '711110': 4,
    '711111': 1, '114-9804': 1, '099-9303': 10, '711202': 16, '711193': 1, '711112': 1, '075-9825': 14, '711113': 1,
    '711144': 2, 'KB0733': 1, '715046': 1, '715047': 2, '9800-880': 1, '711130': 1, '021-0608': 1, '712948': 2,
    '091-0190': 1, '713047': 14, '711196': 1, '711157': 2, '711293': 2, 'KB0731': 1, '711124': 1, '716150': 1,
    '159-9801': 1, '711126': 1, '129-9800': 2, '713730': 1, '716152': 1, '081-0802': 4, '021-9804': 1, '037-0055': 2,
    '716153': 70, '711125': 3, 'KB0838': 1, '711139': 2, 'KB0673': 2, '021-1006': 1, 'KB0746': 1, '711950': 1,
    '017678': 1, '079-0800': 5, '711204': 5, '059-9800': 1, '711473': 1, '711474': 1, '712021': 1, '019-9803': 2,
    '017680': 1, '018141': 1, '017681': 1, '017677': 1, '017899': 1, '078-9800': 2, '711195': 2, '711198': 4,
    '71385': 1, '711957': 1, 'KB0727': 1, '711115': 1, '711116': 16, '711117': 16, '711118': 32, '711119': 16,
    '711251': 0.25, '71286': 1, '711638': 1, '71289': 1, '71321': 1, '711145': 1, '711146': 1, '711147': 1,
    '711151': 1, '711152': 1, '050-9811': 1, '712959': 1, '71331': 1, '71443': 1, '71444': 1, '71445': 1,
    '9LT308': 1, '9FB179': 1, '9FDC007': 1, '713683': 1, '714904': 1, '713780': 1, '716551': 1, '72410': 1,
  },
  'HSM3': {
    '71140': 1, '017810': 1, '71242': 9, '710364': 1, '710365': 1, 'KB0438': 18, '710366': 1, '710376': 2,
    '017677': 1, '017678': 1, '017680': 1, '017681': 1, '017682': 1, '017899': 1, '710362': 1, '710318': 1,
    '710405': 1, '710406': 2, '710407': 1, '710363': 2, '710421': 4, '710413': 4, 'KB0677': 12, '710403': 1,
    '710404': 1, '710361': 1, 'KB0391': 8, 'KB0511': 4, '017679': 1, 'KB0133': 5, '710530': 3, '710394': 1,
    '017916': 1, '018263': 1, '018264': 1, '710423': 1, '710424': 1, '710425': 1, '710426': 1, '710427': 4,
    '710428': 2, '710429': 2, '710430': 2, '710431': 1, '710432': 1, '710433': 2, '710434': 1, '710435': 2,
    '710437': 1, '710438': 1, '710439': 1, '710336': 1, '710316': 1, '710317': 1, '710319': 4, '710322': 1,
    '710326': 1, '710329': 4, '710330': 36, '710331': 2, '710332': 1, '710333': 1, '710334': 1, '710335': 2,
    '710337': 1, '710338': 1, '710339': 1, '710340': 1, '710341': 1, '710342': 1, '710343': 1, '710344': 1,
    '710345': 2, '710346': 4, '710347': 1, '710348': 4, '710349': 1, '710350': 1, '710353': 1, '710354': 1,
    '710355': 1, '710356': 1, '710357': 8, '710358': 2, '710359': 1, '710360': 1, '710367': 1, '710368': 1,
    '710369': 1, '710370': 7, '710372': 2, '710373': 2, '710374': 4, '710375': 2, '710377': 24, '710378': 2,
    '710379': 4, '710380': 4, '710381': 45, '710382': 16, '710383': 5, '710386': 8, '710388': 4, '710389': 7,
    '710390': 6, '710391': 4, '710393': 1, '710395': 1, '710396': 1, '710397': 1, '710398': 1, '710399': 1,
    '710400': 1, '710401': 1, '710402': 4, '710408': 1, '710409': 1, '710410': 1, '710411': 1, '710412': 8,
    '710420': 4, 'KB0379': 1, 'KB0381': 3, 'KB0382': 1, 'KB0389': 5, 'KB0390': 19, 'KB0402': 4, 'KB0408': 2,
    'KB0436': 1, 'KB0485': 4, 'KB0140': 12, 'KB0145': 2, 'KB0146': 2, 'KB0177': 15, 'KB0183': 2, 'KB0132': 1,
    '710385': 16, '711139': 3, '716652': 4, '711125': 9, '71141': 1, '71142': 1, '9FB134': 1, 'SP1083': 1,
    '711919': 1,
  },
};

// 랙 설정 (최대 중량, Bin 크기 등) - 나중에 수정 가능
const RACK_CONFIG = {
  maxWeightPerBin: 50, // kg
  maxWeightPerRack: 500, // kg
  binDimensions: { width: 40, depth: 60, height: 30 } // cm
};

// 무게 데이터 (원자재_무게_측정_등록_작업.xlsx 기준 - 515개 Material)
// d: Description, w: Weight(kg), b: Bin
// 총 515개 Material
const DEFAULT_WEIGHT_DATA = {
  '712626': { d: 'LED INDICATOR BRACKET', w: 0.244, b: 'A1-01' },
  '712944': { d: 'Bracket, Main Enclosure, MX48', w: 0.086, b: 'A1-01' },
  '712591': { d: 'DECK LOW, PLATE , MX48', w: 1.82, b: 'A1-02' },
  '712630': { d: 'Board Cover, MX48', w: 0.3035, b: 'A1-02' },
  '714162': { d: 'Vertical, Motor Plate Top, MX48_CSC', w: 0.509, b: 'A1-03' },
  '712624': { d: 'BACK PLATE, MX48', w: 0.4635, b: 'A1-03' },
  '712613': { d: 'VERTICAL, LEFT PLATE, MX48', w: 0.4195, b: 'A1-04' },
  '712618': { d: 'VERTICAL, RIGHT PLATE, MX48', w: 0.42, b: 'A1-04' },
  '712627': { d: 'SHELF, MAIN BOARD, MX48', w: 0.317, b: 'A1-04' },
  '712608': { d: 'PLUNGER BAR, MX48', w: 0.343, b: 'A1-05' },
  '712602': { d: 'Magnet Bar,Left, MX48', w: 0.145, b: 'A1-05' },
  '712603': { d: 'Magnet Bar, Right , MX48', w: 0.152, b: 'A1-05' },
  '712606': { d: 'PLUNGER BAR, LEFT, MX48', w: 0.1535, b: 'A1-05' },
  '712607': { d: 'Plunger Bar, Right, MX48', w: 0.1475, b: 'A1-05' },
  '712604': { d: 'Magnet Bar,MX48', w: 0.439, b: 'A1-06' },
  '712620': { d: 'Vision, lighting bracket, MX48', w: 0.403, b: 'A1-06' },
  '712929': { d: 'Back Plate, Bottom, MX48', w: 0.1115, b: 'A1-06' },
  '712696': { d: 'ST.Motor With Encoder, MX-48', w: 0.427, b: 'A2-01' },
  '714420': { d: 'LPS365M Power Supply', w: 0.4055, b: 'A2-02' },
  '715713': { d: 'Back Plate, New Tablet, MX48', w: 0.2745, b: 'A2-03' },
  '715715': { d: 'Bottom grip, New Tablet, MX48', w: 0.073, b: 'A2-03' },
  '714060': { d: 'Support bar, Tablet, SM', w: 0.0995, b: 'A2-03' },
  'KB0781': { d: 'Machine Vision ASM,MX48', w: 0.587, b: 'A2-04' },
  '712594': { d: 'Tray Back, Low Profile, MX48', w: 0.7085, b: 'A2-04' },
  '712611': { d: 'Tray Front, Low Profile, MX48', w: 0.704, b: 'A2-04' },
  '712664': { d: 'LM Guide, MX48', w: 0.0905, b: 'A2-05' },
  '712896': { d: 'SPEED GUIDE, MX48', w: 0.983, b: 'A2-05' },
  '714413': { d: 'DC FAN for LPS365-M', w: 0.057, b: 'A2-05' },
  '710343': { d: 'Spindle AL6061-T6 / Anodizing(White', w: 0.3675, b: 'A3-01' },
  '710344': { d: 'Spindle Coupling AL6061-T6 / Anodiz', w: 0.1485, b: 'A3-01' },
  '710359': { d: 'Board Bracket AL5052P / Spray(Silve', w: 0.2, b: 'A3-01' },
  '710375': { d: 'Shaft PSSFGW8-275-M4-N4', w: 0.1061, b: 'A3-01' },
  '710347': { d: 'Heat Block Lower ACETAL / Black', w: 0.588, b: 'A3-02' },
  '710335': { d: 'Magnet Holder AL6061-T6 / Anodizing', w: 0.17314, b: 'A3-02' },
  '710362': { d: 'Power Supply Case Bottom AL5052P / ', w: 0.2905, b: 'A3-02' },
  '710361': { d: 'Power Supply Case Cover AL5052P / P', w: 0.36769, b: 'A3-02' },
  '710318': { d: 'Power Supply Input : 85~264VAC, 47~', w: 1.123, b: 'A3-03' },
  '710346': { d: 'Heat Block AL6061-T6 / Anodizing(Wh', w: 0.37334, b: 'A3-04' },
  '710350': { d: 'Heat Block Metal Cover AL6061-T6 / ', w: 0.65548, b: 'A3-04' },
  '710348': { d: 'Heat Block Gasket ACETAL / Black', w: 0.05619, b: 'A3-05' },
  '710339': { d: 'Shaft SUS303', w: 0.076765, b: 'A3-05' },
  '710338': { d: 'Eccentric Shaft SUS303', w: 0.05852, b: 'A3-05' },
  '710337': { d: 'Eccentric Wheel Brass/Nickel Platin', w: 0.43134, b: 'A3-06' },
  '710333': { d: 'Magnet Back Wall AL6061-T6 / Anodiz', w: 0.27985, b: 'A3-06' },
  '710334': { d: 'Magnet Front Wall AL6061-T6 / Anodi', w: 0.29998, b: 'A3-07' },
  '710332': { d: 'BLDC Motor Housing AL6061-T6 / Anod', w: 0.1, b: 'A3-07' },
  '710336': { d: 'Base Plate SUS304', w: 7.8, b: 'A3-08' },
  '711124': { d: 'Shelf MLB, Ares', w: 0.2315, b: 'A5-01' },
  '711102': { d: 'Vertical Side -R, Ares', w: 0.4175, b: 'A5-02' },
  '711103': { d: 'Vertical Side -L, Ares', w: 0.4185, b: 'A5-02' },
  '711101': { d: 'Base Plate, Ares', w: 2.1085, b: 'A5-03' },
  '711111': { d: 'Plunger Bar, Ares', w: 0.256, b: 'A5-05' },
  '711114': { d: 'Magnet Bar, Ares', w: 0.1895, b: 'A5-05' },
  '711142': { d: 'Tray, Low Profile, Ares', w: 0.4815, b: 'A5-06' },
  '711131': { d: 'Deck Low Profile, Ares', w: 0.4505, b: 'A6-01' },
  '711950': { d: 'Back Panel, CSC', w: 0.3805, b: 'A6-03' },
  '711110': { d: 'LM Guide ML9, Pre-Load, 110mm', w: 0.055, b: 'A6-04' },
  '711956': { d: 'Horizontal Motor, End cut', w: 0.4175, b: 'A6-05' },
  '048-9805': { d: 'Vertical Motor, Leadscrew&Nut, Ares', w: 0.3975, b: 'A6-06' },
  '9800-830': { d: 'PCBA-Heater Assy, Ares', w: 0.027, b: 'A7-01' },
  'KB0746': { d: 'PCBA, USB Hub 4 Port Out, CSC', w: 0.0285, b: 'A7-01' },
  'KB0838': { d: 'Instrument Platform Maxwell LLC', w: 0.1465, b: 'A7-02' },
  '712589': { d: 'Deck Low, Back-F, MX48', w: 0.1615, b: 'B1-01' },
  '712590': { d: 'Deck Low, Back-B, MX48', w: 0.156, b: 'B1-01' },
  '712592': { d: 'DECK LOW, SIDE-L, MX48', w: 0.088, b: 'B1-02' },
  '712593': { d: 'DECK LOW, SIDE-R, MX48', w: 0.088, b: 'B1-02' },
  '712605': { d: 'MAGNET ROD, BLOCK, MX48', w: 0.1165, b: 'B1-03' },
  '712955': { d: 'Support Tablet, MX48', w: 0.025, b: 'B1-03' },
  '712628': { d: 'USB Terminal Board Bracket', w: 0.1935, b: 'B1-04' },
  '712588': { d: 'BASE, SLIDE RAIL, MX48', w: 0.0355, b: 'B1-04' },
  '712609': { d: 'PLUNGER, COVER, MX48', w: 0.0785, b: 'B1-05' },
  '715045': { d: 'New UV Lamp, Hood, MX48', w: 0.1935, b: 'B1-05' },
  '714421': { d: 'LPS365M Power Supply Plate', w: 0.053, b: 'B1-06' },
  '712647': { d: 'Deck, Guide Line, MX48', w: 0.031, b: 'B1-07' },
  '714422': { d: 'Cover LPS365M Power supply', w: 0.079, b: 'B1-07' },
  '714164': { d: 'Vertical, Motor Plate-L, MX48_CSC', w: 0.12, b: 'B1-08' },
  '714165': { d: 'Vertical, Motor Plate-R, MX48_CSC', w: 0.1195, b: 'B1-08' },
  '712622': { d: 'Support Hinge, Door, MX48', w: 0.131, b: 'B1-09' },
  '714163': { d: 'Vertical, Motor Housing, MX48_CSC', w: 0.043, b: 'B1-09' },
  'KB0798': { d: 'Shaft 450mm with Bearing inserted', w: 0.2565, b: 'B1-10' },
  '9800-880': { d: 'PCBA-UV Lamp Converter Assy, Ares', w: 0.038, b: 'B1-11' },
  'KB0784': { d: 'PCBA-USB TERMINAL, MX-48', w: 0.016, b: 'B1-14' },
  '711115': { d: 'Interchange Block, Ares', w: 0.0615, b: 'B2-01' },
  '711112': { d: 'Spacer Plunger Cover, Ares', w: 0.112, b: 'B2-03' },
  '711126': { d: 'Shield, Power Supply, Ares', w: 0.105, b: 'B2-05' },
  '711132': { d: 'Heater Block, Ares', w: 0.1595, b: 'B2-06' },
  '711951': { d: 'Heater Block, CSC', w: 0.16, b: 'B2-07' },
  '711107': { d: 'Vertical Back, Ares', w: 0.5645, b: 'B2-08' },
  '711130': { d: 'UV Lamp Hood, Ares', w: 0.0585, b: 'B2-10' },
  '711109': { d: 'LM Cover, Ares', w: 0.032, b: 'B2-11' },
  '711108': { d: 'Vertical Upper, Ares', w: 0.207, b: 'B2-12' },
  '715046': { d: 'New UV Lamp, Reflector, MX16', w: 0.117, b: 'B2-14' },
  '159-9801': { d: 'Power Supply, 24V/150W/Open FRM, Me', w: 0.1815, b: 'B2-18' },
  'KB0782': { d: 'PCBA-HEAT Front, MX-48', w: 0.2225, b: 'B3-01' },
  'KB0783': { d: 'PCBA-HEAT Back, MX-48', w: 0.2225, b: 'B3-02' },
  'KB0785': { d: 'PCBA-LED INDICATOR, MX-48', w: 0.053, b: 'B3-03' },
  'KB0786': { d: 'PCBA-V.LIGHT, MX-48', w: 0.0465, b: 'B3-04' },
  'KB0837': { d: 'Instrument Platform Maxwell 48 LLC', w: 0.199, b: 'B3-05' },
  '711919': { d: 'Dsub Serial Cable, 3M', w: 0.16753, b: 'B4-01' },
  '710319': { d: 'Kapton Flim Heater 24V/80W', w: 0.010162, b: 'B4-02' },
  '710345': { d: 'Spring Mount AL6061-T6 / Anodizing(', w: 0.04402, b: 'B4-02' },
  'SP1083': { d: 'RS-232 USB Adaptor, Maxwell®16', w: 0.11745, b: 'B4-03' },
  '710395': { d: 'Panel Mount HSM \"Wire : AWG20, 300', w: 0.024273, b: 'B4-04' },
  '710331': { d: 'Bearing 3202ANT9(SKF)', w: 0.06396, b: 'B4-04' },
  '710420': { d: 'Ceramic Paper 55×250 / 1300 PAPER #', w: 0.008932, b: 'B4-05' },
  '710407': { d: 'Power Entry Module (KMF1.1191.11) 1', w: 0.05658, b: 'B4-06' },
  '710376': { d: 'Trim TRAT2.4-B-5 (400mm)', w: 0.02028, b: 'B4-06' },
  '710403': { d: 'Panel Mount_PowerSupply \"Wire : AW', w: 0.06627, b: 'B4-07' },
  '710394': { d: '24V Power Cable \"Cable : AWG16, 60', w: 0.44247, b: 'B4-08' },
  '710367': { d: 'T/Pulley P84-3GT-9-33F', w: 0.14663, b: 'B4-09' },
  '710371': { d: 'Foot  FBFS33-8-30', w: 0.04184, b: 'B4-09' },
  '710330': { d: 'Magnet 15x15, 150\'C', w: 0.01941, b: 'B4-10' },
  '710408': { d: 'Main Board Size : 80 * 99,  6 Layer', w: 0.05431, b: 'B4-11' },
  '710409': { d: 'Motor Drive Board Size : 65 * 80 (m', w: 0.03611, b: 'B4-12' },
  '710410': { d: 'Terminal Board Size : 180 * 25 (mm)', w: 0.02242, b: 'B4-13' },
  '710411': { d: 'LED Board Size : 34 * 16 (mm), 2 La', w: 0.001833, b: 'B4-14' },
  '710360': { d: 'Case EGI 1.2T /Powder Coating(Silve', w: 1.56864, b: 'B4-16' },
  '710364': { d: 'Rack Cover AL5052P / Anodizing(blac', w: 0.19021, b: 'B4-17' },
  '710366': { d: 'Rack Stand SUS304', w: 1.52458, b: 'B4-17' },
  '710365': { d: 'Rack Inner AL5052P / Anodizing(blac', w: 0.16294, b: 'B4-17' },
  '711201': { d: 'Guide E-Tube Tray, Ares', w: 0.016, b: 'C1-01' },
  '9000-375': { d: 'Unsealed Opto Sensor Assy, 19\"', w: 0.00646, b: 'C1-01' },
  '716152': { d: 'Cable-Earth Ground_MX16', w: 0.01939, b: 'C1-01' },
  '711202': { d: 'Roller Lock, Plunger, Ares', w: 5e-05, b: 'C1-01' },
  '711293': { d: 'Nut, Sensor Bracket', w: 0.00038, b: 'C1-01' },
  '712771': { d: 'Cable-Earth Ground, MX-48', w: 0.00423, b: 'C1-01' },
  '711190': { d: 'Adapter Fitting, Ares', w: 0.00647, b: 'C1-02' },
  '711116': { d: 'Magnet Shaft, Ares', w: 0.006, b: 'C1-02' },
  '711117': { d: 'Magnet, Ares', w: 0.00038, b: 'C1-02' },
  '081-9801': { d: 'Flat Tie Wrap Holder, 4.582 Long, Ø', w: 0.01022, b: 'C1-02' },
  '711104': { d: 'Shaft Holder -L, Ares', w: 0.01652, b: 'C1-03' },
  '711105': { d: 'Shaft Holder -R, Ares', w: 0.01654, b: 'C1-03' },
  '711214': { d: 'Ribbon Cable, 10Pos, 22\"', w: 0.01374, b: 'C1-03' },
  '712621': { d: 'Magnet Shaft, DP5.5', w: 0.00614, b: 'C1-03' },
  '711192': { d: 'Anti Rotation Pin Lock, Ares', w: 0.00178, b: 'C1-03' },
  '711133': { d: 'Unthreaded Spacer, Ares', w: 0.00066, b: 'C1-04' },
  '711134': { d: 'Flat Head Spacer, Ares', w: 0.00036, b: 'C1-04' },
  '712623': { d: 'MAGNET, Φ2.5', w: 0.00033, b: 'C1-04' },
  '711119': { d: 'Coil Spring, Ø6-10L, Ares', w: 0.00034, b: 'C1-04' },
  '711136': { d: 'Door Cam, Ares', w: 0.0095, b: 'C1-05' },
  'KB0801': { d: 'Fork Block ASM, Ares', w: 0.013, b: 'C1-05' },
  '711143': { d: 'Pin Support Tray, Ares', w: 0.0032, b: 'C1-05' },
  'KB0800': { d: 'Glide Pin ASM, Ares', w: 0.000376, b: 'C1-05' },
  '711194': { d: 'Tri-Spring, E-Tube, Ares', w: 0.00013, b: 'C1-05' },
  '711191': { d: 'Gasket Filter, .5\"Dia X .375\"Dia ', w: 0.0001, b: 'C1-05' },
  '711193': { d: 'Spring Plunger, Light, Ares', w: 0.0039, b: 'C1-06' },
  '711123': { d: 'Mount Motor Tray, Ares', w: 0.0353, b: 'C1-06' },
  '711198': { d: 'Pivot Hinge, Door, Ares', w: 0.0035, b: 'C1-06' },
  '711196': { d: 'Bracket, Sensor Door, Ares', w: 0.0197, b: 'C1-06' },
  '114-9804': { d: 'Music Wire, 0.024\"Dia, 304SS', w: 0.0007, b: 'C1-06' },
  '711113': { d: 'Tapper Bar Cartridge, Ares', w: 0.007, b: 'C1-07' },
  '711120': { d: 'Mount Sensor, Ares', w: 0.01233, b: 'C1-07' },
  '711144': { d: 'Unsealed Opto Sensor Assy 12.6\"', w: 0.00497, b: 'C1-07' },
  '711138': { d: 'Shaft, 270L SS, SSFJ-10-270', w: 0.16293, b: 'C1-07' },
  '711121': { d: 'Bracket Angle Drive, Ares', w: 0.01905, b: 'C1-08' },
  '711157': { d: 'Switch Opto Sensor Assy, 9.4\"', w: 0.00428, b: 'C1-08' },
  '021-0608': { d: 'Cable - Flex 1mm Pitch, 8\"', w: 0.00094, b: 'C1-08' },
  '711275': { d: 'Foot, FBFS33-8-10', w: 0.03115, b: 'C1-09' },
  '716652': { d: 'Foot, M8x12', w: 0.039188, b: 'C1-09' },
  '713730': { d: 'Power Input Cable,RSC', w: 0.0084, b: 'C1-09' },
  '091-0190': { d: 'Lamp, Germicidal, UV G4T5, 254NM, 4', w: 0.0132, b: 'C1-10' },
  '021-9804': { d: 'Cable 24V Assy, 8\", Ares', w: 0.01094, b: 'C1-10' },
  '711195': { d: 'Spring Door Hinge, Ares', w: 0.00274, b: 'C1-11' },
  '712021': { d: 'Support Hinge, Door', w: 0.03556, b: 'C1-12' },
  '711141': { d: 'Spring-Cartridge Tray, Ares', w: 0.01019, b: 'C1-12' },
  '711135': { d: 'Ball-Nose Spring Plungers Ø0.25\"', w: 0.00192, b: 'C1-12' },
  '021-1006': { d: 'Cable-USB Hub, 10Pos, 6\"', w: 0.00565, b: 'C1-12' },
  '201-9802': { d: 'Linear Bushing 10mm, LMKW10G', w: 0.0435, b: 'C1-13' },
  '711203': { d: 'Clamp Bearing, Ares', w: 0.033, b: 'C1-13' },
  '711957': { d: 'Support, Horizontal Motor', w: 0.003315, b: 'C1-13' },
  '716430': { d: 'Fixture, Calibration', w: 0.94054, b: 'C1-14' },
  'KB0673': { d: 'Ferrite Core ZCAT 2035-0930', w: 0.02068, b: 'C1-14' },
  '710326': { d: 'Home Sensor(L180) Photo Sensor, 5VD', w: 0.003394, b: 'C2-01' },
  '710322': { d: 'T/Belt 540-3GT-9', w: 0.011887, b: 'C2-01' },
  '710340': { d: 'BLDC Motor Tensioner AL6061-T6 / An', w: 0.006787, b: 'C2-02' },
  '710341': { d: 'Sensing Bar AL6061-T6 / Anodizing(W', w: 0.000505, b: 'C2-02' },
  '710353': { d: 'Bearing cover', w: 0.022935, b: 'C2-03' },
  '710342': { d: 'Sensing Cam AL6061-T6 / Anodizing(W', w: 0.002, b: 'C2-03' },
  '710349': { d: 'LED Bracket ACETAL / White', w: 0.005616, b: 'C2-03' },
  '710356': { d: 'Stepper Motor Housing AL5052P', w: 0.01862, b: 'C2-04' },
  '710354': { d: 'BLDC Home Sensor Bracket AL5052P / ', w: 0.00667, b: 'C2-04' },
  '710355': { d: 'Magnet Cam Bracket AL5052P / No Spr', w: 0.00359, b: 'C2-04' },
  '710368': { d: 'T/Pulley P28-3GT-12-33F', w: 0.02041, b: 'C2-05' },
  '710363': { d: 'Power connector Mount AL5052P / No ', w: 0.00381, b: 'C2-05' },
  '710369': { d: 'T/Belt B114-S3M-5', w: 0.00105, b: 'C2-05' },
  '710396': { d: 'Board InterConnect Cable \"Ribbon C', w: 0.01995, b: 'C2-06' },
  '710393': { d: 'D_Sub-9 female 9P Serial Connector,', w: 0.008595, b: 'C2-06' },
  '710398': { d: 'FAN Right \"DC 24V, 0.07A, 5000RPM,', w: 0.018157, b: 'C2-07' },
  '710399': { d: 'FAN Left \"DC 24V, 0.07A, 5000RPM, ', w: 0.017378, b: 'C2-07' },
  '710397': { d: 'LED Board to M.Board Cable \"Ribbon', w: 0.006794, b: 'C2-07' },
  '710402': { d: 'Temperature Sensor ASSY \"Temperatu', w: 0.001942, b: 'C2-08' },
  '710400': { d: 'Heater Board to M.Board Cable \"Wir', w: 0.02326, b: 'C2-08' },
  '710401': { d: 'Sensor Board to M.Board Cable \"Wir', w: 0.008534, b: 'C2-08' },
  '710405': { d: 'Fuse Drawer (4301.1403) 2-Pole, 110', w: 0.00371, b: 'C2-09' },
  '710404': { d: 'FG Cable to Power Entry Wire : AWG2', w: 0.00232, b: 'C2-09' },
  '710406': { d: 'Fuse (0216008.HXP) 250V, 8A', w: 0.001035, b: 'C2-09' },
  '710412': { d: 'Leaf Spring SUS304/T=0.5', w: 0.004477, b: 'C2-10' },
  '710357': { d: 'Square Washers SUS304', w: 0.001349, b: 'C2-10' },
  '710413': { d: 'Foot PR1-3', w: 0.001065, b: 'C2-10' },
  '710439': { d: 'Spanner 13mm(M8 Nut)', w: 0.088432, b: 'C2-11' },
  '710358': { d: 'Fan Mount Bracket AL5052P / No Spra', w: 0.00534, b: 'C2-11' },
  '710438': { d: 'Allen Key 6mm', w: 0.0285, b: 'C2-11' },
  '713683': { d: 'Window Protect Tape, Ares', w: 0.0075, b: 'C2-11' },
  'KB0382': { d: 'T/Pulley P 10-S30-500-C', w: 0.002133, b: 'C2-12' },
  'KB0381': { d: 'T/Pulley P 20-S30-500-BF', w: 0.006918, b: 'C2-12' },
  'KB0379': { d: 'T/Belt S3M-273-5', w: 0.002462, b: 'C2-12' },
  'KB0436': { d: 'Home Sensor (L570)', w: 0.00682, b: 'C2-13' },
  'KB0402': { d: 'Bearing 696 ZZ', w: 0.003698, b: 'C2-13' },
  '9FB134': { d: 'HSM 3.0 Instrument Quick Protocol C', w: 0.004772, b: 'C2-14' },
  '017785': { d: 'Box, Maxwell® Accessory Pack', w: 0.04564, b: 'C2-15' },
  '710317': { d: 'BLDC Motor 24V/3.6A Max RPM : 4500', w: 0.58833, b: 'C2-17' },
  '710316': { d: 'Stepper Motor 24V/1A, Angle : 1.8 d', w: 0.145, b: 'C2-18' },
  'KB0446': { d: 'UV Bulb Box 40*30*152 ,SC350g', w: 0.01584, b: 'C2-22' },
  '713682': { d: 'Window Protect Tape, MX48', w: 0.010366, b: 'C2-23' },
  '712581': { d: 'BAR, BELT GRIPPER, MX48', w: 0.003855, b: 'C3-01' },
  '712583': { d: 'BASE, BEARING TENSIONER, MX48', w: 0.02327, b: 'C3-01' },
  '712580': { d: 'BAR, BELT GRIPPER COVER, MX48', w: 0.00314, b: 'C3-01' },
  '712600': { d: 'HEAT BLOCK, SPACER, MX48', w: 0.000648, b: 'C3-01' },
  '712587': { d: 'BASE, PULLY HOUSING, MX48', w: 0.0367, b: 'C3-02' },
  '712586': { d: 'BASE, MOUNT MOTOR TRAY, MX48', w: 0.03676, b: 'C3-02' },
  '712636': { d: 'Pulley, Deck Motor, MX48', w: 0.004877, b: 'C3-02' },
  '712612': { d: 'VERTICAL, BEARING HOUSING, MX48', w: 0.00808, b: 'C3-03' },
  '712584': { d: 'BASE, BELT GRIPPER DOWN, MX48', w: 0.005764, b: 'C3-03' },
  '712585': { d: 'BASE, BELT GRIPPER UP, MX48', w: 0.030707, b: 'C3-03' },
  'KB0802': { d: 'Pulley, Vertical Bearing ASM, MX48', w: 0.00491, b: 'C3-03' },
  '712634': { d: 'BELT, DECK, MX48', w: 0.015, b: 'C3-03' },
  '712635': { d: 'Pulley, Deck Bearing, MX48', w: 0.00276, b: 'C3-04' },
  '712633': { d: 'BELT, VERTICAL, MX48', w: 0.00455, b: 'C3-04' },
  '712632': { d: 'BELT, MAGNET, MX48', w: 0.00426, b: 'C3-04' },
  '712640': { d: 'Pulley, Vertical Motor, MX48', w: 0.00961, b: 'C3-05' },
  '712639': { d: 'Pulley-B, Vertical shaft, MX48', w: 0.00493, b: 'C3-05' },
  '714027': { d: 'Urethane Washers', w: 0.00242, b: 'C3-05' },
  '712631': { d: 'BELT, PLUNGER, MX48', w: 0.00281, b: 'C3-05' },
  '712821': { d: 'Cable-Encoder, MX-48', w: 0.00427, b: 'C3-06' },
  '712701': { d: 'Cable-ST.Motor, MX-48', w: 0.00637, b: 'C3-07' },
  '712668': { d: 'Spring, Cartridge Tray, MX48', w: 0.01606, b: 'C3-08' },
  '712595': { d: 'Guide E-Tube Tray, MX48', w: 0.023517, b: 'C3-08' },
  '712682': { d: 'Cable-Heater, MX-48', w: 0.028277, b: 'C3-09' },
  '712669': { d: 'Spring, Plunger, MX48', w: 0.006018, b: 'C3-09' },
  '712686': { d: 'Cable-LED Indicator, MX-48', w: 0.029516, b: 'C3-09' },
  '712667': { d: 'Music Wire, Dia. 0.6mm', w: 0.000816, b: 'C3-09' },
  '712697': { d: 'Switch-Power, Push Button', w: 0.024704, b: 'C3-10' },
  '712687': { d: 'Cable-USB Terminal, MX-48', w: 0.019825, b: 'C3-10' },
  '712681': { d: 'Sensor-Door, MX-48', w: 0.007503, b: 'C3-11' },
  '712680': { d: 'Sensor-M.Home, MX-48', w: 0.005289, b: 'C3-11' },
  '712649': { d: 'Locating Pins, Tray, MX48', w: 0.000411, b: 'C3-11' },
  '712055': { d: 'Rod Plastic, 1/8\"Dia', w: 0.0041, b: 'C3-11' },
  '712689': { d: 'Cable-FFC 10\"', w: 0.00076, b: 'C3-12' },
  '712683': { d: 'Cable-24VDC, MX-48', w: 0.009736, b: 'C3-13' },
  '714406': { d: 'Cable-Power Signal, LPS365-M', w: 0.003027, b: 'C3-13' },
  '712691': { d: 'UV Lamp, TUV 6W FAM', w: 0.0185, b: 'C3-14' },
  '715047': { d: 'UV Lamp socket, SK-F-1220', w: 0.005544, b: 'C3-14' },
  '712934': { d: 'Vision Camera Bracket, MX48', w: 0.025477, b: 'C3-15' },
  '712933': { d: 'Vision Camera Spacer, MX48', w: 0.026843, b: 'C3-15' },
  '715714': { d: 'Top grip, New Tablet, MX48', w: 0.006274, b: 'C3-16' },
  '716151': { d: 'PowerInputHarness_MX48', w: 0.0844, b: 'C3-16' },
  '714063': { d: 'Mount, Tablet, SM', w: 0.003554, b: 'C3-16' },
  '713412': { d: 'Door Hinge Spring, MX48', w: 0.004278, b: 'C3-16' },
  '712949': { d: 'Flat Torque Hinge', w: 0.12217, b: 'C3-17' },
  '712930': { d: 'Shaft-One End Threaded One End Tapp', w: 0.0163, b: 'C3-17' },
  '715851': { d: 'Cable, USB B-C for SP9', w: 0.054, b: 'C3-18' },
  '712935': { d: 'Door, PIvot Hinge Base, MX48', w: 0.00532, b: 'C3-18' },
  '714157': { d: 'Vertical, Motor Tensioner, MX48_CSC', w: 0.007663, b: 'C3-19' },
  '714167': { d: 'Vertical Bearing Cover, MX48_CSC', w: 0.008766, b: 'C3-19' },
  '714820': { d: 'MV30 Lens cover_V430-AF10', w: 0.00327, b: 'C3-20' },
  '716150': { d: 'PowerEntryModule_nonshield', w: 0.07056, b: 'C3-20' },
  '714995': { d: 'USB ethernet adapter_UE306', w: 0.02568, b: 'C3-20' },
  '713790': { d: 'Tablet Power Cord, Korea, 2.5A/250V', w: 0.07446, b: 'C3-20' },
  '714682': { d: 'M/V Camera Rolling block', w: 0.02551, b: 'C3-21' },
  '714686': { d: 'M/V Camera Rotation block', w: 0.008877, b: 'C3-21' },
  '714681': { d: 'M/V Camera Bracket', w: 0.07811, b: 'C3-22' },
  '714087': { d: 'USB2.0 A/M To Mini B/M Angle Cable', w: 0.028824, b: 'C3-22' },
  '714981': { d: 'Socket Head Knurled Knobs M4-11.6', w: 0.011702, b: 'C3-22' },
  '712685': { d: 'Cable-MV.Light, MX-48', w: 0.009806, b: 'C3-22' },
  '714646': { d: 'Lens_TBL 2.5 5MP', w: 0.011887, b: 'C3-24' },
  '714647': { d: 'Lens holder_TLH CS-F', w: 0.006254, b: 'C3-24' },
  '714645': { d: 'Vision Camera_DMK42AUC03', w: 0.05562, b: 'C3-25' },
  '715299': { d: 'Windows 10 Enterprise IoT LTSC 2021', w: 0.0005, b: 'D2' },
  '713655': { d: 'TOUCH STYLUS', w: 0.004, b: 'D2' },
  '716551': { d: 'TOUCH STYLUS', w: 0.01528, b: 'D2' },
  '712937': { d: 'Hinge Shaft, Door, MX48', w: 0.01992, b: 'D2' },
  '713646': { d: 'Base, Screw for bearing, MX48', w: 0.0035, b: 'D2' },
  '714683': { d: 'M/V Camera Stepper screw', w: 0.003158, b: 'D2' },
  '72320': { d: 'Label, Shipper, Foil, Maxwell CSC 4', w: 0.0005, b: 'D2' },
  'KB0125': { d: 'Knob Screw [NKOS4-16]', w: 0.00864, b: 'D2' },
  '71141': { d: 'Label, Fuse, 250V 8AT', w: 0.0001, b: 'D2' },
  '713413': { d: 'Door Hinge Pipes, MX48', w: 0.0015, b: 'D2' },
  '712648': { d: 'KNOB SCREW, MX48', w: 0.00349, b: 'D2' },
  '71790': { d: 'Label, Foil, Maxwell RSC48', w: 0.0035, b: 'D2' },
  '050-9809': { d: 'LABEL - FOIL, MAXWELL CSC SP5051', w: 0.0005, b: 'D2' },
  '71300': { d: 'Label, foil, Maxwell RSC Instr Box', w: 0.004, b: 'D2' },
  '710329': { d: 'Set Screw M4×6 / SBPPS4-6', w: 0.0005, b: 'D2' },
  '71654': { d: 'Label, foil, Maxwell® Instr Box, FS', w: 0.0005, b: 'D2' },
  '017682': { d: 'Safety Label, Crush French/Eng', w: 0.0001, b: 'D2' },
  '019-9803': { d: 'Pin, Clevis 3/16\" X 3\" With E-Rin', w: 0.01117, b: 'D2' },
  '710437': { d: 'Allen Key 2.5mm', w: 0.005137, b: 'D2' },
  '710372': { d: 'Wahsers FWS-D20-V6.0-T1.5', w: 0.0005, b: 'D2' },
  '050-9811': { d: 'Label, Cord Wrap, Ares', w: 0.004, b: 'D2' },
  '712641': { d: 'BEARING, B684ZZ', w: 0.001014, b: 'D2' },
  '710427': { d: 'Hex Flange Bolt M8X30', w: 0.017, b: 'D2' },
  '713942': { d: 'Bearing 625DDU', w: 0.004627, b: 'D2' },
  '017916': { d: 'Label, Two person Lift, Maxwell Ins', w: 0.0001, b: 'D2' },
  '018141': { d: 'Labels-UV Size D-0.69 Base X 0.60\"', w: 0.00018, b: 'D2' },
  '710373': { d: 'Low head Bolt CBSTS6-12', w: 0.0005, b: 'D2' },
  '714400': { d: 'Screw, M6×10mm, SOC Cap (Plastic)', w: 0.000955, b: 'D2' },
  '018140': { d: 'Labels-UV Do Not Handle ISO (Size D', w: 0.0001, b: 'D2' },
  '71385': { d: 'Medallion, Maxwell Instr, IVD', w: 6e-05, b: 'D2' },
  '712598': { d: 'Heat Block, Washer, MX48', w: 0.000118, b: 'D2' },
  '712772': { d: 'Cable Clip', w: 0.002303, b: 'D2' },
  '037-0055': { d: 'Fuse, 2.5A/5×20 Glass, UL/CSA/VDE', w: 0.000837, b: 'D2' },
  'KB0408': { d: 'Washer SSWA9-2.0', w: 0.0005, b: 'D2' },
  '712695': { d: 'Fuse, MX-48', w: 0.000849, b: 'D2' },
  '713645': { d: 'Vertical, Screw for bearing, MX48', w: 0.0018, b: 'D2' },
  '017677': { d: 'Safety Label, Exclamation Point', w: 0.00018, b: 'D2' },
  '017681': { d: 'Safety Label, Hand Crush', w: 0.00018, b: 'D2' },
  '711139': { d: 'Cable Clamp, Ø5, Nylon', w: 0.0015, b: 'D2' },
  '017899': { d: 'Safety Label, Biohazard, 0.69\" Bas', w: 0.00018, b: 'D2' },
  '017680': { d: 'Safety Label, Hot Surface', w: 0.00018, b: 'D2' },
  '017678': { d: 'Safety Label, Lightning Bolt', w: 0.00018, b: 'D2' },
  '018263': { d: 'Label, Safety, Magnet, Size D-0.69x', w: 0.0001, b: 'D2' },
  '018264': { d: 'Label, Safety, Pacemaker Size D-0.7', w: 0.0001, b: 'D2' },
  '714684': { d: 'M/V Camera Bushing', w: 0.000165, b: 'D2' },
  '073-9800': { d: 'O-Ring, Silicone(S469-40)', w: 2e-05, b: 'D2' },
  '017679': { d: 'Safety Label, Grounding', w: 0.00018, b: 'D2' },
  '099-9303': { d: 'Tubing, Fep 1/16\"OD X 0.03\" ID', w: 0.0015, b: 'D2' },
  '081-0802': { d: 'Saddle Clamp, #4 Mount 931x Platfor', w: 0.000219, b: 'D2' },
  '712646': { d: 'Bushing, Deck Bearing, MX48', w: 0.000356, b: 'D2' },
  '710374': { d: 'Wahsers WSJJ10-4-3', w: 0.0005, b: 'D2' },
  '713242': { d: 'Shipping Knob screw, MX48', w: 0.013, b: 'D2' },
  'KB0511': { d: 'Socket Button Head Cap Screw [M4x4L', w: 0.0005, b: 'D2' },
  '712653': { d: 'Screw, M4×25mm, LOW SOC HD', w: 0.00279, b: 'D2' },
  '074-9802': { d: 'Nut, Hex 3/8-32×3/32', w: 0.0005, b: 'D2' },
  '710421': { d: 'Flat Head Wrench Bolt SCM435(B) / M', w: 0.0005, b: 'D2' },
  '129-9800': { d: 'Wire Saddle, Nylon 6/6, UL94 V-2', w: 0.000678, b: 'D2' },
  'KB0177': { d: 'Socket Button Head Cap Screw [M4x8L', w: 0.0005, b: 'D2' },
  '711204': { d: 'Screw, M4×10mm, LOW SOC HD', w: 0.001185, b: 'D2' },
  '714930': { d: 'Cable clip flat c-type', w: 0.002897, b: 'D2' },
  '710390': { d: 'Flat Head Wrench Bolt SUS, M5×8', w: 0.0015, b: 'D2' },
  '711251': { d: 'Compound - Loctite 638', w: 5e-05, b: 'D2' },
  '710370': { d: 'Wire Band KR5G5-100P', w: 0.0005, b: 'D2' },
  '078-9800': { d: 'Flange, #10 × 0.75\", Nylon, Ares', w: 6e-05, b: 'D2' },
  '712947': { d: 'Washer, 6mm ID', w: 0.004, b: 'D2' },
  '082-0306': { d: 'Tape, .045\"THK X .75\", BLK FOAM, ', w: 0.002, b: 'D2' },
  '075-9822': { d: 'Screw, M4×12mm, FLT HDSS(SOC)', w: 0.001135, b: 'D2' },
  'KB0391': { d: 'Flat Head Wrench Bolt SUS, M4×6', w: 0.001, b: 'D2' },
  '710388': { d: 'Flat Head Wrench Bolt SUS, M4×20', w: 0.0017, b: 'D2' },
  '713722': { d: '3M DUAL LOCK Fasteners', w: 0.0025, b: 'D2' },
  'KB0145': { d: 'Nut [?4]', w: 0.0005, b: 'D2' },
  'KB0133': { d: 'Tooth Washer', w: 2e-05, b: 'D2' },
  '712661': { d: 'Screw-with S_W, M5×15mm, SOC Cap SS', w: 0.00378, b: 'D2' },
  '72410': { d: 'For Lithium Ion Battery label_UN348', w: 0.0025, b: 'D2' },
  '079-0800': { d: 'Washer, #8, Internal Tooth SS', w: 0.000105, b: 'D2' },
  '079-9803': { d: 'Washer Fiber,0.5\"Od×0.375\"Id×0.03', w: 6e-05, b: 'D2' },
  'KB0146': { d: 'Support [#4*5L]', w: 0.0005, b: 'D2' },
  '713125': { d: 'Screw flange, M3×10mm, BTN HD BLK(S', w: 0.00065, b: 'D2' },
  '075-9808': { d: 'Screw, M3×8mm,BTN HD SS(SOC)', w: 0.000515, b: 'D2' },
  'KB0485': { d: 'Wrench Bolt M3*10L,SUS', w: 0.00075, b: 'D2' },
  '710383': { d: 'Wrench Bolt SUS / M5×20', w: 0.004, b: 'D2' },
  '712660': { d: 'Screw-with S_W, M4×12mm, SOC Cap SS', w: 0.001969, b: 'D2' },
  '712659': { d: 'Screw-with S_W, M4×10mm, SOC Cap SS', w: 0.001803, b: 'D2' },
  '714444': { d: 'Screw, M5×15mm, FLT HD SS(SOC)', w: 0.0023, b: 'D2' },
  '710379': { d: 'Wrench Bolt SUS / M2.5×4', w: 0.0005, b: 'D2' },
  '710380': { d: 'Wrench Bolt SUS / M2.5×8', w: 0.0005, b: 'D2' },
  '712655': { d: 'Screw-with S_W, M4×8mm, SOC Cap SS(', w: 0.001672, b: 'D2' },
  '711673': { d: 'Flat Head Wrench Bolt SUS, M5×10', w: 0.0018, b: 'D2' },
  '714904': { d: 'Tablet Charging Label', w: 0.0015, b: 'D2' },
  '075-9805': { d: 'Screw, M2.5×6mm, FLT HDSS (PHIL)', w: 0.0003, b: 'D2' },
  '075-9825': { d: 'Screw, M2.5×10mm, FLT HDSS (PHIL)', w: 0.0002, b: 'D2' },
  '713047': { d: 'Screw-with S_W, M3×12mm, SOC Cap SS', w: 0.0003, b: 'D2' },
  '710381': { d: 'Wrench Bolt SUS / M4×10', w: 0.001679, b: 'D2' },
  '711106': { d: 'Screw, M4×12mm, SOC Cap SS(SOC)', w: 0.001727, b: 'D2' },
  '711137': { d: 'Screw, M3×25mm, SOC Cap SS(SOC)', w: 0.0014, b: 'D2' },
  '712658': { d: 'Screw-with S_W, M3×8mm, SOC Cap SS(', w: 0.000815, b: 'D2' },
  '713046': { d: 'Screw-with S_W, M3×10mm, SOC Cap SS', w: 0.000896, b: 'D2' },
  '712657': { d: 'Screw-with S_W, M3×6mm, SOC Cap SS(', w: 0.000762, b: 'D2' },
  '710382': { d: 'Wrench Bolt SUS / M4×15', w: 0.002, b: 'D2' },
  '714028': { d: 'Screw, M4×6mm, SOC Cap SS(SOC)', w: 0.0015, b: 'D2' },
  '712662': { d: 'Set screw, M4*3L', w: 0.000134, b: 'D2' },
  'KB0064': { d: 'Wrench Bolt [M3*12L,SUS]', w: 0.001, b: 'D2' },
  'KB0140': { d: 'Set screw [M4*4L]', w: 0.00015, b: 'D2' },
  '075-9815': { d: 'Screw, M3×8mm, SOC CAP SS(SOC)', w: 0.0002, b: 'D2' },
  'KB0390': { d: 'Flat Head Wrench Bolt SUS, M4×10', w: 0.0015, b: 'D2' },
  '714354': { d: 'Self tapping screw, M3 x 10mm', w: 0.000446, b: 'D2' },
  '715024': { d: 'Set screw (flat type), M4x5', w: 0.000275, b: 'D2' },
  '075-9821': { d: 'Screw, M3×6mm, SOC CAP SS(SOC)', w: 0.00069, b: 'D2' },
  'KB0392': { d: 'Socket Button Head Cap Screw [M3x6L', w: 0.00015, b: 'D2' },
  '710389': { d: 'Flat Head Wrench Bolt SUS, M4×8', w: 0.000844, b: 'D2' },
  '711125': { d: 'Tie Wrap(Zip Ties), 2.5 X 100mm, NA', w: 0.00029, b: 'D2' },
  '710386': { d: 'Flat Head Wrench Bolt SUS, M3×15', w: 0.00075, b: 'D2' },
  'KB0677': { d: 'Wrench Bolt SUS,M3x6', w: 0.0005, b: 'D2' },
  '710378': { d: 'Spring Washers M6', w: 0.0005, b: 'D2' },
  '710385': { d: 'Flat Head Wrench Bolt SUS, M3×10', w: 0.00052, b: 'D2' },
  '711668': { d: 'Flat Head Wrench Bolt SUS, M3×8', w: 0.000575, b: 'D2' },
  'KB0438': { d: 'Socket button Head Cap Screw, BHSS,', w: 0.000434, b: 'D2' },
  '712654': { d: 'Screw, M3×5mm, FLT HD SS (SOC)', w: 0.000326, b: 'D2' },
  'KB0389': { d: 'Flat Head Wrench Bolt SUS, M3×6', w: 0.00014, b: 'D2' },
  '714379': { d: 'Seal label', w: 0.0001, b: 'D2' },
  '710391': { d: 'Spring Washers SUS/M5', w: 0.0005, b: 'D2' },
  '716153': { d: 'PowerEntryModule_Tape', w: 0.00355, b: 'D2' },
  'KB0132': { d: 'Washer [M4]', w: 0.000253, b: 'D2' },
  '710530': { d: 'Nut M4', w: 0.0005, b: 'D2' },
  '711118': { d: 'Retainer Ring, E-Type-Ø3', w: 2e-05, b: 'D2' },
  '712948': { d: 'Flat Washers, M3', w: 0.0005, b: 'D2' },
  'KB0183': { d: 'WASHER [M3 ,Plastic]', w: 0.0005, b: 'D2' },
  '710377': { d: 'Spring Washers M4', w: 0.000205, b: 'D2' },
  '800-0430': { d: 'Compound - Heat Transfer, Silicone', w: 0.00015, b: 'D2' },
  '9BR264': { d: 'Maxwell® RSC Set Up Guide (Brochure', w: 0.0185, b: 'D2' },
  '9BR283': { d: 'Maxwell® FSC Set Up Guide', w: 0.01484, b: 'D2' },
  '9BR300': { d: 'Maxwell® RSC 48 Instrument Setup Gu', w: 0.0185, b: 'D2' },
  '9BR320': { d: 'Maxwell CSC 48 Quick Setup Guide', w: 0.01846, b: 'D2' },
  '9FB168': { d: 'Maxwell® RSC Quick Start Guide', w: 0.0185, b: 'D2' },
  '9FB179': { d: 'Maxwell® CSC 1.1 Quick Start Guide', w: 0.01838, b: 'D2' },
  '9FB194': { d: 'Maxwell® FSC Quick Start Guide', w: 0.01853, b: 'D2' },
  '9FB216': { d: 'Maxwell® RSC 48 Inst Quick Start Gu', w: 0.0185, b: 'D2' },
  '9FB231': { d: 'Maxwell CSC 48 Quick Start Guide', w: 0.01811, b: 'D2' },
  '9FB233': { d: 'Maxwell Elution Tube Quick Start Gu', w: 0.00919, b: 'D2' },
  '9GE817': { d: 'Maxwell RSC 48 SM Package Insert', w: 0.002, b: 'D2' },
  '9LT308': { d: 'Maxwell® 16 CSC Thank You Letter', w: 0.01816, b: 'D2' },
  '9LT311': { d: 'Maxwell® RSC Welcome Letter', w: 0.0075, b: 'D2' },
  '9LT312': { d: 'Maxwell CSC 48 Welcome/Thank you Le', w: 0.0064, b: 'D2' },
  '9LT313': { d: 'Maxwell® FSC Welcome Letter', w: 0.00754, b: 'D2' },
  '9LT314': { d: 'Maxwell® RSC 48: Welcome/Thank You ', w: 0.008, b: 'D2' },
  '715298': { d: 'SURFACE PRO 9', w: 1.128, b: 'E' },
  '716655': { d: 'SURFACE PRO 13 INCH, ARM CPU', w: 1.1, b: 'E' },
  'E6150': { d: 'Quantus™ Fluorometer', w: 0.44834, b: 'E' },
  '713780': { d: 'GD4590 Barcode Scanner', w: 0.2859, b: 'E' },
  '712582': { d: 'BASE, BASE PLATE, MX48', w: 4.4, b: 'E' },
  '711473': { d: 'Main Cover, White, CSC 1.1', w: 1.77937, b: 'E' },
  '711100': { d: 'Main Cover, Metalic Silver, RSC', w: 1.72974, b: 'E' },
  '714140': { d: 'Top, Main Enclosure, MX48_CSC', w: 1.86193, b: 'E' },
  '714141': { d: 'Door, Enclosure, MX48_CSC', w: 0.59642, b: 'E' },
  '712941': { d: 'Top, Main Enclosure, MX48', w: 1.84924, b: 'E' },
  '712939': { d: 'Door, Enclosure, MX48', w: 0.56994, b: 'E' },
  '711474': { d: 'Door White, CSC 1.1', w: 0.32077, b: 'E' },
  '711140': { d: 'Door Metalic Silver, Ares', w: 0.32089, b: 'E' },
  '712942': { d: 'Right, Main Enclosure, MX48', w: 0.79719, b: 'E' },
  '714158': { d: 'Right, Main enclosure, MX48_CSC', w: 0.79483, b: 'E' },
  '712943': { d: 'Left, Main Enclosure, MX48', w: 0.82525, b: 'E' },
  '714159': { d: 'Left, Main enclosure, MX48_CSC', w: 0.82945, b: 'E' },
  '712290': { d: 'Door Metalic Silver, FSC', w: 0.31146, b: 'E' },
  '712959': { d: 'Just-Mobile ST-858 Encore iPad Stan', w: 0.21267, b: 'E' },
  '713129': { d: 'Foam, Base Frame, MX48', w: 0.64354, b: 'E' },
  '710423': { d: 'HSM 3.0 BOX KLB/DW 4K , 615X490X510', w: 3.5, b: 'E' },
  '713123': { d: 'Heater Cover Front, MX48', w: 0.07538, b: 'E' },
  '713124': { d: 'Heater Cover Back, MX48', w: 0.0751, b: 'E' },
  '713140': { d: 'Shipper top, MX48', w: 4.25, b: 'E' },
  '713131': { d: 'Foam, Right Frame, MX48', w: 0.38511, b: 'E' },
  '713132': { d: 'Foam, Left Frame, MX48', w: 0.38895, b: 'E' },
  '710424': { d: 'Secondary_box KLB/DW 4K , 590X465X2', w: 1.5, b: 'E' },
  '710428': { d: 'Primary Scored pad KLB/DW 4K , 1317', w: 0.15331, b: 'E' },
  '712945': { d: 'Switch cover, MX48', w: 0.05126, b: 'E' },
  '710425': { d: 'Primary box KLB.K.K / A , 450X320X2', w: 0.45, b: 'E' },
  '710431': { d: 'Power Supply Box KLB.K.K / A , 590×', w: 0.75, b: 'E' },
  '710433': { d: 'Power Spacer KLB.K.K / A , 617×450', w: 0.17096, b: 'E' },
  '710434': { d: 'Rack Spacer KLB.K.K / A , 1144×230', w: 0.15626, b: 'E' },
  '712940': { d: 'Window , Enclosure, MX48', w: 0.1558, b: 'E' },
  '710426': { d: 'Wood Tray Core Plywood 24T', w: 0.92594, b: 'E' },
  '711638': { d: 'Shipper Box, Ares', w: 2.05, b: 'E' },
  '710432': { d: 'Accessory_Box G\'TYPE,  KLB/B 255×2', w: 0.1315, b: 'E' },
  '132-9800': { d: 'Cover Heater, Ares', w: 0.05421, b: 'E' },
  '713138': { d: 'BOX accessary, MX48', w: 0.64544, b: 'E' },
  '712932': { d: 'Indicator Window, MX48', w: 0.14024, b: 'E' },
  '715171': { d: 'Foam, Machine vision bottom, MX48', w: 0.10531, b: 'E' },
  '713141': { d: 'Shipper Bottom, MX48', w: 1.48699, b: 'E' },
  '710429': { d: 'Secondary_Foam_Lower 445×280×30+30+', w: 0.12575, b: 'E' },
  '059-9800': { d: 'Window, Ares', w: 0.14628, b: 'E' },
  '715170': { d: 'Foam, M_V _COVER,ASM', w: 0.10156, b: 'E' },
  '711145': { d: 'Foam Die Cut, Lower, Ares', w: 0.1578, b: 'E' },
  '710430': { d: 'Secondary_Foam_Upper 445×200×30+30+', w: 0.08127, b: 'E' },
  '71289': { d: 'Accessory Box, Ares', w: 0.62853, b: 'E' },
  '71321': { d: 'Foam Die Cut, Upper, Ares', w: 0.14094, b: 'E' },
  '713133': { d: 'Foam, Rod & Deck, MX48', w: 0.10151, b: 'E' },
  '713135': { d: 'Foam, Die cut A/B #1,MX48', w: 0.071, b: 'E' },
  '713137': { d: 'Foam, Die cut A/B #3,MX48', w: 0.059, b: 'E' },
  '713130': { d: 'Foam, Top, MX48', w: 0.22385, b: 'E' },
  '710435': { d: 'Foam Power 210×160×30+30+20T', w: 0.06663, b: 'E' },
  '713139': { d: 'Box Tray, MX48', w: 0.107845, b: 'E' },
  '711147': { d: 'Foam Die Cut, A/B #2, Ares', w: 0.0475, b: 'E' },
  '713134': { d: 'Foam, Inner top, MX48', w: 0.03062, b: 'E' },
  '713136': { d: 'Foam, Die cut A/B #2,MX48', w: 0.014, b: 'E' },
  '71443': { d: 'Foam Die Cut A/B #3, CSC', w: 0.033, b: 'E' },
  '71444': { d: 'Foam Die Cut A/B #4, CSC', w: 0.0265, b: 'E' },
  '71445': { d: 'Foam Die Cut A/B #5, CSC', w: 0.0255, b: 'E' },
  '711146': { d: 'Foam Die Cut, A/B #1, Ares', w: 0.033, b: 'E' },
  '711151': { d: 'Foam Die Cut, Deck, Ares', w: 0.035, b: 'E' },
  '710450': { d: 'HSM 2.0 Rack Box Kraft paper-258X40', w: 0.09259, b: 'E' },
  '71290': { d: 'Tray Box, Ares', w: 0.08925, b: 'E' },
  '711152': { d: 'Foam Die Cut, Rod, Ares', w: 0.02, b: 'E' },
  '713220': { d: 'Plastic Clips, HP601-W3', w: 0.017765, b: 'E' },
  '710451': { d: 'HSM 2.0 Rack Stand Box Kraft paper-', w: 0.13825, b: 'E' },
  '713142': { d: 'Poly Bags, 1000X1000mm, 0.1T', w: 0.17118, b: 'E' },
  '71286': { d: 'Poly Bags, 700X700mm, 0.1T', w: 0.07931, b: 'E' },
  '71331': { d: 'PE Foam lami Bag, 300X300mm, 1T', w: 0.00656, b: 'E' },
  '714352': { d: 'Magnet bar 24 positions Bottom plat', w: 0.04491, b: 'E3' },
  '714350': { d: 'Magnet bar 24 positions Top', w: 0.08061, b: 'E3' },
  '714378': { d: 'Foam insert for 24 positions Top', w: 0.01615, b: 'E3' },
  '714356': { d: 'Magnet bar 16 positions Bottom plat', w: 0.03013, b: 'E3' },
  '714355': { d: 'Magnet bar 16 positions Top', w: 0.05586, b: 'E3' },
  '714373': { d: 'Foam insert for 16 positions Top', w: 0.01804, b: 'E3' },
  '714377': { d: 'Foam insert for 24 positions Bottom', w: 0.01448, b: 'E3' },
  '714372': { d: 'Foam insert for 16 positions Bottom', w: 0.02107, b: 'E3' },
  '714375': { d: '24 position box top', w: 0.04276, b: 'E3' },
  '714370': { d: '16 position box top', w: 0.03289, b: 'E3' },
  '714376': { d: '24 position box bottom', w: 0.04136, b: 'E3' },
  '714371': { d: '16 position box bottom', w: 0.03106, b: 'E3' },
  '714351': { d: 'Magnet 8-8', w: 0.003, b: 'E3' },
  '714353': { d: 'Silicone rubber guide custom', w: 0.003314, b: 'E3' },
  '71142': { d: 'Label, HSM 3.0 Power Supply', w: 0.0001, b: 'LABEL' },
  '71140': { d: 'Label, HSM 3.0 Instrument', w: 0.0001, b: 'LABEL' },
  '017810': { d: 'Outer Box Label, Maxwell® White', w: 0.0001, b: 'LABEL' },
  '050-0040': { d: 'Instrument Label,3\"x2\",blank silv', w: 6e-05, b: 'LABEL' },
  '71242': { d: 'Label, 1” x .25”, blank white', w: 5e-05, b: 'LABEL' },
  '71839': { d: 'Label, 1.875\"x2.5\"-Yellow, non-ha', w: 5e-05, b: 'LABEL' },
  '71885': { d: 'Label, 1.75\"x0.25\", white', w: 5e-05, b: 'LABEL' },
  '050-0029': { d: 'Label, 3” x 3”, blank white', w: 0.0001, b: 'LABEL' },
};

// 초기 랙 설정 (최대하중 등 - 사용자가 수정 가능)
const DEFAULT_RACK_CONFIG = {
  // Maxwell 48 시리즈
  'A1': { maxBins: 6, maxWeight: 1200 },   // 중량 4개 × 300kg
  'A2': { maxBins: 5, maxWeight: 1200 },   // 중량 4개 × 300kg
  'B1': { maxBins: 14, maxWeight: 1800 },  // 경량 12개 × 150kg
  'B3': { maxBins: 6, maxWeight: 1800 },   // 중량 4개 + 경량 4개
  'C3': { maxBins: 25, maxWeight: 1200 },  // 경량 8개 × 150kg
  // Maxwell 16 시리즈
  'A5': { maxBins: 6, maxWeight: 600 },    // 중량 2개 × 300kg
  'A6': { maxBins: 6, maxWeight: 600 },    // 중량 2개 × 300kg
  'A7': { maxBins: 2, maxWeight: 600 },    // 중량 2개 × 300kg
  'B2': { maxBins: 18, maxWeight: 600 },   // 경량 4개 × 150kg
  'C1': { maxBins: 14, maxWeight: 600 },   // 경량 4개 × 150kg
  // HSM 3.0
  'A3': { maxBins: 8, maxWeight: 1200 },   // 중량 4개 × 300kg
  'B4': { maxBins: 17, maxWeight: 600 },   // 경량 4개 × 150kg
  'C2': { maxBins: 25, maxWeight: 600 },   // 경량 4개 × 150kg
  // 기타 구역
  'D2': { maxBins: 1, maxWeight: 1000 },   // 약 1톤
  'E': { maxBins: 1, maxWeight: 99999 },   // 무제한
  'E3': { maxBins: 4, maxWeight: 600 },    // 경량 4개 × 150kg
  'Tablet': { maxBins: 1, maxWeight: 600 }, // 중량 2개 × 300kg
  'Stand': { maxBins: 1, maxWeight: 600 },  // 중량 2개 × 300kg
  'S1': { maxBins: 4, maxWeight: 1200 },   // 중량 4개 × 300kg
  'F1': { maxBins: 1, maxWeight: 99999 },  // 팔레트, 무제한
  'LABEL': { maxBins: 1, maxWeight: 99999 }, // 무제한
};

// 모델 시리즈별 적정 재고 기준 (대수)
const TARGET_UNITS_BY_SERIES = {
  'Maxwell 48': 40,  // 40대분
  'Maxwell 16': 40,  // 40대분
  'HSM 3.0': 15,     // 15대분
  'Others': 99999,   // 기타는 무제한
};

// 랙별 모델 시리즈 매핑
const RACK_MODEL_SERIES = {
  // Maxwell 16 시리즈 (RSC16, CSC16, FSC16) - 파란색
  'A5': 'Maxwell 16', 'A6': 'Maxwell 16', 'A7': 'Maxwell 16',
  'B2': 'Maxwell 16', 'C1': 'Maxwell 16',
  // Maxwell 48 시리즈 (RSC48, CSC48) - 초록색  
  'A1': 'Maxwell 48', 'A2': 'Maxwell 48',
  'B1': 'Maxwell 48', 'B3': 'Maxwell 48', 'C3': 'Maxwell 48',
  // HSM 3.0 - 주황색
  'A3': 'HSM 3.0', 'B4': 'HSM 3.0', 'C2': 'HSM 3.0',
};

// 2025~2027 한국 공휴일 (주말 제외, 대체공휴일 포함)
const KR_HOLIDAYS = new Set([
  // 2025
  '2025-01-01','2025-01-28','2025-01-29','2025-01-30',
  '2025-03-01','2025-05-05','2025-05-06','2025-06-06',
  '2025-08-15','2025-10-03','2025-10-06','2025-10-07','2025-10-08',
  '2025-10-09','2025-12-25',
  // 2026
  '2026-01-01',                            // 신정
  '2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18', // 설연휴 (토~수, 대체공휴일 18수)
  '2026-03-01','2026-03-02',               // 삼일절(일) + 대체공휴일(월)
  '2026-05-05',                            // 어린이날(화)
  '2026-05-24','2026-05-25',               // 석가탄신일(일) + 대체공휴일(월)
  '2026-06-03',                            // 지방선거일(수)
  '2026-06-06',                            // 현충일(토)
  '2026-08-15','2026-08-17',               // 광복절(토) + 대체공휴일(월)
  '2026-09-24','2026-09-25','2026-09-26','2026-09-27', // 추석연휴 (목~일)
  '2026-10-03','2026-10-05',               // 개천절(토) + 대체공휴일(월)
  '2026-10-09',                            // 한글날(금)
  '2026-12-25',                            // 크리스마스(금)
  // 2027
  '2027-01-01','2027-02-02','2027-02-03','2027-02-04',
  '2027-03-01','2027-05-05','2027-05-13','2027-06-06',
  '2027-08-15','2027-10-03','2027-10-09','2027-12-25',
]);

// 영업일 수 계산 (주말 + 공휴일 제외)
function getBusinessDays(startDate, endDate) {
  const start = new Date(startDate);
  const end = new Date(endDate);
  if (isNaN(start) || isNaN(end) || end <= start) return 0;
  
  // 한국시간 기준 날짜 문자열 (YYYY-MM-DD)
  function toKRDate(d) {
    const kr = new Date(d.getTime() + 9 * 60 * 60 * 1000); // UTC+9
    return kr.toISOString().slice(0, 10);
  }
  function getKRDay(d) {
    const kr = new Date(d.getTime() + 9 * 60 * 60 * 1000);
    return kr.getUTCDay();
  }
  
  // 시작일 ~ 완료일 사이 영업일 카운트
  let count = 0;
  const cur = new Date(start);
  cur.setDate(cur.getDate() + 1);
  while (cur <= end) {
    const day = getKRDay(cur);
    const dateStr = toKRDate(cur);
    if (day !== 0 && day !== 6 && !KR_HOLIDAYS.has(dateStr)) {
      count++;
    }
    cur.setDate(cur.getDate() + 1);
  }
  
  // 시작일이 영업일이면 시작일 남은 근무시간 비율 추가
  const startDay = getKRDay(start);
  const startDateStr = toKRDate(start);
  if (startDay !== 0 && startDay !== 6 && !KR_HOLIDAYS.has(startDateStr)) {
    const krHour = (start.getUTCHours() + 9) % 24;
    const hoursWorked = Math.max(0, 17 - krHour); // 17시(퇴근)까지 남은 시간
    count += Math.min(hoursWorked / 8, 1);
  }
  
  return Math.round(count * 10) / 10;
}

// ═══ 자재 위치 미니맵 (실제 레이아웃 기반) ═══
function LocateMiniMap({layoutData, targetArea}){
  const cvRef=React.useRef(null);
  useEffect(()=>{
    const cv=cvRef.current;
    if(!cv||!layoutData)return;
    const ctx=cv.getContext('2d');
    const cW=cv.width,cH=cv.height;
    ctx.clearRect(0,0,cW,cH);
    // 배치도 상수 (픽셀)
    var BX=50,BY=50;
    var WHW=564,WHH=1890,RX=982,JY=774;// px 단위
    // 캔버스 스케일
    var sc=Math.min((cW-16)/WHW,(cH-16)/WHH);
    var ox=8,oy=8;
    var mx=function(x){return ox+(x-BX)*sc;};
    var my=function(y){return oy+(y-BY)*sc;};
    // 배경
    ctx.fillStyle='#0f172a';ctx.fillRect(0,0,cW,cH);
    // L자 건물 외곽
    ctx.beginPath();
    ctx.moveTo(mx(BX),my(BY));
    ctx.lineTo(mx(BX+WHW),my(BY));
    ctx.lineTo(mx(BX+WHW),my(BY+JY));
    ctx.lineTo(mx(RX),my(BY+JY));
    ctx.lineTo(mx(RX),my(BY+WHH));
    ctx.lineTo(mx(BX),my(BY+WHH));
    ctx.closePath();
    ctx.fillStyle='#1e293b';ctx.fill();
    ctx.strokeStyle='#475569';ctx.lineWidth=1;ctx.stroke();
    // 시리즈 색상
    var SC_HEX={mx48:'#dc2626',mx16:'#2563eb',hsm:'#d97706',semi:'#eab308',spare:'#7c3aed',etc:'#06b6d4'};
    var targetRack=null;
    // 랙 그리기
    if(layoutData.R) layoutData.R.forEach(function(r){
      var nm=(r.a||'').toUpperCase();
      if(nm.indexOf('DOOR')>=0||nm.indexOf('PILLAR')>=0) return;
      var w,h;
      if(r.t==='custom'){w=(r.cw||1000)*0.06;h=(r.ch||500)*0.06;}
      else{w=(r.t==='heavy'?1800:900)*0.06;h=450*0.06;}
      if(r.rot===true||r.rot===90||r.rot===270){var tmp=w;w=h;h=tmp;}
      var rx=mx(r.x),ry=my(r.y),rw=w*sc,rh=h*sc;
      var area=(r.a||'').split('-')[0]||r.a||'';
      var isTarget=area===targetArea;
      if(isTarget){
        if(!targetRack) targetRack={x:rx,y:ry,w:rw,h:rh};
        else{// 병합
          var nx=Math.min(targetRack.x,rx),ny=Math.min(targetRack.y,ry);
          targetRack={x:nx,y:ny,w:Math.max(targetRack.x+targetRack.w,rx+rw)-nx,h:Math.max(targetRack.y+targetRack.h,ry+rh)-ny};
        }
      }
      ctx.fillStyle=isTarget?'#f59e0b':(SC_HEX[r.s]||'#64748b');
      ctx.globalAlpha=isTarget?1:0.6;
      ctx.fillRect(rx,ry,Math.max(rw,1),Math.max(rh,1));
      ctx.globalAlpha=1;
    });
    // 존 그리기
    if(layoutData.zones) layoutData.zones.forEach(function(z){
      var zx=mx(z.x),zy=my(z.y),zw=z.w*sc,zh=z.h*sc;
      ctx.fillStyle='#22c55e';ctx.globalAlpha=0.25;
      ctx.fillRect(zx,zy,Math.max(zw,1),Math.max(zh,1));
      ctx.globalAlpha=1;
    });
    // 타겟 하이라이트
    if(targetRack){
      ctx.strokeStyle='#fbbf24';ctx.lineWidth=3;
      ctx.setLineDash([6,3]);
      ctx.strokeRect(targetRack.x-4,targetRack.y-4,targetRack.w+8,targetRack.h+8);
      ctx.setLineDash([]);
      ctx.fillStyle='#fbbf24';ctx.font='bold 16px sans-serif';ctx.textAlign='center';
      ctx.fillText(targetArea,targetRack.x+targetRack.w/2,targetRack.y-10);
    }
  },[layoutData,targetArea]);
  return <canvas ref={cvRef} width={340} height={420} className="border rounded-lg" style={{display:'block'}}/>;
}

// ═══ 워크스루 HUD 오버레이 ═══
function WalkHud({walkRef, ctrlRef, onClose}){
  const [tick,setTick]=useState(0);
  const miniRef=React.useRef(null);
  useEffect(()=>{
    const iv=setInterval(()=>setTick(t=>t+1),100);
    return ()=>clearInterval(iv);
  },[]);
  // 미니맵 그리기
  useEffect(()=>{
    const ws=walkRef.current;
    const cv=miniRef.current;
    if(!ws||!ws.active||!cv)return;
    const ctx=cv.getContext('2d');
    const cW=cv.width,cH=cv.height;
    ctx.clearRect(0,0,cW,cH);
    // 스케일 계산 (창고 전체가 캔버스에 맞게)
    var maxDim=Math.max(ws.whw,ws.whh);
    var sc=(cH-20)/maxDim;// 여백 10px
    var ox=10,oy=10;
    var mx=function(x){return ox+x*sc;};
    var mz=function(z){return oy+z*sc;};
    // 배경
    ctx.fillStyle='rgba(15,23,42,0.9)';
    ctx.fillRect(0,0,cW,cH);
    // L자 건물 외곽
    ctx.beginPath();
    ctx.moveTo(mx(0),mz(0));ctx.lineTo(mx(ws.whw),mz(0));
    ctx.lineTo(mx(ws.whw),mz(ws.jy));ctx.lineTo(mx(ws.rx),mz(ws.jy));
    ctx.lineTo(mx(ws.rx),mz(ws.whh));ctx.lineTo(mx(0),mz(ws.whh));
    ctx.closePath();
    ctx.fillStyle='#1e293b';ctx.fill();
    ctx.strokeStyle='#475569';ctx.lineWidth=1;ctx.stroke();
    // 장애물 (colliders)
    if(ws.colliders){
      ws.colliders.forEach(function(c){
        if(c.name&&c.name.indexOf('wall')===0)return;
        var x1=mx(c.minX),z1=mz(c.minZ);
        var w=(c.maxX-c.minX)*sc,h=(c.maxZ-c.minZ)*sc;
        ctx.fillStyle='rgba(100,116,139,0.6)';
        ctx.fillRect(x1,z1,Math.max(w,1),Math.max(h,1));
      });
    }
    // 현재 위치 + 방향
    var px=mx(ws.posX),pz=mz(ws.posZ);
    var arrowLen=12;
    var ax=Math.sin(ws.angle)*arrowLen,az=Math.cos(ws.angle)*arrowLen;
    // 파렛트 영역 (회전 적용)
    ctx.save();ctx.translate(px,pz);ctx.rotate(-ws.angle);
    ctx.fillStyle='rgba(250,204,21,0.7)';
    var pw=1.1*sc/2,pd=1.1*sc/2;
    ctx.fillRect(-pw,-pd,pw*2,pd*2);
    ctx.restore();
    // 방향 화살표
    ctx.beginPath();
    ctx.moveTo(px,pz);ctx.lineTo(px+ax,pz+az);
    ctx.strokeStyle='#f59e0b';ctx.lineWidth=2.5;ctx.stroke();
    // 화살표 머리
    ctx.beginPath();
    ctx.arc(px+ax,pz+az,3,0,Math.PI*2);
    ctx.fillStyle='#f59e0b';ctx.fill();
    // 현재 위치 점
    ctx.beginPath();ctx.arc(px,pz,4,0,Math.PI*2);
    ctx.fillStyle=ws.colliding?'#ef4444':'#22c55e';ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.stroke();
  },[tick]);
  const ws=walkRef.current;
  if(!ws||!ws.active)return null;
  const fmtDist=(d)=>d>=100?'∞':(d*1000).toFixed(0)+'mm';
  const clrColor=(d)=>d<0.3?'text-red-400':d<0.5?'text-yellow-400':'text-green-400';
  return (
    <div className="absolute inset-0 pointer-events-none" style={{zIndex:10}}>
      {/* 상단: 조작 안내 */}
      <div className="absolute top-3 left-1/2 -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-lg text-sm pointer-events-auto">
        <span className="font-bold text-yellow-400">🚜 워크스루 모드</span>
        <span className="ml-3">W/S 전진·후진 | A/D 좌우 | Q/E 회전 | 마우스 시점 | ESC 종료</span>
      </div>
      {/* 좌하단: 클리어런스 정보 */}
      <div className="absolute bottom-4 left-4 bg-black/80 text-white p-3 rounded-lg text-sm space-y-1 min-w-48">
        <div className="font-bold text-xs text-gray-400 mb-1">📐 여유 공간 (파렛트 가장자리 기준)</div>
        <div className="flex justify-between">
          <span>◀ 좌측:</span>
          <span className={clrColor(ws.nearestL)+' font-mono font-bold'}>{fmtDist(ws.nearestL)}</span>
        </div>
        <div className="flex justify-between">
          <span>▶ 우측:</span>
          <span className={clrColor(ws.nearestR)+' font-mono font-bold'}>{fmtDist(ws.nearestR)}</span>
        </div>
        <div className="flex justify-between">
          <span>▲ 전방:</span>
          <span className={clrColor(ws.nearestF)+' font-mono font-bold'}>{fmtDist(ws.nearestF)}</span>
        </div>
        <div className="border-t border-gray-600 pt-1 mt-1 text-xs text-gray-400">
          파렛트: 1100×1100mm | 자키+파렛트 총 길이: 1400mm
        </div>
        {ws.nearRack && (
          <div className="border-t border-gray-600 pt-1 mt-1">
            <span className="text-yellow-400 font-bold text-xs">📍 {ws.nearRack}</span>
          </div>
        )}
      </div>
      {/* 우하단: 충돌 경고 */}
      {ws.colliding && (
        <div className="absolute bottom-4 right-4 bg-red-900/90 text-red-200 px-4 py-3 rounded-lg animate-pulse">
          <div className="font-bold text-lg">⚠️ 충돌!</div>
          <div className="text-sm">{ws.collideName} 에 접촉</div>
          <div className="text-xs mt-1 text-red-300">이동 차단됨 — 회전(Q/E)으로 방향 전환</div>
        </div>
      )}
      {/* 우상단: 위치 + 리셋 */}
      <div className="absolute top-3 right-3 bg-black/70 text-white px-3 py-2 rounded-lg text-xs pointer-events-auto">
        <div className="text-gray-400">위치: X={ws.posX.toFixed(1)}m Z={ws.posZ.toFixed(1)}m</div>
        <div className="flex gap-2 mt-1">
          <button onClick={()=>{if(ctrlRef.current)ctrlRef.current.resetWalkPos();}}
            className="px-2 py-1 bg-slate-600 hover:bg-slate-500 rounded text-xs">🔄 시작점</button>
          <button onClick={()=>{if(ctrlRef.current)ctrlRef.current.resetWalkCam();}}
            className="px-2 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-xs">🎥 시점 리셋</button>
          <button onClick={()=>{if(ctrlRef.current)ctrlRef.current.captureScreenshot();}}
            className="px-2 py-1 bg-sky-600 hover:bg-sky-500 rounded text-xs">📷 캡처</button>
          <button onClick={onClose}
            className="px-2 py-1 bg-red-700 hover:bg-red-600 rounded text-xs">✕ 종료</button>
        </div>
      </div>
      {/* 좌상단: 미니맵 */}
      <div className="absolute top-14 left-3 pointer-events-auto">
        <div className="bg-black/80 rounded-lg p-1 border border-slate-600">
          <div className="text-[10px] text-gray-400 text-center mb-0.5">📍 위치 맵</div>
          <canvas ref={miniRef} width={160} height={200} style={{display:'block',borderRadius:4}} />
        </div>
      </div>
    </div>
  );
}

function PBKWarehouseSystem() {
  const [activeTab, setActiveTab] = useState(() => {
    try { const p = new URLSearchParams(window.location.search); if(p.get('q')) return 'locate'; if(p.get('tab')) return p.get('tab'); } catch(e){}
    return 'dashboard';
  });
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedZone, setSelectedZone] = useState('all');
  
  // 모바일 메뉴
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  
  // 재고 목록 정렬 - safeStorage에서 복원 (C2 개선)
  const [inventorySortBy, setInventorySortBy] = useState(() => {
    return safeStorage.getItem('pbk_filter_inventorySortBy') || 'bin';
  });
  const [inventorySortOrder, setInventorySortOrder] = useState(() => {
    return safeStorage.getItem('pbk_filter_inventorySortOrder') || 'asc';
  });
  
  // 무게 정보 정렬 - safeStorage에서 복원
  const [weightSortBy, setWeightSortBy] = useState(() => {
    return safeStorage.getItem('pbk_filter_weightSortBy') || 'bin';
  });
  const [weightSortOrder, setWeightSortOrder] = useState(() => {
    return safeStorage.getItem('pbk_filter_weightSortOrder') || 'asc';
  });
  
  // 이전 데이터 저장 (C1 대시보드 증감 표시용)
  const [previousStats, setPreviousStats] = useState(() => {
    const saved = safeStorage.getItem('pbk_previous_stats');
    return saved ? JSON.parse(saved) : null;
  });
  
  // TO DO 리스트
  const [todoList, setTodoList] = useState(() => {
    const saved = safeStorage.getItem('pbk_todo_list');
    return saved ? JSON.parse(saved) : [
      { id: 1, text: '랙별 최대 하중량 데이터 입력', category: 'data', priority: 'high', completed: false, createdAt: '2026-02-01', dueDate: '2026-02-10' },
      { id: 2, text: 'MIGO 처리 시간 단축 방안 검토', category: 'process', priority: 'medium', completed: false, createdAt: '2026-02-01', dueDate: '2026-02-15' },
      { id: 3, text: 'Kitting Lead Time KPI 기준 수립', category: 'kpi', priority: 'high', completed: false, createdAt: '2026-02-01', dueDate: '2026-02-08' },
    ];
  });
  const [newTodo, setNewTodo] = useState('');
  const [newTodoCategory, setNewTodoCategory] = useState('general');
  const [newTodoPriority, setNewTodoPriority] = useState('medium');
  const [newTodoDueDate, setNewTodoDueDate] = useState('');
  const [todoFilter, setTodoFilter] = useState('active');
  const [dueSoonTodos, setDueSoonTodos] = useState([]);
  const [showDueSoonAlert, setShowDueSoonAlert] = useState(true);
  const [notificationPermission, setNotificationPermission] = useState('default');
  const [fullBins, setFullBins] = useState([]); // Bin 100% 알림용
  
  // 재고 데이터 (SAP 엑셀에서 로드)
  const [inventoryData, setInventoryData] = useState([]);
  const [rackSummary, setRackSummary] = useState([]);
  const [lastUpdated, setLastUpdated] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [uploadError, setUploadError] = useState(null);
  
  // Open PO 데이터 (발주 진행 중인 자재)
  const [openPOData, setOpenPOData] = useState(() => {
    const saved = safeStorage.getItem('pbk_open_po');
    return saved ? JSON.parse(saved) : [];
  });
  const [openPOLastUpdated, setOpenPOLastUpdated] = useState(() => {
    return safeStorage.getItem('pbk_open_po_updated') || null;
  });
  const [showOpenPOModal, setShowOpenPOModal] = useState(false);
  const [openPOError, setOpenPOError] = useState(null);
  
  // BOM 데이터 (사용자 업로드 가능)
  const [customBomData, setCustomBomData] = useState(() => {
    const saved = safeStorage.getItem('pbk_custom_bom');
    return saved ? JSON.parse(saved) : null;
  });
  // Sub-component BOM 데이터
  const [subComponentBomData, setSubComponentBomData] = useState(() => {
    const saved = safeStorage.getItem('pbk_subcom_bom');
    return saved ? JSON.parse(saved) : null;
  });
  const [bomLastUpdated, setBomLastUpdated] = useState(() => {
    return safeStorage.getItem('pbk_bom_updated') || null;
  });
  
  // 통합 업로드 모달
  const [showDataUploadModal, setShowDataUploadModal] = useState(false);
  
  // 랙 설정 - 항상 최신 DEFAULT_RACK_CONFIG 사용 (무게 기준 업데이트됨)
  const [rackConfig, setRackConfig] = useState(() => {
    // 기존 safeStorage 삭제하고 새 설정 적용
    safeStorage.removeItem('pbk_rack_config');
    return DEFAULT_RACK_CONFIG;
  });
  
  // 무게 데이터 (수정 가능) - 항상 기본 515개 데이터로 시작
  const [weightData, setWeightData] = useState(() => {
    // safeStorage 데이터가 있어도 개수가 다르면 기본값 사용
    const saved = safeStorage.getItem('pbk_weight_data');
    if (saved) {
      const parsed = JSON.parse(saved);
      // 515개 미만이면 기본값으로 리셋
      if (Object.keys(parsed).length < 500) {
        safeStorage.removeItem('pbk_weight_data');
        return DEFAULT_WEIGHT_DATA;
      }
      return parsed;
    }
    return DEFAULT_WEIGHT_DATA;
  });
  
  // 무게 편집 모달
  const [showWeightModal, setShowWeightModal] = useState(false);
  const [editingWeight, setEditingWeight] = useState(null);
  const [newMaterial, setNewMaterial] = useState({ material: '', desc: '', weight: '', bin: '' });

  // Cycle Time 기록 (safeStorage에 저장)
  const [pickCycles, setPickCycles] = useState(() => {
    const saved = safeStorage.getItem('pbk_pick_cycles');
    if (saved) {
      return JSON.parse(saved).map(p => {
        if (p.status === 'completed' && p.completed) {
          // NaN 포함된 경우 → startTime + cycleMin으로 재계산
          if (String(p.completed).includes('NaN')) {
            if (p.startTime && p.cycleMin) {
              try {
                const start = new Date(p.startTime);
                const end = new Date(start.getTime() + p.cycleMin * 60000);
                p.completed = end.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\. /g, '-').replace('.', '');
              } catch(e) { p.completed = '-'; }
            } else {
              p.completed = '-';
            }
          }
        }
        return p;
      });
    }
    return [
      { id: 1, orderId: 'PO-2026-001', model: 'MX48', received: '2026-01-28 09:00', completed: '2026-01-28 09:45', cycleMin: 45, status: 'completed' },
      { id: 2, orderId: 'PO-2026-002', model: 'RSC48', received: '2026-01-28 10:30', completed: '2026-01-28 11:00', cycleMin: 30, status: 'completed' },
    ];
  });
  
  const [receiveCycles, setReceiveCycles] = useState(() => {
    const saved = safeStorage.getItem('pbk_receive_cycles');
    return saved ? JSON.parse(saved) : [
      { id: 1, poNo: 'PUR-2026-001', vendor: 'Metal Tech', delivery: '2026-01-27 10:00', migo: '2026-01-27 11:30', cycleMin: 90, status: 'completed' },
      { id: 2, poNo: 'PUR-2026-002', vendor: 'PCB Korea', delivery: '2026-01-28 09:30', migo: '2026-01-28 10:15', cycleMin: 45, status: 'completed' },
    ];
  });

  const [showPickModal, setShowPickModal] = useState(false);
  const [showReceiveModal, setShowReceiveModal] = useState(false);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [newPick, setNewPick] = useState({ productionOrder: '', model: 'RSC48', received: '', worker: 'Z01', isUrgent: false });
  const [newReceive, setNewReceive] = useState({ poNo: '', vendor: '', delivery: '' });
  const [showVendorSuggestions, setShowVendorSuggestions] = useState(false);
  
  // 공간 분석 상태
  const [spaceAnalysisModal, setSpaceAnalysisModal] = useState(null);
  const [spaceAnalysisSortBy, setSpaceAnalysisSortBy] = useState('urgency'); // urgency, alphabet
  const [binDetailModal, setBinDetailModal] = useState(null); // Bin 품목 상세 모달
  const [binOverloadExpanded, setBinOverloadExpanded] = useState(false); // Bin별 과적 현황 토글
  
  // 다중 선택 상태
  const [selectedPicks, setSelectedPicks] = useState(new Set());
  const [selectedReceives, setSelectedReceives] = useState(new Set());
  
  // 수정 모달 상태
  const [editingPick, setEditingPick] = useState(null);
  const [editingReceive, setEditingReceive] = useState(null);

  // 불출 정렬/필터 상태 - safeStorage에서 복원 (C2 개선)
  const [pickSortBy, setPickSortBy] = useState(() => {
    return safeStorage.getItem('pbk_filter_pickSortBy') || 'productionOrder';
  });
  const [pickSortOrder, setPickSortOrder] = useState(() => {
    return safeStorage.getItem('pbk_filter_pickSortOrder') || 'asc';
  });
  const [pickFilterModel, setPickFilterModel] = useState(() => {
    return safeStorage.getItem('pbk_filter_pickFilterModel') || 'all';
  });
  const [pickFilterStatus, setPickFilterStatus] = useState(() => {
    return safeStorage.getItem('pbk_filter_pickFilterStatus') || 'all';
  });
  const [pickFilterWorker, setPickFilterWorker] = useState(() => {
    return safeStorage.getItem('pbk_filter_pickFilterWorker') || 'all';
  });
  const [pickFilterUrgent, setPickFilterUrgent] = useState(() => {
    return safeStorage.getItem('pbk_filter_pickFilterUrgent') || 'all';
  });
  const [pickSearchTerm, setPickSearchTerm] = useState('');
  const [pickFilterMonth, setPickFilterMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

  // 입고 정렬/필터 상태 - safeStorage에서 복원
  const [receiveSortBy, setReceiveSortBy] = useState(() => {
    return safeStorage.getItem('pbk_filter_receiveSortBy') || 'delivery';
  });
  const [receiveSortOrder, setReceiveSortOrder] = useState(() => {
    return safeStorage.getItem('pbk_filter_receiveSortOrder') || 'desc';
  });
  const [receiveFilterStatus, setReceiveFilterStatus] = useState(() => {
    return safeStorage.getItem('pbk_filter_receiveFilterStatus') || 'all';
  });
  const [receiveSearchTerm, setReceiveSearchTerm] = useState('');
  const [receiveFilterMonth, setReceiveFilterMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

  // Kitting 현황 데이터
  const [kittingData, setKittingData] = useState(() => {
    const saved = safeStorage.getItem('pbk_kitting_data');
    if (saved) {
      let needSave = false;
      const parsed = JSON.parse(saved).map(k => {
        if (k.completedAt && k.status === 'completed') {
          try {
            if (/^\d{2}-\d{2} /.test(k.completedAt)) {
              k.completedAt = '2026-' + k.completedAt.split(' ')[0];
            }
            if (k.completedAt.includes('T') || k.completedAt.length > 10) {
              const d = new Date(k.completedAt);
              if (!isNaN(d.getTime())) {
                k.completedAt = d.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\. /g, '-').replace('.', '');
              }
            }
          } catch(e) {}
        }
        // 완료된 항목의 leadTimeDays를 영업일 기준으로 재계산
        if (k.status === 'completed' && k.startedAt) {
          try {
            let startTime = new Date(k.startedAt);
            if (isNaN(startTime.getTime()) && typeof k.startedAt === 'string' && /^\d{2}-\d{2}/.test(k.startedAt)) {
              startTime = new Date('2026-' + k.startedAt.replace(' ', 'T') + ':00');
            }
            let endTime = null;
            if (k.completedAt) {
              endTime = (typeof k.completedAt === 'string' && k.completedAt.length <= 10) 
                ? new Date(k.completedAt + 'T17:00:00+09:00')
                : new Date(k.completedAt);
            } else {
              endTime = new Date();
            }
            if (startTime && endTime && !isNaN(startTime.getTime()) && !isNaN(endTime.getTime()) && endTime > startTime) {
              const newLT = getBusinessDays(startTime, endTime);
              if (Math.abs(newLT - (k.leadTimeDays || 0)) > 0.05) {
                k.leadTimeDays = newLT;
                needSave = true;
              }
            }
          } catch(e) { console.error('LT recalc error:', k.productionOrder, e); }
        }
        return k;
      });
      // 재계산된 값을 즉시 safeStorage에 저장
      if (needSave) {
        try { safeStorage.setItem('pbk_kitting_data', JSON.stringify(parsed)); } catch(e) {}
      }
      return parsed;
    }
    return [];
  });
  const [showKittingModal, setShowKittingModal] = useState(false);
  const [newKitting, setNewKitting] = useState({ productionOrder: '', model: 'RSC48', basicStartDate: '', worker: 'Z01', isUrgent: false });
  const [selectedKittings, setSelectedKittings] = useState(new Set());
  const [kittingFilterMonth, setKittingFilterMonth] = useState(new Date().toISOString().slice(0, 7));
  const [kittingFilterModel, setKittingFilterModel] = useState('all');
  const [kittingFilterStatus, setKittingFilterStatus] = useState('all');
  const [kittingSearchTerm, setKittingSearchTerm] = useState('');
  const [kittingSortBy, setKittingSortBy] = useState('basicStartDate');
  const [kittingSortOrder, setKittingSortOrder] = useState('asc');
  const [editingKitting, setEditingKitting] = useState(null);
  const [showKittingGraphModal, setShowKittingGraphModal] = useState(false);
  const [showReceiveGraphModal, setShowReceiveGraphModal] = useState(false);

  // 대시보드 상세 보기 모달
  const [showPickDetailModal, setShowPickDetailModal] = useState(false);
  const [showReceiveDetailModal, setShowReceiveDetailModal] = useState(false);
  const [showLeadTimeDetailModal, setShowLeadTimeDetailModal] = useState(false);

  // 랙 상세 보기 모달
  const [selectedRackDetail, setSelectedRackDetail] = useState(null);

  // 창고 레이아웃 상태
  const [selectedLayoutRack, setSelectedLayoutRack] = useState(null);
  
  // 랙 배치도 에디터 HTML (인라인 임베딩)
  const LAYOUT_EDITOR_HTML = `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PBK 창고 랙 배치도</title>
<style>
/* fonts loaded from parent */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0d1424;color:#e2e8f0;min-height:100vh;overflow:hidden}
.topbar{height:40px;background:#1e293b;border-bottom:1px solid #1e293b;display:flex;align-items:center;justify-content:space-between;padding:0 10px;z-index:200}
.topbar h1{font-size:13px;font-weight:700;color:#f1f5f9}
.tb-g{display:flex;align-items:center;gap:4px}
.tb{background:#1e293b;border:1px solid #334155;color:#94a3b8;font-size:10px;font-family:inherit;padding:4px 8px;border-radius:5px;cursor:pointer;transition:all .12s;white-space:nowrap}
.tb:hover{background:#263043;border-color:#475569;color:#e2e8f0}
.tb.act{background:#1e3a5f;border-color:#3b82f6;color:#60a5fa}
.tb.grn{background:#065f46;border-color:#059669;color:#6ee7b7}
.tb.red{background:#7f1d1d;border-color:#dc2626;color:#fca5a5}
.tb.blu{background:#1e3a5f;border-color:#3b82f6;color:#93c5fd}
.sep{width:1px;height:20px;background:#334155;margin:0 2px}
.zc{display:flex;align-items:center;gap:4px;font-size:10px;color:#94a3b8}
.zc input{width:55px;accent-color:#3b82f6}
.zv{font-weight:600;color:#60a5fa;min-width:26px;text-align:center;font-size:10px}
.modebar{height:34px;background:#1e293b;border-bottom:1px solid #1e293b;display:flex;align-items:center;padding:0 10px;gap:3px}
.mbtn{background:#1e293b;border:1px solid #334155;color:#94a3b8;font-size:11px;font-family:inherit;padding:4px 14px;border-radius:6px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:5px}
.mbtn:hover{background:#263043;color:#e2e8f0}
.mbtn.active{font-weight:700}
.mbtn.active[data-m=move]{background:#064e3b;border-color:#10b981;color:#6ee7b7}
.mbtn.active[data-m=select]{background:#172554;border-color:#3b82f6;color:#93c5fd}
.mbtn.active[data-m=ruler]{background:#451a03;border-color:#d97706;color:#fcd34d}
.mbtn.active[data-m=text]{background:#2e1065;border-color:#7c3aed;color:#c4b5fd}
.mbtn .key{font-size:8px;background:rgba(255,255,255,.08);padding:1px 4px;border-radius:3px;color:rgba(255,255,255,.35)}
.mode-desc{margin-left:12px;font-size:10px;color:#475569;flex:1}
.lg{display:flex;gap:3px;font-size:9px;color:#64748b;align-items:center}
.lg-s{width:10px;height:7px;border-radius:1px;display:inline-block}
#CA{position:relative;width:100%;height:calc(100vh - 40px - 34px - 26px);overflow:auto;background:#111a2e}
#CA.m-move{cursor:grab}#CA.m-move.panning{cursor:grabbing}
#CA.m-select{cursor:default}#CA.m-ruler{cursor:crosshair}#CA.m-text{cursor:text}
#CV{position:relative;transform-origin:0 0}
.bld{position:absolute;border:2.5px solid rgba(255,255,255,.7);border-radius:3px;background:rgba(20,30,50,.2);z-index:1;pointer-events:none}
.blbl{position:absolute;font-size:9px;color:#4b5c73;font-weight:500;pointer-events:none;white-space:nowrap}
.defect{position:absolute;border:2.5px solid rgba(239,68,68,.6);background:rgba(239,68,68,.15);border-radius:4px;z-index:2;display:flex;align-items:center;justify-content:center;pointer-events:none}
.defect b{font-size:11px;font-weight:700;color:rgba(239,68,68,.8);text-shadow:0 0 10px rgba(239,68,68,.4)}
.prod{position:absolute;border:2px dashed rgba(255,255,255,.5);background:rgba(30,41,59,.25);border-radius:3px;z-index:1;display:flex;align-items:center;justify-content:center;pointer-events:none}
.prod span{font-size:11px;color:#475569;font-weight:600;letter-spacing:2px}
.zone{position:absolute;z-index:5;border-radius:4px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1px;user-select:none}
.m-select .zone{cursor:move}.m-move .zone{cursor:grab}.zone:hover{box-shadow:0 0 0 1px rgba(255,255,255,.2)}
.zn{font-size:11px;white-space:nowrap;font-weight:700;color:rgba(255,255,255,.6);pointer-events:none;text-align:center}
.zd{font-size:9px;color:rgba(255,255,255,.3);pointer-events:none}
.zone .rh{position:absolute;bottom:0;right:0;width:14px;height:14px;cursor:nwse-resize;z-index:10}
.zone .rh::after{content:'';position:absolute;bottom:2px;right:2px;width:6px;height:6px;border-right:2px solid rgba(255,255,255,.25);border-bottom:2px solid rgba(255,255,255,.25)}
.rk{position:absolute;z-index:15;border-radius:2px;display:flex;align-items:center;justify-content:center;font-weight:600;color:rgba(255,255,255,.9);text-shadow:0 1px 2px rgba(0,0,0,.4);white-space:nowrap;user-select:none}
.m-select .rk{cursor:pointer}.m-select .rk.sel{cursor:grab}
.m-move .rk{cursor:grab}.m-move .rk.dragging{cursor:grabbing}.rk:hover{z-index:60;box-shadow:0 0 0 1.5px rgba(255,255,255,.3)}
.rk.dragging{z-index:100;opacity:.85;box-shadow:0 0 0 2px #3b82f6,0 6px 20px rgba(0,0,0,.5)!important}
.rk.sel{box-shadow:0 0 0 2px #10b981,0 0 8px rgba(16,185,129,.25);z-index:55}
.rk .rot{position:absolute;top:-12px;right:-12px;width:24px;height:24px;background:#334155;border:1px solid #475569;border-radius:50%;cursor:pointer!important;display:none;align-items:center;justify-content:center;font-size:14px;color:#94a3b8;z-index:20;line-height:24px;text-align:center}
.rk:hover .rot{display:flex}.rk .rot:hover{background:#3b82f6;color:#fff}
.rk.mx48{background:rgba(220,38,38,.85);border:1.5px solid #fca5a5}
.rk.mx16{background:rgba(37,99,235,.85);border:1.5px solid #93c5fd}
.rk.hsm{background:rgba(217,119,6,.85);border:1.5px solid #fcd34d}
.rk.semi{background:rgba(234,179,8,.85);border:1.5px solid #fef08a}
.rk.spare{background:rgba(124,58,237,.85);border:1.5px solid #c4b5fd}
.rk.etc{background:rgba(100,116,139,.75);border:1.5px solid #94a3b8}
.selbox{position:absolute;border:1.5px solid rgba(59,130,246,.6);background:rgba(59,130,246,.08);z-index:90;pointer-events:none;border-radius:2px;display:none}
.rl-line{position:absolute;z-index:80;pointer-events:none;left:0;top:0}
.dl-svg{position:absolute;z-index:78;pointer-events:none;left:0;top:0}
.dl-handle{position:absolute;z-index:79;width:14px;height:14px;border-radius:50%;transform:translate(-7px,-7px);cursor:grab;transition:transform .15s;pointer-events:all}
.dl-handle:hover{transform:translate(-7px,-7px) scale(1.6)}
.dl-handle.dragging{cursor:grabbing;transform:translate(-7px,-7px) scale(1.4);box-shadow:0 0 0 3px rgba(255,255,255,.4)}
.dl-ep{position:absolute;z-index:80;width:10px;height:10px;border-radius:50%;transform:translate(-5px,-5px);cursor:grab;pointer-events:all;border:2px solid rgba(255,255,255,.6);background:rgba(255,255,255,.15);transition:transform .15s}
.dl-ep:hover{transform:translate(-5px,-5px) scale(1.5);background:rgba(255,255,255,.4)}
.dl-preview{position:absolute;z-index:83;pointer-events:none;left:0;top:0}
.area-sel{position:absolute;z-index:85;border:2px solid #22d3ee;background:rgba(34,211,238,.08);pointer-events:none;border-radius:2px}
.area-label{position:absolute;z-index:86;background:rgba(15,23,42,.92);border:1.5px solid #22d3ee;color:#22d3ee;font-size:11px;font-weight:700;padding:5px 10px;border-radius:6px;white-space:nowrap;pointer-events:all;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.5);font-family:inherit}
#spPanel{position:fixed;right:0;top:34px;width:400px;height:calc(100vh - 34px);background:#0f172a;border-left:1px solid #1e293b;z-index:200;overflow-y:auto;transform:translateX(100%);transition:transform .3s;font-family:inherit;font-size:11px}
#spPanel.open{transform:translateX(0)}
.sp-hd{background:#1e293b;padding:10px 12px;font-weight:700;color:#e2e8f0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
.sp-sect{padding:10px 12px;border-bottom:1px solid #1e293b}
.sp-title{font-size:10px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.sp-row{display:flex;justify-content:space-between;align-items:center;margin:3px 0;font-size:11px}
.sp-val{font-weight:700;color:#e2e8f0}
.sp-bar{height:8px;background:#1e293b;border-radius:4px;margin:4px 0;overflow:hidden}
.sp-bar-fill{height:100%;border-radius:4px;transition:width .4s}
.sp-ok{color:#10b981}.sp-warn{color:#f59e0b}.sp-bad{color:#ef4444}
.sp-badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600;margin-left:4px}
.sp-badge-ok{background:rgba(16,185,129,.2);color:#10b981}
.sp-badge-warn{background:rgba(245,158,11,.2);color:#f59e0b}
.sp-badge-bad{background:rgba(239,68,68,.2);color:#ef4444}
.sp-aisle{margin:3px 0;padding:4px 6px;border-radius:4px;font-size:10px}
.sp-aisle-ok{background:rgba(16,185,129,.1);border-left:3px solid #10b981;color:#a7f3d0}
.sp-aisle-warn{background:rgba(245,158,11,.1);border-left:3px solid #f59e0b;color:#fde68a}
.sp-aisle-bad{background:rgba(239,68,68,.1);border-left:3px solid #ef4444;color:#fca5a5}
.sp-tip{background:rgba(99,102,241,.12);border-left:3px solid #6366f1;color:#a5b4fc;padding:5px 8px;border-radius:0 4px 4px 0;font-size:10px;margin:3px 0;line-height:1.5}
#spToggle{position:fixed;right:0;top:50%;transform:translateY(-50%);background:#3b82f6;color:#fff;border:none;border-radius:6px 0 0 6px;padding:8px 5px;cursor:pointer;z-index:201;font-size:16px;writing-mode:vertical-rl;font-family:inherit;font-size:10px;font-weight:700;letter-spacing:1px}
.aisle-overlay{position:absolute;pointer-events:none;z-index:77}
.sp-collapsible{cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center}
.sp-collapsible::after{content:"▼";font-size:9px;color:#64748b;transition:transform .2s;margin-left:4px}
.sp-collapsible.collapsed::after{transform:rotate(-90deg)}
.sp-collapse-body{overflow:hidden;transition:max-height .3s;max-height:500px}
.sp-collapse-body.hidden{max-height:0}
.sp-issue-item{margin:3px 0;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;transition:all .15s}
.sp-issue-item:hover{filter:brightness(1.3);transform:translateX(2px)}
.sp-highlight-overlay{position:absolute;z-index:88;pointer-events:none;border-radius:2px;animation:sp-pulse 1.5s ease-in-out infinite}
@keyframes sp-pulse{0%,100%{opacity:.9}50%{opacity:.4}}
@keyframes spPulse{0%{opacity:.5}100%{opacity:1}}
.sp-ai-click:hover{background:rgba(139,92,246,.1)!important;border-color:rgba(139,92,246,.3)!important}
.sp-focus-badge{position:absolute;z-index:89;background:#fbbf24;color:#000;font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;pointer-events:none;white-space:nowrap}
.area-overlay{position:absolute;z-index:84;pointer-events:none;left:0;top:0}
#areaOpts{display:none;align-items:center;gap:6px;margin-left:6px}
#areaOpts.visible{display:flex}
.aopt{background:#1e293b;border:1px solid #22d3ee;border-radius:4px;color:#22d3ee;font-size:11px;padding:2px 8px}
#lineOpts{display:none;align-items:center;gap:6px;margin-left:6px}
#lineOpts.visible{display:flex}
.lopt{background:#1e293b;border:1px solid #334155;border-radius:4px;color:#94a3b8;font-size:11px;padding:2px 8px;cursor:pointer;transition:all .15s}
.lopt.active{background:#3b82f6;border-color:#3b82f6;color:#fff}
#lineColor{width:26px;height:22px;padding:1px;border:1px solid #334155;border-radius:4px;cursor:pointer;background:none}
#lineWidth{width:46px;background:#1e293b;border:1px solid #334155;border-radius:4px;color:#e2e8f0;font-size:11px;padding:2px 4px}
#lineArrow{background:#1e293b;border:1px solid #334155;border-radius:4px;color:#94a3b8;font-size:11px;padding:2px 8px;cursor:pointer}
#lineArrow.active{background:#7c3aed;border-color:#7c3aed;color:#fff}
.rl-label{position:absolute;z-index:81;background:#1e293b;border:1px solid #f59e0b;color:#fcd34d;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;white-space:nowrap;font-family:inherit;cursor:pointer}
.rl-label:hover{background:#f59e0b;color:#1e293b}
.rl-dot{position:absolute;width:8px;height:8px;background:#f59e0b;border-radius:50%;z-index:82;pointer-events:none;transform:translate(-4px,-4px)}
.txl{position:absolute;z-index:18;user-select:none;font-size:10px;font-weight:600;color:rgba(255,255,255,.7);padding:2px 6px;border:1px dashed rgba(255,255,255,.15);border-radius:3px;background:rgba(255,255,255,.03);white-space:nowrap}
.m-select .txl{cursor:move}.m-move .txl{cursor:grab}.txl:hover{border-color:rgba(255,255,255,.35)}
.txl .xb{position:absolute;top:-6px;right:-6px;width:12px;height:12px;background:#dc2626;border-radius:50%;color:#fff;font-size:8px;cursor:pointer;display:none;line-height:12px;text-align:center}
.txl:hover .xb{display:block}
.tooltip{position:fixed;background:#1e293b;border:1px solid #475569;border-radius:7px;padding:8px 12px;font-size:10px;color:#e2e8f0;pointer-events:none;z-index:300;display:none;box-shadow:0 6px 20px rgba(0,0,0,.6);min-width:160px}
.ttn{font-weight:700;font-size:12px;margin-bottom:4px;padding-bottom:3px;border-bottom:1px solid #334155}
.ttr{display:flex;justify-content:space-between;gap:8px;padding:1px 0}.ttl{color:#94a3b8}.ttv{font-weight:600;color:#f1f5f9}
.statusbar{height:26px;background:#1e293b;border-top:1px solid #1e293b;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-size:9px;color:#64748b}
.gl{position:absolute;pointer-events:none;z-index:0}.glv{width:1px;background:rgba(45,58,79,.5)}.glh{height:1px;background:rgba(45,58,79,.5)}
.panel{position:fixed;top:74px;right:0;width:195px;background:#1e293b;border-left:1px solid #1e293b;border-bottom:1px solid #1e293b;padding:10px;z-index:150;display:none;border-radius:0 0 0 8px;max-height:calc(100vh - 120px);overflow-y:auto}
.panel.show{display:block}.panel h3{font-size:11px;font-weight:700;color:#e2e8f0;margin-bottom:8px;display:flex;justify-content:space-between}
.panel h3 .xb{cursor:pointer;color:#64748b;font-size:14px}.panel h3 .xb:hover{color:#e2e8f0}
.pr{display:flex;gap:4px;margin-bottom:5px;align-items:center}.pr label{font-size:9px;color:#94a3b8;min-width:38px}
.pr select,.pr input{background:#1e293b;border:1px solid #334155;color:#e2e8f0;font-size:10px;font-family:inherit;padding:3px 5px;border-radius:4px;flex:1}
.pbtn{width:100%;padding:5px;font-size:10px;font-weight:600;font-family:inherit;border-radius:5px;cursor:pointer;margin-top:3px;background:#065f46;border:1px solid #059669;color:#6ee7b7}.pbtn:hover{background:#047857}
.hs{font-size:9px;font-weight:700;color:#475569;letter-spacing:.5px;padding:4px 0 2px;border-bottom:1px solid #1e293b;margin:4px 0 2px}
.hr{display:flex;align-items:center;gap:8px;padding:3px 0}.hr .hk{min-width:60px;text-align:right}
.hr kbd{background:#1e293b;border:1px solid #334155;color:#94a3b8;font-size:9px;font-family:inherit;padding:2px 5px;border-radius:3px}.hr .hd{font-size:10px;color:#94a3b8}

.edit-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:500;display:flex;align-items:center;justify-content:center}
.edit-box{background:#1e293b;border:1px solid #475569;border-radius:10px;padding:16px;min-width:250px;color:#e2e8f0;font-family:inherit}
.edit-box h4{font-size:13px;font-weight:700;margin-bottom:10px;color:#f1f5f9}
.edit-box label{font-size:10px;color:#94a3b8;display:block;margin-bottom:2px;margin-top:8px}
.edit-box input{width:100%;background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:5px 8px;border-radius:4px;font-size:11px;font-family:inherit}
.edit-box .ebtn{display:flex;gap:6px;margin-top:12px}
.edit-box button{flex:1;padding:6px;border:none;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit}
.edit-box .ok{background:#059669;color:#fff}
.edit-box .cancel{background:#475569;color:#e2e8f0}
</style>
</head>
<body>
<div class="topbar"><h1>🏭 PBK 창고 랙 배치도</h1><div class="tb-g"><div class="zc">줌<input type="range" id="zoomR" min="30" max="200" value="75" step="5"><span class="zv" id="zoomV">75%</span></div><div class="sep"></div><button class="tb act" id="bG" onclick="tog('grid')">▦ 그리드</button><button class="tb act" id="bS" onclick="tog('snap')">⊞ 스냅</button><div class="sep"></div><button class="tb blu" onclick="toggleP('ap')">＋ 추가</button><button class="tb red" onclick="delSel()">✕ 삭제</button><button class="tb" onclick="undo()" style="background:#1e293b;border-color:#475569;color:#94a3b8;font-size:12px" title="Ctrl+Z">&#x21A9; \ub418\ub3cc\ub9ac\uae30</button><div class="sep"></div><button class="tb grn" onclick="save()">💾 저장</button><button class="tb" onclick="exportJSON()" style="background:#1e3a5f;border-color:#3b82f6;color:#93c5fd">📤 내보내기</button><button class="tb" onclick="document.getElementById('importFile').click()" style="background:#4c1d95;border-color:#7c3aed;color:#c4b5fd">📥 불러오기</button><input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)"><button class="tb red" onclick="doReset()">↺ 초기화</button><div class="sep"></div><button class="tb" onclick="toggleP('hp')" style="font-size:12px">❓</button><div class="sep"></div><label style="color:#94a3b8;font-size:9px;display:flex;align-items:center;gap:4px;cursor:pointer">🎨 배경<input type="color" id="bgPick" value="#0a1628" style="width:24px;height:20px;border:none;cursor:pointer;background:none;padding:0" onchange="try{document.getElementById('CA').style.background=this.value;document.body.style.background=this.value}catch(e){}"></label></div></div>
<div class="modebar"><button class="mbtn active" data-m="move" onclick="setMode('move')">🖐 이동<span class="key">V</span></button><button class="mbtn" data-m="select" onclick="setMode('select')">⬚ 선택<span class="key">S</span></button><button class="mbtn" data-m="ruler" onclick="setMode('ruler')">📏 측정<span class="key">M</span></button><button class="mbtn" data-m="text" onclick="setMode('text')">T 텍스트<span class="key">T</span></button><button class="mbtn" data-m="line" onclick="setMode('line')">✏ 선 그리기<span class="key">L</span></button><button class="mbtn" data-m="area" onclick="setMode('area')">⬜ 면적<span class="key">A</span></button><span id="lineOpts"><button class="lopt active" id="lsBtn" onclick="setLineStyle('solid')">━ 실선</button><button class="lopt" id="ldBtn" onclick="setLineStyle('dashed')">┅ 점선</button><input type="color" id="lineColor" value="#ffffff" title="선 색상"><input type="number" id="lineWidth" value="2" min="1" max="10" title="선 두께(px)"><button id="lineArrow" onclick="toggleArrow()" title="화살표">→ 화살표</button></span><span class="mode-desc" id="md">🖐 화면을 드래그하여 스크롤합니다</span><div class="lg"><span class="lg-s" style="background:rgba(220,38,38,.85)"></span>RSC48 <span class="lg-s" style="background:rgba(37,99,235,.85)"></span>RSC16 <span class="lg-s" style="background:rgba(217,119,6,.85)"></span>HSM <span class="lg-s" style="background:rgba(234,179,8,.85)"></span>Semi <span class="lg-s" style="background:rgba(124,58,237,.85)"></span>SP</div></div>
<button id="spToggle" onclick="toggleSpPanel()">📊 공간분석</button>
<div id="spPanel">
  <div class="sp-hd">
    <span>📊 공간 활용 분석</span>
    <button onclick="toggleSpPanel()" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:14px">✕</button>
  </div>
  <div class="sp-sect">
    <div class="sp-title">🏢 기준 공간</div>
    <div class="sp-row"><span>생산 창고 기준</span><span class="sp-val" id="sp-base">117.91평 (389.83m²)</span></div>
    <div class="sp-row"><span>선택 영역</span><span class="sp-val" id="sp-sel">-</span></div>
  </div>
  <div class="sp-sect">
    <div class="sp-title">📦 1단계 · 점유 면적</div>
    <!-- 랙 점유 접기 -->
    <div class="sp-row sp-collapsible" onclick="spToggleSection('rack-detail')" id="sp-rack-toggle">
      <span>🟥 랙 점유</span><span class="sp-val" id="sp-rack">-</span>
    </div>
    <div class="sp-collapse-body" id="rack-detail">
      <div style="margin:3px 0 3px 10px;color:#94a3b8;font-size:10px" id="sp-rack-list">-</div>
    </div>
    <!-- 존 점유 접기 -->
    <div class="sp-row sp-collapsible" onclick="spToggleSection('zone-detail')" id="sp-zone-toggle" style="margin-top:4px">
      <span>🟦 존 점유</span><span class="sp-val" id="sp-zone">-</span>
    </div>
    <div class="sp-collapse-body" id="zone-detail">
      <div id="sp-zone-detail" style="margin:3px 0 3px 10px;color:#94a3b8;font-size:10px"></div>
    </div>
    <div class="sp-row sp-collapsible" onclick="spToggleSection('excl-detail')" style="margin-top:4px">
      <span>⬜ 제외 영역</span><span class="sp-val sp-bad" id="sp-excl">-</span>
    </div>
    <div class="sp-collapse-body hidden" id="excl-detail">
      <div id="sp-excl-detail" style="margin:3px 0 3px 10px;color:#94a3b8;font-size:10px"></div>
    </div>
    <div class="sp-row sp-collapsible" onclick="spToggleSection('aisle-detail')" style="font-weight:700;margin-top:6px;padding-top:6px;border-top:1px solid #1e293b">
      <span>🚶 계획 통로 (유효)</span><span class="sp-val sp-ok" id="sp-aisle-area">-</span>
    </div>
    <div class="sp-collapse-body hidden" id="aisle-detail">
      <div id="sp-aisle-detail" style="margin:3px 0 3px 10px;color:#94a3b8;font-size:10px"></div>
    </div>
    <div class="sp-row" style="color:#94a3b8">
      <span>⬜ 미활용 빈공간</span><span class="sp-val" id="sp-free">-</span>
    </div>
    <div class="sp-row" style="font-weight:700;margin-top:6px;padding-top:6px;border-top:1px solid #1e293b">
      <span>📊 총 점유</span><span class="sp-val" id="sp-total-occ" style="color:#e2e8f0">-</span>
    </div>
    <div style="display:flex;gap:6px;font-size:9px;color:#64748b;margin-top:4px">
      <span style="color:#ef4444">■ 랙</span>
      <span style="color:#3b82f6">■ 존</span>
      <span style="color:#6b7280">■ 제외</span>
      <span style="color:#06b6d4">■ 통로</span>
      <span style="color:#1e293b;border:1px solid #334155">■ 미활용</span>
    </div>
    <div style="height:10px;border-radius:4px;overflow:hidden;display:flex;margin-top:3px" id="sp-stacked"></div>
  </div>
  <div class="sp-sect">
    <div class="sp-title">🚶 2단계 · 통로 검증 <span style="color:#f59e0b">(최소1m / 권장1.3m)</span></div>
    <div style="display:flex;gap:4px;margin:4px 0 6px">
      <button id="sp-ov-rack" onclick="setOvMode(1)" style="flex:1;font-size:9px;padding:3px 6px;border-radius:3px;border:1px solid #334155;background:#1e293b;color:#94a3b8;cursor:pointer">랙 간 통로</button>
      <button id="sp-ov-total" onclick="setOvMode(2)" style="flex:1;font-size:9px;padding:3px 6px;border-radius:3px;border:1px solid #334155;background:#1e293b;color:#94a3b8;cursor:pointer">전체 통로</button>
    </div>
    <div id="sp-aisle-result"><div class="sp-tip" style="color:#64748b">분석 중...</div></div>
  </div>
  <div class="sp-sect">
    <div class="sp-title">💡 3단계 · 개선 포인트</div>
    <div id="sp-tips"><div class="sp-tip" style="color:#64748b">분석 중...</div></div>
  </div>
  <div class="sp-sect">
    <div class="sp-title">🔄 실시간 분석 <span id="sp-rt-badge" class="sp-badge sp-badge-ok">ON</span></div>
    <div class="sp-row"><span>마지막 업데이트</span><span class="sp-val" id="sp-updated">-</span></div>
    <div class="sp-row"><span>기준 면적 설정</span>
      <span><input id="sp-base-input" type="number" value="117.91" step="0.01"
        style="width:70px;background:#1e293b;border:1px solid #334155;color:#e2e8f0;padding:2px 5px;border-radius:3px;font-size:10px"
        onchange="updateSpBase()"> 평</span>
    </div>
    <div class="sp-row"><span>그룹 판별 기준</span>
      <span><input id="sp-group-input" type="number" value="300" step="50" min="0" max="1000"
        style="width:60px;background:#1e293b;border:1px solid #334155;color:#e2e8f0;padding:2px 5px;border-radius:3px;font-size:10px"
        onchange="updateGroupThresh()"> mm 이하 = 그룹</span>
    </div>
  </div>
</div>
<div id="CA" class="m-move"><div id="CV"><div class="selbox" id="SB"></div></div></div>
<div class="statusbar"><span id="coords">X:0 Y:0</span><span id="stats"></span><span id="snapSt">스냅 ON</span></div>
<div class="tooltip" id="tip"></div>
<div class="panel" id="ap"><h3>＋ 랙 추가<span class="xb" onclick="toggleP('ap')">×</span></h3><div class="pr"><label>영역</label><input id="aA" value="A1"></div><div class="pr"><label>타입</label><select id="aT" onchange="document.getElementById('customSize').style.display=this.value==='custom'?'block':'none'"><option value="heavy">중량랙 (1800mm)</option><option value="light">경량랙 (900mm)</option><option value="custom">커스텀 크기</option></select></div><div id="customSize" style="display:none"><div class="pr"><label>가로mm</label><input id="aCW" type="number" value="1800" min="100" max="10000"></div><div class="pr"><label>세로mm</label><input id="aCH" type="number" value="450" min="100" max="10000"></div></div><div class="pr"><label>시리즈</label><select id="aS"><option value="mx48">RSC48</option><option value="mx16">RSC16</option><option value="hsm">HSM</option><option value="semi">Semi</option><option value="spare">SP</option><option value="etc">기타</option></select></div><div class="pr"><label>색상</label><select id="aC"><option value="">시리즈 기본</option><option value="rgba(34,197,94,.4)">초록</option><option value="rgba(96,165,250,.4)">파랑</option><option value="rgba(249,115,22,.4)">주황</option><option value="rgba(239,68,68,.4)">빨강</option><option value="rgba(168,85,247,.4)">보라</option><option value="rgba(202,138,4,.4)">노랑</option><option value="rgba(148,163,184,.35)">회색</option></select></div><button class="pbtn" onclick="addRack()">랙 추가</button><div style="border-top:1px solid #334155;margin-top:8px;padding-top:8px"><div style="font-size:9px;color:#94a3b8;margin-bottom:4px;font-weight:700">공간/구역 추가</div><div class="pr"><label>이름</label><input id="aZN" value="새 구역"></div><div class="pr"><label>가로mm</label><input id="aZW" type="number" value="2000"></div><div class="pr"><label>세로mm</label><input id="aZH" type="number" value="1000"></div><div class="pr"><label>색상</label><select id="aZC"><option value="rgba(34,197,94,.15)">초록</option><option value="rgba(96,165,250,.12)">파랑</option><option value="rgba(249,115,22,.12)">주황</option><option value="rgba(239,68,68,.15)">빨강</option><option value="rgba(168,85,247,.12)">보라</option><option value="rgba(202,138,4,.15)">노랑</option><option value="rgba(148,163,184,.12)">회색</option></select></div><button class="pbtn" onclick="addZone()" style="background:#4c1d95;border-color:#7c3aed;color:#c4b5fd">구역 추가</button></div><div style="border-top:1px solid #334155;margin-top:8px;padding-top:8px"><div style="font-size:9px;color:#94a3b8;margin-bottom:6px;font-weight:700">\ud504\ub9ac\uc14b \ucd94\uac00</div><button class="pbtn" onclick="addPreset('table')" style="background:#1e293b;border-color:#475569;color:#94a3b8;margin-bottom:4px">\ud14c\uc774\ube14 (1.2m x 4.5m)</button><button class="pbtn" onclick="addPreset('pillar')" style="background:#1e293b;border-color:#475569;color:#94a3b8;margin-bottom:4px">\uae30\ub465 (0.5m x 0.5m)</button><button class="pbtn" onclick="addPreset('equip')" style="background:#1e293b;border-color:#475569;color:#94a3b8;margin-bottom:4px">\uc7a5\ube44 (2m x 1m)</button><button class="pbtn" onclick="addPreset('desk')" style="background:#1e293b;border-color:#475569;color:#94a3b8;margin-bottom:4px">\uc791\uc5c5\ub300 (1.8m x 0.6m)</button><button class="pbtn" onclick="addPreset('conveyor')" style="background:#1e293b;border-color:#475569;color:#94a3b8;margin-bottom:4px">\ucee8\ubca0\uc774\uc5b4 (3m x 0.5m)</button><button class="pbtn" onclick="addPreset('wall')" style="background:#1e293b;border-color:#475569;color:#94a3b8;margin-bottom:4px">\ubcbd/\ud30c\ud2f0\uc158 (3m x 0.1m)</button><button class="pbtn" onclick="addPreset('pallet')" style="background:#1e293b;border-color:#475569;color:#94a3b8;margin-bottom:4px">\ud30c\ub808\ud2b8 (1.1m x 1.1m)</button><button class="pbtn" onclick="addPreset('door')" style="background:#1e293b;border-color:#475569;color:#94a3b8">\ucd9c\uc785\uad6c (1.5m x 0.2m)</button></div></div>
<div class="panel" id="hp"><h3>\u2328 \ub3c4\uc6c0\ub9d0<span class="xb" onclick="toggleP('hp')">\xc3\x97</span></h3><div style="max-height:calc(100vh - 180px);overflow-y:auto;padding-right:4px"><div class="hs">\ubaa8\ub4dc \uc804\ud658</div><div class="hr"><div class="hk"><kbd>V</kbd></div><div class="hd">\ud83d\udd90 \uc774\ub3d9 - \ud654\uba74 \ub4dc\ub798\uadf8 \uc2a4\ud06c\ub864</div></div><div class="hr"><div class="hk"><kbd>S</kbd></div><div class="hd">\u2b1c \uc120\ud0dd - \ub799 \uc120\ud0dd/\uc774\ub3d9/\ubc94\uc704\uc120\ud0dd</div></div><div class="hr"><div class="hk"><kbd>M</kbd></div><div class="hd">\ud83d\udccf \uce21\uc815 - \ub450 \uc810 \uac70\ub9ac \uce21\uc815</div></div><div class="hr"><div class="hk"><kbd>T</kbd></div><div class="hd">T \ud14d\uc2a4\ud2b8 \ucd94\uac00</div></div><div class="hs">\uc120\ud0dd</div><div class="hr"><div class="hk"><kbd>\ud074\ub9ad</kbd></div><div class="hd">\ub2e8\uc77c \uc120\ud0dd</div></div><div class="hr"><div class="hk"><kbd>Shift+\ud074\ub9ad</kbd></div><div class="hd">\ub2e4\uc911 \uc120\ud0dd (\ucd94\uac00\ub9cc)</div></div><div class="hr"><div class="hk"><kbd>Ctrl+\ud074\ub9ad</kbd></div><div class="hd">\ud1a0\uae00 \uc120\ud0dd (\ucd94\uac00/\ud574\uc81c)</div></div><div class="hr"><div class="hk"><kbd>Ctrl+A</kbd></div><div class="hd">\uc804\uccb4 \uc120\ud0dd</div></div><div class="hr"><div class="hk"><kbd>Esc</kbd></div><div class="hd">\uc120\ud0dd \ud574\uc81c / \uc774\ub3d9 \ubaa8\ub4dc</div></div><div class="hs">\ud3b8\uc9d1</div><div class="hr"><div class="hk"><kbd>\ub354\ube14\ud074\ub9ad</kbd></div><div class="hd">\uc774\ub984/\ud06c\uae30/\uc0c9\uc0c1 \uc218\uc815</div></div><div class="hr"><div class="hk"><kbd>R</kbd></div><div class="hd">\uc120\ud0dd \ub799 90\xc2\xb0 \ud68c\uc804</div></div><div class="hr"><div class="hk"><kbd>Delete</kbd></div><div class="hd">\uc120\ud0dd \ud56d\ubaa9 \uc0ad\uc81c</div></div><div class="hr"><div class="hk"><kbd>Ctrl+C</kbd></div><div class="hd">\ubcf5\uc0ac</div></div><div class="hr"><div class="hk"><kbd>Ctrl+V</kbd></div><div class="hd">\ubd99\uc5ec\ub123\uae30</div></div><div class="hr"><div class="hk"><kbd>Ctrl+Z</kbd></div><div class="hd">\ub418\ub3cc\ub9ac\uae30 (\ucd5c\ub300 50\ub2e8\uacc4)</div></div><div class="hs">\ubcf4\uae30</div><div class="hr"><div class="hk"><kbd>Ctrl+\ud720</kbd></div><div class="hd">\ud655\ub300/\ucd95\uc18c</div></div><div class="hr"><div class="hk"><kbd>\ud720</kbd></div><div class="hd">\uc0c1\ud558 \uc2a4\ud06c\ub864</div></div><div class="hs">\uc2a4\ucf00\uc77c</div><div class="hr"><div class="hk">\ud83d\udcd0</div><div class="hd">1mm = 0.06px<br>\uadf8\ub9ac\ub4dc 1\uce78 = 0.5m<br>\uc911\ub7c9\ub799 1800\xc3\x97450mm<br>\uacbd\ub7c9\ub799 900\xc3\x97450mm<br>\ucc3d\uace0 9.4\xc3\x97 31.5m(\ubc15\uc2a4) | \uc0dd\uc0b0\ucc3d\uace0 117.91\ud3c9</div></div></div>
<script>
// safeStorage 폴리필 (iframe 환경)
const safeStorage=(()=>{try{localStorage.setItem('__t__','1');localStorage.removeItem('__t__');return localStorage;}catch(e){const _d={};return{getItem:k=>Object.prototype.hasOwnProperty.call(_d,k)?_d[k]:null,setItem:(k,v)=>{_d[k]=String(v)},removeItem:k=>{delete _d[k]}}}})();
const S=0.06,mm=v=>Math.round(v*S),SNAP=8,BX=50,BY=50,WHW=mm(9400),WHH=mm(31500),CW=BX+WHW+mm(19900)+80,CH=BY+WHH+80;
let Z=0.75,O={grid:true,snap:true},mode='move';
const CA=document.getElementById('CA'),CV=document.getElementById('CV'),SB=document.getElementById('SB');
const MD={move:'🖐 화면을 드래그하여 스크롤합니다',select:'⬚ 랙 클릭=선택 · 선택랙 드래그=이동 · 빈곳 드래그=범위선택',ruler:'📏 두 점을 클릭하여 거리 측정',text:'T 클릭으로 텍스트 추가',line:'✏ 첫 번째 점 클릭 → 두 번째 점 클릭으로 선 그리기 · 선 클릭 = 삭제',area:'⬜ 두 점을 클릭하여 직사각형 면적 계산 (L자 건물 내부만 집계) · 클릭으로 삭제'};
const SN={mx48:'RSC48',mx16:'RSC16',hsm:'HSM 3.0',semi:'Semi',spare:'SP',etc:'기타'};
let R=[],nid=1,sel=new Set(),selZ=new Set();
let zones=[{id:'defect',n:'Defect Area',x:0,y:0,w:264,h:222,c:'rgba(239,68,68,.15)',b:'rgba(239,68,68,.6)'},{id:'pkg',n:'Packaging Foam',x:3,y:350,w:50,h:800,c:'rgba(34,197,94,.15)',b:'rgba(34,197,94,.35)'},{id:'inj',n:'Injection',x:264,y:150,w:300,h:222,c:'rgba(96,165,250,.12)',b:'rgba(96,165,250,.3)'},{id:'bp',n:'Base Plate',x:60,y:1550,w:200,h:50,c:'rgba(168,85,247,.12)',b:'rgba(168,85,247,.3)'},{id:'sp',n:'Spare Part Box',x:3,y:1250,w:50,h:300,c:'rgba(148,163,184,.12)',b:'rgba(148,163,184,.3)'},{id:'test',n:'Test Area',x:936,y:774,w:300,h:210,c:'rgba(96,165,250,.12)',b:'rgba(96,165,250,.3)'},{id:'fqc',n:'Final QC Area',x:936,y:1254,w:300,h:180,c:'rgba(96,165,250,.12)',b:'rgba(96,165,250,.3)'},{id:'stand',n:'Stand',x:684,y:954,w:90,h:36,c:'rgba(202,138,4,.15)',b:'rgba(202,138,4,.35)'},{id:'tablet',n:'Tablet',x:684,y:990,w:90,h:36,c:'rgba(202,138,4,.15)',b:'rgba(202,138,4,.35)'},{id:'ybox',n:'Yellow Box',x:5,y:5,w:80,h:50,c:'rgba(234,179,8,.15)',b:'rgba(234,179,8,.4)'}];
let txts=[],ntid=1,rulers=[],lines=[],areas=[],nlid=1,naid=1,drag=null,rulerPt=null,linePt=null,areaPt=null,lineStyle='solid',lineArrow=false;
function rpx(r){var w,h;if(r.t==='custom'){w=mm(r.cw||1800);h=mm(r.ch||450)}else{w=mm(r.t==='heavy'?1800:900);h=mm(450)}if(r.rot===true||r.rot===90||r.rot===270){var tmp=w;w=h;h=tmp}return{w:w,h:h}}
function exy(e){const c=CV.getBoundingClientRect();return{x:(e.clientX-c.left)/Z,y:(e.clientY-c.top)/Z}}
function initR(){R=[];nid=1;
[{a:'A1',t:'heavy',s:'mx48',n:4,c:2,x:80,y:420},{a:'A2',t:'heavy',s:'mx48',n:4,c:2,x:80,y:510},{a:'A5',t:'heavy',s:'mx16',n:2,c:1,x:310,y:420},{a:'A6',t:'heavy',s:'mx16',n:2,c:1,x:310,y:490},{a:'A7',m:[{t:'heavy',n:1},{t:'light',n:2}],s:'mx16',c:1,x:310,y:570},{a:'B1',m:[{t:'light',n:10},{t:'heavy',n:1}],s:'mx48',c:4,x:70,y:610},{a:'B2',t:'light',s:'mx16',n:4,c:1,x:310,y:700},{a:'B3',m:[{t:'light',n:4},{t:'heavy',n:4}],s:'mx48',c:2,x:70,y:830},{a:'B4',t:'light',s:'hsm',n:6,c:1,x:345,y:20},{a:'C1',t:'light',s:'mx16',n:4,c:2,x:310,y:840},{a:'C2',t:'light',s:'hsm',n:4,c:1,x:285,y:30},{a:'C3',t:'light',s:'mx48',n:8,c:2,x:70,y:1060},{a:'A3',m:[{t:'heavy',n:1},{t:'light',n:2}],s:'hsm',c:1,x:285,y:220},{a:'S1',t:'heavy',s:'semi',n:6,c:2,x:470,y:420},{a:'E3',t:'light',s:'etc',n:4,c:2,x:480,y:630},{a:'D2',t:'heavy',s:'etc',n:1,c:1,x:350,y:1600},{a:'F1',t:'light',s:'spare',n:1,c:1,x:800,y:50}]
.forEach(d=>{let items=[];if(d.m)d.m.forEach(g=>{for(let i=0;i<g.n;i++)items.push(g.t)});else for(let i=0;i<d.n;i++)items.push(d.t);const gap=3;let col=0,cx=0,cy=0,rh=0;items.forEach(tp=>{R.push({id:nid++,a:d.a,t:tp,s:d.s,x:d.x+cx,y:d.y+cy,rot:false});cx+=mm(tp==='heavy'?1800:900)+gap;rh=Math.max(rh,mm(450));col++;if(col>=d.c){col=0;cx=0;cy+=rh+gap;rh=0}});
R.push({id:nid++,a:'TBL1',t:'custom',s:'etc',x:1070,y:904,rot:true,cw:1200,ch:4500,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL2',t:'custom',s:'etc',x:1070,y:1274,rot:true,cw:1200,ch:4500,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL3',t:'custom',s:'etc',x:1270,y:904,rot:true,cw:1200,ch:4500,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL4',t:'custom',s:'etc',x:1270,y:1274,rot:true,cw:1200,ch:4500,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL5',t:'custom',s:'etc',x:1470,y:904,rot:true,cw:1200,ch:4500,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL6',t:'custom',s:'etc',x:1470,y:1274,rot:true,cw:1200,ch:4500,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL7',t:'custom',s:'etc',x:1670,y:904,rot:true,cw:1200,ch:4500,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL8',t:'custom',s:'etc',x:1670,y:1274,rot:true,cw:1200,ch:4500,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL9',t:'custom',s:'etc',x:1340,y:1674,rot:true,cw:800,ch:2000,cc:'rgba(20,20,20,.85)'});
R.push({id:nid++,a:'TBL10',t:'custom',s:'etc',x:1540,y:1674,rot:true,cw:800,ch:2000,cc:'rgba(20,20,20,.85)'});
})}
const SK='pbk_v9';
function load(){try{var s=safeStorage.getItem(SK);if(s){var d=JSON.parse(s);if(d.R&&d.R.length){R=d.R;nid=Math.max.apply(null,R.map(function(r){return r.id}))+1;if(d.zones)zones=d.zones;if(d.txts){txts=d.txts;ntid=txts.length?Math.max.apply(null,txts.map(function(t){return t.id}))+1:1}if(d.rulers)rulers=d.rulers;if(d.lines){lines=d.lines;nlid=lines.length?Math.max.apply(null,lines.map(function(l){return l.id||0}))+1:1}if(d.areas){areas=d.areas;naid=areas.length?Math.max.apply(null,areas.map(function(a){return a.id||0}))+1:1}return true}}}catch(e){console.error('Layout load error:',e);try{safeStorage.removeItem(SK)}catch(ex){}}return false}
function loadFromData(d){if(d.R&&d.R.length>5){R=d.R;nid=Math.max.apply(null,R.map(function(r){return r.id}))+1;if(d.zones)zones=d.zones;if(d.txts){txts=d.txts;ntid=txts.length?Math.max.apply(null,txts.map(function(t){return t.id}))+1:1}if(d.rulers)rulers=d.rulers;if(d.lines){lines=d.lines;nlid=lines.length?Math.max.apply(null,lines.map(function(l){return l.id||0}))+1:1}if(d.areas){areas=d.areas;naid=areas.length?Math.max.apply(null,areas.map(function(a){return a.id||0}))+1:1}sel.clear();render();return true}return false}
function save(){autoSave();toast('✅ 저장')}
var _history=[],_redo=[],_maxHist=50;function pushHistory(){var snap=JSON.stringify({R:R,zones:zones,txts:txts,rulers:rulers,lines:lines,areas:areas});if(_history.length>=_maxHist)_history.shift();_history.push(snap);_redo=[]}function undo(){if(_history.length<2)return;var cur=_history.pop();_redo.push(cur);var prev=_history[_history.length-1];if(prev){var d=JSON.parse(prev);R=d.R;nid=Math.max.apply(null,R.map(function(r){return r.id}))+1;zones=d.zones;txts=d.txts||[];rulers=d.rulers||[];lines=d.lines||[];areas=d.areas||[];sel.clear();render();autoSaveNoHist();toast('\ub418\ub3cc\ub9ac\uae30')}}function redo(){if(!_redo.length)return;var next=_redo.pop();_history.push(next);var d=JSON.parse(next);R=d.R;nid=Math.max.apply(null,R.map(function(r){return r.id}))+1;zones=d.zones;txts=d.txts||[];rulers=d.rulers||[];lines=d.lines||[];areas=d.areas||[];sel.clear();render();autoSaveNoHist();toast('\ub2e4\uc2dc \uc2e4\ud589')}function autoSave(){pushHistory();var data=JSON.stringify({R:R,zones:zones,txts:txts,rulers:rulers,lines:lines,areas:areas});try{safeStorage.setItem(SK,data)}catch(e){}if(window.parent!==window){window.parent.postMessage({type:'layoutSave',data:data},'*')}}function autoSaveNoHist(){var data=JSON.stringify({R:R,zones:zones,txts:txts,rulers:rulers,lines:lines,areas:areas});try{safeStorage.setItem(SK,data)}catch(e){}if(window.parent!==window){window.parent.postMessage({type:'layoutSave',data:data},'*')}if(spPanelOpen)setTimeout(runSpAnalysis,50);}
function exportJSON(){try{var data=JSON.stringify({R:R,zones:zones,txts:txts,rulers:rulers,lines:lines,areas:areas,_exported:new Date().toISOString(),_version:'v9'},null,2);var blob=new Blob([data],{type:'application/json'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='PBK_Layout_'+new Date().toISOString().slice(0,10)+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a);setTimeout(function(){URL.revokeObjectURL(url)},500);toast('📤 파일 내보내기 완료')}catch(ex){toast('⚠ 내보내기 실패: '+ex.message)}}
function importJSON(e){var file=e.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(ev){try{var d=JSON.parse(ev.target.result);if(d.R&&d.R.length){R=d.R;nid=Math.max.apply(null,R.map(function(r){return r.id}))+1;if(d.zones)zones=d.zones;if(d.txts){txts=d.txts;ntid=txts.length?Math.max.apply(null,txts.map(function(t){return t.id}))+1:1}if(d.rulers)rulers=d.rulers;if(d.lines){lines=d.lines;nlid=lines.length?Math.max.apply(null,lines.map(function(l){return l.id||0}))+1:1}if(d.areas){areas=d.areas;naid=areas.length?Math.max.apply(null,areas.map(function(a){return a.id||0}))+1:1}sel.clear();render();toast('📥 불러오기 완료 (랙 '+R.length+'개)')}else{toast('⚠ 유효하지 않은 파일')}}catch(ex){toast('⚠ 파일 오류: '+ex.message)}};reader.readAsText(file);e.target.value=''}
function doReset(){showConfirm('정말 초기화하시겠습니까?',function(){safeStorage.removeItem(SK);if(window.parent!==window){window.parent.postMessage({type:'layoutClear'},'*')}initR();txts=[];rulers=[];lines=[];areas=[];sel.clear();zones=[{id:'defect',n:'Defect Area',x:0,y:0,w:264,h:222,c:'rgba(239,68,68,.15)',b:'rgba(239,68,68,.6)'},{id:'pkg',n:'Packaging Foam',x:3,y:350,w:50,h:800,c:'rgba(34,197,94,.15)',b:'rgba(34,197,94,.35)'},{id:'inj',n:'Injection',x:264,y:150,w:300,h:222,c:'rgba(96,165,250,.12)',b:'rgba(96,165,250,.3)'},{id:'bp',n:'Base Plate',x:60,y:1550,w:200,h:50,c:'rgba(168,85,247,.12)',b:'rgba(168,85,247,.3)'},{id:'sp',n:'Spare Part Box',x:3,y:1250,w:50,h:300,c:'rgba(148,163,184,.12)',b:'rgba(148,163,184,.3)'},{id:'test',n:'Test Area',x:936,y:774,w:300,h:210,c:'rgba(96,165,250,.12)',b:'rgba(96,165,250,.3)'},{id:'fqc',n:'Final QC Area',x:936,y:1254,w:300,h:180,c:'rgba(96,165,250,.12)',b:'rgba(96,165,250,.3)'},{id:'stand',n:'Stand',x:684,y:954,w:90,h:36,c:'rgba(202,138,4,.15)',b:'rgba(202,138,4,.35)'},{id:'tablet',n:'Tablet',x:684,y:990,w:90,h:36,c:'rgba(202,138,4,.15)',b:'rgba(202,138,4,.35)'},{id:'ybox',n:'Yellow Box',x:5,y:5,w:80,h:50,c:'rgba(234,179,8,.15)',b:'rgba(234,179,8,.4)'}];render();autoSave();toast('\xec\xb4\x88\xea\xb8\xb0\xed\x99\x94 \xec\x99\x84\xeb\xa3\x8c')})}
function toast(m){const t=document.createElement('div');t.textContent=m;Object.assign(t.style,{position:'fixed',bottom:'40px',left:'50%',transform:'translateX(-50%)',background:'#065f46',color:'#6ee7b7',padding:'6px 16px',borderRadius:'6px',fontSize:'11px',fontWeight:'600',zIndex:'400',fontFamily:'inherit'});document.body.appendChild(t);setTimeout(()=>t.remove(),1500)}
function setLineStyle(s){lineStyle=s;document.getElementById('lsBtn').className='lopt'+(s==='solid'?' active':'');document.getElementById('ldBtn').className='lopt'+(s==='dashed'?' active':'');}
function toggleArrow(){lineArrow=!lineArrow;var b=document.getElementById('lineArrow');if(b)b.className=lineArrow?'active':'';}
function setMode(m){var prev=mode;mode=m;rulerPt=null;linePt=null;areaPt=null;var rmk=document.getElementById('rulerStartMk');if(rmk)rmk.style.display='none';var rpv=document.getElementById('rulerPreviewSvg');if(rpv)rpv.remove();document.querySelectorAll('.mbtn').forEach(b=>b.classList.toggle('active',b.dataset.m===m));CA.className='m-'+(m==='line'?'ruler':m);var lo=document.getElementById('lineOpts');if(lo)lo.className=m==='line'?'visible':'';document.getElementById('md').textContent=MD[m]||'';if(m==='area'){document.querySelectorAll('.sp-corridor-ov,.sp-total-ov,.sp-area-highlight').forEach(function(el){el.style.display='none'})}else{document.querySelectorAll('.sp-corridor-ov,.sp-total-ov,.sp-area-highlight').forEach(function(el){el.style.display=''});if(prev==='area'&&spPanelOpen)setTimeout(runSpAnalysis,50)}}
function render(){CV.innerHTML='';CV.appendChild(SB);CV.style.width=CW+'px';CV.style.height=CH+'px';CV.style.transform='scale('+Z+')';SB.style.display='none';
if(O.grid){var g=mm(500);var gW=WHW+mm(19900)+20;for(var x=BX;x<=BX+gW;x+=g)el('gl glv',CV,{left:x,top:BY,width:1,height:WHH});for(var y=BY;y<=BY+WHH;y+=g)el('gl glh',CV,{left:BX,top:y,width:gW,height:1})}
var lPath='M '+BX+' '+BY+' L '+(BX+WHW)+' '+BY+' L '+(BX+WHW)+' '+(BY+mm(12900))+' L '+(BX+WHW+10+mm(19900))+' '+(BY+mm(12900))+' L '+(BX+WHW+10+mm(19900))+' '+(BY+WHH)+' L '+BX+' '+(BY+WHH)+' Z';
var lSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');lSvg.style.cssText='position:absolute;left:0;top:0;width:'+CW+'px;height:'+CH+'px;z-index:1;pointer-events:none';lSvg.innerHTML='<path d="'+lPath+'" fill="rgba(20,30,50,.15)" stroke="rgba(255,255,255,.7)" stroke-width="2.5" stroke-linejoin="round"/>';CV.appendChild(lSvg);
// 생산라인 텍스트 제거됨
const l1=el('blbl',CV,{left:BX+WHW/2,top:BY+WHH+10});l1.textContent='9.4m';l1.style.transform='translateX(-50%)';
const l2=el('blbl',CV,{left:BX-14,top:BY+WHH/2});l2.textContent='31.5m';l2.style.transform='rotate(-90deg) translateX(-50%)';l2.style.transformOrigin='0 0';
var la=el('blbl',CV,{left:BX+WHW/2,top:BY+12});la.textContent='창고 박스 9.4m×31.5m (직사각형 기준) | 생산창고 117.91평 | 생산라인+창고 195.01평';la.style.transform='translateX(-50%)';la.style.fontSize='8px';la.style.color='#64748b';
zones.forEach((z,i)=>{const e=el('zone',CV,{left:BX+z.x,top:BY+z.y,width:z.w,height:z.h});e.style.background=z.c;e.style.border='1.5px dashed '+z.b;e.dataset.zi=i;e.dataset.zid=z.id||('z'+i);if(selZ.has(z.id||('z'+i)))e.style.outline='2px solid #f59e0b';e.innerHTML='<span class="zn" style="font-size:'+(z.fs||11)+'px;'+(z.fc?'color:'+z.fc:'')+'">'+ z.n+(z.excl?' <span style="font-size:8px;background:rgba(239,68,68,.5);color:#fff;border-radius:3px;padding:0 3px;vertical-align:middle">제외</span>':'')+'</span>';if(z.rot){var spans=e.querySelectorAll('.zn');for(var si=0;si<spans.length;si++)spans[si].style.transform='rotate('+z.rot+'deg)'}+'<span class="zd">'+z.w+'×'+z.h+'</span><div class="rh" data-rh="'+i+'"></div>';});
R.forEach((r,i)=>{const p=rpx(r);const e=el('rk '+r.s,CV,{left:r.x,top:r.y,width:p.w,height:p.h});e.dataset.ri=i;e.dataset.id=r.id;e.style.fontSize=(p.w<40?7:8)+'px';e.style.lineHeight=p.h+'px';if(sel.has(r.id))e.classList.add('sel');if(r.cc){e.style.background=r.cc;e.style.borderColor=r.cc}const sp=document.createElement('span');sp.textContent=r.a;sp.style.pointerEvents='none';sp.style.textShadow='0 1px 3px rgba(0,0,0,.7)';var autoFs=Math.min(r.fs||11,Math.floor(Math.min(p.w,p.h)*0.7));sp.style.fontSize=Math.max(autoFs,8)+'px';sp.style.fontWeight='700';sp.style.color=r.fc||'#fff';e.appendChild(sp);const rot=document.createElement('div');rot.className='rot';rot.textContent='↻';rot.dataset.rotid=r.id;e.appendChild(rot);});
txts.forEach((t,i)=>{const e=el('txl',CV,{left:t.x,top:t.y});e.dataset.ti=i;if(t.fs)e.style.fontSize=t.fs+'px';if(t.fc)e.style.color=t.fc;if(t.rot)e.style.transform='rotate('+t.rot+'deg)';const sp=document.createElement('span');sp.textContent=t.text;sp.style.pointerEvents='none';e.appendChild(sp);const x=document.createElement('div');x.className='xb';x.textContent='×';x.dataset.dtx=i;e.appendChild(x);});
rulers.forEach((rl,i)=>{const dx=rl.x2-rl.x1,dy=rl.y2-rl.y1,len=Math.sqrt(dx*dx+dy*dy),rMM=Math.round(len/S),rM=(rMM/1000).toFixed(2);const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');svg.setAttribute('class','rl-line');svg.style.width=CW+'px';svg.style.height=CH+'px';svg.innerHTML='<line x1="'+rl.x1+'" y1="'+rl.y1+'" x2="'+rl.x2+'" y2="'+rl.y2+'" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,3"/>';CV.appendChild(svg);el('rl-dot',CV,{left:rl.x1,top:rl.y1});el('rl-dot',CV,{left:rl.x2,top:rl.y2});const lb=el('rl-label',CV,{left:(rl.x1+rl.x2)/2,top:(rl.y1+rl.y2)/2-18});lb.textContent=rM+'m ('+rMM.toLocaleString()+'mm)';lb.style.transform='translateX(-50%)';lb.dataset.drl=i;});
// ── preview SVG 정리 (render 시) ──
var pvOld=document.getElementById('linePreviewSvg');if(pvOld){pvOld.innerHTML=''}
var apOld=document.getElementById('areaPreview');if(apOld){apOld.innerHTML=''}
// ── 면적 영역 렌더링 ──
areas.forEach(function(ar,i){
  // L자 건물 정의 (두 직사각형의 합집합)
  // R1: 창고 (BX,BY)~(BX+WHW,BY+WHH)
  // R2: 생산라인 (BX+WHW,BY+mm(12900))~(BX+WHW+mm(19900),BY+WHH)
  var R1={x1:BX,y1:BY,x2:BX+WHW,y2:BY+WHH};
  var R2={x1:BX+WHW,y1:BY+mm(12900),x2:BX+WHW+mm(19900),y2:BY+WHH};
  function intersect(ax1,ay1,ax2,ay2,bx1,by1,bx2,by2){
    var ix1=Math.max(ax1,bx1),iy1=Math.max(ay1,by1),ix2=Math.min(ax2,bx2),iy2=Math.min(ay2,by2);
    if(ix2<=ix1||iy2<=iy1)return null;
    return{x1:ix1,y1:iy1,x2:ix2,y2:iy2};
  }
  var selX1=Math.min(ar.x1,ar.x2),selY1=Math.min(ar.y1,ar.y2);
  var selX2=Math.max(ar.x1,ar.x2),selY2=Math.max(ar.y1,ar.y2);
  var i1=intersect(selX1,selY1,selX2,selY2,R1.x1,R1.y1,R1.x2,R1.y2);
  var i2=intersect(selX1,selY1,selX2,selY2,R2.x1,R2.y1,R2.x2,R2.y2);
  var totalMM2=0;
  var svgInner='';
  [i1,i2].forEach(function(ir){
    if(!ir)return;
    var wPx=ir.x2-ir.x1,hPx=ir.y2-ir.y1;
    var wMM=wPx/S,hMM=hPx/S;
    totalMM2+=wMM*hMM;
    svgInner+='<rect x="'+ir.x1+'" y="'+ir.y1+'" width="'+wPx+'" height="'+hPx+'" fill="rgba(34,211,238,.05)" stroke="rgba(34,211,238,.25)" stroke-width="1"/>';
  });
  // ── excl 존 차감 ──
  var exclMM2=0;var exclNames=[];
  zones.forEach(function(z){
    if(!z.excl)return;
    // 존 픽셀 좌표
    var zx1=BX+z.x,zy1=BY+z.y,zx2=BX+z.x+z.w,zy2=BY+z.y+z.h;
    // 선택 영역과 excl존의 교집합
    var ex1=Math.max(selX1,zx1),ey1=Math.max(selY1,zy1),ex2=Math.min(selX2,zx2),ey2=Math.min(selY2,zy2);
    if(ex2<=ex1||ey2<=ey1)return;
    var ewPx=ex2-ex1,ehPx=ey2-ey1;
    var ewMM=ewPx/S,ehMM=ehPx/S;
    exclMM2+=ewMM*ehMM;
    exclNames.push(z.n);
    // 빨간 오버레이로 제외 영역 표시
    svgInner+='<rect x="'+ex1+'" y="'+ey1+'" width="'+ewPx+'" height="'+ehPx+'" fill="rgba(239,68,68,.08)" stroke="rgba(239,68,68,.4)" stroke-width="1"/>';
    svgInner+='<text x="'+(ex1+ewPx/2)+'" y="'+(ey1+ehPx/2)+'" text-anchor="middle" dominant-baseline="middle" fill="rgba(239,68,68,.8)" font-size="10" font-family="inherit">✕제외</text>';
  });
  totalMM2-=exclMM2;
  if(totalMM2<0)totalMM2=0;
  // 선택 영역 외곽선
  svgInner+='<rect x="'+selX1+'" y="'+selY1+'" width="'+(selX2-selX1)+'" height="'+(selY2-selY1)+'" fill="none" stroke="rgba(34,211,238,.15)" stroke-width="0.8"/>';
  var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('class','area-overlay');svg.style.width=CW+'px';svg.style.height=CH+'px';
  svg.innerHTML=svgInner;
  CV.appendChild(svg);
  // 면적 라벨
  var m2=(totalMM2/1e6).toFixed(2);
  var m2Tsubo=(totalMM2/1e6/3.30579).toFixed(2);
  var cx=(selX1+selX2)/2,cy=(selY1+selY2)/2;
  var lbl=el('area-label',CV,{left:cx,top:cy});
  lbl.style.transform='translate(-50%,-50%)';
  var exclInfo=exclMM2>0?('<br><span style="font-size:9px;color:rgba(239,68,68,.9)">-'+(exclMM2/1e6).toFixed(2)+'m² ('+exclNames.join(', ')+') 제외됨</span>'):'';
  lbl.innerHTML='📐 <b>'+m2+'m²</b> ('+m2Tsubo+'평)'+exclInfo+'<br><span style="font-size:9px;opacity:.6">클릭하여 삭제 ✕</span>';
  lbl.dataset.dai=i;
  // 클릭으로 즉시 삭제 (이벤트 직접 바인딩)
  (function(idx){ lbl.addEventListener('click', function(e){ e.stopPropagation(); areas.splice(idx,1); render(); autoSave(); toast('면적 삭제됨'); }); })(i);
});
// ── 사용자 정의 선(draw lines) 렌더링 ──
lines.forEach(function(ln,i){
  var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('class','dl-svg');svg.style.width=CW+'px';svg.style.height=CH+'px';
  var dash=ln.style==='dashed'?'stroke-dasharray="8,5"':'';
  var col=ln.color||'#ffffff';var w=ln.width||2;
  var arrowId='arr'+i;
  var arrowDef=ln.arrow?('<defs><marker id="'+arrowId+'" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 Z" fill="'+col+'"/></marker></defs>'):'';
  var mEnd=ln.arrow?('marker-end="url(#'+arrowId+')"'):'';
  svg.innerHTML=arrowDef+'<line x1="'+ln.x1+'" y1="'+ln.y1+'" x2="'+ln.x2+'" y2="'+ln.y2+'" stroke="'+col+'" stroke-width="'+w+'" '+dash+' stroke-linecap="round" '+mEnd+'/>';
  CV.appendChild(svg);
  // 중간 핸들 (선 이동용)
  var mx=(ln.x1+ln.x2)/2,my=(ln.y1+ln.y2)/2;
  var hEl=document.createElement('div');
  hEl.className='dl-handle';hEl.style.left=mx+'px';hEl.style.top=my+'px';
  hEl.style.background=col;hEl.style.border='2px solid rgba(255,255,255,.5)';
  hEl.dataset.dli=i;hEl.dataset.dltype='move';hEl.title='드래그: 이동 · 더블클릭: 삭제';
  CV.appendChild(hEl);
  // 시작점 핸들 (끝점 조절용)
  var ep1=document.createElement('div');
  ep1.className='dl-ep';ep1.style.left=ln.x1+'px';ep1.style.top=ln.y1+'px';
  ep1.style.borderColor=col;ep1.dataset.dli=i;ep1.dataset.dltype='p1';ep1.title='드래그: 시작점 이동';
  CV.appendChild(ep1);
  // 끝점 핸들
  var ep2=document.createElement('div');
  ep2.className='dl-ep';ep2.style.left=ln.x2+'px';ep2.style.top=ln.y2+'px';
  ep2.style.borderColor=col;ep2.dataset.dli=i;ep2.dataset.dltype='p2';ep2.title='드래그: 끝점 이동';
  CV.appendChild(ep2);
});
upStats();}
function el(cls,par,pos){const d=document.createElement('div');d.className=cls;if(pos){d.style.left=pos.left+'px';d.style.top=pos.top+'px';if(pos.width)d.style.width=pos.width+'px';if(pos.height)d.style.height=pos.height+'px';}if(par)par.appendChild(d);return d}
function updSel(){document.querySelectorAll('.rk').forEach(e=>e.classList.toggle('sel',sel.has(+e.dataset.id)));document.querySelectorAll('.zone').forEach(e=>{var zid=e.dataset.zid;e.style.outline=selZ.has(zid)?'2px solid #f59e0b':''})}

// ══════════ 공간 분석 엔진 ══════════
var spBasePyeong=117.91;
var spBaseM2=spBasePyeong*3.30579;
var spPanelOpen=false;
var spOvMode=0; // 0=off, 1=랙 간 통로, 2=전체 통로
var rackM2_global=0,zoneM2_global=0,exclM2_global=0,selM2_global=0;
var MIN_AISLE=1000,OPT_AISLE=1300,GROUP_THRESH=300; // OPT_AISLE: 1.3m (시리즈 랙간 권장 통로) // mm - GROUP_THRESH: 붙어있는 랙 그룹 판별 기준 (이 이하면 의도적 그룹으로 간주, 통로 체크 제외)

function spToggleSection(id){
  var el=document.getElementById(id);if(!el)return;
  var tog=el.previousElementSibling;
  if(el.classList.contains('hidden')){el.classList.remove('hidden');if(tog)tog.classList.remove('collapsed');}
  else{el.classList.add('hidden');if(tog)tog.classList.add('collapsed');}
}
function spHighlightAisle(it){
  // 기존 하이라이트 제거
  document.querySelectorAll('.sp-highlight-overlay,.sp-focus-badge').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});
  if(!it||!it.ra||!it.rb)return;
  // 두 랙 하이라이트
  [it.ra,it.rb].forEach(function(r,i){
    var ov=document.createElement('div');ov.className='sp-highlight-overlay';
    ov.style.cssText='left:'+r.x+'px;top:'+r.y+'px;width:'+r.w+'px;height:'+r.h+'px;'
      +'background:rgba(251,191,36,'+(i===0?'.35':'.35')+');border:2px solid #fbbf24;';
    CV.appendChild(ov);
  });
  // 간격 시각화
  var gapEl=document.createElement('div');gapEl.className='sp-highlight-overlay';
  if(it.dir==='X'){
    var x1=it.ra.x+it.ra.w,x2=it.rb.x,midY=(it.ra.y+it.ra.y+it.ra.h)/2;
    if(x1>x2){x1=it.rb.x+it.rb.w;x2=it.ra.x;}
    gapEl.style.cssText='left:'+x1+'px;top:'+(midY-8)+'px;width:'+(x2-x1)+'px;height:16px;background:rgba(239,68,68,.25);border:1px dashed #ef4444;';
  }else{
    var y1=it.ra.y+it.ra.h,y2=it.rb.y,midX=(it.ra.x+it.ra.x+it.ra.w)/2;
    if(y1>y2){y1=it.rb.y+it.rb.h;y2=it.ra.y;}
    gapEl.style.cssText='left:'+(midX-8)+'px;top:'+y1+'px;width:16px;height:'+(y2-y1)+'px;background:rgba(239,68,68,.25);border:1px dashed #ef4444;';
  }
  CV.appendChild(gapEl);
  // 배지
  var badge=document.createElement('div');badge.className='sp-focus-badge';
  badge.style.cssText='left:'+Math.min(it.ra.x,it.rb.x)+'px;top:'+(Math.min(it.ra.y,it.rb.y)-18)+'px;';
  badge.textContent=(it.gap/1000).toFixed(2)+'m';
  CV.appendChild(badge);
  // 화면 스크롤 이동
  var cx=(it.ra.x+it.rb.x)/2*Z-CA.clientWidth/2;
  var cy=(it.ra.y+it.rb.y)/2*Z-CA.clientHeight/2;
  CA.scrollLeft=Math.max(0,cx);CA.scrollTop=Math.max(0,cy);
  setTimeout(function(){document.querySelectorAll('.sp-highlight-overlay,.sp-focus-badge').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});},3000);
}
function spFocusRacks(prefix){
  document.querySelectorAll('.sp-highlight-overlay,.sp-focus-badge').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});
  var found=R.filter(function(r){return r.a.replace(/[0-9]/g,'')===prefix;});
  found.forEach(function(r){
    var rp=rpx(r);var ov=document.createElement('div');ov.className='sp-highlight-overlay';
    ov.style.cssText='left:'+r.x+'px;top:'+r.y+'px;width:'+rp.w+'px;height:'+rp.h+'px;background:rgba(99,102,241,.35);border:2px solid #6366f1;';
    CV.appendChild(ov);
  });
  if(found.length>0){var r0=found[0];CA.scrollLeft=r0.x*Z-CA.clientWidth/2;CA.scrollTop=r0.y*Z-CA.clientHeight/2;}
  setTimeout(function(){document.querySelectorAll('.sp-highlight-overlay,.sp-focus-badge').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});},3000);
}
function spFocusZone(name){
  document.querySelectorAll('.sp-highlight-overlay,.sp-focus-badge').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});
  zones.forEach(function(z){
    if(z.n!==name)return;
    var ov=document.createElement('div');ov.className='sp-highlight-overlay';
    ov.style.cssText='left:'+(BX+z.x)+'px;top:'+(BY+z.y)+'px;width:'+z.w+'px;height:'+z.h+'px;background:rgba(59,130,246,.3);border:2px solid #3b82f6;';
    CV.appendChild(ov);
    CA.scrollLeft=(BX+z.x)*Z-CA.clientWidth/2;CA.scrollTop=(BY+z.y)*Z-CA.clientHeight/2;
  });
  setTimeout(function(){document.querySelectorAll('.sp-highlight-overlay,.sp-focus-badge').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});},3000);
}
function toggleSpPanel(){spPanelOpen=!spPanelOpen;var p=document.getElementById('spPanel');if(p)p.className=spPanelOpen?'open':'';if(!spPanelOpen){spOvMode=0;document.querySelectorAll('.sp-corridor-ov,.sp-total-ov').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)});}runSpAnalysis();}
function setOvMode(m){spOvMode=spOvMode===m?0:m;updateOvButtons();if(spPanelOpen)runSpAnalysis();}
function updateOvButtons(){
  var b1=document.getElementById('sp-ov-rack'),b2=document.getElementById('sp-ov-total');
  if(b1){b1.style.background=spOvMode===1?'rgba(6,182,212,.15)':'#1e293b';b1.style.color=spOvMode===1?'#67e8f9':'#94a3b8';b1.style.borderColor=spOvMode===1?'rgba(6,182,212,.4)':'#334155';}
  if(b2){b2.style.background=spOvMode===2?'rgba(139,92,246,.15)':'#1e293b';b2.style.color=spOvMode===2?'#a78bfa':'#94a3b8';b2.style.borderColor=spOvMode===2?'rgba(139,92,246,.4)':'#334155';}
}
function spHighlightArea(x1,y1,x2,y2,label,color){
  document.querySelectorAll('.sp-area-highlight').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});
  var ov=document.createElement('div');
  ov.className='sp-area-highlight';
  ov.style.cssText='position:absolute;z-index:17;pointer-events:none;border-radius:4px;left:'+x1+'px;top:'+y1+'px;width:'+(x2-x1)+'px;height:'+(y2-y1)+'px;background:'+(color||'rgba(251,191,36,.12)')+';border:2px dashed '+(color?color.replace('.12','.6'):'rgba(251,191,36,.5)')+';animation:spPulse 1s infinite alternate';
  if(label){
    var lbl=document.createElement('div');
    lbl.style.cssText='position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;font-weight:700;white-space:nowrap;text-shadow:0 1px 3px rgba(0,0,0,.9);pointer-events:none;color:#fbbf24;background:rgba(15,23,42,.85);padding:3px 10px;border-radius:4px';
    lbl.textContent=label;
    ov.appendChild(lbl);
  }
  CV.appendChild(ov);
  CA.scrollLeft=((x1+x2)/2)*Z-CA.clientWidth/2;CA.scrollTop=((y1+y2)/2)*Z-CA.clientHeight/2;
  setTimeout(function(){document.querySelectorAll('.sp-area-highlight').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});},4000);
}
function updateSpBase(){var v=parseFloat(document.getElementById('sp-base-input').value)||117.69;spBasePyeong=v;spBaseM2=v*3.30579;var el=document.getElementById('sp-base');if(el)el.textContent=v.toFixed(2)+'평 ('+(spBaseM2).toFixed(2)+'m²)';runSpAnalysis();}
function updateGroupThresh(){var v=parseInt(document.getElementById('sp-group-input').value);if(!isNaN(v)&&v>=0)GROUP_THRESH=v;runSpAnalysis();}

function getIntersectArea(ax1,ay1,ax2,ay2,bx1,by1,bx2,by2){
  var ix1=Math.max(ax1,bx1),iy1=Math.max(ay1,by1),ix2=Math.min(ax2,bx2),iy2=Math.min(ay2,by2);
  if(ix2<=ix1||iy2<=iy1)return 0;
  return((ix2-ix1)/S)*((iy2-iy1)/S); // mm²
}

function runSpAnalysis(){
  var corridors=[];
  var corridorSeen={};
  var aisleIssues=[],aisleOk=0,aisleWarn=0,aisleBad=0;
  var racksInSel=[];
  var selArea=areas.length>0?areas[areas.length-1]:null;
  var selX1,selY1,selX2,selY2,selM2;
  if(selArea){
    selX1=Math.min(selArea.x1,selArea.x2);selY1=Math.min(selArea.y1,selArea.y2);
    selX2=Math.max(selArea.x1,selArea.x2);selY2=Math.max(selArea.y1,selArea.y2);
    var R1={x1:BX,y1:BY,x2:BX+WHW,y2:BY+WHH};
    var R2={x1:BX+WHW,y1:BY+mm(12900),x2:BX+WHW+mm(19900),y2:BY+WHH};
    var i1=getIntersectArea(selX1,selY1,selX2,selY2,R1.x1,R1.y1,R1.x2,R1.y2);
    var i2=getIntersectArea(selX1,selY1,selX2,selY2,R2.x1,R2.y1,R2.x2,R2.y2);
    var exclMM2=0;
    zones.forEach(function(z){if(!z.excl)return;exclMM2+=getIntersectArea(selX1,selY1,selX2,selY2,BX+z.x,BY+z.y,BX+z.x+z.w,BY+z.y+z.h);});
    selM2=(i1+i2-exclMM2)/1e6;
  }else{selX1=BX;selY1=BY;selX2=982;selY2=BY+WHH;selM2=spBaseM2;}
  var selPy=(selM2/3.30579);
  var e_sel=document.getElementById('sp-sel');
  if(e_sel)e_sel.textContent=selM2.toFixed(2)+'m² ('+selPy.toFixed(2)+'평)'+(selArea?'':' [전체창고]');

  // ── 1단계 ──
  var rackMM2=0,rackCnt=0,racksByArea={};
  R.forEach(function(r){
    var rp=rpx(r);var ov=getIntersectArea(selX1,selY1,selX2,selY2,r.x,r.y,r.x+rp.w,r.y+rp.h);
    if(ov>0){rackMM2+=ov;rackCnt++;var key=r.a.replace(/[0-9]/g,'');if(!racksByArea[key])racksByArea[key]=[];racksByArea[key].push(r);}
  });
  var rackM2=rackMM2/1e6;
  var zoneMM2=0,zoneDetail={},exclTotalMM2=0;
  zones.forEach(function(z){
    var ov=getIntersectArea(selX1,selY1,selX2,selY2,BX+z.x,BY+z.y,BX+z.x+z.w,BY+z.y+z.h);
    if(ov<=0)return;
    if(z.excl){exclTotalMM2+=ov;}else{zoneMM2+=ov;zoneDetail[z.n]=(zoneDetail[z.n]||0)+ov;}
  });
  var zoneM2=zoneMM2/1e6,exclM2=exclTotalMM2/1e6;
  rackM2_global=rackM2;zoneM2_global=zoneM2;exclM2_global=exclM2;selM2_global=selM2;
  var totalFreeM2=Math.max(0,selM2-rackM2-zoneM2-exclM2);
  // 계획 통로 면적 추정: 각 랙 둘레(mm) × MIN_AISLE(mm) / 1e12 m²
  // 인접 랙 간 공유 통로이므로 × 0.5 보정
  var plannedAisleMM2=0;
  R.forEach(function(r){
    var rp=rpx(r);
    var perimMM=(rp.w/S*2+rp.h/S*2); // 둘레 mm
    plannedAisleMM2+=perimMM*MIN_AISLE*0.5;
  });
  var plannedAisleM2=Math.min(plannedAisleMM2/1e6, totalFreeM2*0.8); // 최대 빈공간의 80%
  var unusedM2=Math.max(0,totalFreeM2-plannedAisleM2);
  var freeM2=totalFreeM2; // 하위 호환
  var rackPct=selM2>0?(rackM2/selM2*100):0;
  var zonePct=selM2>0?(zoneM2/selM2*100):0;
  var exclPct=selM2>0?(exclM2/selM2*100):0;
  var aislePct=selM2>0?(plannedAisleM2/selM2*100):0;
  var unusedPct=selM2>0?(unusedM2/selM2*100):0;
  var freePct=selM2>0?(totalFreeM2/selM2*100):0;
  var utilPct=selM2>0?((rackM2+zoneM2+plannedAisleM2)/selM2*100):0; // 통로 포함 유효 활용률

  function setTxt(id,v){var e=document.getElementById(id);if(e)e.innerHTML=v;}
  setTxt('sp-rack',rackM2.toFixed(2)+'m² ('+rackPct.toFixed(1)+'%) ▾ '+rackCnt+'개');
  
  // 랙 목록 DOM 생성
  var rlEl=document.getElementById('sp-rack-list');
  if(rlEl){
    rlEl.innerHTML='';
    Object.keys(racksByArea).forEach(function(k){
      var cnt=racksByArea[k].length;
      var rp0=rpx(racksByArea[k][0]);
      var wMM=Math.round(rp0.w/S),hMM=Math.round(rp0.h/S);
      var row=document.createElement('div');
      row.style.cssText='display:flex;justify-content:space-between;padding:2px 0';
      var sp=document.createElement('span');
      sp.style.cssText='cursor:pointer;color:#93c5fd';
      sp.textContent=k+' 계열 ('+cnt+'개)';
      sp.title='클릭: 해당 랙 하이라이트';
      sp.onclick=function(ky){return function(){spFocusRacks(ky);};}(k);
      var sz=document.createElement('span');
      sz.style.color='#64748b';sz.textContent=wMM+'×'+hMM+'mm';
      row.appendChild(sp);row.appendChild(sz);
      rlEl.appendChild(row);
    });
    if(!rlEl.children.length)rlEl.innerHTML='<span style="color:#475569">낙 없음</span>';
  }

  setTxt('sp-zone',zoneM2.toFixed(2)+'m² ('+zonePct.toFixed(1)+'%) ▾');
  
  // 존 목록 DOM 생성
  var zdEl=document.getElementById('sp-zone-detail');
  if(zdEl){
    zdEl.innerHTML='';
    Object.keys(zoneDetail).forEach(function(k){
      var row=document.createElement('div');
      row.style.cssText='display:flex;justify-content:space-between;padding:2px 0;cursor:pointer';
      row.title='클릭: 해당 존 하이라이트';
      var nm=document.createElement('span');
      nm.style.color='#93c5fd';nm.textContent='└ '+k;
      var sz=document.createElement('span');
      sz.style.color='#64748b';sz.textContent=(zoneDetail[k]/1e6).toFixed(1)+'m²';
      row.appendChild(nm);row.appendChild(sz);
      row.onclick=function(zn){return function(){spFocusZone(zn);};}(k);
      zdEl.appendChild(row);
    });
    if(!zdEl.children.length)zdEl.innerHTML='<span style="color:#475569">존 없음</span>';
  }

  setTxt('sp-excl','<span class="sp-bad">'+exclM2.toFixed(2)+'m² ('+exclPct.toFixed(1)+'%) 제외</span>');

  // 제외 영역 상세 DOM
  var exclDetailEl=document.getElementById('sp-excl-detail');
  if(exclDetailEl){
    exclDetailEl.innerHTML='';
    zones.forEach(function(z){
      var ov=getIntersectArea(selX1,selY1,selX2,selY2,BX+z.x,BY+z.y,BX+z.x+z.w,BY+z.y+z.h);
      if(!z.excl||ov<=0)return;
      var row=document.createElement('div');
      row.style.cssText='display:flex;justify-content:space-between;padding:2px 0;cursor:pointer';
      var nm=document.createElement('span');nm.style.color='#f87171';nm.textContent='✕ '+z.n;
      var sz=document.createElement('span');sz.style.color='#6b7280';sz.textContent=(ov/1e6).toFixed(1)+'m²';
      row.appendChild(nm);row.appendChild(sz);
      row.onclick=(function(zn){return function(){spFocusZone(zn);};})(z.n);
      exclDetailEl.appendChild(row);
    });
    if(!exclDetailEl.children.length)exclDetailEl.innerHTML='<span style="color:#475569">제외 존 없음</span>';
  }
  setTxt('sp-aisle-area','<span class="sp-ok">'+plannedAisleM2.toFixed(2)+'m² ('+aislePct.toFixed(1)+'%)</span>');

  var unusedClass=unusedPct<20?'sp-ok':unusedPct<40?'sp-warn':'sp-bad';
  setTxt('sp-free','<span class="'+unusedClass+'">'+unusedM2.toFixed(2)+'m² ('+unusedPct.toFixed(1)+'%)</span>');
  var totalOccM2=rackM2+zoneM2;
  var totalOccPct=selM2>0?(totalOccM2/selM2*100):0;
  setTxt('sp-total-occ',totalOccM2.toFixed(2)+'m² ('+totalOccPct.toFixed(1)+'%)');
  var sb=document.getElementById('sp-stacked');
  if(sb)sb.innerHTML='<div style="width:'+rackPct.toFixed(1)+'%;background:#ef4444;height:100%"></div>'
    +'<div style="width:'+zonePct.toFixed(1)+'%;background:#3b82f6;height:100%"></div>'
    +'<div style="width:'+exclPct.toFixed(1)+'%;background:#6b7280;height:100%"></div>'
    +'<div style="width:'+aislePct.toFixed(1)+'%;background:#06b6d4;height:100%"></div>'
    +'<div style="width:'+unusedPct.toFixed(1)+'%;background:#1e3a5f;height:100%"></div>';

  // ── 2단계: 통로 검증 (그룹 바운딩박스 기반) ──
  aisleIssues=[];aisleOk=0;aisleWarn=0;aisleBad=0;
  corridors=[];corridorSeen={};
  racksInSel=R.filter(function(r){var rp=rpx(r);return getIntersectArea(selX1,selY1,selX2,selY2,r.x,r.y,r.x+rp.w,r.y+rp.h)>0;});
  // 1) 영역명(r.a) 기준 그룹화 → 바운딩박스 계산
  var SKIP_NAMES=['DOOR','PILLAR','WALL','CONV','TBL','DESK','EQUIP','PLT'];
  var rackGroups={};
  racksInSel.forEach(function(r){
    if(r.t==='custom')return;
    var skip=false;SKIP_NAMES.forEach(function(sk){if(r.a.toUpperCase().indexOf(sk)>=0)skip=true;});
    if(skip)return;
    var rp=rpx(r);
    if(!rackGroups[r.a])rackGroups[r.a]={x1:Infinity,y1:Infinity,x2:-Infinity,y2:-Infinity,s:r.s};
    var g=rackGroups[r.a];
    g.x1=Math.min(g.x1,r.x);g.y1=Math.min(g.y1,r.y);
    g.x2=Math.max(g.x2,r.x+rp.w);g.y2=Math.max(g.y2,r.y+rp.h);
  });
  // 2) 공간 근접 기반 서브그룹 분리 + 최근접 이웃 통로
  // 같은 이름이지만 떨어진 랙은 별도 서브그룹으로 분리
  var subGroups=[];
  Object.keys(rackGroups).forEach(function(name){
    var racks=racksInSel.filter(function(r){return r.a===name&&r.t!=='custom'});
    if(!racks.length)return;
    var skip=false;SKIP_NAMES.forEach(function(sk){if(name.toUpperCase().indexOf(sk)>=0)skip=true;});
    if(skip)return;
    // Y좌표로 정렬 후 큰 간격에서 분리
    racks.sort(function(a,b){return a.y-b.y;});
    var clusters=[],cur=[racks[0]];
    for(var ri=1;ri<racks.length;ri++){
      var prev=cur[cur.length-1],rp=rpx(prev);
      var gap=(racks[ri].y-(prev.y+rp.h))/S;
      if(gap>2000){// 2m 이상 떨어지면 별도 클러스터
        clusters.push(cur);cur=[racks[ri]];
      }else{cur.push(racks[ri]);}
    }
    clusters.push(cur);
    clusters.forEach(function(cl,ci){
      var sg={name:name+(clusters.length>1?'_'+(ci+1):''),s:cl[0].s,x1:Infinity,y1:Infinity,x2:-Infinity,y2:-Infinity};
      cl.forEach(function(r){var rp=rpx(r);sg.x1=Math.min(sg.x1,r.x);sg.y1=Math.min(sg.y1,r.y);sg.x2=Math.max(sg.x2,r.x+rp.w);sg.y2=Math.max(sg.y2,r.y+rp.h);});
      subGroups.push(sg);
    });
  });
  // 존(Zone)도 경계로 포함 (제외 존 제외)
  zones.forEach(function(z){
    if(z.excl)return;
    var zx1=BX+z.x,zy1=BY+z.y,zx2=BX+z.x+z.w,zy2=BY+z.y+z.h;
    var ov=getIntersectArea(selX1,selY1,selX2,selY2,zx1,zy1,zx2,zy2);
    if(ov>0)subGroups.push({name:z.n,s:'zone',x1:zx1,y1:zy1,x2:zx2,y2:zy2});
  });
  // 각 서브그룹에서 4방향(상하좌우) 최근접 이웃 찾기
  var pairSeen={};
  subGroups.forEach(function(sg){
    // 오른쪽 최근접
    var bestR=null,bestRd=Infinity;
    subGroups.forEach(function(nb){
      if(nb===sg||nb.name===sg.name)return;
      var yOv=Math.min(sg.y2,nb.y2)-Math.max(sg.y1,nb.y1);
      if(yOv<=0)return;
      if(nb.x1>=sg.x2){var d=(nb.x1-sg.x2)/S;if(d<bestRd){bestRd=d;bestR=nb;}}
    });
    if(bestR&&bestRd>GROUP_THRESH){
      var key=[sg.name,bestR.name].sort().join('_X_');
      if(!pairSeen[key]){pairSeen[key]=true;
        var my1=Math.max(sg.y1,bestR.y1),my2=Math.min(sg.y2,bestR.y2);
        var st=bestRd<MIN_AISLE*0.95?'bad':(bestRd<OPT_AISLE?'warn':'ok');
        if(sg.s==='zone'&&bestR.s==='zone')st='ok';
        if(st==='bad')aisleBad++;else if(st==='warn')aisleWarn++;else aisleOk++;
        if(st!=='ok')aisleIssues.push({type:st,gap:Math.round(bestRd),dir:'X',a:sg.name,b:bestR.name,ra:{x:sg.x1,y:sg.y1,w:sg.x2-sg.x1,h:sg.y2-sg.y1},rb:{x:bestR.x1,y:bestR.y1,w:bestR.x2-bestR.x1,h:bestR.y2-bestR.y1}});
        corridors.push({x:sg.x2,y:my1,w:bestR.x1-sg.x2,h:my2-my1,gapMM:Math.round(bestRd),dir:'X',status:st,la:sg.name,lb:bestR.name});
      }
    }
    // 아래쪽 최근접
    var bestB=null,bestBd=Infinity;
    subGroups.forEach(function(nb){
      if(nb===sg||nb.name===sg.name)return;
      var xOv=Math.min(sg.x2,nb.x2)-Math.max(sg.x1,nb.x1);
      if(xOv<=0)return;
      if(nb.y1>=sg.y2){var d=(nb.y1-sg.y2)/S;if(d<bestBd){bestBd=d;bestB=nb;}}
    });
    if(bestB&&bestBd>GROUP_THRESH){
      var key=[sg.name,bestB.name].sort().join('_Y_');
      if(!pairSeen[key]){pairSeen[key]=true;
        var mx1=Math.max(sg.x1,bestB.x1),mx2=Math.min(sg.x2,bestB.x2);
        var st=bestBd<MIN_AISLE*0.95?'bad':'ok';
        if(sg.s==='zone'&&bestB.s==='zone')st='ok';
        if(st==='bad')aisleBad++;else aisleOk++;
        if(st!=='ok')aisleIssues.push({type:st,gap:Math.round(bestBd),dir:'Y',a:sg.name,b:bestB.name,ra:{x:sg.x1,y:sg.y1,w:sg.x2-sg.x1,h:sg.y2-sg.y1},rb:{x:bestB.x1,y:bestB.y1,w:bestB.x2-bestB.x1,h:bestB.y2-bestB.y1}});
        corridors.push({x:mx1,y:sg.y2,w:mx2-mx1,h:bestB.y1-sg.y2,gapMM:Math.round(bestBd),dir:'Y',status:st,la:sg.name,lb:bestB.name});
      }
    }
  });
  // 통로 결과 DOM 생성
  var aisleEl=document.getElementById('sp-aisle-result');
  if(aisleEl){
    aisleEl.innerHTML='';
    if(racksInSel.length===0){
      var d=document.createElement('div');d.className='sp-tip';d.textContent='선택 영역 내 랙이 없습니다';aisleEl.appendChild(d);
    }else{
      if(aisleBad>0){
        var hdr=document.createElement('div');hdr.className='sp-aisle sp-aisle-bad sp-collapsible';
        hdr.textContent='🚨 위험 '+aisleBad+'곳 최소(1m) 미달 — 클릭 상세';
        hdr.style.cursor='pointer';
        var list=document.createElement('div');list.className='sp-collapse-body hidden';list.id='aisle-bad-list';
        hdr.onclick=function(){spToggleSection('aisle-bad-list');};
        aisleEl.appendChild(hdr);
        aisleIssues.filter(function(it){return it.type==='bad';}).sort(function(a,b){return a.gap-b.gap;}).forEach(function(it){
          var item=document.createElement('div');item.className='sp-issue-item sp-aisle-bad';
          item.innerHTML='<b>'+it.a+'</b> ↔ <b>'+it.b+'</b>: <span style="color:#f87171;font-weight:700">'+(it.gap/1000).toFixed(2)+'m</span> <span style="color:#6b7280;font-size:9px">(클릭: 위치 보기)</span>';
          item.onclick=function(d){return function(){spHighlightAisle(d);};}(it);
          list.appendChild(item);
        });
        aisleEl.appendChild(list);
      }
      if(aisleWarn>0){
        var hdr2=document.createElement('div');hdr2.className='sp-aisle sp-aisle-warn sp-collapsible';
        hdr2.textContent='⚠️ 주의 '+aisleWarn+'곳 권장(1.5m) 미달 — 클릭 상세';
        hdr2.style.cursor='pointer';
        var list2=document.createElement('div');list2.className='sp-collapse-body hidden';list2.id='aisle-warn-list';
        hdr2.onclick=function(){spToggleSection('aisle-warn-list');};
        aisleEl.appendChild(hdr2);
        aisleIssues.filter(function(it){return it.type==='warn';}).sort(function(a,b){return a.gap-b.gap;}).slice(0,20).forEach(function(it){
          var item=document.createElement('div');item.className='sp-issue-item sp-aisle-warn';
          item.innerHTML='<b>'+it.a+'</b> ↔ <b>'+it.b+'</b>: <span style="color:#fbbf24;font-weight:700">'+(it.gap/1000).toFixed(2)+'m</span> <span style="color:#6b7280;font-size:9px">(클릭: 위치 보기)</span>';
          item.onclick=function(d){return function(){spHighlightAisle(d);};}(it);
          list2.appendChild(item);
        });
        aisleEl.appendChild(list2);
      }
      if(aisleOk>0){var ok=document.createElement('div');ok.className='sp-aisle sp-aisle-ok';ok.textContent='✅ 적정 '+aisleOk+'곳 1.3m 이상';aisleEl.appendChild(ok);}
    }
    // 전체 통로 면적
    var totalCorridorM2=Math.max(0,selM2-rackM2-zoneM2-exclM2);
    var totalCorridorPct=selM2>0?(totalCorridorM2/selM2*100):0;
    var tcDiv=document.createElement('div');
    tcDiv.style.cssText='margin-top:8px;padding:6px 8px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.15);border-radius:4px';
    tcDiv.innerHTML='<div style="font-size:10px;font-weight:700;color:#a78bfa;margin-bottom:3px">\ud83d\udcca \uc804\uccb4 \ud1b5\ub85c \uba74\uc801</div>'
      +'<div style="font-size:10px;color:#cbd5e1">\ubc30\uce58\ub3c4 \ub0b4 \ubaa8\ub4e0 \ubc30\uce58 \uc694\uc18c(\ub799, \uad6c\uc5ed, \uc81c\uc678 \uc601\uc5ed) \uc81c\uc678</div>'
      +'<div style="font-size:12px;color:#a78bfa;font-weight:700;margin:3px 0"><b>'+totalCorridorM2.toFixed(1)+'m\u00b2</b> <span style="font-size:10px;font-weight:400;color:#94a3b8">('+totalCorridorPct.toFixed(1)+'%)</span></div>'
      +'<div style="font-size:9px;color:#64748b">\u2192 \uc804\uccb4 \ud1b5\ub85c \ubc84\ud2bc\uc73c\ub85c \ubc30\uce58\ub3c4\uc5d0\uc11c \uc2dc\uac01\uc801 \ud655\uc778 \uac00\ub2a5</div>';
    aisleEl.appendChild(tcDiv);
  }

  // 통로 상세 목록 (corridor 감지 후 실행)
  var aisleDetailEl=document.getElementById('sp-aisle-detail');
  if(aisleDetailEl){
    aisleDetailEl.innerHTML='';
    var seen2={};var uniqCorr=corridors.filter(function(c){
      var k=c.x+'_'+c.y+'_'+c.w+'_'+c.h;if(seen2[k])return false;seen2[k]=true;return true;
    }).sort(function(a,b){return (a.dir==='X'?0:1)-(b.dir==='X'?0:1)||a.gapMM-b.gapMM;});
    uniqCorr.forEach(function(cor,ci){
      var row=document.createElement('div');
      row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:3px 4px;margin:2px 0;border-radius:3px;cursor:pointer';
      var icon=cor.status==='bad'?'\ud83d\udea8':cor.status==='warn'?'\u26a0\ufe0f':'\u2705';
      var col=cor.status==='bad'?'rgba(239,68,68,.1)':cor.status==='warn'?'rgba(245,158,11,.1)':'rgba(6,182,212,.08)';
      var tcol=cor.status==='bad'?'#f87171':cor.status==='warn'?'#fbbf24':'#67e8f9';
      row.style.background=col;
      var dirLabel=cor.dir==='X'?'\uac00\ub85c':'\uc138\ub85c';
      var areaM2c=(cor.w/S/1000)*(cor.h/S/1000);
      var nm=document.createElement('span');
      nm.style.cssText='color:'+tcol+';font-size:10px';
      nm.textContent=icon+' '+cor.la+'\u2194'+cor.lb+' ('+dirLabel+')';
      var info=document.createElement('span');
      info.style.cssText='color:#94a3b8;font-size:10px;text-align:right';
      info.textContent=(cor.gapMM/1000).toFixed(2)+'m \u00b7 '+areaM2c.toFixed(1)+'m\u00b2';
      row.appendChild(nm);row.appendChild(info);
      row.title='\ud074\ub9ad: \uc704\uce58 \ubcf4\uae30';
      row.onclick=(function(c2){return function(){
        if(spOvMode!==1){setOvMode(1);}
        CA.scrollLeft=(c2.x+c2.w/2)*Z-CA.clientWidth/2;
        CA.scrollTop=(c2.y+c2.h/2)*Z-CA.clientHeight/2;
      };})(cor);
      aisleDetailEl.appendChild(row);
    });
    if(!aisleDetailEl.children.length)aisleDetailEl.innerHTML='<span style="color:#475569">\uac10\uc9c0\ub41c \ud1b5\ub85c \uc5c6\uc74c</span>';
    if(unusedM2>1){
      var sep=document.createElement('div');
      sep.style.cssText='border-top:1px solid #1e293b;margin:4px 0;padding-top:4px;color:#94a3b8;font-size:9px';
      sep.textContent='\ubbf8\ud65c\uc6a9: ~'+unusedM2.toFixed(1)+'m\u00b2';
      aisleDetailEl.appendChild(sep);
    }
  }

  // ── 3단계: AI 분석 + 개선 포인트 ──
  var tips=[],score=100,sDet=[];
  if(utilPct<20){tips.push({t:'bad',msg:'\ud83c\udfdc\ufe0f \uacf5\uac04 \ud65c\uc6a9\ub3c4 \ub9e4\uc6b0 \ub0ae\uc74c ('+utilPct.toFixed(1)+'%)'});score-=30;sDet.push({d:-30,r:'\ud65c\uc6a9\ub960 20% \ubbf8\ub9cc'});}
  else if(utilPct<40){tips.push({t:'warn',msg:'\u26a0\ufe0f \uacf5\uac04 \ud65c\uc6a9\ub3c4 \ub0ae\uc74c ('+utilPct.toFixed(1)+'%)'});score-=15;sDet.push({d:-15,r:'\ud65c\uc6a9\ub960 40% \ubbf8\ub9cc'});}
  else if(utilPct>90){tips.push({t:'bad',msg:'\ud83d\udea8 \uacf5\uac04 \uacfc\ubc00 ('+utilPct.toFixed(1)+'%)'});score-=25;sDet.push({d:-25,r:'\ud65c\uc6a9\ub960 90% \ucd08\uacfc: \uacfc\ubc00'});}
  else if(utilPct>80){tips.push({t:'warn',msg:'\u26a0\ufe0f \uacf5\uac04 \ud3ec\ud654 \uc811\uadfc ('+utilPct.toFixed(1)+'%)'});score-=10;sDet.push({d:-10,r:'\ud65c\uc6a9\ub960 80% \ucd08\uacfc'});}
  else if(utilPct>70){tips.push({t:'ok',msg:'\u2705 \uacf5\uac04 \ud65c\uc6a9\ub3c4 \ub2e4\uc18c \ub192\uc74c ('+utilPct.toFixed(1)+'%)'});score-=5;sDet.push({d:-5,r:'\ud65c\uc6a9\ub960 70~80%: \ud3ec\ud654 \uc811\uadfc \uad6c\uac04'});}
  else if(utilPct>=55){tips.push({t:'ok',msg:'\u2705 \uacf5\uac04 \ud65c\uc6a9\ub3c4 \ucd5c\uc801 ('+utilPct.toFixed(1)+'%)'});sDet.push({d:0,r:'\ud65c\uc6a9\ub960 55~70%: \ubc30\uce58\uc640 \ub3d9\uc120 \uade0\ud615 \ucd5c\uc801'});}
  else{tips.push({t:'ok',msg:'\u2705 \uacf5\uac04 \ud65c\uc6a9\ub3c4 \ub2e4\uc18c \ub0ae\uc74c ('+utilPct.toFixed(1)+'%)'});score-=5;sDet.push({d:-5,r:'\ud65c\uc6a9\ub960 40~55%: \uc5ec\uc720 \uc788\uc73c\ub098 \ud65c\uc6a9 \uac00\ub2a5'});}
  if(aisleBad>0){tips.push({t:'bad',msg:'\ud83d\udea8 \ucd5c\uc18c \ud1b5\ub85c(1m) \ubbf8\ub2ec '+aisleBad+'\uacf3',action:'aisle-bad-list'});score-=25;sDet.push({d:-25,r:'\uc548\uc804\uac70\ub9ac(1m) \ubbf8\ub2ec '+aisleBad+'\uacf3'});}
  if(aisleWarn>0){tips.push({t:'warn',msg:'\u26a0\ufe0f \uad8c\uc7a5 \ud1b5\ub85c(1.3m) \ubbf8\ub2ec '+aisleWarn+'\uacf3',action:'aisle-warn-list'});score-=10;sDet.push({d:-10,r:'\uad8c\uc7a5\uac70\ub9ac(1.3m) \ubbf8\ub2ec '+aisleWarn+'\uacf3'});}
  if(aisleBad===0&&aisleWarn===0&&aisleOk>0){sDet.push({d:0,r:'\ubaa8\ub4e0 \ud1b5\ub85c('+aisleOk+'\uacf3) \uae30\uc900 \ucda9\uc871'});}
  if(rackPct>50){tips.push({t:'warn',msg:'\ud83d\udce6 \ub799 \uc810\uc720\uc728 \uacfc\ub2e4 ('+rackPct.toFixed(1)+'%)'});score-=10;sDet.push({d:-10,r:'\ub799 \uc810\uc720 50% \ucd08\uacfc'});}
  else if(rackPct>0&&rackPct<10){tips.push({t:'ok',msg:'\ud83d\udce6 \ub799 \uc810\uc720\uc728 \uc5ec\uc720 ('+rackPct.toFixed(1)+'%)'});sDet.push({d:0,r:'\ub799 \uc810\uc720\uc728 \ub0ae\uc74c'});}
  else if(rackPct>=10){sDet.push({d:0,r:'\ub799 \uc810\uc720\uc728 '+rackPct.toFixed(1)+'%: \uc801\uc815'});}
  if(exclPct>20){tips.push({t:'warn',msg:'\u2b1b \uc81c\uc678 \uc601\uc5ed('+exclPct.toFixed(1)+'%) \ud070'});score-=5;sDet.push({d:-5,r:'\uc81c\uc678 \uc601\uc5ed 20% \ucd08\uacfc'});}
  score=Math.max(0,score);
  var scoreClass=score>=80?'sp-badge-ok':score>=60?'sp-badge-warn':'sp-badge-bad';
  var tipsEl=document.getElementById('sp-tips');
  if(tipsEl){
    tipsEl.innerHTML='';
    // 종합 점수
    var sRow=document.createElement('div');sRow.className='sp-row';sRow.style.marginBottom='6px';
    sRow.innerHTML='<span>\uc885\ud569 \uc810\uc218</span><span class="sp-badge '+scoreClass+'" style="font-size:13px">'+score+'\uc810</span>';
    tipsEl.appendChild(sRow);
    // 점수 근거 토글
    var sToggle=document.createElement('div');
    sToggle.style.cssText='font-size:9px;color:#67e8f9;cursor:pointer;margin:4px 0;user-select:none';
    sToggle.textContent='\ud83d\udcca \uc810\uc218 \uc0b0\ucd9c \uadfc\uac70 \u25b8';
    var sBody=document.createElement('div');
    sBody.style.cssText='display:none;margin:4px 0 8px;padding:6px;background:rgba(15,23,42,.6);border-radius:4px;border:1px solid #1e293b';
    var sHtml='<div style="font-size:9px;color:#94a3b8;margin-bottom:6px">\uae30\uc900: 100\uc810 \ub9cc\uc810 (\uac10\uc810 \ubc29\uc2dd) \u2014 \uc77c\ubc18\uc801\uc778 \ucc3d\uace0 \uc6b4\uc601 \uac00\uc774\ub4dc\ub77c\uc778 \uae30\ubc18</div>';
    sHtml+='<div style="margin-bottom:6px;padding:4px 6px;background:rgba(30,41,59,.5);border-radius:3px;border:1px solid #1e293b">';
    sHtml+='<div style="font-size:8px;color:#64748b;margin-bottom:3px">\u25b6 \uacf5\uac04 \ud65c\uc6a9\ub960 \ud3c9\uac00 \uae30\uc900</div>';
    var curIdx=utilPct<20?0:utilPct<40?1:utilPct<55?2:utilPct<=70?3:utilPct<=80?4:utilPct<=90?5:6;
    [{r:'20% \ubbf8\ub9cc',s:'\ub9e4\uc6b0 \ub0ae\uc74c',d:'-30',c:'#f87171'},{r:'20~40%',s:'\ub0ae\uc74c',d:'-15',c:'#fbbf24'},{r:'40~55%',s:'\ub2e4\uc18c \ub0ae\uc74c',d:'-5',c:'#67e8f9'},{r:'55~70%',s:'\u2605 \ucd5c\uc801',d:'\u00b10',c:'#34d399'},{r:'70~80%',s:'\ub2e4\uc18c \ub192\uc74c',d:'-5',c:'#67e8f9'},{r:'80~90%',s:'\ud3ec\ud654 \uc811\uadfc',d:'-10',c:'#fbbf24'},{r:'90% \ucd08\uacfc',s:'\uacfc\ubc00',d:'-25',c:'#f87171'}].forEach(function(row,idx){
      var isCurrent=idx===curIdx;
      sHtml+='<div style="display:flex;justify-content:space-between;padding:1px 0;font-size:8px;'+(isCurrent?'background:rgba(52,211,153,.1);border-radius:2px;padding:2px 4px;':'')+'"><span style="color:#94a3b8">'+row.r+'</span><span style="color:#94a3b8">'+row.s+'</span><span style="color:'+row.c+';font-weight:700">'+row.d+'</span></div>';
    });
    sHtml+='<div style="font-size:8px;color:#475569;margin-top:2px">\ud604\uc7ac: '+utilPct.toFixed(1)+'%</div></div>';
    sHtml+='<div style="font-size:8px;color:#64748b;margin-bottom:4px">\u25b6 \uac10\uc810 \ub0b4\uc5ed</div>';
    sDet.forEach(function(sd){
      var c=sd.d===0?'#67e8f9':sd.d>=-10?'#fbbf24':'#f87171';
      sHtml+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:9px"><span style="color:#cbd5e1">'+sd.r+'</span><span style="color:'+c+';font-weight:700;white-space:nowrap;margin-left:8px">'+(sd.d===0?'\u00b10':sd.d)+'</span></div>';
    });
    sHtml+='<div style="border-top:1px solid #334155;margin-top:4px;padding-top:4px;display:flex;justify-content:space-between;font-size:10px;font-weight:700"><span style="color:#e2e8f0">\ucd5c\uc885</span><span style="color:'+(score>=80?'#34d399':score>=60?'#fbbf24':'#f87171')+'">'+score+'\uc810</span></div>';
    sBody.innerHTML=sHtml;
    sToggle.onclick=function(){var v=sBody.style.display!=='none';sBody.style.display=v?'none':'block';sToggle.textContent='\ud83d\udcca \uc810\uc218 \uc0b0\ucd9c \uadfc\uac70 '+(v?'\u25b8':'\u25be');};
    tipsEl.appendChild(sToggle);tipsEl.appendChild(sBody);
    // 개선 항목
    tips.forEach(function(tp){
      var cls=tp.t==='ok'?'sp-aisle-ok':tp.t==='warn'?'sp-aisle-warn':'sp-aisle-bad';
      var div=document.createElement('div');div.className='sp-aisle '+cls;
      div.textContent=tp.msg+(tp.action?' \u25b6 \uc0c1\uc138':'');
      if(tp.action){var act=tp.action;div.style.cursor='pointer';div.onclick=function(){spToggleSection(act);};}
      tipsEl.appendChild(div);
    });
    // ── AI 최적화 추천 ──
    var rackFp=0.81,rackWA=rackFp+0.9*1.0;
    var addEstHeavy=Math.floor(unusedM2*0.5/rackWA);
    var addEstLight=Math.floor(unusedM2*0.5/(0.9*0.45+0.45*1.0));
    var aiTgl=document.createElement('div');
    aiTgl.style.cssText='font-size:10px;color:#a78bfa;cursor:pointer;margin:10px 0 4px;font-weight:700;user-select:none;padding:5px 8px;background:rgba(139,92,246,.08);border-radius:5px;border:1px solid rgba(139,92,246,.2)';
    aiTgl.textContent='\ud83e\udd16 AI \uacf5\uac04 \ucd5c\uc801\ud654 \ucd94\ucc9c \u25b8';
    var aiBd=document.createElement('div');
    aiBd.id='sp-ai-body';
    aiBd.style.cssText='display:none;margin:4px 0;padding:8px;background:rgba(15,23,42,.7);border-radius:6px;border:1px solid rgba(139,92,246,.15);font-size:10px;color:#cbd5e1;line-height:1.6';
    aiTgl.onclick=function(){var v=aiBd.style.display!=='none';aiBd.style.display=v?'none':'block';aiTgl.textContent='\ud83e\udd16 AI \uacf5\uac04 \ucd5c\uc801\ud654 \ucd94\ucc9c '+(v?'\u25b8':'\u25be');};
    // 데이터 수집
    var seriesStats={};
    racksInSel.forEach(function(r){var k=r.s;if(!seriesStats[k])seriesStats[k]={cnt:0,nm:{}};seriesStats[k].cnt++;if(!seriesStats[k].nm[r.a])seriesStats[k].nm[r.a]=0;seriesStats[k].nm[r.a]++;});
    var SN_MAP={mx48:'RSC48',mx16:'RSC16',hsm:'HSM',semi:'Semi',spare:'SP',etc:'\uae30\ud0c0'};
    // 여유 공간 위치 탐색 — 그리드 스캔 방식
    var gapAreas=[];
    var allOccupied=[];
    racksInSel.forEach(function(r){var rp=rpx(r);allOccupied.push({x1:r.x,y1:r.y,x2:r.x+rp.w,y2:r.y+rp.h});});
    zones.forEach(function(z){var zx=BX+z.x,zy=BY+z.y;var ov=getIntersectArea(selX1,selY1,selX2,selY2,zx,zy,zx+z.w,zy+z.h);if(ov>0)allOccupied.push({x1:zx,y1:zy,x2:zx+z.w,y2:zy+z.h});});
    // 그리드 스캔: 1m(60px) 셀로 분할
    var cellSize=mm(1000);
    var cols=Math.floor((selX2-selX1)/cellSize),rows=Math.floor((selY2-selY1)/cellSize);
    // L자 건물 경계: R1(BX~BX+WHW, BY~BY+WHH) + R2(BX+WHW~982, BY+mm(12900)~BY+WHH)
    var WH_RX=982,WH_JY=BY+mm(12900);
    function isInBuilding(px,py){
      if(px>=BX&&px<BX+WHW&&py>=BY&&py<BY+WHH)return true;
      if(px>=BX+WHW&&px<WH_RX&&py>=WH_JY&&py<BY+WHH)return true;
      return false;
    }
    var grid=[];
    for(var gy=0;gy<rows;gy++){
      grid[gy]=[];
      for(var gx=0;gx<cols;gx++){
        var cx1=selX1+gx*cellSize,cy1=selY1+gy*cellSize;
        var cx2=cx1+cellSize,cy2=cy1+cellSize;
        var cMidX=(cx1+cx2)/2,cMidY=(cy1+cy2)/2;
        // 건물 외부면 점유로 표시 (빈 공간으로 잡히지 않게)
        if(!isInBuilding(cMidX,cMidY)){grid[gy][gx]=1;continue;}
        var occ=false;
        for(var oi=0;oi<allOccupied.length;oi++){
          var o=allOccupied[oi];
          if(o.x1<cx2&&o.x2>cx1&&o.y1<cy2&&o.y2>cy1){occ=true;break;}
        }
        grid[gy][gx]=occ?1:0;
      }
    }
    // 빈 셀 연결 영역 찾기 (flood fill)
    var visited=[];
    for(var gy=0;gy<rows;gy++){visited[gy]=[];for(var gx=0;gx<cols;gx++)visited[gy][gx]=false;}
    function floodFill(sy,sx){
      var cells=[],stack=[[sy,sx]];
      while(stack.length){
        var p=stack.pop();var py=p[0],px=p[1];
        if(py<0||py>=rows||px<0||px>=cols||visited[py][px]||grid[py][px])continue;
        visited[py][px]=true;cells.push(p);
        stack.push([py-1,px],[py+1,px],[py,px-1],[py,px+1]);
      }
      return cells;
    }
    for(var gy=0;gy<rows;gy++){
      for(var gx=0;gx<cols;gx++){
        if(!visited[gy][gx]&&!grid[gy][gx]){
          var cells=floodFill(gy,gx);
          if(cells.length>=2){// 최소 2m² 이상
            var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
            cells.forEach(function(c){minX=Math.min(minX,c[1]);minY=Math.min(minY,c[0]);maxX=Math.max(maxX,c[1]);maxY=Math.max(maxY,c[0]);});
            var px1=selX1+minX*cellSize,py1=selY1+minY*cellSize;
            var px2=selX1+(maxX+1)*cellSize,py2=selY1+(maxY+1)*cellSize;
            var areaM2=cells.length*(cellSize/S)*(cellSize/S)/1e6;
            var locName='';
            if(px1<selX1+(selX2-selX1)*0.3)locName+='\uc88c\uce21';
            else if(px2>selX1+(selX2-selX1)*0.7)locName+='\uc6b0\uce21';
            else locName+='\uc911\uc559';
            if(py1<selY1+(selY2-selY1)*0.3)locName+=' \uc0c1\ub2e8';
            else if(py2>selY1+(selY2-selY1)*0.7)locName+=' \ud558\ub2e8';
            else locName+=' \uc911\uac04';
            gapAreas.push({loc:locName,mm:Math.round(Math.max(px2-px1,py2-py1)/S),px1:px1,py1:py1,px2:px2,py2:py2,m2:areaM2});
          }
        }
      }
    }
    gapAreas.sort(function(a,b){return b.m2-a.m2});// 큰 영역순
    var xSR=racksInSel.filter(function(r){return r.t!=='custom'}).slice().sort(function(a,b){return a.x-b.x});
    var ySR=racksInSel.filter(function(r){return r.t!=='custom'}).slice().sort(function(a,b){return a.y-b.y});

    // AI 리포트 생성
    var ah='';
    ah+='<div style="color:#a78bfa;font-weight:700;margin-bottom:4px">\ud83d\udccb \ud604\ud669 \uc694\uc57d</div>';
    ah+='<div style="padding:4px 8px;margin-bottom:8px;background:rgba(30,41,59,.5);border-radius:4px">';
    ah+='\uc804\uccb4 <b>'+selM2.toFixed(1)+'m\u00b2</b> \u2192 \ub799 <b>'+rackM2.toFixed(1)+'m\u00b2</b>('+rackPct.toFixed(1)+'%), ';
    ah+='\uc874 <b>'+zoneM2.toFixed(1)+'m\u00b2</b>('+zonePct.toFixed(1)+'%), ';
    ah+='\ud1b5\ub85c <b>'+plannedAisleM2.toFixed(1)+'m\u00b2</b>('+aislePct.toFixed(1)+'%), ';
    ah+='\ubbf8\ud65c\uc6a9 <b style="color:#fbbf24">'+unusedM2.toFixed(1)+'m\u00b2</b>('+unusedPct.toFixed(1)+'%)</div>';
    // 랙 구성
    ah+='<div style="color:#a78bfa;font-weight:700;margin-bottom:4px">\ud83d\udce6 \ub799 \uad6c\uc131</div>';
    ah+='<div style="padding:4px 8px;margin-bottom:8px;background:rgba(30,41,59,.5);border-radius:4px">';
    Object.keys(seriesStats).forEach(function(sk){
      var s=seriesStats[sk];
      var nl=Object.keys(s.nm).map(function(n){return n+'('+s.nm[n]+')'}).join(', ');
      ah+='<div>'+(SN_MAP[sk]||sk)+': <b>'+s.cnt+'\uac1c</b> \u2014 '+nl+'</div>';
    });
    ah+='</div>';
    // 여유 공간 (클릭 가능)
    if(gapAreas.length>0){
      ah+='<div style="color:#a78bfa;font-weight:700;margin-bottom:4px">\ud83d\udccd \uc5ec\uc720 \uacf5\uac04 \uc704\uce58 <span style="color:#64748b;font-weight:400;font-size:9px">(\ud074\ub9ad \u2192 \uc704\uce58 \ud655\uc778)</span></div>';
      ah+='<div style="padding:4px 8px;margin-bottom:8px;background:rgba(30,41,59,.5);border-radius:4px">';
      gapAreas.forEach(function(g,gi){
        ah+='<div class="sp-ai-click" data-gapidx="'+gi+'" style="cursor:pointer;padding:3px 4px;margin:2px 0;border-radius:3px;border:1px solid transparent">';
        ah+='\ud83d\udfe1 <b style="color:#fbbf24">'+g.loc+'</b>: ~<b>'+g.m2.toFixed(1)+'m\u00b2</b>';
        ah+='</div>';
      });
      ah+='</div>';
    }
    // 전역 저장 (시뮬레이션용)
    _simGaps=gapAreas;_simYSR=ySR;_simUnusedM2=unusedM2;_simEstH=addEstHeavy;_simEstL=addEstLight;
    // 최적화 추천
    ah+='<div style="color:#a78bfa;font-weight:700;margin-bottom:4px">\ud83d\udca1 \ucd5c\uc801\ud654 \ucd94\ucc9c</div>';
    ah+='<div style="padding:4px 8px;background:rgba(30,41,59,.5);border-radius:4px">';
    if(addEstHeavy>0&&unusedM2>3){
      ah+='<div style="margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #1e293b">';
      ah+='<span style="color:#34d399;font-weight:700">\u25b8 \ucd94\uac00 \ubc30\uce58 \uac00\ub2a5</span>';
      ah+=' <span class="sp-sim-btn" data-action="unused" style="cursor:pointer;font-size:9px;color:#fbbf24;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);padding:1px 6px;border-radius:3px;margin-left:4px">\ud83d\udd0d \uc704\uce58 \ubcf4\uae30</span><br>';
      ah+='\ubbf8\ud65c\uc6a9 <b>'+unusedM2.toFixed(1)+'m\u00b2</b> \uc911 \ud1b5\ub85c(1m) \ud655\ubcf4 \ud6c4:<br>';
      ah+='\u2022 \uc911\ub7c9\ub799(900\u00d7900): \uc57d <b>'+addEstHeavy+'\uac1c</b><br>';
      ah+='\u2022 \uacbd\ub7c9\ub799(900\u00d7450): \uc57d <b>'+addEstLight+'\uac1c</b>';
      ah+='</div>';
    }
    // 동선 분석
    if(ySR.length>1){
      var maxYd=((ySR[ySR.length-1].y-ySR[0].y)/S/1000).toFixed(1);
      ah+='<div style="margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #1e293b">';
      ah+='<span style="color:#67e8f9;font-weight:700">\u25b8 \ub3d9\uc120 \ubd84\uc11d</span>';
      ah+=' <span class="sp-sim-btn" data-action="movement" style="cursor:pointer;font-size:9px;color:#f87171;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);padding:1px 6px;border-radius:3px;margin-left:4px">\ud83d\udd0d \ub3d9\uc120 \ubcf4\uae30</span><br>';
      ah+='\ub799 \uac04 \ucd5c\ub300 Y\ucd95 \uac70\ub9ac: <b>'+maxYd+'m</b> ('+ySR[0].a+' \u2194 '+ySR[ySR.length-1].a+')<br>';
      if(parseFloat(maxYd)>20){
        ah+='<span style="color:#fbbf24">\uad8c\uace0:</span> \uace0\ube48\ub3c4 \ucd9c\uace0 \ud488\ubaa9\uc744 \ucd9c\uc785\uad6c \uc778\uadfc(\ud558\ub2e8)\uc5d0, \uc800\ube48\ub3c4 \ud488\ubaa9\uc744 \uc0c1\ub2e8\uc5d0 \ubc30\uce58';
      }else if(parseFloat(maxYd)>15){ah+='\ub3d9\uc120\uc774 \ub2e4\uc18c \uae34 \ud3b8. \ucd9c\uace0 \ube48\ub3c4\uc5d0 \ub530\ub978 \ub799 \ubc30\uce58 \uc21c\uc11c \uac80\ud1a0';}
      else{ah+='\ub3d9\uc120 \uae38\uc774 \uc801\uc815 \ubc94\uc704';}
      ah+='</div>';
    }
    // 신모델 런칭 대응
    if(unusedM2>5){
      ah+='<div style="margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #1e293b">';
      ah+='<span style="color:#67e8f9;font-weight:700">\u25b8 \uc2e0\ubaa8\ub378 \ub7f0\uce6d \ub300\uc751</span><br>';
      ah+='\ubbf8\ud65c\uc6a9 <b>'+unusedM2.toFixed(1)+'m\u00b2</b> \uae30\uc900 \uc2dc\ubbac\ub808\uc774\uc158:<br>';
      ah+='<div style="display:flex;gap:4px;margin:6px 0">';
      ah+='<span class="sp-sim-btn" data-action="simA" style="cursor:pointer;flex:1;text-align:center;font-size:9px;font-weight:700;color:#34d399;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.3);padding:4px 2px;border-radius:4px">A: \uacbd\ub7c9 '+addEstLight+'\uac1c<br>\ubbf8\ub9ac\ubcf4\uae30</span>';
      ah+='<span class="sp-sim-btn" data-action="simB" style="cursor:pointer;flex:1;text-align:center;font-size:9px;font-weight:700;color:#60a5fa;background:rgba(96,165,250,.08);border:1px solid rgba(96,165,250,.3);padding:4px 2px;border-radius:4px">B: \uc911\ub7c9 '+addEstHeavy+'\uac1c<br>\ubbf8\ub9ac\ubcf4\uae30</span>';
      var mixH=Math.floor(addEstHeavy*0.5),mixL=Math.floor(addEstLight*0.5);
      ah+='<span class="sp-sim-btn" data-action="simC" style="cursor:pointer;flex:1;text-align:center;font-size:9px;font-weight:700;color:#fbbf24;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.3);padding:4px 2px;border-radius:4px">C: \ud63c\ud569<br>\ubbf8\ub9ac\ubcf4\uae30</span>';
      ah+='</div>';
      ah+='<span style="color:#94a3b8;font-size:9px">\u203b \ud3b8\uce21 \ud1b5\ub85c 1m \ud655\ubcf4 \uae30\uc900. \ud074\ub9ad\ud558\uba74 \ubc30\uce58\ub3c4\uc5d0 \ubc18\ud22c\uba85 \uac00\uc0c1 \ub799 \ud45c\uc2dc</span>';
      ah+='</div>';
    }
    // 종합 의견
    ah+='<div style="border-top:1px solid #334155;margin-top:6px;padding-top:6px;color:#e2e8f0">';
    if(score>=90){ah+='<b style="color:#34d399">\uc885\ud569 \uc758\uacac:</b> \ud604\uc7ac \ubc30\uce58\uac00 \ub9e4\uc6b0 \ud6a8\uc728\uc801\uc785\ub2c8\ub2e4. \ud1b5\ub85c\u00b7\ub799\u00b7\uc874\uc758 \uade0\ud615\uc774 \uc798 \uc7a1\ud600 \uc788\uc2b5\ub2c8\ub2e4.';}
    else if(score>=70){ah+='<b style="color:#34d399">\uc885\ud569 \uc758\uacac:</b> \uc804\ubc18\uc801\uc73c\ub85c \uc591\ud638\ud55c \ubc30\uce58\uc785\ub2c8\ub2e4.';if(unusedM2>10)ah+=' \ubbf8\ud65c\uc6a9 \uacf5\uac04 \ud65c\uc6a9 \uc5ec\uc9c0 \uc788\uc74c.';if(aisleBad>0)ah+=' \uc704\ud5d8 \ud1b5\ub85c '+aisleBad+'\uacf3 \uac1c\uc120 \ud544\uc694.';}
    else if(score>=50){ah+='<b style="color:#fbbf24">\uc885\ud569 \uc758\uacac:</b> \uac1c\uc120 \ud544\uc694. \ud1b5\ub85c \uc548\uc804 \ud655\ubcf4\uc640 \uacf5\uac04 \uc7ac\ubc30\uce58 \uac80\ud1a0.';}
    else{ah+='<b style="color:#f87171">\uc885\ud569 \uc758\uacac:</b> \ubc30\uce58 \uc7ac\uc124\uacc4 \uad8c\uace0.';}
    ah+='</div></div>';
    aiBd.innerHTML=ah;
    // 클릭 이벤트 바인딩
    aiBd.querySelectorAll('.sp-ai-click').forEach(function(el){
      el.addEventListener('click',function(){
        var gidx=parseInt(el.getAttribute('data-gapidx'));
        var g=gapAreas[gidx];
        if(g)spHighlightArea(g.px1,g.py1,g.px2,g.py2,g.loc+' ~'+g.m2.toFixed(1)+'m\u00b2','rgba(251,191,36,.12)');
      });
    });
    // 시뮬레이션 버튼 바인딩
    aiBd.querySelectorAll('.sp-sim-btn').forEach(function(el){
      el.addEventListener('click',function(){
        var act=el.getAttribute('data-action');
        if(act==='unused')spShowUnused();
        else if(act==='movement')spShowMovement();
        else if(act==='simA')spSimulate('A');
        else if(act==='simB')spSimulate('B');
        else if(act==='simC')spSimulate('C');
      });
    });
    tipsEl.appendChild(aiTgl);tipsEl.appendChild(aiBd);
  }
  var now=new Date();
  var ue=document.getElementById('sp-updated');
  if(ue)ue.textContent=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')+':'+now.getSeconds().toString().padStart(2,'0');
  // 통로 오버레이 렌더링 (분석 완료 후)
  try{renderCorridorOverlay(corridors);}catch(ex){}


}
// ── 시뮬레이션 함수들 ──
var _simGaps=[],_simYSR=[],_simUnusedM2=0,_simEstH=0,_simEstL=0;
function spClearSim(){
  document.querySelectorAll('.sp-sim,.sp-sim-arrow,.sp-sim-ghost').forEach(function(e){e.parentNode&&e.parentNode.removeChild(e);});
  // 기존 요소 복원
  document.querySelectorAll('.rk,.zone,.txl').forEach(function(e){e.style.opacity='';e.style.filter='';});
  CV.style.background='';
}
function spShowUnused(){
  spClearSim();
  // 기존 요소 반투명
  document.querySelectorAll('.rk,.zone,.txl').forEach(function(e){e.style.opacity='0.15';e.style.filter='grayscale(1)';});
  if(!_simGaps.length){
    // gapAreas가 비어있으면 간단한 안내
    var lbl=document.createElement('div');lbl.className='sp-sim';
    lbl.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:300;background:rgba(15,23,42,.95);border:1px solid #fbbf24;color:#fbbf24;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;pointer-events:auto;cursor:pointer';
    lbl.textContent='\ubbf8\ud65c\uc6a9 \uacf5\uac04\uc774 \ub791/\uc874 \uc0ac\uc774\uc5d0 \ubd84\uc0b0\ub418\uc5b4 \uc788\uc2b5\ub2c8\ub2e4 (\ud074\ub9ad: \ub2eb\uae30)';
    lbl.onclick=spClearSim;document.body.appendChild(lbl);
    setTimeout(spClearSim,4000);return;
  }
  _simGaps.forEach(function(g){
    var ov=document.createElement('div');ov.className='sp-sim';
    var m2=g.m2?g.m2.toFixed(1):((g.px2-g.px1)/S*(g.py2-g.py1)/S/1e6).toFixed(1);
    ov.style.cssText='position:absolute;z-index:17;pointer-events:none;border-radius:4px;left:'+g.px1+'px;top:'+g.py1+'px;width:'+(g.px2-g.px1)+'px;height:'+(g.py2-g.py1)+'px;background:rgba(251,191,36,.15);border:2px dashed rgba(251,191,36,.5);animation:spPulse 1.5s infinite alternate';
    var lbl=document.createElement('div');
    lbl.style.cssText='position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;font-weight:700;color:#fbbf24;text-shadow:0 1px 3px rgba(0,0,0,.9);background:rgba(15,23,42,.85);padding:2px 8px;border-radius:4px;white-space:nowrap';
    lbl.textContent=g.loc+' ~'+m2+'m\u00b2';
    ov.appendChild(lbl);CV.appendChild(ov);
  });
  if(_simGaps.length>0){CA.scrollLeft=(_simGaps[0].px1)*Z-CA.clientWidth/2;CA.scrollTop=(_simGaps[0].py1)*Z-CA.clientHeight/2;}
  setTimeout(spClearSim,6000);
}
function spShowMovement(){
  spClearSim();
  document.querySelectorAll('.rk,.zone,.txl').forEach(function(e){e.style.opacity='0.15';e.style.filter='grayscale(1)';});
  if(_simYSR.length<2)return;
  var top=_simYSR[0],bot=_simYSR[_simYSR.length-1],rpT=rpx(top),rpB=rpx(bot);
  var x1=top.x+rpT.w/2,y1=top.y+rpT.h/2,x2=bot.x+rpB.w/2,y2=bot.y+rpB.h/2;
  var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('class','sp-sim-arrow');
  svg.style.cssText='position:absolute;left:0;top:0;width:'+CW+'px;height:'+CH+'px;z-index:17;pointer-events:none';
  svg.innerHTML='<defs><marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#f87171"/></marker><marker id="ah2" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto"><polygon points="8 0, 0 3, 8 6" fill="#f87171"/></marker></defs>'
    +'<line x1="'+x1+'" y1="'+y1+'" x2="'+x2+'" y2="'+y2+'" stroke="#f87171" stroke-width="2" stroke-dasharray="8,4" marker-end="url(#ah)" marker-start="url(#ah2)"/>';
  var midY=(y1+y2)/2,dist=(Math.abs(y2-y1)/S/1000).toFixed(1);
  svg.innerHTML+='<rect x="'+(x1-40)+'" y="'+(midY-10)+'" width="80" height="20" rx="4" fill="rgba(15,23,42,.9)" stroke="#f87171" stroke-width="1"/>'
    +'<text x="'+x1+'" y="'+(midY+4)+'" text-anchor="middle" fill="#f87171" font-size="11" font-weight="700" font-family="monospace">'+dist+'m</text>';
  CV.appendChild(svg);
  // 상/하단 랙 하이라이트
  [{r:top,rp:rpT,l:'\uc0c1\ub2e8'},{r:bot,rp:rpB,l:'\ud558\ub2e8'}].forEach(function(d){
    var ov=document.createElement('div');ov.className='sp-sim';
    ov.style.cssText='position:absolute;z-index:17;pointer-events:none;left:'+d.r.x+'px;top:'+d.r.y+'px;width:'+d.rp.w+'px;height:'+d.rp.h+'px;border:3px solid #f87171;border-radius:4px;background:rgba(239,68,68,.15)';
    var bl=document.createElement('div');bl.style.cssText='position:absolute;top:-16px;left:0;font-size:9px;color:#f87171;font-weight:700;background:rgba(15,23,42,.85);padding:1px 5px;border-radius:3px';
    bl.textContent=d.l+' '+d.r.a;ov.appendChild(bl);CV.appendChild(ov);
  });
  CA.scrollLeft=x1*Z-CA.clientWidth/2;CA.scrollTop=(y1)*Z-100;
  setTimeout(spClearSim,8000);
}
function spSimulate(opt){
  spClearSim();
  // 기존 랙/존을 거의 안 보이게 처리
  document.querySelectorAll('.rk,.zone,.txl').forEach(function(e){e.style.opacity='0.08';e.style.filter='grayscale(1)';});
  CV.style.background='rgba(15,23,42,.95)';
  // ── 고정/이동 기준 ──
  var FIXED_ZONES=['Packaging Foam','Spare Part Box','Yellow Box','8160 Area','Test Area','Final QC Area','Defect Area'];
  function isFixedZone(z){for(var i=0;i<FIXED_ZONES.length;i++){if(z.n===FIXED_ZONES[i])return true;}if(z.excl)return true;return false;}
  function isFixedRack(r){var nm=r.a.toUpperCase();if(nm.indexOf('DOOR')>=0||nm.indexOf('PILLAR')>=0)return true;if(r.a.indexOf('\uae30\ub465')>=0)return true;return false;}

  // 1) 이동 가능 항목 수집 — 모든 랙 + 모든 이동 존 확실히 수집
  var existingRacks=[];
  var collectLog={racks:0,zones:0,custom:0,fixed:0,skippedRacks:[],skippedZones:[]};
  R.forEach(function(r){
    if(isFixedRack(r)){collectLog.fixed++;collectLog.skippedRacks.push(r.a+' (\uace0\uc815)');return;}
    var rp=rpx(r);
    existingRacks.push({a:r.a,s:r.s,t:r.t,w:rp.w,h:rp.h,col:r.s});
    collectLog.racks++;
  });
  // 이동 가능 존도 배치 대상에 추가
  zones.forEach(function(z){
    if(isFixedZone(z)){collectLog.fixed++;collectLog.skippedZones.push(z.n+' (\uace0\uc815)');return;}
    existingRacks.push({a:z.n,s:'zone',t:'zone',w:z.w,h:z.h,col:'zone'});
    collectLog.zones++;
  });
  console.log('[SIM] \uc218\uc9d1: \ub799 '+collectLog.racks+'\uac1c, \uc874 '+collectLog.zones+'\uac1c, \uace0\uc815 '+collectLog.fixed+'\uac1c');
  console.log('[SIM] \uace0\uc815 \ub799:', collectLog.skippedRacks);
  console.log('[SIM] \uace0\uc815 \uc874:', collectLog.skippedZones);
  console.log('[SIM] \uc774\ub3d9 \ud56d\ubaa9:', existingRacks.map(function(r){return r.a}).join(', '));

  // 2) 신규 랙 추가
  var newCnt=0,newW,newH,newSeries;
  if(opt==='A'){newCnt=_simEstL;newW=mm(900);newH=mm(450);newSeries='mx16';}
  else if(opt==='B'){newCnt=_simEstH;newW=mm(900);newH=mm(900);newSeries='mx48';}
  else{
    var hCnt=Math.floor(_simEstH*0.5),lCnt=Math.floor(_simEstL*0.5);
    for(var ni=0;ni<hCnt;ni++)existingRacks.push({a:'NEW',s:'mx48',t:'heavy',w:mm(900),h:mm(900),col:'mx48',isNew:true});
    for(var ni=0;ni<lCnt;ni++)existingRacks.push({a:'NEW',s:'mx16',t:'light',w:mm(900),h:mm(450),col:'mx16',isNew:true});
    newCnt=0;
  }
  for(var ni=0;ni<newCnt;ni++)existingRacks.push({a:'NEW',s:newSeries,t:newSeries==='mx48'?'heavy':'light',w:newW,h:newH,col:newSeries,isNew:true});

  // 3) 고정 장애물 = 이동 불가 존 + 이동 불가 랙
  var obstacles=[];
  zones.forEach(function(z){if(isFixedZone(z))obstacles.push({x:BX+z.x,y:BY+z.y,w:z.w,h:z.h,n:z.n});});
  R.forEach(function(r){if(isFixedRack(r)){var rp=rpx(r);obstacles.push({x:r.x,y:r.y,w:rp.w,h:rp.h,n:r.a});}});
  // Spare Part Box / Packaging Foam: 오른쪽 2m 불출 클리어
  zones.forEach(function(z){
    if(z.n!=='Spare Part Box'&&z.n!=='Packaging Foam')return;
    obstacles.push({x:BX+z.x+z.w,y:BY+z.y,w:mm(2000),h:z.h,n:z.n+' \ubd88\ucd9c'});
  });
  // 8160 Area 출입구 (아래 2m)
  zones.forEach(function(z){
    if(z.n.indexOf('8160')<0)return;
    obstacles.push({x:BX+z.x,y:BY+z.y+z.h,w:z.w,h:mm(2000),n:'8160 \ucd9c\uc785\uad6c'});
  });
  // DOOR 통행 구간 (위아래 2m)
  R.forEach(function(r){
    if(r.a.toUpperCase().indexOf('DOOR')<0)return;
    var rp=rpx(r);var clearV=mm(2000);
    obstacles.push({x:r.x,y:Math.max(BY,r.y-clearV),w:rp.w,h:clearV,n:'DOOR\ud1b5\ud589'});
    obstacles.push({x:r.x,y:r.y+rp.h,w:rp.w,h:Math.min(clearV,BY+WHH-r.y-rp.h),n:'DOOR\ud1b5\ud589'});
  });
  // 입고 동선: 상단 DOOR에서 PLT까지 1.5m 폭 세로 통로
  R.forEach(function(r){
    if(r.a.toUpperCase().indexOf('DOOR')<0||r.y>BY+WHH/2)return;
    var rp=rpx(r);var corrW=mm(1500);
    obstacles.push({x:r.x+rp.w/2-corrW/2,y:r.y+rp.h+mm(2000),w:corrW,h:mm(8000),n:'\uc785\uace0\ub3d9\uc120'});
  });
  // 대형 폼 입고 구역: Packaging Foam 위쪽 3m x 3m
  zones.forEach(function(z){
    if(z.n!=='Packaging Foam')return;
    obstacles.push({x:BX+z.x+z.w,y:BY+z.y-mm(500),w:mm(3000),h:mm(3000),n:'\ud3fc\uc785\uace0'});
  });

  // 4) L자 건물 경계
  var WH_RX=982,WH_JY=BY+mm(12900);
  var margin=mm(300);
  var AISLE_VERT=mm(1000);// 세로(행 간) 최소 1m
  var AISLE_HORIZ=mm(1500);// 시리즈 간 가로 통로 1.5m
  var RACK_GAP=mm(300);// 같은 행 내 랙 간격 300mm

  // 5) 시리즈별 그룹 분류
  var seriesOrder=['mx48','mx16','hsm','semi','spare','etc','zone'];
  var seriesBuckets={};
  existingRacks.forEach(function(rk){
    if(!seriesBuckets[rk.s])seriesBuckets[rk.s]=[];
    seriesBuckets[rk.s].push(rk);
  });

  // 6) 그리드 정렬 배치 알고리즘
  var placedRacks=[];
  function isInBldg(x,y,w,h){
    var cx=x+w/2,cy=y+h/2;
    if(cx>=BX&&cx<=BX+WHW&&cy>=BY&&cy<=BY+WHH)return true;
    if(cx>BX+WHW&&cx<=WH_RX&&cy>=WH_JY&&cy<=BY+WHH)return true;
    return false;
  }
  function hitsAny(x,y,w,h){
    var padH=RACK_GAP,padV=mm(200);// 가로 300mm, 세로 200mm 최소 간격
    for(var oi=0;oi<obstacles.length;oi++){
      var o=obstacles[oi];
      if(x<o.x+o.w+padH&&x+w+padH>o.x&&y<o.y+o.h+padV&&y+h+padV>o.y)return true;
    }
    for(var pi=0;pi<placedRacks.length;pi++){
      var p=placedRacks[pi];
      if(x<p.x+p.w+padH&&x+w+padH>p.x&&y<p.y+p.h+padV&&y+h+padV>p.y)return true;
    }
    return false;
  }
  function getMaxX(y){return y<WH_JY?(BX+WHW-margin):(WH_RX-margin);}

  // 시리즈별로 행 단위 배치
  var curY=BY+margin;
  seriesOrder.forEach(function(series){
    var bucket=seriesBuckets[series];
    if(!bucket||!bucket.length)return;
    // 높이별로 정렬 (같은 높이끼리 같은 행)
    bucket.sort(function(a,b){return b.h-a.h||b.w-a.w;});
    var rowStartY=curY;
    var curX=BX+margin;
    var rowH=0;
    bucket.forEach(function(rk){
      var w=rk.w,h=rk.h;
      var maxX=getMaxX(curY);
      // 행 넘침 → 다음 행
      if(curX+w>maxX){
        curY+=rowH+AISLE_VERT;
        curX=BX+margin;
        rowH=0;
      }
      // L자 경계 넘으면 X범위 재계산
      maxX=getMaxX(curY);
      if(curX+w>maxX){curY+=rowH+AISLE_VERT;curX=BX+margin;rowH=0;maxX=getMaxX(curY);}
      // 건물 밖이면 스킵
      if(curY+h>BY+WHH){return;}
      // 장애물 회피 — 같은 행에서 오른쪽으로 점프
      var attempts=0;
      while(hitsAny(curX,curY,w,h)&&attempts<100){
        curX+=mm(500);
        if(curX+w>getMaxX(curY)){curY+=rowH+AISLE_VERT;curX=BX+margin;rowH=0;if(curY+h>BY+WHH)return;}
        attempts++;
      }
      if(!isInBldg(curX,curY,w,h)||hitsAny(curX,curY,w,h))return;
      placedRacks.push({x:curX,y:curY,w:w,h:h,s:rk.s,a:rk.a,isNew:rk.isNew||false});
      rk._placed=true;
      curX+=w+RACK_GAP;
      if(h>rowH)rowH=h;
    });
    // 시리즈 끝 → 다음 시리즈 시작 (1.5m 간격)
    curY+=rowH+AISLE_HORIZ;
  });

  // 미배치 항목 2차 시도: 빈 공간 스캔
  existingRacks.filter(function(r){return !r._placed;}).forEach(function(rk){
    for(var sy=BY+margin;sy<BY+WHH-rk.h;sy+=mm(500)){
      for(var sx=BX+margin;sx<WH_RX-rk.w;sx+=mm(500)){
        if(!isInBldg(sx,sy,rk.w,rk.h))continue;
        if(hitsAny(sx,sy,rk.w,rk.h))continue;
        placedRacks.push({x:sx,y:sy,w:rk.w,h:rk.h,s:rk.s,a:rk.a,isNew:rk.isNew||false});
        rk._placed=true;break;
      }
      if(rk._placed)break;
    }
  });
  var unplacedList=existingRacks.filter(function(r){return !r._placed;});
  var unplaced=unplacedList.length;
  var unplacedNames=unplacedList.map(function(r){return r.a}).join(', ');
  console.log('[SIM] \ubc30\uce58\ub428:', placedRacks.length, '\ubbf8\ubc30\uce58:', unplaced, unplacedNames);
  // 7) 고정 장애물 시각화 (움직이지 않는 항목)
  obstacles.forEach(function(ob){
    var fov=document.createElement('div');fov.className='sp-sim-ghost';
    var isSpecial=ob.n&&(ob.n.indexOf('DOOR')>=0||ob.n.indexOf('\ud1b5\ud589')>=0||ob.n.indexOf('\ub3d9\uc120')>=0||ob.n.indexOf('\uc785\uace0')>=0||ob.n.indexOf('\ud3fc')>=0||ob.n.indexOf('\ubd88\ucd9c')>=0||ob.n.indexOf('\ucd9c\uc785')>=0);
    fov.style.cssText='position:absolute;z-index:16;pointer-events:none;left:'+ob.x+'px;top:'+ob.y+'px;width:'+ob.w+'px;height:'+ob.h+'px;background:'+(isSpecial?'rgba(239,68,68,.08)':'rgba(100,116,139,.2)')+';border:1.5px '+(isSpecial?'dashed rgba(239,68,68,.3)':'solid rgba(100,116,139,.4)')+';border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:8px;color:'+(isSpecial?'rgba(239,68,68,.5)':'rgba(148,163,184,.7)')+';font-weight:600';
    fov.textContent=ob.n||'';
    CV.appendChild(fov);
  });
  // 8) 이동 항목 고스트 렌더링
  var seriesColors={mx48:'rgba(220,38,38,.4)',mx16:'rgba(37,99,235,.4)',hsm:'rgba(217,119,6,.4)',semi:'rgba(234,179,8,.4)',spare:'rgba(124,58,237,.4)',etc:'rgba(148,163,184,.3)',zone:'rgba(34,197,94,.3)'};
  var seriesBorders={mx48:'#ef4444',mx16:'#3b82f6',hsm:'#f59e0b',semi:'#eab308',spare:'#8b5cf6',etc:'#94a3b8',zone:'#22c55e'};
  var newPlaced=0,existPlaced=0,zonePlaced=0;
  placedRacks.forEach(function(rk){
    var ghost=document.createElement('div');ghost.className='sp-sim-ghost';
    var bg=rk.isNew?'rgba(52,211,153,.5)':rk.s==='zone'?'rgba(34,197,94,.3)':(seriesColors[rk.s]||'rgba(148,163,184,.3)');
    var bdr=rk.isNew?'#34d399':rk.s==='zone'?'#22c55e':(seriesBorders[rk.s]||'#94a3b8');
    ghost.style.cssText='position:absolute;z-index:17;pointer-events:none;left:'+rk.x+'px;top:'+rk.y+'px;width:'+rk.w+'px;height:'+rk.h+'px;background:'+bg+';border:1.5px '+(rk.isNew?'solid':'dashed')+' '+bdr+';border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:'+(rk.isNew?'9':'8')+'px;color:rgba(255,255,255,.9);font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.8)';
    ghost.textContent=rk.isNew?'NEW':rk.a;
    CV.appendChild(ghost);
    if(rk.isNew)newPlaced++;else if(rk.s==='zone')zonePlaced++;else existPlaced++;
  });
  // 결과 배너
  var lbl=document.createElement('div');lbl.className='sp-sim';
  lbl.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:300;background:rgba(15,23,42,.95);border:1px solid '+(opt==='A'?'#60a5fa':opt==='B'?'#f87171':'#fbbf24')+';color:#e2e8f0;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;pointer-events:auto;cursor:pointer;max-width:400px;text-align:center';
  lbl.innerHTML='<div style="font-size:14px;margin-bottom:4px">Option '+opt+' \uc2dc\ubbac\ub808\uc774\uc158</div>'
    +'<div>\ub799 '+existPlaced+' + \uad6c\uc5ed '+zonePlaced+' + \uc2e0\uaddc <b style="color:'+(opt==='A'?'#60a5fa':opt==='B'?'#f87171':'#fbbf24')+'">'+newPlaced+'</b> = \ucd1d '+(existPlaced+zonePlaced+newPlaced)+'\uac1c'+(unplaced>0?' <span style="color:#f87171">(\ubbf8\ubc30\uce58 '+unplaced+': '+unplacedNames+')</span>':'')+'</div>'
    +'<div style="font-size:9px;color:#94a3b8;margin-top:4px">'
    +'<span style="color:#ef4444">\u25a0</span>RSC48 '
    +'<span style="color:#3b82f6">\u25a0</span>RSC16 '
    +'<span style="color:#f59e0b">\u25a0</span>HSM '
    +'<span style="color:#eab308">\u25a0</span>Semi '
    +'<span style="color:#22c55e">\u25a0</span>\uad6c\uc5ed '
    +'<span style="color:#34d399">\u25a0</span>NEW '
    +'<span style="color:#64748b">\u25a0</span>\uace0\uc815 '
    +'| \ud074\ub9ad\ud558\uba74 \ub2eb\ud798</div>';
  lbl.onclick=spClearSim;
  document.body.appendChild(lbl);
  CA.scrollLeft=BX*Z;CA.scrollTop=BY*Z;
}
function renderCorridorOverlay(corridors){
  document.querySelectorAll('.sp-corridor-ov,.sp-total-ov').forEach(function(e){if(e.parentNode)e.parentNode.removeChild(e);});
  if(!spPanelOpen||mode==='area'||spOvMode===0)return;

  if(spOvMode===1&&corridors&&corridors.length>0){
    // 모드1: 그룹 간 거리 — 짧은 끝점 마크 + 중앙 라벨
    var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('class','sp-corridor-ov');
    svg.style.cssText='position:absolute;left:0;top:0;width:'+CW+'px;height:'+CH+'px;z-index:16;pointer-events:none';
    corridors.forEach(function(cor){
      if(!cor||cor.w<=0||cor.h<=0)return;
      var col=cor.status==='bad'?'#f87171':cor.status==='warn'?'#fbbf24':'#67e8f9';
      var op=cor.status==='ok'?'0.4':'0.9';
      var lx,ly;
      if(cor.dir==='X'){
        var midY=cor.y+cor.h/2;
        lx=cor.x+cor.w/2;ly=midY-6;
        // 짧은 시작/끝 마크 (가로 방향: 세로 틱)
        var markLen=Math.min(8,cor.h/2);
        [cor.x, cor.x+cor.w].forEach(function(ex){
          var mk=document.createElementNS('http://www.w3.org/2000/svg','line');
          mk.setAttribute('x1',ex);mk.setAttribute('y1',midY-markLen);
          mk.setAttribute('x2',ex);mk.setAttribute('y2',midY+markLen);
          mk.setAttribute('stroke',col);mk.setAttribute('stroke-width','1.5');mk.setAttribute('opacity',op);
          svg.appendChild(mk);
        });
        // 짧은 연결선 (양 끝에서 20%만)
        var segLen=Math.min(cor.w*0.2, 10);
        [{x1:cor.x,x2:cor.x+segLen},{x1:cor.x+cor.w-segLen,x2:cor.x+cor.w}].forEach(function(s){
          var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
          ln.setAttribute('x1',s.x1);ln.setAttribute('y1',midY);ln.setAttribute('x2',s.x2);ln.setAttribute('y2',midY);
          ln.setAttribute('stroke',col);ln.setAttribute('stroke-width','1');ln.setAttribute('stroke-dasharray','3,2');ln.setAttribute('opacity',op);
          svg.appendChild(ln);
        });
      }else{
        var midX=cor.x+cor.w/2;
        lx=midX+4;ly=cor.y+cor.h/2;
        // 짧은 시작/끝 마크 (세로 방향: 가로 틱)
        var markLen=Math.min(8,cor.w/2);
        [cor.y, cor.y+cor.h].forEach(function(ey){
          var mk=document.createElementNS('http://www.w3.org/2000/svg','line');
          mk.setAttribute('x1',midX-markLen);mk.setAttribute('y1',ey);
          mk.setAttribute('x2',midX+markLen);mk.setAttribute('y2',ey);
          mk.setAttribute('stroke',col);mk.setAttribute('stroke-width','1.5');mk.setAttribute('opacity',op);
          svg.appendChild(mk);
        });
        // 짧은 연결선 (양 끝에서 20%만)
        var segLen=Math.min(cor.h*0.2, 10);
        [{y1:cor.y,y2:cor.y+segLen},{y1:cor.y+cor.h-segLen,y2:cor.y+cor.h}].forEach(function(s){
          var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
          ln.setAttribute('x1',midX);ln.setAttribute('y1',s.y1);ln.setAttribute('x2',midX);ln.setAttribute('y2',s.y2);
          ln.setAttribute('stroke',col);ln.setAttribute('stroke-width','1');ln.setAttribute('stroke-dasharray','3,2');ln.setAttribute('opacity',op);
          svg.appendChild(ln);
        });
      }
      // 라벨
      var txt=(cor.gapMM/1000).toFixed(2)+'m';
      var tw=txt.length*5+6;
      var rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',lx-tw/2);rect.setAttribute('y',ly-6);
      rect.setAttribute('width',tw);rect.setAttribute('height',12);
      rect.setAttribute('rx','2');rect.setAttribute('fill','rgba(15,23,42,.85)');
      svg.appendChild(rect);
      var label=document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x',lx);label.setAttribute('y',ly+3);
      label.setAttribute('text-anchor','middle');label.setAttribute('fill',col);
      label.setAttribute('font-size','8');label.setAttribute('font-weight','700');
      label.setAttribute('font-family','monospace');
      label.textContent=txt;
      svg.appendChild(label);
    });
    CV.appendChild(svg);
  }

  if(spOvMode===2){
    // 모드2: 117.91평 생산창고 (생산라인 제외) — x=982 기준
    var WH_RX=982; // 생산창고 오른쪽 경계 (사용자 정의)
    var WH_JY=BY+mm(12900); // L자 꺾임점 Y
    var tSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');
    tSvg.setAttribute('class','sp-total-ov');
    tSvg.style.cssText='position:absolute;left:0;top:0;width:'+CW+'px;height:'+CH+'px;z-index:3;pointer-events:none';
    var whPath='M '+BX+' '+BY+' L '+(BX+WHW)+' '+BY+' L '+(BX+WHW)+' '+WH_JY+' L '+WH_RX+' '+WH_JY+' L '+WH_RX+' '+(BY+WHH)+' L '+BX+' '+(BY+WHH)+' Z';
    tSvg.innerHTML='<path d="'+whPath+'" fill="rgba(139,92,246,.1)" stroke="rgba(139,92,246,.3)" stroke-width="2" stroke-linejoin="round"/>';
    CV.appendChild(tSvg);
    var totalCorrM2=Math.max(0,selM2_global-rackM2_global-zoneM2_global-exclM2_global);
    var lbl=document.createElement('div');lbl.className='sp-total-ov';
    lbl.style.cssText='position:absolute;z-index:18;pointer-events:none;left:'+(BX+4)+'px;top:'+(BY+WHH+4)+'px;font-size:10px;color:#a78bfa;background:rgba(15,23,42,.9);padding:3px 8px;border-radius:4px;border:1px solid rgba(139,92,246,.3);font-weight:600';
    lbl.textContent='\uc0dd\uc0b0\ucc3d\uace0 \ud1b5\ub85c: '+totalCorrM2.toFixed(1)+'m\u00b2 (117.91\ud3c9 \uae30\uc900)';
    CV.appendChild(lbl);
  }
}

function upStats(){const hc=R.filter(r=>r.t==='heavy').length;const lc=R.filter(r=>r.t==='light').length;const cc=R.filter(r=>r.t==='custom').length;document.getElementById('stats').textContent='랙 '+(hc+lc)+' (중량'+hc+'/경량'+lc+')'+( cc?' · 기타 '+cc:'')+' · 선택 '+(sel.size+selZ.size)+' · 측정 '+rulers.length+' · 선 '+lines.length+' · 면적 '+areas.length}

// ══════════ MOUSEDOWN ══════════
CA.addEventListener('mousedown',function(e){
if(drag)return;
var p=exy(e),tgt=e.target;
if(e.button===1){e.preventDefault();drag={type:'pan',sx:e.clientX,sy:e.clientY,sl:CA.scrollLeft,st:CA.scrollTop};CA.classList.add('panning');return}
if(e.button!==0)return;
if(tgt.dataset.rotid){var r=R.find(function(x){return x.id===+tgt.dataset.rotid});if(r){r.rot=!r.rot;render();autoSave()}return}
if(tgt.dataset.dtx!==undefined){txts.splice(+tgt.dataset.dtx,1);render();autoSave();return}
if(tgt.dataset.drl!==undefined){rulers.splice(+tgt.dataset.drl,1);render();autoSave();return}
// dl-handle/dl-ep 드래그 처리
if(tgt.dataset.dli!==undefined && tgt.dataset.dltype){
  var dli=+tgt.dataset.dli, dlt=tgt.dataset.dltype, ln=lines[dli];
  if(!ln) return;
  if(dlt==='move'){
    drag={type:'ld',dli:dli,dltype:'move',ox:p.x-(ln.x1+ln.x2)/2,oy:p.y-(ln.y1+ln.y2)/2};
  } else if(dlt==='p1'){
    drag={type:'ld',dli:dli,dltype:'p1'};
  } else if(dlt==='p2'){
    drag={type:'ld',dli:dli,dltype:'p2'};
  }
  tgt.classList.add('dragging');
  return;
}
if(mode==='move'){var rkEl2=tgt.closest('.rk');if(rkEl2){var ri2=+rkEl2.dataset.ri,r3=R[ri2];if(e.shiftKey){sel.add(r3.id);updSel();upStats();return}if(e.ctrlKey||e.metaKey){if(sel.has(r3.id))sel.delete(r3.id);else sel.add(r3.id);updSel();upStats();return}if(!sel.has(r3.id)){sel.clear();sel.add(r3.id);updSel();upStats()}var off2={};R.forEach(function(rr){if(sel.has(rr.id))off2[rr.id]={dx:rr.x-p.x,dy:rr.y-p.y}});drag={type:'gd',off:off2,moved:false};document.querySelectorAll('.rk').forEach(function(el){if(sel.has(+el.dataset.id))el.classList.add('dragging')});return}if(tgt.dataset.rh!==undefined){var zi3=+tgt.dataset.rh;drag={type:'zr',zi:zi3,sx:e.clientX,sy:e.clientY,sw:zones[zi3].w,sh:zones[zi3].h};return}var zEl2=tgt.closest('.zone');if(zEl2){var zi4=+zEl2.dataset.zi,zid4=zEl2.dataset.zid;if(e.shiftKey){selZ.add(zid4);updSel();upStats();return}if(e.ctrlKey||e.metaKey){if(selZ.has(zid4))selZ.delete(zid4);else selZ.add(zid4);updSel();upStats();return}if(!selZ.has(zid4)){selZ.clear();selZ.add(zid4);updSel();upStats()}if(selZ.size>1){var zoff={};zones.forEach(function(zz,idx){if(selZ.has(zz.id||('z'+idx)))zoff[zz.id||('z'+idx)]={dx:(BX+zz.x)-p.x,dy:(BY+zz.y)-p.y,idx:idx}});drag={type:'zgd',zoff:zoff,moved:false};return}drag={type:'zd',zi:zi4,ox:p.x-(BX+zones[zi4].x),oy:p.y-(BY+zones[zi4].y)};return}var txEl2=tgt.closest('.txl');if(txEl2){var ti2=+txEl2.dataset.ti;drag={type:'td',ti:ti2,ox:p.x-txts[ti2].x,oy:p.y-txts[ti2].y};return}drag={type:'pan',sx:e.clientX,sy:e.clientY,sl:CA.scrollLeft,st:CA.scrollTop};CA.classList.add('panning');return}
if(mode==='select'){
  if(tgt.dataset.rh!==undefined){var zi=+tgt.dataset.rh;drag={type:'zr',zi:zi,sx:e.clientX,sy:e.clientY,sw:zones[zi].w,sh:zones[zi].h};return}
  var zEl=tgt.closest('.zone');if(zEl){var zi2=+zEl.dataset.zi,zid2=zEl.dataset.zid;if(e.shiftKey){selZ.add(zid2);updSel();upStats();return}if(e.ctrlKey||e.metaKey){if(selZ.has(zid2))selZ.delete(zid2);else selZ.add(zid2);updSel();upStats();return}if(!selZ.has(zid2)){selZ.clear();selZ.add(zid2);updSel();upStats()}if(selZ.size>1){var zoff={};zones.forEach(function(zz,idx){if(selZ.has(zz.id||('z'+idx)))zoff[zz.id||('z'+idx)]={dx:(BX+zz.x)-p.x,dy:(BY+zz.y)-p.y,idx:idx}});drag={type:'zgd',zoff:zoff,moved:false};return}drag={type:'zd',zi:zi2,ox:p.x-(BX+zones[zi2].x),oy:p.y-(BY+zones[zi2].y)};return}
  var txEl=tgt.closest('.txl');if(txEl){var ti=+txEl.dataset.ti;drag={type:'td',ti:ti,ox:p.x-txts[ti].x,oy:p.y-txts[ti].y};return}
  var rkEl=tgt.closest('.rk');
  if(rkEl){var ri=+rkEl.dataset.ri,r2=R[ri];
    if(e.shiftKey){sel.add(r2.id);updSel();upStats();return}if(e.ctrlKey||e.metaKey){if(sel.has(r2.id))sel.delete(r2.id);else sel.add(r2.id);updSel();upStats();return}
    if(!sel.has(r2.id)){sel.clear();sel.add(r2.id);updSel();upStats()}
    var off={};R.forEach(function(rr){if(sel.has(rr.id))off[rr.id]={dx:rr.x-p.x,dy:rr.y-p.y}});
    drag={type:'gd',off:off,moved:false};document.querySelectorAll('.rk').forEach(function(el){if(sel.has(+el.dataset.id))el.classList.add('dragging')});return}
  if(!e.shiftKey)sel.clear();drag={type:'sb',sx:p.x,sy:p.y,shift:e.shiftKey};SB.style.display='block';updSel();upStats();return}
if(mode==='ruler'){if(!rulerPt){rulerPt={x:p.x,y:p.y};var mk=document.getElementById('rulerStartMk');if(!mk){mk=document.createElement('div');mk.id='rulerStartMk';mk.style.cssText='position:absolute;width:12px;height:12px;border-radius:50%;background:#f59e0b;border:2px solid #fff;box-shadow:0 0 8px rgba(245,158,11,.8);pointer-events:none;z-index:9999;transform:translate(-50%,-50%)';CV.appendChild(mk)}mk.style.left=p.x+'px';mk.style.top=p.y+'px';mk.style.display='block';if(!document.getElementById('rulerPreviewSvg')){var sv=document.createElementNS('http://www.w3.org/2000/svg','svg');sv.id='rulerPreviewSvg';sv.style.cssText='position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9998';sv.innerHTML='<line id="rulerPrevLine" stroke="#f59e0b" stroke-width="2" stroke-dasharray="6,4"/>';CV.appendChild(sv)}toast('📏 두번째 점을 클릭하세요')}else{rulers.push({x1:rulerPt.x,y1:rulerPt.y,x2:p.x,y2:p.y});rulerPt=null;var mk2=document.getElementById('rulerStartMk');if(mk2)mk2.style.display='none';var pv2=document.getElementById('rulerPreviewSvg');if(pv2)pv2.remove();render();autoSave()}return}
if(mode==='area'){
  if(!areaPt){areaPt={x:p.x,y:p.y};toast('⬜ 반대 꼭짓점을 클릭하세요');}
  else{
    areas.push({id:naid++,x1:areaPt.x,y1:areaPt.y,x2:p.x,y2:p.y});
    areaPt=null;render();autoSave();if(spPanelOpen)setTimeout(runSpAnalysis,100);
  }
  return;
}
if(mode==='line'){
  var lc=document.getElementById('lineColor')?document.getElementById('lineColor').value:'#ffffff';
  var lw=document.getElementById('lineWidth')?parseInt(document.getElementById('lineWidth').value)||2:2;
  var la=lineArrow;
  if(!linePt){linePt={x:p.x,y:p.y};toast('✏ 두 번째 점을 클릭하세요');}
  else{lines.push({id:nlid++,x1:linePt.x,y1:linePt.y,x2:p.x,y2:p.y,style:lineStyle,color:lc,width:lw,arrow:la});linePt=null;render();autoSave();toast('선 추가됨 (클릭으로 삭제)');}
  return;
}
if(mode==='text'){var _tx=Math.round(p.x),_ty=Math.round(p.y);showEditModal('\ud14d\uc2a4\ud2b8 \ucd94\uac00',[{key:'text',label:'\ud14d\uc2a4\ud2b8',value:''},{key:'fs',label:'\uae00\uc790(px)',value:'12'}],function(v){if(v.text){txts.push({id:ntid++,text:v.text,x:_tx,y:_ty,fs:parseInt(v.fs)||12});render();autoSave()}});return}
});

// ══════════ MOUSEMOVE (always on document) ══════════
document.addEventListener('mousemove',function(e){
if(!drag){try{var p=exy(e);document.getElementById('coords').textContent='X:'+Math.round(p.x)+' Y:'+Math.round(p.y)}catch(ex){}
var tip=document.getElementById('tip'),rk=e.target.closest&&e.target.closest('.rk');
if(rk){var r=R[+rk.dataset.ri];if(r){tip.innerHTML='<div class="ttn">'+r.a+' #'+r.id+'</div><div class="ttr"><span class="ttl">시리즈</span><span class="ttv">'+SN[r.s]+'</span></div><div class="ttr"><span class="ttl">타입</span><span class="ttv">'+(r.t==='heavy'?'중량 1800mm':'경량 900mm')+'</span></div>';tip.style.display='block';tip.style.left=(e.clientX+12)+'px';tip.style.top=(e.clientY-8)+'px'}}else tip.style.display='none';
// area 모드 preview
var areaPrevSvg=document.getElementById('areaPreview');
if(mode==='area'&&areaPt){
  var pp2=exy(e);
  if(!areaPrevSvg){areaPrevSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');areaPrevSvg.id='areaPreview';areaPrevSvg.setAttribute('class','dl-preview');areaPrevSvg.style.width=CW+'px';areaPrevSvg.style.height=CH+'px';CV.appendChild(areaPrevSvg)}
  // L자 교집합 계산
  var R1={x1:BX,y1:BY,x2:BX+WHW,y2:BY+WHH};
  var R2={x1:BX+WHW,y1:BY+mm(12900),x2:BX+WHW+mm(19900),y2:BY+WHH};
  function intersectPrev(ax1,ay1,ax2,ay2,bx1,by1,bx2,by2){var ix1=Math.max(ax1,bx1),iy1=Math.max(ay1,by1),ix2=Math.min(ax2,bx2),iy2=Math.min(ay2,by2);if(ix2<=ix1||iy2<=iy1)return null;return{x1:ix1,y1:iy1,x2:ix2,y2:iy2};}
  var sx1=Math.min(areaPt.x,pp2.x),sy1=Math.min(areaPt.y,pp2.y),sx2=Math.max(areaPt.x,pp2.x),sy2=Math.max(areaPt.y,pp2.y);
  var i1=intersectPrev(sx1,sy1,sx2,sy2,R1.x1,R1.y1,R1.x2,R1.y2);
  var i2=intersectPrev(sx1,sy1,sx2,sy2,R2.x1,R2.y1,R2.x2,R2.y2);
  var totalMM2prev=0;var inner='';
  [i1,i2].forEach(function(ir){if(!ir)return;var wPx=ir.x2-ir.x1,hPx=ir.y2-ir.y1;totalMM2prev+=(wPx/S)*(hPx/S);inner+='<rect x="'+ir.x1+'" y="'+ir.y1+'" width="'+wPx+'" height="'+hPx+'" fill="rgba(34,211,238,.1)" stroke="#22d3ee" stroke-width="1.5"/>';});
  inner+='<rect x="'+sx1+'" y="'+sy1+'" width="'+(sx2-sx1)+'" height="'+(sy2-sy1)+'" fill="none" stroke="rgba(34,211,238,.2)" stroke-width="0.8"/>';
  // preview에서도 excl 존 차감
  var exclMM2prev=0;
  zones.forEach(function(z){
    if(!z.excl)return;
    var zx1=BX+z.x,zy1=BY+z.y,zx2=BX+z.x+z.w,zy2=BY+z.y+z.h;
    var ex1=Math.max(sx1,zx1),ey1=Math.max(sy1,zy1),ex2=Math.min(sx2,zx2),ey2=Math.min(sy2,zy2);
    if(ex2<=ex1||ey2<=ey1)return;
    exclMM2prev+=(ex2-ex1)/S*(ey2-ey1)/S;
    inner+='<rect x="'+ex1+'" y="'+ey1+'" width="'+(ex2-ex1)+'" height="'+(ey2-ey1)+'" fill="rgba(239,68,68,.08)" stroke="rgba(239,68,68,.35)" stroke-width="1"/>';
  });
  totalMM2prev-=exclMM2prev;
  if(totalMM2prev<0)totalMM2prev=0;
  var m2p=(totalMM2prev/1e6).toFixed(2);
  var cx=(sx1+sx2)/2,cy=(sy1+sy2)/2;
  var labelW=exclMM2prev>0?130:90;
  inner+='<rect x="'+(cx-labelW/2)+'" y="'+(cy-13)+'" width="'+labelW+'" height="24" rx="4" fill="rgba(15,23,42,.88)"/>';
  inner+='<text x="'+cx+'" y="'+(cy+4)+'" text-anchor="middle" fill="#22d3ee" font-size="12" font-weight="700" font-family="monospace">'+m2p+'m²'+(exclMM2prev>0?' (제외 있음)':'')+'</text>';
  areaPrevSvg.innerHTML=inner;
}else if(areaPrevSvg){areaPrevSvg.innerHTML=''}
// ruler 모드 preview (시작점→마우스 위치)
if(mode==='ruler'&&rulerPt){
  var rpp=exy(e);
  var rpLine=document.getElementById('rulerPrevLine');
  if(rpLine){rpLine.setAttribute('x1',rulerPt.x);rpLine.setAttribute('y1',rulerPt.y);rpLine.setAttribute('x2',rpp.x);rpLine.setAttribute('y2',rpp.y)}
}
// line 모드 preview
var prevSvg=document.getElementById('linePreviewSvg');
if(mode==='line'&&linePt){
  var pp=exy(e);
  if(!prevSvg){prevSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');prevSvg.id='linePreviewSvg';prevSvg.setAttribute('class','dl-preview');prevSvg.style.width=CW+'px';prevSvg.style.height=CH+'px';CV.appendChild(prevSvg)}
  var lc2=document.getElementById('lineColor')?document.getElementById('lineColor').value:'#ffffff';
  var lw2=document.getElementById('lineWidth')?parseInt(document.getElementById('lineWidth').value)||2:2;
  var dash2=lineStyle==='dashed'?'stroke-dasharray="8,5"':'';
  prevSvg.innerHTML='<line x1="'+linePt.x+'" y1="'+linePt.y+'" x2="'+pp.x+'" y2="'+pp.y+'" stroke="'+lc2+'" stroke-width="'+lw2+'" '+dash2+' stroke-linecap="round" opacity="0.6"/>'
    +'<circle cx="'+linePt.x+'" cy="'+linePt.y+'" r="5" fill="'+lc2+'" opacity="0.9"/>'
    +'<circle cx="'+pp.x+'" cy="'+pp.y+'" r="4" fill="none" stroke="'+lc2+'" stroke-width="2" opacity="0.7"/>';
}else if(prevSvg){prevSvg.innerHTML=''}
return}
document.getElementById('tip').style.display='none';var p=exy(e);
if(drag.type==='pan'){CA.scrollLeft=drag.sl-(e.clientX-drag.sx);CA.scrollTop=drag.st-(e.clientY-drag.sy)}
else if(drag.type==='gd'){drag.moved=true;R.forEach(function(r){if(!sel.has(r.id))return;var nx=p.x+drag.off[r.id].dx,ny=p.y+drag.off[r.id].dy;if(O.snap){nx=Math.round(nx/SNAP)*SNAP;ny=Math.round(ny/SNAP)*SNAP}r.x=Math.round(nx);r.y=Math.round(ny);var el=CV.querySelector('.rk[data-id="'+r.id+'"]');if(el){el.style.left=r.x+'px';el.style.top=r.y+'px'}});var f=R.find(function(r){return sel.has(r.id)});if(f)document.getElementById('coords').textContent=f.a+' X:'+f.x+' Y:'+f.y+' ('+sel.size+'개)'}
else if(drag.type==='sb'){var x=Math.min(drag.sx,p.x),y=Math.min(drag.sy,p.y),w=Math.abs(p.x-drag.sx),h=Math.abs(p.y-drag.sy);SB.style.left=x+'px';SB.style.top=y+'px';SB.style.width=w+'px';SB.style.height=h+'px';SB.style.display='block';R.forEach(function(r){var rp=rpx(r);var inB=r.x+rp.w>x&&r.x<x+w&&r.y+rp.h>y&&r.y<y+h;if(inB)sel.add(r.id);else if(!drag.shift)sel.delete(r.id)});zones.forEach(function(z,idx){var zid=z.id||('z'+idx);var zx=BX+z.x,zy=BY+z.y;var inB=zx+z.w>x&&zx<x+w&&zy+z.h>y&&zy<y+h;if(inB)selZ.add(zid);else if(!drag.shift)selZ.delete(zid)});updSel();upStats()}
else if(drag.type==='zgd'){drag.moved=true;zones.forEach(function(z,idx){var zid=z.id||('z'+idx);if(!selZ.has(zid))return;var info=drag.zoff[zid];if(!info)return;var nx=p.x+info.dx-BX,ny=p.y+info.dy-BY;if(O.snap){nx=Math.round(nx/SNAP)*SNAP;ny=Math.round(ny/SNAP)*SNAP}z.x=Math.round(nx);z.y=Math.round(ny);var el=CV.querySelector('.zone[data-zid="'+zid+'"]');if(el){el.style.left=(BX+z.x)+'px';el.style.top=(BY+z.y)+'px'}})}
else if(drag.type==='zd'){var nx=p.x-drag.ox-BX,ny=p.y-drag.oy-BY;if(O.snap){nx=Math.round(nx/SNAP)*SNAP;ny=Math.round(ny/SNAP)*SNAP}zones[drag.zi].x=Math.round(nx);zones[drag.zi].y=Math.round(ny);var el=CV.querySelector('.zone[data-zi="'+drag.zi+'"]');if(el){el.style.left=(BX+zones[drag.zi].x)+'px';el.style.top=(BY+zones[drag.zi].y)+'px'}}
else if(drag.type==='zr'){zones[drag.zi].w=Math.max(30,Math.round(drag.sw+(e.clientX-drag.sx)/Z));zones[drag.zi].h=Math.max(20,Math.round(drag.sh+(e.clientY-drag.sy)/Z));var el=CV.querySelector('.zone[data-zi="'+drag.zi+'"]');if(el){el.style.width=zones[drag.zi].w+'px';el.style.height=zones[drag.zi].h+'px';var dm=el.querySelector('.zd');if(dm)dm.textContent=zones[drag.zi].w+'×'+zones[drag.zi].h}}
else if(drag.type==='td'){txts[drag.ti].x=Math.round(p.x-drag.ox);txts[drag.ti].y=Math.round(p.y-drag.oy);var el=CV.querySelector('.txl[data-ti="'+drag.ti+'"]');if(el){el.style.left=txts[drag.ti].x+'px';el.style.top=txts[drag.ti].y+'px'}}
else if(drag.type==='ld'){
  var ln=lines[drag.dli];if(!ln)return;
  if(drag.dltype==='move'){
    // 선 전체 이동: 중간 핸들 기준 offset
    var cx=Math.round(p.x-drag.ox),cy=Math.round(p.y-drag.oy);
    var hw=(ln.x2-ln.x1)/2,hh=(ln.y2-ln.y1)/2;
    ln.x1=Math.round(cx-hw);ln.y1=Math.round(cy-hh);
    ln.x2=Math.round(cx+hw);ln.y2=Math.round(cy+hh);
  } else if(drag.dltype==='p1'){
    ln.x1=Math.round(p.x);ln.y1=Math.round(p.y);
  } else if(drag.dltype==='p2'){
    ln.x2=Math.round(p.x);ln.y2=Math.round(p.y);
  }
  // 실시간 선 SVG 업데이트 (render() 없이 빠르게)
  var svgs=CV.querySelectorAll('.dl-svg');if(svgs[drag.dli]){var line=svgs[drag.dli].querySelector('line');if(line){line.setAttribute('x1',ln.x1);line.setAttribute('y1',ln.y1);line.setAttribute('x2',ln.x2);line.setAttribute('y2',ln.y2)}}
  // 핸들 위치 업데이트
  var handles=CV.querySelectorAll('.dl-handle[data-dli="'+drag.dli+'"]');handles.forEach(function(h){h.style.left=((ln.x1+ln.x2)/2)+'px';h.style.top=((ln.y1+ln.y2)/2)+'px'});
  var eps=CV.querySelectorAll('.dl-ep[data-dli="'+drag.dli+'"]');eps.forEach(function(ep){if(ep.dataset.dltype==='p1'){ep.style.left=ln.x1+'px';ep.style.top=ln.y1+'px'}else{ep.style.left=ln.x2+'px';ep.style.top=ln.y2+'px'}});
  document.getElementById('coords').textContent='선 ('+Math.round((ln.x2-ln.x1)/S)+'×'+Math.round((ln.y2-ln.y1)/S)+'mm)';
}
});

// ══════════ MOUSEUP (always on document) ══════════
document.addEventListener('mouseup',function(){if(!drag)return;if(drag.type==='gd'){if(drag.moved){R.forEach(function(r){if(sel.has(r.id))trySnap(r)});render();autoSave()}}else if(drag.type==='zgd'){if(drag.moved){render();autoSave()}}else if(drag.type==='sb'){SB.style.display='none';render()}else if(drag.type==='pan'){CA.classList.remove('panning')}else if(drag.type==='ld'){document.querySelectorAll('.dl-handle.dragging,.dl-ep.dragging').forEach(function(el){el.classList.remove('dragging')});render();autoSave()}else{autoSave()}drag=null});
function showConfirm(msg,onYes){var m=document.createElement('div');m.className='edit-modal';var b=document.createElement('div');b.className='edit-box';var h=document.createElement('h4');h.textContent='\ud655\uc778';b.appendChild(h);var p=document.createElement('div');p.textContent=msg;p.style.cssText='font-size:12px;color:#e2e8f0;margin:12px 0';b.appendChild(p);var btns=document.createElement('div');btns.style.cssText='display:flex;gap:6px;margin-top:14px';var yBtn=document.createElement('button');yBtn.textContent='\uc608 (Enter)';yBtn.style.cssText='flex:1;padding:7px;border:none;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;background:#dc2626;color:#fff;font-family:inherit';var nBtn=document.createElement('button');nBtn.textContent='\uc544\ub2c8\uc624';nBtn.style.cssText='flex:1;padding:7px;border:none;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;background:#475569;color:#e2e8f0;font-family:inherit';yBtn.addEventListener('click',function(){m.parentNode.removeChild(m);onYes()});nBtn.addEventListener('click',function(){m.parentNode.removeChild(m)});btns.appendChild(yBtn);btns.appendChild(nBtn);b.appendChild(btns);m.appendChild(b);document.body.appendChild(m);function onKey(e){if(e.key==='Enter'){m.parentNode.removeChild(m);document.removeEventListener('keydown',onKey);onYes()}if(e.key==='Escape'){m.parentNode.removeChild(m);document.removeEventListener('keydown',onKey)}}document.addEventListener('keydown',onKey);yBtn.focus()}
function showEditModal(title,fields,onSave){var m=document.createElement('div');m.className='edit-modal';var b=document.createElement('div');b.className='edit-box';var h=document.createElement('h4');h.textContent=title;b.appendChild(h);var inputs=[];for(var fi=0;fi<fields.length;fi++){var f=fields[fi];var lbl=document.createElement('label');lbl.textContent=f.label;b.appendChild(lbl);var inp;if(f.type==='color'){var wrap=document.createElement('div');wrap.style.cssText='display:flex;gap:6px;align-items:center';inp=document.createElement('input');inp.type='color';inp.style.cssText='width:40px;height:28px;border:none;cursor:pointer;background:none';var txtInp=document.createElement('input');txtInp.value=f.value||'';txtInp.style.cssText='flex:1;background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:5px 8px;border-radius:4px;font-size:11px';try{var cv=f.value||'';if(cv.indexOf('rgba')===0||cv.indexOf('rgb')===0){var nums=cv.match(/[\d.]+/g);if(nums&&nums.length>=3){var rr=parseInt(nums[0]),gg=parseInt(nums[1]),bb=parseInt(nums[2]);inp.value='#'+((1<<24)+(rr<<16)+(gg<<8)+bb).toString(16).slice(1)}}else if(cv.indexOf('#')===0){inp.value=cv}else{inp.value='#3b82f6'}}catch(ex){inp.value='#3b82f6'}inp.oninput=function(ti){return function(){ti.value=this.value}}(txtInp);txtInp.oninput=function(ci){return function(){var v=this.value;if(v.indexOf('#')===0&&v.length===7){ci.value=v}else if(v.indexOf('rgb')===0){try{var n=v.match(/[\d.]+/g);if(n&&n.length>=3){ci.value='#'+((1<<24)+(parseInt(n[0])<<16)+(parseInt(n[1])<<8)+parseInt(n[2])).toString(16).slice(1)}}catch(ex){}}}}(inp);wrap.appendChild(inp);wrap.appendChild(txtInp);b.appendChild(wrap);inputs.push({key:f.key,el:txtInp})}else{inp=document.createElement('input');inp.value=f.value||'';inp.style.cssText='width:100%;background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:5px 8px;border-radius:4px;font-size:11px;font-family:inherit';b.appendChild(inp);inputs.push({key:f.key,el:inp})}}var btns=document.createElement('div');btns.style.cssText='display:flex;gap:6px;margin-top:14px';var okBtn=document.createElement('button');okBtn.textContent='\ud655\uc778';okBtn.style.cssText='flex:1;padding:7px;border:none;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;background:#059669;color:#fff;font-family:inherit';var ccBtn=document.createElement('button');ccBtn.textContent='\ucde8\uc18c';ccBtn.style.cssText='flex:1;padding:7px;border:none;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;background:#475569;color:#e2e8f0;font-family:inherit';okBtn.addEventListener('click',function(){var vals={};for(var ii=0;ii<inputs.length;ii++){vals[inputs[ii].key]=inputs[ii].el.value}m.parentNode.removeChild(m);onSave(vals)});ccBtn.addEventListener('click',function(){m.parentNode.removeChild(m)});btns.appendChild(okBtn);btns.appendChild(ccBtn);b.appendChild(btns);m.appendChild(b);document.body.appendChild(m);function onEnter(e){if(e.key==='Enter'){e.preventDefault();okBtn.click()}}for(var ki=0;ki<inputs.length;ki++){inputs[ki].el.addEventListener('keydown',onEnter)}if(inputs.length>0)inputs[0].el.focus()}
CA.addEventListener('dblclick',function(e){
  // area-label 더블클릭 → 면적 삭제
  var albl=e.target.closest?e.target.closest('[data-dai]'):null;
  if(!albl&&e.target.dataset&&e.target.dataset.dai!==undefined)albl=e.target;
  if(albl&&albl.dataset.dai!==undefined){areas.splice(+albl.dataset.dai,1);render();autoSave();toast('면적 삭제됨');return;}
  // dl-handle 더블클릭 → 선 삭제
  var dlh=e.target.closest?e.target.closest('[data-dli]'):null;
  if(!dlh&&e.target.dataset&&e.target.dataset.dli!==undefined)dlh=e.target;
  if(dlh&&dlh.dataset.dli!==undefined){lines.splice(+dlh.dataset.dli,1);render();autoSave();toast('선 삭제됨');return;}var rk=e.target.closest('.rk');if(rk){var ri=+rk.dataset.ri,r=R[ri];if(!r)return;var wMM=r.t==='custom'?(r.cw||1800):r.t==='heavy'?1800:900;var hMM=r.t==='custom'?(r.ch||450):450;showEditModal(r.a+' \\uc218\\uc815',[{key:'a',label:'\\uc774\\ub984',value:r.a},{key:'t',label:'\\ud0c0\\uc785(heavy/light/custom)',value:r.t},{key:'cw',label:'\\uac00\\ub85c mm',value:''+wMM},{key:'ch',label:'\\uc138\\ub85c mm',value:''+hMM},{key:'cc',label:'\\ubc30\\uacbd\\uc0c9',value:r.cc||'',type:'color'},{key:'fs',label:'\\uae00\\uc790\\ud06c\\uae30(px)',value:''+(r.fs||10)},{key:'fc',label:'\\uae00\\uc790\\uc0c9\\uc0c1',value:r.fc||'',type:'color'},{key:'rot2',label:'\\ud68c\\uc804(0/90/180/270)',value:''+(r.rot===true?90:(r.rot||0))}],function(v){r.a=v.a.toUpperCase();var nt=v.t;if(nt==='heavy'||nt==='light'||nt==='custom')r.t=nt;r.cw=parseInt(v.cw)||1800;r.ch=parseInt(v.ch)||450;if(r.t!=='custom'&&(r.cw!==1800&&r.cw!==900))r.t='custom';r.cc=v.cc||'';r.fs=parseInt(v.fs)||10;r.fc=v.fc||'';r.rot=parseInt(v.rot2)||0;render();autoSave()});return}var z=e.target.closest('.zone');if(z){var zi=+z.dataset.zi,zn=zones[zi];if(!zn)return;showEditModal(zn.n+' \\uc218\\uc815',[{key:'n',label:'\\uc774\\ub984',value:zn.n},{key:'w',label:'\\uac00\\ub85c mm',value:''+Math.round(zn.w/S)},{key:'h',label:'\\uc138\\ub85c mm',value:''+Math.round(zn.h/S)},{key:'c',label:'\\uc0c9\\uc0c1',value:zn.c||'',type:'color'},{key:'fs',label:'\\uae00\\uc790\\ud06c\\uae30(px)',value:''+(zn.fs||11)},{key:'fc',label:'\\uae00\\uc790\\uc0c9\\uc0c1',value:zn.fc||'',type:'color'},{key:'rot',label:'\\ud68c\\uc804(0/90/270)',value:''+(zn.rot||0)},{key:'excl',label:'\\uba74\\uc801 \\uacc4\\uc0b0 \\uc81c\\uc678(1=\\uc608, 0=\\uc544\\ub2c8\\uc624)',value:zn.excl?'1':'0'}],function(v){zn.n=v.n;zn.w=mm(parseInt(v.w)||1000);zn.h=mm(parseInt(v.h)||500);if(v.c){zn.c=v.c;zn.b=v.c}zn.fs=parseInt(v.fs)||11;zn.fc=v.fc||'';zn.rot=parseInt(v.rot)||0;zn.excl=(v.excl==='1'||v.excl===1||v.excl===true);render();autoSave()});return}var t=e.target.closest('.txl');if(t){var ti=+t.dataset.ti,tx=txts[ti];showEditModal('\\ud14d\\uc2a4\\ud2b8 \\uc218\\uc815',[{key:'text',label:'\\ud14d\\uc2a4\\ud2b8',value:tx.text},{key:'fs',label:'\\uae00\\uc790\\ud06c\\uae30(px)',value:''+(tx.fs||10)},{key:'fc',label:'\\uae00\\uc790\\uc0c9\\uc0c1',value:tx.fc||'',type:'color'},{key:'rot',label:'\\ud68c\\uc804(0/90/270)',value:''+(tx.rot||0)}],function(v){tx.text=v.text;tx.fs=parseInt(v.fs)||10;tx.fc=v.fc||'';tx.rot=parseInt(v.rot)||0;render();autoSave()});return}});
function trySnap(r){var rp=rpx(r),bd=13,bs=null;R.forEach(function(o){if(o.id===r.id||sel.has(o.id))return;var op=rpx(o);[[r.x+rp.w,o.x,r.y,o.y,{x:o.x-rp.w-3,y:o.y}],[r.x,o.x+op.w,r.y,o.y,{x:o.x+op.w+3,y:o.y}],[r.x,o.x,r.y+rp.h,o.y,{x:o.x,y:o.y-rp.h-3}],[r.x,o.x,r.y,o.y+op.h,{x:o.x,y:o.y+op.h+3}]].forEach(function(a){if(Math.abs(a[0]-a[1])<12&&Math.abs(a[2]-a[3])<10){var dt=Math.abs(a[0]-a[1])+Math.abs(a[2]-a[3]);if(dt<bd){bd=dt;bs=a[4]}}})});if(bs){r.x=bs.x;r.y=bs.y}}
document.getElementById('zoomR').addEventListener('input',function(e){Z=e.target.value/100;document.getElementById('zoomV').textContent=e.target.value+'%';CV.style.transform='scale('+Z+')'});
function tog(k){O[k]=!O[k];document.getElementById(k==='grid'?'bG':'bS').classList.toggle('act',O[k]);if(k==='snap')document.getElementById('snapSt').textContent=O.snap?'스냅 ON':'스냅 OFF';if(k==='grid')render()}
function toggleP(id){document.getElementById(id).classList.toggle('show')}
function addRack(){var a=document.getElementById('aA').value.toUpperCase()||'NEW',tv=document.getElementById('aT').value,s=document.getElementById('aS').value,cc=document.getElementById('aC')?document.getElementById('aC').value:'',cx=(CA.scrollLeft+CA.clientWidth/2)/Z,cy=(CA.scrollTop+CA.clientHeight/2)/Z;var t=tv==='custom'?'custom':tv==='heavy'?'heavy':'light';var nr={id:nid++,a:a,t:t,s:s,x:Math.round(cx),y:Math.round(cy),rot:false};if(t==='custom'){nr.cw=parseInt(document.getElementById('aCW').value)||1800;nr.ch=parseInt(document.getElementById('aCH').value)||450}if(cc)nr.cc=cc;R.push(nr);render();autoSave();toast(a+' 추가')}
function addZone(){var n=document.getElementById('aZN').value||'새 구역',w=mm(parseInt(document.getElementById('aZW').value)||2000),h=mm(parseInt(document.getElementById('aZH').value)||1000),c=document.getElementById('aZC').value,cx=(CA.scrollLeft+CA.clientWidth/2)/Z,cy=(CA.scrollTop+CA.clientHeight/2)/Z;var bd=c.replace('.15)','0.5)').replace('.12)','0.5)').replace('.4)','0.6)');zones.push({id:'z'+Date.now(),n:n,x:Math.round(cx-BX),y:Math.round(cy-BY),w:w,h:h,c:c,b:bd});render();autoSave();toast(n+' 구역 추가')}
function addPreset(type){var presets={table:{a:'TBL',cw:1200,ch:4500,cc:'rgba(20,20,20,.85)',rot:true},pillar:{a:'PILLAR',cw:500,ch:500,cc:'#6b7280',rot:false},equip:{a:'EQUIP',cw:2000,ch:1000,cc:'#374151',rot:false},desk:{a:'DESK',cw:1800,ch:600,cc:'#78716c',rot:false},conveyor:{a:'CONV',cw:3000,ch:500,cc:'#525252',rot:false},wall:{a:'WALL',cw:3000,ch:100,cc:'#9ca3af',rot:false},pallet:{a:'PLT',cw:1100,ch:1100,cc:'#a16207',rot:false},door:{a:'DOOR',cw:1500,ch:200,cc:'#065f46',rot:false}};var p=presets[type];if(!p)return;showEditModal(p.a+' \ucd94\uac00',[{key:'a',label:'\uc774\ub984',value:p.a},{key:'cw',label:'\uac00\ub85c mm',value:''+p.cw},{key:'ch',label:'\uc138\ub85c mm',value:''+p.ch},{key:'cc',label:'\uc0c9\uc0c1',value:p.cc,type:'color'}],function(v){var cx=(CA.scrollLeft+CA.clientWidth/2)/Z,cy=(CA.scrollTop+CA.clientHeight/2)/Z;R.push({id:nid++,a:v.a||p.a,t:'custom',s:'etc',x:Math.round(cx),y:Math.round(cy),rot:p.rot,cw:parseInt(v.cw)||p.cw,ch:parseInt(v.ch)||p.ch,cc:v.cc||p.cc});render();autoSave();toast((v.a||p.a)+' \ucd94\uac00')})}
function delSel(){var cnt=sel.size+selZ.size;if(!cnt){toast('\uc120\ud0dd \uc5c6\uc74c');return}showConfirm(cnt+'\uac1c \ud56d\ubaa9\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?',function(){R=R.filter(function(r){return!sel.has(r.id)});zones=zones.filter(function(z,idx){return!selZ.has(z.id||('z'+idx))});sel.clear();selZ.clear();render();autoSave();toast('\uc0ad\uc81c \uc644\ub8cc')})}
document.addEventListener('keydown',function(e){if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT')return;if((e.ctrlKey||e.metaKey)&&!e.shiftKey&&e.key==='z'){undo();e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&e.key==='c'){var cc=sel.size+selZ.size;if(cc>0){window._clipR=[];R.forEach(function(r){if(sel.has(r.id))window._clipR.push(JSON.parse(JSON.stringify(r)))});window._clipZ=[];zones.forEach(function(z,idx){if(selZ.has(z.id||('z'+idx)))window._clipZ.push(JSON.parse(JSON.stringify(z)))});toast('\ubcf5\uc0ac: '+(window._clipR.length+window._clipZ.length)+'\uac1c');e.preventDefault();return}}if((e.ctrlKey||e.metaKey)&&e.key==='v'){var pc=0;if(window._clipR&&window._clipR.length>0){window._clipR.forEach(function(cr){R.push({id:nid++,a:cr.a,t:cr.t,s:cr.s,x:cr.x+20,y:cr.y+20,rot:cr.rot||false,cw:cr.cw,ch:cr.ch,cc:cr.cc})});pc+=window._clipR.length}if(window._clipZ&&window._clipZ.length>0){window._clipZ.forEach(function(cz){zones.push({id:'z'+Date.now()+Math.random(),n:cz.n,x:cz.x+20,y:cz.y+20,w:cz.w,h:cz.h,c:cz.c,b:cz.b,fs:cz.fs,fc:cz.fc,rot:cz.rot})});pc+=window._clipZ.length}if(pc>0){render();autoSave();toast('\ubd99\uc5ec\ub123\uae30: '+pc+'\uac1c');e.preventDefault();return}}var k=e.key.toLowerCase();if(k==='v')setMode('move');else if(k==='s'&&!e.ctrlKey)setMode('select');else if(k==='m'&&!e.ctrlKey)setMode('ruler');else if(k==='t'&&!e.ctrlKey)setMode('text');else if(k==='l'&&!e.ctrlKey)setMode('line');else if(k==='a'&&!e.ctrlKey&&!e.metaKey)setMode('area');else if(k==='r'&&!e.ctrlKey){R.forEach(function(r){if(sel.has(r.id))r.rot=!r.rot});if(sel.size){render();autoSave()}}else if(k==='delete'||k==='backspace'){if(sel.size||selZ.size)delSel();e.preventDefault()}else if(k==='escape'){sel.clear();selZ.clear();rulerPt=null;linePt=null;areaPt=null;var pv=document.getElementById('linePreviewSvg');if(pv)pv.innerHTML='';var ap2=document.getElementById('areaPreview');if(ap2)ap2.innerHTML='';setMode('move');render()}else if(k==='a'&&(e.ctrlKey||e.metaKey)){e.preventDefault();R.forEach(function(r){sel.add(r.id)});zones.forEach(function(z,idx){selZ.add(z.id||('z'+idx))});render()}});
CA.addEventListener('wheel',function(e){if(e.ctrlKey||e.metaKey){e.preventDefault();var nz=Math.max(30,Math.min(200,Math.round(Z*100)+(e.deltaY>0?-5:5)));Z=nz/100;document.getElementById('zoomR').value=nz;document.getElementById('zoomV').textContent=nz+'%';CV.style.transform='scale('+Z+')'}},{passive:false});
CA.addEventListener('contextmenu',function(e){e.preventDefault()});
try{initR();load();render();pushHistory()}catch(e){console.error('Layout init error:',e);initR();render();pushHistory()}
window.addEventListener('message',function(e){if(e.data&&e.data.type==='layoutLoad'){try{var d=JSON.parse(e.data.data);loadFromData(d);pushHistory()}catch(ex){}}});
setTimeout(function(){if(window.parent!==window){window.parent.postMessage({type:'layoutReady'},'*')}},500)
<\/script>
<\/body>
<\/html>
`;

  // 랙 배치도 데이터 저장/로드 (postMessage 통신)
  const layoutIframeRef = React.useRef(null);
  const [layoutData, setLayoutData] = useState(null);
  const view3dCanvasRef = React.useRef(null);
  const view3dSceneRef = React.useRef(null);
  const view3dCtrlRef = React.useRef(null);// 카메라/기능 제어용
  const view3dWalkRef = React.useRef(null);// 워크스루 시뮬레이션 상태
  const [walkHudVisible, setWalkHudVisible] = useState(false);
  
  useEffect(() => {
    // 초기 로드: 저장된 데이터가 있으면 파싱
    try {
      const saved = safeStorage.getItem('pbk_layout_data');
      if (saved) setLayoutData(JSON.parse(saved));
    } catch(ex) {}
  }, []);

  useEffect(() => {
    const handleLayoutMessage = (e) => {
      if (!e.data || !e.data.type) return;
      if (e.data.type === 'layoutClear') {
        try { safeStorage.removeItem('pbk_layout_data'); } catch(ex) {}
        setLayoutData(null);
      }
      if (e.data.type === 'layoutSave') {
        try { safeStorage.setItem('pbk_layout_data', e.data.data); setLayoutData(JSON.parse(e.data.data)); } catch(ex) {}
      }
      if (e.data.type === 'layoutReady') {
        try {
          const saved = safeStorage.getItem('pbk_layout_data');
          if (saved && layoutIframeRef.current) {
            const parsed = JSON.parse(saved);
            if (parsed.R && parsed.R.length > 0) {
              layoutIframeRef.current.contentWindow.postMessage({ type: 'layoutLoad', data: saved }, '*');
            }
          }
        } catch(ex) {}
      }
    };
    window.addEventListener('message', handleLayoutMessage);
    return () => window.removeEventListener('message', handleLayoutMessage);
  }, []);

  // 3D 뷰 렌더링
  const view3dKeyRef = React.useRef(null);
  useEffect(() => {
    if(activeTab !== 'view3d' || !layoutData || !view3dCanvasRef.current) return;
    if(view3dSceneRef.current) { view3dSceneRef.current.renderer.dispose(); view3dSceneRef.current = null; }
    if(view3dKeyRef.current) { if(view3dKeyRef.current.down){window.removeEventListener('keydown',view3dKeyRef.current.down);window.removeEventListener('keyup',view3dKeyRef.current.up);}else{window.removeEventListener('keydown',view3dKeyRef.current);}view3dKeyRef.current=null; }
    const loadAndInit = () => {
      const THREE = window.THREE;
      if(!THREE) return;
      const cv = view3dCanvasRef.current;
      if(!cv) return;
      const W = cv.clientWidth || 800, H = cv.clientHeight || 600;
      const S3D = 0.06, BX3D = 50, BY3D = 50;
      const toM = (px) => px / S3D / 1000;
      // 시리즈 색상 — etc를 밝은 청록색으로
      const SERIES_COLORS = {mx48:0xdc2626,mx16:0x2563eb,hsm:0xd97706,semi:0xeab308,spare:0x7c3aed,etc:0x06b6d4};
      const rpx3d = (r) => {
        var w,h;
        if(r.t==='custom'){w=(r.cw||1000)*S3D;h=(r.ch||500)*S3D;}
        else{w=(r.t==='heavy'?1800:900)*S3D;h=450*S3D;}
        if(r.rot===true||r.rot===90||r.rot===270){var tmp=w;w=h;h=tmp;}
        return {w:w,h:h};
      };
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0f172a);
      const camera = new THREE.PerspectiveCamera(50, W/H, 0.1, 200);
      const renderer = new THREE.WebGLRenderer({canvas:cv, antialias:true, preserveDrawingBuffer:true});
      renderer.setSize(W, H); renderer.shadowMap.enabled = true;
      view3dSceneRef.current = {scene, camera, renderer};
      scene.add(new THREE.AmbientLight(0xffffff, 0.5));
      const dl = new THREE.DirectionalLight(0xffffff, 0.6);
      dl.position.set(20, 30, 10); dl.castShadow = true; scene.add(dl);

      // Floor (L-shape)
      const whw=toM(564),whh=toM(1890),jy=toM(774),rx=toM(982-BX3D);
      const floorShape = new THREE.Shape();
      floorShape.moveTo(0,0);floorShape.lineTo(whw,0);floorShape.lineTo(whw,jy);
      floorShape.lineTo(rx,jy);floorShape.lineTo(rx,whh);floorShape.lineTo(0,whh);
      const floor = new THREE.Mesh(new THREE.ShapeGeometry(floorShape), new THREE.MeshStandardMaterial({color:0x1a2332,side:THREE.DoubleSide}));
      floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

      // Walls
      const wallH = 3.5;
      const pts = [[0,0],[whw,0],[whw,jy],[rx,jy],[rx,whh],[0,whh]];
      for(let i=0;i<pts.length;i++){
        const p0=pts[i],p1=pts[(i+1)%pts.length];
        const dx=p1[0]-p0[0],dz=p1[1]-p0[1],len=Math.sqrt(dx*dx+dz*dz);
        const wall=new THREE.Mesh(new THREE.PlaneGeometry(len,wallH),new THREE.MeshStandardMaterial({color:0x475569,transparent:true,opacity:0.15,side:THREE.DoubleSide}));
        wall.position.set((p0[0]+p1[0])/2,wallH/2,(p0[1]+p1[1])/2);
        wall.rotation.y=-Math.atan2(dz,dx); scene.add(wall);
      }

      // 라벨: Sprite 방식 (항상 카메라를 향해 읽기 쉬움)
      function makeLabel(text,x,topY,z,scale,color){
        const cW=512,cH=64;
        const c=document.createElement('canvas');c.width=cW;c.height=cH;
        const ctx=c.getContext('2d');
        ctx.clearRect(0,0,cW,cH);
        var fontSize=32;
        ctx.font='bold '+fontSize+'px sans-serif';
        while(ctx.measureText(text).width>cW-10&&fontSize>8){fontSize-=2;ctx.font='bold '+fontSize+'px sans-serif';}
        ctx.fillStyle='rgba(0,0,0,0.6)';
        var tw=Math.min(ctx.measureText(text).width+16,cW);
        ctx.fillRect((cW-tw)/2,4,tw,cH-8);
        ctx.fillStyle=color||'#ffffff';
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText(text,cW/2,cH/2);
        const tex=new THREE.CanvasTexture(c);tex.minFilter=THREE.LinearFilter;
        const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,depthWrite:false,depthTest:false}));
        sp.position.set(x,topY+0.15,z);
        var s=scale||1.2;
        sp.scale.set(s,s*cH/cW,1);
        scene.add(sp);
      }

      // 랙 렌더링
      if(layoutData.R) layoutData.R.forEach(r => {
        const rp=rpx3d(r),wM=toM(rp.w),dM=toM(rp.h);
        const xM=toM(r.x-BX3D),zM=toM(r.y-BY3D);
        const nm=(r.a||'').toUpperCase();
        const isPillar=nm.indexOf('PILLAR')>=0||(r.a||'').indexOf('\uae30\ub465')>=0||(r.cc==='#6b7280')||(r.t==='custom'&&(r.cw||0)<=600&&(r.ch||0)<=600&&nm.indexOf('DOOR')<0&&nm.indexOf('PLT')<0);
        const isDoor=nm.indexOf('DOOR')>=0;
        const isPLT=nm.indexOf('PLT')>=0;
        // 높이
        var hM=1.8;// 기본 1.8m
        if(isDoor)hM=2.0;
        else if(isPLT)hM=0.3;
        else if(isPillar)hM=1.8;// 기둥
        // 색상
        var col=isDoor?0x10b981:isPillar?0x6b7280:isPLT?0xa16207:(SERIES_COLORS[r.s]||0x06b6d4);
        var op=isDoor?0.5:isPillar?0.95:isPLT?0.7:0.9;
        // DOOR: 얇은 프레임 (높이 2m, 깊이 0.05m)
        var geoW=wM,geoH=hM,geoD=dM;
        if(isDoor){geoD=Math.max(dM,0.05);geoW=Math.max(wM,0.05);}
        const mesh=new THREE.Mesh(new THREE.BoxGeometry(geoW,geoH,geoD),new THREE.MeshStandardMaterial({color:col,transparent:true,opacity:op}));
        mesh.position.set(xM+wM/2,geoH/2,zM+dM/2);mesh.castShadow=true;scene.add(mesh);
        // 엣지 (DOOR은 두껍게)
        const edgeLine=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(geoW,geoH,geoD)),new THREE.LineBasicMaterial({color:isDoor?0x34d399:isPillar?0x94a3b8:col,transparent:true,opacity:isDoor?0.8:0.4}));
        edgeLine.position.copy(mesh.position);scene.add(edgeLine);
        // 라벨
        var lblScale=Math.max(wM*1.5,1);
        makeLabel(r.a,xM+wM/2,geoH,zM+dM/2,lblScale,isPillar?'#94a3b8':isDoor?'#34d399':isPLT?'#fbbf24':'#ffffff');
      });

      // 존 — 이름별 높이/색상
      const ZONE_CFG={
        'Packaging Foam':{h:1.8,c:0x22c55e,op:0.6},
        'Spare Part Box':{h:1.8,c:0x22c55e,op:0.6},
        'Injection':{h:0.3,c:0x3b82f6,op:0.3},
        'Stand':{h:1.8,c:0xf59e0b,op:0.9},
        'Tablet':{h:1.8,c:0xf59e0b,op:0.9},
        'Base Plate':{h:0.5,c:0x8b5cf6,op:0.6},
        'Yellow Box':{h:0.8,c:0xeab308,op:0.6},
        '8160 Area':{h:3.5,c:0x94a3b8,op:0.5},
        'Barcode/ E6150 Area':{h:0.3,c:0x8b5cf6,op:0.5},
        'Defect Area':{h:0.01,c:0xef4444,op:0.2},
        'Test Area':{h:0.01,c:0x3b82f6,op:0.15},
        'Final QC Area':{h:0.01,c:0x3b82f6,op:0.15}
      };
      if(layoutData.zones) layoutData.zones.forEach(z => {
        const wM=toM(z.w),dM=toM(z.h),xM=toM(z.x),zM=toM(z.y);
        var cfg=ZONE_CFG[z.n];
        if(!cfg){
          // 이름에 '기둥' 포함 시 1.8m 기둥으로 처리
          if(z.n.indexOf('\uae30\ub465')>=0) cfg={h:1.8,c:0x6b7280,op:0.95};
          else cfg={h:0.3,c:0x22c55e,op:0.4};
        }
        const mesh=new THREE.Mesh(new THREE.BoxGeometry(wM,cfg.h,dM),new THREE.MeshStandardMaterial({color:cfg.c,transparent:true,opacity:cfg.op}));
        mesh.position.set(xM+wM/2,cfg.h/2,zM+dM/2); scene.add(mesh);
        if(cfg.h>=0.1){
          var lblScale=Math.max(wM,1.5);
          makeLabel(z.n,xM+wM/2,cfg.h,zM+dM/2,lblScale,'#ffffff');
        }
      });


      // Camera orbit + 화살표 키 이동
      let isDrag=false,prevX=0,prevY=0,theta=0.8,phi=0.5,dist=35;
      const target=new THREE.Vector3(whw/2,0,whh/3);
      const updateCam=()=>{camera.position.set(target.x+dist*Math.sin(theta)*Math.cos(phi),dist*Math.sin(phi),target.z+dist*Math.cos(theta)*Math.cos(phi));camera.lookAt(target);};
      updateCam();
      cv.addEventListener('mousedown',e=>{isDrag=true;prevX=e.clientX;prevY=e.clientY;});
      cv.addEventListener('mousemove',e=>{if(!isDrag)return;
        if(walkState.active){
          // 워크스루: 3인칭 카메라 회전
          walkState.camTheta+=(e.clientX-prevX)*0.005;
          walkState.camPhi=Math.max(0.1,Math.min(1.2,walkState.camPhi+(e.clientY-prevY)*0.005));
          prevX=e.clientX;prevY=e.clientY;
        } else {
          theta+=(e.clientX-prevX)*0.005;phi=Math.max(0.1,Math.min(1.5,phi+(e.clientY-prevY)*0.005));prevX=e.clientX;prevY=e.clientY;updateCam();
        }
      });
      window.addEventListener('mouseup',()=>{isDrag=false;});
      cv.addEventListener('wheel',e=>{
        if(walkState.active){
          walkState.camDist=Math.max(2,Math.min(12,walkState.camDist+e.deltaY*0.01));
        } else {
          dist=Math.max(5,Math.min(80,dist+e.deltaY*0.03));updateCam();
        }
        e.preventDefault();
      },{passive:false});

      const onKey=e=>{
        var kl=e.key.toLowerCase();
        // 워크스루 모드 키 처리
        if(walkState.active){
          if('wasdqe'.indexOf(kl)>=0){
            walkState.keys[kl]=true;e.preventDefault();return;
          }
          if(e.key==='Escape'){
            if(view3dCtrlRef.current)view3dCtrlRef.current.toggleWalk();
            var btn=document.getElementById('btn3dWalk');if(btn)btn.classList.remove('bg-yellow-700');
            e.preventDefault();return;
          }
          return;
        }
        // 오빗 모드: WASD + 화살표 모두 지원
        const sp=0.5;
        var fwdX=Math.sin(theta),fwdZ=Math.cos(theta);
        var rightX=Math.cos(theta),rightZ=-Math.sin(theta);
        if(kl==='a'||e.key==='ArrowLeft'){target.x-=rightX*sp;target.z-=rightZ*sp;updateCam();e.preventDefault();}
        else if(kl==='d'||e.key==='ArrowRight'){target.x+=rightX*sp;target.z+=rightZ*sp;updateCam();e.preventDefault();}
        else if(kl==='w'||e.key==='ArrowUp'){target.x-=fwdX*sp;target.z-=fwdZ*sp;updateCam();e.preventDefault();}
        else if(kl==='s'||e.key==='ArrowDown'){target.x+=fwdX*sp;target.z+=fwdZ*sp;updateCam();e.preventDefault();}
      };
      const onKeyUp=e=>{
        if(walkState.active){
          var kl=e.key.toLowerCase();
          if('wasdqe'.indexOf(kl)>=0){walkState.keys[kl]=false;e.preventDefault();}
        }
      };
      window.addEventListener('keydown',onKey);
      window.addEventListener('keyup',onKeyUp);
      view3dKeyRef.current = {down:onKey, up:onKeyUp};

      // ── 외부 제어 함수 노출 ──
      view3dCtrlRef.current = {
        setCamPreset: function(preset){
          if(view3dWalkRef.current&&view3dWalkRef.current.active) return;// 워크스루 중 프리셋 비활성
          if(preset==='top'){theta=0;phi=1.5;dist=30;target.set(whw/2,0,whh/2);}
          else if(preset==='front'){theta=0;phi=0.3;dist=35;target.set(whw/2,0,whh);}
          else if(preset==='entrance'){theta=0.3;phi=0.4;dist=25;target.set(whw/2,0,2);}
          else if(preset==='side'){theta=Math.PI/2;phi=0.4;dist=35;target.set(0,0,whh/2);}
          else if(preset==='iso'){theta=0.8;phi=0.5;dist=35;target.set(whw/2,0,whh/3);}
          updateCam();
        },

      };

      // ══════════════════════════════════════════════════
      // ██ 워크스루 시뮬레이션 (자키 + 파렛트 동선 검증) ██
      // ══════════════════════════════════════════════════

      // --- 충돌 박스 수집 (모든 랙, 존, 벽) ---
      var colliders = [];
      if(layoutData.R) layoutData.R.forEach(function(r){
        var nm=(r.a||'').toUpperCase();
        var rp=rpx3d(r),wM=toM(rp.w),dM=toM(rp.h);
        var xM=toM(r.x-BX3D),zM=toM(r.y-BY3D);
        // DOOR만 통과 가능(passable), PLT는 충돌 대상
        var pass=(nm.indexOf('DOOR')>=0);
        colliders.push({minX:xM,maxX:xM+wM,minZ:zM,maxZ:zM+dM,name:r.a||'rack',passable:pass});
      });
      if(layoutData.zones) layoutData.zones.forEach(function(z){
        var wM=toM(z.w),dM=toM(z.h),xM=toM(z.x),zM=toM(z.y);
        // 모든 배치된 존을 충돌 대상으로 등록
        colliders.push({minX:xM,maxX:xM+wM,minZ:zM,maxZ:zM+dM,name:z.n});
      });
      // 벽 충돌 (L자 건물 외곽 — 벗어나지 못하도록)
      var wallThick=0.05;
      // 하단벽(z=0), 우측벽(x=whw, z<jy), 상단벽z=jy(x>rx), 내벽x=rx(z>jy), 상단벽z=whh(x<rx), 좌측벽x=0
      colliders.push({minX:-wallThick,maxX:whw+wallThick,minZ:-wallThick-0.5,maxZ:-wallThick,name:'wall-bottom'});
      colliders.push({minX:whw,maxX:whw+wallThick,minZ:-wallThick,maxZ:jy+wallThick,name:'wall-right'});
      colliders.push({minX:rx,maxX:whw+wallThick,minZ:jy,maxZ:jy+wallThick,name:'wall-step-h'});
      colliders.push({minX:rx,maxX:rx+wallThick,minZ:jy,maxZ:whh+wallThick,name:'wall-step-v'});
      colliders.push({minX:-wallThick,maxX:rx+wallThick,minZ:whh,maxZ:whh+wallThick,name:'wall-top'});
      colliders.push({minX:-wallThick-0.5,maxX:-wallThick,minZ:-wallThick,maxZ:whh+wallThick,name:'wall-left'});

      // --- 자키 + 파렛트 3D 모델 생성 ---
      var jackGroup = new THREE.Group();
      jackGroup.visible = false;
      // 파렛트: 1100×1100mm, 높이 150mm
      var palletW=1.1, palletD=1.1, palletH=0.15;
      var palletMesh = new THREE.Mesh(
        new THREE.BoxGeometry(palletW,palletH,palletD),
        new THREE.MeshStandardMaterial({color:0xc4a035,roughness:0.8})
      );
      palletMesh.position.y=palletH/2;
      palletMesh.castShadow=true;
      jackGroup.add(palletMesh);
      // 파렛트 엣지
      var palletEdge=new THREE.LineSegments(
        new THREE.EdgesGeometry(new THREE.BoxGeometry(palletW,palletH,palletD)),
        new THREE.LineBasicMaterial({color:0x8b6914})
      );
      palletEdge.position.copy(palletMesh.position);
      jackGroup.add(palletEdge);
      // 핸드잭 포크 2개: 파렛트 아래에 들어감 (폭150mm×길이1000mm×높이50mm)
      var forkW=0.15, forkD=1.0, forkH=0.05;
      var forkMat=new THREE.MeshStandardMaterial({color:0x4a90d9,roughness:0.4,metalness:0.6});
      var forkL=new THREE.Mesh(new THREE.BoxGeometry(forkW,forkH,forkD),forkMat);
      forkL.position.set(-0.17,forkH/2,0.05);// 파렛트 아래 좌측
      jackGroup.add(forkL);
      var forkR=new THREE.Mesh(new THREE.BoxGeometry(forkW,forkH,forkD),forkMat);
      forkR.position.set(0.17,forkH/2,0.05);// 파렛트 아래 우측
      jackGroup.add(forkR);
      // 펌프 본체: 파렛트 뒤에 (폭450mm×길이300mm×높이200mm)
      var pumpW=0.45, pumpD=0.3, pumpH=0.2;
      var pumpMesh=new THREE.Mesh(
        new THREE.BoxGeometry(pumpW,pumpH,pumpD),
        new THREE.MeshStandardMaterial({color:0x3b78c4,roughness:0.3,metalness:0.7})
      );
      pumpMesh.position.set(0,pumpH/2,-palletD/2-pumpD/2);
      pumpMesh.castShadow=true;
      jackGroup.add(pumpMesh);
      // 핸들 (수직 봉 + 가로 손잡이)
      var handleMesh = new THREE.Mesh(
        new THREE.CylinderGeometry(0.02,0.02,0.8,8),
        new THREE.MeshStandardMaterial({color:0x666666,metalness:0.8})
      );
      handleMesh.position.set(0,0.5,-palletD/2-pumpD);
      jackGroup.add(handleMesh);
      // 핸들 가로 손잡이
      var handleGrip=new THREE.Mesh(
        new THREE.CylinderGeometry(0.015,0.015,0.35,8),
        new THREE.MeshStandardMaterial({color:0x444444,metalness:0.6})
      );
      handleGrip.rotation.z=Math.PI/2;
      handleGrip.position.set(0,0.9,-palletD/2-pumpD);
      jackGroup.add(handleGrip);
      // 충돌 바운딩 표시 (파렛트 + 뒤쪽 펌프만)
      var totalD=palletD+pumpD;// 1.1+0.3=1.4m
      var jackBoundVis = new THREE.Mesh(
        new THREE.BoxGeometry(palletW+0.05,0.02,totalD+0.05),
        new THREE.MeshBasicMaterial({color:0x00ff00,transparent:true,opacity:0.2,side:THREE.DoubleSide})
      );
      jackBoundVis.position.set(0,0.01,-pumpD/2);
      jackGroup.add(jackBoundVis);
      scene.add(jackGroup);

      // --- 클리어런스 측정 라인 (좌/우) ---
      var clearLineL = new THREE.Line(
        new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0.3,0),new THREE.Vector3(-1,0.3,0)]),
        new THREE.LineBasicMaterial({color:0x00ff00,linewidth:2})
      );clearLineL.visible=false;scene.add(clearLineL);
      var clearLineR = new THREE.Line(
        new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0.3,0),new THREE.Vector3(1,0.3,0)]),
        new THREE.LineBasicMaterial({color:0x00ff00,linewidth:2})
      );clearLineR.visible=false;scene.add(clearLineR);
      // 전방 클리어런스 라인
      var clearLineF = new THREE.Line(
        new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0.3,0),new THREE.Vector3(0,0.3,1)]),
        new THREE.LineBasicMaterial({color:0x00ff00,linewidth:2})
      );clearLineF.visible=false;scene.add(clearLineF);

      // 3D 거리 라벨 함수
      function makeDynLabel(){
        var cW=256,cH=64;
        var c=document.createElement('canvas');c.width=cW;c.height=cH;
        var tex=new THREE.CanvasTexture(c);tex.minFilter=THREE.LinearFilter;
        var sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,depthWrite:false,depthTest:false,transparent:true}));
        sp.scale.set(1.2,0.3,1);sp.visible=false;
        scene.add(sp);
        return {sprite:sp,canvas:c,texture:tex};
      }
      var labelL=makeDynLabel(),labelR=makeDynLabel(),labelF=makeDynLabel();

      // --- 랙 근접 정보 표시 ---
      var SERIES_NAMES={mx48:'Maxwell48',mx16:'Maxwell16',hsm:'HSM',semi:'Semi Goods',spare:'Spare',etc:'E3/D2'};
      var SERIES_HEX={mx48:'#ef4444',mx16:'#3b82f6',hsm:'#d97706',semi:'#eab308',spare:'#7c3aed',etc:'#06b6d4'};
      // 랙 위치 데이터 (3D 좌표 + 메타)
      var rackInfos=[];
      if(layoutData.R) layoutData.R.forEach(function(r){
        var nm=(r.a||'').toUpperCase();
        if(nm.indexOf('DOOR')>=0||nm.indexOf('PILLAR')>=0||nm.indexOf('PLT')>=0||r.t==='custom') return;
        var rp=rpx3d(r),wM=toM(rp.w),dM=toM(rp.h);
        var xM=toM(r.x-BX3D)+wM/2,zM=toM(r.y-BY3D)+dM/2;
        rackInfos.push({x:xM,z:zM,name:r.a||'',series:r.s||'etc',bins:r.b||0});
      });
      // 근접 랙 라벨 (최대 3개)
      var rackLabels=[];
      for(var ri=0;ri<3;ri++){
        var rlc=document.createElement('canvas');rlc.width=512;rlc.height=64;
        var rlTex=new THREE.CanvasTexture(rlc);rlTex.minFilter=THREE.LinearFilter;
        var rlSp=new THREE.Sprite(new THREE.SpriteMaterial({map:rlTex,depthWrite:false,depthTest:false,transparent:true}));
        rlSp.scale.set(2.4,0.5,1);rlSp.visible=false;scene.add(rlSp);
        rackLabels.push({sprite:rlSp,canvas:rlc,texture:rlTex});
      }
      function updateDynLabel(lb,text,color,x,y,z){
        var ctx=lb.canvas.getContext('2d');
        var cW=lb.canvas.width,cH=lb.canvas.height;
        ctx.clearRect(0,0,cW,cH);
        ctx.fillStyle='rgba(0,0,0,0.75)';
        ctx.fillRect(8,6,cW-16,cH-12);
        // 자동 폰트 크기 (텍스트 길이에 맞춤)
        var fs=28;
        ctx.font='bold '+fs+'px monospace';
        while(ctx.measureText(text).width>cW-24&&fs>12){fs-=2;ctx.font='bold '+fs+'px monospace';}
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillStyle=color;ctx.fillText(text,cW/2,cH/2);
        lb.texture.needsUpdate=true;
        lb.sprite.position.set(x,y,z);
        lb.sprite.visible=true;
      }

      // --- 워크스루 상태 ---
      var walkState = {
        active: false,
        posX: 0, posZ: 0,
        angle: Math.PI/2,
        speed: 0.06,
        turnSpeed: 0.04,
        keys: {w:false,a:false,s:false,d:false,q:false,e:false},
        colliding: false,
        nearestL: 999, nearestR: 999, nearestF: 999,
        collideName: '',
        camTheta: 0, camPhi: 0.35, camDist: 4,
        nearRack: '',
        // 미니맵용 창고 치수 (미터)
        whw:whw, whh:whh, jy:jy, rx:rx,
        colliders: colliders
      };
      view3dWalkRef.current = walkState;

      // 자키의 AABB 구하기 (월드좌표)
      function getJackAABB(px,pz,ang){
        // 자키+파렛트 합산: 폭 1.1m, 길이 1.4m (파렛트1.1 + 펌프0.3)
        var hw=palletW/2+0.05, hd=(palletD+pumpD)/2+0.05;// 반폭, 반길이
        // 회전된 4개 코너의 AABB
        var cos=Math.cos(ang),sin=Math.sin(ang);
        var corners=[[-hw,-hd],[hw,-hd],[hw,hd],[-hw,hd]];
        var mnX=1e9,mxX=-1e9,mnZ=1e9,mxZ=-1e9;
        corners.forEach(function(c){
          var rx=c[0]*cos-c[1]*sin+px;
          var rz=c[0]*sin+c[1]*cos+pz;
          if(rx<mnX)mnX=rx;if(rx>mxX)mxX=rx;
          if(rz<mnZ)mnZ=rz;if(rz>mxZ)mxZ=rz;
        });
        return {minX:mnX,maxX:mxX,minZ:mnZ,maxZ:mxZ};
      }

      // 충돌 검사
      function checkCollision(px,pz,ang){
        var bb=getJackAABB(px,pz,ang);
        for(var i=0;i<colliders.length;i++){
          var c=colliders[i];
          if(c.passable) continue;// DOOR/PLT는 통과 가능
          if(bb.maxX>c.minX&&bb.minX<c.maxX&&bb.maxZ>c.minZ&&bb.minZ<c.maxZ){
            return {hit:true,name:c.name};
          }
        }
        return {hit:false,name:''};
      }

      // 좌우/전방 클리어런스 계산 (레이캐스트)
      function calcClearance(px,pz,ang){
        var cos=Math.cos(ang),sin=Math.sin(ang);
        var leftDir=[-cos,-sin];
        var rightDir=[cos,sin];
        var fwdDir=[Math.sin(ang),Math.cos(ang)];
        var hw=palletW/2+0.05;
        var lEdgeX=px+leftDir[0]*hw, lEdgeZ=pz+leftDir[1]*hw;
        var rEdgeX=px+rightDir[0]*hw, rEdgeZ=pz+rightDir[1]*hw;
        var fEdgeX=px+fwdDir[0]*(palletD/2+0.1), fEdgeZ=pz+fwdDir[1]*(palletD/2+0.1);
        var nearL=raycastAll(lEdgeX,lEdgeZ,leftDir);
        var nearR=raycastAll(rEdgeX,rEdgeZ,rightDir);
        var nearF=raycastAll(fEdgeX,fEdgeZ,fwdDir);
        return {l:nearL,r:nearR,f:nearF};
      }

      // 모든 collider + 건물 경계에 대한 레이캐스트
      function raycastAll(ox,oz,dir){
        var minD=999;
        // 1) 건물 경계선에 대한 레이캐스트 (L자 형태 6개 변)
        var segs=[[0,0,whw,0],[whw,0,whw,jy],[whw,jy,rx,jy],[rx,jy,rx,whh],[rx,whh,0,whh],[0,whh,0,0]];
        segs.forEach(function(s){
          var d=raySegment(ox,oz,dir[0],dir[1],s[0],s[1],s[2],s[3]);
          if(d>0&&d<minD) minD=d;
        });
        // 2) 장애물 박스에 대한 AABB 레이캐스트
        colliders.forEach(function(c){
          if(c.name&&c.name.indexOf('wall')===0) return;// 벽 collider는 이미 경계선으로 처리
          var d=rayAABB(ox,oz,dir,c);
          if(d>0&&d<minD) minD=d;
        });
        return minD;
      }

      // 레이 vs 선분 교차 (2D)
      function raySegment(ox,oz,dx,dz,ax,az,bx,bz){
        var sx=bx-ax,sz=bz-az;
        var denom=dx*sz-dz*sx;
        if(Math.abs(denom)<1e-8) return 999;// 평행
        var t=((ax-ox)*sz-(az-oz)*sx)/denom;
        var u=((ax-ox)*dz-(az-oz)*dx)/denom;
        if(t>0.001&&u>=0&&u<=1) return t;
        return 999;
      }

      // 레이 vs AABB 교차 (2D)
      function rayAABB(ox,oz,dir,box){
        var tmin=-1e9,tmax=1e9;
        // X slab
        if(Math.abs(dir[0])>1e-8){
          var t1=(box.minX-ox)/dir[0],t2=(box.maxX-ox)/dir[0];
          if(t1>t2){var tmp=t1;t1=t2;t2=tmp;}
          tmin=Math.max(tmin,t1);tmax=Math.min(tmax,t2);
        } else {
          if(ox<box.minX||ox>box.maxX) return 999;
        }
        // Z slab
        if(Math.abs(dir[1])>1e-8){
          var t3=(box.minZ-oz)/dir[1],t4=(box.maxZ-oz)/dir[1];
          if(t3>t4){var tmp2=t3;t3=t4;t4=tmp2;}
          tmin=Math.max(tmin,t3);tmax=Math.min(tmax,t4);
        } else {
          if(oz<box.minZ||oz>box.maxZ) return 999;
        }
        if(tmax<0||tmin>tmax) return 999;
        return tmin>0?tmin:tmax>0?tmax:999;
      }

      // 워크스루 업데이트 (매 프레임)
      function updateWalkthrough(){
        if(!walkState.active)return;
        var k=walkState.keys;
        var newX=walkState.posX, newZ=walkState.posZ, newAng=walkState.angle;
        // 회전
        if(k.q) newAng+=walkState.turnSpeed;
        if(k.e) newAng-=walkState.turnSpeed;
        // 전진/후진
        var fwdX=Math.sin(newAng),fwdZ=Math.cos(newAng);
        if(k.w){newX+=fwdX*walkState.speed;newZ+=fwdZ*walkState.speed;}
        if(k.s){newX-=fwdX*walkState.speed;newZ-=fwdZ*walkState.speed;}
        // 좌우 이동 (스트레이프)
        var sideX=Math.cos(newAng),sideZ=-Math.sin(newAng);
        if(k.a){newX+=sideX*walkState.speed;newZ+=sideZ*walkState.speed;}
        if(k.d){newX-=sideX*walkState.speed;newZ-=sideZ*walkState.speed;}

        // 충돌 검사 (슬라이딩 + 끼임 탈출)
        var col=checkCollision(newX,newZ,newAng);
        if(!col.hit){
          // 이동 성공
          walkState.colliding=false;walkState.collideName='';
          walkState.posX=newX;walkState.posZ=newZ;walkState.angle=newAng;
          jackBoundVis.material.color.setHex(0x00ff00);jackBoundVis.material.opacity=0.2;
        } else {
          // X축만 이동 시도 (벽을 따라 미끄러짐)
          var colX=checkCollision(newX,walkState.posZ,newAng);
          var colZ=checkCollision(walkState.posX,newZ,newAng);
          if(!colX.hit){
            walkState.posX=newX;walkState.angle=newAng;
            walkState.colliding=false;walkState.collideName='';
            jackBoundVis.material.color.setHex(0xffaa00);jackBoundVis.material.opacity=0.3;
          } else if(!colZ.hit){
            walkState.posZ=newZ;walkState.angle=newAng;
            walkState.colliding=false;walkState.collideName='';
            jackBoundVis.material.color.setHex(0xffaa00);jackBoundVis.material.opacity=0.3;
          } else {
            // 끼임 상태: 가장 가까운 장애물 반대 방향으로 밀어내기 시도
            walkState.angle=newAng;// 회전은 항상 허용
            var bb=getJackAABB(walkState.posX,walkState.posZ,newAng);
            var pushX=0,pushZ=0,pushCount=0;
            for(var ci=0;ci<colliders.length;ci++){
              var c=colliders[ci];
              if(c.passable) continue;
              if(bb.maxX>c.minX&&bb.minX<c.maxX&&bb.maxZ>c.minZ&&bb.minZ<c.maxZ){
                // 겹치는 충돌체에서 밀어내기 방향 계산
                var cx=(c.minX+c.maxX)/2,cz=(c.minZ+c.maxZ)/2;
                var dx=walkState.posX-cx,dz=walkState.posZ-cz;
                var dl=Math.sqrt(dx*dx+dz*dz)||1;
                pushX+=dx/dl;pushZ+=dz/dl;pushCount++;
              }
            }
            if(pushCount>0){
              pushX/=pushCount;pushZ/=pushCount;
              var pushSpd=walkState.speed*0.8;
              var tryX=walkState.posX+pushX*pushSpd;
              var tryZ=walkState.posZ+pushZ*pushSpd;
              if(!checkCollision(tryX,tryZ,newAng).hit){
                walkState.posX=tryX;walkState.posZ=tryZ;
                walkState.colliding=false;walkState.collideName='';
                jackBoundVis.material.color.setHex(0xff8800);jackBoundVis.material.opacity=0.3;
              } else {
                walkState.colliding=true;walkState.collideName=col.name;
                jackBoundVis.material.color.setHex(0xff0000);jackBoundVis.material.opacity=0.4;
              }
            } else {
              walkState.colliding=true;walkState.collideName=col.name;
              jackBoundVis.material.color.setHex(0xff0000);jackBoundVis.material.opacity=0.4;
            }
          }
        }

        // 모델 위치 업데이트
        jackGroup.position.set(walkState.posX,0,walkState.posZ);
        jackGroup.rotation.y=walkState.angle;

        // 클리어런스 계산
        var cl=calcClearance(walkState.posX,walkState.posZ,walkState.angle);
        walkState.nearestL=cl.l;walkState.nearestR=cl.r;walkState.nearestF=cl.f;

        // 클리어런스 라인 업데이트
        var cos=Math.cos(walkState.angle),sin=Math.sin(walkState.angle);
        var leftDir=[-cos,-sin],rightDir=[cos,sin];
        var hw=palletW/2+0.05;
        var lx=walkState.posX+leftDir[0]*hw,lz=walkState.posZ+leftDir[1]*hw;
        var rx2=walkState.posX+rightDir[0]*hw,rz2=walkState.posZ+rightDir[1]*hw;
        var dL=Math.min(cl.l,3),dR=Math.min(cl.r,3);
        clearLineL.geometry.dispose();
        clearLineL.geometry=new THREE.BufferGeometry().setFromPoints([
          new THREE.Vector3(lx,0.3,lz),
          new THREE.Vector3(lx+leftDir[0]*dL,0.3,lz+leftDir[1]*dL)
        ]);
        clearLineL.material.color.setHex(cl.l<0.3?0xff0000:cl.l<0.5?0xffaa00:0x00ff00);
        clearLineR.geometry.dispose();
        clearLineR.geometry=new THREE.BufferGeometry().setFromPoints([
          new THREE.Vector3(rx2,0.3,rz2),
          new THREE.Vector3(rx2+rightDir[0]*dR,0.3,rz2+rightDir[1]*dR)
        ]);
        clearLineR.material.color.setHex(cl.r<0.3?0xff0000:cl.r<0.5?0xffaa00:0x00ff00);
        // 전방 클리어런스 라인
        var fwdDirV=[Math.sin(walkState.angle),Math.cos(walkState.angle)];
        var fEdge=palletD/2+0.1;
        var fx=walkState.posX+fwdDirV[0]*fEdge,fz=walkState.posZ+fwdDirV[1]*fEdge;
        var dF=Math.min(cl.f,3);
        clearLineF.geometry.dispose();
        clearLineF.geometry=new THREE.BufferGeometry().setFromPoints([
          new THREE.Vector3(fx,0.3,fz),
          new THREE.Vector3(fx+fwdDirV[0]*dF,0.3,fz+fwdDirV[1]*dF)
        ]);
        clearLineF.material.color.setHex(cl.f<0.3?0xff0000:cl.f<0.5?0xffaa00:0x00ff00);
        // 3D 거리 라벨 업데이트
        var fmtD=function(d){return d>=100?'∞':Math.round(d*1000)+'mm';};
        var clrHex=function(d){return d<0.3?'#f87171':d<0.5?'#fbbf24':'#4ade80';};
        updateDynLabel(labelL,'◀ '+fmtD(cl.l),clrHex(cl.l),lx+leftDir[0]*Math.min(dL,1.5),0.6,lz+leftDir[1]*Math.min(dL,1.5));
        updateDynLabel(labelR,fmtD(cl.r)+' ▶',clrHex(cl.r),rx2+rightDir[0]*Math.min(dR,1.5),0.6,rz2+rightDir[1]*Math.min(dR,1.5));
        updateDynLabel(labelF,'▲ '+fmtD(cl.f),clrHex(cl.f),fx+fwdDirV[0]*Math.min(dF,1.5),0.6,fz+fwdDirV[1]*Math.min(dF,1.5));

        // 근접 랙 정보 표시 (2m 이내)
        var nearRacks=[];
        rackInfos.forEach(function(ri){
          var dx=ri.x-walkState.posX,dz=ri.z-walkState.posZ;
          var dist2=Math.sqrt(dx*dx+dz*dz);
          if(dist2<2.5) nearRacks.push({info:ri,dist:dist2});
        });
        nearRacks.sort(function(a,b){return a.dist-b.dist;});
        for(var rli=0;rli<3;rli++){
          if(rli<nearRacks.length){
            var nr=nearRacks[rli];
            var sName=SERIES_NAMES[nr.info.series]||nr.info.series;
            var sCol=SERIES_HEX[nr.info.series]||'#ffffff';
            var txt=SERIES_NAMES[nr.info.series]||nr.info.series;
            updateDynLabel(rackLabels[rli],txt,sCol,nr.info.x,2.2,nr.info.z);
          } else {
            rackLabels[rli].sprite.visible=false;
          }
        }
        walkState.nearRack=nearRacks.length>0?(SERIES_NAMES[nearRacks[0].info.series]||nearRacks[0].info.series):'';

        // 카메라: 3인칭 팔로우 (마우스로 시점 변경 가능)
        var camH=walkState.camDist*Math.sin(walkState.camPhi);
        var camHoriz=walkState.camDist*Math.cos(walkState.camPhi);
        var totalAng=walkState.angle+walkState.camTheta;
        var behindX=walkState.posX-Math.sin(totalAng)*camHoriz;
        var behindZ=walkState.posZ-Math.cos(totalAng)*camHoriz;
        camera.position.set(behindX,camH,behindZ);
        camera.lookAt(walkState.posX,0.5,walkState.posZ);
      }

      // 워크스루 시작 위치: 첫 번째 DOOR 아래 통로 중앙
      var startDoor=null;
      if(layoutData.R){
        var allDoors2=layoutData.R.filter(function(r){return (r.a||'').toUpperCase().indexOf('DOOR')>=0;});
        startDoor=allDoors2.length>0?allDoors2.reduce(function(a,b){return a.y<b.y?a:b;}):null;
      }
      // DOOR 위치에서 창고 안쪽으로 5m, Packaging Foam과 Injection 사이 통로 중앙
      var walkStartX=startDoor?toM(startDoor.x-BX3D)+toM(rpx3d(startDoor).w)/2:3;
      var walkStartZ=startDoor?toM(startDoor.y-BY3D)+5:5;
      // 충돌 없는 스폰 지점 찾기 (나선형 탐색)
      function findSafeSpawn(cx,cz){
        var ang=Math.PI/2;
        if(!checkCollision(cx,cz,ang).hit) return {x:cx,z:cz};
        for(var r=0.5;r<=5;r+=0.5){
          for(var a=0;a<Math.PI*2;a+=Math.PI/6){
            var tx=cx+Math.cos(a)*r, tz=cz+Math.sin(a)*r;
            if(!checkCollision(tx,tz,ang).hit) return {x:tx,z:tz};
          }
        }
        return {x:cx+3,z:cz+3};// fallback
      }
      var safeSpawn=findSafeSpawn(walkStartX,walkStartZ);
      walkStartX=safeSpawn.x; walkStartZ=safeSpawn.z;

      // 토글 함수 노출
      view3dCtrlRef.current.toggleWalk = function(){
        walkState.active=!walkState.active;
        jackGroup.visible=walkState.active;
        clearLineL.visible=walkState.active;
        clearLineR.visible=walkState.active;
        clearLineF.visible=walkState.active;
        labelL.sprite.visible=walkState.active;
        labelR.sprite.visible=walkState.active;
        labelF.sprite.visible=walkState.active;
        rackLabels.forEach(function(rl){rl.sprite.visible=false;});
        if(walkState.active){
          var sp=findSafeSpawn(walkStartX,walkStartZ);
          walkState.posX=sp.x;walkState.posZ=sp.z;
          walkState.angle=0;// 오른쪽(+Z 방향, 창고 안쪽)
          walkState.keys={w:false,a:false,s:false,d:false,q:false,e:false};
          walkState.colliding=false;walkState.collideName='';
          walkState.camTheta=0;walkState.camPhi=0.35;walkState.camDist=4;
          jackGroup.position.set(walkState.posX,0,walkState.posZ);
          jackGroup.rotation.y=walkState.angle;
        } else {
          // 오빗 모드로 복원
          theta=0.8;phi=0.5;dist=35;target.set(whw/2,0,whh/3);
          updateCam();
        }
        return walkState.active;
      };
      view3dCtrlRef.current.getWalkState = function(){return walkState;};
      view3dCtrlRef.current.resetWalkCam = function(){
        walkState.camTheta=0;walkState.camPhi=0.35;walkState.camDist=4;
      };
      view3dCtrlRef.current.resetWalkPos = function(){
        var sp=findSafeSpawn(walkStartX,walkStartZ);
        walkState.posX=sp.x;walkState.posZ=sp.z;
        walkState.angle=0;
        walkState.colliding=false;walkState.collideName='';
        jackGroup.position.set(walkState.posX,0,walkState.posZ);
        jackGroup.rotation.y=walkState.angle;
      };
      // 스크린샷 캡처
      view3dCtrlRef.current.captureScreenshot = function(){
        renderer.render(scene,camera);
        try{
          cv.toBlob(function(blob){
            if(!blob)return;
            var url=URL.createObjectURL(blob);
            var a=document.createElement('a');
            a.href=url;
            var now=new Date();
            var pad=function(n){return n<10?'0'+n:''+n;};
            a.download='warehouse_3d_'+now.getFullYear()+pad(now.getMonth()+1)+pad(now.getDate())+'_'+pad(now.getHours())+pad(now.getMinutes())+'.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(function(){URL.revokeObjectURL(url);},1000);
          },'image/png');
        }catch(e){
          // fallback: 새 탭에 이미지 열기
          var dataUrl=cv.toDataURL('image/png');
          window.open(dataUrl,'_blank');
        }
      };

      const animate=()=>{if(!view3dSceneRef.current)return;requestAnimationFrame(animate);updateWalkthrough();renderer.render(scene,camera);};
      animate();
    };
    if(!window.THREE){const sc=document.createElement('script');sc.src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';sc.onload=loadAndInit;document.head.appendChild(sc);}else{loadAndInit();}
    return () => {
      if(view3dKeyRef.current){window.removeEventListener('keydown',view3dKeyRef.current.down);window.removeEventListener('keyup',view3dKeyRef.current.up);view3dKeyRef.current=null;}
      if(view3dWalkRef.current){view3dWalkRef.current.active=false;view3dWalkRef.current=null;}
      if(view3dSceneRef.current){view3dSceneRef.current.renderer.dispose();view3dSceneRef.current=null;}
    };
  }, [activeTab, layoutData]);

  const [rackDetailModal, setRackDetailModal] = useState(null); // 'items', 'stock', 'weight', 'bins'

  // 백업 모달
  const [showBackupModal, setShowBackupModal] = useState(false);
  const [backupData, setBackupData] = useState('');

  // 모델별/Sub-component 생산 가능 대수 상세 모달
  const [showModelDetailModal, setShowModelDetailModal] = useState(null); // 'excess', 'normal', 'caution', 'urgent'
  const [showSubcomDetailModal, setShowSubcomDetailModal] = useState(null);
  const [showShortageDetailModal, setShowShortageDetailModal] = useState(null); // 'critical', 'high', 'withPO', 'noPO' // 'excess', 'normal', 'caution', 'urgent'

  // Cycle Time 그래프 설정
  const [showGraphModal, setShowGraphModal] = useState(false);
  const [graphDateRange, setGraphDateRange] = useState({ start: '', end: '' });
  const [graphViewType, setGraphViewType] = useState('monthly'); // 'monthly', 'daily', 'custom'
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

  // TO DO 뷰 모드
  const [todoViewMode, setTodoViewMode] = useState('list'); // 'list' or 'calendar'
  // URL 파라미터 지원
  const urlParams = useMemo(() => {
    try { return new URLSearchParams(window.location.search); } catch(e) { return new URLSearchParams(); }
  }, []);
  const [locateSearch, setLocateSearch] = useState(urlParams.get('q') || '');
  const [locateQuery, setLocateQuery] = useState(urlParams.get('q') || '');
  const [calendarMonth, setCalendarMonth] = useState(new Date());
  const [selectedCalendarTodo, setSelectedCalendarTodo] = useState(null);
  const [selectedCategory, setSelectedCategory] = useState(null);

  // 온습도 Excel 내보내기 모달
  const [showTempHumidityExportModal, setShowTempHumidityExportModal] = useState(false);

  // 온습도 관리 상태
  const [tempHumidityData, setTempHumidityData] = useState(() => {
    const saved = safeStorage.getItem('pbk_temp_humidity_data');
    const savedData = saved ? JSON.parse(saved) : {};
    // 과거 데이터와 사용자 입력 데이터 병합 (사용자 입력이 우선)
    return { ...HISTORICAL_TEMP_HUMIDITY_DATA, ...savedData };
  });
  const [tempHumidityMonth, setTempHumidityMonth] = useState(() => {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  });
  const [tempHumidityRecorder, setTempHumidityRecorder] = useState(() => {
    return safeStorage.getItem('pbk_temp_humidity_recorder') || 'JM. Jung';
  });

  // 삭제 확인 모달
  const [deleteConfirm, setDeleteConfirm] = useState({ show: false, type: '', id: null, text: '', count: 0 });

  // ========== v15 신규 기능 ==========
  
  // 다크 모드
  const [darkMode, setDarkMode] = useState(() => {
    const saved = safeStorage.getItem('pbk_dark_mode');
    return saved ? JSON.parse(saved) : false;
  });
  
  // 알림 센터
  const [showNotificationCenter, setShowNotificationCenter] = useState(false);
  const [notifications, setNotifications] = useState(() => {
    const saved = safeStorage.getItem('pbk_notifications');
    return saved ? JSON.parse(saved) : [];
  });
  
  // 토스트 메시지 (자동 저장 표시)
  const [toasts, setToasts] = useState([]);
  
  // 로딩 상태 (loadingText만 추가, isLoading은 기존 것 사용)
  const [loadingText, setLoadingText] = useState('');
  
  // 데이터 업로드 히스토리
  const [dataHistory, setDataHistory] = useState(() => {
    const saved = safeStorage.getItem('pbk_data_history');
    return saved ? JSON.parse(saved) : [];
  });
  const [showHistoryModal, setShowHistoryModal] = useState(false);
  
  // 단축키 도움말 모달
  const [showShortcutHelp, setShowShortcutHelp] = useState(false);
  
  // 공간 최적화 리포트 모달
  const [showSpaceOptimizationModal, setShowSpaceOptimizationModal] = useState(false);
  const [showSeriesCards, setShowSeriesCards] = useState(false); // 기본 접힘
  const [showDetailSection, setShowDetailSection] = useState(false); // 상세 정보 접힘

  // ========== KPI 관리 ==========
  // GR Cancel 기본 데이터 (Movement Type 102 기준)
  // GR Cancel 기본값 (SUM 시트 기준 확정 데이터)
  const DEFAULT_GR_CANCEL_DATA = {
    '2024-01': 1, '2024-02': 0, '2024-03': 0, '2024-04': 0, '2024-05': 0, '2024-06': 0,
    '2024-07': 0, '2024-08': 0, '2024-09': 0, '2024-10': 1, '2024-11': 0, '2024-12': 0,
    '2025-01': 0, '2025-02': 0, '2025-03': 0, '2025-04': 0, '2025-05': 0, '2025-06': 0,
    '2025-07': 0, '2025-08': 0, '2025-09': 1, '2025-10': 0, '2025-11': 0, '2025-12': 0,
    '2026-01': 0
  };
  // GR Qty 기본값 (SUM 시트 기준 확정 데이터) - 엑셀 업로드 시 덮어씌워짐
  const DEFAULT_GR_CANCEL_QTY = {
    '2024-01': 91,  '2024-02': 201, '2024-03': 123, '2024-04': 68,  '2024-05': 65,  '2024-06': 110,
    '2024-07': 114, '2024-08': 85,  '2024-09': 107, '2024-10': 108, '2024-11': 167, '2024-12': 138,
    '2025-01': 83,  '2025-02': 0,   '2025-03': 0,   '2025-04': 0,   '2025-05': 0,   '2025-06': 0,
    '2025-07': 0,   '2025-08': 0,   '2025-09': 0,   '2025-10': 0,   '2025-11': 0,   '2025-12': 0,
    '2026-01': 83
  };
  
  const [kpiData, setKpiData] = useState(() => {
    const saved = safeStorage.getItem('pbk_kpi_data');
    if (saved) {
      const parsed = JSON.parse(saved);
      return {
        grCancel: { ...DEFAULT_GR_CANCEL_DATA, ...parsed.grCancel },
        grCancelQty: { ...DEFAULT_GR_CANCEL_QTY, ...parsed.grCancelQty },
        inventoryAdjust: parsed.inventoryAdjust || {}
      };
    }
    return {
      grCancel: DEFAULT_GR_CANCEL_DATA,
      grCancelQty: DEFAULT_GR_CANCEL_QTY,
      inventoryAdjust: {}
    };
  });

  // v17: GR Cancel 엑셀 업로드 상태
  const [grCancelUploadStatus, setGrCancelUploadStatus] = useState(null); // null | 'loading' | 'success' | 'error'
  const [grCancelUploadMsg, setGrCancelUploadMsg] = useState('');
  const [inventoryLossUploadStatus, setInventoryLossUploadStatus] = useState(null);
  const [inventoryLossUploadMsg, setInventoryLossUploadMsg] = useState('');

  const [showKpiInputModal, setShowKpiInputModal] = useState(false);
  const [kpiInputMonth, setKpiInputMonth] = useState(new Date().toISOString().slice(0, 7));
  const [kpiInputType, setKpiInputType] = useState('grCancel'); // 'grCancel' or 'inventoryAdjust'
  const [kpiSelectedYear, setKpiSelectedYear] = useState(new Date().getFullYear()); // KPI 연도 선택

  // KPI 점수 계산 함수
  const KPI_SCORE_TABLE = {
    grCancel: [
      { score: 100, max: 0 },
      { score: 90, max: 1 },
      { score: 80, max: 2 },
      { score: 70, max: 3 },
      { score: 60, max: 4 },
      { score: 50, max: 5 },
      { score: 40, max: 6 },
      { score: 30, max: 7 },
      { score: 20, max: 8 },
      { score: 10, max: 9 },
    ],
    inventoryAdjust: [
      { score: 100, max: 0.02 },
      { score: 90, max: 0.04 },
      { score: 80, max: 0.064 },
      { score: 70, max: 0.08 },
      { score: 60, max: 0.10 },
      { score: 50, max: 0.12 },
      { score: 40, max: 0.14 },
      { score: 30, max: 0.16 },
      { score: 20, max: 0.18 },
      { score: 10, max: 0.20 },
    ],
    kittingLeadTime: [
      { score: 100, max: 2 },
      { score: 90, max: 2.5 },
      { score: 80, max: 3 },
      { score: 70, max: 4 },
      { score: 60, max: 4.5 },
      { score: 50, max: 5 },
      { score: 40, max: 5.5 },
      { score: 30, max: 6 },
      { score: 20, max: 6.5 },
      { score: 10, max: 7 },
    ],
  };

  const calculateKpiScore = (type, value) => {
    if (value === null || value === undefined) return null;
    const table = KPI_SCORE_TABLE[type];
    if (!table) return null;
    
    for (const row of table) {
      if (value <= row.max) return row.score;
    }
    return 10; // 최저 점수
  };

  // ========== 상태별 색상 정의 (일관성) ==========
  const STATUS_COLORS = {
    danger: { bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-500', badge: 'bg-red-500' },
    warning: { bg: 'bg-amber-100', text: 'text-amber-700', border: 'border-amber-500', badge: 'bg-amber-500' },
    success: { bg: 'bg-emerald-100', text: 'text-emerald-700', border: 'border-emerald-500', badge: 'bg-emerald-500' },
    info: { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-500', badge: 'bg-blue-500' },
    neutral: { bg: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-500', badge: 'bg-gray-500' }
  };

  // safeStorage에 저장
  useEffect(() => {
    safeStorage.setItem('pbk_pick_cycles', JSON.stringify(pickCycles));
  }, [pickCycles]);

  // 마운트 시 완료된 pickCycles의 cycleMin을 영업시간 기준으로 재계산
  useEffect(() => {
    setPickCycles(prev => {
      let changed = false;
      const updated = prev.map(p => {
        if (p.status === 'completed' && p.startTime && p.completed) {
          const oldMin = p.cycleMin || 0;
          // 간단한 영업시간 계산 (calculateWorkingMinutes가 아직 안 됨 → 인라인)
          const start = new Date(p.startTime);
          const end = new Date(p.completed);
          if (!isNaN(start.getTime()) && !isNaN(end.getTime()) && end > start) {
            let totalMin = 0;
            const cur = new Date(start);
            while (cur < end) {
              const krTime = new Date(cur.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
              const day = krTime.getDay();
              const h = krTime.getHours();
              const m = krTime.getMinutes();
              const t = h + m / 60;
              const dateStr = krTime.getFullYear() + '-' + String(krTime.getMonth()+1).padStart(2,'0') + '-' + String(krTime.getDate()).padStart(2,'0');
              const isWorkday = day >= 1 && day <= 5 && !KR_HOLIDAYS.has(dateStr);
              const isWorkHour = h >= 7 && h < 16;
              const isLunch = t >= 12.5 && t < 13.5;
              if (isWorkday && isWorkHour && !isLunch) totalMin++;
              cur.setTime(cur.getTime() + 60000);
            }
            if (Math.abs(totalMin - oldMin) > 5) {
              changed = true;
              return { ...p, cycleMin: totalMin };
            }
          }
        }
        return p;
      });
      return changed ? updated : prev;
    });
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  useEffect(() => {
    safeStorage.setItem('pbk_receive_cycles', JSON.stringify(receiveCycles));
  }, [receiveCycles]);

  useEffect(() => {
    safeStorage.setItem('pbk_kitting_data', JSON.stringify(kittingData));
  }, [kittingData]);

  // LT 재계산은 useState 초기화에서 처리됨

  useEffect(() => {
    safeStorage.setItem('pbk_todo_list', JSON.stringify(todoList));
  }, [todoList]);

  // v15: 다크모드 저장
  useEffect(() => {
    safeStorage.setItem('pbk_dark_mode', JSON.stringify(darkMode));
  }, [darkMode]);
  
  // v15: 알림 저장
  useEffect(() => {
    safeStorage.setItem('pbk_notifications', JSON.stringify(notifications));
  }, [notifications]);
  
  // v15: 데이터 히스토리 저장
  useEffect(() => {
    safeStorage.setItem('pbk_data_history', JSON.stringify(dataHistory));
  }, [dataHistory]);

  // v15: KPI 데이터 저장
  useEffect(() => {
    safeStorage.setItem('pbk_kpi_data', JSON.stringify(kpiData));
  }, [kpiData]);

  // 온습도 데이터 저장
  useEffect(() => {
    safeStorage.setItem('pbk_temp_humidity_data', JSON.stringify(tempHumidityData));
  }, [tempHumidityData]);

  useEffect(() => {
    safeStorage.setItem('pbk_temp_humidity_recorder', tempHumidityRecorder);
  }, [tempHumidityRecorder]);

  // 마감 임박/당일 할일 체크 및 알림
  useEffect(() => {
    const checkDueSoonTodos = () => {
      const today = new Date().toISOString().split('T')[0];
      const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      const dueSoon = todoList.filter(todo => 
        !todo.completed && 
        todo.dueDate && 
        (todo.dueDate === today || todo.dueDate === tomorrow || todo.dueDate < today)
      );
      
      setDueSoonTodos(dueSoon);
      
      if (dueSoon.length > 0) {
        setShowDueSoonAlert(true);
        document.title = `(${dueSoon.length}) ⚠️ Warehouse Management`;
      } else {
        document.title = 'Warehouse Management';
      }
    };
    
    checkDueSoonTodos();
    
    if ('Notification' in window) {
      setNotificationPermission(Notification.permission);
    }
  }, [todoList]);
  
  // Bin 100% 알림 확인
  useEffect(() => {
    const checkFullBins = () => {
      const full = [];
      rackSummary.forEach(rack => {
        // 각 랙의 모든 Bin 확인
        const rackBins = {};
        inventoryData.filter(item => item.rack === rack.id).forEach(item => {
          const bin = item.bin;
          if (!rackBins[bin]) {
            rackBins[bin] = { count: 0, maxCount: 10 }; // 임시로 Bin당 최대 10개 품목
          }
          rackBins[bin].count++;
        });
        
        // 100% 찬 Bin 찾기 (임시 기준: 품목 수가 10개 이상이면 100%)
        Object.entries(rackBins).forEach(([bin, data]) => {
          if (data.count >= 10) {
            full.push({ rack: rack.id, bin, count: data.count });
          }
        });
      });
      setFullBins(full);
    };
    
    if (inventoryData.length > 0) {
      checkFullBins();
    }
  }, [inventoryData, rackSummary]);
  
  // 탭이 보일 때 깜빡임 효과 (마감 임박 항목 있을 때)
  useEffect(() => {
    let interval;
    const today = new Date().toISOString().split('T')[0];
    
    const urgentCount = todoList.filter(todo => 
      !todo.completed && 
      todo.dueDate && 
      (todo.dueDate === today || todo.dueDate < today)
    ).length;
    
    if (urgentCount > 0) {
      let isAlert = true;
      interval = setInterval(() => {
        if (isAlert) {
          document.title = `🚨 (${urgentCount}) 마감 임박!`;
        } else {
          document.title = `⏰ Warehouse Management`;
        }
        isAlert = !isAlert;
      }, 1500);
    }
    
    return () => {
      if (interval) clearInterval(interval);
    };
  }, [todoList]);

  // 온습도 미입력 알림 상태
  const [showTempAlert, setShowTempAlert] = useState(false);
  const [showUploadAlert, setShowUploadAlert] = useState(false);
  const [showOpenPOAlert, setShowOpenPOAlert] = useState(false);
  
  // 온습도 미입력 체크 (평일 오후 2시 이후 ~ 퇴근 전)
  useEffect(() => {
    const checkAlerts = () => {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const currentHour = now.getHours();
      
      // 주말이면 체크 안함
      if (dayOfWeek === 0 || dayOfWeek === 6) return;
      
      // 공휴일이면 체크 안함
      const todayStr = now.toISOString().split('T')[0];
      if (KR_HOLIDAYS.has(todayStr)) return;
      
      // 오후 2시(14시) 이후면 온습도 체크
      if (currentHour >= 14) {
        const today = now.toISOString().split('T')[0];
        const todayData = tempHumidityData[today];
        const hasInput = todayData && (todayData.temp || todayData.humidity);
        setShowTempAlert(!hasInput);
      }
      
      // 오전 9시 이후면 재고/Open PO 업로드 체크 (오늘 업로드 여부)
      if (currentHour >= 9) {
        const krNow = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
        const todayISO = krNow.getFullYear() + '-' + String(krNow.getMonth()+1).padStart(2,'0') + '-' + String(krNow.getDate()).padStart(2,'0');
        
        // dataHistory에서 오늘 stock 업로드 기록 확인
        const toKRDateStr = (ts) => {
          try {
            const d = new Date(ts);
            const kr = new Date(d.getTime() + 9 * 60 * 60 * 1000);
            return kr.toISOString().slice(0, 10);
          } catch(e) { return ''; }
        };
        const stockUploadedToday = dataHistory.some(h => 
          h.type === 'stock' && h.timestamp && toKRDateStr(h.timestamp) === todayISO
        );
        // dataHistory에서 오늘 openPO 업로드 기록 확인
        const poUploadedToday = dataHistory.some(h => 
          h.type === 'openPO' && h.timestamp && toKRDateStr(h.timestamp) === todayISO
        );
        
        setShowUploadAlert(!stockUploadedToday);
        setShowOpenPOAlert(!poUploadedToday);
      } else {
        setShowUploadAlert(false);
        setShowOpenPOAlert(false);
      }
    };
    
    checkAlerts();
    const interval = setInterval(checkAlerts, 60000);
    return () => clearInterval(interval);
  }, [tempHumidityData, inventoryData, openPOData, dataHistory]);

  // TO DO 수정 함수
  const updateTodo = (id, field, value) => {
    setTodoList(prev => prev.map(todo => 
      todo.id === id ? {...todo, [field]: value} : todo
    ));
  };

  // TO DO 삭제 확인
  const confirmDeleteTodo = () => {
    setTodoList(prev => prev.filter(t => t.id !== deleteConfirm.id));
    setDeleteConfirm({ show: false, type: '', id: null, text: '', count: 0 });
  };

  useEffect(() => {
    safeStorage.setItem('pbk_rack_config', JSON.stringify(rackConfig));
  }, [rackConfig]);
  
  useEffect(() => {
    safeStorage.setItem('pbk_weight_data', JSON.stringify(weightData));
  }, [weightData]);

  // 필터 상태 safeStorage에 저장 (C2 개선)
  useEffect(() => {
    safeStorage.setItem('pbk_filter_inventorySortBy', inventorySortBy);
    safeStorage.setItem('pbk_filter_inventorySortOrder', inventorySortOrder);
  }, [inventorySortBy, inventorySortOrder]);

  useEffect(() => {
    safeStorage.setItem('pbk_filter_weightSortBy', weightSortBy);
    safeStorage.setItem('pbk_filter_weightSortOrder', weightSortOrder);
  }, [weightSortBy, weightSortOrder]);

  useEffect(() => {
    safeStorage.setItem('pbk_filter_pickSortBy', pickSortBy);
    safeStorage.setItem('pbk_filter_pickSortOrder', pickSortOrder);
    safeStorage.setItem('pbk_filter_pickFilterModel', pickFilterModel);
    safeStorage.setItem('pbk_filter_pickFilterStatus', pickFilterStatus);
    safeStorage.setItem('pbk_filter_pickFilterWorker', pickFilterWorker);
    safeStorage.setItem('pbk_filter_pickFilterUrgent', pickFilterUrgent);
  }, [pickSortBy, pickSortOrder, pickFilterModel, pickFilterStatus, pickFilterWorker, pickFilterUrgent]);

  useEffect(() => {
    safeStorage.setItem('pbk_filter_receiveSortBy', receiveSortBy);
    safeStorage.setItem('pbk_filter_receiveSortOrder', receiveSortOrder);
    safeStorage.setItem('pbk_filter_receiveFilterStatus', receiveFilterStatus);
  }, [receiveSortBy, receiveSortOrder, receiveFilterStatus]);

  // 키보드 단축키 (Ctrl+N: 새 입고, Ctrl+K: 새 Kitting, Ctrl+D: 대시보드)
  useEffect(() => {
    const handleKeyDown = (e) => {
      // input, textarea에서는 단축키 무시
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 'm':
            e.preventDefault();
            setActiveTab('receive');
            setShowReceiveModal(true);
            break;
          case 'k':
            e.preventDefault();
            setActiveTab('kitting');
            setShowKittingModal(true);
            break;
          case 'd':
            e.preventDefault();
            setActiveTab('dashboard');
            break;
          case 'b':
            e.preventDefault();
            setShowBackupModal(true);
            break;
          case '/':
          case '?':
            e.preventDefault();
            setShowShortcutHelp(true);
            break;
          case 'n':
            e.preventDefault();
            setShowNotificationCenter(true);
            break;
        }
      }
      
      // ESC로 모달 닫기
      if (e.key === 'Escape') {
        setShowShortcutHelp(false);
        setShowNotificationCenter(false);
        setShowSpaceOptimizationModal(false);
        setShowHistoryModal(false);
      }
    };
    
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  // 불출 Cycle 담당자 변경 시 Kitting 담당자 자동 동기화 + Lead Time 재계산
  useEffect(() => {
    if (pickCycles.length === 0 || kittingData.length === 0) return;
    
    // Production Order별 불출 정보 맵 생성
    const pickInfoMap = {};
    pickCycles.forEach(p => {
      const po = p.productionOrder || p.orderId;
      if (po) {
        pickInfoMap[po] = {
          worker: p.worker,
          startTime: p.startTime,
          completed: p.completed,
          cycleMin: p.cycleMin,
          status: p.status
        };
      }
    });
    
    // Kitting 담당자 동기화 + Lead Time 재계산 (완료된 것만)
    let hasChanges = false;
    const updatedKitting = kittingData.map(k => {
      const pickInfo = pickInfoMap[k.productionOrder];
      if (!pickInfo) return k;
      
      let updated = { ...k };
      
      // 담당자 동기화
      if (pickInfo.worker && k.worker !== pickInfo.worker) {
        updated.worker = pickInfo.worker;
        hasChanges = true;
      }
      
      // 완료된 Kitting의 Lead Time 재계산 (영업일 기준)
      if (k.status === 'completed' && pickInfo.status === 'completed' && pickInfo.startTime) {
        const startTime = new Date(pickInfo.startTime);
        const endTime = pickInfo.completed ? new Date(pickInfo.completed) : new Date();
        if (!isNaN(startTime.getTime()) && !isNaN(endTime.getTime()) && endTime > startTime) {
          const newLeadTime = getBusinessDays(startTime, endTime);
          if (newLeadTime >= 0 && Math.abs(newLeadTime - (k.leadTimeDays || 0)) > 0.05) {
            updated.leadTimeDays = newLeadTime;
            if (pickInfo.startTime) {
              updated.startedAt = pickInfo.startTime;
            }
            hasChanges = true;
          }
        }
      }
      
      return updated;
    });
    
    if (hasChanges) {
      setKittingData(updatedKitting);
    }
  }, [pickCycles]);

  // 이전에 입력한 협력업체 목록 (자동완성용)
  const previousVendors = React.useMemo(() => {
    const vendors = new Set();
    receiveCycles.forEach(r => {
      if (r.vendor) vendors.add(r.vendor);
    });
    return Array.from(vendors).sort();
  }, [receiveCycles]);

  // 협력업체 자동완성 필터링
  const filteredVendorSuggestions = React.useMemo(() => {
    if (!newReceive.vendor) return previousVendors.slice(0, 5);
    const term = newReceive.vendor.toLowerCase();
    return previousVendors.filter(v => v.toLowerCase().includes(term)).slice(0, 5);
  }, [newReceive.vendor, previousVendors]);

  // 정렬/필터된 Pick 데이터 (A5 개선 - 긴급 Order 상단 고정)
  const filteredSortedPicks = React.useMemo(() => {
    let result = [...pickCycles];
    
    // 월별 필터 (Basic Start Date 기준)
    if (pickFilterMonth) {
      const ym = pickFilterMonth;
      const ymShort = ym.slice(2);
      result = result.filter(p => 
        p.basicStartDate?.startsWith(ym) || p.basicStartDate?.startsWith(ymShort)
      );
    }
    
    // 검색 필터
    if (pickSearchTerm) {
      const term = pickSearchTerm.toLowerCase();
      result = result.filter(p => 
        (p.productionOrder || p.orderId || '').toLowerCase().includes(term) ||
        (p.materialDesc || '').toLowerCase().includes(term)
      );
    }
    
    // Model 필터
    if (pickFilterModel !== 'all') {
      result = result.filter(p => p.model === pickFilterModel);
    }
    
    // 상태 필터
    if (pickFilterStatus !== 'all') {
      result = result.filter(p => p.status === pickFilterStatus);
    }
    
    // 담당자 필터
    if (pickFilterWorker !== 'all') {
      result = result.filter(p => p.worker === pickFilterWorker);
    }
    
    // 긴급 필터
    if (pickFilterUrgent !== 'all') {
      result = result.filter(p => pickFilterUrgent === 'urgent' ? p.isUrgent : !p.isUrgent);
    }
    
    // 정렬 (A5 개선: 긴급 + 미완료는 항상 최상단)
    result.sort((a, b) => {
      // 1순위: 긴급 + 미완료는 최상단 (완료되지 않은 긴급 건)
      const aIsUrgentPending = a.isUrgent && a.status !== 'completed';
      const bIsUrgentPending = b.isUrgent && b.status !== 'completed';
      
      if (aIsUrgentPending && !bIsUrgentPending) return -1;
      if (!aIsUrgentPending && bIsUrgentPending) return 1;
      
      // 2순위: 일반 정렬
      let aVal, bVal;
      if (pickSortBy === 'productionOrder') {
        aVal = a.productionOrder || a.orderId || '';
        bVal = b.productionOrder || b.orderId || '';
      } else if (pickSortBy === 'basicStartDate') {
        aVal = a.basicStartDate || a.received || '';
        bVal = b.basicStartDate || b.received || '';
      } else if (pickSortBy === 'model') {
        aVal = a.model || '';
        bVal = b.model || '';
      } else if (pickSortBy === 'status') {
        const statusOrder = { 'waiting': 0, 'in-progress': 1, 'paused': 2, 'completed': 3 };
        aVal = statusOrder[a.status] || 0;
        bVal = statusOrder[b.status] || 0;
      }
      
      if (pickSortOrder === 'asc') {
        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      } else {
        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
      }
    });
    
    return result;
  }, [pickCycles, pickFilterMonth, pickSearchTerm, pickFilterModel, pickFilterStatus, pickFilterWorker, pickFilterUrgent, pickSortBy, pickSortOrder]);

  // 정렬/필터된 Receive 데이터
  const filteredSortedReceives = React.useMemo(() => {
    let result = [...receiveCycles];
    
    // 검색 필터
    if (receiveSearchTerm) {
      const term = receiveSearchTerm.toLowerCase();
      result = result.filter(r => 
        (r.poNo || '').toLowerCase().includes(term) ||
        (r.vendor || '').toLowerCase().includes(term)
      );
    }
    
    // 상태 필터
    if (receiveFilterStatus !== 'all') {
      result = result.filter(r => r.status === receiveFilterStatus);
    }
    
    // 정렬
    result.sort((a, b) => {
      let aVal, bVal;
      if (receiveSortBy === 'poNo') {
        aVal = a.poNo || '';
        bVal = b.poNo || '';
      } else if (receiveSortBy === 'delivery') {
        aVal = a.delivery || '';
        bVal = b.delivery || '';
      } else if (receiveSortBy === 'vendor') {
        aVal = a.vendor || '';
        bVal = b.vendor || '';
      }
      
      if (receiveSortOrder === 'asc') {
        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      } else {
        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
      }
    });
    
    return result;
  }, [receiveCycles, receiveSearchTerm, receiveFilterStatus, receiveSortBy, receiveSortOrder]);

  // 무게 데이터 수정
  const updateWeight = (material, field, value) => {
    setWeightData(prev => ({
      ...prev,
      [material]: { ...prev[material], [field]: field === 'w' ? parseFloat(value) || 0 : value }
    }));
  };
  
  // 무게 데이터 엑셀 대량 업로드
  const handleWeightExcelUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const XLSX = await new Promise((res)=>{if(window.XLSX){res(window.XLSX);return;}var s=document.createElement('script');s.src='https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';s.onload=()=>res(window.XLSX);document.head.appendChild(s);});
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);
      
      if (jsonData.length === 0) {
        alert('❌ 엑셀 파일에 데이터가 없습니다.');
        return;
      }
      
      // 컬럼명 자동 감지 (Material, Description, Weight, Bin 등)
      const firstRow = jsonData[0];
      const keys = Object.keys(firstRow);
      
      // Material 컬럼 찾기
      const materialCol = keys.find(k => 
        k.toLowerCase().includes('material') || 
        k.toLowerCase() === 'mat' ||
        k.toLowerCase() === '품번' ||
        k.toLowerCase() === 'part'
      ) || keys[0];
      
      // Description 컬럼 찾기
      const descCol = keys.find(k => 
        k.toLowerCase().includes('desc') || 
        k.toLowerCase().includes('품명') ||
        k.toLowerCase().includes('name')
      );
      
      // Weight 컬럼 찾기 (g 또는 kg)
      const weightColG = keys.find(k => 
        k.toLowerCase().includes('weight') && k.toLowerCase().includes('g') && !k.toLowerCase().includes('kg')
      );
      const weightColKg = keys.find(k => 
        k.toLowerCase().includes('weight') && k.toLowerCase().includes('kg')
      );
      const weightCol = keys.find(k => 
        k.toLowerCase().includes('weight') || 
        k.toLowerCase().includes('무게') ||
        k.toLowerCase() === 'net weight'
      );
      
      // Bin 컬럼 찾기
      const binCol = keys.find(k => 
        k.toLowerCase().includes('bin') || 
        k.toLowerCase().includes('storage') ||
        k.toLowerCase().includes('위치')
      );
      
      let addedCount = 0;
      let updatedCount = 0;
      
      const newWeightData = { ...weightData };
      
      jsonData.forEach(row => {
        const material = String(row[materialCol] || '').trim();
        if (!material) return;
        
        // 무게 처리 (g → kg 변환)
        let weightKg = 0;
        if (weightColG && row[weightColG]) {
          weightKg = parseFloat(row[weightColG]) / 1000; // g → kg
        } else if (weightColKg && row[weightColKg]) {
          weightKg = parseFloat(row[weightColKg]); // 이미 kg
        } else if (weightCol && row[weightCol]) {
          const w = parseFloat(row[weightCol]);
          // 1000 이상이면 g로 간주, 아니면 kg로 간주
          weightKg = w > 100 ? w / 1000 : w;
        }
        
        const desc = descCol ? String(row[descCol] || '') : '';
        const bin = binCol ? String(row[binCol] || '') : '';
        
        if (newWeightData[material]) {
          updatedCount++;
        } else {
          addedCount++;
        }
        
        newWeightData[material] = {
          d: desc || newWeightData[material]?.d || '',
          w: weightKg || newWeightData[material]?.w || 0,
          b: bin || newWeightData[material]?.b || ''
        };
      });
      
      setWeightData(newWeightData);
      alert(`✅ 업로드 완료!\n- 신규 추가: ${addedCount}개\n- 업데이트: ${updatedCount}개\n- 총: ${Object.keys(newWeightData).length}개`);
      
    } catch (error) {
      console.error('Excel upload error:', error);
      alert('❌ 엑셀 파일 처리 중 오류가 발생했습니다.\n' + error.message);
    }
    
    e.target.value = ''; // 같은 파일 재업로드 가능하게
  };
  
  // 신규 Material 추가
  const addNewMaterial = () => {
    if (!newMaterial.material.trim()) return;
    setWeightData(prev => ({
      ...prev,
      [newMaterial.material]: {
        d: newMaterial.desc,
        w: parseFloat(newMaterial.weight) || 0,
        b: newMaterial.bin
      }
    }));
    setNewMaterial({ material: '', desc: '', weight: '', bin: '' });
    setShowWeightModal(false);
  };
  
  // Material 삭제
  const deleteMaterial = (material) => {
    if (!confirm(`${material}을(를) 삭제하시겠습니까?`)) return;
    setWeightData(prev => {
      const newData = { ...prev };
      delete newData[material];
      return newData;
    });
  };

  // 엑셀 내보내기 공통 함수
  const [exportModalData, setExportModalData] = useState(null);
  
  const exportToExcel = async (data, filename, sheetName = 'Sheet1') => {
    if (!data || data.length === 0) return;
    const headers = Object.keys(data[0]);
    const rows = [headers.join('\t')];
    data.forEach(row => {
      rows.push(headers.map(h => String(row[h] ?? '')).join('\t'));
    });
    setExportModalData({ text: rows.join('\n'), filename, count: data.length });
  };

  // 재고 목록 엑셀 내보내기
  const exportInventory = () => {
    const data = inventoryData.map(item => ({
      '품번': item.material,
      '품명': item.description,
      'Storage Bin': item.bin,
      '랙': getRackId(item.bin),
      '가용재고': item.stock,
      '단위': item.unit
    }));
    exportToExcel(data, 'PBK_재고목록', '재고목록');
  };

  // 무게 정보 엑셀 내보내기
  const exportWeightData = () => {
    const data = Object.entries(weightData).map(([material, info]) => {
      const invItem = inventoryData.find(i => i.material === material);
      return {
        'Material': material,
        'Description': info.d || '',
        'Storage Bin': info.b || '',
        '무게(g)': ((info.w || 0) * 1000).toFixed(1),
        '무게(kg)': (info.w || 0).toFixed(4),
        '현재재고': invItem?.stock || 0,
        '총무게(kg)': ((invItem?.stock || 0) * (info.w || 0)).toFixed(2)
      };
    });
    exportToExcel(data, 'PBK_무게정보', '무게정보');
  };

  // 랙별 현황 엑셀 내보내기
  const exportRackSummary = () => {
    const SPECIAL_AREAS = ['D2', 'E', 'F1', 'LABEL'];
    const data = rackSummary.map(rack => {
      // 공간 사용률 계산
      let curBoxes = 0, maxBoxes = 0;
      if (!SPECIAL_AREAS.includes(rack.id)) {
        const areaItems = inventoryData.filter(item => {
          const bin = item.bin || '';
          return bin.startsWith(rack.id + '-') || bin === rack.id;
        });
        const binGroups = {};
        areaItems.forEach(item => {
          const bin = item.bin || rack.id;
          if (!binGroups[bin]) binGroups[bin] = [];
          binGroups[bin].push(item);
        });
        Object.entries(binGroups).forEach(([bin, items]) => {
          items.forEach(item => {
            const qtyPerBox = MATERIAL_QTY_PER_BOX[item.material] || 1;
            curBoxes += (item.stock || 0) / qtyPerBox;
          });
          const binInfo = BIN_RACK_INFO[bin] || { rackType: '경량랙', rackCount: 1 };
          const binBoxTypes = items.map(i => MATERIAL_BOX_MAP[i.material] || 'PLASTIC-S');
          const tc = {};
          binBoxTypes.forEach(t => { tc[t] = (tc[t] || 0) + 1; });
          const mainBT = Object.entries(tc).sort((a, b) => b[1] - a[1])[0]?.[0] || 'PLASTIC-S';
          if (binInfo.maxBoxes) { maxBoxes += binInfo.maxBoxes; }
          else if (binInfo.mixed) {
            binInfo.mixed.forEach(m => {
              const s = BOXES_PER_SHELF[m.type] || BOXES_PER_SHELF['경량랙'];
              maxBoxes += (s[mainBT] || s['PLASTIC-S'] || 2) * m.count;
            });
          } else {
            const s = BOXES_PER_SHELF[binInfo.rackType] || BOXES_PER_SHELF['경량랙'];
            maxBoxes += (s[mainBT] || s['PLASTIC-S'] || 2) * binInfo.rackCount * (binInfo.shelves || 1);
          }
        });
      }
      const spaceUtil = maxBoxes > 0 ? ((curBoxes / maxBoxes) * 100).toFixed(1) : 'N/A';
      
      return {
        '랙ID': rack.id,
        '모델시리즈': RACK_MODEL_SERIES[rack.id] || '기타',
        '품목수': rack.items,
        '총재고': rack.stock,
        '현재박스수': curBoxes.toFixed(1),
        '최대박스수': maxBoxes || 'N/A',
        '공간사용률(%)': spaceUtil,
        '총무게(kg)': rack.weight.toFixed(2),
        '최대무게(kg)': rack.maxWeight >= 99999 ? '무제한' : rack.maxWeight
      };
    });
    exportToExcel(data, 'PBK_랙별현황', '랙별현황');
  };

  // 불출 Cycle Time 엑셀 내보내기
  const exportPickCycles = () => {
    const data = pickCycles.map(cycle => ({
      'Production Order': cycle.productionOrder,
      'Material': cycle.material,
      'Description': cycle.description,
      '수량': cycle.quantity,
      '요청시간': cycle.requestTime,
      '완료시간': cycle.completeTime || '',
      '상태': cycle.status === 'completed' ? '완료' : cycle.status === 'in-progress' ? '진행중' : '대기',
      'Cycle Time(분)': cycle.cycleTime || ''
    }));
    exportToExcel(data, 'PBK_불출CycleTime', '불출Cycle');
  };

  // 입고 Cycle Time 엑셀 내보내기
  const exportReceiveCycles = () => {
    const data = receiveCycles.map(cycle => ({
      'Material': cycle.material,
      'Description': cycle.description,
      '수량': cycle.quantity,
      'PO Number': cycle.poNumber || '',
      '도착시간': cycle.arrivalTime,
      'MIGO완료시간': cycle.migoTime || '',
      '적치완료시간': cycle.putawayTime || '',
      '상태': cycle.status === 'completed' ? '완료' : cycle.status === 'migo-done' ? 'MIGO완료' : '도착',
      '총CycleTime(분)': cycle.totalCycleTime || ''
    }));
    exportToExcel(data, 'PBK_입고CycleTime', '입고Cycle');
  };

  // Kitting 현황 엑셀 내보내기
  const exportKittingData = () => {
    const data = kittingData.map(order => ({
      '주문번호': order.orderId,
      '모델': order.model,
      '수량': order.quantity,
      '시작일': order.startDate,
      '목표완료일': order.targetDate,
      '진행률(%)': order.progress,
      '상태': order.status === 'completed' ? '완료' : order.status === 'in-progress' ? '진행중' : order.status === 'paused' ? '일시정지' : '대기',
      '완료품목': order.completedItems,
      '총품목': order.totalItems
    }));
    exportToExcel(data, 'PBK_Kitting현황', 'Kitting');
  };

  // TO DO 리스트 엑셀 내보내기
  const exportTodoList = () => {
    const categoryNames = { general: '일반', data: '데이터', process: '프로세스', kpi: 'KPI', other: '기타' };
    const priorityNames = { high: '높음', medium: '중간', low: '낮음' };
    const data = todoList.map(todo => ({
      '할일': todo.text,
      '카테고리': categoryNames[todo.category] || todo.category,
      '우선순위': priorityNames[todo.priority] || todo.priority,
      '완료여부': todo.completed ? '완료' : '미완료',
      '생성일': todo.createdAt,
      '마감일': todo.dueDate || ''
    }));
    exportToExcel(data, 'PBK_TODO리스트', 'TODO');
  };

  // 저장된 재고 데이터 로드
  useEffect(() => {
    const savedInventory = safeStorage.getItem('pbk_inventory');
    const savedLastUpdated = safeStorage.getItem('pbk_last_updated');
    if (savedInventory) {
      const data = JSON.parse(savedInventory);
      setInventoryData(data);
      processRackSummary(data);
    }
    if (savedLastUpdated) {
      setLastUpdated(savedLastUpdated);
    }
  }, []);

  // 랙 ID 추출
  const getRackId = (bin) => {
    if (!bin) return 'UNKNOWN';
    const binStr = String(bin).trim();
    if (binStr.match(/^\d/)) return null; // Production Order Bin 제외
    if (binStr.includes('-')) return binStr.split('-')[0];
    return binStr;
  };

  // 랙별 요약 계산
  const processRackSummary = useCallback((data) => {
    const rackMap = {};
    
    data.forEach(item => {
      const rackId = getRackId(item.bin);
      if (!rackId) return; // Production Order Bin 제외
      
      if (!rackMap[rackId]) {
        rackMap[rackId] = {
          id: rackId,
          zone: rackId.charAt(0),
          items: new Set(),
          stock: 0,
          weight: 0,
          bins: new Set()
        };
      }
      
      rackMap[rackId].items.add(item.material);
      rackMap[rackId].stock += item.stock || 0;
      // weightData에서 무게 가져오기 (kg 단위)
      const itemWeight = weightData[item.material]?.w || 0;
      rackMap[rackId].weight += (item.stock || 0) * itemWeight;
      rackMap[rackId].bins.add(item.bin);
    });

    const summary = Object.values(rackMap).map(rack => ({
      id: rack.id,
      zone: rack.zone,
      items: rack.items.size,
      stock: rack.stock,
      weight: rack.weight,
      bins: rack.bins.size,
      maxBins: rackConfig[rack.id]?.maxBins || 10,
      maxWeight: rackConfig[rack.id]?.maxWeight || 200
    })).sort((a, b) => b.stock - a.stock);

    setRackSummary(summary);
  }, [rackConfig, weightData]);

  // 엑셀 파일 파싱 (SheetJS 사용)
  const parseExcelFile = async (file) => {
    setIsLoading(true);
    setUploadError(null);
    
    try {
      // SheetJS 라이브러리 로드
      if (!window.XLSX) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      
      const data = await file.arrayBuffer();
      const workbook = window.XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = window.XLSX.utils.sheet_to_json(sheet);
      
      // SAP 데이터 파싱 
      // Description 없는 행 (노란색) = Material별 총 재고 → 여기서 재고 추출
      // Description 있는 행 = Bin 정보 + 품명 → 매핑용
      
      // 1. Description 있는 행에서 Material별 정보 매핑 (Bin, Description)
      const materialInfoMap = {};
      jsonData.forEach(row => {
        const material = row['Material'];
        const desc = row['Material Description'];
        const bin = row['Storage Bin'];
        
        if (material && desc && desc.toString().trim() && bin) {
          const matKey = String(material);
          // Production Order Bin (숫자로 시작) 제외
          if (String(bin).match(/^\d{10}/)) return;
          
          if (!materialInfoMap[matKey]) {
            materialInfoMap[matKey] = {
              description: String(desc),
              bins: []
            };
          }
          materialInfoMap[matKey].bins.push(String(bin));
        }
      });
      
      // 2. 노란색 행 (Description 없는 행)에서 총 재고 추출
      const inventory = jsonData
        .filter(row => {
          const material = row['Material'];
          const desc = row['Material Description'];
          // Material은 있고, Description은 비어있는 행 (노란색)
          return material && (!desc || !desc.toString().trim());
        })
        .map(row => {
          const material = String(row['Material'] || '');
          const info = materialInfoMap[material] || { description: '', bins: [] };
          // 첫 번째 Bin을 대표 Bin으로 사용
          const primaryBin = info.bins.length > 0 ? info.bins[0] : '';
          
          return {
            material: material,
            description: info.description,
            bin: primaryBin,
            allBins: info.bins, // 모든 Bin 저장
            stock: parseFloat(row['Available stock']) || 0,
            unit: String(row['Base Unit of Measure'] || 'EA'),
          };
        })
        .filter(item => item.bin); // Bin 정보가 있는 것만 (Production Order 제외됨)

      if (inventory.length === 0) {
        throw new Error('유효한 재고 데이터가 없습니다. SAP 엑셀 형식을 확인해주세요.');
      }

      // 저장
      setInventoryData(inventory);
      processRackSummary(inventory);
      const now = new Date().toLocaleString('ko-KR');
      setLastUpdated(now);
      
      safeStorage.setItem('pbk_inventory', JSON.stringify(inventory));
      safeStorage.setItem('pbk_last_updated', now);
      
      setShowUploadModal(false);
      
      // v15: 토스트, 알림, 히스토리 추가
      showToast(`✅ SAP 재고 업로드 완료! ${inventory.length}개 품목`, 'success');
      addNotification('재고 데이터 업로드', `${inventory.length}개 품목이 업로드되었습니다.`, 'success');
      addDataHistory('stock', `SAP 재고 데이터 업로드 (${inventory.length}개 품목)`, inventory.length);
      
    } catch (error) {
      console.error('Excel parsing error:', error);
      setUploadError(error.message || '엑셀 파일 파싱 중 오류가 발생했습니다.');
      showToast('❌ 파일 업로드 실패', 'error');
    } finally {
      setIsLoading(false);
    }
  };

  // 파일 드롭 핸들러
  const handleDrop = useCallback((e) => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
      parseExcelFile(file);
    } else {
      setUploadError('엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.');
    }
  }, []);

  const handleFileSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
      parseExcelFile(file);
    }
  };

  // Open PO 엑셀 파싱
  const parseOpenPOFile = async (file) => {
    setIsLoading(true);
    setOpenPOError(null);
    
    try {
      if (!window.XLSX) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      
      const data = await file.arrayBuffer();
      const workbook = window.XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = window.XLSX.utils.sheet_to_json(sheet);
      
      // Z열: "Still to be delivered (qty)" > 0 필터링
      const filtered = jsonData.filter(row => {
        const qty = parseFloat(row['Still to be delivered (qty)']);
        return qty > 0;
      });
      
      // Material별로 그룹화 (같은 Material의 수량 합산)
      const poByMaterial = {};
      filtered.forEach(row => {
        const material = String(row['Material'] || '').trim();
        const description = String(row['Short Text'] || '').trim();
        const qty = parseFloat(row['Still to be delivered (qty)']) || 0;
        const unit = String(row['Order Unit'] || 'EA').trim();
        const poNo = row['Purchasing Document'];
        
        if (material) {
          if (!poByMaterial[material]) {
            poByMaterial[material] = {
              material,
              description,
              totalQty: 0,
              unit,
              poNumbers: []
            };
          }
          poByMaterial[material].totalQty += qty;
          if (poNo && !poByMaterial[material].poNumbers.includes(poNo)) {
            poByMaterial[material].poNumbers.push(poNo);
          }
        }
      });
      
      const openPOList = Object.values(poByMaterial);
      
      if (openPOList.length === 0) {
        throw new Error('납품 예정인 자재가 없습니다. (Still to be delivered > 0)');
      }
      
      // 저장
      setOpenPOData(openPOList);
      const now = new Date().toLocaleString('ko-KR');
      setOpenPOLastUpdated(now);
      
      safeStorage.setItem('pbk_open_po', JSON.stringify(openPOList));
      safeStorage.setItem('pbk_open_po_updated', now);
      
      setShowOpenPOModal(false);
      
      // v15: 토스트, 알림, 히스토리 추가
      showToast(`✅ Open PO 업로드 완료! ${openPOList.length}개 자재`, 'success');
      addNotification('Open PO 업로드', `${openPOList.length}개 자재 납품 예정이 업로드되었습니다.`, 'success');
      addDataHistory('openPO', `Open PO 데이터 업로드 (${openPOList.length}개 자재)`, openPOList.length);
      
    } catch (error) {
      console.error('Open PO parsing error:', error);
      setOpenPOError(error.message || 'Open PO 파일 파싱 중 오류가 발생했습니다.');
      showToast('❌ Open PO 업로드 실패', 'error');
    } finally {
      setIsLoading(false);
    }
  };

  // Open PO 파일 핸들러
  const handleOpenPODrop = useCallback((e) => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
      parseOpenPOFile(file);
    } else {
      setOpenPOError('엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.');
    }
  }, []);

  const handleOpenPOFileSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
      parseOpenPOFile(file);
    }
  };

  // Open PO에서 자재 찾기 헬퍼 함수
  const getOpenPOForMaterial = (material) => {
    return openPOData.find(po => po.material === material);
  };

  // BOM 파일 파싱 함수 (새 형식 + Sub-component 지원)
  const parseBOMFile = async (file) => {
    setIsLoading(true);
    try {
      // XLSX 라이브러리 로드
      if (!window.XLSX) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      const data = await file.arrayBuffer();
      const workbook = window.XLSX.read(data, { type: 'array' });
      
      // 모델별 BOM 데이터 + Sub-component 데이터
      const modelBomData = {};
      const subComponentBomData = {};
      
      workbook.SheetNames.forEach(sheetName => {
        // storage bin 시트 제외
        if (sheetName.toLowerCase().includes('storage')) return;
        
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = window.XLSX.utils.sheet_to_json(worksheet);
        
        if (jsonData.length === 0) return;
        
        const bomItems = {};
        let validCount = 0;
        let excludedCount = 0;
        
        jsonData.forEach(row => {
          // Part No. = Component number 컬럼
          const partNo = row['Component number'];
          // Qty = Comp. Qty (CUn) 컬럼
          const qty = parseFloat(row['Comp. Qty (CUn)']) || 1;
          // Phantom item 체크 - X면 제외
          const phantom = row['Phantom item'] || '';
          // Item category 체크 - L만 포함 (D, T 등은 제외)
          const itemCategory = row['Item category'] || '';
          
          // 제외 조건 1: Phantom item = X
          if (phantom.toString().toUpperCase() === 'X') {
            excludedCount++;
            return;
          }
          
          // 제외 조건 2: Item category가 L이 아닌 경우 (D, T 등)
          if (itemCategory.toString().toUpperCase() !== 'L') {
            excludedCount++;
            return;
          }
          
          if (partNo) {
            validCount++;
            bomItems[String(partNo).trim()] = qty;
          }
        });
        
        // 시트 탭 이름으로 완제품/Sub-component 구분
        if (sheetName.startsWith('KB')) {
          // Sub-component
          subComponentBomData[sheetName] = bomItems;
        } else if (sheetName.startsWith('AS') || sheetName.includes('A2715') || sheetName.includes('HSM')) {
          // 완제품 - 모델명 매핑
          let modelName = sheetName;
          if (sheetName === 'AS4500') modelName = 'RSC16';
          else if (sheetName === 'AS6000') modelName = 'CSC16';
          else if (sheetName === 'AS4600') modelName = 'FSC16';
          else if (sheetName === 'AS8500') modelName = 'RSC48';
          else if (sheetName === 'AS8000') modelName = 'CSC48';
          else if (sheetName.includes('A2715') || sheetName.includes('HSM')) modelName = 'HSM3';
          
          modelBomData[modelName] = bomItems;
        }
      });
      
      if (Object.keys(modelBomData).length === 0) {
        alert('❌ BOM 데이터를 찾을 수 없습니다.\n\n시트 탭 이름이 AS4500, AS8500, KB0xxx 형식이어야 합니다.');
        setIsLoading(false);
        return;
      }
      
      // 저장
      const now = new Date().toLocaleString('ko-KR');
      setCustomBomData(modelBomData);
      setSubComponentBomData(subComponentBomData);
      setBomLastUpdated(now);
      safeStorage.setItem('pbk_custom_bom', JSON.stringify(modelBomData));
      safeStorage.setItem('pbk_subcom_bom', JSON.stringify(subComponentBomData));
      safeStorage.setItem('pbk_bom_updated', now);
      
      const modelCount = Object.keys(modelBomData).length;
      const subComCount = Object.keys(subComponentBomData).length;
      const totalModelParts = Object.values(modelBomData).reduce((sum, m) => sum + Object.keys(m).length, 0);
      const totalSubComParts = Object.values(subComponentBomData).reduce((sum, m) => sum + Object.keys(m).length, 0);
      
      // v15: 토스트, 알림, 히스토리 추가
      showToast(`✅ BOM 업로드 완료! ${modelCount}개 모델`, 'success');
      addNotification('BOM 데이터 업로드', `완제품 ${modelCount}개 모델, Sub-com ${subComCount}개가 업로드되었습니다.`, 'success');
      addDataHistory('bom', `BOM 데이터 업로드 (완제품 ${totalModelParts}개, Sub-com ${totalSubComParts}개 자재)`, totalModelParts + totalSubComParts);
      
    } catch (error) {
      console.error('BOM parsing error:', error);
      alert('❌ BOM 파일 파싱 중 오류가 발생했습니다.\n\n' + error.message);
      showToast('❌ BOM 업로드 실패', 'error');
    } finally {
      setIsLoading(false);
    }
  };

  const handleBOMFileSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
      parseBOMFile(file);
    }
    e.target.value = '';
  };

  // BOM 초기화 (기본 BOM으로 복원)
  const resetBOMData = () => {
    if (confirm('BOM 데이터를 기본값으로 초기화하시겠습니까?\n(완제품 + Sub-component 모두 초기화)')) {
      setCustomBomData(null);
      setSubComponentBomData(null);
      setBomLastUpdated(null);
      safeStorage.removeItem('pbk_custom_bom');
      safeStorage.removeItem('pbk_subcom_bom');
      safeStorage.removeItem('pbk_bom_updated');
      alert('✅ BOM 데이터가 기본값으로 초기화되었습니다.');
    }
  };

  // 현재 사용 중인 BOM 데이터 (사용자 업로드 또는 기본값)
  const activeBomData = customBomData || MODEL_BOM_DATA;

  // 통계
  const totals = {
    items: new Set(inventoryData.map(i => i.material)).size,
    stock: inventoryData.reduce((s, i) => s + (i.stock || 0), 0),
    weight: rackSummary.reduce((s, r) => s + r.weight, 0),
    bins: new Set(inventoryData.map(i => i.bin)).size
  };

  // Sub-component 생산 가능 대수 계산
  const calculateSubComponentUnits = useCallback(() => {
    if (!subComponentBomData || inventoryData.length === 0) return {};
    
    // 재고를 Material 기준으로 합계
    const stockByMaterial = {};
    const descByMaterial = {};
    inventoryData.forEach(item => {
      const mat = item.material;
      if (!stockByMaterial[mat]) stockByMaterial[mat] = 0;
      stockByMaterial[mat] += item.stock || 0;
      if (!descByMaterial[mat]) descByMaterial[mat] = item.description || '';
    });
    
    const results = {};
    
    Object.entries(subComponentBomData).forEach(([subComName, bom]) => {
      let minUnits = Infinity;
      let bottleneck = null;
      let missingCount = 0;
      let totalBomItems = Object.keys(bom).length;
      let matchedItems = 0;
      
      Object.entries(bom).forEach(([material, requiredQty]) => {
        const currentStock = stockByMaterial[material] || 0;
        const description = descByMaterial[material] || '';
        
        if (currentStock > 0) {
          matchedItems++;
          const possibleUnits = Math.floor(currentStock / requiredQty);
          if (possibleUnits < minUnits) {
            minUnits = possibleUnits;
            bottleneck = { material, description, currentStock, requiredQty, possibleUnits };
          }
        } else {
          missingCount++;
          if (minUnits > 0) {
            minUnits = 0;
            bottleneck = { material, description, currentStock: 0, requiredQty, possibleUnits: 0 };
          }
        }
      });
      
      results[subComName] = {
        units: minUnits === Infinity ? 0 : minUnits,
        bottleneck,
        missingCount,
        totalBomItems,
        matchedItems,
        coverage: totalBomItems > 0 ? ((matchedItems / totalBomItems) * 100).toFixed(1) : '0'
      };
    });
    
    return results;
  }, [inventoryData, subComponentBomData]);

  const subComponentUnits = calculateSubComponentUnits();

  // 생산 가능 대수 계산 (사용자 BOM 또는 기본 BOM 사용)
  const calculateProducibleUnits = useCallback(() => {
    if (inventoryData.length === 0) return {};
    
    // 재고를 Material 기준으로 합계 및 description 저장
    const stockByMaterial = {};
    const descByMaterial = {};
    inventoryData.forEach(item => {
      const mat = item.material;
      if (!stockByMaterial[mat]) stockByMaterial[mat] = 0;
      stockByMaterial[mat] += item.stock || 0;
      if (!descByMaterial[mat]) descByMaterial[mat] = item.description || '';
    });
    
    const results = {};
    const bomToUse = customBomData || MODEL_BOM_DATA;
    
    Object.keys(bomToUse).forEach(model => {
      const bom = bomToUse[model];
      let minUnits = Infinity;
      let bottleneck = null;
      let missingCount = 0;
      let totalBomItems = Object.keys(bom).length;
      let matchedItems = 0;
      
      Object.entries(bom).forEach(([material, requiredQty]) => {
        const currentStock = stockByMaterial[material] || 0;
        const description = descByMaterial[material] || '';
        
        if (currentStock > 0) {
          matchedItems++;
          const possibleUnits = Math.floor(currentStock / requiredQty);
          if (possibleUnits < minUnits) {
            minUnits = possibleUnits;
            bottleneck = { material, description, currentStock, requiredQty, possibleUnits };
          }
        } else {
          missingCount++;
          if (minUnits > 0) {
            minUnits = 0;
            bottleneck = { material, description, currentStock: 0, requiredQty, possibleUnits: 0 };
          }
        }
      });
      
      results[model] = {
        units: minUnits === Infinity ? 0 : minUnits,
        bottleneck,
        missingCount,
        totalBomItems,
        matchedItems,
        coverage: ((matchedItems / totalBomItems) * 100).toFixed(1)
      };
    });
    
    return results;
  }, [inventoryData, customBomData]);
  
  const producibleUnits = calculateProducibleUnits();

  const avgPickTime = pickCycles.filter(p => p.cycleMin).reduce((s, p, _, a) => s + p.cycleMin / a.length, 0) || 0;
  const avgReceiveTime = receiveCycles.filter(r => r.cycleMin).reduce((s, r, _, a) => s + r.cycleMin / a.length, 0) || 0;
  const avgLeadTime = kittingData.filter(k => k.leadTimeDays && k.leadTimeDays > 0).reduce((s, k, _, a) => s + k.leadTimeDays / a.length, 0) || 0;

  // C1 개선: 현재 통계를 매일 자정에 이전 통계로 저장
  useEffect(() => {
    const today = new Date().toISOString().split('T')[0];
    const lastSavedDate = safeStorage.getItem('pbk_stats_saved_date');
    
    // 날짜가 바뀌면 현재 값을 이전 값으로 저장
    if (lastSavedDate !== today && avgPickTime > 0) {
      const currentStats = {
        avgPickTime,
        avgReceiveTime,
        avgLeadTime,
        savedAt: today
      };
      safeStorage.setItem('pbk_previous_stats', JSON.stringify(currentStats));
      safeStorage.setItem('pbk_stats_saved_date', today);
      setPreviousStats(currentStats);
    }
  }, [avgPickTime, avgReceiveTime, avgLeadTime]);

  // 필터링
  const filteredRacks = rackSummary.filter(r => {
    if (selectedZone !== 'all' && r.zone !== selectedZone) return false;
    if (searchTerm && !r.id.toLowerCase().includes(searchTerm.toLowerCase())) return false;
    return true;
  }).sort((a, b) => {
    // 시리즈별 우선순위: Maxwell 48 → Maxwell 16 → HSM 3.0 → 기타
    const seriesOrder = { 'Maxwell 48': 0, 'Maxwell 16': 1, 'HSM 3.0': 2, 'Others': 3 };
    const aSeries = RACK_MODEL_SERIES[a.id] || 'Others';
    const bSeries = RACK_MODEL_SERIES[b.id] || 'Others';
    const aOrder = seriesOrder[aSeries] ?? 3;
    const bOrder = seriesOrder[bSeries] ?? 3;
    if (aOrder !== bOrder) return aOrder - bOrder;
    // 같은 시리즈 내에서 알파벳 순
    return a.id.localeCompare(b.id);
  });

  // 여유 공간 있는 랙
  const availableRacks = rackSummary
    .filter(r => r.bins < r.maxBins && !['D2', 'LABEL', 'E', 'E3'].includes(r.id))
    .sort((a, b) => (b.maxBins - b.bins) - (a.maxBins - a.bins));

  // Cycle Time 완료 처리
  const completePick = (id) => {
    const now = new Date();
    const koreaTime = now.toLocaleString('ko-KR', { 
      timeZone: 'Asia/Seoul',
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: false
    }).replace(/\. /g, '-').replace('.', '');
    
    // 한국 시간 날짜 (YYYY-MM-DD)
    const koreaDate = now.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\. /g, '-').replace('.', '');
    
    // 먼저 productionOrder 찾기 (productionOrder 또는 orderId)
    const targetPick = pickCycles.find(p => p.id === id);
    const productionOrder = targetPick?.productionOrder || targetPick?.orderId;
    
    setPickCycles(prev => prev.map(p => {
      if (p.id === id && p.startTime) {
        // 근무시간만 계산 (평일 07:00~16:00, 점심 12:30~13:30 제외)
        const cycleMin = calculateWorkingMinutes(p.startTime, now.toISOString());
        return { ...p, completed: koreaTime, cycleMin, status: 'completed' };
      }
      return p;
    }));
    
    // Kitting도 같이 완료 처리
    if (productionOrder) {
      setKittingData(prev => prev.map(k => {
        if (k.productionOrder === productionOrder && k.status !== 'completed') {
          // 시작 시간이 있으면 실제 작업 시간 계산, 없으면 0
          let leadTimeDays = 0;
          if (k.startedAt) {
            const startTime = new Date(k.startedAt);
            leadTimeDays = getBusinessDays(startTime, now); // 영업일 기준 (주말+공휴일 제외)
          }
          return { ...k, status: 'completed', completedAt: koreaDate, leadTimeDays };
        }
        return k;
      }));
    }
  };

  const completeReceive = (id) => {
    const now = new Date();
    // 한국 시간으로 포맷팅
    const koreaTime = now.toLocaleString('ko-KR', { 
      timeZone: 'Asia/Seoul',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    }).replace(/\. /g, '-').replace('.', '').replace(' ', ' ');
    
    setReceiveCycles(prev => prev.map(r => {
      if (r.id === id && r.startTime) {
        // 근무시간만 계산 (평일 07:00~16:00)
        const cycleMin = calculateWorkingMinutes(r.startTime, now.toISOString());
        return { ...r, migo: koreaTime, cycleMin, status: 'completed' };
      }
      return r;
    }));
  };

  // 시작 기능
  const startPick = (id) => {
    const now = new Date().toISOString();
    
    // 먼저 productionOrder 찾기 (productionOrder 또는 orderId)
    const targetPick = pickCycles.find(p => p.id === id);
    const productionOrder = targetPick?.productionOrder || targetPick?.orderId;
    
    setPickCycles(prev => prev.map(p => 
      p.id === id ? { ...p, startTime: now, status: 'in-progress' } : p
    ));
    
    // Kitting도 같이 시작 처리
    if (productionOrder) {
      setKittingData(prev => prev.map(k => 
        k.productionOrder === productionOrder && k.status === 'waiting'
          ? { ...k, status: 'in-progress', startedAt: now }
          : k
      ));
    }
  };

  const startReceive = (id) => {
    const now = new Date().toISOString();
    setReceiveCycles(prev => prev.map(r => 
      r.id === id ? { ...r, startTime: now, status: 'in-progress' } : r
    ));
  };

  // 일시정지 기능
  const pausePick = (id) => {
    const now = new Date().toISOString();
    
    // 먼저 productionOrder 찾기
    const targetPick = pickCycles.find(p => p.id === id);
    const productionOrder = targetPick?.productionOrder || targetPick?.orderId;
    
    setPickCycles(prev => prev.map(p => 
      p.id === id ? { ...p, pausedAt: now, status: 'paused' } : p
    ));
    
    // Kitting도 같이 일시정지 처리
    if (productionOrder) {
      setKittingData(prev => prev.map(k => 
        k.productionOrder === productionOrder && k.status === 'in-progress'
          ? { ...k, status: 'paused', pausedAt: now }
          : k
      ));
    }
  };

  const pauseReceive = (id) => {
    const now = new Date().toISOString();
    setReceiveCycles(prev => prev.map(r => 
      r.id === id ? { ...r, pausedAt: now, status: 'paused' } : r
    ));
  };

  // 재개 기능
  const resumePick = (id) => {
    const now = new Date().toISOString();
    
    // 먼저 productionOrder 찾기
    const targetPick = pickCycles.find(p => p.id === id);
    const productionOrder = targetPick?.productionOrder || targetPick?.orderId;
    
    setPickCycles(prev => prev.map(p => {
      if (p.id === id && p.pausedAt) {
        const pausedMs = new Date() - new Date(p.pausedAt);
        return { 
          ...p, 
          totalPausedMs: (p.totalPausedMs || 0) + pausedMs,
          pausedAt: null, 
          status: 'in-progress' 
        };
      }
      return p;
    }));
    
    // Kitting도 같이 재개 처리
    if (productionOrder) {
      setKittingData(prev => prev.map(k => {
        if (k.productionOrder === productionOrder && k.status === 'paused') {
          const pausedMs = k.pausedAt ? new Date() - new Date(k.pausedAt) : 0;
          return { 
            ...k, 
            status: 'in-progress',
            totalPausedMs: (k.totalPausedMs || 0) + pausedMs,
            pausedAt: null
          };
        }
        return k;
      }));
    }
  };

  const resumeReceive = (id) => {
    setReceiveCycles(prev => prev.map(r => {
      if (r.id === id && r.pausedAt) {
        const pausedMs = new Date() - new Date(r.pausedAt);
        return { 
          ...r, 
          totalPausedMs: (r.totalPausedMs || 0) + pausedMs,
          pausedAt: null, 
          status: 'in-progress' 
        };
      }
      return r;
    }));
  };

  // 엑셀 다운로드 기능
  const downloadCycleExcel = async (type) => {
    if (!window.XLSX) {
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    let data, filename;
    if (type === 'pick') {
      data = pickCycles.map(p => ({
        'Production Order': p.productionOrder || p.orderId,
        'Model': p.model,
        '담당자': p.worker || '-',
        '긴급': p.isUrgent ? '긴급' : '-',
        'Material Description': p.materialDesc || '-',
        '시작예정일': p.basicStartDate || '-',
        '시작 시간': p.startTime ? new Date(p.startTime).toLocaleString('ko-KR') : '-',
        '완료 시간': p.completed || '-',
        'Cycle Time (분)': p.cycleMin || '-',
        '일시정지 시간 (분)': p.totalPausedMs ? Math.round(p.totalPausedMs / 60000) : 0,
        '상태': p.status === 'completed' ? '완료' : p.status === 'paused' ? '일시정지' : p.status === 'in-progress' ? '진행중' : '대기'
      }));
      filename = `불출_Cycle_Time_${new Date().toISOString().slice(0,10)}.xlsx`;
    } else {
      data = receiveCycles.map(r => ({
        'No.': r.poNo,
        '협력업체': r.vendor,
        '납품 시각': r.delivery ? r.delivery.replace(/^(\d{4}-\d{2}-\d{2})[\-T](\d{2}:\d{2}).*/, '$1 $2') : '-',
        '시작 시간': r.startTime ? new Date(r.startTime).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }) : '-',
        'MIGO 완료': r.migo ? convertToKoreaTime(r.migo) : '-',
        'Cycle Time (분)': r.cycleMin || '-',
        '일시정지 시간 (분)': r.totalPausedMs ? Math.round(r.totalPausedMs / 60000) : 0,
        '상태': r.status === 'completed' ? '완료' : r.status === 'paused' ? '일시정지' : r.status === 'in-progress' ? '진행중' : '대기',
        'Comments': r.comments || ''
      }));
      filename = `입고_Cycle_Time_${new Date().toISOString().slice(0,10)}.xlsx`;
    }

    const ws = window.XLSX.utils.json_to_sheet(data);
    const wb = window.XLSX.utils.book_new();
    window.XLSX.utils.book_append_sheet(wb, ws, 'Cycle Time');
    window.XLSX.writeFile(wb, filename);
  };

  // 주간 리포트 다운로드 함수
  const downloadWeeklyReport = async () => {
    if (!window.XLSX) {
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    const now = new Date();
    const lastWeekStart = new Date(now);
    lastWeekStart.setDate(now.getDate() - now.getDay() - 6); // 지난주 월요일
    lastWeekStart.setHours(0, 0, 0, 0);
    const lastWeekEnd = new Date(lastWeekStart);
    lastWeekEnd.setDate(lastWeekStart.getDate() + 6); // 지난주 일요일
    lastWeekEnd.setHours(23, 59, 59, 999);

    const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    
    // 지난주 데이터 필터링
    const lastWeekPicks = pickCycles.filter(p => {
      if (!p.completed) return false;
      const completedDate = new Date(p.completed);
      return completedDate >= lastWeekStart && completedDate <= lastWeekEnd;
    });
    
    const lastWeekReceives = receiveCycles.filter(r => {
      if (!r.migo) return false;
      const migoDate = new Date(r.migo);
      return migoDate >= lastWeekStart && migoDate <= lastWeekEnd;
    });
    
    const lastWeekKittings = kittingData.filter(k => {
      if (!k.completedAt) return false;
      const completedDate = new Date(k.completedAt);
      return completedDate >= lastWeekStart && completedDate <= lastWeekEnd;
    });

    // KPI 계산
    const avgPickTime = lastWeekPicks.length > 0 
      ? (lastWeekPicks.reduce((s, p) => s + (p.cycleMin || 0), 0) / lastWeekPicks.length).toFixed(1)
      : '-';
    const avgReceiveTime = lastWeekReceives.length > 0 
      ? (lastWeekReceives.reduce((s, r) => s + (r.cycleMin || 0), 0) / lastWeekReceives.length).toFixed(1)
      : '-';
    const avgLeadTime = lastWeekKittings.filter(k => k.leadTimeDays).length > 0
      ? (lastWeekKittings.filter(k => k.leadTimeDays).reduce((s, k) => s + k.leadTimeDays, 0) / lastWeekKittings.filter(k => k.leadTimeDays).length).toFixed(2)
      : '-';

    // 협력업체별 입고 통계
    const vendorStats = {};
    lastWeekReceives.forEach(r => {
      if (!vendorStats[r.vendor]) vendorStats[r.vendor] = { count: 0, totalTime: 0 };
      vendorStats[r.vendor].count++;
      vendorStats[r.vendor].totalTime += r.cycleMin || 0;
    });

    // KPI 요약 시트
    const summaryData = [
      { '항목': '📅 리포트 기간', '값': `${formatDate(lastWeekStart)} ~ ${formatDate(lastWeekEnd)}` },
      { '항목': '📊 Kitting 완료 건수', '값': `${lastWeekPicks.length}건` },
      { '항목': '⏱️ 평균 Kitting 시간', '값': `${avgPickTime}분` },
      { '항목': '📦 입고 완료 건수', '값': `${lastWeekReceives.length}건` },
      { '항목': '⏱️ 평균 입고 시간', '값': `${avgReceiveTime}분` },
      { '항목': '📈 Kitting 완료 건수', '값': `${lastWeekKittings.length}건` },
      { '항목': '📅 평균 리드타임', '값': `${avgLeadTime}일` },
    ];

    // 협력업체별 시트
    const vendorData = Object.entries(vendorStats).map(([vendor, stats]) => ({
      '협력업체': vendor,
      '입고 건수': stats.count,
      '평균 입고시간(분)': stats.count > 0 ? (stats.totalTime / stats.count).toFixed(1) : '-'
    })).sort((a, b) => b['입고 건수'] - a['입고 건수']);

    // 엑셀 생성
    const wb = window.XLSX.utils.book_new();
    
    const ws1 = window.XLSX.utils.json_to_sheet(summaryData);
    window.XLSX.utils.book_append_sheet(wb, ws1, 'KPI 요약');
    
    const ws2 = window.XLSX.utils.json_to_sheet(vendorData);
    window.XLSX.utils.book_append_sheet(wb, ws2, '협력업체별 통계');
    
    if (lastWeekPicks.length > 0) {
      const pickData = lastWeekPicks.map(p => ({
        'Production Order': p.productionOrder || p.orderId,
        'Model': p.model,
        '담당자': p.worker || '-',
        '완료 시간': p.completed,
        'Cycle Time (분)': p.cycleMin || '-'
      }));
      const ws3 = window.XLSX.utils.json_to_sheet(pickData);
      window.XLSX.utils.book_append_sheet(wb, ws3, 'Kitting 상세');
    }
    
    if (lastWeekReceives.length > 0) {
      const receiveData = lastWeekReceives.map(r => ({
        'No.': r.poNo,
        '협력업체': r.vendor,
        'MIGO 완료': r.migo,
        'Cycle Time (분)': r.cycleMin || '-'
      }));
      const ws4 = window.XLSX.utils.json_to_sheet(receiveData);
      window.XLSX.utils.book_append_sheet(wb, ws4, '입고 상세');
    }

    const filename = `주간리포트_${formatDate(lastWeekStart)}_${formatDate(lastWeekEnd)}.xlsx`;
    window.XLSX.writeFile(wb, filename);
  };

  // 온습도 PDF 생성 함수
  const generateTempHumidityPDF = () => {
    const [year, month] = tempHumidityMonth.split('-').map(Number);
    const daysInMonth = new Date(year, month, 0).getDate();
    
    // 테이블 행 생성
    let tableRows = '';
    for (let day = 1; day <= 31; day++) {
      const dateKey = tempHumidityMonth + '-' + String(day).padStart(2, '0');
      const data = tempHumidityData[dateKey] || { temp: '', humidity: '' };
      const tempNum = parseFloat(data.temp);
      const humidNum = parseFloat(data.humidity);
      const tempStyle = !isNaN(tempNum) && (tempNum < 5 || tempNum > 40) ? 'color:red;font-weight:bold;' : '';
      const humidStyle = !isNaN(humidNum) && (humidNum < 0 || humidNum > 75) ? 'color:red;font-weight:bold;' : '';
      
      if (day > daysInMonth) {
        tableRows += '<tr><td>' + day + '</td><td>-</td><td>-</td><td>-</td></tr>';
      } else {
        const tempVal = data.temp || '';
        const humidVal = data.humidity || '';
        const recorder = (data.temp || data.humidity) ? tempHumidityRecorder : '';
        tableRows += '<tr><td>' + day + '</td><td style="' + tempStyle + '">' + tempVal + '</td><td style="' + humidStyle + '">' + humidVal + '</td><td>' + recorder + '</td></tr>';
      }
    }
    
    // Word 호환 HTML 생성 (mso 스타일 포함)
    const htmlContent = `
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="UTF-8">
<title>ESD Check Sheet - ${year}년 ${month}월</title>
<!--[if gte mso 9]>
<xml>
<w:WordDocument>
<w:View>Print</w:View>
<w:Zoom>100</w:Zoom>
</w:WordDocument>
</xml>
<![endif]-->
<style>
@page { size: A4; margin: 2cm; }
body { font-family: 'Malgun Gothic', Arial, sans-serif; font-size: 10pt; }
h1 { text-align: center; font-size: 14pt; margin-bottom: 5px; }
h2 { text-align: center; font-size: 11pt; color: #666; margin-top: 0; margin-bottom: 15px; }
table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
td, th { border: 1px solid #000; padding: 5px 8px; text-align: center; }
th { background-color: #e8e8e8; font-weight: bold; }
.header-table td { padding: 8px; }
.title-cell { font-weight: bold; background-color: #f5f5f5; width: 40%; font-size: 9pt; }
.signature-cell { width: 20%; }
</style>
</head>
<body>
<h1>Temp. & Humidity Check Log (Daily)</h1>
<h2>ESD Protected Work Area Check log - ${year}년 ${String(month).padStart(2, '0')}월</h2>

<table class="header-table">
<tr>
<td class="title-cell" rowspan="2">Temp. & Humidity Check Log(Daily)<br/>ESD Protected Work Area Check log</td>
<td class="signature-cell">Writer</td>
<td class="signature-cell">Reviewer</td>
<td class="signature-cell">Approver</td>
</tr>
<tr>
<td class="signature-cell">${tempHumidityRecorder}</td>
<td class="signature-cell"></td>
<td class="signature-cell"></td>
</tr>
</table>

<table>
<thead>
<tr>
<th style="width:12%">Day</th>
<th style="width:28%">Temp (℃)</th>
<th style="width:28%">Humidity (%)</th>
<th style="width:32%">Recorded by</th>
</tr>
</thead>
<tbody>
${tableRows}
</tbody>
</table>

<p style="font-size:8pt;color:#666;margin-top:20px;">
* Spec: Temp +5~40℃ / Humidity 0~75% (Equipment: NS-205B)<br/>
* Generated: ${new Date().toLocaleString('ko-KR')}
</p>
<\/body>
<\/html>`;
    
    // Blob으로 doc 파일 다운로드 (Word에서 열 수 있는 HTML)
    const blob = new Blob(['\ufeff' + htmlContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = year + '_' + String(month).padStart(2, '0') + '_ESD_Check_Sheet.doc';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('파일이 다운로드되었습니다!\\n\\n' + year + '_' + String(month).padStart(2, '0') + '_ESD_Check_Sheet.doc\\n\\nWord에서 열어 PDF로 저장하거나 바로 인쇄하세요.');
  };

  // CSV 내보내기 함수 (원본 docx 템플릿용)
  const exportTempHumidityCSV = () => {
    const [year, month] = tempHumidityMonth.split('-').map(Number);
    const daysInMonth = new Date(year, month, 0).getDate();
    
    // CSV 헤더
    let csvContent = 'Day,Temp,Humidity,Recorded_by\n';
    
    // 각 일별 데이터
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = tempHumidityMonth + '-' + String(day).padStart(2, '0');
      const data = tempHumidityData[dateKey] || { temp: '', humidity: '' };
      const temp = data.temp || '';
      const humidity = data.humidity || '';
      const recorder = (temp || humidity) ? tempHumidityRecorder : '';
      
      csvContent += day + ',' + temp + ',' + humidity + ',' + recorder + '\n';
    }
    
    // CSV 파일 다운로드
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = year + '_' + String(month).padStart(2, '0') + '_temp_humidity_data.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const addPick = () => {
    if (!newPick.productionOrder || !newPick.model || !newPick.received) return;
    
    // 불출 Cycle 추가
    setPickCycles(prev => [...prev, { 
      id: Date.now(), 
      ...newPick, 
      startTime: null,
      completed: null, 
      cycleMin: null, 
      totalPausedMs: 0,
      pausedAt: null,
      status: 'waiting' 
    }]);
    
    // Kitting에 같은 Production Order가 있으면 담당자 업데이트
    if (newPick.productionOrder && newPick.worker) {
      setKittingData(prev => prev.map(k => 
        k.productionOrder === newPick.productionOrder 
          ? { ...k, worker: newPick.worker }
          : k
      ));
    }
    
    setNewPick({ productionOrder: '', model: 'RSC48', received: '', worker: 'Z01', isUrgent: false });
    setShowPickModal(false);
  };

  // Order CSV 업로드 처리 (불출 Cycle + Kitting 현황 동시 업데이트)
  const handleOrderCsvUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          alert('❌ CSV 파일에 데이터가 없습니다.');
          return;
        }

        // 헤더 파싱
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const orderIdx = headers.findIndex(h => /^Order$/i.test(h));
        const descIdx = headers.findIndex(h => /Material description/i.test(h));
        const materialNumIdx = headers.findIndex(h => /Material Number/i.test(h));
        const startDateIdx = headers.findIndex(h => /Basic start date/i.test(h));
        // 담당자 (Prodn Supervisor) 컬럼 추가
        const supervisorIdx = headers.findIndex(h => /Prodn Supervisor/i.test(h) || /Production Supervisor/i.test(h) || /Supervisor/i.test(h));

        if (orderIdx === -1) {
          alert('❌ Order 컬럼을 찾을 수 없습니다.');
          return;
        }

        // Model 매핑 함수 (Material Number 기준)
        // RSC16(AS4500), RSC48(AS8500), CSC48(AS8000), FSC16(AS4600), CSC16(AS6000), HSM3.0(A2715)
        const getModelFromMaterial = (materialNum) => {
          if (!materialNum) return 'Spare Parts';
          const m = materialNum.toUpperCase();
          if (m === 'AS4500') return 'RSC16';
          if (m === 'AS8500') return 'RSC48';
          if (m === 'AS8000') return 'CSC48';
          if (m === 'AS4600') return 'FSC16';
          if (m === 'AS6000') return 'CSC16';
          if (m === 'A2715') return 'HSM3.0';
          return 'Spare Parts';
        };

        // 날짜 형식 통일 (YY-MM-DD → YYYY-MM-DD)
        const normalizeDate = (d) => {
          if (!d) return '';
          d = d.trim().split(' ')[0];
          // YY-MM-DD (예: 26-03-04)
          if (/^\d{2}-\d{2}-\d{2}$/.test(d)) return '20' + d;
          // DD.MM.YYYY (예: 04.03.2026)
          if (/^\d{2}\.\d{2}\.\d{4}$/.test(d)) { var p=d.split('.'); return p[2]+'-'+p[1]+'-'+p[0]; }
          // MM/DD/YYYY (예: 03/04/2026)
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(d)) { var p=d.split('/'); return p[2]+'-'+p[0]+'-'+p[1]; }
          return d;
        };

        // 데이터 파싱
        const newPickOrders = [];
        const newKittingOrders = [];
        const existingPickOrders = new Set(pickCycles.map(p => p.productionOrder));
        const existingKittingOrders = new Set(kittingData.map(k => k.productionOrder));
        const now = new Date().toISOString().slice(0, 16).replace('T', ' ');

        for (let i = 1; i < lines.length; i++) {
          // CSV 파싱 (쉼표 처리)
          const row = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
          if (!row) continue;

          const values = row.map(v => v.trim().replace(/^"|"$/g, '').replace(/\r/g, ''));
          const order = values[orderIdx];
          
          if (!order) continue;

          const desc = descIdx >= 0 ? values[descIdx] : '';
          const materialNum = materialNumIdx >= 0 ? values[materialNumIdx] : '';
          const startDate = startDateIdx >= 0 ? values[startDateIdx] : '';
          const model = getModelFromMaterial(materialNum);
          // 담당자 추출 (없으면 기본값 Z01)
          const worker = supervisorIdx >= 0 && values[supervisorIdx] ? values[supervisorIdx].trim() : 'Z01';

          // 불출 Cycle에 추가 (중복 아닌 경우)
          if (!existingPickOrders.has(order)) {
            newPickOrders.push({
              id: Date.now() + i,
              productionOrder: order,
              model: model,
              materialNum: materialNum,  // Part No.
              materialDesc: desc,
              received: now,
              basicStartDate: normalizeDate(startDate),
              worker: worker,  // 담당자 자동 매핑
              startTime: null,
              completed: null,
              cycleMin: null,
              totalPausedMs: 0,
              pausedAt: null,
              status: 'waiting'
            });
            existingPickOrders.add(order);
          }

          // Kitting 현황에 추가 (중복 아닌 경우)
          if (!existingKittingOrders.has(order)) {
            newKittingOrders.push({
              id: Date.now() + i + 100000,
              productionOrder: order,
              model: model,
              materialNum: materialNum,  // Part No.
              materialDesc: desc,
              basicStartDate: normalizeDate(startDate) || new Date().toISOString().split('T')[0],
              worker: worker,  // 담당자 자동 매핑
              isUrgent: false,
              status: 'waiting',
              createdAt: new Date().toISOString(),
              completedAt: null,
              leadTimeDays: null
            });
            existingKittingOrders.add(order);
          }
        }

        if (newPickOrders.length === 0 && newKittingOrders.length === 0) {
          alert('⚠️ 추가할 새로운 Order가 없습니다.\n(이미 등록된 Order이거나 유효하지 않은 데이터)');
          return;
        }

        // 불출 Cycle 업데이트
        if (newPickOrders.length > 0) {
          setPickCycles(prev => [...prev, ...newPickOrders]);
        }

        // Kitting 현황 업데이트
        if (newKittingOrders.length > 0) {
          setKittingData(prev => [...prev, ...newKittingOrders]);
        }

        alert(`✅ Order 업로드 완료!\n\n📦 불출 Cycle: ${newPickOrders.length}개 추가\n📋 Kitting 현황: ${newKittingOrders.length}개 추가`);
      } catch (error) {
        console.error('CSV parsing error:', error);
        alert('❌ CSV 파일 파싱 중 오류가 발생했습니다.');
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  // UTC 시간을 한국 시간으로 변환하는 함수
  // 새로 입력한 데이터(한국 시간)는 그대로, 기존 UTC 데이터만 +9시간
  const convertToKoreaTime = (timeStr) => {
    if (!timeStr || timeStr === '-') return timeStr;
    
    // "2026-02-23-13:54" 형식 (날짜-시간 사이 하이픈) → 공백으로 정규화
    const m = timeStr.match(/^(\d{4}-\d{2}-\d{2})[\-T\s](\d{2}:\d{2}.*)$/);
    if (m) timeStr = m[1] + ' ' + m[2];
    
    // "2026-02-03 12:00" 형식 확인
    if (timeStr.includes('-') && timeStr.includes(' ') && timeStr.length >= 16) {
      const [datePart, timePart] = timeStr.split(' ');
      if (datePart && timePart) {
        const hour = parseInt(timePart.split(':')[0]);
        
        // 07:00 ~ 23:59 범위면 이미 한국 시간으로 간주 (정상 근무/생활 시간)
        // 00:00 ~ 06:59 범위면 UTC일 가능성 높음 (한국시간 09:00~15:59)
        if (hour >= 7 && hour <= 23) {
          return timeStr; // 이미 한국 시간, 그대로 반환
        }
      }
    }
    
    try {
      // ISO 형식이나 다른 형식의 날짜 파싱
      let date;
      if (timeStr.includes('T')) {
        date = new Date(timeStr);
      } else {
        // "2026-02-03 04:35" 형식 → UTC로 해석하여 +9시간
        const [datePart, timePart] = timeStr.split(' ');
        if (datePart && timePart) {
          const [year, month, day] = datePart.split('-');
          const [hour, minute] = timePart.split(':');
          date = new Date(Date.UTC(year, month - 1, day, hour, minute));
        } else {
          return timeStr;
        }
      }
      
      if (isNaN(date.getTime())) return timeStr;
      
      // 한국 시간으로 변환
      const koreaTime = date.toLocaleString('ko-KR', {
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      
      // "2026. 02. 03. 13:35" → "2026-02-03 13:35" 형식으로 변환
      return koreaTime.replace(/\. /g, '-').replace('.', '');
    } catch (e) {
      return timeStr;
    }
  };

  // 근무시간만 계산하는 함수 (평일 07:00~16:00, 한국 시간 기준)
  const calculateWorkingMinutes = (startTime, endTime) => {
    const start = new Date(startTime);
    const end = new Date(endTime);
    
    const WORK_START_HOUR = 7;   // 오전 7시
    const WORK_END_HOUR = 16;    // 오후 4시
    const LUNCH_START = 12.5;    // 점심 시작 12:30
    const LUNCH_END = 13.5;      // 점심 종료 13:30
    
    let totalMinutes = 0;
    let current = new Date(start);
    
    // 한국 시간대 오프셋 (UTC+9)
    const getKoreaHour = (date) => {
      const koreaTime = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
      return koreaTime.getHours();
    };
    
    const getKoreaMinute = (date) => {
      const koreaTime = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
      return koreaTime.getMinutes();
    };
    
    const getKoreaDay = (date) => {
      const koreaTime = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
      return koreaTime.getDay();
    };
    
    while (current < end) {
      const dayOfWeek = getKoreaDay(current); // 0=일, 1=월, ..., 6=토
      const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5; // 월~금
      
      // 한국시간 기준 날짜 문자열로 공휴일 체크
      const krDate = new Date(current.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
      const dateStr = krDate.getFullYear() + '-' + String(krDate.getMonth()+1).padStart(2,'0') + '-' + String(krDate.getDate()).padStart(2,'0');
      const isHoliday = KR_HOLIDAYS.has(dateStr);
      
      if (isWeekday && !isHoliday) {
        const currentHour = getKoreaHour(current);
        const currentMinute = getKoreaMinute(current);
        const currentTime = currentHour + currentMinute / 60; // 시간을 소수점으로 변환
        
        // 근무시간 내인지 확인 (07:00 ~ 16:00)
        // 점심시간 제외 (12:30 ~ 13:30)
        const isWorkingHour = currentHour >= WORK_START_HOUR && currentHour < WORK_END_HOUR;
        const isLunchTime = currentTime >= LUNCH_START && currentTime < LUNCH_END;
        
        if (isWorkingHour && !isLunchTime) {
          totalMinutes += 1;
        }
      }
      
      // 1분씩 증가
      current = new Date(current.getTime() + 60000);
    }
    
    return totalMinutes;
  };

  const addReceive = () => {
    if (!newReceive.vendor) return;
    
    // 자동 번호 계산: 현재 최대값 + 1
    const maxNo = receiveCycles.reduce((max, r) => {
      const num = parseInt(r.poNo) || 0;
      return num > max ? num : max;
    }, 0);
    const newPoNo = String(maxNo + 1);
    
    // 현재 시간을 납품 시각으로 사용
    const now = new Date();
    const deliveryStr = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
    
    setReceiveCycles(prev => [...prev, { 
      id: Date.now(), 
      poNo: newPoNo,
      vendor: newReceive.vendor,
      delivery: deliveryStr,
      startTime: now.toISOString(),  // 현재 시각 기준으로 Cycle Time 계산
      migo: null, 
      cycleMin: null, 
      totalPausedMs: 0,
      pausedAt: null,
      status: 'in-progress'  // 바로 진행중 상태
    }]);
    setNewReceive({ poNo: '', vendor: '', delivery: '' });
    setShowReceiveModal(false);
  };

  // ===== 다중 선택 관련 함수들 =====
  
  // Pick 전체 선택/해제
  const toggleAllPicks = () => {
    if (selectedPicks.size === pickCycles.length) {
      setSelectedPicks(new Set());
    } else {
      setSelectedPicks(new Set(pickCycles.map(p => p.id)));
    }
  };

  // Pick 개별 선택/해제
  const togglePickSelection = (id) => {
    const newSet = new Set(selectedPicks);
    if (newSet.has(id)) {
      newSet.delete(id);
    } else {
      newSet.add(id);
    }
    setSelectedPicks(newSet);
  };

  // Receive 전체 선택/해제
  const toggleAllReceives = () => {
    if (selectedReceives.size === receiveCycles.length) {
      setSelectedReceives(new Set());
    } else {
      setSelectedReceives(new Set(receiveCycles.map(r => r.id)));
    }
  };

  // Receive 개별 선택/해제
  const toggleReceiveSelection = (id) => {
    const newSet = new Set(selectedReceives);
    if (newSet.has(id)) {
      newSet.delete(id);
    } else {
      newSet.add(id);
    }
    setSelectedReceives(newSet);
  };

  // 선택된 Pick 일괄 시작
  const startSelectedPicks = () => {
    if (selectedPicks.size === 0) return;
    const now = new Date().toISOString();
    const idsToStart = Array.from(selectedPicks);
    
    // 먼저 Production Order 목록 수집
    const productionOrders = pickCycles
      .filter(p => idsToStart.includes(p.id) && p.status === 'waiting')
      .map(p => p.productionOrder);
    
    setPickCycles(prev => prev.map(p => 
      idsToStart.includes(p.id) && p.status === 'waiting'
        ? { ...p, startTime: now, status: 'in-progress' }
        : p
    ));
    
    // Kitting도 같이 시작
    if (productionOrders.length > 0) {
      setKittingData(prev => prev.map(k => 
        productionOrders.includes(k.productionOrder) && k.status === 'waiting'
          ? { ...k, status: 'in-progress', startedAt: now }
          : k
      ));
    }
    
    setSelectedPicks(new Set());
  };

  // 선택된 Pick 일괄 완료
  const completeSelectedPicks = () => {
    if (selectedPicks.size === 0) return;
    const now = new Date();
    const idsToComplete = Array.from(selectedPicks);
    
    // 먼저 Production Order 목록 수집
    const productionOrders = pickCycles
      .filter(p => idsToComplete.includes(p.id) && (p.status === 'in-progress' || p.status === 'paused') && p.startTime)
      .map(p => p.productionOrder);
    
    setPickCycles(prev => prev.map(p => {
      if (idsToComplete.includes(p.id) && (p.status === 'in-progress' || p.status === 'paused') && p.startTime) {
        const totalPaused = p.totalPausedMs || 0;
        const cycleMin = Math.round((now - new Date(p.startTime) - totalPaused) / 60000);
        return { ...p, completed: now.toISOString().slice(0,16).replace('T',' '), cycleMin, status: 'completed' };
      }
      return p;
    }));
    
    // Kitting도 같이 완료
    if (productionOrders.length > 0) {
      setKittingData(prev => prev.map(k => {
        if (productionOrders.includes(k.productionOrder) && k.status !== 'completed') {
          // 시작 시간이 있으면 실제 작업 시간 계산, 없으면 0
          let leadTimeDays = 0;
          if (k.startedAt) {
            const startTime = new Date(k.startedAt);
            leadTimeDays = getBusinessDays(startTime, now); // 영업일 기준 (주말+공휴일 제외)
          }
          return { ...k, status: 'completed', completedAt: now.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\. /g, '-').replace('.', ''), leadTimeDays };
        }
        return k;
      }));
    }
    
    setSelectedPicks(new Set());
  };

  // 선택된 Pick 일괄 삭제 (모달 호출)
  const deleteSelectedPicks = () => {
    if (selectedPicks.size === 0) return;
    setDeleteConfirm({ show: true, type: 'pick', id: null, text: '', count: selectedPicks.size });
  };

  // 실제 Pick 삭제 실행
  const confirmDeletePicks = () => {
    const idsToDelete = [...selectedPicks];
    setPickCycles(prev => prev.filter(p => !idsToDelete.includes(p.id)));
    setSelectedPicks(new Set());
    setDeleteConfirm({ show: false, type: '', id: null, text: '', count: 0 });
  };

  // 선택된 Receive 일괄 시작
  const startSelectedReceives = () => {
    if (selectedReceives.size === 0) return;
    const now = new Date().toISOString();
    const idsToStart = Array.from(selectedReceives);
    setReceiveCycles(prev => prev.map(r => 
      idsToStart.includes(r.id) && r.status === 'waiting' 
        ? { ...r, startTime: now, status: 'in-progress' } 
        : r
    ));
    setSelectedReceives(new Set());
  };

  // 선택된 Receive 일괄 완료
  const completeSelectedReceives = () => {
    if (selectedReceives.size === 0) return;
    const now = new Date();
    const idsToComplete = Array.from(selectedReceives);
    setReceiveCycles(prev => prev.map(r => {
      if (idsToComplete.includes(r.id) && (r.status === 'in-progress' || r.status === 'paused') && r.startTime) {
        const totalPaused = r.totalPausedMs || 0;
        const cycleMin = Math.round((now - new Date(r.startTime) - totalPaused) / 60000);
        return { ...r, migo: now.toISOString().slice(0,16).replace('T',' '), cycleMin, status: 'completed' };
      }
      return r;
    }));
    setSelectedReceives(new Set());
  };

  // 선택된 Receive 일괄 삭제 (모달 호출)
  const deleteSelectedReceives = () => {
    if (selectedReceives.size === 0) return;
    setDeleteConfirm({ show: true, type: 'receive', id: null, text: '', count: selectedReceives.size });
  };

  // 실제 Receive 삭제 실행
  const confirmDeleteReceives = () => {
    const idsToDelete = [...selectedReceives];
    setReceiveCycles(prev => prev.filter(r => !idsToDelete.includes(r.id)));
    setSelectedReceives(new Set());
    setDeleteConfirm({ show: false, type: '', id: null, text: '', count: 0 });
  };

  // Kitting 추가
  const addKitting = () => {
    if (!newKitting.productionOrder) return;
    const newItem = {
      id: Date.now(),
      ...newKitting,
      materialDesc: '',
      status: 'waiting', // waiting, in-progress, completed
      createdAt: new Date().toISOString(),
      completedAt: null,
      leadTimeDays: null
    };
    setKittingData(prev => [...prev, newItem]);
    setNewKitting({ productionOrder: '', model: 'RSC48', basicStartDate: '', worker: 'Z01', isUrgent: false });
    setShowKittingModal(false);
  };

  // Kitting 완료 처리
  const completeKitting = (id) => {
    const now = new Date();
    
    // 먼저 productionOrder 찾기
    const targetKitting = kittingData.find(k => k.id === id);
    const productionOrder = targetKitting?.productionOrder;
    
    setKittingData(prev => prev.map(k => {
      if (k.id === id) {
        // 시작 시간이 있으면 실제 작업 시간 계산, 없으면 0
        let leadTimeDays = 0;
        if (k.startedAt) {
          const startTime = new Date(k.startedAt);
          leadTimeDays = getBusinessDays(startTime, now); // 영업일 기준 (주말+공휴일 제외)
        }
        return { ...k, status: 'completed', completedAt: now.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\. /g, '-').replace('.', ''), leadTimeDays };
      }
      return k;
    }));
    
    // 불출 Cycle도 같이 완료 처리
    if (productionOrder) {
      const nowStr = now.toISOString().slice(0, 16).replace('T', ' ');
      setPickCycles(prev => prev.map(p => {
        if ((p.productionOrder === productionOrder || p.orderId === productionOrder) && p.status !== 'completed') {
          const cycleMin = p.startTime ? calculateWorkingMinutes(p.startTime, now.toISOString()) : 0;
          return { ...p, completed: nowStr, cycleMin, status: 'completed' };
        }
        return p;
      }));
    }
  };

  // Kitting 시작 처리
  const startKitting = (id) => {
    const now = new Date().toISOString();
    
    // 먼저 productionOrder 찾기
    const targetKitting = kittingData.find(k => k.id === id);
    const productionOrder = targetKitting?.productionOrder;
    
    setKittingData(prev => prev.map(k => 
      k.id === id ? { ...k, status: 'in-progress', startedAt: now } : k
    ));
    
    // 불출 Cycle도 같이 시작 처리
    if (productionOrder) {
      setPickCycles(prev => prev.map(p => 
        (p.productionOrder === productionOrder || p.orderId === productionOrder) && p.status === 'waiting'
          ? { ...p, startTime: now, status: 'in-progress' }
          : p
      ));
    }
  };

  // Kitting 일시정지 처리
  const pauseKitting = (id) => {
    const now = new Date().toISOString();
    
    // 먼저 productionOrder 찾기
    const targetKitting = kittingData.find(k => k.id === id);
    const productionOrder = targetKitting?.productionOrder;
    
    setKittingData(prev => prev.map(k => 
      k.id === id ? { ...k, status: 'paused', pausedAt: now } : k
    ));
    
    // 불출 Cycle도 같이 일시정지 처리
    if (productionOrder) {
      setPickCycles(prev => prev.map(p => 
        (p.productionOrder === productionOrder || p.orderId === productionOrder) && p.status === 'in-progress'
          ? { ...p, pausedAt: now, status: 'paused' }
          : p
      ));
    }
  };

  // Kitting 재개 처리
  const resumeKitting = (id) => {
    const now = new Date();
    
    // 먼저 productionOrder 찾기
    const targetKitting = kittingData.find(k => k.id === id);
    const productionOrder = targetKitting?.productionOrder;
    
    setKittingData(prev => prev.map(k => {
      if (k.id === id && k.status === 'paused') {
        const pausedMs = k.pausedAt ? now - new Date(k.pausedAt) : 0;
        return { 
          ...k, 
          status: 'in-progress',
          totalPausedMs: (k.totalPausedMs || 0) + pausedMs,
          pausedAt: null
        };
      }
      return k;
    }));
    
    // 불출 Cycle도 같이 재개 처리
    if (productionOrder) {
      setPickCycles(prev => prev.map(p => {
        if ((p.productionOrder === productionOrder || p.orderId === productionOrder) && p.status === 'paused') {
          const pausedMs = p.pausedAt ? now - new Date(p.pausedAt) : 0;
          return { 
            ...p, 
            totalPausedMs: (p.totalPausedMs || 0) + pausedMs,
            pausedAt: null, 
            status: 'in-progress' 
          };
        }
        return p;
      }));
    }
  };

  // Kitting 선택 토글
  const toggleKittingSelection = (id) => {
    setSelectedKittings(prev => {
      const newSet = new Set(prev);
      if (newSet.has(id)) newSet.delete(id);
      else newSet.add(id);
      return newSet;
    });
  };

  // Kitting 일괄 완료
  const completeSelectedKittings = () => {
    if (selectedKittings.size === 0) return;
    const now = new Date();
    const idsToComplete = Array.from(selectedKittings);
    
    // 먼저 Production Order 목록 수집
    const productionOrders = kittingData
      .filter(k => idsToComplete.includes(k.id) && k.status !== 'completed')
      .map(k => k.productionOrder);
    
    setKittingData(prev => prev.map(k => {
      if (idsToComplete.includes(k.id) && k.status !== 'completed') {
        // 시작 시간이 있으면 실제 작업 시간 계산, 없으면 0
        let leadTimeDays = 0;
        if (k.startedAt) {
          const startTime = new Date(k.startedAt);
          leadTimeDays = getBusinessDays(startTime, now); // 영업일 기준 (주말+공휴일 제외)
        }
        return { ...k, status: 'completed', completedAt: now.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\. /g, '-').replace('.', ''), leadTimeDays };
      }
      return k;
    }));
    
    // 불출 Cycle도 같이 완료
    if (productionOrders.length > 0) {
      const nowStr = now.toISOString().slice(0, 16).replace('T', ' ');
      setPickCycles(prev => prev.map(p => {
        if (productionOrders.includes(p.productionOrder) && p.status !== 'completed') {
          const cycleMin = p.startTime ? calculateWorkingMinutes(p.startTime, now.toISOString()) : 0;
          return { ...p, completed: nowStr, cycleMin, status: 'completed' };
        }
        return p;
      }));
    }
    
    setSelectedKittings(new Set());
  };

  // Kitting 일괄 삭제
  const deleteSelectedKittings = () => {
    if (selectedKittings.size === 0) return;
    setDeleteConfirm({ show: true, type: 'kitting', id: null, text: '', count: selectedKittings.size });
  };

  const confirmDeleteKittings = () => {
    const idsToDelete = [...selectedKittings];
    setKittingData(prev => prev.filter(k => !idsToDelete.includes(k.id)));
    setSelectedKittings(new Set());
    setDeleteConfirm({ show: false, type: '', id: null, text: '', count: 0 });
  };

  // Kitting CSV 업로드
  const handleKittingCsvUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          alert('유효한 데이터가 없습니다.');
          return;
        }
        
        // 헤더 파싱
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const orderIdx = headers.findIndex(h => /^Order$/i.test(h));
        const descIdx = headers.findIndex(h => /Material description/i.test(h));
        const materialNumIdx = headers.findIndex(h => /Material Number/i.test(h));
        const startDateIdx = headers.findIndex(h => /Basic start date/i.test(h));
        
        if (orderIdx === -1) {
          alert('❌ Order 컬럼을 찾을 수 없습니다.');
          return;
        }
        
        // Model 매핑 함수 (Material Number 기준) - 불출과 동일
        // RSC16(AS4500), RSC48(AS8500), CSC48(AS8000), FSC16(AS4600), CSC16(AS6000), HSM3.0(A2715)
        const getModelFromMaterial = (materialNum) => {
          if (!materialNum) return 'Spare Parts';
          const m = materialNum.toUpperCase();
          if (m === 'AS4500') return 'RSC16';
          if (m === 'AS8500') return 'RSC48';
          if (m === 'AS8000') return 'CSC48';
          if (m === 'AS4600') return 'FSC16';
          if (m === 'AS6000') return 'CSC16';
          if (m === 'A2715') return 'HSM3.0';
          return 'Spare Parts';
        };
        
        // 날짜 형식 통일
        const normalizeDate2 = (d) => {
          if (!d) return '';
          d = d.trim().split(' ')[0];
          if (/^\d{2}-\d{2}-\d{2}$/.test(d)) return '20' + d;
          if (/^\d{2}\.\d{2}\.\d{4}$/.test(d)) { var p=d.split('.'); return p[2]+'-'+p[1]+'-'+p[0]; }
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(d)) { var p=d.split('/'); return p[2]+'-'+p[0]+'-'+p[1]; }
          return d;
        };
        
        const newItems = [];
        for (let i = 1; i < lines.length; i++) {
          // CSV 파싱 (쉼표 처리)
          const row = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
          if (!row) continue;
          
          const values = row.map(v => v.trim().replace(/^"|"$/g, '').replace(/\r/g, ''));
          const productionOrder = values[orderIdx];
          
          if (!productionOrder) continue;
          
          // 중복 체크
          const exists = kittingData.some(k => k.productionOrder === productionOrder);
          if (exists) continue;
          
          const materialDesc = descIdx >= 0 ? values[descIdx] : '';
          const materialNum = materialNumIdx >= 0 ? values[materialNumIdx] : '';
          const startDate = startDateIdx >= 0 ? values[startDateIdx] : '';
          const model = getModelFromMaterial(materialNum);
          
          newItems.push({
            id: Date.now() + i,
            productionOrder,
            model,
            materialNum,
            materialDesc,
            basicStartDate: normalizeDate2(startDate) || new Date().toISOString().split('T')[0],
            worker: 'Z01',
            isUrgent: false,
            status: 'waiting',
            createdAt: new Date().toISOString(),
            completedAt: null,
            leadTimeDays: null
          });
        }
        
        if (newItems.length > 0) {
          setKittingData(prev => [...prev, ...newItems]);
          alert(`✅ ${newItems.length}개의 Kitting 항목이 추가되었습니다.`);
        } else {
          alert('추가할 새로운 항목이 없습니다. (중복 제외)');
        }
      } catch (error) {
        alert('❌ CSV 파일 파싱 중 오류가 발생했습니다.');
        console.error(error);
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  // Kitting 엑셀 다운로드
  const downloadKittingExcel = async () => {
    try {
      const XLSX = await new Promise((res)=>{if(window.XLSX){res(window.XLSX);return;}var s=document.createElement('script');s.src='https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';s.onload=()=>res(window.XLSX);document.head.appendChild(s);});
      const data = kittingData.map(k => ({
        'Production Order': k.productionOrder,
        'Model': k.model,
        'Material Description': k.materialDesc || '',
        '시작예정일': k.basicStartDate || '',
        '담당자': k.worker || '',
        '긴급': k.isUrgent ? '긴급' : '일반',
        '상태': k.status === 'completed' ? '완료' : k.status === 'in-progress' ? '진행중' : k.status === 'paused' ? '일시정지' : '대기',
        '완료일': k.completedAt || '',
        'Lead Time(일)': k.leadTimeDays || ''
      }));
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Kitting현황');
      XLSX.writeFile(workbook, `PBK_Kitting현황_${new Date().toISOString().slice(0,10)}.xlsx`);
    } catch (error) {
      // 폴백: CSV로 다운로드
      const headers = ['Production Order', 'Model', 'Material Description', '시작예정일', '담당자', '긴급', '상태', '완료일', 'Lead Time(일)'];
      const rows = kittingData.map(k => [
        k.productionOrder, k.model, k.materialDesc || '', k.basicStartDate || '', k.worker || '',
        k.isUrgent ? '긴급' : '일반', k.status === 'completed' ? '완료' : k.status === 'in-progress' ? '진행중' : '대기',
        k.completedAt || '', k.leadTimeDays || ''
      ]);
      const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `Kitting_현황_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }
  };

  // Kitting 수정 저장
  const saveEditKitting = () => {
    if (!editingKitting) return;
    setKittingData(prev => prev.map(k => k.id === editingKitting.id ? editingKitting : k));
    setEditingKitting(null);
  };

  // Kitting 필터링 및 정렬
  const filteredSortedKittings = React.useMemo(() => {
    let result = [...kittingData];
    
    // 월별 필터
    if (kittingFilterMonth) {
      const ym = kittingFilterMonth; // "2026-03"
      const ymShort = ym.slice(2); // "26-03"
      result = result.filter(k => 
        k.basicStartDate?.startsWith(ym) || k.basicStartDate?.startsWith(ymShort) ||
        k.completedAt?.startsWith(ym) || k.completedAt?.startsWith(ymShort)
      );
    }
    
    // 검색어 필터
    if (kittingSearchTerm) {
      const term = kittingSearchTerm.toLowerCase();
      result = result.filter(k => 
        k.productionOrder?.toLowerCase().includes(term) ||
        k.materialDesc?.toLowerCase().includes(term)
      );
    }
    
    // 모델 필터
    if (kittingFilterModel !== 'all') {
      if (kittingFilterModel === 'Maxwell 48') {
        result = result.filter(k => ['RSC48', 'CSC48'].includes(k.model));
      } else if (kittingFilterModel === 'Maxwell 16') {
        result = result.filter(k => ['RSC16', 'CSC16', 'FSC16'].includes(k.model));
      } else {
        result = result.filter(k => k.model === kittingFilterModel);
      }
    }
    
    // 상태 필터
    if (kittingFilterStatus !== 'all') {
      result = result.filter(k => k.status === kittingFilterStatus);
    }
    
    // 정렬
    result.sort((a, b) => {
      let aVal = a[kittingSortBy] || '';
      let bVal = b[kittingSortBy] || '';
      if (kittingSortOrder === 'asc') return aVal.localeCompare(bVal);
      return bVal.localeCompare(aVal);
    });
    
    return result;
  }, [kittingData, kittingFilterMonth, kittingSearchTerm, kittingFilterModel, kittingFilterStatus, kittingSortBy, kittingSortOrder]);

  // Pick 수정 저장
  const saveEditPick = () => {
    if (!editingPick) return;
    
    // 불출 Cycle 저장
    setPickCycles(prev => prev.map(p => p.id === editingPick.id ? editingPick : p));
    
    // Kitting 담당자도 같이 변경
    const productionOrder = editingPick.productionOrder || editingPick.orderId;
    if (productionOrder && editingPick.worker) {
      setKittingData(prev => prev.map(k => 
        k.productionOrder === productionOrder 
          ? { ...k, worker: editingPick.worker }
          : k
      ));
    }
    
    setEditingPick(null);
  };

  // Receive 수정 저장
  const saveEditReceive = () => {
    if (!editingReceive) return;
    // delivery 형식 정규화 (하이픈 구분 → 공백 구분)
    const cleaned = {...editingReceive};
    if (cleaned.delivery) {
      const dm = cleaned.delivery.match(/^(\d{4}-\d{2}-\d{2})[\-T\s](\d{2}:\d{2})/);
      if (dm) cleaned.delivery = dm[1] + ' ' + dm[2];
    }
    setReceiveCycles(prev => prev.map(r => r.id === cleaned.id ? cleaned : r));
    setEditingReceive(null);
  };

  // ========== v15 헬퍼 함수들 ==========
  
  // 토스트 메시지 표시
  const showToast = (message, type = 'success') => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== id));
    }, 3000);
  };

  // v17: XLSX 라이브러리 동적 로드 헬퍼
  const ensureXLSX = () => new Promise((resolve, reject) => {
    if (window.XLSX) return resolve();
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    script.onload = resolve;
    script.onerror = () => reject(new Error('XLSX 라이브러리 로드 실패'));
    document.head.appendChild(script);
  });

  // v17: GR Cancel SUM 시트 파싱 함수 (showToast 이후 정의)
  const parseGRCancelExcel = async (file) => {
    setGrCancelUploadStatus('loading');
    setGrCancelUploadMsg('파일 읽는 중...');
    try {
      await ensureXLSX();
    } catch (err) {
      setGrCancelUploadStatus('error');
      setGrCancelUploadMsg('❌ XLSX 라이브러리 로드 실패');
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = window.XLSX.read(data, { type: 'array' });
        const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const newQty = {};
        const newCancel = {};

        // ── STEP 1: SUM 시트 파싱 ──
        const sumSheetName = workbook.SheetNames.find(n => n.toUpperCase() === 'SUM');
        if (sumSheetName) {
          const ws = workbook.Sheets[sumSheetName];
          const rows = window.XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
          if (rows.length >= 5) {
            const headerRow = rows[0];
            const qtyRow    = rows[1];
            const cancelRow = rows[3];
            let currentYear = null;
            for (let col = 1; col < headerRow.length; col++) {
              const cell = headerRow[col];
              if (cell === null || cell === undefined) continue;
              if (typeof cell === 'number' && cell >= 2020 && cell <= 2030) {
                currentYear = Math.round(cell);
                continue;
              }
              if (typeof cell === 'string' && MONTH_NAMES.includes(cell)) {
                if (!currentYear) continue;
                const mNum = MONTH_NAMES.indexOf(cell) + 1;
                const key = `${currentYear}-${String(mNum).padStart(2, '0')}`;
                const qty = qtyRow[col];
                const cancel = cancelRow[col];
                if (typeof qty === 'number' && qty > 0) newQty[key] = Math.round(qty);
                if (typeof cancel === 'number' && cancel >= 0) newCancel[key] = Math.round(cancel);
              }
            }
          }
        }

        const qtyCount = Object.keys(newQty).length;
        const cancelCount = Object.keys(newCancel).length;
        if (qtyCount === 0) throw new Error('SUM 시트에서 데이터를 파싱할 수 없습니다. SUM 시트를 확인하세요.');

        setKpiData(prev => ({
          ...prev,
          grCancel: { ...prev.grCancel, ...newCancel },
          grCancelQty: { ...prev.grCancelQty, ...newQty }
        }));
        setGrCancelUploadStatus('success');
        setGrCancelUploadMsg(`✅ 파싱 완료: ${qtyCount}개월 (SUM + 개별 시트 보완)`);
        showToast(`GR Cancel 데이터 ${qtyCount}개월 로드 완료!`, 'success');
      } catch (err) {
        setGrCancelUploadStatus('error');
        setGrCancelUploadMsg(`❌ 오류: ${err.message}`);
        showToast('파일 파싱 실패: ' + err.message, 'error');
      }
    };
    reader.readAsArrayBuffer(file);
  };

  // v17: 재고 손실율 엑셀 업로드 파싱 함수
  const parseInventoryLossExcel = async (file) => {
    setInventoryLossUploadStatus('loading');
    setInventoryLossUploadMsg('파일 읽는 중...');
    try {
      await ensureXLSX();
    } catch (err) {
      setInventoryLossUploadStatus('error');
      setInventoryLossUploadMsg('❌ XLSX 라이브러리 로드 실패');
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = window.XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames.find(n => n === 'Ratio') || workbook.SheetNames[0];
        const ws = workbook.Sheets[sheetName];
        const rows = window.XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
        const newInvAdj = {};
        const headerRow = rows[0] || [];
        const adjustRow = rows[3] || [];
        for (let col = 1; col < headerRow.length; col++) {
          const h = headerRow[col];
          if (!h) continue;
          const qMatch = typeof h === 'string' && h.match(/(\d{4})\s*\/\s*Q(\d)/);
          if (qMatch) {
            const year = parseInt(qMatch[1]);
            const quarter = parseInt(qMatch[2]);
            const month = quarter * 3;
            const key = `${year}-${String(month).padStart(2, '0')}`;
            const val = adjustRow[col];
            if (typeof val === 'number') newInvAdj[key] = parseFloat((val * 100).toFixed(4));
          }
        }
        if (Object.keys(newInvAdj).length > 0) {
          setKpiData(prev => ({ ...prev, inventoryAdjust: { ...prev.inventoryAdjust, ...newInvAdj } }));
          setInventoryLossUploadStatus('success');
          setInventoryLossUploadMsg(`✅ ${Object.keys(newInvAdj).length}개 기간 데이터 로드 (분기별). 월별 형식 확정 후 업데이트 예정.`);
          showToast('재고 손실율 데이터 업로드 완료', 'success');
        } else {
          setInventoryLossUploadStatus('error');
          setInventoryLossUploadMsg('❌ 파싱된 데이터 없음. 형식을 확인하세요.');
        }
      } catch (err) {
        setInventoryLossUploadStatus('error');
        setInventoryLossUploadMsg(`❌ 오류: ${err.message}`);
        showToast('파일 파싱 실패: ' + err.message, 'error');
      }
    };
    reader.readAsArrayBuffer(file);
  };
  
  // 알림 추가
  const addNotification = (title, message, type = 'info') => {
    const notification = {
      id: Date.now(),
      title,
      message,
      type,
      timestamp: new Date().toISOString(),
      read: false
    };
    setNotifications(prev => [notification, ...prev].slice(0, 50)); // 최대 50개 유지
  };
  
  // 알림 읽음 처리
  const markNotificationAsRead = (id) => {
    setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
  };
  
  // 모든 알림 읽음 처리
  const markAllNotificationsAsRead = () => {
    setNotifications(prev => prev.map(n => ({ ...n, read: true })));
  };
  
  // 알림 삭제
  const deleteNotification = (id) => {
    setNotifications(prev => prev.filter(n => n.id !== id));
  };
  
  // 모든 알림 삭제
  const clearAllNotifications = () => {
    setNotifications([]);
  };
  
  // 데이터 히스토리 추가
  const addDataHistory = (type, description, itemCount) => {
    const history = {
      id: Date.now(),
      type,
      description,
      itemCount,
      timestamp: new Date().toISOString()
    };
    setDataHistory(prev => [history, ...prev].slice(0, 100)); // 최대 100개 유지
  };
  
  // 경과 시간 계산 (상세)
  const getElapsedTimeDetail = (dateString) => {
    if (!dateString) return '정보 없음';
    
    try {
      // 한국어 날짜 형식 파싱: "2026. 2. 9. 오후 3:30:00" 또는 "2026. 2. 9. 오전 10:30:00"
      let past;
      
      if (dateString.includes('오전') || dateString.includes('오후')) {
        // 한국어 형식
        const isAM = dateString.includes('오전');
        const cleaned = dateString.replace('오전', '').replace('오후', '').trim();
        const parts = cleaned.split(/[.\s:]+/).filter(p => p);
        
        if (parts.length >= 5) {
          let hours = parseInt(parts[3]);
          if (!isAM && hours !== 12) hours += 12;
          if (isAM && hours === 12) hours = 0;
          
          past = new Date(
            parseInt(parts[0]), // year
            parseInt(parts[1]) - 1, // month (0-indexed)
            parseInt(parts[2]), // day
            hours,
            parseInt(parts[4]),
            parseInt(parts[5]) || 0
          );
        }
      }
      
      // ISO 형식 또는 기타 형식 시도
      if (!past || isNaN(past.getTime())) {
        past = new Date(dateString);
      }
      
      if (isNaN(past.getTime())) {
        // 파싱 실패 시 원본 문자열에서 시간 부분 제거하고 반환
        return dateString.replace(/:\d{2}$/, '');
      }
      
      const now = new Date();
      const diffMs = now - past;
      
      const minutes = Math.floor(diffMs / (1000 * 60));
      const hours = Math.floor(diffMs / (1000 * 60 * 60));
      const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (days > 0) {
        return `${days}일 전`;
      } else if (hours > 0) {
        return `${hours}시간 전`;
      } else if (minutes > 0) {
        return `${minutes}분 전`;
      } else {
        return '방금 전';
      }
    } catch (e) {
      // 에러 시 원본 반환
      return dateString.replace(/:\d{2}$/, '');
    }
  };
  
  // 공간 최적화 분석 (개선된 버전)
  const analyzeSpaceOptimization = () => {
    const suggestions = [];
    if (inventoryData.length === 0) return suggestions;
    
    const SPECIAL_AREAS = ['D2', 'E', 'F1', 'LABEL'];
    
    // 1. 영역별 공간 사용률 계산 (핵심!)
    const areaUtils = [];
    rackSummary.forEach(rack => {
      if (SPECIAL_AREAS.includes(rack.id)) return;
      
      const areaItems = inventoryData.filter(item => {
        const bin = item.bin || '';
        return bin.startsWith(rack.id + '-') || bin === rack.id;
      });
      
      const binGroups = {};
      areaItems.forEach(item => {
        const bin = item.bin || rack.id;
        if (!binGroups[bin]) binGroups[bin] = [];
        binGroups[bin].push(item);
      });
      
      let totalCur = 0, totalMax = 0;
      Object.entries(binGroups).forEach(([bin, items]) => {
        let binCur = 0;
        items.forEach(item => {
          const qtyPerBox = MATERIAL_QTY_PER_BOX[item.material] || 1;
          binCur += (item.stock || 0) / qtyPerBox;
        });
        totalCur += binCur;
        
        const binInfo = BIN_RACK_INFO[bin] || { rackType: '경량랙', rackCount: 1 };
        if (binInfo.maxBoxes) {
          totalMax += binInfo.maxBoxes;
        } else if (binInfo.mixed) {
          const binBoxTypes = items.map(i => MATERIAL_BOX_MAP[i.material] || 'PLASTIC-S');
          const tc = {};
          binBoxTypes.forEach(t => { tc[t] = (tc[t] || 0) + 1; });
          const mainBT = Object.entries(tc).sort((a, b) => b[1] - a[1])[0]?.[0] || 'PLASTIC-S';
          binInfo.mixed.forEach(m => {
            const s = BOXES_PER_SHELF[m.type] || BOXES_PER_SHELF['경량랙'];
            totalMax += (s[mainBT] || s['PLASTIC-S'] || 2) * m.count;
          });
        } else {
          const binBoxTypes = items.map(i => MATERIAL_BOX_MAP[i.material] || 'PLASTIC-S');
          const tc = {};
          binBoxTypes.forEach(t => { tc[t] = (tc[t] || 0) + 1; });
          const mainBT = Object.entries(tc).sort((a, b) => b[1] - a[1])[0]?.[0] || 'PLASTIC-S';
          const s = BOXES_PER_SHELF[binInfo.rackType] || BOXES_PER_SHELF['경량랙'];
          const perShelf = s[mainBT] || s['PLASTIC-S'] || 2;
          totalMax += perShelf * binInfo.rackCount * (binInfo.shelves || 1);
        }
      });
      
      const util = totalMax > 0 ? (totalCur / totalMax) * 100 : 0;
      areaUtils.push({ id: rack.id, util: Math.round(util), curBoxes: totalCur, maxBoxes: totalMax, items: rack.items });
    });
    
    // 전체 공간 사용률
    const totalCur = areaUtils.reduce((s, a) => s + a.curBoxes, 0);
    const totalMax = areaUtils.reduce((s, a) => s + a.maxBoxes, 0);
    const overallUtil = totalMax > 0 ? Math.round((totalCur / totalMax) * 100) : 0;
    
    suggestions.push({
      type: 'utilization_score',
      priority: overallUtil > 85 ? 'danger' : overallUtil > 70 ? 'warning' : overallUtil > 50 ? 'info' : 'success',
      title: '전체 공간 사용률',
      description: `현재 ${totalCur.toFixed(0)}박스 / 최대 ${totalMax.toFixed(0)}박스`,
      score: overallUtil,
      recommendation: overallUtil > 85 
        ? '공간이 거의 포화 상태입니다. 추가 랙 확보를 검토하세요.'
        : overallUtil > 70 
          ? '적정 수준입니다. 효율적인 배치를 유지하세요.'
          : '여유 공간이 충분합니다.'
    });
    
    // 2. 위험 영역 (80% 이상)
    const dangerAreas = areaUtils.filter(a => a.util >= 80).sort((a, b) => b.util - a.util);
    if (dangerAreas.length > 0) {
      suggestions.push({
        type: 'overloaded_bins',
        priority: 'danger',
        title: `공간 부족 영역 ${dangerAreas.length}개`,
        description: '80% 이상 적재된 영역입니다. 재배치 또는 랙 추가가 필요합니다.',
        details: dangerAreas.slice(0, 8).map(a => ({ rack: a.id, bin: '', count: a.util, totalStock: a.items })),
        action: dangerAreas.map(a => `${a.id}(${a.util}%)`).join(', ')
      });
    }
    
    // 3. 여유 영역 (30% 미만)
    const lowAreas = areaUtils.filter(a => a.util < 30 && a.items > 0).sort((a, b) => a.util - b.util);
    if (lowAreas.length > 0) {
      suggestions.push({
        type: 'empty_bins',
        priority: 'success',
        title: `여유 공간 영역 ${lowAreas.length}개`,
        description: '30% 미만 사용 중입니다. 과밀 영역 품목 이동에 활용 가능합니다.',
        details: lowAreas.slice(0, 8).map(a => ({ rack: a.id, bin: `${a.util}%`, count: 0, totalStock: a.items })),
        action: lowAreas.map(a => `${a.id}(${a.util}%)`).join(', ')
      });
    }
    
    // 4. 재배치 추천 (과밀 → 여유)
    if (dangerAreas.length > 0 && lowAreas.length > 0) {
      const recs = [];
      dangerAreas.slice(0, 3).forEach(da => {
        const sameSeries = lowAreas.find(la => {
          return RACK_MODEL_SERIES[la.id] === RACK_MODEL_SERIES[da.id];
        });
        if (sameSeries) {
          recs.push({ from: `${da.id}(${da.util}%)`, to: `${sameSeries.id}(${sameSeries.util}%)`, reason: '같은 시리즈 내 재배치' });
        }
      });
      if (recs.length > 0) {
        suggestions.push({
          type: 'relocation_recommendation',
          priority: 'info',
          title: '재배치 추천',
          description: '같은 시리즈 내에서 과밀 → 여유 영역으로 품목 이동을 권장합니다.',
          details: recs,
          action: '공간 균형이 개선됩니다.'
        });
      }
    }
    
    return suggestions;
  };
  
  // 데이터 유효성 검사
  const validateUploadData = (data, type) => {
    const errors = [];
    const warnings = [];
    
    if (type === 'stock') {
      // 필수 필드 체크
      data.forEach((row, idx) => {
        if (!row.material) {
          errors.push(`행 ${idx + 1}: Material 코드가 없습니다.`);
        }
        if (!row.bin) {
          warnings.push(`행 ${idx + 1}: Bin 정보가 없습니다 (Material: ${row.material})`);
        }
        if (row.stock < 0) {
          errors.push(`행 ${idx + 1}: 재고 수량이 음수입니다 (${row.stock})`);
        }
      });
      
      // 중복 체크
      const duplicates = {};
      data.forEach(row => {
        const key = `${row.material}-${row.bin}`;
        duplicates[key] = (duplicates[key] || 0) + 1;
      });
      
      Object.entries(duplicates).forEach(([key, count]) => {
        if (count > 1) {
          warnings.push(`중복 데이터: ${key} (${count}건)`);
        }
      });
    }
    
    if (type === 'openPO') {
      data.forEach((row, idx) => {
        if (!row.material) {
          errors.push(`행 ${idx + 1}: Material 코드가 없습니다.`);
        }
        if (!row.poNo) {
          warnings.push(`행 ${idx + 1}: PO 번호가 없습니다.`);
        }
        if (row.qty <= 0) {
          warnings.push(`행 ${idx + 1}: 수량이 0 이하입니다.`);
        }
      });
    }
    
    if (type === 'bom') {
      Object.entries(data).forEach(([model, items]) => {
        if (Object.keys(items).length === 0) {
          warnings.push(`${model}: BOM 항목이 없습니다.`);
        }
        
        Object.entries(items).forEach(([material, qty]) => {
          if (qty <= 0) {
            warnings.push(`${model} - ${material}: 수량이 0 이하입니다.`);
          }
        });
      });
    }
    
    return { 
      isValid: errors.length === 0, 
      errors, 
      warnings,
      summary: `${errors.length}개 오류, ${warnings.length}개 경고`
    };
  };

  // 데이터 초기화
  const clearData = () => {
    if (confirm('모든 재고 데이터를 초기화하시겠습니까?')) {
      setInventoryData([]);
      setRackSummary([]);
      setLastUpdated(null);
      safeStorage.removeItem('pbk_inventory');
      safeStorage.removeItem('pbk_last_updated');
      showToast('재고 데이터가 초기화되었습니다.', 'info');
      addNotification('데이터 초기화', '모든 재고 데이터가 초기화되었습니다.', 'warning');
    }
  };

  // 데이터 내보내기 (JSON 파일로 다운로드)
  const exportAllData = () => {
    const exportData = {
      version: '1.2',
      exportDate: new Date().toISOString(),
      inventory: inventoryData,
      weightData: weightData,
      pickCycles: pickCycles,
      receiveCycles: receiveCycles,
      kittingData: kittingData,
      todoList: todoList,
      rackConfig: rackConfig,
      lastUpdated: lastUpdated,
      tempHumidityData: tempHumidityData,
      tempHumidityRecorder: tempHumidityRecorder,
      openPOData: openPOData,
      openPOLastUpdated: openPOLastUpdated,
      customBomData: customBomData,
      bomLastUpdated: bomLastUpdated
    };
    
    const jsonStr = JSON.stringify(exportData, null, 2);
    setBackupData(jsonStr);
  };
  
  const selectAllBackupText = () => {
    const textarea = document.getElementById('backup-textarea');
    if (textarea) {
      textarea.select();
      textarea.setSelectionRange(0, textarea.value.length);
      alert('✅ 텍스트가 선택되었습니다!\nCtrl+C로 복사 후 메모장에 붙여넣기하세요.');
    }
  };

  // 데이터 가져오기 (JSON 파일에서 복원)
  const importAllData = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const importData = JSON.parse(event.target.result);
        
        if (!importData.version) {
          alert('❌ 유효하지 않은 백업 파일입니다.');
          return;
        }
        
        if (confirm(`${importData.exportDate?.slice(0,10) || '알 수 없음'} 백업을 복원하시겠습니까?\n현재 데이터가 덮어씌워집니다.`)) {
          if (importData.inventory) {
            setInventoryData(importData.inventory);
            processRackSummary(importData.inventory);
            safeStorage.setItem('pbk_inventory', JSON.stringify(importData.inventory));
          }
          if (importData.weightData) {
            setWeightData(importData.weightData);
            safeStorage.setItem('pbk_weight_data', JSON.stringify(importData.weightData));
          }
          if (importData.pickCycles) {
            setPickCycles(importData.pickCycles);
            safeStorage.setItem('pbk_pick_cycles', JSON.stringify(importData.pickCycles));
          }
          if (importData.receiveCycles) {
            setReceiveCycles(importData.receiveCycles);
            safeStorage.setItem('pbk_receive_cycles', JSON.stringify(importData.receiveCycles));
          }
          if (importData.rackConfig) {
            setRackConfig(importData.rackConfig);
            safeStorage.setItem('pbk_rack_config', JSON.stringify(importData.rackConfig));
          }
          if (importData.kittingData) {
            setKittingData(importData.kittingData);
            safeStorage.setItem('pbk_kitting_data', JSON.stringify(importData.kittingData));
          }
          if (importData.todoList) {
            setTodoList(importData.todoList);
            safeStorage.setItem('pbk_todo_list', JSON.stringify(importData.todoList));
          }
          if (importData.lastUpdated) {
            setLastUpdated(importData.lastUpdated);
            safeStorage.setItem('pbk_last_updated', importData.lastUpdated);
          }
          // 온습도 데이터 복원
          if (importData.tempHumidityData) {
            setTempHumidityData(importData.tempHumidityData);
            safeStorage.setItem('pbk_temp_humidity_data', JSON.stringify(importData.tempHumidityData));
          }
          if (importData.tempHumidityRecorder) {
            setTempHumidityRecorder(importData.tempHumidityRecorder);
            safeStorage.setItem('pbk_temp_humidity_recorder', importData.tempHumidityRecorder);
          }
          // Open PO 데이터 복원
          if (importData.openPOData) {
            setOpenPOData(importData.openPOData);
            safeStorage.setItem('pbk_open_po_data', JSON.stringify(importData.openPOData));
          }
          if (importData.openPOLastUpdated) {
            setOpenPOLastUpdated(importData.openPOLastUpdated);
            safeStorage.setItem('pbk_open_po_last_updated', importData.openPOLastUpdated);
          }
          // BOM 데이터 복원
          if (importData.customBomData) {
            setCustomBomData(importData.customBomData);
            safeStorage.setItem('pbk_custom_bom_data', JSON.stringify(importData.customBomData));
          }
          if (importData.bomLastUpdated) {
            setBomLastUpdated(importData.bomLastUpdated);
            safeStorage.setItem('pbk_bom_last_updated', importData.bomLastUpdated);
          }
          
          alert('✅ 데이터가 복원되었습니다!');
        }
      } catch (error) {
        alert('❌ 파일을 읽는 중 오류가 발생했습니다.');
        console.error(error);
      }
    };
    reader.readAsText(file);
    e.target.value = ''; // 같은 파일 다시 선택 가능하게
  };

  return (
    <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-slate-50'}`}>
      {/* v15: 토스트 메시지 */}
      <div className="fixed top-4 right-4 z-[100] space-y-2">
        {toasts.map(toast => (
          <div
            key={toast.id}
            className={`px-4 py-3 rounded-lg shadow-lg text-white text-sm animate-pulse ${
              toast.type === 'success' ? 'bg-emerald-500' :
              toast.type === 'error' ? 'bg-red-500' :
              toast.type === 'warning' ? 'bg-amber-500' : 'bg-blue-500'
            }`}
          >
            {toast.message}
          </div>
        ))}
      </div>

      {/* v15: 로딩 오버레이 */}
      {isLoading && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[90]">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-8 flex flex-col items-center gap-4 shadow-xl`}>
            <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            <p className={`${darkMode ? 'text-gray-200' : 'text-gray-600'}`}>{loadingText || '처리 중...'}</p>
          </div>
        </div>
      )}

      {/* Header */}
      <header className={`${darkMode ? 'bg-gradient-to-r from-gray-800 to-gray-900' : 'bg-gradient-to-r from-indigo-700 to-indigo-900'} text-white shadow-lg`}>
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="bg-amber-400 text-gray-900 px-3 py-2 rounded-lg font-bold text-sm">
                <span className="text-lg">⬡</span> <span className="hidden sm:inline">Promega</span>
              </div>
              <div>
                <h1 className="text-lg sm:text-xl font-bold">Warehouse Management <span className="text-indigo-300 text-sm font-normal">{APP_VERSION}</span></h1>
                <p className="text-xs sm:text-sm text-indigo-200 hidden sm:block">
                  {totals.items > 0 ? `${totals.items.toLocaleString()}개 품목 | ${rackSummary.length}개 랙 | ${totals.bins}개 Bin` : 'SAP 엑셀을 업로드해주세요'}
                </p>
              </div>
            </div>
            {/* PC용 버튼들 */}
            <div className="hidden md:flex items-center gap-2">
              {/* v15: 단축키 도움말 */}
              <button
                onClick={() => setShowShortcutHelp(true)}
                className="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition"
                title="단축키 도움말 (Ctrl+?)"
              >
                <Keyboard className="w-4 h-4" />
              </button>
              {/* v15: 알림 센터 */}
              <button
                onClick={() => setShowNotificationCenter(true)}
                className="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition relative"
                title="알림 센터 (Ctrl+N)"
              >
                <Bell className="w-4 h-4" />
                {(() => {
                  const now = new Date();
                  const overdueReceiveCount = receiveCycles.filter(r => {
                    if (r.status === 'completed') return false;
                    if (!r.startTime) return false;
                    return (now - new Date(r.startTime)) / (1000 * 60 * 60) >= 4;
                  }).length;
                  const unreadCount = notifications.filter(n => !n.read).length;
                  const totalAlerts = unreadCount + overdueReceiveCount + (showTempAlert ? 1 : 0) + (showUploadAlert ? 1 : 0) + (showOpenPOAlert ? 1 : 0);
                  return totalAlerts > 0 ? (
                    <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                      {totalAlerts}
                    </span>
                  ) : null;
                })()}
              </button>
              {/* v15: 다크 모드 토글 */}
              <button
                onClick={() => setDarkMode(!darkMode)}
                className="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition"
                title={darkMode ? '라이트 모드' : '다크 모드'}
              >
                {darkMode ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
              </button>
              <a
                href="http://172.30.49.122:8503/"
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition text-sm"
                title="Operations Dashboard 열기"
              >
                <ExternalLink className="w-4 h-4" />
                Ops Dashboard
              </a>
              <button
                onClick={() => setShowBackupModal(true)}
                className="flex items-center gap-2 px-3 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg transition text-sm"
                title="데이터 백업 및 복원"
              >
                <Download className="w-4 h-4" />
                백업/복원
              </button>
              <button
                onClick={() => setShowDataUploadModal(true)}
                className="flex items-center gap-2 px-3 py-2 bg-indigo-500 hover:bg-indigo-600 rounded-lg transition text-sm"
              >
                <Database className="w-4 h-4" />
                데이터 관리
              </button>
              {(lastUpdated || openPOLastUpdated || bomLastUpdated) && (
                <div className="text-left text-xs">
                  <p className="text-indigo-200 mb-1">마지막 업데이트</p>
                  {lastUpdated && (
                    <p title={getElapsedTimeDetail(lastUpdated)}>
                      <span className="text-emerald-300 font-bold">Stock:</span> {lastUpdated.replace(/:\d{2}$/, '').replace(/^20/, '')}
                    </p>
                  )}
                  {openPOLastUpdated && (
                    <p title={getElapsedTimeDetail(openPOLastUpdated)}>
                      <span className="text-amber-300 font-bold">Open PO:</span> {openPOLastUpdated.replace(/:\d{2}$/, '').replace(/^20/, '')}
                    </p>
                  )}
                  {bomLastUpdated && (
                    <p title={getElapsedTimeDetail(bomLastUpdated)}>
                      <span className="text-purple-300 font-bold">BOM:</span> {bomLastUpdated.replace(/:\d{2}$/, '').replace(/^20/, '')}
                    </p>
                  )}
                </div>
              )}
            </div>
            {/* 모바일용 업로드 버튼 */}
            <div className="flex md:hidden items-center gap-2">
              <button
                onClick={() => setDarkMode(!darkMode)}
                className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition"
              >
                {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
              </button>
              <button
                onClick={() => setShowNotificationCenter(true)}
                className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition relative"
              >
                <Bell className="w-5 h-5" />
                {notifications.filter(n => !n.read).length > 0 && (
                  <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                    {notifications.filter(n => !n.read).length}
                  </span>
                )}
              </button>
              <button
                onClick={() => setShowDataUploadModal(true)}
                className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition"
              >
                <Database className="w-5 h-5" />
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* PC용 Nav - 상단 */}
      <nav className={`hidden md:block ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-b'} shadow-sm sticky top-0 z-10`}>
        <div className="max-w-7xl mx-auto px-4">
          <div className="flex gap-1 overflow-x-auto">
            {[
              { id: 'dashboard', label: 'Overview', icon: BarChart3 },
              { id: 'receive', label: '입고 Cycle', icon: Database },
              { id: 'kitting', label: 'Kitting L/T', icon: Package },
              { id: 'pick', label: 'Kitting Cycle', icon: Clock },
              { id: 'kpi', label: 'KPI', icon: TrendingUp },
              { id: 'analysis', label: 'Area Analysis', icon: BarChart3 },
              { id: 'locate', label: '자재 위치', icon: Search },
              { id: 'layout', label: '랙 배치도', icon: Warehouse },
              { id: 'view3d', label: '3D 뷰', icon: Box },
              { id: 'temphumidity', label: '온습도 관리', icon: Thermometer },
              { id: 'todo', label: 'TO DO', icon: Check },
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-1.5 px-2.5 py-2.5 text-xs font-medium border-b-2 transition whitespace-nowrap ${
                  activeTab === tab.id 
                    ? 'border-indigo-600 text-indigo-600 bg-indigo-50' 
                    : darkMode 
                      ? 'border-transparent text-gray-300 hover:text-white' 
                      : 'border-transparent text-gray-600 hover:text-gray-900'
                }`}
              >
                <tab.icon className="w-3.5 h-3.5" />
                {tab.label}
                {tab.id === 'todo' && dueSoonTodos.length > 0 && (
                  <span className="ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">{dueSoonTodos.length}</span>
                )}
                {tab.id === 'receive' && (() => {
                  const now = new Date();
                  const overdueCount = receiveCycles.filter(r => {
                    if (r.status === 'completed') return false;
                    if (!r.startTime) return false;
                    return (now - new Date(r.startTime)) / (1000 * 60 * 60) >= 4;
                  }).length;
                  return overdueCount > 0 ? (
                    <span className="ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">{overdueCount}</span>
                  ) : null;
                })()}
                {tab.id === 'rack' && fullBins.length > 0 && (
                  <span className="ml-1 px-1.5 py-0.5 bg-pink-500 text-white text-xs rounded-full">{fullBins.length}</span>
                )}
              </button>
            ))}
          </div>
        </div>
      </nav>

      {/* 모바일용 하단 네비게이션 */}
      <nav className={`md:hidden fixed bottom-0 left-0 right-0 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-t'} shadow-lg z-50`}>
        <div className="flex justify-around items-center py-2">
          {[
            { id: 'dashboard', label: 'Overview', icon: BarChart3 },
            { id: 'receive', label: '입고', icon: Database },
            { id: 'kitting', label: 'Kitting', icon: Package },
            { id: 'pick', label: 'Cycle', icon: Clock },
            { id: 'more', label: '더보기', icon: List },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => {
                if (tab.id === 'more') {
                  setShowMobileMenu(true);
                } else {
                  setActiveTab(tab.id);
                }
              }}
              className={`flex flex-col items-center gap-1 px-3 py-1 rounded-lg transition ${
                activeTab === tab.id ? 'text-indigo-600' : 'text-gray-500'
              }`}
            >
              <tab.icon className="w-5 h-5" />
              <span className="text-xs">{tab.label}</span>
              {tab.id === 'receive' && receiveCycles.filter(r => r.status === 'in-progress').length > 0 && (
                <span className="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span>
              )}
            </button>
          ))}
        </div>
      </nav>

      {/* 모바일 더보기 메뉴 모달 */}
      {showMobileMenu && (
        <div className="md:hidden fixed inset-0 bg-black/50 z-50 flex items-end" onClick={() => setShowMobileMenu(false)}>
          <div className="bg-white w-full rounded-t-2xl p-4 pb-8" onClick={e => e.stopPropagation()}>
            <div className="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h3 className="font-semibold text-lg mb-4">메뉴</h3>
            <div className="grid grid-cols-4 gap-4">
              {[
                { id: 'dashboard', label: 'Overview', icon: BarChart3 },
                { id: 'receive', label: '입고', icon: Database },
                { id: 'kitting', label: 'Kitting', icon: Package },
                { id: 'pick', label: 'Cycle', icon: Clock },
                { id: 'kpi', label: 'KPI', icon: TrendingUp },
                { id: 'analysis', label: 'Analysis', icon: BarChart3 },
                { id: 'todo', label: 'TO DO', icon: Check },
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => { setActiveTab(tab.id); setShowMobileMenu(false); }}
                  className={`flex flex-col items-center gap-2 p-3 rounded-xl transition ${
                    activeTab === tab.id ? 'bg-indigo-100 text-indigo-600' : 'bg-gray-50 text-gray-600'
                  }`}
                >
                  <tab.icon className="w-6 h-6" />
                  <span className="text-xs">{tab.label}</span>
                </button>
              ))}
            </div>
            <div className="mt-6 pt-4 border-t grid grid-cols-2 gap-3">
              <button
                onClick={() => { setShowBackupModal(true); setShowMobileMenu(false); }}
                className="flex items-center justify-center gap-2 p-3 bg-orange-100 text-orange-600 rounded-xl"
              >
                <Download className="w-5 h-5" /> 백업/복원
              </button>
              <button
                onClick={() => { setShowDataUploadModal(true); setShowMobileMenu(false); }}
                className="flex items-center justify-center gap-2 p-3 bg-indigo-100 text-indigo-600 rounded-xl"
              >
                <Database className="w-5 h-5" /> 데이터 관리
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Main */}
      <main className="max-w-7xl mx-auto px-4 py-6 pb-24 md:pb-6">
        
        {/* No Data Message */}
        {inventoryData.length === 0 && activeTab !== 'pick' && activeTab !== 'receive' && activeTab !== 'todo' && activeTab !== 'kitting' && (
          <div className="bg-white rounded-xl shadow-sm p-12 text-center">
            <FileSpreadsheet className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-700 mb-2">재고 데이터가 없습니다</h3>
            <p className="text-gray-500 mb-6">SAP에서 추출한 재고 리스트 엑셀을 업로드해주세요.</p>
            <button
              onClick={() => setShowUploadModal(true)}
              className="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
            >
              <Upload className="w-5 h-5" />
              엑셀 업로드
            </button>
          </div>
        )}

        {/* Dashboard */}
        {activeTab === 'dashboard' && inventoryData.length === 0 && (
          <div className="space-y-4">
            {/* ZBIN/ME2N 미업로드 알림 */}
            <div className="bg-amber-50 border border-amber-300 rounded-xl p-5 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <span className="text-2xl">📊</span>
                <div>
                  <p className="font-bold text-amber-800">오늘 재고 데이터 미업로드!</p>
                  <p className="text-sm text-amber-600">ZBIN(Stock) 데이터를 업로드해주세요.</p>
                </div>
              </div>
              <button onClick={() => setShowDataUploadModal(true)} className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm font-medium">
                업로드하기
              </button>
            </div>
            {/* Open PO 미업로드 알림 */}
            {showOpenPOAlert && (
              <div className="bg-orange-50 border border-orange-300 rounded-xl p-5 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">📋</span>
                  <div>
                    <p className="font-bold text-orange-800">Open PO 데이터 미업로드!</p>
                    <p className="text-sm text-orange-600">ME2N(Open PO) 데이터를 업로드해주세요.</p>
                  </div>
                </div>
                <button onClick={() => setShowOpenPOModal(true)} className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm font-medium">
                  업로드하기
                </button>
              </div>
            )}
            {/* 온습도 미입력 알림 */}
            {showTempAlert && (
              <div className="bg-red-50 border border-red-300 rounded-xl p-5 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">🌡️</span>
                  <div>
                    <p className="font-bold text-red-800">온습도 미입력!</p>
                    <p className="text-sm text-red-600">오늘의 온도/습도가 아직 입력되지 않았습니다.</p>
                  </div>
                </div>
                <button onClick={() => setActiveTab('temphumidity')} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">
                  입력하러 가기
                </button>
              </div>
            )}
          </div>
        )}
        {activeTab === 'dashboard' && inventoryData.length > 0 && (
          <div className="space-y-6">
            {/* 온습도 미입력 알림 배너 */}
            {showTempAlert && (
              <div className="bg-red-50 border border-red-300 rounded-xl p-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">🌡️</span>
                  <div>
                    <p className="font-bold text-red-800">온습도 미입력!</p>
                    <p className="text-sm text-red-600">오늘의 온도/습도가 아직 입력되지 않았습니다. 온습도 관리 탭에서 입력해주세요.</p>
                  </div>
                </div>
                <button onClick={() => setActiveTab('temphumidity')} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">
                  입력하러 가기
                </button>
              </div>
            )}
            {/* 재고 데이터 미업로드 알림 */}
            {showUploadAlert && (
              <div className="bg-amber-50 border border-amber-300 rounded-xl p-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">📊</span>
                  <div>
                    <p className="font-bold text-amber-800">오늘 재고 데이터 미업로드!</p>
                    <p className="text-sm text-amber-600">ZBIN(Stock) 데이터를 업로드해주세요.</p>
                  </div>
                </div>
                <button onClick={() => setShowDataUploadModal(true)} className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm font-medium">
                  업로드하기
                </button>
              </div>
            )}
            {/* Open PO 미업로드 알림 */}
            {showOpenPOAlert && (
              <div className="bg-orange-50 border border-orange-300 rounded-xl p-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">📋</span>
                  <div>
                    <p className="font-bold text-orange-800">Open PO 데이터 미업로드!</p>
                    <p className="text-sm text-orange-600">ME2N(Open PO) 데이터를 업로드해주세요.</p>
                  </div>
                </div>
                <button onClick={() => setShowOpenPOModal(true)} className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm font-medium">
                  업로드하기
                </button>
              </div>
            )}
            
            {/* C3 개선: 업데이트 필요 알림 배너 */}
            {(() => {
              if (!lastUpdated) return null;
              const lastUpdateDate = new Date(lastUpdated.replace(/\. /g, '-').replace('.', ''));
              const hoursSinceUpdate = (new Date() - lastUpdateDate) / (1000 * 60 * 60);
              const needsUpdate = hoursSinceUpdate > 24;
              
              if (needsUpdate) {
                return (
                  <div className="bg-amber-50 border border-amber-300 rounded-xl p-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <AlertTriangle className="w-5 h-5 text-amber-600" />
                      <div>
                        <p className="font-medium text-amber-800">재고 데이터 갱신 필요</p>
                        <p className="text-sm text-amber-600">마지막 업데이트: {lastUpdated} ({Math.floor(hoursSinceUpdate)}시간 전)</p>
                      </div>
                    </div>
                    <button 
                      onClick={() => setShowUploadModal(true)}
                      className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 flex items-center gap-2"
                    >
                      <Upload className="w-4 h-4" /> SAP Stock 업로드
                    </button>
                  </div>
                );
              }
              return null;
            })()}

            {/* 입고 미처리 알림 - 1일 이상 경과 */}
            {(() => {
              const now = new Date();
              const overdueReceives = receiveCycles.filter(r => {
                if (r.status === 'completed') return false;
                if (!r.startTime) return false;
                const startTime = new Date(r.startTime);
                const hoursPassed = (now - startTime) / (1000 * 60 * 60);
                return hoursPassed >= 4; // 4시간 이상 경과
              });
              
              if (overdueReceives.length > 0) {
                return (
                  <div className="bg-red-50 border border-red-300 rounded-xl p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <AlertTriangle className="w-5 h-5 text-red-600" />
                        <div>
                          <p className="font-medium text-red-800">⚠️ 입고 미처리 {overdueReceives.length}건</p>
                          <p className="text-sm text-red-600">
                            4시간 이상 MIGO 미완료: {overdueReceives.map(r => `${r.vendor}(No.${r.poNo})`).join(', ')}
                          </p>
                        </div>
                      </div>
                      <button 
                        onClick={() => setActiveTab('receive')}
                        className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2"
                      >
                        입고 Cycle 이동
                      </button>
                    </div>
                  </div>
                );
              }
              return null;
            })()}

            {/* KPI - 전월 대비 증감 표시 */}
            <div className="grid grid-cols-3 gap-4">
              {(() => {
                // 이번 달과 지난 달 데이터 분리
                const now = new Date();
                const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonth = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, '0')}`;
                
                // 불출시간 - 이번 달 vs 지난 달
                const thisMonthPicks = pickCycles.filter(p => p.status === 'completed' && p.cycleMin && p.completed?.startsWith(thisMonth));
                const lastMonthPicks = pickCycles.filter(p => p.status === 'completed' && p.cycleMin && p.completed?.startsWith(lastMonth));
                const thisMonthPickAvg = thisMonthPicks.length > 0 ? thisMonthPicks.reduce((s, p) => s + p.cycleMin, 0) / thisMonthPicks.length : 0;
                const lastMonthPickAvg = lastMonthPicks.length > 0 ? lastMonthPicks.reduce((s, p) => s + p.cycleMin, 0) / lastMonthPicks.length : 0;
                const pickDiff = lastMonthPickAvg > 0 ? thisMonthPickAvg - lastMonthPickAvg : 0;
                
                // 입고시간 - 이번 달 vs 지난 달
                const thisMonthReceives = receiveCycles.filter(r => r.status === 'completed' && r.cycleMin && r.migo?.startsWith(thisMonth));
                const lastMonthReceives = receiveCycles.filter(r => r.status === 'completed' && r.cycleMin && r.migo?.startsWith(lastMonth));
                const thisMonthReceiveAvg = thisMonthReceives.length > 0 ? thisMonthReceives.reduce((s, r) => s + r.cycleMin, 0) / thisMonthReceives.length : 0;
                const lastMonthReceiveAvg = lastMonthReceives.length > 0 ? lastMonthReceives.reduce((s, r) => s + r.cycleMin, 0) / lastMonthReceives.length : 0;
                const receiveDiff = lastMonthReceiveAvg > 0 ? thisMonthReceiveAvg - lastMonthReceiveAvg : 0;
                
                // 리드타임 - 이번 달 vs 지난 달
                const thisMonthKittings = kittingData.filter(k => k.status === 'completed' && k.leadTimeDays && k.completedAt?.startsWith(thisMonth));
                const lastMonthKittings = kittingData.filter(k => k.status === 'completed' && k.leadTimeDays && k.completedAt?.startsWith(lastMonth));
                const thisMonthLeadAvg = thisMonthKittings.length > 0 ? thisMonthKittings.reduce((s, k) => s + k.leadTimeDays, 0) / thisMonthKittings.length : 0;
                const lastMonthLeadAvg = lastMonthKittings.length > 0 ? lastMonthKittings.reduce((s, k) => s + k.leadTimeDays, 0) / lastMonthKittings.length : 0;
                const leadDiff = lastMonthLeadAvg > 0 ? thisMonthLeadAvg - lastMonthLeadAvg : 0;
                
                return (
                  <>
                    <div 
                      className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-rose-500 cursor-pointer hover:bg-rose-50 transition"
                      onClick={() => setShowReceiveDetailModal(true)}
                    >
                      <p className="text-sm text-gray-500">평균 입고시간 <span className="text-xs text-rose-500">▶ 클릭</span></p>
                      <div className="flex items-end gap-2">
                        <p className="text-2xl font-bold">{avgReceiveTime.toFixed(0)}분</p>
                        <span className={`text-sm font-medium ${receiveDiff > 0 ? 'text-red-500' : receiveDiff < 0 ? 'text-green-500' : 'text-gray-400'}`}>
                          {receiveDiff !== 0 ? (receiveDiff > 0 ? '↑' : '↓') + Math.abs(receiveDiff).toFixed(0) + '분' : '-'} <span className="text-xs text-gray-400">전월대비</span>
                        </span>
                      </div>
                      <p className="text-xs text-gray-400 mt-1">완료 {receiveCycles.filter(r => r.status === 'completed').length}건 기준</p>
                    </div>
                    <div 
                      className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-cyan-500 cursor-pointer hover:bg-cyan-50 transition"
                      onClick={() => setShowLeadTimeDetailModal(true)}
                    >
                      <p className="text-sm text-gray-500">평균 Kitting 리드타임 <span className="text-xs text-cyan-500">▶ 클릭</span></p>
                      <div className="flex items-end gap-2">
                        <p className="text-2xl font-bold">{avgLeadTime.toFixed(1)}일</p>
                        <span className={`text-sm font-medium ${leadDiff > 0 ? 'text-red-500' : leadDiff < 0 ? 'text-green-500' : 'text-gray-400'}`}>
                          {leadDiff !== 0 ? (leadDiff > 0 ? '↑' : '↓') + Math.abs(leadDiff).toFixed(1) + '일' : '-'} <span className="text-xs text-gray-400">전월대비</span>
                        </span>
                      </div>
                      <p className="text-xs text-gray-400 mt-1">Kitting 완료 {kittingData.filter(k => k.status === 'completed').length}건 기준</p>
                    </div>
                    <div 
                      className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-purple-500 cursor-pointer hover:bg-purple-50 transition"
                      onClick={() => setShowPickDetailModal(true)}
                    >
                      <p className="text-sm text-gray-500">평균 Kitting 시간 <span className="text-xs text-purple-500">▶ 클릭</span></p>
                      <div className="flex items-end gap-2">
                        <p className="text-2xl font-bold">{avgPickTime.toFixed(0)}분</p>
                        <span className={`text-sm font-medium ${pickDiff > 0 ? 'text-red-500' : pickDiff < 0 ? 'text-green-500' : 'text-gray-400'}`}>
                          {pickDiff !== 0 ? (pickDiff > 0 ? '↑' : '↓') + Math.abs(pickDiff).toFixed(0) + '분' : '-'} <span className="text-xs text-gray-400">전월대비</span>
                        </span>
                      </div>
                      <p className="text-xs text-gray-400 mt-1">완료 {pickCycles.filter(p => p.status === 'completed').length}건 기준</p>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* 주간 리포트 다운로드 */}
            <div className="flex justify-end">
              <button
                onClick={downloadWeeklyReport}
                className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg hover:from-indigo-600 hover:to-purple-600 shadow-sm transition"
              >
                <Download className="w-4 h-4" />
                📊 주간 리포트 다운로드
              </button>
            </div>

            {/* 🏭 생산 가능 대수 */}
            <div className="bg-white rounded-xl shadow-sm p-6">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                <h3 className="font-semibold flex items-center gap-2">
                  <Package className="w-5 h-5 text-indigo-600" />
                  🏭 모델별 생산 가능 대수
                </h3>
                <div className="flex items-center gap-2 mt-1 sm:mt-0">
                  {lastUpdated && (
                    <span className={`text-xs px-2 py-1 rounded ${
                      (() => {
                        const lastUpdateDate = new Date(lastUpdated.replace(/\. /g, '-').replace('.', ''));
                        const hoursSinceUpdate = (new Date() - lastUpdateDate) / (1000 * 60 * 60);
                        return hoursSinceUpdate > 24 ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700';
                      })()
                    }`}>
                      📅 {lastUpdated}
                    </span>
                  )}
                </div>
              </div>
              
              {/* 요약 카드 */}
              {(() => {
                const TARGET_STOCK = {
                  'RSC16': { min: 10, max: 30 },
                  'CSC16': { min: 5, max: 10 },
                  'FSC16': { min: 2, max: 2 },
                  'RSC48': { min: 10, max: 20 },
                  'CSC48': { min: 3, max: 10 },
                  'HSM3': { min: 1, max: 5 }
                };
                
                const modelStatus = Object.entries(TARGET_STOCK).map(([model, range]) => {
                  const info = MODEL_WEIGHTS[model];
                  const currentStock = inventoryData.filter(i => i.material === info?.code).reduce((sum, i) => sum + (i.stock || 0), 0);
                  let status = 'ok';
                  if (currentStock > range.max) status = 'over';
                  else if (currentStock >= range.min) status = 'ok';
                  else if (currentStock >= range.min * 0.5) status = 'warning';
                  else status = 'shortage';
                  return { model, currentStock, status };
                });
                
                const overStock = modelStatus.filter(m => m.status === 'over');
                const okStock = modelStatus.filter(m => m.status === 'ok');
                const warningStock = modelStatus.filter(m => m.status === 'warning');
                const shortageStock = modelStatus.filter(m => m.status === 'shortage');
                
                return (
                  <div className="grid grid-cols-4 gap-3 mb-4">
                    <div 
                      className="bg-purple-50 border border-purple-200 rounded-lg p-3 cursor-pointer hover:bg-purple-100 transition"
                      onClick={() => setShowModelDetailModal('excess')}
                    >
                      <p className="text-xs text-purple-600 font-medium">📦 과다 재고</p>
                      <p className="text-2xl font-bold text-purple-700">{overStock.length}<span className="text-xs font-normal ml-1">모델</span></p>
                    </div>
                    <div 
                      className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 cursor-pointer hover:bg-emerald-100 transition"
                      onClick={() => setShowModelDetailModal('normal')}
                    >
                      <p className="text-xs text-emerald-600 font-medium">✅ 적정 재고</p>
                      <p className="text-2xl font-bold text-emerald-700">{okStock.length}<span className="text-xs font-normal ml-1">모델</span></p>
                    </div>
                    <div 
                      className="bg-amber-50 border border-amber-200 rounded-lg p-3 cursor-pointer hover:bg-amber-100 transition"
                      onClick={() => setShowModelDetailModal('caution')}
                    >
                      <p className="text-xs text-amber-600 font-medium">⚠️ 부족 주의</p>
                      <p className="text-2xl font-bold text-amber-700">{warningStock.length}<span className="text-xs font-normal ml-1">모델</span></p>
                    </div>
                    <div 
                      className="bg-red-50 border border-red-200 rounded-lg p-3 cursor-pointer hover:bg-red-100 transition"
                      onClick={() => setShowModelDetailModal('urgent')}
                    >
                      <p className="text-xs text-red-600 font-medium">🚨 부족 긴급</p>
                      <p className="text-2xl font-bold text-red-700">{shortageStock.length}<span className="text-xs font-normal ml-1">모델</span></p>
                    </div>
                  </div>
                );
              })()}
              
              {/* 색상 범례 */}
              <div className="flex flex-wrap gap-4 mb-4 text-xs">
                <span className="flex items-center gap-1">
                  <span className="w-3 h-3 rounded-full bg-purple-400"></span> 과다 (최대 초과)
                </span>
                <span className="flex items-center gap-1">
                  <span className="w-3 h-3 rounded-full bg-emerald-400"></span> 적정 (최소~최대)
                </span>
                <span className="flex items-center gap-1">
                  <span className="w-3 h-3 rounded-full bg-amber-400"></span> 주의 (최소의 50% 이상)
                </span>
                <span className="flex items-center gap-1">
                  <span className="w-3 h-3 rounded-full bg-red-400"></span> 긴급 (최소의 50% 미만)
                </span>
              </div>

              {/* 모델 목록 - 카드 박스 형식 */}
              <div className="space-y-6">
                {/* Maxwell 16 시리즈 */}
                <div>
                  <h4 className="text-sm font-semibold text-purple-700 mb-3 flex items-center gap-2">
                    <span className="px-2 py-0.5 bg-purple-100 rounded text-xs">16</span> Maxwell 16 시리즈
                  </h4>
                  <div className="grid grid-cols-3 gap-4">
                    {Object.entries(MODEL_WEIGHTS).filter(([_, info]) => info.series === '16').map(([model, info]) => {
                      const prodInfo = producibleUnits[model] || { units: 0, coverage: '0' };
                      const TARGET = { RSC16: { min: 10, max: 30 }, CSC16: { min: 5, max: 10 }, FSC16: { min: 2, max: 2 } };
                      const range = TARGET[model] || { min: 10, max: 30 };
                      const currentStock = inventoryData.filter(i => i.material === info.code).reduce((sum, i) => sum + (i.stock || 0), 0);
                      const status = currentStock > range.max ? 'over' : currentStock >= range.min ? 'ok' : currentStock >= range.min * 0.5 ? 'warning' : 'shortage';
                      const bgColor = status === 'over' ? 'bg-purple-50 border-purple-300' :
                                      status === 'ok' ? 'bg-emerald-50 border-emerald-300' :
                                      status === 'warning' ? 'bg-amber-50 border-amber-300' :
                                      'bg-red-50 border-red-300';
                      const textColor = status === 'over' ? 'text-purple-700' :
                                       status === 'ok' ? 'text-emerald-700' :
                                       status === 'warning' ? 'text-amber-700' :
                                       'text-red-700';
                      const statusLabel = status === 'over' ? '과다' : status === 'ok' ? '적정' : status === 'warning' ? '주의' : '긴급';
                      const statusIcon = status === 'over' ? '📦' : status === 'ok' ? '✅' : status === 'warning' ? '⚠️' : '🚨';
                      
                      return (
                        <div key={model} className={`rounded-xl p-4 border-2 ${bgColor}`}>
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <p className="font-bold text-gray-800">{model}</p>
                              <p className="text-xs text-gray-500">{info.code}</p>
                            </div>
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              status === 'over' ? 'bg-purple-200 text-purple-800' :
                              status === 'ok' ? 'bg-emerald-200 text-emerald-800' :
                              status === 'warning' ? 'bg-amber-200 text-amber-800' :
                              'bg-red-200 text-red-800'
                            }`}>
                              {statusIcon} {statusLabel}
                            </span>
                          </div>
                          <div className="flex items-end gap-2">
                            <p className={`text-3xl font-bold ${textColor}`}>{prodInfo.units}<span className="text-lg">대</span></p>
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Safety Stock: {range.min}~{range.max}대</p>
                          <p className="text-xs text-blue-600 mt-0.5">
                            현재 재고: {currentStock.toLocaleString()} EA
                          </p>
                          <div className="mt-2">
                            <div className="w-full bg-gray-200 rounded-full h-2 relative">
                              <div className="absolute h-full w-0.5 bg-gray-400" style={{ left: `${(range.min / range.max) * 100}%` }} />
                              <div 
                                className={`h-2 rounded-full ${
                                  status === 'over' ? 'bg-purple-500' :
                                  status === 'ok' ? 'bg-emerald-500' :
                                  status === 'warning' ? 'bg-amber-500' :
                                  'bg-red-500'
                                }`}
                                style={{ width: `${Math.min((currentStock / range.max) * 100, 100)}%` }}
                              />
                            </div>
                          </div>
                          {prodInfo.bottleneck && (
                            <div className="mt-2 text-xs">
                              <p className="text-gray-600 truncate">
                                병목: {prodInfo.bottleneck.material} | {prodInfo.bottleneck.description?.slice(0, 15) || '-'} | 재고: {prodInfo.bottleneck.currentStock} EA
                                {(() => {
                                  const openPO = getOpenPOForMaterial(prodInfo.bottleneck.material);
                                  return openPO ? (
                                    <span className="text-green-600 font-medium ml-1">| 📦 {openPO.totalQty.toLocaleString()} {openPO.unit}</span>
                                  ) : (
                                    <span className="text-red-500 ml-1">| ⚠️ Open PO 없음</span>
                                  );
                                })()}
                              </p>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Maxwell 48 시리즈 */}
                <div>
                  <h4 className="text-sm font-semibold text-blue-700 mb-3 flex items-center gap-2">
                    <span className="px-2 py-0.5 bg-blue-100 rounded text-xs">48</span> Maxwell 48 시리즈
                  </h4>
                  <div className="grid grid-cols-3 gap-4">
                    {Object.entries(MODEL_WEIGHTS).filter(([_, info]) => info.series === '48').map(([model, info]) => {
                      const prodInfo = producibleUnits[model] || { units: 0, coverage: '0' };
                      const TARGET = { RSC48: { min: 10, max: 20 }, CSC48: { min: 3, max: 10 } };
                      const range = TARGET[model] || { min: 10, max: 20 };
                      const currentStock = inventoryData.filter(i => i.material === info.code).reduce((sum, i) => sum + (i.stock || 0), 0);
                      const status = currentStock > range.max ? 'over' : currentStock >= range.min ? 'ok' : currentStock >= range.min * 0.5 ? 'warning' : 'shortage';
                      const bgColor = status === 'over' ? 'bg-purple-50 border-purple-300' :
                                      status === 'ok' ? 'bg-emerald-50 border-emerald-300' :
                                      status === 'warning' ? 'bg-amber-50 border-amber-300' :
                                      'bg-red-50 border-red-300';
                      const textColor = status === 'over' ? 'text-purple-700' :
                                       status === 'ok' ? 'text-emerald-700' :
                                       status === 'warning' ? 'text-amber-700' :
                                       'text-red-700';
                      const statusLabel = status === 'over' ? '과다' : status === 'ok' ? '적정' : status === 'warning' ? '주의' : '긴급';
                      const statusIcon = status === 'over' ? '📦' : status === 'ok' ? '✅' : status === 'warning' ? '⚠️' : '🚨';
                      
                      return (
                        <div key={model} className={`rounded-xl p-4 border-2 ${bgColor}`}>
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <p className="font-bold text-gray-800">{model}</p>
                              <p className="text-xs text-gray-500">{info.code}</p>
                            </div>
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              status === 'over' ? 'bg-purple-200 text-purple-800' :
                              status === 'ok' ? 'bg-emerald-200 text-emerald-800' :
                              status === 'warning' ? 'bg-amber-200 text-amber-800' :
                              'bg-red-200 text-red-800'
                            }`}>
                              {statusIcon} {statusLabel}
                            </span>
                          </div>
                          <div className="flex items-end gap-2">
                            <p className={`text-3xl font-bold ${textColor}`}>{prodInfo.units}<span className="text-lg">대</span></p>
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Safety Stock: {range.min}~{range.max}대</p>
                          <p className="text-xs text-blue-600 mt-0.5">
                            현재 재고: {currentStock.toLocaleString()} EA
                          </p>
                          <div className="mt-2">
                            <div className="w-full bg-gray-200 rounded-full h-2 relative">
                              <div className="absolute h-full w-0.5 bg-gray-400" style={{ left: `${(range.min / range.max) * 100}%` }} />
                              <div 
                                className={`h-2 rounded-full ${
                                  status === 'over' ? 'bg-purple-500' :
                                  status === 'ok' ? 'bg-emerald-500' :
                                  status === 'warning' ? 'bg-amber-500' :
                                  'bg-red-500'
                                }`}
                                style={{ width: `${Math.min((currentStock / range.max) * 100, 100)}%` }}
                              />
                            </div>
                          </div>
                          {prodInfo.bottleneck && (
                            <div className="mt-2 text-xs">
                              <p className="text-gray-600 truncate">
                                병목: {prodInfo.bottleneck.material} | {prodInfo.bottleneck.description?.slice(0, 15) || '-'} | 재고: {prodInfo.bottleneck.currentStock} EA
                                {(() => {
                                  const openPO = getOpenPOForMaterial(prodInfo.bottleneck.material);
                                  return openPO ? (
                                    <span className="text-green-600 font-medium ml-1">| 📦 {openPO.totalQty.toLocaleString()} {openPO.unit}</span>
                                  ) : (
                                    <span className="text-red-500 ml-1">| ⚠️ Open PO 없음</span>
                                  );
                                })()}
                              </p>
                            </div>
                          )}
                        </div>
                      );
                    })}
                    {/* 빈 카드로 정렬 맞추기 */}
                    <div className="rounded-xl p-4 border-2 border-dashed border-gray-200 bg-gray-50 flex items-center justify-center">
                      <span className="text-gray-400 text-sm">-</span>
                    </div>
                  </div>
                </div>

                {/* HSM 시리즈 */}
                <div>
                  <h4 className="text-sm font-semibold text-orange-600 mb-3 flex items-center gap-2">
                    <span className="px-2 py-0.5 bg-orange-100 rounded text-xs">HSM</span> HSM 시리즈
                  </h4>
                  <div className="grid grid-cols-3 gap-4">
                    {Object.entries(MODEL_WEIGHTS).filter(([_, info]) => info.series === 'HSM').map(([model, info]) => {
                      const prodInfo = producibleUnits[model] || { units: 0, coverage: '0' };
                      const range = { min: 1, max: 5 };
                      const currentStock = inventoryData.filter(i => i.material === info.code).reduce((sum, i) => sum + (i.stock || 0), 0);
                      const status = currentStock > range.max ? 'over' : currentStock >= range.min ? 'ok' : currentStock >= range.min * 0.5 ? 'warning' : 'shortage';
                      const bgColor = status === 'over' ? 'bg-purple-50 border-purple-300' :
                                      status === 'ok' ? 'bg-emerald-50 border-emerald-300' :
                                      status === 'warning' ? 'bg-amber-50 border-amber-300' :
                                      'bg-red-50 border-red-300';
                      const textColor = status === 'over' ? 'text-purple-700' :
                                       status === 'ok' ? 'text-emerald-700' :
                                       status === 'warning' ? 'text-amber-700' :
                                       'text-red-700';
                      const statusLabel = status === 'over' ? '과다' : status === 'ok' ? '적정' : status === 'warning' ? '주의' : '긴급';
                      const statusIcon = status === 'over' ? '📦' : status === 'ok' ? '✅' : status === 'warning' ? '⚠️' : '🚨';
                      
                      return (
                        <div key={model} className={`rounded-xl p-4 border-2 ${bgColor}`}>
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <p className="font-bold text-gray-800">{model}</p>
                              <p className="text-xs text-gray-500">{info.code}</p>
                            </div>
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              status === 'over' ? 'bg-purple-200 text-purple-800' :
                              status === 'ok' ? 'bg-emerald-200 text-emerald-800' :
                              status === 'warning' ? 'bg-amber-200 text-amber-800' :
                              'bg-red-200 text-red-800'
                            }`}>
                              {statusIcon} {statusLabel}
                            </span>
                          </div>
                          <div className="flex items-end gap-2">
                            <p className={`text-3xl font-bold ${textColor}`}>{prodInfo.units}<span className="text-lg">대</span></p>
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Safety Stock: {range.min}~{range.max}대</p>
                          <p className="text-xs text-blue-600 mt-0.5">
                            현재 재고: {currentStock.toLocaleString()} EA
                          </p>
                          <div className="mt-2">
                            <div className="w-full bg-gray-200 rounded-full h-2 relative">
                              <div className="absolute h-full w-0.5 bg-gray-400" style={{ left: `${(range.min / range.max) * 100}%` }} />
                              <div 
                                className={`h-2 rounded-full ${
                                  status === 'over' ? 'bg-purple-500' :
                                  status === 'ok' ? 'bg-emerald-500' :
                                  status === 'warning' ? 'bg-amber-500' :
                                  'bg-red-500'
                                }`}
                                style={{ width: `${Math.min((currentStock / range.max) * 100, 100)}%` }}
                              />
                            </div>
                          </div>
                          {prodInfo.bottleneck && (
                            <div className="mt-2 text-xs">
                              <p className="text-gray-600 truncate">
                                병목: {prodInfo.bottleneck.material} | {prodInfo.bottleneck.description?.slice(0, 15) || '-'} | 재고: {prodInfo.bottleneck.currentStock} EA
                                {(() => {
                                  const openPO = getOpenPOForMaterial(prodInfo.bottleneck.material);
                                  return openPO ? (
                                    <span className="text-green-600 font-medium ml-1">| 📦 {openPO.totalQty.toLocaleString()} {openPO.unit}</span>
                                  ) : (
                                    <span className="text-red-500 ml-1">| ⚠️ Open PO 없음</span>
                                  );
                                })()}
                              </p>
                            </div>
                          )}
                        </div>
                      );
                    })}
                    {/* 빈 카드로 정렬 맞추기 */}
                    <div className="rounded-xl p-4 border-2 border-dashed border-gray-200 bg-gray-50 flex items-center justify-center">
                      <span className="text-gray-400 text-sm">-</span>
                    </div>
                    <div className="rounded-xl p-4 border-2 border-dashed border-gray-200 bg-gray-50 flex items-center justify-center">
                      <span className="text-gray-400 text-sm">-</span>
                    </div>
                  </div>
                </div>
              </div>

              <p className="text-xs text-gray-400 mt-4">
                💡 병목 자재 = 가장 먼저 소진되는 자재. 해당 자재 재고 부족 시 생산 불가.
              </p>
            </div>

            {/* 🔧 Sub-component 생산 가능 대수 */}
            {subComponentBomData && Object.keys(subComponentBomData).length > 0 && (
              <div className="bg-white rounded-xl shadow-sm p-6">
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                  <h3 className="font-semibold flex items-center gap-2">
                    <Package className="w-5 h-5 text-teal-600" />
                    🔧 Sub-component 생산 가능 대수
                  </h3>
                  <span className="text-xs text-gray-500 mt-1 sm:mt-0">
                    {Object.keys(subComponentBomData).length}개 Sub-com
                  </span>
                </div>
                
                {/* 요약 카드 */}
                {(() => {
                  const SUBCOM_SAFETY = { min: 10, max: 50 }; // Sub-component Safety Stock 기준
                  const SUBCOM_SAFETY_KB0770 = { min: 20, max: 100 }; // KB0770은 1대당 2EA 사용
                  const subComStatus = Object.entries(subComponentUnits).map(([name, info]) => {
                    const currentStock = inventoryData.filter(i => i.material === name).reduce((sum, i) => sum + (i.stock || 0), 0);
                    const range = name === 'KB0770' ? SUBCOM_SAFETY_KB0770 : SUBCOM_SAFETY;
                    let status = 'ok';
                    if (currentStock > range.max) status = 'over';
                    else if (currentStock >= range.min) status = 'ok';
                    else if (currentStock >= range.min * 0.5) status = 'warning';
                    else status = 'shortage';
                    return { name, currentStock, status };
                  });
                  
                  const overStock = subComStatus.filter(m => m.status === 'over');
                  const okStock = subComStatus.filter(m => m.status === 'ok');
                  const warningStock = subComStatus.filter(m => m.status === 'warning');
                  const shortageStock = subComStatus.filter(m => m.status === 'shortage');
                  
                  return (
                    <div className="grid grid-cols-4 gap-3 mb-4">
                      <div 
                        className="bg-purple-50 border border-purple-200 rounded-lg p-3 cursor-pointer hover:bg-purple-100 transition"
                        onClick={() => setShowSubcomDetailModal('excess')}
                      >
                        <p className="text-xs text-purple-600 font-medium">📦 과다 재고</p>
                        <p className="text-2xl font-bold text-purple-700">{overStock.length}<span className="text-xs font-normal ml-1">Sub</span></p>
                      </div>
                      <div 
                        className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 cursor-pointer hover:bg-emerald-100 transition"
                        onClick={() => setShowSubcomDetailModal('normal')}
                      >
                        <p className="text-xs text-emerald-600 font-medium">✅ 적정 재고</p>
                        <p className="text-2xl font-bold text-emerald-700">{okStock.length}<span className="text-xs font-normal ml-1">Sub</span></p>
                      </div>
                      <div 
                        className="bg-amber-50 border border-amber-200 rounded-lg p-3 cursor-pointer hover:bg-amber-100 transition"
                        onClick={() => setShowSubcomDetailModal('caution')}
                      >
                        <p className="text-xs text-amber-600 font-medium">⚠️ 부족 주의</p>
                        <p className="text-2xl font-bold text-amber-700">{warningStock.length}<span className="text-xs font-normal ml-1">Sub</span></p>
                      </div>
                      <div 
                        className="bg-red-50 border border-red-200 rounded-lg p-3 cursor-pointer hover:bg-red-100 transition"
                        onClick={() => setShowSubcomDetailModal('urgent')}
                      >
                        <p className="text-xs text-red-600 font-medium">🚨 부족 긴급</p>
                        <p className="text-2xl font-bold text-red-700">{shortageStock.length}<span className="text-xs font-normal ml-1">Sub</span></p>
                      </div>
                    </div>
                  );
                })()}
                
                {/* 색상 범례 */}
                <div className="flex flex-wrap gap-4 mb-4 text-xs">
                  <span className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded-full bg-purple-400"></span> 과다 (50대 초과, KB0770: 100대 초과)
                  </span>
                  <span className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded-full bg-emerald-400"></span> 적정 (10~50대, KB0770: 20~100대)
                  </span>
                  <span className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded-full bg-amber-400"></span> 주의 (5~9대)
                  </span>
                  <span className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded-full bg-red-400"></span> 긴급 (5대 미만)
                  </span>
                </div>
                
                {/* Maxwell 16 시리즈 Sub-component */}
                {(() => {
                  const subCom48 = ['KB0770', 'KB0778', 'KB0840', 'KB0768', 'KB0776', 'KB0780', 'KB0835', 'KB0775', 'KB0771'];
                  const SUBCOM_SAFETY = { min: 10, max: 50 };
                  const filtered16 = Object.entries(subComponentUnits)
                    .filter(([name]) => !subCom48.includes(name))
                    .sort((a, b) => a[1].units - b[1].units);
                  
                  if (filtered16.length === 0) return null;
                  
                  return (
                    <div className="mb-6">
                      <h4 className="text-sm font-semibold text-purple-700 mb-3 flex items-center gap-2">
                        <span className="px-2 py-0.5 bg-purple-100 rounded text-xs">16</span> Maxwell 16 시리즈
                      </h4>
                      <div className="grid grid-cols-3 gap-4">
                        {filtered16.map(([subComName, info]) => {
                          const currentStock = inventoryData.filter(i => i.material === subComName).reduce((sum, i) => sum + (i.stock || 0), 0);
                          const range = SUBCOM_SAFETY;
                          const status = currentStock > range.max ? 'over' : currentStock >= range.min ? 'ok' : currentStock >= range.min * 0.5 ? 'warning' : 'shortage';
                          const bgColor = status === 'over' ? 'bg-purple-50 border-purple-300' :
                                          status === 'ok' ? 'bg-emerald-50 border-emerald-300' :
                                          status === 'warning' ? 'bg-amber-50 border-amber-300' :
                                          'bg-red-50 border-red-300';
                          const textColor = status === 'over' ? 'text-purple-700' :
                                           status === 'ok' ? 'text-emerald-700' :
                                           status === 'warning' ? 'text-amber-700' :
                                           'text-red-700';
                          const statusLabel = status === 'over' ? '과다' : status === 'ok' ? '적정' : status === 'warning' ? '주의' : '긴급';
                          const statusIcon = status === 'over' ? '📦' : status === 'ok' ? '✅' : status === 'warning' ? '⚠️' : '🚨';
                          
                          return (
                            <div key={subComName} className={`rounded-xl p-4 border-2 ${bgColor}`}>
                              <div className="flex justify-between items-start mb-2">
                                <p className="font-bold text-gray-800">{subComName}</p>
                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                  status === 'over' ? 'bg-purple-200 text-purple-800' :
                                  status === 'ok' ? 'bg-emerald-200 text-emerald-800' :
                                  status === 'warning' ? 'bg-amber-200 text-amber-800' :
                                  'bg-red-200 text-red-800'
                                }`}>
                                  {statusIcon} {statusLabel}
                                </span>
                              </div>
                              <div className="flex items-end gap-2">
                                <p className={`text-3xl font-bold ${textColor}`}>{info.units}<span className="text-lg">대</span></p>
                              </div>
                              <p className="text-xs text-gray-500 mt-1">Safety Stock: {range.min}~{range.max}대</p>
                              <p className="text-xs text-blue-600 mt-0.5">
                                현재 재고: {currentStock.toLocaleString()} EA
                              </p>
                              <div className="mt-2">
                                <div className="w-full bg-gray-200 rounded-full h-2 relative">
                                  <div className="absolute h-full w-0.5 bg-gray-400" style={{ left: `${(range.min / range.max) * 100}%` }} />
                                  <div 
                                    className={`h-2 rounded-full ${
                                      status === 'over' ? 'bg-purple-500' :
                                      status === 'ok' ? 'bg-emerald-500' :
                                      status === 'warning' ? 'bg-amber-500' :
                                      'bg-red-500'
                                    }`}
                                    style={{ width: `${Math.min((currentStock / range.max) * 100, 100)}%` }}
                                  />
                                </div>
                              </div>
                              {info.bottleneck && info.units < 20 && (
                                <p className="mt-2 text-xs text-gray-600 truncate">
                                  병목: {info.bottleneck.material} | 재고: {info.bottleneck.currentStock} EA
                                  {(() => {
                                    const openPO = getOpenPOForMaterial(info.bottleneck.material);
                                    return openPO ? (
                                      <span className="text-green-600 font-medium ml-1">| 📦 {openPO.totalQty.toLocaleString()} {openPO.unit}</span>
                                    ) : (
                                      <span className="text-red-500 ml-1">| ⚠️ Open PO 없음</span>
                                    );
                                  })()}
                                </p>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })()}

                {/* 시리즈 구분선 */}
                <div className="my-6 border-t border-gray-200"></div>

                {/* Maxwell 48 시리즈 Sub-component */}
                {(() => {
                  const subCom48 = ['KB0770', 'KB0778', 'KB0840', 'KB0768', 'KB0776', 'KB0780', 'KB0835', 'KB0775', 'KB0771'];
                  const SUBCOM_SAFETY = { min: 10, max: 50 };
                  const SUBCOM_SAFETY_KB0770 = { min: 20, max: 100 }; // KB0770은 1대당 2EA 사용
                  const filtered48 = Object.entries(subComponentUnits)
                    .filter(([name]) => subCom48.includes(name))
                    .sort((a, b) => a[1].units - b[1].units);
                  
                  if (filtered48.length === 0) return null;
                  
                  return (
                    <div className="mb-2">
                      <h4 className="text-sm font-semibold text-blue-700 mb-3 flex items-center gap-2">
                        <span className="px-2 py-0.5 bg-blue-100 rounded text-xs">48</span> Maxwell 48 시리즈
                      </h4>
                      <div className="grid grid-cols-3 gap-4">
                        {filtered48.map(([subComName, info]) => {
                          const currentStock = inventoryData.filter(i => i.material === subComName).reduce((sum, i) => sum + (i.stock || 0), 0);
                          const range = subComName === 'KB0770' ? SUBCOM_SAFETY_KB0770 : SUBCOM_SAFETY;
                          const status = currentStock > range.max ? 'over' : currentStock >= range.min ? 'ok' : currentStock >= range.min * 0.5 ? 'warning' : 'shortage';
                          const bgColor = status === 'over' ? 'bg-purple-50 border-purple-300' :
                                          status === 'ok' ? 'bg-emerald-50 border-emerald-300' :
                                          status === 'warning' ? 'bg-amber-50 border-amber-300' :
                                          'bg-red-50 border-red-300';
                          const textColor = status === 'over' ? 'text-purple-700' :
                                           status === 'ok' ? 'text-emerald-700' :
                                           status === 'warning' ? 'text-amber-700' :
                                           'text-red-700';
                          const statusLabel = status === 'over' ? '과다' : status === 'ok' ? '적정' : status === 'warning' ? '주의' : '긴급';
                          const statusIcon = status === 'over' ? '📦' : status === 'ok' ? '✅' : status === 'warning' ? '⚠️' : '🚨';
                          
                          return (
                            <div key={subComName} className={`rounded-xl p-4 border-2 ${bgColor}`}>
                              <div className="flex justify-between items-start mb-2">
                                <div>
                                  <p className="font-bold text-gray-800">{subComName}</p>
                                  {subComName === 'KB0770' && <p className="text-xs text-gray-400">1대당 2EA</p>}
                                </div>
                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                  status === 'over' ? 'bg-purple-200 text-purple-800' :
                                  status === 'ok' ? 'bg-emerald-200 text-emerald-800' :
                                  status === 'warning' ? 'bg-amber-200 text-amber-800' :
                                  'bg-red-200 text-red-800'
                                }`}>
                                  {statusIcon} {statusLabel}
                                </span>
                              </div>
                              <div className="flex items-end gap-2">
                                <p className={`text-3xl font-bold ${textColor}`}>{info.units}<span className="text-lg">대</span></p>
                              </div>
                              <p className="text-xs text-gray-500 mt-1">Safety Stock: {range.min}~{range.max}대</p>
                              <p className="text-xs text-blue-600 mt-0.5">
                                현재 재고: {currentStock.toLocaleString()} EA
                              </p>
                              <div className="mt-2">
                                <div className="w-full bg-gray-200 rounded-full h-2 relative">
                                  <div className="absolute h-full w-0.5 bg-gray-400" style={{ left: `${(range.min / range.max) * 100}%` }} />
                                  <div 
                                    className={`h-2 rounded-full ${
                                      status === 'over' ? 'bg-purple-500' :
                                      status === 'ok' ? 'bg-emerald-500' :
                                      status === 'warning' ? 'bg-amber-500' :
                                      'bg-red-500'
                                    }`}
                                    style={{ width: `${Math.min((currentStock / range.max) * 100, 100)}%` }}
                                  />
                                </div>
                              </div>
                              {info.bottleneck && info.units < 20 && (
                                <p className="mt-2 text-xs text-gray-600 truncate">
                                  병목: {info.bottleneck.material} | 재고: {info.bottleneck.currentStock} EA
                                  {(() => {
                                    const openPO = getOpenPOForMaterial(info.bottleneck.material);
                                    return openPO ? (
                                      <span className="text-green-600 font-medium ml-1">| 📦 {openPO.totalQty.toLocaleString()} {openPO.unit}</span>
                                    ) : (
                                      <span className="text-red-500 ml-1">| ⚠️ Open PO 없음</span>
                                    );
                                  })()}
                                </p>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })()}
                
                <p className="text-xs text-gray-400 mt-4">
                  💡 Sub-component = 완제품 조립에 필요한 반제품/조립품. BOM 파일의 KB 시트 기준.
                </p>
              </div>
            )}

            {/* 📦 발주 제안 */}
            <div className="bg-white rounded-xl shadow-sm p-6">
              <h3 className="font-semibold mb-4 flex items-center gap-2">
                <Package className="w-5 h-5 text-indigo-500" />
                💡 발주 제안 (BOM 병목 자재 기준)
              </h3>
              
              {(() => {
                const TARGET_STOCK = {
                  'RSC16': { min: 10, max: 30 },
                  'CSC16': { min: 10, max: 30 },
                  'FSC16': { min: 5, max: 20 },
                  'RSC48': { min: 10, max: 30 },
                  'CSC48': { min: 10, max: 30 },
                  'HSM3': { min: 3, max: 30 }
                };
                
                // 부족 모델의 병목 자재 수집
                const shortageItems = [];
                const overItems = [];
                
                Object.entries(TARGET_STOCK).forEach(([model, range]) => {
                  const current = producibleUnits[model]?.units || 0;
                  const bottleneck = producibleUnits[model]?.bottleneck;
                  
                  if (current < range.min && bottleneck) {
                    // 부족: 발주 필요
                    const needQty = (range.min - current) * (bottleneck.requiredQty || 1);
                    shortageItems.push({
                      model,
                      material: bottleneck.material,
                      description: bottleneck.description,
                      currentStock: bottleneck.currentStock,
                      needQty,
                      shortage: range.min - current,
                      min: range.min,
                      type: 'shortage'
                    });
                  } else if (current > range.max && bottleneck) {
                    // 과다: 발주 연기
                    overItems.push({
                      model,
                      material: bottleneck.material,
                      description: bottleneck.description,
                      currentStock: bottleneck.currentStock,
                      excess: current - range.max,
                      max: range.max,
                      type: 'over'
                    });
                  }
                });
                
                return (
                  <div className="space-y-4">
                    {/* 발주 필요 (부족) */}
                    {shortageItems.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium text-red-700 mb-2">🚨 발주 필요 (부족 자재)</h4>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead className="bg-red-50">
                              <tr>
                                <th className="px-3 py-2 text-left">모델</th>
                                <th className="px-3 py-2 text-left">병목 자재</th>
                                <th className="px-3 py-2 text-left">Description</th>
                                <th className="px-3 py-2 text-right">현재 재고</th>
                                <th className="px-3 py-2 text-right">부족 대수</th>
                                <th className="px-3 py-2 text-left">제안</th>
                                <th className="px-3 py-2 text-left">Open PO</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y">
                              {shortageItems.map((item, idx) => {
                                const openPO = getOpenPOForMaterial(item.material);
                                return (
                                  <tr key={idx} className="hover:bg-red-50/50">
                                    <td className="px-3 py-2 font-medium">{item.model}</td>
                                    <td className="px-3 py-2">{item.material}</td>
                                    <td className="px-3 py-2 text-gray-600 truncate max-w-xs">{item.description?.slice(0, 25) || '-'}</td>
                                    <td className="px-3 py-2 text-right">{item.currentStock?.toLocaleString()} EA</td>
                                    <td className="px-3 py-2 text-right font-bold text-red-600">-{item.shortage}대</td>
                                    <td className="px-3 py-2">
                                      {openPO ? (
                                        <span className="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded">
                                          📦 발주 진행 중
                                        </span>
                                      ) : (
                                        <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded">
                                          🛒 발주 필요
                                        </span>
                                      )}
                                    </td>
                                    <td className="px-3 py-2">
                                      {openPO ? (
                                        <span className="text-amber-600 font-medium">
                                          📦 {openPO.totalQty.toLocaleString()} {openPO.unit}
                                        </span>
                                      ) : (
                                        <span className="text-gray-400">-</span>
                                      )}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                    
                    {/* 발주 연기 (과다) */}
                    {overItems.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium text-purple-700 mb-2">📦 발주 연기 검토 (과다 재고)</h4>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead className="bg-purple-50">
                              <tr>
                                <th className="px-3 py-2 text-left">모델</th>
                                <th className="px-3 py-2 text-left">병목 자재</th>
                                <th className="px-3 py-2 text-left">Description</th>
                                <th className="px-3 py-2 text-right">현재 재고</th>
                                <th className="px-3 py-2 text-right">초과 대수</th>
                                <th className="px-3 py-2 text-left">제안</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y">
                              {overItems.map((item, idx) => (
                                <tr key={idx} className="hover:bg-purple-50/50">
                                  <td className="px-3 py-2 font-medium">{item.model}</td>
                                  <td className="px-3 py-2">{item.material}</td>
                                  <td className="px-3 py-2 text-gray-600 truncate max-w-xs">{item.description?.slice(0, 25) || '-'}</td>
                                  <td className="px-3 py-2 text-right">{item.currentStock?.toLocaleString()} EA</td>
                                  <td className="px-3 py-2 text-right font-bold text-purple-600">+{item.excess}대</td>
                                  <td className="px-3 py-2">
                                    <span className="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded">
                                      📅 발주 연기
                                    </span>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                    
                    {shortageItems.length === 0 && overItems.length === 0 && (
                      <p className="text-center text-gray-500 py-4">✅ 모든 모델이 적정 재고 범위 내입니다.</p>
                    )}
                  </div>
                );
              })()}
            </div>

            {/* A1 개선: 부족 자재 상세 목록 + Open PO 매칭 */}
            <div className="bg-white rounded-xl shadow-sm p-6">
              <h3 className="font-semibold mb-4 flex items-center gap-2">
                <AlertTriangle className="w-5 h-5 text-red-500" />
                🚨 부족/저재고 자재 현황 (Open PO 매칭)
                {customBomData && <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full ml-2">사용자 BOM</span>}
              </h3>
              
              {(() => {
                // 모든 모델의 BOM을 검사하여 부족 자재 수집
                const allShortages = [];
                const stockByMaterial = {};
                const descByMaterial = {};
                
                inventoryData.forEach(item => {
                  stockByMaterial[item.material] = (stockByMaterial[item.material] || 0) + item.stock;
                  descByMaterial[item.material] = item.description || '';
                });
                
                // 모델별 BOM 검사 (사용자 BOM 또는 기본 BOM)
                const bomToUse = customBomData || MODEL_BOM_DATA;
                Object.entries(bomToUse).forEach(([model, bom]) => {
                  Object.entries(bom).forEach(([material, requiredQty]) => {
                    const currentStock = stockByMaterial[material] || 0;
                    const possibleUnits = Math.floor(currentStock / requiredQty);
                    
                    // 모델별 부족 기준: HSM3=3대, 나머지=10대
                    const threshold = (model === 'HSM3' || model === 'HSM3.0') ? 3 : 10;
                    if (possibleUnits < threshold && requiredQty > 0) {
                      const openPO = openPOData.find(po => po.material === material);
                      const existingIdx = allShortages.findIndex(s => s.material === material);
                      
                      if (existingIdx === -1) {
                        allShortages.push({
                          material,
                          description: descByMaterial[material] || openPO?.description || '-',
                          currentStock,
                          requiredQty,
                          possibleUnits,
                          models: [model],
                          openPO: openPO ? {
                            qty: openPO.totalQty,
                            unit: openPO.unit,
                            poNumbers: openPO.poNumbers
                          } : null,
                          urgency: possibleUnits === 0 ? 'critical' : possibleUnits < Math.ceil(threshold/2) ? 'high' : 'medium'
                        });
                      } else {
                        if (!allShortages[existingIdx].models.includes(model)) {
                          allShortages[existingIdx].models.push(model);
                        }
                      }
                    }
                  });
                });
                
                // 긴급도 순으로 정렬
                allShortages.sort((a, b) => {
                  const urgencyOrder = { critical: 0, high: 1, medium: 2 };
                  return urgencyOrder[a.urgency] - urgencyOrder[b.urgency] || a.possibleUnits - b.possibleUnits;
                });
                
                const criticalCount = allShortages.filter(s => s.urgency === 'critical').length;
                const highCount = allShortages.filter(s => s.urgency === 'high').length;
                const withPOCount = allShortages.filter(s => s.openPO).length;
                const noPOCount = allShortages.filter(s => !s.openPO).length;
                
                return (
                  <div className="space-y-4">
                    {/* 요약 카드 */}
                    <div className="grid grid-cols-4 gap-3">
                      <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition" onClick={() => setShowShortageDetailModal('critical')}>
                        <p className="text-2xl font-bold text-red-600">{criticalCount}</p>
                        <p className="text-xs text-red-600">생산불가 (0대)</p>
                      </div>
                      <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition" onClick={() => setShowShortageDetailModal('high')}>
                        <p className="text-2xl font-bold text-amber-600">{highCount}</p>
                        <p className="text-xs text-amber-600">긴급 (1~4대)</p>
                      </div>
                      <div className="bg-green-50 border border-green-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition" onClick={() => setShowShortageDetailModal('withPO')}>
                        <p className="text-2xl font-bold text-green-600">{withPOCount}</p>
                        <p className="text-xs text-green-600">발주 진행중</p>
                      </div>
                      <div className="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition" onClick={() => setShowShortageDetailModal('noPO')}>
                        <p className="text-2xl font-bold text-gray-600">{noPOCount}</p>
                        <p className="text-xs text-gray-600">발주 필요</p>
                      </div>
                    </div>
                    
                    {/* 부족 자재 테이블 */}
                    {allShortages.length > 0 ? (
                      <div className="overflow-x-auto max-h-80">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-50 sticky top-0">
                            <tr>
                              <th className="px-3 py-2 text-left">긴급도</th>
                              <th className="px-3 py-2 text-left">Material</th>
                              <th className="px-3 py-2 text-left">Description</th>
                              <th className="px-3 py-2 text-right">현재재고</th>
                              <th className="px-3 py-2 text-center">생산가능</th>
                              <th className="px-3 py-2 text-left">해당모델</th>
                              <th className="px-3 py-2 text-center">Open PO</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y">
                            {allShortages.slice(0, 20).map((item, idx) => (
                              <tr key={idx} className={`hover:bg-gray-50 ${
                                item.urgency === 'critical' ? 'bg-red-50/50' : 
                                item.urgency === 'high' ? 'bg-amber-50/50' : ''
                              }`}>
                                <td className="px-3 py-2">
                                  <span className={`px-2 py-1 rounded text-xs font-medium ${
                                    item.urgency === 'critical' ? 'bg-red-100 text-red-700' :
                                    item.urgency === 'high' ? 'bg-amber-100 text-amber-700' :
                                    'bg-yellow-100 text-yellow-700'
                                  }`}>
                                    {item.urgency === 'critical' ? '🔴 긴급' : 
                                     item.urgency === 'high' ? '🟠 주의' : '🟡 관찰'}
                                  </span>
                                </td>
                                <td className="px-3 py-2 font-mono text-xs">{item.material}</td>
                                <td className="px-3 py-2 text-gray-600 truncate max-w-xs" title={item.description}>
                                  {item.description?.slice(0, 30) || '-'}
                                </td>
                                <td className="px-3 py-2 text-right font-medium">{item.currentStock.toLocaleString()}</td>
                                <td className="px-3 py-2 text-center">
                                  <span className={`font-bold ${
                                    item.possibleUnits === 0 ? 'text-red-600' :
                                    item.possibleUnits < 5 ? 'text-amber-600' : 'text-yellow-600'
                                  }`}>
                                    {item.possibleUnits}대
                                  </span>
                                </td>
                                <td className="px-3 py-2">
                                  <div className="flex flex-wrap gap-1">
                                    {item.models.slice(0, 3).map((m, i) => (
                                      <span key={i} className="px-1.5 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded">
                                        {m}
                                      </span>
                                    ))}
                                    {item.models.length > 3 && (
                                      <span className="px-1.5 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">
                                        +{item.models.length - 3}
                                      </span>
                                    )}
                                  </div>
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {item.openPO ? (
                                    <div className="flex flex-col items-center">
                                      <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">
                                        ✅ {item.openPO.qty.toLocaleString()} {item.openPO.unit}
                                      </span>
                                      {item.openPO.poNumbers?.length > 0 && (
                                        <span className="text-xs text-gray-400 mt-0.5">
                                          PO: {item.openPO.poNumbers[0]}
                                        </span>
                                      )}
                                    </div>
                                  ) : (
                                    <span className="px-2 py-1 bg-red-100 text-red-600 text-xs rounded font-medium">
                                      ❌ 발주 필요
                                    </span>
                                  )}
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                        {allShortages.length > 20 && (
                          <p className="text-center text-gray-400 text-sm py-2">
                            ... 외 {allShortages.length - 20}개 자재
                          </p>
                        )}
                      </div>
                    ) : (
                      <p className="text-center text-gray-500 py-4">✅ 모든 자재가 충분합니다. (기준: 10대, HSM3: 3대 이상)</p>
                    )}
                    
                    <p className="text-xs text-gray-400">
                      💡 기준: 10대 미만 생산 가능한 자재를 부족 자재로 분류합니다 (HSM3: 3대 미만). Open PO 데이터는 마지막 업로드 기준입니다.
                    </p>
                  </div>
                );
              })()}
            </div>

            {/* Area Summary */}
            <div className="bg-white rounded-xl shadow-sm p-6">
              <h3 className="font-semibold mb-4">📍 Area별 현황</h3>
              <div className="grid grid-cols-3 md:grid-cols-7 gap-3">
                {['A', 'B', 'C', 'D', 'E', 'F', 'S'].map(zone => {
                  const zoneRacks = rackSummary.filter(r => r.zone === zone);
                  const zoneStock = zoneRacks.reduce((s, r) => s + r.stock, 0);
                  const zoneItems = zoneRacks.reduce((s, r) => s + r.items, 0);
                  if (zoneRacks.length === 0) return null;
                  return (
                    <div key={zone} className="bg-slate-50 rounded-lg p-3 text-center">
                      <p className="text-xl font-bold text-indigo-600">{zone} Area</p>
                      <p className="text-xs text-gray-500">{zoneRacks.length}개 랙</p>
                      <p className="text-sm font-medium">{zoneItems}개 품목</p>
                      <p className="text-xs text-gray-400">{zoneStock.toLocaleString()} EA</p>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {/* 📍 자재 위치 검색 */}
        {activeTab === 'locate' && (
          <div className="space-y-4">
            {/* 검색 헤더 */}
            <div className="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-xl p-6 text-white">
              <h2 className="text-xl font-bold mb-1">📍 자재 위치 검색</h2>
              <p className="text-sm text-indigo-200 mb-4">Material 번호를 입력하면 창고 내 보관 위치를 안내합니다.</p>
              <div className="flex gap-2 relative">
                <div className="flex-1 relative">
                  <input
                    type="text"
                    placeholder="Material 번호 입력 (예: 710335, KB0781)"
                    className="w-full px-4 py-3 rounded-lg text-gray-900 text-lg font-medium"
                    value={locateSearch || ''}
                    onChange={e => { setLocateSearch(e.target.value); if(locateQuery) setLocateQuery(''); }}
                    onKeyDown={e => { if(e.key === 'Enter'){setLocateQuery(locateSearch);} }}
                  />
                  {/* 자동완성 드롭다운 */}
                  {locateSearch && locateSearch.length >= 2 && !locateQuery && inventoryData.length > 0 && (() => {
                    const q = locateSearch.trim().toUpperCase();
                    const suggestions = inventoryData.filter(item =>
                      (item.material || '').toUpperCase().includes(q) ||
                      (item.description || '').toUpperCase().includes(q)
                    ).reduce((acc, item) => {
                      if (!acc.find(a => a.material === item.material)) acc.push(item);
                      return acc;
                    }, []).slice(0, 8);
                    if (suggestions.length === 0) return null;
                    return (
                      <div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-xl border border-gray-200 max-h-64 overflow-y-auto z-50">
                        {suggestions.map((s, i) => (
                          <button key={i}
                            className="w-full px-4 py-2.5 text-left hover:bg-indigo-50 flex items-center gap-3 border-b border-gray-100 last:border-0"
                            onClick={() => { setLocateSearch(s.material); setLocateQuery(s.material); }}
                          >
                            <span className="font-mono font-bold text-gray-900 shrink-0">{s.material}</span>
                            <span className="text-sm text-gray-500 truncate">{s.description}</span>
                            <span className="text-xs text-indigo-500 shrink-0 ml-auto">{s.bin}</span>
                          </button>
                        ))}
                      </div>
                    );
                  })()}
                </div>
                <button
                  onClick={() => setLocateQuery(locateSearch)}
                  className="px-6 py-3 bg-amber-500 hover:bg-amber-600 rounded-lg font-bold text-lg transition shrink-0"
                >
                  🔍 검색
                </button>
              </div>
            </div>

            {/* 검색 결과 */}
            {locateQuery && (() => {
              const q = locateQuery.trim().toUpperCase();
              // inventoryData에서 Part No. 매칭
              const matches = inventoryData.filter(item => 
                (item.material || '').toUpperCase().includes(q) ||
                (item.description || '').toUpperCase().includes(q)
              );
              
              if (matches.length === 0) {
                return (
                  <div className="bg-white rounded-xl shadow-sm p-8 text-center">
                    <p className="text-4xl mb-3">🔍</p>
                    <p className="text-lg font-medium text-gray-700">"{locateQuery}" 검색 결과가 없습니다.</p>
                    <p className="text-sm text-gray-500 mt-2">SAP 재고 데이터에 등록된 Material 번호인지 확인해주세요.</p>
                  </div>
                );
              }

              // Bin별 그룹핑
              const binGroups = {};
              matches.forEach(item => {
                const bin = item.bin || 'Unknown';
                if (!binGroups[bin]) binGroups[bin] = [];
                binGroups[bin].push(item);
              });

              // 각 Bin의 위치 정보 매핑
              const locationResults = Object.entries(binGroups).map(([bin, items]) => {
                const area = bin.split('-')[0] || bin;
                const series = RACK_MODEL_SERIES[area] || '기타';
                const binInfo = BIN_RACK_INFO[bin] || { rackType: '경량랙', rackCount: 1 };
                // BIN_LEVEL_MAP에서 실제 단수/위치 조회
                const blm = BIN_LEVEL_MAP[bin] || {l: binInfo.shelves || 3, p: 1};
                const levels = blm.l;
                const rackLevel = blm.p;
                const totalStock = items.reduce((s, i) => s + (i.stock || 0), 0);
                const totalWeight = items.reduce((s, i) => s + ((weightData[i.material]?.w || 0) * (i.stock || 0)), 0);
                return { bin, area, series, binInfo, levels, rackLevel, items, totalStock, totalWeight };
              });

              const seriesColor = {
                'Maxwell 48': { bg: 'bg-red-50', border: 'border-red-400', text: 'text-red-700', badge: 'bg-red-500' },
                'Maxwell 16': { bg: 'bg-blue-50', border: 'border-blue-400', text: 'text-blue-700', badge: 'bg-blue-500' },
                'HSM 3.0': { bg: 'bg-orange-50', border: 'border-orange-400', text: 'text-orange-700', badge: 'bg-orange-500' },
                '기타': { bg: 'bg-gray-50', border: 'border-gray-400', text: 'text-gray-700', badge: 'bg-gray-500' }
              };

              return (
                <div className="space-y-4">
                  {/* 요약 */}
                  <div className="bg-white rounded-xl shadow-sm p-4">
                    <div className="flex items-center gap-4 flex-wrap">
                      <span className="text-sm text-gray-500">검색: <strong className="text-gray-800">{locateQuery}</strong></span>
                      <span className="text-sm px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full font-medium">{matches.length}개 품목</span>
                      <span className="text-sm px-3 py-1 bg-purple-100 text-purple-700 rounded-full font-medium">{Object.keys(binGroups).length}개 Bin</span>
                      <span className="text-sm px-3 py-1 bg-amber-100 text-amber-700 rounded-full font-medium">
                        총 {matches.reduce((s,i) => s + (i.stock||0), 0).toLocaleString()} EA
                      </span>
                    </div>
                  </div>

                  {/* Bin별 위치 카드 — 컴팩트 */}
                  {locationResults.sort((a,b) => a.bin.localeCompare(b.bin)).map((loc, idx) => {
                    const sc = seriesColor[loc.series] || seriesColor['기타'];
                    return (
                      <div key={idx} className={`${sc.bg} rounded-lg shadow-sm border ${sc.border} overflow-hidden`}>
                        {/* 카드 헤더 — 컴팩트 */}
                        <div className="px-4 py-2.5 flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className={`px-2.5 py-1 ${sc.badge} text-white text-xs font-bold rounded`}>{loc.series}</span>
                            <h3 className="text-base font-bold text-gray-900">📍 {loc.bin}</h3>
                            <span className="text-sm text-gray-500">{loc.binInfo.rackType} · {loc.levels}단</span>
                          </div>
                          <div className="text-right text-sm">
                            <span className="font-bold text-gray-700">{loc.items.length}개 품목 · </span>
                            <span className="font-medium text-indigo-600">{loc.totalStock.toLocaleString()} EA</span>
                          </div>
                        </div>

                        {/* 랙(왼) + 품목(중간, 단 맞춤) + 미니맵(오른) */}
                        <div className="px-4 py-3 bg-white/60">
                          <div className="flex gap-3 items-start">
                            {/* SVG 랙 일러스트 */}
                            {(() => {
                              const lvls = loc.levels;
                              const shelfH = 48, pad = 8, pillarW = 8;
                              const svgW = 160, svgH = lvls * shelfH + pad * 2 + 10;
                              return (
                                <svg width={svgW} height={svgH} className="shrink-0">
                                  <rect x={0} y={0} width={svgW} height={svgH} rx={5} fill="#f8fafc" stroke="#e2e8f0" strokeWidth={1}/>
                                  <rect x={4} y={svgH - 7} width={svgW - 8} height={6} rx={2} fill="#64748b"/>
                                  <rect x={4} y={pad - 2} width={pillarW} height={svgH - pad - 5} rx={2} fill="#64748b"/>
                                  <rect x={svgW - pillarW - 4} y={pad - 2} width={pillarW} height={svgH - pad - 5} rx={2} fill="#64748b"/>
                                  <rect x={6} y={pad - 2} width={2.5} height={svgH - pad - 5} fill="#94a3b8" opacity={0.4}/>
                                  <rect x={svgW - pillarW - 2} y={pad - 2} width={2.5} height={svgH - pad - 5} fill="#94a3b8" opacity={0.4}/>
                                  {Array.from({length: lvls}, (_, i) => {
                                    const levelNum = i + 1;
                                    const isHere = levelNum === loc.rackLevel;
                                    const y = pad + i * shelfH;
                                    const shelfY = y + shelfH - 6;
                                    const cx = pillarW + 7, cw = svgW - pillarW * 2 - 14;
                                    return (
                                      <g key={i}>
                                        {isHere && <rect x={cx - 1} y={y + 2} width={cw + 2} height={shelfH - 5} rx={3} fill="#fef3c7" stroke="#f59e0b" strokeWidth={1.5}/>}
                                        <text x={cx + 3} y={y + shelfH / 2 + 1} fill={isHere ? '#92400e' : '#94a3b8'} fontSize={isHere ? 13 : 11} fontWeight={isHere ? 'bold' : 'normal'} dominantBaseline="middle">{levelNum}단</text>
                                        {isHere ? loc.items.slice(0, 3).map((_, bi) => {
                                          const bw = 26, bh = shelfH - 16, bx = cx + cw - (3 - bi) * (bw + 3), by = y + 6;
                                          return (<g key={bi}><rect x={bx} y={by} width={bw} height={bh} rx={2.5} fill="#fbbf24" stroke="#d97706" strokeWidth={0.8}/><path d={`M${bx+2},${by} Q${bx+bw/2},${by+5} ${bx+bw-2},${by}`} fill="#f59e0b" stroke="#d97706" strokeWidth={0.4}/><rect x={bx+bw/2-2.5} y={by+4} width={5} height={bh-7} rx={0.5} fill="#3b82f6" opacity={0.4}/></g>);
                                        }) : <line x1={cx + 28} y1={y + shelfH/2} x2={cx + cw - 4} y2={y + shelfH/2} stroke="#e2e8f0" strokeWidth={1} strokeDasharray="4,3"/>}
                                        <rect x={4} y={shelfY} width={svgW - 8} height={6} rx={1} fill={isHere ? '#b45309' : '#94a3b8'}/>
                                        <rect x={5} y={shelfY} width={svgW - 10} height={2} rx={0.5} fill={isHere ? '#fbbf24' : '#b0bec5'} opacity={0.5}/>
                                      </g>
                                    );
                                  })}
                                </svg>
                              );
                            })()}
                            {/* 품목 — 해당 단 높이+크기에 맞춤 */}
                            <div className="min-w-0" style={{flex:'0 1 auto'}}>
                              {Array.from({length: loc.levels}, (_, i) => {
                                const levelNum = i + 1;
                                const isHere = levelNum === loc.rackLevel;
                                return (
                                  <div key={i} className="flex items-center" style={{height: 48}}>
                                    {isHere ? (
                                      <div className="space-y-0.5">
                                        {loc.items.slice(0, 3).map((item, j) => (
                                          <div key={j} className="flex items-center px-2.5 py-1 bg-amber-50 rounded border border-amber-200 gap-2 whitespace-nowrap">
                                            <span className="font-mono font-bold text-gray-900 text-sm shrink-0">{item.material}</span>
                                            <span className="text-gray-600 text-sm">{item.description}</span>
                                            <span className="font-bold text-indigo-600 text-sm shrink-0">{(item.stock||0).toLocaleString()} EA</span>
                                          </div>
                                        ))}
                                        {loc.items.length > 3 && <span className="text-xs text-gray-400 px-1">외 {loc.items.length-3}개</span>}
                                      </div>
                                    ) : null}
                                  </div>
                                );
                              })}
                            </div>
                            {/* 미니맵 (오른쪽 고정) */}
                            <div className="shrink-0 flex flex-col items-center gap-1.5 ml-auto">
                              <LocateMiniMap layoutData={layoutData} targetArea={loc.area} />
                              <button onClick={() => { setActiveTab('layout'); }}
                                className="text-xs px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition">
                                🗺️ 배치도에서 보기 · {loc.area}
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}

                  {/* 전체 결과 테이블 */}
                  {matches.length > 3 && (
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                      <div className="px-4 py-2 bg-gray-100 border-b">
                        <h4 className="text-sm font-bold text-gray-700">📋 전체 검색 결과 ({matches.length}건)</h4>
                      </div>
                      <div className="overflow-x-auto" style={{maxHeight:'400px', overflowY:'auto'}}>
                        <table className="w-full text-sm">
                          <thead className="bg-gray-50 sticky top-0">
                            <tr>
                              <th className="px-3 py-2 text-left">Material</th>
                              <th className="px-3 py-2 text-left">Description</th>
                              <th className="px-3 py-2 text-center">Bin</th>
                              <th className="px-3 py-2 text-center">영역</th>
                              <th className="px-3 py-2 text-center">시리즈</th>
                              <th className="px-3 py-2 text-right">재고</th>
                            </tr>
                          </thead>
                          <tbody>
                            {matches.map((item, i) => {
                              const area = (item.bin||'').split('-')[0];
                              const series = RACK_MODEL_SERIES[area] || '기타';
                              return (
                                <tr key={i} className="border-b hover:bg-indigo-50">
                                  <td className="px-3 py-2 font-mono font-bold">{item.material}</td>
                                  <td className="px-3 py-2 text-gray-600 truncate max-w-xs">{item.description}</td>
                                  <td className="px-3 py-2 text-center font-medium">{item.bin}</td>
                                  <td className="px-3 py-2 text-center">{area}</td>
                                  <td className="px-3 py-2 text-center">
                                    <span className={`px-2 py-0.5 rounded text-xs text-white ${
                                      series === 'Maxwell 48' ? 'bg-red-500' : series === 'Maxwell 16' ? 'bg-blue-500' : series === 'HSM 3.0' ? 'bg-orange-500' : 'bg-gray-500'
                                    }`}>{series}</span>
                                  </td>
                                  <td className="px-3 py-2 text-right font-medium">{(item.stock||0).toLocaleString()}</td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* 초기 안내 */}
            {!locateQuery && (
              <div className="bg-white rounded-xl shadow-sm p-8 text-center">
                <p className="text-5xl mb-4">📦</p>
                <p className="text-lg font-medium text-gray-700">Material 번호를 입력하여 자재 위치를 검색하세요</p>
                <p className="text-sm text-gray-500 mt-2">Material 번호 또는 Description으로 검색할 수 있습니다.</p>
                <div className="mt-6 flex flex-wrap justify-center gap-2">
                  {['710335', '712626', 'KB0781', 'Motor', 'Heater'].map(ex => (
                    <button key={ex} onClick={() => { setLocateSearch(ex); setLocateQuery(ex); }}
                      className="px-3 py-1.5 bg-gray-100 hover:bg-indigo-100 text-sm text-gray-600 rounded-lg transition">
                      {ex}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}


        {/* 🏭 랙 배치도 에디터 (인라인 임베딩) */}
        {activeTab === 'layout' && (
          <div className="space-y-4">
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="px-4 py-2 bg-gradient-to-r from-slate-700 to-slate-800 text-white flex justify-between items-center">
                <h3 className="text-lg font-bold flex items-center gap-2">🏭 창고 랙 배치도 에디터</h3>
                <span className="text-xs bg-white/20 px-2 py-1 rounded">그리드 1칸 = 0.5m (50cm) | 생산창고 117.91평 · 생산라인+창고 195.01평</span>
              </div>
              <div className="px-3 py-1 bg-gray-50 border-b text-xs text-gray-500">
                <span>💡 <b>이동(V)</b>: 화면 스크롤 · <b>선택(S)</b>: 랙 선택/이동 · <b>측정(M)</b>: 거리 측정 · <b>텍스트(T)</b>: 라벨 추가</span>
              </div>
              <iframe
                ref={layoutIframeRef}
                srcDoc={LAYOUT_EDITOR_HTML}
                style={{ width: '100%', height: 'calc(100vh - 120px)', border: 'none', minHeight: '1200px' }}
                title="PBK 창고 랙 배치도" sandbox="allow-scripts allow-same-origin allow-modals allow-popups allow-forms"
              />
            </div>
          </div>
        )}

        {activeTab === 'view3d' && (
          <div className="space-y-4">
            <div className="bg-slate-900 rounded-xl shadow-sm overflow-hidden">
              <div className="px-4 py-2 bg-gradient-to-r from-indigo-700 to-purple-800 text-white flex justify-between items-center">
                <h3 className="text-lg font-bold flex items-center gap-2">🏗️ 3D 창고 뷰</h3>
                <div className="flex gap-1">
                  {[{id:'iso',label:'기본'},{id:'top',label:'위에서'},{id:'front',label:'정면'},{id:'entrance',label:'입구'},{id:'side',label:'측면'}].map(p=>(
                    <button key={p.id} onClick={()=>view3dCtrlRef.current&&view3dCtrlRef.current.setCamPreset(p.id)}
                      className="px-2 py-1 text-xs bg-white/10 hover:bg-white/25 rounded transition">{p.label}</button>
                  ))}
                </div>
              </div>
              <div className="flex flex-wrap items-center gap-2 px-3 py-2 bg-slate-800 text-xs text-gray-300">
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded" style={{background:'#dc2626'}}></span>RSC48</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded" style={{background:'#2563eb'}}></span>RSC16</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded" style={{background:'#d97706'}}></span>HSM</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded" style={{background:'#eab308'}}></span>Semi</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded" style={{background:'#06b6d4'}}></span>E3/D2</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded" style={{background:'#22c55e'}}></span>구역</span>
                <span className="border-l border-slate-600 pl-2 ml-1"></span>
                <button onClick={()=>{if(view3dCtrlRef.current){var v=view3dCtrlRef.current.toggleWalk();document.getElementById('btn3dWalk').classList.toggle('bg-yellow-700',v);setWalkHudVisible(v);}}}
                  id="btn3dWalk" className="px-2 py-1 bg-slate-700 hover:bg-yellow-700 rounded transition font-bold">🚜 워크스루</button>
                <button onClick={()=>{if(view3dCtrlRef.current)view3dCtrlRef.current.captureScreenshot();}}
                  className="px-2 py-1 bg-slate-700 hover:bg-sky-700 rounded transition">📷 캡처</button>
                <span className="ml-auto text-gray-500">{walkHudVisible ? 'WASD 이동 · Q/E 회전 · 마우스 시점 · ESC 종료' : 'WASD/↑↓←→ 이동 · 드래그 회전 · 스크롤 줌'}</span>
              </div>
              {!layoutData ? (
                <div className="flex items-center justify-center h-96 text-gray-400">
                  <p>배치도 데이터가 없습니다. 먼저 랙 배치도 탭에서 배치도를 저장해주세요.</p>
                </div>
              ) : (
                <div className="relative">
                  <canvas ref={view3dCanvasRef} style={{width:'100%',height:'calc(100vh - 160px)',minHeight:'600px',display:'block'}} />
                  {/* 워크스루 HUD 오버레이 */}
                  {walkHudVisible && (
                    <WalkHud walkRef={view3dWalkRef} ctrlRef={view3dCtrlRef} onClose={()=>{
                      if(view3dCtrlRef.current&&view3dWalkRef.current&&view3dWalkRef.current.active){
                        view3dCtrlRef.current.toggleWalk();
                        var btn=document.getElementById('btn3dWalk');if(btn)btn.classList.remove('bg-yellow-700');
                      }
                      setWalkHudVisible(false);
                    }} />
                  )}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Area Analysis (창고 레이아웃 + 공간 분석 통합) */}
        {activeTab === 'analysis' && inventoryData.length > 0 && (
          <div className="space-y-6">
            
{/* 총 현황 요약 */}
            <div className="grid grid-cols-3 gap-4">
              <div className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-indigo-500">
                <p className="text-sm text-gray-500">총 품목</p>
                <p className="text-2xl font-bold">{totals.items.toLocaleString()}개</p>
              </div>
              <div className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-emerald-500">
                <p className="text-sm text-gray-500">총 재고</p>
                <p className="text-2xl font-bold">{totals.stock.toLocaleString()} EA</p>
              </div>
              <div className="bg-white rounded-xl shadow-sm p-5 border-l-4 border-amber-500">
                <p className="text-sm text-gray-500">총 무게</p>
                <p className="text-2xl font-bold">{totals.weight.toLocaleString(undefined, {maximumFractionDigits: 1})} kg</p>
              </div>
            </div>


            
            {/* 모델 시리즈별 필터 */}
            <div className="bg-white rounded-xl shadow-sm p-4 flex flex-wrap gap-4 items-center">
              <div className="flex items-center gap-2">
                <Filter className="w-4 h-4 text-gray-400" />
                <select value={selectedZone} onChange={e => setSelectedZone(e.target.value)} className="border rounded-lg px-3 py-2 text-sm">
                  <option value="all">전체 모델</option>
                  <option value="Maxwell 16">Maxwell 16 (RSC16/CSC16/FSC16)</option>
                  <option value="Maxwell 48">Maxwell 48 (RSC48/CSC48)</option>
                  <option value="HSM 3.0">HSM 3.0</option>
                  <option value="Others">기타</option>
                </select>
              </div>
              <div className="flex items-center gap-2 flex-1">
                <Search className="w-4 h-4 text-gray-400" />
                <input type="text" placeholder="랙 검색..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                  className="border rounded-lg px-3 py-2 text-sm w-full max-w-xs" />
              </div>
              
              {/* 범례 */}
              <div className="flex items-center gap-4 text-xs">
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-blue-500"></span> Maxwell 16</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-emerald-500"></span> Maxwell 48</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-orange-500"></span> HSM 3.0</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-gray-400"></span> 기타</span>
              </div>
              
              {/* v15: 공간 최적화 리포트 버튼 */}
              <button 
                onClick={() => setShowSpaceOptimizationModal(true)}
                className="flex items-center gap-1 px-3 py-1.5 bg-amber-500 text-white rounded-lg hover:bg-amber-600 text-sm"
              >
                <Lightbulb className="w-4 h-4" /> 최적화 리포트
              </button>
              
              {/* v15: 데이터 히스토리 버튼 */}
              <button 
                onClick={() => setShowHistoryModal(true)}
                className="flex items-center gap-1 px-3 py-1.5 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm"
              >
                <History className="w-4 h-4" /> 히스토리
              </button>
              
              <button 
                onClick={exportRackSummary}
                className="flex items-center gap-1 px-3 py-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
              >
                <Download className="w-4 h-4" /> 엑셀
              </button>
            </div>

            {/* 랙 상세 테이블 */}
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="px-5 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white flex justify-between items-center">
                <h3 className="text-lg font-bold">📦 랙 상세 현황</h3>
                <span className="text-xs bg-white/20 px-2 py-1 rounded">💡 랙을 클릭하면 Bin별 상세 현황을 볼 수 있어요</span>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50">
                    <tr>
                      <th className="px-4 py-3 text-left">랙 ID</th>
                      <th className="px-4 py-3 text-center">모델 시리즈</th>
                      <th className="px-4 py-3 text-center">품목 수</th>
                      <th className="px-4 py-3 text-center">재고 수량</th>
                      <th className="px-4 py-3 text-center">공간 사용률 (박스/Bin)</th>
                      <th className="px-4 py-3 text-center">무게 (현재/최대)</th>
                      <th className="px-4 py-3 text-center">무게 활용률</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {(() => {
                      const seriesOrder = { 'Maxwell 48': 0, 'Maxwell 16': 1, 'HSM 3.0': 2, 'Others': 3 };
                      const seriesNames = { 'Maxwell 48': 'Maxwell 48 (A1, A2, B1, B3, C3)', 'Maxwell 16': 'Maxwell 16 (A5, A6, A7, B2, C1)', 'HSM 3.0': 'HSM 3.0 (A3, B4, C2)', 'Others': '기타 (D2, E, E3, S1, F1)' };
                      const seriesColors = { 'Maxwell 48': 'emerald', 'Maxwell 16': 'blue', 'HSM 3.0': 'orange', 'Others': 'gray' };
                      
                      const sorted = rackSummary
                        .filter(r => {
                          if (selectedZone === 'all') return true;
                          const series = RACK_MODEL_SERIES[r.id];
                          if (selectedZone === 'Others') return !series;
                          return series === selectedZone;
                        })
                        .filter(r => !searchTerm || r.id.toLowerCase().includes(searchTerm.toLowerCase()))
                        .sort((a, b) => {
                          const aS = RACK_MODEL_SERIES[a.id] || 'Others';
                          const bS = RACK_MODEL_SERIES[b.id] || 'Others';
                          const aO = seriesOrder[aS] ?? 3;
                          const bO = seriesOrder[bS] ?? 3;
                          if (aO !== bO) return aO - bO;
                          return a.id.localeCompare(b.id);
                        });
                      
                      let lastSeries = null;
                      const rows = [];
                      
                      sorted.forEach(r => {
                        const series = RACK_MODEL_SERIES[r.id] || 'Others';
                        
                        // 시리즈 구분 헤더
                        if (series !== lastSeries) {
                          const sc = seriesColors[series] || 'gray';
                          // 첫 번째가 아니면 빈 행으로 간격 추가
                          if (lastSeries !== null) {
                            rows.push(
                              <tr key={`spacer-${series}`}><td colSpan="7" className="py-3"></td></tr>
                            );
                          }
                          rows.push(
                            <tr key={`header-${series}`} className={`bg-${sc}-50`}>
                              <td colSpan="7" className={`px-4 py-3 font-bold text-${sc}-700 text-lg border-b-2 border-${sc}-200`}>
                                {series === 'Maxwell 48' ? '🟢' : series === 'Maxwell 16' ? '🔵' : series === 'HSM 3.0' ? '🟠' : '⚪'} {seriesNames[series] || series}
                              </td>
                            </tr>
                          );
                          lastSeries = series;
                        }
                        
                        const seriesColor = series === 'Maxwell 16' ? 'blue' : series === 'Maxwell 48' ? 'emerald' : series === 'HSM 3.0' ? 'orange' : 'gray';
                        
                        // v16.1: 공간 사용률 계산 (BIN_RACK_INFO + BOXES_PER_SHELF 기반)
                        // 특수 영역 (D2, E, F1, LABEL): 랙 스펙 없으므로 사용률 N/A
                        const SPECIAL_AREAS = ['D2', 'E', 'F1', 'LABEL'];
                        const isSpecialArea = SPECIAL_AREAS.includes(r.id);
                        
                        // 해당 영역의 모든 Material 가져오기
                        const areaItems = inventoryData.filter(item => {
                          const bin = item.bin || '';
                          return bin.startsWith(r.id + '-') || bin === r.id;
                        });
                        
                        let totalCurrentBoxes = 0;
                        let totalMaxBoxes = 0;
                        let stockUtil = 0;
                        
                        if (!isSpecialArea) {
                          // Bin별로 그룹화
                          const binGroups = {};
                          areaItems.forEach(item => {
                            const bin = item.bin || r.id;
                            if (!binGroups[bin]) binGroups[bin] = [];
                            binGroups[bin].push(item);
                          });
                          
                          // 각 Bin별 현재 박스 수 & 최대 수용량 계산
                          Object.entries(binGroups).forEach(([bin, items]) => {
                            // 이 Bin의 현재 박스 수
                            let binCurrentBoxes = 0;
                            items.forEach(item => {
                              const qtyPerBox = MATERIAL_QTY_PER_BOX[item.material] || 1;
                              binCurrentBoxes += (item.stock || 0) / qtyPerBox;
                            });
                            totalCurrentBoxes += binCurrentBoxes;
                            
                            // 이 Bin의 최대 수용량 (BIN_RACK_INFO 사용)
                            // Bin = 1개 선반(1단), rackCount = 공유 랙 수
                            // 최대 박스 = 1랙 1선반 박스 수 × rackCount
                            const binInfo = BIN_RACK_INFO[bin] || { rackType: '경량랙', rackCount: 1 };
                            // 해당 Bin의 Material들이 사용하는 박스 타입 중 가장 많은 것 사용
                            const binBoxTypes = items.map(item => MATERIAL_BOX_MAP[item.material] || 'PLASTIC-S');
                            const typeCount = {};
                            binBoxTypes.forEach(t => { typeCount[t] = (typeCount[t] || 0) + 1; });
                            const mainBoxType = Object.entries(typeCount).sort((a, b) => b[1] - a[1])[0]?.[0] || 'PLASTIC-S';
                            
                            let binMaxBoxes = 0;
                            if (binInfo.maxBoxes) {
                              // 직접 지정된 최대 박스 수 (B3 등 1단 랙)
                              binMaxBoxes = binInfo.maxBoxes;
                            } else if (binInfo.mixed) {
                              // 혼합 랙 (예: A3 = 중량랙1 + 경량랙2)
                              binInfo.mixed.forEach(m => {
                                const shelfByType = BOXES_PER_SHELF[m.type] || BOXES_PER_SHELF['경량랙'];
                                const perShelf = shelfByType[mainBoxType] || shelfByType['PLASTIC-S'] || 12;
                                binMaxBoxes += perShelf * m.count;
                              });
                            } else {
                              // 단일 랙 타입
                              const shelfByType = BOXES_PER_SHELF[binInfo.rackType] || BOXES_PER_SHELF['경량랙'];
                              const perShelf = shelfByType[mainBoxType] || shelfByType['PLASTIC-S'] || 12;
                              const shelvesPerRack = binInfo.shelves || 1;
                              binMaxBoxes = perShelf * binInfo.rackCount * shelvesPerRack;
                            }
                            totalMaxBoxes += binMaxBoxes;
                          });
                          
                          stockUtil = totalMaxBoxes > 0 ? (totalCurrentBoxes / totalMaxBoxes) * 100 : 0;
                        } else {
                          // 특수 영역: 박스 수만 계산 (최대 용량 N/A)
                          areaItems.forEach(item => {
                            const qtyPerBox = MATERIAL_QTY_PER_BOX[item.material] || 1;
                            totalCurrentBoxes += (item.stock || 0) / qtyPerBox;
                          });
                        }
                        
                        // 무게 활용률 계산
                        const weightUtil = (r.weight / r.maxWeight) * 100;
                        const isUnlimitedWeight = r.maxWeight >= 99999;
                        
                        const row = (
                          <tr key={r.id} className={`hover:bg-slate-50 border-l-4 border-${seriesColor}-500 cursor-pointer`}
                            onClick={() => setSelectedRackDetail(r)}>
                            <td className="px-4 py-3 font-bold text-lg">{r.id}</td>
                            <td className="px-4 py-3 text-center">
                              <span className={`px-2 py-1 rounded text-xs bg-${seriesColor}-100 text-${seriesColor}-700`}>
                                {series === 'Others' ? '기타' : series}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-center">{r.items}</td>
                            <td className="px-4 py-3 text-center font-medium">{r.stock.toLocaleString()} EA</td>
                            <td className="px-4 py-3">
                              {isSpecialArea ? (
                                <div className="flex items-center gap-2">
                                  <span className="text-xs text-gray-400">{totalCurrentBoxes.toFixed(1)} 박스 (랙 미지정)</span>
                                </div>
                              ) : (
                              <div className="flex items-center gap-2">
                                <div className="flex-1 bg-gray-200 rounded-full h-2 w-16">
                                  <div className={`h-2 rounded-full ${stockUtil > 100 ? 'bg-red-500' : stockUtil >= 80 ? 'bg-amber-500' : stockUtil >= 50 ? 'bg-emerald-500' : 'bg-blue-500'}`}
                                    style={{ width: `${Math.min(stockUtil, 100)}%` }} />
                                </div>
                                <span className={`text-xs w-24 ${stockUtil > 100 ? 'text-red-600 font-bold' : stockUtil >= 80 ? 'text-amber-600' : stockUtil >= 50 ? 'text-emerald-600' : 'text-blue-600'}`}>
                                  {totalCurrentBoxes.toFixed(1)}/{totalMaxBoxes} ({stockUtil.toFixed(0)}%)
                                </span>
                              </div>
                              )}
                            </td>
                            <td className="px-4 py-3 text-center text-sm">
                              {isUnlimitedWeight ? (
                                <span>{r.weight.toFixed(1)} kg</span>
                              ) : (
                                <span>{r.weight.toFixed(1)} / {r.maxWeight} kg</span>
                              )}
                            </td>
                            <td className="px-4 py-3">
                              {isUnlimitedWeight ? (
                                <span className="text-xs text-gray-400">무제한</span>
                              ) : (
                                <div className="flex items-center gap-2">
                                  <div className="flex-1 bg-gray-200 rounded-full h-2 w-16">
                                    <div className={`h-2 rounded-full ${weightUtil >= 90 ? 'bg-red-500' : weightUtil >= 70 ? 'bg-amber-500' : 'bg-emerald-500'}`}
                                      style={{ width: `${Math.min(weightUtil, 100)}%` }} />
                                  </div>
                                  <span className={`text-xs w-12 ${weightUtil >= 90 ? 'text-red-600' : weightUtil >= 70 ? 'text-amber-600' : 'text-emerald-600'}`}>
                                    {weightUtil.toFixed(0)}%
                                  </span>
                                </div>
                              )}
                            </td>
                          </tr>
                        );
                        rows.push(row);
                      });
                      return rows;
                    })()}
                  </tbody>
                </table>
              </div>
            </div>


{/* ========== v16.0: 랙 스펙 기반 분석 ========== */}
            <div className="bg-gradient-to-r from-slate-700 to-slate-800 rounded-xl shadow-lg p-6 text-white">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold flex items-center gap-2">
                  📐 v16.0 랙 스펙 분석
                  <span className="text-xs bg-amber-500 px-2 py-0.5 rounded">NEW</span>
                </h3>
                <div className="text-xs text-slate-300">
                  물리적 랙 {Object.values(RACK_SPEC).flat().length}개 | 박스 타입 {Object.keys(BOX_TYPES).length}종
                </div>
              </div>
              
              {/* 랙 타입별 요약 */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                {(() => {
                  const allRacks = Object.values(RACK_SPEC).flat();
                  const heavyRacks = allRacks.filter(r => r.type === '중량랙');
                  const lightRacks = allRacks.filter(r => r.type === '경량랙');
                  const totalCapacity = allRacks.reduce((sum, r) => sum + (r.maxWeight * r.levels), 0);
                  const totalVolume = allRacks.reduce((sum, r) => sum + (r.width * r.depth * r.height / 1000000), 0);
                  
                  return (
                    <>
                      <div className="bg-white/10 rounded-lg p-3">
                        <p className="text-xs text-slate-300">중량랙</p>
                        <p className="text-xl font-bold">{heavyRacks.length}개</p>
                        <p className="text-xs text-slate-400">최대 {heavyRacks.reduce((s, r) => s + r.maxWeight * r.levels, 0).toLocaleString()}kg</p>
                      </div>
                      <div className="bg-white/10 rounded-lg p-3">
                        <p className="text-xs text-slate-300">경량랙</p>
                        <p className="text-xl font-bold">{lightRacks.length}개</p>
                        <p className="text-xs text-slate-400">최대 {lightRacks.reduce((s, r) => s + r.maxWeight * r.levels, 0).toLocaleString()}kg</p>
                      </div>
                      <div className="bg-white/10 rounded-lg p-3">
                        <p className="text-xs text-slate-300">총 적재용량</p>
                        <p className="text-xl font-bold">{totalCapacity.toLocaleString()}kg</p>
                        <p className="text-xs text-slate-400">현재 {totals.weight.toFixed(0)}kg ({(totals.weight / totalCapacity * 100).toFixed(1)}%)</p>
                      </div>
                      <div className="bg-white/10 rounded-lg p-3">
                        <p className="text-xs text-slate-300">총 부피</p>
                        <p className="text-xl font-bold">{totalVolume.toFixed(1)}m³</p>
                        <p className="text-xs text-slate-400">{allRacks.length}개 랙 합계</p>
                      </div>
                    </>
                  );
                })()}
              </div>
              
              {/* 박스 타입별 현황 - 실제 박스 개수로 계산 */}
              <div className="bg-white/5 rounded-lg p-4">
                <p className="text-sm font-medium mb-3">📦 박스 타입별 사용 현황 <span className="text-xs text-slate-400">(재고 ÷ Qty/Box = 박스 수)</span></p>
                <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
                  {['PLASTIC-XL', 'PLASTIC-M', 'PLASTIC-S', 'PCB BOX-L', 'PCB BOX-M', 'PAPER-L'].map(code => {
                    const box = BOX_TYPES[code] || { name: code, width: 0, depth: 0 };
                    // 해당 박스 타입을 사용하는 Material의 실제 박스 개수 합계
                    const boxCount = inventoryData.reduce((sum, item) => {
                      const matBox = MATERIAL_BOX_MAP[item.material];
                      if (matBox === code) {
                        const qtyPerBox = MATERIAL_QTY_PER_BOX[item.material] || 1;
                        const stock = item.stock || 0;
                        return sum + Math.ceil(stock / qtyPerBox);
                      }
                      return sum;
                    }, 0);
                    return (
                      <div key={code} className="bg-white/10 rounded p-2 text-center">
                        <p className="text-xs truncate">{box.name || code}</p>
                        <p className="text-lg font-bold">{boxCount}</p>
                        <p className="text-xs text-slate-400">
                          {box.width > 0 ? `${box.width}×${box.depth}` : '가변'}
                        </p>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

            
{/* ========== 랙별 현황 (기존 rack 탭 내용) ========== */}
            
            {/* Bin 100% 알림 배너 */}
            {fullBins.length > 0 && (
              <div className="bg-gradient-to-r from-red-500 to-pink-500 rounded-xl shadow-lg p-4 text-white">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-3xl">📦</span>
                    <div>
                      <h3 className="font-bold text-lg">Bin 용량 경고!</h3>
                      <p className="text-sm opacity-90">
                        {fullBins.length}개 Bin이 100% 가득 찼습니다. 재배치가 필요합니다.
                      </p>
                    </div>
                  </div>
                </div>
                <div className="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2">
                  {fullBins.slice(0, 8).map((item, idx) => (
                    <div key={idx} className="bg-white/20 rounded px-3 py-2 text-sm flex items-center justify-between">
                      <span className="font-medium">{item.rack} - {item.bin}</span>
                      <span className="bg-white/30 px-2 py-0.5 rounded text-xs">{item.count}개 품목</span>
                    </div>
                  ))}
                </div>
                {fullBins.length > 8 && (
                  <p className="mt-2 text-sm opacity-75">+{fullBins.length - 8}개 더 있음</p>
                )}
              </div>
            )}


            {/* ========== BOM 기준 재고 분석 ========== */}

            {/* 모델 시리즈별 요약 카드 - 접기/펼치기 */}
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <button 
                onClick={() => setShowSeriesCards(!showSeriesCards)}
                className="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition"
              >
                <h3 className="font-semibold flex items-center gap-2">
                  📊 모델 시리즈별 요약
                </h3>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-500">{showSeriesCards ? '접기' : '펼치기'}</span>
                  {showSeriesCards ? <ChevronUp className="w-5 h-5 text-gray-400" /> : <ChevronDown className="w-5 h-5 text-gray-400" />}
                </div>
              </button>
              {showSeriesCards && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
              {[
                { name: 'Maxwell 48', desc: 'RSC48 / CSC48', color: 'emerald', racks: ['A1', 'A2', 'B1', 'B3', 'C3'] },
                { name: 'Maxwell 16', desc: 'RSC16 / CSC16 / FSC16', color: 'blue', racks: ['A5', 'A6', 'A7', 'B2', 'C1'] },
                { name: 'HSM 3.0', desc: 'HSM 3.0', color: 'orange', racks: ['A3', 'B4', 'C2'] },
                { name: '기타 구역', desc: 'D2, E, E3, S1, F1', color: 'gray', racks: ['D2', 'E', 'E3', 'S1', 'F1'] },
              ].map(series => {
                const seriesRacks = rackSummary.filter(r => series.racks.includes(r.id));
                const totalItems = seriesRacks.reduce((s, r) => s + r.items, 0);
                const totalStock = seriesRacks.reduce((s, r) => s + r.stock, 0);
                const totalWeight = seriesRacks.reduce((s, r) => s + r.weight, 0);
                
                // 공간 사용률 계산
                const SPECIAL_AREAS = ['D2', 'E', 'F1', 'LABEL'];
                let seriesCurBoxes = 0, seriesMaxBoxes = 0;
                seriesRacks.forEach(rack => {
                  if (SPECIAL_AREAS.includes(rack.id)) return;
                  const areaItems = inventoryData.filter(item => {
                    const bin = item.bin || '';
                    return bin.startsWith(rack.id + '-') || bin === rack.id;
                  });
                  const binGroups = {};
                  areaItems.forEach(item => {
                    const bin = item.bin || rack.id;
                    if (!binGroups[bin]) binGroups[bin] = [];
                    binGroups[bin].push(item);
                  });
                  Object.entries(binGroups).forEach(([bin, items]) => {
                    items.forEach(item => {
                      const qtyPerBox = MATERIAL_QTY_PER_BOX[item.material] || 1;
                      seriesCurBoxes += (item.stock || 0) / qtyPerBox;
                    });
                    const binInfo = BIN_RACK_INFO[bin] || { rackType: '경량랙', rackCount: 1 };
                    const binBoxTypes = items.map(i => MATERIAL_BOX_MAP[i.material] || 'PLASTIC-S');
                    const tc = {};
                    binBoxTypes.forEach(t => { tc[t] = (tc[t] || 0) + 1; });
                    const mainBT = Object.entries(tc).sort((a, b) => b[1] - a[1])[0]?.[0] || 'PLASTIC-S';
                    if (binInfo.maxBoxes) {
                      seriesMaxBoxes += binInfo.maxBoxes;
                    } else if (binInfo.mixed) {
                      binInfo.mixed.forEach(m => {
                        const s = BOXES_PER_SHELF[m.type] || BOXES_PER_SHELF['경량랙'];
                        seriesMaxBoxes += (s[mainBT] || s['PLASTIC-S'] || 2) * m.count;
                      });
                    } else {
                      const s = BOXES_PER_SHELF[binInfo.rackType] || BOXES_PER_SHELF['경량랙'];
                      seriesMaxBoxes += (s[mainBT] || s['PLASTIC-S'] || 2) * binInfo.rackCount * (binInfo.shelves || 1);
                    }
                  });
                });
                const seriesSpaceUtil = seriesMaxBoxes > 0 ? Math.round((seriesCurBoxes / seriesMaxBoxes) * 100) : 0;
                
                return (
                  <div key={series.name} className={`bg-white rounded-xl shadow-sm p-5 border-l-4 border-${series.color}-500`}>
                    <h3 className={`text-lg font-bold text-${series.color}-600 mb-3`}>{series.name}</h3>
                    <div className="grid grid-cols-2 gap-y-2 text-sm">
                      <div className="text-gray-500">랙:</div>
                      <div className="text-right font-medium">{series.racks.join(', ')}</div>
                      <div className="text-gray-500">품목:</div>
                      <div className="text-right font-medium">{totalItems}개</div>
                      <div className="text-gray-500">재고:</div>
                      <div className="text-right font-medium">{totalStock.toLocaleString()} EA</div>
                      <div className="text-gray-500">무게:</div>
                      <div className="text-right font-medium">{totalWeight.toFixed(1)} kg</div>
                      <div className="text-gray-500">공간 사용률:</div>
                      <div className="text-right">
                        <span className={`font-bold ${seriesSpaceUtil > 80 ? 'text-red-600' : seriesSpaceUtil > 50 ? 'text-amber-600' : 'text-emerald-600'}`}>
                          {seriesSpaceUtil}%
                        </span>
                        <span className="text-xs text-gray-400 ml-1">({seriesCurBoxes.toFixed(0)}/{seriesMaxBoxes}박스)</span>
                      </div>
                    </div>
                    <div className="mt-2 bg-gray-200 rounded-full h-2">
                      <div className={`h-2 rounded-full ${seriesSpaceUtil > 80 ? 'bg-red-500' : seriesSpaceUtil > 50 ? 'bg-amber-500' : 'bg-emerald-500'}`}
                        style={{ width: `${Math.min(seriesSpaceUtil, 100)}%` }} />
                    </div>
                  </div>
                );
              })}
            </div>
              )}
            </div>

            
            {/* 상세 정보 섹션 - 접기/펼치기 */}
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <button 
                onClick={() => setShowDetailSection(!showDetailSection)}
                className="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition"
              >
                <h3 className="font-semibold flex items-center gap-2">
                  🏗️ 영역별 물리적 랙 현황
                </h3>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-500">{showDetailSection ? '접기' : '펼치기'}</span>
                  {showDetailSection ? <ChevronUp className="w-5 h-5 text-gray-400" /> : <ChevronDown className="w-5 h-5 text-gray-400" />}
                </div>
              </button>
              {showDetailSection && (
              <div className="p-4 space-y-6">
{/* v16.0: 영역별 물리적 랙 현황 */}
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white flex justify-between items-center">
                <h3 className="font-bold flex items-center gap-2">
                  🏗️ 영역별 물리적 랙 현황
                </h3>
                <span className="text-xs bg-white/20 px-2 py-1 rounded">클릭하여 상세 보기</span>
              </div>
              <div className="p-4">
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                  {Object.entries(RACK_SPEC).map(([area, racks]) => {
                    const areaItems = inventoryData.filter(item => {
                      const bin = item.bin || '';
                      return bin.startsWith(area + '-') || bin === area;
                    });
                    // 무게 계산: weightData에서 Material별 무게(kg) 가져와서 재고 곱하기
                    const areaWeight = areaItems.reduce((sum, item) => {
                      const materialWeight = weightData[item.material]?.w || 0; // kg 단위
                      return sum + (materialWeight * (item.stock || 0));
                    }, 0);
                    const maxWeight = racks.reduce((sum, r) => sum + (r.maxWeight * r.levels), 0);
                    const weightUtil = maxWeight > 0 ? (areaWeight / maxWeight) * 100 : 0;
                    const heavyCount = racks.filter(r => r.type === '중량랙').length;
                    const lightCount = racks.filter(r => r.type === '경량랙').length;
                    
                    return (
                      <div 
                        key={area} 
                        className={`border rounded-lg p-3 cursor-pointer hover:shadow-md transition ${
                          weightUtil >= 90 ? 'border-red-300 bg-red-50' :
                          weightUtil >= 70 ? 'border-amber-300 bg-amber-50' :
                          'border-gray-200 hover:border-indigo-300'
                        }`}
                        onClick={() => {
                          const rackData = rackSummary.find(r => r.id === area);
                          if (rackData) setSelectedRackDetail(rackData);
                        }}
                      >
                        <div className="flex justify-between items-start mb-2">
                          <span className="font-bold text-lg">{area}</span>
                          <span className={`text-xs px-1.5 py-0.5 rounded ${
                            weightUtil >= 90 ? 'bg-red-100 text-red-700' :
                            weightUtil >= 70 ? 'bg-amber-100 text-amber-700' :
                            'bg-emerald-100 text-emerald-700'
                          }`}>
                            {weightUtil.toFixed(0)}%
                          </span>
                        </div>
                        <div className="text-xs text-gray-500 space-y-1">
                          <div className="flex justify-between">
                            <span>랙:</span>
                            <span>{racks.length}개 {heavyCount > 0 && `(중${heavyCount})`} {lightCount > 0 && `(경${lightCount})`}</span>
                          </div>
                          <div className="flex justify-between">
                            <span>품목:</span>
                            <span>{areaItems.length}개</span>
                          </div>
                          <div className="flex justify-between">
                            <span>무게:</span>
                            <span>{areaWeight.toFixed(1)} / {maxWeight}kg</span>
                          </div>
                        </div>
                        {/* 하중 바 */}
                        <div className="mt-2 bg-gray-200 rounded-full h-1.5">
                          <div 
                            className={`h-1.5 rounded-full ${
                              weightUtil >= 90 ? 'bg-red-500' :
                              weightUtil >= 70 ? 'bg-amber-500' :
                              'bg-emerald-500'
                            }`}
                            style={{ width: `${Math.min(weightUtil, 100)}%` }}
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
              </div>
              )}
            </div>


            
            {/* Bin별 과적 현황 (D2, Label, E3 제외) - 토글 방식 */}
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <button 
                onClick={() => setBinOverloadExpanded(!binOverloadExpanded)}
                className="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition"
              >
                <h3 className="font-semibold flex items-center gap-2">
                  <AlertTriangle className="w-5 h-5 text-orange-500" />
                  Bin별 과적 현황 (D2, Label, E3 제외)
                  {(() => {
                    const BIN_CAPACITY = 500;
                    const EXCLUDED_BINS = ['D2', 'Label', 'E3', 'd2', 'label', 'LABEL', 'e3'];
                    const count = inventoryData.reduce((acc, item) => {
                      if (EXCLUDED_BINS.some(ex => ex.toLowerCase() === (item.bin || '').toLowerCase())) return acc;
                      if (!acc[item.bin]) acc[item.bin] = 0;
                      acc[item.bin] += item.stock || 0;
                      return acc;
                    }, {});
                    const overCount = Object.values(count).filter(v => v > BIN_CAPACITY).length;
                    return overCount > 0 ? (
                      <span className="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded ml-2">
                        {overCount}개 과적
                      </span>
                    ) : null;
                  })()}
                </h3>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-500">{binOverloadExpanded ? '접기' : '펼치기'}</span>
                  {binOverloadExpanded ? <ChevronUp className="w-5 h-5 text-gray-400" /> : <ChevronDown className="w-5 h-5 text-gray-400" />}
                </div>
              </button>
              
              {binOverloadExpanded && (
                <div className="px-6 pb-6 border-t">
                  <div className="flex items-center justify-between mt-4 mb-4">
                    <p className="text-sm text-gray-500">Bin당 적정 수량 500 EA 기준 (임시) | 클릭하면 품목 상세 확인</p>
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-gray-500">정렬:</span>
                      <select 
                        className="border rounded px-2 py-1 text-sm"
                        value={spaceAnalysisSortBy}
                        onChange={e => setSpaceAnalysisSortBy(e.target.value)}
                      >
                        <option value="urgency">긴급도순 (초과량)</option>
                        <option value="alphabet">알파벳순 (Bin)</option>
                      </select>
                    </div>
                  </div>
              
                  {(() => {
                    const BIN_CAPACITY = 500;
                    // 대소문자 구분 없이 제외
                    const EXCLUDED_BINS = ['D2', 'Label', 'E3', 'd2', 'label', 'LABEL', 'e3'];
                    
                    const binStockMap = {};
                    inventoryData.forEach(item => {
                      // 제외 Bin 필터링 (대소문자 무시)
                      if (EXCLUDED_BINS.some(ex => ex.toLowerCase() === (item.bin || '').toLowerCase())) return;
                      
                      // 랙 추출 (C1-04 → C1)
                      const rack = item.bin?.split('-')[0] || item.bin || '';
                      
                      if (!binStockMap[item.bin]) {
                        binStockMap[item.bin] = { stock: 0, items: [], rack: rack, area: rack };
                      }
                      binStockMap[item.bin].stock += item.stock || 0;
                      binStockMap[item.bin].items.push(item);
                    });
                    
                    let overloadedBins = Object.entries(binStockMap)
                      .filter(([_, data]) => data.stock > BIN_CAPACITY);
                    
                    // 정렬
                if (spaceAnalysisSortBy === 'alphabet') {
                  overloadedBins = overloadedBins.sort((a, b) => a[0].localeCompare(b[0]));
                } else {
                  overloadedBins = overloadedBins.sort((a, b) => b[1].stock - a[1].stock);
                }
                
                // 같은 랙 내 여유 Bin 찾기 (C1→C1, C2→C2)
                const spareBinsByRack = {};
                Object.entries(binStockMap).forEach(([bin, data]) => {
                  if (data.stock < BIN_CAPACITY * 0.5) {
                    const rack = data.rack;
                    if (!spareBinsByRack[rack]) spareBinsByRack[rack] = [];
                    spareBinsByRack[rack].push({ bin, ...data, spare: BIN_CAPACITY - data.stock });
                  }
                });
                
                if (overloadedBins.length === 0) {
                  return <p className="text-center text-gray-500 py-8">✅ 과적된 Bin이 없습니다!</p>;
                }
                
                return (
                  <div className="space-y-3 max-h-[400px] overflow-y-auto">
                    {overloadedBins.slice(0, 10).map(([bin, data]) => {
                      const overAmount = data.stock - BIN_CAPACITY;
                      const rack = data.rack;
                      const urgencyPercent = ((data.stock / BIN_CAPACITY) * 100).toFixed(0);
                      // 같은 랙 내에서만 여유 Bin 추천
                      const sameRackSpare = (spareBinsByRack[rack] || [])
                        .filter(s => s.bin !== bin)
                        .sort((a, b) => b.spare - a.spare)
                        .slice(0, 3);
                      
                      return (
                        <div 
                          key={bin} 
                          className="border border-orange-200 rounded-lg p-3 bg-orange-50 cursor-pointer hover:bg-orange-100 transition"
                          onClick={() => setBinDetailModal({ bin, data, BIN_CAPACITY })}
                        >
                          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <span className="font-bold text-orange-700">{bin}</span>
                                <span className={`px-2 py-0.5 text-xs rounded ${
                                  urgencyPercent > 200 ? 'bg-red-500 text-white' :
                                  urgencyPercent > 150 ? 'bg-orange-400 text-white' :
                                  'bg-orange-200 text-orange-800'
                                }`}>
                                  {urgencyPercent}%
                                </span>
                              </div>
                              <p className="text-sm text-gray-700">
                                {data.stock.toLocaleString()} EA <span className="text-orange-500">(+{overAmount.toLocaleString()} 초과)</span>
                              </p>
                            </div>
                            
                            <div className="flex-1">
                              <p className="text-xs font-medium text-gray-600 mb-1">📍 {rack} Area 이동 추천</p>
                              {sameRackSpare.length > 0 ? (
                                <div className="flex flex-wrap gap-1">
                                  {sameRackSpare.map((s, idx) => (
                                    <span key={s.bin} className={`px-2 py-0.5 rounded text-xs ${idx === 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'}`}>
                                      {s.bin}
                                    </span>
                                  ))}
                                </div>
                              ) : (
                                <p className="text-xs text-amber-600">여유 Bin 없음</p>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                    {overloadedBins.length > 10 && (
                      <p className="text-center text-gray-500 text-sm">외 {overloadedBins.length - 10}개 Bin</p>
                    )}
                  </div>
                );
              })()}
                </div>
              )}
            </div>

          </div>
        )}

        {/* Inventory List */}
        {activeTab === 'inventory' && inventoryData.length > 0 && (
          <div className="space-y-4">
            {/* 검색/필터 - 모바일 최적화 */}
            <div className="bg-white rounded-xl shadow-sm p-4">
              <div className="flex flex-col sm:flex-row gap-3">
                <div className="flex items-center gap-2 flex-1">
                  <Search className="w-4 h-4 text-gray-400" />
                  <input type="text" placeholder="품번/품명 검색..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                    className="border rounded-lg px-3 py-2 text-sm w-full" />
                </div>
                <div className="flex items-center gap-2">
                  <select 
                    value={inventorySortBy} 
                    onChange={e => setInventorySortBy(e.target.value)}
                    className="border rounded-lg px-3 py-2 text-sm flex-1"
                  >
                    <option value="bin">Bin순</option>
                    <option value="material">품번순</option>
                    <option value="stock">재고순</option>
                  </select>
                  <button 
                    onClick={() => setInventorySortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                    className="border rounded-lg px-3 py-2 text-sm"
                  >
                    {inventorySortOrder === 'asc' ? '↑' : '↓'}
                  </button>
                  <button 
                    onClick={exportInventory}
                    className="p-2 bg-emerald-600 text-white rounded-lg"
                  >
                    <Download className="w-4 h-4" />
                  </button>
                </div>
              </div>
              <p className="text-xs text-gray-500 mt-2">총 {inventoryData.length}개</p>
            </div>

            {/* PC: 테이블 뷰 */}
            <div className="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="overflow-x-auto max-h-[600px]">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50 sticky top-0">
                    <tr>
                      <th className="px-4 py-3 text-left cursor-pointer hover:bg-slate-100" onClick={() => { setInventorySortBy('material'); setInventorySortOrder(prev => inventorySortBy === 'material' ? (prev === 'asc' ? 'desc' : 'asc') : 'asc'); }}>
                        품번 {inventorySortBy === 'material' && (inventorySortOrder === 'asc' ? '↑' : '↓')}
                      </th>
                      <th className="px-4 py-3 text-left">품명</th>
                      <th className="px-4 py-3 text-center cursor-pointer hover:bg-slate-100" onClick={() => { setInventorySortBy('bin'); setInventorySortOrder(prev => inventorySortBy === 'bin' ? (prev === 'asc' ? 'desc' : 'asc') : 'asc'); }}>
                        Bin {inventorySortBy === 'bin' && (inventorySortOrder === 'asc' ? '↑' : '↓')}
                      </th>
                      <th className="px-4 py-3 text-center">랙</th>
                      <th className="px-4 py-3 text-center cursor-pointer hover:bg-slate-100" onClick={() => { setInventorySortBy('stock'); setInventorySortOrder(prev => inventorySortBy === 'stock' ? (prev === 'asc' ? 'desc' : 'asc') : 'asc'); }}>
                        재고 {inventorySortBy === 'stock' && (inventorySortOrder === 'asc' ? '↑' : '↓')}
                      </th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {inventoryData
                      .filter(i => !searchTerm || 
                        i.material.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        i.description.toLowerCase().includes(searchTerm.toLowerCase()))
                      .sort((a, b) => {
                        let aVal, bVal;
                        switch(inventorySortBy) {
                          case 'bin': aVal = a.bin || ''; bVal = b.bin || ''; break;
                          case 'material': aVal = a.material || ''; bVal = b.material || ''; break;
                          case 'stock': aVal = a.stock || 0; bVal = b.stock || 0; break;
                          default: aVal = a.bin || ''; bVal = b.bin || '';
                        }
                        if (typeof aVal === 'number') {
                          return inventorySortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                        }
                        return inventorySortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                      })
                      .slice(0, 500)
                      .map((item, idx) => (
                        <tr key={idx} className="hover:bg-slate-50">
                          <td className="px-4 py-2 font-mono text-xs">{item.material}</td>
                          <td className="px-4 py-2 text-sm">{item.description?.slice(0, 40)}</td>
                          <td className="px-4 py-2 text-center">
                            <span className="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs">{item.bin}</span>
                          </td>
                          <td className="px-4 py-2 text-center text-xs">{getRackId(item.bin)}</td>
                          <td className="px-4 py-2 text-center font-medium">{item.stock?.toLocaleString()}</td>
                        </tr>
                      ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* 모바일: 카드 뷰 */}
            <div className="md:hidden space-y-3">
              {inventoryData
                .filter(i => !searchTerm || 
                  i.material.toLowerCase().includes(searchTerm.toLowerCase()) ||
                  i.description.toLowerCase().includes(searchTerm.toLowerCase()))
                .sort((a, b) => {
                  let aVal, bVal;
                  switch(inventorySortBy) {
                    case 'bin': aVal = a.bin || ''; bVal = b.bin || ''; break;
                    case 'material': aVal = a.material || ''; bVal = b.material || ''; break;
                    case 'stock': aVal = a.stock || 0; bVal = b.stock || 0; break;
                    default: aVal = a.bin || ''; bVal = b.bin || '';
                  }
                  if (typeof aVal === 'number') {
                    return inventorySortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                  }
                  return inventorySortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                })
                .slice(0, 100)
                .map((item, idx) => (
                  <div key={idx} className="bg-white rounded-xl shadow-sm p-4">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <p className="font-mono text-sm font-medium">{item.material}</p>
                        <p className="text-xs text-gray-500">{item.description?.slice(0, 30)}</p>
                      </div>
                      <span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-medium">{item.bin}</span>
                    </div>
                    <div className="flex justify-between items-center pt-2 border-t">
                      <span className="text-xs text-gray-500">랙 {getRackId(item.bin)}</span>
                      <span className="text-lg font-bold text-indigo-600">{item.stock?.toLocaleString()} {item.unit}</span>
                    </div>
                  </div>
                ))}
              {inventoryData.length > 100 && (
                <p className="text-center text-sm text-gray-500 py-4">100개까지 표시 (전체 {inventoryData.length}개)</p>
              )}
            </div>
          </div>
        )}

        {/* Pick Cycle Time */}
        {activeTab === 'pick' && (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <h2 className="text-lg font-semibold">자재 불출 Cycle Time</h2>
                {/* 월별 선택 */}
                <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                  <button 
                    onClick={() => {
                      const d = new Date(pickFilterMonth + '-01');
                      d.setMonth(d.getMonth() - 1);
                      setPickFilterMonth(d.toISOString().slice(0, 7));
                    }}
                    className="p-1 hover:bg-white rounded"
                  >
                    <ChevronLeft className="w-4 h-4" />
                  </button>
                  <span className="px-2 font-medium text-indigo-600">
                    {pickFilterMonth.split('-')[0]}년 {parseInt(pickFilterMonth.split('-')[1])}월
                  </span>
                  <button 
                    onClick={() => {
                      const d = new Date(pickFilterMonth + '-01');
                      d.setMonth(d.getMonth() + 1);
                      setPickFilterMonth(d.toISOString().slice(0, 7));
                    }}
                    className="p-1 hover:bg-white rounded"
                  >
                    <ChevronRight className="w-4 h-4" />
                  </button>
                </div>
                {pickFilterMonth !== new Date().toISOString().slice(0, 7) && (
                  <button 
                    onClick={() => setPickFilterMonth(new Date().toISOString().slice(0, 7))}
                    className="text-xs text-indigo-600 hover:underline"
                  >
                    이번 달로
                  </button>
                )}
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowGraphModal(true)} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                  <BarChart3 className="w-4 h-4" /> 📊 그래프
                </button>
                <label className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 cursor-pointer">
                  <Upload className="w-4 h-4" /> Order CSV 업로드
                  <input type="file" accept=".csv" onChange={handleOrderCsvUpload} className="hidden" />
                </label>
                <button onClick={() => downloadCycleExcel('pick')} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                  <Download className="w-4 h-4" /> 엑셀 다운로드
                </button>
                <button onClick={() => setShowPickModal(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                  <Plus className="w-4 h-4" /> 새 기록
                </button>
              </div>
            </div>

            {/* 불출 통계 카드 */}
            <div className="grid grid-cols-5 gap-4">
              {(() => {
                const monthPicks = pickCycles.filter(p => 
                  p.completed?.startsWith(pickFilterMonth) || p.basicStartDate?.startsWith(pickFilterMonth)
                );
                const completedPicks = monthPicks.filter(p => p.status === 'completed');
                const pendingPicks = monthPicks.filter(p => p.status !== 'completed');
                
                // Maxwell 48
                const mx48Picks = monthPicks.filter(p => ['RSC48', 'CSC48'].includes(p.model) && p.cycleMin && p.status === 'completed');
                const mx48Avg = mx48Picks.length ? Math.round(mx48Picks.reduce((s, p) => s + p.cycleMin, 0) / mx48Picks.length) : 0;
                
                // Maxwell 16
                const mx16Picks = monthPicks.filter(p => ['RSC16', 'CSC16', 'FSC16'].includes(p.model) && p.cycleMin && p.status === 'completed');
                const mx16Avg = mx16Picks.length ? Math.round(mx16Picks.reduce((s, p) => s + p.cycleMin, 0) / mx16Picks.length) : 0;
                
                // HSM 3.0
                const hsmPicks = monthPicks.filter(p => p.model === 'HSM3.0' && p.cycleMin && p.status === 'completed');
                const hsmAvg = hsmPicks.length ? Math.round(hsmPicks.reduce((s, p) => s + p.cycleMin, 0) / hsmPicks.length) : 0;
                
                // Spare Parts
                const sparePicks = monthPicks.filter(p => p.model === 'Spare Parts' && p.cycleMin && p.status === 'completed');
                const spareAvg = sparePicks.length ? Math.round(sparePicks.reduce((s, p) => s + p.cycleMin, 0) / sparePicks.length) : 0;
                
                return (
                  <>
                    <div className="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl p-4 text-white">
                      <div className="text-indigo-200 text-sm">{parseInt(pickFilterMonth.split('-')[1])}월 불출 완료</div>
                      <div className="text-3xl font-bold">{completedPicks.length}<span className="text-lg ml-1">건</span></div>
                      <div className="text-indigo-200 text-xs">대기 {pendingPicks.length}건</div>
                    </div>
                    <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-4 text-white">
                      <div className="text-emerald-200 text-sm">Maxwell 48</div>
                      <div className="text-3xl font-bold">{mx48Picks.length}<span className="text-lg ml-1">건</span></div>
                      <div className="text-emerald-200 text-xs">평균 {mx48Avg}분</div>
                    </div>
                    <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                      <div className="text-blue-200 text-sm">Maxwell 16</div>
                      <div className="text-3xl font-bold">{mx16Picks.length}<span className="text-lg ml-1">건</span></div>
                      <div className="text-blue-200 text-xs">평균 {mx16Avg}분</div>
                    </div>
                    <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white">
                      <div className="text-orange-200 text-sm">HSM 3.0</div>
                      <div className="text-3xl font-bold">{hsmPicks.length}<span className="text-lg ml-1">건</span></div>
                      <div className="text-orange-200 text-xs">평균 {hsmAvg}분</div>
                    </div>
                    <div className="bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl p-4 text-white">
                      <div className="text-gray-200 text-sm">Spare Parts</div>
                      <div className="text-3xl font-bold">{sparePicks.length}<span className="text-lg ml-1">건</span></div>
                      <div className="text-gray-200 text-xs">평균 {spareAvg}분</div>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* 선택 시 일괄 작업 버튼 */}
            {selectedPicks.size > 0 && (
              <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center gap-3">
                <span className="text-sm font-medium text-indigo-700">{selectedPicks.size}개 선택됨</span>
                <button onClick={startSelectedPicks} className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                  ▶️ 일괄 시작
                </button>
                <button onClick={completeSelectedPicks} className="px-3 py-1 bg-emerald-600 text-white text-sm rounded hover:bg-emerald-700">
                  ✅ 일괄 완료
                </button>
                <button onClick={deleteSelectedPicks} className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                  🗑️ 일괄 삭제
                </button>
                <button onClick={() => setSelectedPicks(new Set())} className="px-3 py-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600 ml-auto">
                  선택 해제
                </button>
              </div>
            )}

            {/* 필터/정렬 컨트롤 */}
            <div className="bg-white rounded-xl shadow-sm p-4">
              <div className="flex flex-wrap items-center gap-4">
                {/* 검색 */}
                <div className="flex items-center gap-2">
                  <Search className="w-4 h-4 text-gray-400" />
                  <input 
                    type="text" 
                    placeholder="Production Order / Description 검색..." 
                    className="border rounded-lg px-3 py-1.5 text-sm w-64"
                    value={pickSearchTerm}
                    onChange={e => setPickSearchTerm(e.target.value)}
                  />
                </div>
                
                {/* Model 필터 */}
                <div className="flex items-center gap-2">
                  <Filter className="w-4 h-4 text-gray-400" />
                  <select 
                    className="border rounded-lg px-3 py-1.5 text-sm"
                    value={pickFilterModel}
                    onChange={e => setPickFilterModel(e.target.value)}
                  >
                    <option value="all">전체 Model</option>
                    <option value="RSC48">RSC48</option>
                    <option value="CSC48">CSC48</option>
                    <option value="RSC16">RSC16</option>
                    <option value="CSC16">CSC16</option>
                    <option value="FSC16">FSC16</option>
                    <option value="HSM3.0">HSM3.0</option>
                    <option value="Spare Parts">Spare Parts</option>
                  </select>
                </div>
                
                {/* 상태 필터 */}
                <select 
                  className="border rounded-lg px-3 py-1.5 text-sm"
                  value={pickFilterStatus}
                  onChange={e => setPickFilterStatus(e.target.value)}
                >
                  <option value="all">전체 상태</option>
                  <option value="waiting">대기</option>
                  <option value="in-progress">진행중</option>
                  <option value="paused">일시정지</option>
                  <option value="completed">완료</option>
                </select>
                
                {/* 담당자 필터 */}
                <select 
                  className="border rounded-lg px-3 py-1.5 text-sm"
                  value={pickFilterWorker}
                  onChange={e => setPickFilterWorker(e.target.value)}
                >
                  <option value="all">전체 담당자</option>
                  <option value="Z01">Z01</option>
                  <option value="Z02">Z02</option>
                  <option value="Z03">Z03</option>
                  <option value="Z04">Z04</option>
                  <option value="Z06">Z06</option>
                </select>
                
                {/* 긴급 필터 */}
                <select 
                  className="border rounded-lg px-3 py-1.5 text-sm"
                  value={pickFilterUrgent}
                  onChange={e => setPickFilterUrgent(e.target.value)}
                >
                  <option value="all">전체</option>
                  <option value="urgent">🚨 긴급만</option>
                  <option value="normal">일반만</option>
                </select>
                
                {/* 정렬 */}
                <div className="flex items-center gap-2 ml-auto">
                  <span className="text-sm text-gray-500">정렬:</span>
                  <select 
                    className="border rounded-lg px-3 py-1.5 text-sm"
                    value={pickSortBy}
                    onChange={e => setPickSortBy(e.target.value)}
                  >
                    <option value="productionOrder">Production Order</option>
                    <option value="basicStartDate">시작예정일</option>
                    <option value="model">Model</option>
                    <option value="status">상태</option>
                  </select>
                  <button 
                    onClick={() => setPickSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                    className="px-3 py-1.5 border rounded-lg text-sm hover:bg-gray-50"
                  >
                    {pickSortOrder === 'asc' ? '↑ 오름차순' : '↓ 내림차순'}
                  </button>
                </div>
              </div>
              
              {/* 필터 결과 카운트 */}
              <div className="mt-3 text-sm text-gray-500">
                총 {pickCycles.length}개 중 {filteredSortedPicks.length}개 표시
                {(pickSearchTerm || pickFilterModel !== 'all' || pickFilterStatus !== 'all' || pickFilterWorker !== 'all' || pickFilterUrgent !== 'all') && (
                  <button 
                    onClick={() => { setPickSearchTerm(''); setPickFilterModel('all'); setPickFilterStatus('all'); setPickFilterWorker('all'); setPickFilterUrgent('all'); }}
                    className="ml-2 text-indigo-600 hover:text-indigo-800"
                  >
                    필터 초기화
                  </button>
                )}
              </div>
            </div>

            <div className="grid grid-cols-4 gap-4">
              {/* Maxwell 48 (RSC48 + CSC48) */}
              {(() => {
                const picks = pickCycles.filter(p => ['RSC48', 'CSC48'].includes(p.model) && p.cycleMin);
                const avg = picks.length ? (picks.reduce((s, p) => s + p.cycleMin, 0) / picks.length).toFixed(0) : '-';
                return (
                  <div className="bg-white rounded-xl shadow-sm p-4 text-center border-l-4 border-green-500">
                    <p className="text-sm font-medium text-gray-700">Maxwell 48</p>
                    <p className="text-xs text-gray-400 mb-1">RSC48 + CSC48</p>
                    <p className="text-2xl font-bold text-green-600">{avg}분</p>
                    <p className="text-xs text-gray-400">평균 (n={picks.length})</p>
                  </div>
                );
              })()}
              
              {/* Maxwell 16 (RSC16 + CSC16 + FSC16) */}
              {(() => {
                const picks = pickCycles.filter(p => ['RSC16', 'CSC16', 'FSC16'].includes(p.model) && p.cycleMin);
                const avg = picks.length ? (picks.reduce((s, p) => s + p.cycleMin, 0) / picks.length).toFixed(0) : '-';
                return (
                  <div className="bg-white rounded-xl shadow-sm p-4 text-center border-l-4 border-blue-500">
                    <p className="text-sm font-medium text-gray-700">Maxwell 16</p>
                    <p className="text-xs text-gray-400 mb-1">RSC16 + CSC16 + FSC16</p>
                    <p className="text-2xl font-bold text-blue-600">{avg}분</p>
                    <p className="text-xs text-gray-400">평균 (n={picks.length})</p>
                  </div>
                );
              })()}
              
              {/* HSM 3.0 */}
              {(() => {
                const picks = pickCycles.filter(p => p.model === 'HSM3.0' && p.cycleMin);
                const avg = picks.length ? (picks.reduce((s, p) => s + p.cycleMin, 0) / picks.length).toFixed(0) : '-';
                return (
                  <div className="bg-white rounded-xl shadow-sm p-4 text-center border-l-4 border-orange-500">
                    <p className="text-sm font-medium text-gray-700">HSM 3.0</p>
                    <p className="text-xs text-gray-400 mb-1">&nbsp;</p>
                    <p className="text-2xl font-bold text-orange-600">{avg}분</p>
                    <p className="text-xs text-gray-400">평균 (n={picks.length})</p>
                  </div>
                );
              })()}
              
              {/* Spare Parts */}
              {(() => {
                const picks = pickCycles.filter(p => p.model === 'Spare Parts' && p.cycleMin);
                const avg = picks.length ? (picks.reduce((s, p) => s + p.cycleMin, 0) / picks.length).toFixed(0) : '-';
                return (
                  <div className="bg-white rounded-xl shadow-sm p-4 text-center border-l-4 border-gray-400">
                    <p className="text-sm font-medium text-gray-700">Spare Parts</p>
                    <p className="text-xs text-gray-400 mb-1">&nbsp;</p>
                    <p className="text-2xl font-bold text-gray-600">{avg}분</p>
                    <p className="text-xs text-gray-400">평균 (n={picks.length})</p>
                  </div>
                );
              })()}
            </div>

            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="overflow-x-auto">
              <table className="w-full text-sm min-w-[1200px]">
                <thead className="bg-slate-50">
                  <tr>
                    <th className="px-2 py-3 text-center w-10 sticky left-0 bg-slate-50 z-10">
                      <input type="checkbox" 
                        checked={filteredSortedPicks.length > 0 && selectedPicks.size === filteredSortedPicks.length}
                        onChange={() => {
                          if (selectedPicks.size === filteredSortedPicks.length) {
                            setSelectedPicks(new Set());
                          } else {
                            setSelectedPicks(new Set(filteredSortedPicks.map(p => p.id)));
                          }
                        }}
                        className="w-4 h-4 rounded" />
                    </th>
                    <th className="px-2 py-3 text-left whitespace-nowrap">PO</th>
                    <th className="px-2 py-3 text-left whitespace-nowrap">Model</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">담당자</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">긴급</th>
                    <th className="px-2 py-3 text-left whitespace-nowrap">Part No.</th>
                    <th className="px-2 py-3 text-left whitespace-nowrap">Description</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">시작예정일</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">시작시간</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">불출완료</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">Cycle Time</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">상태</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">액션</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {filteredSortedPicks.map(p => {
                    // A5 개선: 긴급 + 미완료인 경우 강조 스타일
                    const isUrgentPending = p.isUrgent && p.status !== 'completed';
                    // 모델별 색상 설정
                    const getModelColor = (model) => {
                      switch(model) {
                        case 'RSC48': return 'bg-emerald-100 text-emerald-700';
                        case 'CSC48': return 'bg-green-100 text-green-700';
                        case 'RSC16': return 'bg-blue-100 text-blue-700';
                        case 'CSC16': return 'bg-sky-100 text-sky-700';
                        case 'FSC16': return 'bg-cyan-100 text-cyan-700';
                        case 'HSM3.0': return 'bg-orange-100 text-orange-700';
                        case 'Spare Parts': return 'bg-gray-100 text-gray-700';
                        default: return 'bg-indigo-100 text-indigo-700';
                      }
                    };
                    // 날짜 축약 함수 (2026-02-06 → 26-02-06)
                    const shortDate = (dateStr) => {
                      if (!dateStr) return '-';
                      return dateStr.replace(/^20(\d{2})/, '$1');
                    };
                    return (
                    <tr key={p.id} className={`hover:bg-slate-50 transition-all ${
                      selectedPicks.has(p.id) ? 'bg-indigo-50' : 
                      isUrgentPending ? 'bg-red-50 border-l-4 border-red-500 animate-pulse' : ''
                    }`}>
                      <td className="px-2 py-2 text-center sticky left-0 bg-white z-10">
                        <input type="checkbox" 
                          checked={selectedPicks.has(p.id)}
                          onChange={() => togglePickSelection(p.id)}
                          className="w-4 h-4 rounded" />
                      </td>
                      <td className={`px-2 py-2 font-medium whitespace-nowrap ${isUrgentPending ? 'text-red-700 font-bold' : ''}`}>
                        {isUrgentPending && <span className="mr-1">🚨</span>}
                        {p.productionOrder || p.orderId}
                      </td>
                      <td className="px-2 py-2">
                        <select 
                          className={`px-2 py-1 rounded text-xs border-0 cursor-pointer font-medium ${getModelColor(p.model)}`}
                          value={p.model}
                          onChange={e => {
                            setPickCycles(prev => prev.map(pick => 
                              pick.id === p.id ? {...pick, model: e.target.value} : pick
                            ));
                          }}
                        >
                          <option value="RSC48">RSC48</option>
                          <option value="CSC48">CSC48</option>
                          <option value="RSC16">RSC16</option>
                          <option value="CSC16">CSC16</option>
                          <option value="FSC16">FSC16</option>
                          <option value="HSM3.0">HSM3.0</option>
                          <option value="Spare Parts">Spare Parts</option>
                        </select>
                      </td>
                      <td className="px-2 py-2 text-center">
                        <select 
                          className="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs border-0 cursor-pointer hover:bg-slate-200 font-medium"
                          value={p.worker || ''}
                          onChange={e => {
                            setPickCycles(prev => prev.map(pick => 
                              pick.id === p.id ? {...pick, worker: e.target.value} : pick
                            ));
                          }}
                        >
                          <option value="">-</option>
                          <option value="Z01">Z01</option>
                          <option value="Z02">Z02</option>
                          <option value="Z03">Z03</option>
                          <option value="Z04">Z04</option>
                          <option value="Z06">Z06</option>
                        </select>
                      </td>
                      <td className="px-2 py-2 text-center whitespace-nowrap">
                        <label className="cursor-pointer">
                          <input 
                            type="checkbox" 
                            checked={p.isUrgent || false}
                            onChange={e => {
                              setPickCycles(prev => prev.map(pick => 
                                pick.id === p.id ? {...pick, isUrgent: e.target.checked} : pick
                              ));
                            }}
                            className="hidden"
                          />
                          {p.isUrgent ? (
                            <span className="px-2 py-1 bg-red-500 text-white rounded text-xs font-bold whitespace-nowrap">🚨긴급</span>
                          ) : (
                            <span className="px-2 py-1 bg-gray-200 text-gray-500 rounded text-xs hover:bg-red-100 whitespace-nowrap">일반</span>
                          )}
                        </label>
                      </td>
                      <td className="px-2 py-2 text-xs font-mono text-gray-600 whitespace-nowrap">
                        {p.materialNum || '-'}
                      </td>
                      <td className="px-2 py-2 text-sm text-gray-600 whitespace-nowrap" title={p.materialDesc || ''}>{p.materialDesc?.slice(0, 20) || '-'}</td>
                      <td className="px-2 py-2 text-center text-xs whitespace-nowrap">{shortDate(p.basicStartDate) || shortDate(p.received?.slice(0,10)) || '-'}</td>
                      <td className="px-2 py-2 text-center text-xs whitespace-nowrap">
                        {p.startTime ? (
                          <span className="text-blue-600">
                            {(() => {
                              const d = new Date(p.startTime);
                              return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                            })()}
                          </span>
                        ) : (
                          <span className="text-gray-400">-</span>
                        )}
                      </td>
                      <td className="px-2 py-2 text-center text-xs whitespace-nowrap">
                        {p.completed ? (
                          <span>
                            {(() => {
                              // 한국 형식 "2026-02-12 15:30" 그대로 표시 (MM-DD HH:MM)
                              try {
                                const parts = p.completed.replace(/[^\d\s:-]/g, '').trim().split(/[\s-]+/);
                                if (parts.length >= 4) {
                                  return `${parts[1]}-${parts[2]} ${parts[3]}`;
                                } else if (parts.length >= 3) {
                                  return `${parts[1]}-${parts[2]}`;
                                }
                                return p.completed;
                              } catch(e) { return p.completed; }
                            })()}
                          </span>
                        ) : '-'}
                      </td>
                      <td className="px-2 py-2 text-center whitespace-nowrap">
                        {p.cycleMin ? (
                          <span className={`px-2 py-1 rounded text-xs ${p.cycleMin > 60 ? 'bg-red-100 text-red-700' : p.cycleMin > 45 ? 'bg-amber-100 text-yellow-600' : 'bg-emerald-100 text-emerald-700'}`}>
                            {p.cycleMin}분
                          </span>
                        ) : '-'}
                      </td>
                      <td className="px-2 py-2 text-center whitespace-nowrap">
                        <span className={`px-2 py-1 rounded text-xs ${
                          p.status === 'completed' ? 'bg-emerald-100 text-emerald-700' : 
                          p.status === 'paused' ? 'bg-orange-100 text-orange-600' : 
                          p.status === 'in-progress' ? 'bg-blue-100 text-blue-700' : 
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {p.status === 'completed' ? '완료' : p.status === 'paused' ? '일시정지' : p.status === 'in-progress' ? '진행중' : '대기'}
                        </span>
                      </td>
                      <td className="px-2 py-2 text-center whitespace-nowrap">
                        <div className="flex gap-1 justify-center">
                          {p.status === 'waiting' && (
                            <button onClick={() => startPick(p.id)} className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex items-center gap-1">
                              <Play className="w-3 h-3" />시작
                            </button>
                          )}
                          {p.status === 'in-progress' && (
                            <>
                              <button onClick={() => pausePick(p.id)} className="px-2 py-1 bg-orange-500 text-white text-xs rounded hover:bg-orange-600 whitespace-nowrap">
                                정지
                              </button>
                              <button onClick={() => completePick(p.id)} className="px-2 py-1 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">
                                완료
                              </button>
                            </>
                          )}
                          {p.status === 'paused' && (
                            <>
                              <button onClick={() => resumePick(p.id)} className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex items-center gap-1">
                                <Play className="w-3 h-3" />재개
                              </button>
                              <button onClick={() => completePick(p.id)} className="px-2 py-1 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">
                                완료
                              </button>
                            </>
                          )}
                          <button onClick={() => setEditingPick({...p, worker: p.worker || 'Z01', isUrgent: p.isUrgent || false})} className="px-2 py-1 bg-gray-500 text-white text-xs rounded hover:bg-gray-600">
                            ✏️
                          </button>
                        </div>
                      </td>
                    </tr>
                  )})}
                </tbody>
              </table>
              </div>
            </div>
          </div>
        )}

        {/* Kitting 현황 */}
        {activeTab === 'kitting' && (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <h2 className="text-lg font-semibold">Kitting 현황 (Lead Time 관리)</h2>
                {/* 월별 선택 */}
                <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                  <button 
                    onClick={() => {
                      const d = new Date(kittingFilterMonth + '-01');
                      d.setMonth(d.getMonth() - 1);
                      setKittingFilterMonth(d.toISOString().slice(0, 7));
                    }}
                    className="p-1 hover:bg-white rounded"
                  >
                    <ChevronLeft className="w-4 h-4" />
                  </button>
                  <span className="px-2 font-medium text-teal-600">
                    {kittingFilterMonth.split('-')[0]}년 {parseInt(kittingFilterMonth.split('-')[1])}월
                  </span>
                  <button 
                    onClick={() => {
                      const d = new Date(kittingFilterMonth + '-01');
                      d.setMonth(d.getMonth() + 1);
                      setKittingFilterMonth(d.toISOString().slice(0, 7));
                    }}
                    className="p-1 hover:bg-white rounded"
                  >
                    <ChevronRight className="w-4 h-4" />
                  </button>
                </div>
                {kittingFilterMonth !== new Date().toISOString().slice(0, 7) && (
                  <button 
                    onClick={() => setKittingFilterMonth(new Date().toISOString().slice(0, 7))}
                    className="text-xs text-teal-600 hover:underline"
                  >
                    이번 달로
                  </button>
                )}
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowKittingGraphModal(true)} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                  <BarChart3 className="w-4 h-4" /> 📊 그래프
                </button>
                <label className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 cursor-pointer">
                  <Upload className="w-4 h-4" /> Order CSV 업로드
                  <input type="file" accept=".csv" onChange={handleOrderCsvUpload} className="hidden" />
                </label>
                <button onClick={downloadKittingExcel} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                  <Download className="w-4 h-4" /> 엑셀 다운로드
                </button>
                <button onClick={() => setShowKittingModal(true)} className="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                  <Plus className="w-4 h-4" /> 새 기록
                </button>
              </div>
            </div>

            {/* Kitting 통계 카드 */}
            <div className="grid grid-cols-5 gap-4">
              {(() => {
                const monthKittings = filteredSortedKittings;
                const completedKittings = monthKittings.filter(k => k.status === 'completed');
                const pendingKittings = monthKittings.filter(k => k.status !== 'completed');
                
                // 3일 이내 완료율
                const within3Days = completedKittings.filter(k => k.leadTimeDays && k.leadTimeDays <= 3).length;
                const within3DaysRate = completedKittings.length > 0 ? Math.round((within3Days / completedKittings.length) * 100) : 0;
                
                // 평균 Lead Time
                const avgLeadTime = completedKittings.length > 0
                  ? (completedKittings.reduce((sum, k) => sum + (k.leadTimeDays || 0), 0) / completedKittings.length).toFixed(1)
                  : 0;
                
                // 지연 건수 (시작예정일이 지났는데 미완료)
                const today = new Date().toISOString().split('T')[0];
                const delayedCount = pendingKittings.filter(k => k.basicStartDate && k.basicStartDate < today).length;
                
                return (
                  <>
                    <div className="bg-gradient-to-br from-teal-500 to-teal-600 rounded-xl p-4 text-white">
                      <div className="text-teal-200 text-sm">{parseInt(kittingFilterMonth.split('-')[1])}월 Kitting 완료</div>
                      <div className="text-3xl font-bold">{completedKittings.length}<span className="text-lg ml-1">건</span></div>
                      <div className="text-teal-200 text-xs">대기/진행 {pendingKittings.length}건</div>
                    </div>
                    <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
                      <div className="text-green-200 text-sm">3일 이내 완료율</div>
                      <div className="text-3xl font-bold">{within3DaysRate}<span className="text-lg ml-1">%</span></div>
                      <div className="text-green-200 text-xs">{within3Days}/{completedKittings.length}건</div>
                    </div>
                    <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                      <div className="text-blue-200 text-sm">평균 Lead Time</div>
                      <div className="text-3xl font-bold">{avgLeadTime}<span className="text-lg ml-1">일</span></div>
                      <div className="text-blue-200 text-xs">목표: 3일 이내</div>
                    </div>
                    <div className={`bg-gradient-to-br ${delayedCount > 0 ? 'from-red-500 to-red-600' : 'from-gray-400 to-gray-500'} rounded-xl p-4 text-white`}>
                      <div className={`${delayedCount > 0 ? 'text-red-200' : 'text-gray-200'} text-sm`}>지연 현황</div>
                      <div className="text-3xl font-bold">{delayedCount}<span className="text-lg ml-1">건</span></div>
                      <div className={`${delayedCount > 0 ? 'text-red-200' : 'text-gray-200'} text-xs`}>시작예정일 초과</div>
                    </div>
                    <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                      <div className="text-purple-200 text-sm">전체 등록</div>
                      <div className="text-3xl font-bold">{monthKittings.length}<span className="text-lg ml-1">건</span></div>
                      <div className="text-purple-200 text-xs">이번 달 기준</div>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* 선택 시 일괄 작업 버튼 */}
            {selectedKittings.size > 0 && (
              <div className="bg-teal-50 border border-teal-200 rounded-lg p-3 flex items-center gap-3">
                <span className="text-sm font-medium text-teal-700">{selectedKittings.size}개 선택됨</span>
                <button onClick={completeSelectedKittings} className="px-3 py-1 bg-emerald-600 text-white text-sm rounded hover:bg-emerald-700">
                  ✅ 일괄 완료
                </button>
                <button onClick={deleteSelectedKittings} className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                  🗑️ 일괄 삭제
                </button>
                <button onClick={() => setSelectedKittings(new Set())} className="px-3 py-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600 ml-auto">
                  선택 해제
                </button>
              </div>
            )}

            {/* 필터/정렬 컨트롤 */}
            <div className="bg-white rounded-xl shadow-sm p-4">
              <div className="flex flex-wrap items-center gap-4">
                {/* 검색 */}
                <div className="flex items-center gap-2">
                  <Search className="w-4 h-4 text-gray-400" />
                  <input 
                    type="text" 
                    placeholder="Production Order / Description 검색..." 
                    className="border rounded-lg px-3 py-1.5 text-sm w-64"
                    value={kittingSearchTerm}
                    onChange={e => setKittingSearchTerm(e.target.value)}
                  />
                </div>
                
                {/* Model 필터 */}
                <div className="flex items-center gap-2">
                  <Filter className="w-4 h-4 text-gray-400" />
                  <select 
                    className="border rounded-lg px-3 py-1.5 text-sm"
                    value={kittingFilterModel}
                    onChange={e => setKittingFilterModel(e.target.value)}
                  >
                    <option value="all">전체 Model</option>
                    <option value="Maxwell 48">Maxwell 48 (RSC48/CSC48)</option>
                    <option value="Maxwell 16">Maxwell 16 (RSC16/CSC16/FSC16)</option>
                    <option value="HSM3.0">HSM 3.0</option>
                    <option value="Spare Parts">Spare Parts</option>
                  </select>
                </div>
                
                {/* 상태 필터 */}
                <select 
                  className="border rounded-lg px-3 py-1.5 text-sm"
                  value={kittingFilterStatus}
                  onChange={e => setKittingFilterStatus(e.target.value)}
                >
                  <option value="all">전체 상태</option>
                  <option value="waiting">대기</option>
                  <option value="in-progress">진행중</option>
                  <option value="paused">일시정지</option>
                  <option value="completed">완료</option>
                </select>

                {/* 정렬 */}
                <div className="flex items-center gap-2 ml-auto">
                  <span className="text-sm text-gray-500">정렬:</span>
                  <select 
                    className="border rounded-lg px-3 py-1.5 text-sm"
                    value={kittingSortBy}
                    onChange={e => setKittingSortBy(e.target.value)}
                  >
                    <option value="productionOrder">Production Order</option>
                    <option value="basicStartDate">시작예정일</option>
                    <option value="completedAt">완료일</option>
                  </select>
                  <button 
                    onClick={() => setKittingSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                    className="border rounded-lg px-3 py-1.5 text-sm hover:bg-gray-50"
                  >
                    {kittingSortOrder === 'asc' ? '↑ 오름차순' : '↓ 내림차순'}
                  </button>
                </div>
              </div>
              
              {/* 필터 결과 */}
              <div className="mt-3 text-sm text-gray-500">
                총 {filteredSortedKittings.length}개 중 {filteredSortedKittings.length}개 표시
              </div>
            </div>

            {/* Kitting 테이블 */}
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="overflow-x-auto">
              <table className="w-full text-sm min-w-[1200px]">
                <thead className="bg-slate-50">
                  <tr>
                    <th className="px-2 py-3 text-center w-10 sticky left-0 bg-slate-50 z-10">
                      <input type="checkbox" 
                        checked={filteredSortedKittings.length > 0 && selectedKittings.size === filteredSortedKittings.length}
                        onChange={() => {
                          if (selectedKittings.size === filteredSortedKittings.length) {
                            setSelectedKittings(new Set());
                          } else {
                            setSelectedKittings(new Set(filteredSortedKittings.map(k => k.id)));
                          }
                        }}
                        className="w-4 h-4 rounded" />
                    </th>
                    <th className="px-2 py-3 text-left whitespace-nowrap">PO</th>
                    <th className="px-2 py-3 text-left whitespace-nowrap">Model</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">담당자</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">긴급</th>
                    <th className="px-2 py-3 text-left whitespace-nowrap">Part No.</th>
                    <th className="px-2 py-3 text-left whitespace-nowrap">Description</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">시작예정일</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">시작시간</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">완료일</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">Lead Time</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">상태</th>
                    <th className="px-2 py-3 text-center whitespace-nowrap">액션</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {filteredSortedKittings.map(k => {
                    const today = new Date().toISOString().split('T')[0];
                    const isDelayed = k.status !== 'completed' && k.basicStartDate && k.basicStartDate < today;
                    // 모델별 색상 설정 (불출과 동일)
                    const getModelColor = (model) => {
                      switch(model) {
                        case 'RSC48': return 'bg-emerald-100 text-emerald-700';
                        case 'CSC48': return 'bg-green-100 text-green-700';
                        case 'RSC16': return 'bg-blue-100 text-blue-700';
                        case 'CSC16': return 'bg-sky-100 text-sky-700';
                        case 'FSC16': return 'bg-cyan-100 text-cyan-700';
                        case 'HSM3.0': return 'bg-orange-100 text-orange-700';
                        case 'Spare Parts': return 'bg-gray-100 text-gray-700';
                        default: return 'bg-teal-100 text-teal-700';
                      }
                    };
                    // 날짜 축약 함수 (2026-02-06 → 26-02-06)
                    const shortDate = (dateStr) => {
                      if (!dateStr) return '-';
                      return dateStr.replace(/^20(\d{2})/, '$1');
                    };
                    
                    return (
                      <tr key={k.id} className={`hover:bg-slate-50 ${selectedKittings.has(k.id) ? 'bg-teal-50' : ''} ${isDelayed ? 'bg-red-50' : ''}`}>
                        <td className="px-2 py-2 text-center sticky left-0 bg-white z-10">
                          <input type="checkbox" 
                            checked={selectedKittings.has(k.id)}
                            onChange={() => toggleKittingSelection(k.id)}
                            className="w-4 h-4 rounded" />
                        </td>
                        <td className="px-2 py-2 font-medium whitespace-nowrap">{k.productionOrder}</td>
                        <td className="px-2 py-2">
                          <select 
                            className={`px-2 py-1 rounded text-xs border-0 cursor-pointer font-medium ${getModelColor(k.model)}`}
                            value={k.model}
                            onChange={e => setKittingData(prev => prev.map(item => 
                              item.id === k.id ? {...item, model: e.target.value} : item
                            ))}
                          >
                            <option value="RSC48">RSC48</option>
                            <option value="CSC48">CSC48</option>
                            <option value="RSC16">RSC16</option>
                            <option value="CSC16">CSC16</option>
                            <option value="FSC16">FSC16</option>
                            <option value="HSM3.0">HSM3.0</option>
                            <option value="Spare Parts">Spare Parts</option>
                          </select>
                        </td>
                        <td className="px-2 py-2 text-center">
                          <select 
                            className="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs border-0 cursor-pointer hover:bg-slate-200 font-medium"
                            value={k.worker || ''}
                            onChange={e => setKittingData(prev => prev.map(item => 
                              item.id === k.id ? {...item, worker: e.target.value} : item
                            ))}
                          >
                            <option value="">-</option>
                            <option value="Z01">Z01</option>
                            <option value="Z02">Z02</option>
                            <option value="Z03">Z03</option>
                            <option value="Z04">Z04</option>
                            <option value="Z06">Z06</option>
                          </select>
                        </td>
                        <td className="px-2 py-2 text-center whitespace-nowrap">
                          <label className="cursor-pointer">
                            <input 
                              type="checkbox" 
                              checked={k.isUrgent || false}
                              onChange={e => setKittingData(prev => prev.map(item => 
                                item.id === k.id ? {...item, isUrgent: e.target.checked} : item
                              ))}
                              className="hidden"
                            />
                            {k.isUrgent ? (
                              <span className="px-2 py-1 bg-red-500 text-white rounded text-xs font-bold whitespace-nowrap">🚨긴급</span>
                            ) : (
                              <span className="px-2 py-1 bg-gray-200 text-gray-500 rounded text-xs hover:bg-red-100 whitespace-nowrap">일반</span>
                            )}
                          </label>
                        </td>
                        <td className="px-2 py-2 text-xs font-mono text-gray-600 whitespace-nowrap">
                          {k.materialNum || '-'}
                        </td>
                        <td className="px-2 py-2 text-sm text-gray-600 whitespace-nowrap" title={k.materialDesc || ''}>{k.materialDesc?.slice(0, 20) || '-'}</td>
                        <td className="px-2 py-2 text-center text-xs whitespace-nowrap">{shortDate(k.basicStartDate) || '-'}</td>
                        <td className="px-2 py-2 text-center text-xs whitespace-nowrap">
                          {k.startedAt ? (
                            <span className="text-blue-600">
                              {(() => {
                                const d = new Date(k.startedAt);
                                return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                              })()}
                            </span>
                          ) : (
                            <span className="text-gray-400">-</span>
                          )}
                        </td>
                        <td className="px-2 py-2 text-center text-xs whitespace-nowrap">
                          {k.completedAt ? (
                            <span>{k.completedAt}</span>
                          ) : '-'}
                        </td>
                        <td className="px-2 py-2 text-center whitespace-nowrap">
                          {k.leadTimeDays ? (
                            <span className={`px-2 py-1 rounded text-xs ${
                              k.leadTimeDays <= 3 ? 'bg-emerald-100 text-emerald-700' : 
                              k.leadTimeDays <= 5 ? 'bg-amber-100 text-yellow-600' : 
                              'bg-red-100 text-red-700'
                            }`}>
                              {k.leadTimeDays}일
                            </span>
                          ) : '-'}
                        </td>
                        <td className="px-2 py-2 text-center whitespace-nowrap">
                          <span className={`px-2 py-1 rounded text-xs ${
                            k.status === 'completed' ? 'bg-emerald-100 text-emerald-700' : 
                            k.status === 'paused' ? 'bg-orange-100 text-orange-600' :
                            k.status === 'in-progress' ? 'bg-blue-100 text-blue-700' : 
                            isDelayed ? 'bg-red-100 text-red-700' :
                            'bg-gray-100 text-gray-700'
                          }`}>
                            {k.status === 'completed' ? '완료' : k.status === 'paused' ? '일시정지' : k.status === 'in-progress' ? '진행중' : isDelayed ? '⚠️ 지연' : '대기'}
                          </span>
                        </td>
                        <td className="px-2 py-2 text-center whitespace-nowrap">
                          <div className="flex gap-1 justify-center">
                            {k.status === 'waiting' && (
                              <button onClick={() => startKitting(k.id)} className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                시작
                              </button>
                            )}
                            {k.status === 'in-progress' && (
                              <button onClick={() => pauseKitting(k.id)} className="px-2 py-1 bg-orange-500 text-white text-xs rounded hover:bg-orange-600">
                                정지
                              </button>
                            )}
                            {k.status === 'paused' && (
                              <button onClick={() => resumeKitting(k.id)} className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                재개
                              </button>
                            )}
                            {(k.status === 'waiting' || k.status === 'in-progress' || k.status === 'paused') && (
                              <button onClick={() => completeKitting(k.id)} className="px-2 py-1 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">
                                완료
                              </button>
                            )}
                            <button 
                              onClick={() => setEditingKitting(k)}
                              className="px-2 py-1 bg-amber-500 text-white text-xs rounded hover:bg-amber-600"
                            >
                              ✏️
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              </div>
              
              {filteredSortedKittings.length === 0 && (
                <div className="text-center py-12 text-gray-500">
                  <Package className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                  <p>등록된 Kitting 항목이 없습니다.</p>
                  <p className="text-sm mt-1">CSV 업로드 또는 새 기록 버튼으로 추가하세요.</p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Receive Cycle Time */}
        {activeTab === 'receive' && (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <h2 className="text-lg font-semibold">입고 처리 Cycle Time (납품 → MIGO)</h2>
                {/* 월별 선택 */}
                <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                  <button 
                    onClick={() => {
                      const d = new Date(receiveFilterMonth + '-01');
                      d.setMonth(d.getMonth() - 1);
                      setReceiveFilterMonth(d.toISOString().slice(0, 7));
                    }}
                    className="p-1 hover:bg-white rounded"
                  >
                    <ChevronLeft className="w-4 h-4" />
                  </button>
                  <span className="px-2 font-medium text-purple-600">
                    {receiveFilterMonth.split('-')[0]}년 {parseInt(receiveFilterMonth.split('-')[1])}월
                  </span>
                  <button 
                    onClick={() => {
                      const d = new Date(receiveFilterMonth + '-01');
                      d.setMonth(d.getMonth() + 1);
                      setReceiveFilterMonth(d.toISOString().slice(0, 7));
                    }}
                    className="p-1 hover:bg-white rounded"
                  >
                    <ChevronRight className="w-4 h-4" />
                  </button>
                </div>
                {receiveFilterMonth !== new Date().toISOString().slice(0, 7) && (
                  <button 
                    onClick={() => setReceiveFilterMonth(new Date().toISOString().slice(0, 7))}
                    className="text-xs text-purple-600 hover:underline"
                  >
                    이번 달로
                  </button>
                )}
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowReceiveGraphModal(true)} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                  <BarChart3 className="w-4 h-4" /> 📊 그래프
                </button>
                <button onClick={() => downloadCycleExcel('receive')} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                  <Download className="w-4 h-4" /> 엑셀 다운로드
                </button>
                <button onClick={() => setShowReceiveModal(true)} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                  <Plus className="w-4 h-4" /> 새 기록
                </button>
              </div>
            </div>

            {/* 입고 통계 카드 */}
            <div className="grid grid-cols-3 gap-4">
              {(() => {
                const monthReceives = receiveCycles.filter(r => 
                  r.delivery?.startsWith(receiveFilterMonth) || r.migoTime?.startsWith(receiveFilterMonth)
                );
                const completedReceives = monthReceives.filter(r => r.status === 'completed' && r.cycleMin);
                const avgTime = completedReceives.length > 0 
                  ? Math.round(completedReceives.reduce((sum, r) => sum + r.cycleMin, 0) / completedReceives.length)
                  : 0;
                const uniqueVendors = [...new Set(monthReceives.map(r => r.vendor).filter(Boolean))];
                const monthCompleted = monthReceives.filter(r => r.status === 'completed').length;
                const pendingCount = monthReceives.filter(r => r.status !== 'completed').length;
                
                return (
                  <>
                    <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                      <div className="text-purple-200 text-sm">평균 입고 시간</div>
                      <div className="text-3xl font-bold">{avgTime}<span className="text-lg ml-1">분</span></div>
                      <div className="text-purple-200 text-xs">완료 {completedReceives.length}건 기준</div>
                    </div>
                    <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-4 text-white">
                      <div className="text-emerald-200 text-sm">{parseInt(receiveFilterMonth.split('-')[1])}월 입고 완료</div>
                      <div className="text-3xl font-bold">{monthCompleted}<span className="text-lg ml-1">건</span></div>
                      <div className="text-emerald-200 text-xs">{uniqueVendors.length}개 업체</div>
                    </div>
                    <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white">
                      <div className="text-orange-200 text-sm">대기/진행중</div>
                      <div className="text-3xl font-bold">{pendingCount}<span className="text-lg ml-1">건</span></div>
                      <div className="text-orange-200 text-xs">처리 필요</div>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* 선택 시 일괄 작업 버튼 */}
            {selectedReceives.size > 0 && (
              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center gap-3">
                <span className="text-sm font-medium text-purple-700">{selectedReceives.size}개 선택됨</span>
                <button onClick={startSelectedReceives} className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                  ▶️ 일괄 시작
                </button>
                <button onClick={completeSelectedReceives} className="px-3 py-1 bg-emerald-600 text-white text-sm rounded hover:bg-emerald-700">
                  ✅ 일괄 MIGO
                </button>
                <button onClick={deleteSelectedReceives} className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                  🗑️ 일괄 삭제
                </button>
                <button onClick={() => setSelectedReceives(new Set())} className="px-3 py-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600 ml-auto">
                  선택 해제
                </button>
              </div>
            )}

            {/* 필터/정렬 컨트롤 */}
            <div className="bg-white rounded-xl shadow-sm p-4">
              <div className="flex flex-wrap items-center gap-4">
                {/* 검색 */}
                <div className="flex items-center gap-2">
                  <Search className="w-4 h-4 text-gray-400" />
                  <input 
                    type="text" 
                    placeholder="No. / 협력업체 검색..." 
                    className="border rounded-lg px-3 py-1.5 text-sm w-64"
                    value={receiveSearchTerm}
                    onChange={e => setReceiveSearchTerm(e.target.value)}
                  />
                </div>
                
                {/* 상태 필터 */}
                <div className="flex items-center gap-2">
                  <Filter className="w-4 h-4 text-gray-400" />
                  <select 
                    className="border rounded-lg px-3 py-1.5 text-sm"
                    value={receiveFilterStatus}
                    onChange={e => setReceiveFilterStatus(e.target.value)}
                  >
                    <option value="all">전체 상태</option>
                    <option value="waiting">대기</option>
                    <option value="in-progress">진행중</option>
                    <option value="paused">일시정지</option>
                    <option value="completed">완료</option>
                  </select>
                </div>
                
                {/* 정렬 */}
                <div className="flex items-center gap-2 ml-auto">
                  <span className="text-sm text-gray-500">정렬:</span>
                  <select 
                    className="border rounded-lg px-3 py-1.5 text-sm"
                    value={receiveSortBy}
                    onChange={e => setReceiveSortBy(e.target.value)}
                  >
                    <option value="delivery">납품 시각</option>
                    <option value="poNo">No.</option>
                    <option value="vendor">협력업체</option>
                  </select>
                  <button 
                    onClick={() => setReceiveSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                    className="px-3 py-1.5 border rounded-lg text-sm hover:bg-gray-50"
                  >
                    {receiveSortOrder === 'asc' ? '↑ 오름차순' : '↓ 내림차순'}
                  </button>
                </div>
              </div>
              
              {/* 필터 결과 카운트 */}
              <div className="mt-3 text-sm text-gray-500">
                총 {receiveCycles.length}개 중 {filteredSortedReceives.length}개 표시
                {(receiveSearchTerm || receiveFilterStatus !== 'all') && (
                  <button 
                    onClick={() => { setReceiveSearchTerm(''); setReceiveFilterStatus('all'); }}
                    className="ml-2 text-purple-600 hover:text-purple-800"
                  >
                    필터 초기화
                  </button>
                )}
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <table className="w-full text-sm">
                <thead className="bg-slate-50">
                  <tr>
                    <th className="px-4 py-3 text-center w-10">
                      <input type="checkbox" 
                        checked={filteredSortedReceives.length > 0 && selectedReceives.size === filteredSortedReceives.length}
                        onChange={() => {
                          if (selectedReceives.size === filteredSortedReceives.length) {
                            setSelectedReceives(new Set());
                          } else {
                            setSelectedReceives(new Set(filteredSortedReceives.map(r => r.id)));
                          }
                        }}
                        className="w-4 h-4 rounded" />
                    </th>
                    <th className="px-4 py-3 text-left">No.</th>
                    <th className="px-4 py-3 text-left">협력업체</th>
                    <th className="px-4 py-3 text-center">납품 시각</th>
                    <th className="px-4 py-3 text-center">MIGO 완료</th>
                    <th className="px-4 py-3 text-center">Cycle Time</th>
                    <th className="px-4 py-3 text-center">상태</th>
                    <th className="px-4 py-3 text-left">Comments</th>
                    <th className="px-4 py-3 text-center">액션</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {filteredSortedReceives.map(r => (
                    <tr key={r.id} className={`hover:bg-slate-50 ${selectedReceives.has(r.id) ? 'bg-purple-50' : ''}`}>
                      <td className="px-4 py-3 text-center">
                        <input type="checkbox" 
                          checked={selectedReceives.has(r.id)}
                          onChange={() => toggleReceiveSelection(r.id)}
                          className="w-4 h-4 rounded" />
                      </td>
                      <td className="px-4 py-3 font-medium">{r.poNo}</td>
                      <td className="px-4 py-3">{r.vendor}</td>
                      <td className="px-4 py-3 text-center text-sm">{r.delivery ? r.delivery.replace(/^(\d{4}-\d{2}-\d{2})[\-T](\d{2}:\d{2}).*/, '$1 $2') : '-'}</td>
                      <td className="px-4 py-3 text-center text-sm">{r.migo ? convertToKoreaTime(r.migo) : '-'}</td>
                      <td className="px-4 py-3 text-center">{r.cycleMin ? `${r.cycleMin}분` : '-'}</td>
                      <td className="px-4 py-3 text-center">
                        <span className={`px-2 py-1 rounded text-xs ${
                          r.status === 'completed' ? 'bg-emerald-100 text-blue-600' : 
                          r.status === 'paused' ? 'bg-orange-100 text-orange-600' : 
                          r.status === 'in-progress' ? 'bg-blue-100 text-blue-700' : 
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {r.status === 'completed' ? '완료' : r.status === 'paused' ? '일시정지' : r.status === 'in-progress' ? '진행중' : '대기'}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-left max-w-xs">
                        <input
                          type="text"
                          className="w-full px-2 py-1 text-xs border border-gray-200 rounded hover:border-purple-400 focus:border-purple-500 focus:outline-none"
                          placeholder="메모 입력..."
                          value={r.comments || ''}
                          onChange={e => {
                            const newComments = e.target.value;
                            setReceiveCycles(prev => prev.map(item => 
                              item.id === r.id ? {...item, comments: newComments} : item
                            ));
                          }}
                        />
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex gap-1 justify-center">
                          {r.status === 'waiting' && (
                            <button onClick={() => startReceive(r.id)} className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex items-center gap-1">
                              <Play className="w-3 h-3" /> 시작
                            </button>
                          )}
                          {r.status === 'in-progress' && (
                            <>
                              <button onClick={() => pauseReceive(r.id)} className="px-2 py-1 bg-orange-500 text-white text-xs rounded hover:bg-orange-600 flex items-center gap-1">
                                <Pause className="w-3 h-3" /> 일시정지
                              </button>
                              <button onClick={() => completeReceive(r.id)} className="px-2 py-1 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">
                                MIGO 완료
                              </button>
                            </>
                          )}
                          {r.status === 'paused' && (
                            <>
                              <button onClick={() => resumeReceive(r.id)} className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 flex items-center gap-1">
                                <Play className="w-3 h-3" /> 재개
                              </button>
                              <button onClick={() => completeReceive(r.id)} className="px-2 py-1 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700">
                                MIGO 완료
                              </button>
                            </>
                          )}
                          <button onClick={() => setEditingReceive({...r})} className="px-2 py-1 bg-gray-500 text-white text-xs rounded hover:bg-gray-600">
                            ✏️
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Weight Info */}
        {activeTab === 'weight' && (
          <div className="space-y-6">
            {/* 모델별 BOM 무게 카드 - 시리즈별 그룹 */}
            <div className="bg-white rounded-xl shadow-sm p-4">
              <h3 className="font-semibold mb-4 flex items-center gap-2">
                <Scale className="w-5 h-5" /> 모델별 BOM 무게 (실제 계산값)
              </h3>
              
              {/* 48 시리즈 */}
              <div className="mb-4">
                <p className="text-xs text-gray-500 mb-2 font-medium">Maxwell 48 시리즈</p>
                <div className="grid grid-cols-2 gap-3">
                  {Object.entries(MODEL_WEIGHTS).filter(([_, d]) => d.series === '48').map(([model, data]) => (
                    <div key={model} className="bg-emerald-50 rounded-lg p-3 flex items-center justify-between">
                      <div>
                        <p className="text-xs text-gray-400">{data.code}</p>
                        <p className="text-sm font-medium text-gray-700">{data.name}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-lg font-bold text-emerald-600">{data.avgWeight} kg</p>
                        <p className="text-xs text-gray-400">BOM {data.bomItems}개</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* 16 시리즈 */}
              <div className="mb-4">
                <p className="text-xs text-gray-500 mb-2 font-medium">Maxwell 16 시리즈</p>
                <div className="grid grid-cols-3 gap-3">
                  {Object.entries(MODEL_WEIGHTS).filter(([_, d]) => d.series === '16').map(([model, data]) => (
                    <div key={model} className="bg-blue-50 rounded-lg p-3 flex items-center justify-between">
                      <div>
                        <p className="text-xs text-gray-400">{data.code}</p>
                        <p className="text-sm font-medium text-gray-700">{data.name}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-lg font-bold text-blue-600">{data.avgWeight} kg</p>
                        <p className="text-xs text-gray-400">BOM {data.bomItems}개</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* HSM 시리즈 */}
              <div>
                <p className="text-xs text-gray-500 mb-2 font-medium">HSM 시리즈</p>
                <div className="grid grid-cols-3 gap-3">
                  {Object.entries(MODEL_WEIGHTS).filter(([_, d]) => d.series === 'HSM').map(([model, data]) => (
                    <div key={model} className="bg-orange-50 rounded-lg p-3 flex items-center justify-between">
                      <div>
                        <p className="text-xs text-gray-400">{data.code}</p>
                        <p className="text-sm font-medium text-gray-700">{data.name}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-lg font-bold text-orange-600">{data.avgWeight} kg</p>
                        <p className="text-xs text-gray-400">BOM {data.bomItems}개</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <div className="flex justify-between items-center">
              <div>
                <h2 className="text-lg font-semibold">Material별 무게 정보</h2>
                <p className="text-sm text-gray-500">
                  {Object.keys(weightData).length}개 Material 등록됨
                </p>
              </div>
              <div className="flex items-center gap-2">
                <div className="relative group">
                  <label className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 cursor-pointer">
                    <Upload className="w-4 h-4" /> 엑셀 대량 업로드
                    <input 
                      type="file" 
                      accept=".xlsx,.xls,.csv" 
                      onChange={handleWeightExcelUpload}
                      className="hidden" 
                    />
                  </label>
                  {/* 툴팁 */}
                  <div className="absolute right-0 top-full mt-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none">
                    <p className="font-bold mb-2">📋 엑셀 형식 가이드</p>
                    <p className="mb-1">필수 컬럼: Material (품번)</p>
                    <p className="mb-1">선택 컬럼: Description, Net Weight (g), Storage Bin</p>
                    <p className="text-gray-300 mt-2">* 무게는 g 단위로 입력 권장</p>
                    <p className="text-gray-300">* 기존 Material은 업데이트됨</p>
                  </div>
                </div>
                <button 
                  onClick={exportWeightData}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  <Download className="w-4 h-4" /> 엑셀 내보내기
                </button>
                <button 
                  onClick={() => setShowWeightModal(true)}
                  className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700"
                >
                  <Plus className="w-4 h-4" /> 신규 Material 추가
                </button>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm p-4">
              <div className="flex flex-wrap items-center gap-4">
                <div className="flex items-center gap-2">
                  <Search className="w-4 h-4 text-gray-400" />
                  <input 
                    type="text" 
                    placeholder="Material / Description 검색..." 
                    value={searchTerm} 
                    onChange={e => setSearchTerm(e.target.value)}
                    className="border rounded-lg px-3 py-2 text-sm w-64" 
                  />
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-500">정렬:</span>
                  <select 
                    value={weightSortBy} 
                    onChange={e => setWeightSortBy(e.target.value)}
                    className="border rounded-lg px-3 py-2 text-sm"
                  >
                    <option value="bin">Bin</option>
                    <option value="material">Material</option>
                    <option value="description">Description</option>
                    <option value="weight">무게</option>
                  </select>
                  <button 
                    onClick={() => setWeightSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                    className="border rounded-lg px-3 py-2 text-sm hover:bg-gray-50"
                  >
                    {weightSortOrder === 'asc' ? '↑ 오름차순' : '↓ 내림차순'}
                  </button>
                </div>
                <span className="text-sm text-gray-500">
                  {Object.entries(weightData).filter(([m, info]) => 
                    !searchTerm || 
                    m.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (info.d && info.d.toLowerCase().includes(searchTerm.toLowerCase()))
                  ).length}개 표시
                </span>
                <button 
                  onClick={() => {
                    if (confirm('무게 데이터를 초기값으로 리셋하시겠습니까?')) {
                      setWeightData(DEFAULT_WEIGHT_DATA);
                    }
                  }}
                  className="ml-auto text-sm text-gray-500 hover:text-red-600"
                >
                  초기값으로 리셋
                </button>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="overflow-x-auto max-h-[500px]">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50 sticky top-0">
                    <tr>
                      <th className="px-3 py-3 text-left cursor-pointer hover:bg-slate-100" onClick={() => { setWeightSortBy('material'); setWeightSortOrder(prev => weightSortBy === 'material' ? (prev === 'asc' ? 'desc' : 'asc') : 'asc'); }}>
                        Material {weightSortBy === 'material' && (weightSortOrder === 'asc' ? '↑' : '↓')}
                      </th>
                      <th className="px-3 py-3 text-left cursor-pointer hover:bg-slate-100" onClick={() => { setWeightSortBy('description'); setWeightSortOrder(prev => weightSortBy === 'description' ? (prev === 'asc' ? 'desc' : 'asc') : 'asc'); }}>
                        Description {weightSortBy === 'description' && (weightSortOrder === 'asc' ? '↑' : '↓')}
                      </th>
                      <th className="px-3 py-3 text-center cursor-pointer hover:bg-slate-100" onClick={() => { setWeightSortBy('bin'); setWeightSortOrder(prev => weightSortBy === 'bin' ? (prev === 'asc' ? 'desc' : 'asc') : 'asc'); }}>
                        Bin {weightSortBy === 'bin' && (weightSortOrder === 'asc' ? '↑' : '↓')}
                      </th>
                      <th className="px-3 py-3 text-center">무게 (g)</th>
                      <th className="px-3 py-3 text-center cursor-pointer hover:bg-slate-100" onClick={() => { setWeightSortBy('weight'); setWeightSortOrder(prev => weightSortBy === 'weight' ? (prev === 'asc' ? 'desc' : 'asc') : 'asc'); }}>
                        무게 (kg) {weightSortBy === 'weight' && (weightSortOrder === 'asc' ? '↑' : '↓')}
                      </th>
                      <th className="px-3 py-3 text-center">현재 재고</th>
                      <th className="px-3 py-3 text-center">총 무게</th>
                      <th className="px-3 py-3 text-center">액션</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {Object.entries(weightData)
                      .filter(([material, info]) => 
                        !searchTerm || 
                        material.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (info.d && info.d.toLowerCase().includes(searchTerm.toLowerCase()))
                      )
                      .sort(([aMat, aInfo], [bMat, bInfo]) => {
                        let aVal, bVal;
                        switch(weightSortBy) {
                          case 'bin': aVal = aInfo.b || ''; bVal = bInfo.b || ''; break;
                          case 'material': aVal = aMat || ''; bVal = bMat || ''; break;
                          case 'description': aVal = aInfo.d || ''; bVal = bInfo.d || ''; break;
                          case 'weight': aVal = aInfo.w || 0; bVal = bInfo.w || 0; break;
                          default: aVal = aInfo.b || ''; bVal = bInfo.b || '';
                        }
                        if (typeof aVal === 'number') {
                          return weightSortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                        }
                        return weightSortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                      })
                      .slice(0, 200)
                      .map(([material, info]) => {
                        const invItem = inventoryData.find(i => i.material === material);
                        const stock = invItem?.stock || 0;
                        const totalWeight = stock * (info.w || 0);
                        const isEditing = editingWeight === material;
                        
                        return (
                          <tr key={material} className="hover:bg-slate-50">
                            <td className="px-3 py-2 font-mono text-xs">{material}</td>
                            <td className="px-3 py-2">
                              {isEditing ? (
                                <input 
                                  type="text" 
                                  value={info.d || ''} 
                                  onChange={e => updateWeight(material, 'd', e.target.value)}
                                  className="border rounded px-2 py-1 text-xs w-full"
                                />
                              ) : (
                                <span className="text-xs">{info.d || '-'}</span>
                              )}
                            </td>
                            <td className="px-3 py-2 text-center">
                              {isEditing ? (
                                <input 
                                  type="text" 
                                  value={info.b || ''} 
                                  onChange={e => updateWeight(material, 'b', e.target.value)}
                                  className="border rounded px-2 py-1 text-xs w-20 text-center"
                                />
                              ) : (
                                <span className="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs">{info.b || '-'}</span>
                              )}
                            </td>
                            <td className="px-3 py-2 text-center">
                              {isEditing ? (
                                <input 
                                  type="number" 
                                  step="0.1"
                                  value={((info.w || 0) * 1000).toFixed(1)} 
                                  onChange={e => updateWeight(material, 'w', parseFloat(e.target.value) / 1000)}
                                  className="border rounded px-2 py-1 text-xs w-20 text-center"
                                />
                              ) : (
                                ((info.w || 0) * 1000).toFixed(1)
                              )}
                            </td>
                            <td className="px-3 py-2 text-center text-xs text-gray-500">
                              {(info.w || 0).toFixed(4)}
                            </td>
                            <td className="px-3 py-2 text-center font-medium">
                              {stock > 0 ? stock.toLocaleString() : '-'}
                            </td>
                            <td className="px-3 py-2 text-center">
                              {totalWeight > 0 ? `${totalWeight.toFixed(2)} kg` : '-'}
                            </td>
                            <td className="px-3 py-2 text-center">
                              {isEditing ? (
                                <button 
                                  onClick={() => setEditingWeight(null)}
                                  className="p-1 text-emerald-600 hover:bg-emerald-50 rounded"
                                >
                                  <Check className="w-4 h-4" />
                                </button>
                              ) : (
                                <div className="flex gap-1 justify-center">
                                  <button 
                                    onClick={() => setEditingWeight(material)}
                                    className="p-1 text-indigo-600 hover:bg-indigo-50 rounded"
                                  >
                                    <Edit2 className="w-4 h-4" />
                                  </button>
                                  <button 
                                    onClick={() => deleteMaterial(material)}
                                    className="p-1 text-red-500 hover:bg-red-50 rounded"
                                  >
                                    <X className="w-4 h-4" />
                                  </button>
                                </div>
                              )}
                            </td>
                          </tr>
                        );
                      })}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* 온습도 관리 */}
        {activeTab === 'temphumidity' && (
          <div className="space-y-6">
            {/* 헤더 */}
            <div className="bg-white rounded-xl shadow-sm p-6">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                  <h2 className="text-lg font-semibold flex items-center gap-2">
                    <Thermometer className="w-5 h-5 text-red-500" />
                    온습도 관리 (ESD Check Sheet)
                  </h2>
                </div>
                <div className="flex items-center gap-2">
                  <input
                    type="month"
                    value={tempHumidityMonth}
                    onChange={e => setTempHumidityMonth(e.target.value)}
                    className="border rounded-lg px-3 py-2 text-sm"
                  />
                  <button
                    type="button"
                    onClick={() => setTempHumidityMonth(new Date().toISOString().slice(0, 7))}
                    className="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm"
                    title="오늘 날짜로 이동"
                  >
                    오늘
                  </button>
                  <button
                    type="button"
                    onClick={() => setShowTempHumidityExportModal(true)}
                    className="flex items-center gap-2 px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
                  >
                    <Download className="w-4 h-4" />
                    Excel
                  </button>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.stopPropagation();
                      e.preventDefault();
                      generateTempHumidityPDF();
                    }}
                    className="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm"
                  >
                    <Printer className="w-4 h-4" />
                    문서 출력
                  </button>
                </div>
              </div>
              
              {/* 기록자 설정 */}
              <div className="mt-4 flex items-center gap-2">
                <span className="text-sm text-gray-600">Recorded by:</span>
                <input
                  type="text"
                  value={tempHumidityRecorder}
                  onChange={e => setTempHumidityRecorder(e.target.value)}
                  className="border rounded px-2 py-1 text-sm w-32"
                  placeholder="이름"
                />
              </div>
            </div>

            {/* 온습도 기준 안내 */}
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
              <h3 className="font-medium text-blue-800 mb-2">📋 온습도 관리 기준 (NS-205B)</h3>
              <div className="flex flex-wrap items-center gap-6 text-sm">
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-green-100 text-green-700 rounded">온도</span>
                  <span>+5 ~ 40℃</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-cyan-100 text-cyan-700 rounded">습도</span>
                  <span>0 ~ 75%</span>
                </div>
              </div>
              <p className="text-xs text-gray-500 mt-2">Equipment & Tool: NS-205B / Check method: write down the digit</p>
            </div>

            {/* 월간 통계 - 기준 아래에 위치 */}
            <div className="bg-white rounded-xl shadow-sm p-6">
              <h3 className="font-semibold mb-4">📊 {parseInt(tempHumidityMonth.split('-')[1])}월 통계</h3>
              {(() => {
                const [year, month] = tempHumidityMonth.split('-').map(Number);
                const daysInMonth = new Date(year, month, 0).getDate();
                
                // 영업일 수 계산 (주말 + 공휴일 제외)
                let workdays = 0;
                for (let d = 1; d <= daysInMonth; d++) {
                  const dt = new Date(year, month - 1, d);
                  const dow = dt.getDay();
                  const dk = `${tempHumidityMonth}-${String(d).padStart(2, '0')}`;
                  if (dow !== 0 && dow !== 6 && !KR_HOLIDAYS.has(dk)) workdays++;
                }
                
                let tempSum = 0, humidSum = 0, count = 0;
                let tempMin = Infinity, tempMax = -Infinity;
                let humidMin = Infinity, humidMax = -Infinity;
                
                for (let day = 1; day <= daysInMonth; day++) {
                  const dateKey = `${tempHumidityMonth}-${String(day).padStart(2, '0')}`;
                  const data = tempHumidityData[dateKey];
                  if (data && data.temp && data.humidity) {
                    const t = parseFloat(data.temp);
                    const h = parseFloat(data.humidity);
                    if (!isNaN(t) && !isNaN(h)) {
                      tempSum += t;
                      humidSum += h;
                      count++;
                      tempMin = Math.min(tempMin, t);
                      tempMax = Math.max(tempMax, t);
                      humidMin = Math.min(humidMin, h);
                      humidMax = Math.max(humidMax, h);
                    }
                  }
                }
                
                const avgTemp = count > 0 ? (tempSum / count).toFixed(1) : '-';
                const avgHumid = count > 0 ? (humidSum / count).toFixed(1) : '-';
                
                return (
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-red-50 rounded-lg p-4 text-center">
                      <p className="text-sm text-red-600">평균 온도</p>
                      <p className="text-2xl font-bold text-red-700">{avgTemp}℃</p>
                      {count > 0 && <p className="text-xs text-gray-500">{tempMin.toFixed(1)}~{tempMax.toFixed(1)}℃</p>}
                    </div>
                    <div className="bg-cyan-50 rounded-lg p-4 text-center">
                      <p className="text-sm text-cyan-600">평균 습도</p>
                      <p className="text-2xl font-bold text-cyan-700">{avgHumid}%</p>
                      {count > 0 && <p className="text-xs text-gray-500">{humidMin.toFixed(1)}~{humidMax.toFixed(1)}%</p>}
                    </div>
                    <div className="bg-green-50 rounded-lg p-4 text-center">
                      <p className="text-sm text-green-600">기록일수</p>
                      <p className="text-2xl font-bold text-green-700">{count}일</p>
                      <p className="text-xs text-gray-500">/ {workdays}일 (영업일)</p>
                    </div>
                    <div className="bg-purple-50 rounded-lg p-4 text-center">
                      <p className="text-sm text-purple-600">입력률</p>
                      <p className="text-2xl font-bold text-purple-700">{workdays > 0 ? Math.round(count / workdays * 100) : 0}%</p>
                    </div>
                  </div>
                );
              })()}
            </div>

            {/* Temp & Humidity Trend 그래프 */}
            <div className="bg-white rounded-xl shadow-sm p-6">
              <h3 className="font-semibold mb-4 flex items-center gap-2">
                <TrendingUp className="w-5 h-5 text-blue-500" />
                Temp & Humidity Trend
              </h3>
              <div className="h-96">
                <ResponsiveContainer width="100%" height="100%">
                  <ScatterChart margin={{ top: 20, right: 60, bottom: 20, left: 20 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis 
                      dataKey="date" 
                      type="category"
                      allowDuplicatedCategory={false}
                      tick={{ fontSize: 10 }}
                      tickFormatter={(value) => {
                        const d = new Date(value);
                        return `${d.getFullYear()}년 ${d.getMonth()+1}월`;
                      }}
                      interval={60}
                    />
                    {/* 온도 Y축 (좌측) - 15~50 범위 */}
                    <YAxis 
                      yAxisId="temp"
                      domain={[15, 50]} 
                      ticks={[15, 20, 25, 30, 35, 40, 45, 50]}
                      tick={{ fontSize: 10 }}
                      label={{ value: 'Temp.', angle: -90, position: 'insideLeft', fontSize: 12, fill: '#0369a1' }}
                      stroke="#0369a1"
                    />
                    {/* 습도 Y축 (우측) - 0~70 범위 */}
                    <YAxis 
                      yAxisId="humidity"
                      orientation="right"
                      domain={[0, 70]} 
                      ticks={[0, 10, 20, 30, 40, 50, 60, 70]}
                      tick={{ fontSize: 10 }}
                      label={{ value: 'Humidity', angle: 90, position: 'insideRight', fontSize: 12, fill: '#ea580c' }}
                      stroke="#ea580c"
                    />
                    <Tooltip 
                      content={({ active, payload }) => {
                        if (active && payload && payload.length) {
                          const data = payload[0].payload;
                          return (
                            <div className="bg-white p-2 border rounded shadow text-xs">
                              <p className="font-medium">{data.date}</p>
                              <p className="text-sky-700">온도: {data.temp}℃</p>
                              <p className="text-orange-600">습도: {data.humidity}%</p>
                            </div>
                          );
                        }
                        return null;
                      }}
                    />
                    {/* 온도 데이터 (진한 파란색) */}
                    <Scatter 
                      yAxisId="temp"
                      name="Temperature" 
                      data={Object.entries(tempHumidityData)
                        .filter(([_, v]) => v.temp)
                        .map(([date, v]) => ({ date, temp: parseFloat(v.temp), humidity: parseFloat(v.humidity) }))
                        .sort((a, b) => a.date.localeCompare(b.date))
                      }
                      fill="#0369a1"
                      dataKey="temp"
                      shape={(props) => {
                        const { cx, cy } = props;
                        return <circle cx={cx} cy={cy} r={3} fill="#0369a1" />;
                      }}
                    />
                    {/* 습도 데이터 (주황색) */}
                    <Scatter 
                      yAxisId="humidity"
                      name="Humidity" 
                      data={Object.entries(tempHumidityData)
                        .filter(([_, v]) => v.humidity)
                        .map(([date, v]) => ({ date, temp: parseFloat(v.temp), humidity: parseFloat(v.humidity) }))
                        .sort((a, b) => a.date.localeCompare(b.date))
                      }
                      fill="#ea580c"
                      dataKey="humidity"
                      shape={(props) => {
                        const { cx, cy } = props;
                        return <circle cx={cx} cy={cy} r={3} fill="#ea580c" />;
                      }}
                    />
                  </ScatterChart>
                </ResponsiveContainer>
              </div>
              <div className="mt-2 flex items-center justify-center gap-6 text-xs text-gray-500">
                <span className="flex items-center gap-1"><span className="w-3 h-3 bg-sky-700 rounded-full"></span> Temperature (좌축, ℃)</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 bg-orange-600 rounded-full"></span> Humidity (우축, %)</span>
              </div>
            </div>

            {/* 월별 데이터 입력 테이블 */}
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <div className="p-4 border-b bg-gray-50">
                <h3 className="font-semibold">
                  {tempHumidityMonth.split('-')[0]}년 {parseInt(tempHumidityMonth.split('-')[1])}월 온습도 기록
                </h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-slate-100">
                    <tr>
                      <th className="px-3 py-2 text-center w-16">Day</th>
                      <th className="px-3 py-2 text-center w-24">요일</th>
                      <th className="px-3 py-2 text-center w-32">Temp (℃)</th>
                      <th className="px-3 py-2 text-center w-32">Humidity (%)</th>
                      <th className="px-3 py-2 text-center">상태</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {(() => {
                      const [year, month] = tempHumidityMonth.split('-').map(Number);
                      const daysInMonth = new Date(year, month, 0).getDate();
                      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                      
                      return Array.from({ length: daysInMonth }, (_, i) => {
                        const day = i + 1;
                        const dateKey = `${tempHumidityMonth}-${String(day).padStart(2, '0')}`;
                        const dayOfWeek = new Date(year, month - 1, day).getDay();
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const isHoliday = KR_HOLIDAYS.has(dateKey);
                        const isOff = isWeekend || isHoliday;
                        const data = tempHumidityData[dateKey] || { temp: '', humidity: '' };
                        
                        // 온습도 상태 체크 (회사 기준: Temp +5~40℃, Humidity 0~75%)
                        const tempNum = parseFloat(data.temp);
                        const humidNum = parseFloat(data.humidity);
                        const tempOk = !isNaN(tempNum) && tempNum >= 5 && tempNum <= 40;
                        const humidOk = !isNaN(humidNum) && humidNum >= 0 && humidNum <= 75;
                        const hasData = data.temp || data.humidity;
                        
                        return (
                          <tr key={day} className={`${isOff ? 'bg-gray-50' : ''} hover:bg-blue-50`}>
                            <td className="px-3 py-2 text-center font-medium">{day}</td>
                            <td className={`px-3 py-2 text-center ${dayOfWeek === 0 || isHoliday ? 'text-red-500' : dayOfWeek === 6 ? 'text-blue-500' : ''}`}>
                              {weekdays[dayOfWeek]}
                            </td>
                            <td className="px-3 py-2">
                              <input
                                type="number"
                                step="0.1"
                                placeholder="-"
                                className={`w-full border rounded px-2 py-1 text-center ${
                                  hasData && !isNaN(tempNum) ? (tempOk ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300') : ''
                                }`}
                                value={data.temp}
                                onChange={e => {
                                  setTempHumidityData(prev => ({
                                    ...prev,
                                    [dateKey]: { ...prev[dateKey], temp: e.target.value }
                                  }));
                                }}
                              />
                            </td>
                            <td className="px-3 py-2">
                              <input
                                type="number"
                                step="0.1"
                                placeholder="-"
                                className={`w-full border rounded px-2 py-1 text-center ${
                                  hasData && !isNaN(humidNum) ? (humidOk ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300') : ''
                                }`}
                                value={data.humidity}
                                onChange={e => {
                                  setTempHumidityData(prev => ({
                                    ...prev,
                                    [dateKey]: { ...prev[dateKey], humidity: e.target.value }
                                  }));
                                }}
                              />
                            </td>
                            <td className="px-3 py-2 text-center">
                              {hasData ? (
                                tempOk && humidOk ? (
                                  <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">정상</span>
                                ) : (
                                  <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">
                                    {!tempOk && !humidOk ? '온도/습도 이상' : !tempOk ? '온도 이상' : '습도 이상'}
                                  </span>
                                )
                              ) : isOff ? (
                                <span className="text-gray-400 text-xs">{isHoliday && !isWeekend ? '공휴일' : '주말'}</span>
                              ) : (
                                <span className="text-gray-400 text-xs">미입력</span>
                              )}
                            </td>
                          </tr>
                        );
                      });
                    })()}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* KPI 관리 탭 */}
        {activeTab === 'kpi' && (
          <div className="space-y-6">
            {/* 헤더 */}
            <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-6 text-white">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold flex items-center gap-2">
                    📊 KPI Dashboard
                  </h2>
                  <p className="text-indigo-200 mt-1">월간 성과 지표 관리</p>
                </div>
                <div className="flex items-center gap-2 flex-wrap justify-end">
                  {/* v17: GR Cancel 엑셀 업로드 버튼 */}
                  <label className="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition cursor-pointer text-white text-sm font-medium">
                    <FileSpreadsheet className="w-4 h-4" />
                    GR Cancel 업로드
                    <input
                      type="file"
                      accept=".xlsx,.xls"
                      className="hidden"
                      onChange={(e) => {
                        const file = e.target.files?.[0];
                        if (file) parseGRCancelExcel(file);
                        e.target.value = '';
                      }}
                    />
                  </label>
                  {/* v17: 재고 손실율 엑셀 업로드 버튼 */}
                  <label className="flex items-center gap-2 px-4 py-2 bg-violet-500 hover:bg-violet-600 rounded-lg transition cursor-pointer text-white text-sm font-medium">
                    <FileSpreadsheet className="w-4 h-4" />
                    재고손실율 업로드
                    <input
                      type="file"
                      accept=".xlsx,.xls"
                      className="hidden"
                      onChange={(e) => {
                        const file = e.target.files?.[0];
                        if (file) parseInventoryLossExcel(file);
                        e.target.value = '';
                      }}
                    />
                  </label>
                  {/* 데이터 리셋 버튼 */}
                  <button
                    onClick={() => {
                      setKpiData({
                        grCancel: DEFAULT_GR_CANCEL_DATA,
                        grCancelQty: {},
                        inventoryAdjust: {}
                      });
                      setGrCancelUploadStatus(null);
                      setGrCancelUploadMsg('');
                      setInventoryLossUploadStatus(null);
                      setInventoryLossUploadMsg('');
                      showToast('KPI 데이터가 초기화되었습니다.', 'success');
                    }}
                    className="flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 rounded-lg transition"
                  >
                    <RefreshCw className="w-4 h-4" />
                    리셋
                  </button>
                  <button
                    onClick={() => setShowKpiInputModal(true)}
                    className="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition"
                  >
                    <Plus className="w-5 h-5" />
                    수동 입력
                  </button>
                </div>
              </div>
            </div>

            {/* 연도 선택 */}
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-600">연도 선택:</span>
                {[2024, 2025, 2026].map(year => (
                  <button
                    key={year}
                    onClick={() => setKpiSelectedYear(year)}
                    className={`px-4 py-2 rounded-lg font-medium transition ${
                      kpiSelectedYear === year
                        ? 'bg-indigo-600 text-white'
                        : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    {year}년
                  </button>
                ))}
              </div>
              <div className="flex flex-col gap-1 text-sm">
                <span className="text-gray-500">
                  GR Cancel: {Object.keys(kpiData.grCancel).length}개월 / GR Qty: {Object.keys(kpiData.grCancelQty).length}개월 로드됨
                </span>
                {/* v17: 업로드 상태 메시지 */}
                {grCancelUploadMsg && (
                  <span className={`text-xs px-2 py-1 rounded ${
                    grCancelUploadStatus === 'success' ? 'bg-blue-50 text-blue-700' :
                    grCancelUploadStatus === 'error' ? 'bg-red-50 text-red-700' :
                    'bg-gray-50 text-gray-500'
                  }`}>
                    {grCancelUploadMsg}
                  </span>
                )}
                {inventoryLossUploadMsg && (
                  <span className={`text-xs px-2 py-1 rounded ${
                    inventoryLossUploadStatus === 'success' ? 'bg-violet-50 text-violet-700' :
                    inventoryLossUploadStatus === 'error' ? 'bg-red-50 text-red-700' :
                    'bg-gray-50 text-gray-500'
                  }`}>
                    {inventoryLossUploadMsg}
                  </span>
                )}
              </div>
            </div>

            {/* KPI 요약 카드 - 선택된 연도 */}
            {(() => {
              const selectedYear = kpiSelectedYear;
              const currentMonth = new Date().getMonth() + 1;
              const isCurrentYear = selectedYear === new Date().getFullYear();
              
              // 선택된 연도 데이터 집계
              const yearMonths = Array.from({ length: 12 }, (_, i) => 
                `${selectedYear}-${String(i + 1).padStart(2, '0')}`
              );
              
              // GR Cancel 평균
              const grCancelValues = yearMonths
                .map(m => kpiData.grCancel[m])
                .filter(v => v !== undefined);
              const grCancelAvg = grCancelValues.length > 0 
                ? grCancelValues.reduce((a, b) => a + b, 0) / grCancelValues.length 
                : null;
              const grCancelScore = calculateKpiScore('grCancel', grCancelAvg);
              
              // Inventory Adjust 평균
              const invAdjustValues = yearMonths
                .map(m => kpiData.inventoryAdjust[m])
                .filter(v => v !== undefined);
              const invAdjustAvg = invAdjustValues.length > 0 
                ? invAdjustValues.reduce((a, b) => a + b, 0) / invAdjustValues.length 
                : null;
              const invAdjustScore = calculateKpiScore('inventoryAdjust', invAdjustAvg);
              
              // Kitting Lead Time 평균 (자동 집계)
              const kittingLTByMonth = {};
              kittingData.filter(k => k.status === 'completed' && k.leadTimeDays).forEach(k => {
                const month = k.completedAt?.slice(0, 7);
                if (month && month.startsWith(String(selectedYear))) {
                  if (!kittingLTByMonth[month]) kittingLTByMonth[month] = [];
                  kittingLTByMonth[month].push(k.leadTimeDays);
                }
              });
              const kittingLTValues = Object.values(kittingLTByMonth).map(arr => 
                arr.reduce((a, b) => a + b, 0) / arr.length
              );
              const kittingLTAvg = kittingLTValues.length > 0 
                ? kittingLTValues.reduce((a, b) => a + b, 0) / kittingLTValues.length 
                : null;
              const kittingLTScore = calculateKpiScore('kittingLeadTime', kittingLTAvg);
              
              // Kitting Cycle Time 월별 집계
              const kittingCTByMonth = {};
              pickCycles.filter(p => p.status === 'completed' && p.cycleMin).forEach(p => {
                const month = p.completed?.slice(0, 7);
                if (month && month.startsWith(String(selectedYear))) {
                  if (!kittingCTByMonth[month]) kittingCTByMonth[month] = [];
                  kittingCTByMonth[month].push(p.cycleMin);
                }
              });
              const kittingCTValues = Object.values(kittingCTByMonth).map(arr => 
                arr.reduce((a, b) => a + b, 0) / arr.length
              );
              const kittingCTAvg = kittingCTValues.length > 0 
                ? kittingCTValues.reduce((a, b) => a + b, 0) / kittingCTValues.length 
                : null;

              // 입고 Cycle Time 월별 집계 (migo 날짜 기준)
              const receiveCTByMonth = {};
              receiveCycles.filter(r => r.status === 'completed' && r.cycleMin).forEach(r => {
                const month = r.migo?.slice(0, 7);
                if (month && month.startsWith(String(selectedYear))) {
                  if (!receiveCTByMonth[month]) receiveCTByMonth[month] = [];
                  receiveCTByMonth[month].push(r.cycleMin);
                }
              });
              const receiveCTValues = Object.values(receiveCTByMonth).map(arr =>
                arr.reduce((a, b) => a + b, 0) / arr.length
              );
              const receiveCTAvg = receiveCTValues.length > 0
                ? receiveCTValues.reduce((a, b) => a + b, 0) / receiveCTValues.length
                : null;

              const getScoreColor = (score) => {
                if (score === null) return 'bg-gray-100 text-gray-500';
                if (score >= 80) return 'bg-emerald-100 text-emerald-700 border-emerald-300';
                if (score >= 60) return 'bg-amber-100 text-amber-700 border-amber-300';
                return 'bg-red-100 text-red-700 border-red-300';
              };

              return (
                <>
                  <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
                    {/* GR Cancel */}
                    <div className={`rounded-xl p-5 border-2 ${getScoreColor(grCancelScore)}`}>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium">GR Cancel</span>
                        {grCancelScore !== null && (
                          <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                            grCancelScore >= 80 ? 'bg-emerald-500 text-white' : 
                            grCancelScore >= 60 ? 'bg-amber-500 text-white' : 'bg-red-500 text-white'
                          }`}>
                            {grCancelScore}점
                          </span>
                        )}
                      </div>
                      <p className="text-3xl font-bold">
                        {grCancelAvg !== null ? grCancelAvg.toFixed(1) : '-'}
                        <span className="text-lg font-normal ml-1">건/월</span>
                      </p>
                      {/* v17: GR Cancel 비율 표시 (qty 데이터 있을 때만) */}
                      {(() => {
                        const totalQty = yearMonths.reduce((s,m) => s + (kpiData.grCancelQty[m]||0), 0);
                        const totalCancel = yearMonths.reduce((s,m) => s + (kpiData.grCancel[m]||0), 0);
                        const rateVals = yearMonths
                          .filter(m => kpiData.grCancelQty[m] && kpiData.grCancel[m] !== undefined)
                          .map(m => (kpiData.grCancel[m] / kpiData.grCancelQty[m]) * 100);
                        const avgRate = rateVals.length > 0
                          ? rateVals.reduce((a, b) => a + b, 0) / rateVals.length
                          : null;
                        return (
                          <>
                            {totalQty > 0 && (
                              <p className="text-xs mt-1 opacity-80">
                                입고: {totalQty}건 / Cancel: {totalCancel}건
                              </p>
                            )}
                            {avgRate !== null && (
                              <p className="text-sm font-semibold mt-0.5 opacity-80">
                                취소율: {avgRate.toFixed(3)}% 평균
                              </p>
                            )}
                          </>
                        );
                      })()}
                      <p className="text-xs mt-1 opacity-70">목표: 2건 이하 (80점)</p>
                      <p className="text-xs opacity-50">{selectedYear}년 {grCancelValues.length}개월 평균</p>
                    </div>

                    {/* Inventory Adjust Cost */}
                    <div className={`rounded-xl p-5 border-2 ${getScoreColor(invAdjustScore)}`}>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium">재고 손실율</span>
                        {invAdjustScore !== null && (
                          <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                            invAdjustScore >= 80 ? 'bg-emerald-500 text-white' : 
                            invAdjustScore >= 60 ? 'bg-amber-500 text-white' : 'bg-red-500 text-white'
                          }`}>
                            {invAdjustScore}점
                          </span>
                        )}
                      </div>
                      <p className="text-3xl font-bold">
                        {invAdjustAvg !== null ? invAdjustAvg.toFixed(3) : '-'}
                        <span className="text-lg font-normal ml-1">%</span>
                      </p>
                      <p className="text-xs mt-2 opacity-70">목표: 0.064% 이하 (80점)</p>
                      <p className="text-xs opacity-50">{selectedYear}년 {invAdjustValues.length}개월 평균</p>
                    </div>

                    {/* Kitting Lead Time */}
                    <div className={`rounded-xl p-5 border-2 ${getScoreColor(kittingLTScore)}`}>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium">Kitting Lead Time</span>
                        {kittingLTScore !== null && (
                          <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                            kittingLTScore >= 80 ? 'bg-emerald-500 text-white' : 
                            kittingLTScore >= 60 ? 'bg-amber-500 text-white' : 'bg-red-500 text-white'
                          }`}>
                            {kittingLTScore}점
                          </span>
                        )}
                      </div>
                      <p className="text-3xl font-bold">
                        {kittingLTAvg !== null ? kittingLTAvg.toFixed(1) : '-'}
                        <span className="text-lg font-normal ml-1">일</span>
                      </p>
                      <p className="text-xs mt-2 opacity-70">목표: 3일 이하 (80점)</p>
                      <p className="text-xs opacity-50">{selectedYear}년 자동 집계</p>
                    </div>

                    {/* Kitting Cycle Time */}
                    <div className="rounded-xl p-5 border-2 bg-gray-50 text-gray-600 border-gray-200">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium">Kitting Cycle Time</span>
                        <span className="px-2 py-0.5 rounded text-xs bg-gray-300 text-gray-600">목표 미정</span>
                      </div>
                      <p className="text-3xl font-bold">
                        {kittingCTAvg !== null ? kittingCTAvg.toFixed(0) : '-'}
                        <span className="text-lg font-normal ml-1">분</span>
                      </p>
                      <p className="text-xs mt-2 opacity-70">목표: 검토 중</p>
                      <p className="text-xs opacity-50">{selectedYear}년 자동 집계</p>
                    </div>

                    {/* 입고 Cycle Time */}
                    <div className="rounded-xl p-5 border-2 bg-gray-50 text-gray-600 border-gray-200">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium">입고 Cycle Time</span>
                        <span className="px-2 py-0.5 rounded text-xs bg-gray-300 text-gray-600">목표 미정</span>
                      </div>
                      <p className="text-3xl font-bold">
                        {receiveCTAvg !== null ? receiveCTAvg.toFixed(0) : '-'}
                        <span className="text-lg font-normal ml-1">분</span>
                      </p>
                      <p className="text-xs mt-2 opacity-70">목표: 검토 중</p>
                      <p className="text-xs opacity-50">{selectedYear}년 자동 집계</p>
                    </div>
                  </div>

                  {/* 월별 추이 그래프 */}
                  <div className="bg-white rounded-xl shadow-sm p-6">
                    <h3 className="font-semibold mb-4 flex items-center gap-2">
                      📈 {selectedYear}년 월별 KPI 추이
                    </h3>
                    
                    {/* v17: GR Cancel 연도별 트렌드 - 엑셀 업로드 데이터 동적 반영 */}
                    <div className="mb-8">
                      <h4 className="text-base font-bold text-gray-700 mb-3">
                        📊 GR Cancel Rate 연도별 추이
                        {Object.keys(kpiData.grCancelQty).length > 0 && (
                          <span className="ml-2 text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded">📂 엑셀 데이터 반영됨</span>
                        )}
                      </h4>
                      {(() => {
                        // 연도별 확정 데이터 (SUM 시트 기준 - 정적 사용)
                        // SUM 시트의 연간 합계 컬럼에서 추출한 값
                        const annualData = [
                          { year: 2020, qty: 3294, cancel: 141 },
                          { year: 2021, qty: 1773, cancel: 31 },
                          { year: 2022, qty: 1411, cancel: 24 },
                          { year: 2023, qty: 1220, cancel: 6 },
                          { year: 2024, qty: 1277, cancel: 2 },
                          { year: 2025, qty: 1377, cancel: 5 },
                        ];
                        const maxRate = Math.max(...annualData.map(d => d.qty > 0 ? (d.cancel/d.qty)*100 : 0));
                        return (
                          <>
                            <div className="grid grid-cols-6 gap-3">
                              {annualData.map(d => {
                                const rate = d.qty > 0 ? (d.cancel / d.qty) * 100 : 0;
                                return (
                                  <div key={d.year} className="bg-gray-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-gray-500 mb-1">{d.year}</p>
                                    <p className={`text-lg font-bold ${
                                      rate <= 0.5 ? 'text-emerald-600' : 
                                      rate <= 2 ? 'text-amber-600' : 'text-red-600'
                                    }`}>{rate.toFixed(2)}%</p>
                                    <p className="text-xs text-gray-400 mt-1">{d.cancel}/{d.qty}건</p>
                                  </div>
                                );
                              })}
                            </div>
                            <div className="mt-3 flex items-end gap-1 h-16">
                              {annualData.map((d, i) => {
                                const rate = d.qty > 0 ? (d.cancel / d.qty) * 100 : 0;
                                return (
                                  <div key={i} className="flex-1 flex flex-col items-center">
                                    <div 
                                      className={`w-full rounded-t ${rate <= 0.5 ? 'bg-emerald-500' : rate <= 2 ? 'bg-amber-500' : 'bg-red-500'}`}
                                      style={{ height: `${maxRate > 0 ? (rate / maxRate) * 100 : 0}%` }}
                                    />
                                    <span className="text-xs text-gray-400 mt-1">{String(d.year).slice(2)}</span>
                                  </div>
                                );
                              })}
                            </div>
                          </>
                        );
                      })()}
                    </div>

                    {/* GR Cancel - 막대(하단25%)=GR Qty, 꺾은선(상단75%)=월별 취소율 */}
                    {(() => {
                      const grChartData = yearMonths.map((month, idx) => {
                        const qty   = kpiData.grCancelQty[month] || null;
                        const cancel = kpiData.grCancel[month] !== undefined ? kpiData.grCancel[month] : null;
                        // 월별 취소율 (cancel/qty*100)
                        const rate = (qty && cancel !== null) ? parseFloat((cancel / qty * 100).toFixed(3)) : null;
                        // 누적 취소율
                        const cumQty    = yearMonths.slice(0,idx+1).reduce((s,m)=>s+(kpiData.grCancelQty[m]||0),0);
                        const cumCancel = yearMonths.slice(0,idx+1).reduce((s,m)=>{const v=kpiData.grCancel[m]; return s+(v!==undefined?v:0);},0);
                        const cumRate   = cumQty > 0 ? parseFloat((cumCancel/cumQty*100).toFixed(3)) : null;
                        return { name: `${idx+1}월`, qty, cancel, rate, cumRate };
                      });
                      const hasData   = grChartData.some(d => d.qty !== null);
                      const qtyMax    = Math.max(...grChartData.map(d => d.qty || 0), 10);
                      const rateMax   = Math.max(...grChartData.map(d => d.cumRate || 0), 1);
                      // 막대(GR Qty)를 하단 25%로 — 왼쪽 Y축 max = qtyMax * 4
                      const leftMax   = qtyMax * 4;
                      const rightMax  = parseFloat((rateMax * 1.8).toFixed(2)) || 1;
                      // 연간 요약
                      const totalQty    = yearMonths.reduce((s,m)=>s+(kpiData.grCancelQty[m]||0),0);
                      const totalCancel = yearMonths.reduce((s,m)=>{const v=kpiData.grCancel[m]; return s+(v!==undefined?v:0);},0);
                      const finalRate   = totalQty > 0 ? (totalCancel/totalQty*100) : 0;
                      return (
                        <div className="mb-8">
                          {/* 헤더 */}
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="text-base font-bold text-gray-700">GR Cancel - 자동 집계</h4>
                            <div className="flex items-center gap-4 text-xs">
                              <span className="flex items-center gap-1 text-gray-400"><span className="inline-block w-3 h-3 rounded bg-blue-400 opacity-70"></span>막대 = GR Qty</span>
                              <span className="flex items-center gap-1 text-gray-400"><span className="inline-block w-4 border-t-2 border-violet-500"></span>꺾은선 = 누적 취소율(%)</span>
                              <span className={`px-2 py-0.5 rounded font-medium ${totalCancel <= 2 ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-600'}`}>
                                {selectedYear} Target: 2건 | Actual: {totalCancel}건
                              </span>
                            </div>
                          </div>
                          {/* 요약 뱃지 */}
                          <div className="flex gap-3 mb-3 text-xs">
                            <span className="px-2 py-1 bg-blue-50 text-blue-700 rounded">Total GR: <b>{totalQty.toLocaleString()}</b>건</span>
                            <span className="px-2 py-1 bg-orange-50 text-orange-700 rounded">Total Cancel: <b>{totalCancel}</b>건</span>
                            <span className={`px-2 py-1 rounded ${finalRate===0?'bg-emerald-50 text-emerald-700':finalRate<=0.5?'bg-amber-50 text-amber-700':'bg-red-50 text-red-600'}`}>
                              Cancel Rate: <b>{finalRate.toFixed(2)}%</b>
                            </span>
                          </div>
                          <ResponsiveContainer width="100%" height={260}>
                            <ComposedChart data={grChartData} margin={{top:30,right:60,left:5,bottom:5}}>
                              <CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" vertical={false} />
                              <XAxis dataKey="name" tick={{fontSize:11}} axisLine={false} tickLine={false} />
                              {/* 왼쪽: GR Qty — max*4 → 막대 하단 25% */}
                              <YAxis yAxisId="left" orientation="left" tick={{fontSize:10, fill:'#3b82f6'}}
                                domain={[0, leftMax]} allowDecimals={false}
                                tickFormatter={v => v <= qtyMax ? v : ''} width={30} />
                              {/* 오른쪽: 취소율(%) */}
                              <YAxis yAxisId="right" orientation="right" tick={{fontSize:10, fill:'#7c3aed'}}
                                domain={[0, rightMax]} width={40}
                                tickFormatter={v => `${v.toFixed(2)}%`} />
                              <Tooltip
                                contentStyle={{borderRadius:8, border:'1px solid #e5e7eb', fontSize:12}}
                                formatter={(v, name) => {
                                  if (v === null || v === undefined) return ['-', name];
                                  if (name === '누적 취소율(%)') return [`${v.toFixed(3)}%`, name];
                                  return [`${v}건`, name];
                                }} />
                              <Legend verticalAlign="bottom" wrapperStyle={{fontSize:11, paddingTop:8}} />
                              {/* 목표선 2건 (건수 축 기준) */}
                              <ReferenceLine yAxisId="left" y={2} stroke="#10b981" strokeDasharray="5 3" />
                              {/* GR Qty 막대 */}
                              <Bar yAxisId="left" dataKey="qty" name="GR Qty" radius={[4,4,0,0]} maxBarSize={40} fillOpacity={0.75}
                                label={(props) => {
                                  const {x,y,width,value}=props;
                                  if(!value) return null;
                                  return <text x={x+width/2} y={y-5} fill="#1d4ed8" textAnchor="middle" fontSize={12} fontWeight={700}>{value}건</text>;
                                }}>
                                {grChartData.map((d,i) => (
                                  <Cell key={i} fill={!d.qty ? '#e5e7eb' : '#60a5fa'} />
                                ))}
                              </Bar>
                              {/* 누적 취소율 꺾은선 */}
                              <Line yAxisId="right" type="monotone" dataKey="cumRate" name="누적 취소율(%)"
                                stroke="#7c3aed" strokeWidth={3}
                                dot={{r:6, fill:'#fff', stroke:'#7c3aed', strokeWidth:2.5}}
                                activeDot={{r:8}}
                                label={(props) => {
                                  const {x,y,value}=props;
                                  if(value===null||value===undefined) return null;
                                  const text = value.toFixed(2)+'%';
                                  const tw = text.length*6+6;
                                  return (
                                    <g>
                                      <rect x={x-tw/2} y={y-26} width={tw} height={15} rx={3} fill="rgba(124,58,237,0.12)" />
                                      <text x={x} y={y-15} fill="#7c3aed" textAnchor="middle" fontSize={10} fontWeight={700}>{text}</text>
                                    </g>
                                  );
                                }}
                                connectNulls={false} />
                            </ComposedChart>
                          </ResponsiveContainer>
                        </div>
                      );
                    })()}

                    {/* Inventory Adjust 그래프 */}
                    <div className="mb-8">
                      <h4 className="text-base font-bold text-gray-700 mb-3">재고 손실율 (%)</h4>
                      <div className="relative h-48 border-b border-l border-gray-300">
                        {/* 목표선 (0.064%) */}
                        <div 
                          className="absolute left-0 right-0 border-t-2 border-dashed border-emerald-500"
                          style={{ bottom: `${(0.064 / 0.25) * 100}%` }}
                        >
                          <span className="absolute -top-3 right-0 text-xs text-emerald-600 bg-white px-1">목표 0.064%</span>
                        </div>
                        <div className="absolute -left-10 top-0 text-xs text-gray-400">0.25</div>
                        <div className="absolute -left-6 bottom-0 text-xs text-gray-400">0</div>
                        <div className="absolute inset-0 flex items-end justify-around px-2">
                          {yearMonths.map((month, idx) => {
                            const value = kpiData.inventoryAdjust[month];
                            const height = value !== undefined ? (value / 0.25) * 100 : 0;
                            const isPast = selectedYear < new Date().getFullYear() || (isCurrentYear && idx + 1 <= currentMonth);
                            return (
                              <div key={month} className="flex flex-col items-center gap-1 flex-1">
                                <div className="w-full flex flex-col items-center">
                                  {value !== undefined && (
                                    <span className="text-xs font-medium mb-1">{value.toFixed(3)}</span>
                                  )}
                                  <div 
                                    className={`w-6 rounded-t transition-all ${
                                      value === undefined 
                                        ? isPast ? 'bg-gray-200' : 'bg-gray-100'
                                        : value <= 0.064 ? 'bg-emerald-500' 
                                        : value <= 0.12 ? 'bg-amber-500' 
                                        : 'bg-red-500'
                                    }`}
                                    style={{ height: `${Math.max(height, value !== undefined ? 5 : 0)}%` }}
                                  />
                                </div>
                                <span className="text-xs text-gray-400">{idx + 1}월</span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>

                    {/* Kitting Lead Time - 막대(하단25%)=건수, 꺾은선(상단75%)=L/T */}
                    {(() => {
                      const ltChartData = yearMonths.map((month, idx) => {
                        const md = kittingLTByMonth[month];
                        const lt = md ? parseFloat((md.reduce((a,b)=>a+b,0)/md.length).toFixed(2)) : null;
                        const count = md ? md.length : null;
                        return { name: `${idx+1}월`, lt, count };
                      });
                      const hasData = ltChartData.some(d => d.lt !== null);
                      const countMax = Math.max(...ltChartData.map(d => d.count || 0), 3);
                      const ltMax   = Math.max(...ltChartData.map(d => d.lt   || 0), 5);
                      // 막대를 하단 25%에 → 왼쪽 Y축 max = countMax * 4
                      const leftDomainMax  = countMax * 4;
                      // 꺾은선을 상단 75%에 → 오른쪽 Y축 max에 충분한 여백
                      const rightDomainMax = Math.ceil(ltMax * 1.4 / 1) + 1;
                      return (
                        <div className="mb-8">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="text-base font-bold text-gray-700">Kitting Lead Time - 자동 집계</h4>
                            <div className="flex items-center gap-4 text-xs text-gray-400">
                              <span className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded bg-indigo-400 opacity-70"></span>막대 = Order 건수</span>
                              <span className="flex items-center gap-1"><span className="inline-block w-4 border-t-2 border-red-500"></span>꺾은선 = L/T(일)</span>
                              {!hasData && <span className="text-gray-400">Kitting L/T 탭 완료 건부터 집계</span>}
                            </div>
                          </div>
                          {/* 요약 뱃지 */}
                          {(() => {
                            const totalOrders = Object.values(kittingLTByMonth).reduce((s,arr)=>s+arr.length,0);
                            const allLT = Object.values(kittingLTByMonth).flat();
                            const avgLT = allLT.length > 0 ? allLT.reduce((a,b)=>a+b,0)/allLT.length : null;
                            return (
                              <div className="flex gap-3 mb-3 text-xs">
                                <span className="px-2 py-1 bg-indigo-50 text-indigo-700 rounded">Total Orders: <b>{totalOrders}</b>건</span>
                                {avgLT !== null && <span className={`px-2 py-1 rounded ${avgLT<=3?'bg-emerald-50 text-emerald-700':avgLT<=5?'bg-amber-50 text-amber-700':'bg-red-50 text-red-600'}`}>평균 L/T: <b>{avgLT.toFixed(1)}</b>일</span>}
                                <span className={`px-2 py-1 rounded ${avgLT===null?'bg-gray-50 text-gray-400':avgLT<=3?'bg-emerald-50 text-emerald-700':'bg-red-50 text-red-600'}`}>목표: 3일 이하</span>
                              </div>
                            );
                          })()}
                          <ResponsiveContainer width="100%" height={260}>
                            <ComposedChart data={ltChartData} margin={{top:30,right:55,left:5,bottom:5}}>
                              <CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" vertical={false} />
                              <XAxis dataKey="name" tick={{fontSize:11}} axisLine={false} tickLine={false} />
                              {/* 왼쪽 Y축: 건수 — max를 4배로 늘려 막대가 하단 25%만 차지 */}
                              <YAxis yAxisId="left" orientation="left" tick={{fontSize:10, fill:'#6366f1'}}
                                domain={[0, leftDomainMax]} allowDecimals={false}
                                tickFormatter={v => v <= countMax ? v : ''} width={28} />
                              {/* 오른쪽 Y축: L/T(일) */}
                              <YAxis yAxisId="right" orientation="right" tick={{fontSize:10, fill:'#ef4444'}}
                                domain={[0, rightDomainMax]} width={32}
                                tickFormatter={v => `${v}일`} />
                              <Tooltip
                                contentStyle={{borderRadius:8, border:'1px solid #e5e7eb', fontSize:12}}
                                formatter={(v, name) => [
                                  v === null ? '-' : name === 'Lead Time(일)' ? `${v}일` : `${v}건`, name
                                ]}
                              />
                              <Legend verticalAlign="bottom" wrapperStyle={{fontSize:11, paddingTop:8}} />
                              <ReferenceLine yAxisId="right" y={3} stroke="#10b981" strokeDasharray="5 3"
                                label={{value:'목표 3일', position:'insideTopRight', fontSize:10, fill:'#10b981'}} />
                              {/* 막대: 건수 — 불투명도 낮춰 꺾은선이 잘 보이게 */}
                              <Bar yAxisId="left" dataKey="count" name="Order 건수"
                                radius={[4,4,0,0]} maxBarSize={40} fillOpacity={0.75}
                                label={(props) => {
                                  const {x,y,width,value} = props;
                                  if (!value) return null;
                                  return <text x={x+width/2} y={y-5} fill="#4338ca" textAnchor="middle" fontSize={12} fontWeight={700}>{value}건</text>;
                                }}>
                                {ltChartData.map((d,i) => (
                                  <Cell key={i} fill={!d.count ? '#e5e7eb' : d.lt<=3 ? '#818cf8' : d.lt<=5 ? '#fbbf24' : d.count ? '#818cf8' : '#e5e7eb'} />
                                ))}
                              </Bar>
                              {/* 꺾은선: L/T(일) — 두꺼운 선 + 눈에 띄는 점 */}
                              <Line yAxisId="right" type="monotone" dataKey="lt" name="Lead Time(일)"
                                stroke="#ef4444" strokeWidth={3} dot={{r:6, fill:'#fff', stroke:'#ef4444', strokeWidth:2.5}}
                                activeDot={{r:8}}
                                label={(props) => {
                                  const {x,y,value} = props;
                                  if (!value) return null;
                                  return <text x={x} y={y-12} fill="#ef4444" textAnchor="middle" fontSize={11} fontWeight={700}>{value}일</text>;
                                }}
                                connectNulls={false} />
                            </ComposedChart>
                          </ResponsiveContainer>
                        </div>
                      );
                    })()}

                    {/* Kitting Cycle Time - 막대(하단25%)=건수, 꺾은선(상단75%)=CT(분) */}
                    {(() => {
                      const ctChartData = yearMonths.map((month, idx) => {
                        const md = kittingCTByMonth[month];
                        const ct = md ? parseFloat((md.reduce((a,b)=>a+b,0)/md.length).toFixed(0)) : null;
                        const count = md ? md.length : null;
                        return { name: `${idx+1}월`, ct, count };
                      });
                      const hasData = ctChartData.some(d => d.ct !== null);
                      const ctCountMax = Math.max(...ctChartData.map(d => d.count || 0), 3);
                      const ctMax      = Math.max(...ctChartData.map(d => d.ct    || 0), 60);
                      const ctLeftMax  = ctCountMax * 4;
                      const ctRightMax = Math.ceil(ctMax * 1.4 / 10) * 10 + 20;
                      return (
                        <div className="mb-8">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="text-base font-bold text-gray-700">Kitting Cycle Time - 자동 집계</h4>
                            <div className="flex items-center gap-4 text-xs text-gray-400">
                              <span className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded bg-blue-400 opacity-70"></span>막대 = Order 건수</span>
                              <span className="flex items-center gap-1"><span className="inline-block w-4 border-t-2 border-purple-500"></span>꺾은선 = CT(분)</span>
                              {!hasData && <span>Kitting Cycle 탭 완료 건부터 집계</span>}
                            </div>
                          </div>
                          {/* 요약 뱃지 */}
                          {(() => {
                            const totalOrders = Object.values(kittingCTByMonth).reduce((s,arr)=>s+arr.length,0);
                            const allCT = Object.values(kittingCTByMonth).flat();
                            const avgCT = allCT.length > 0 ? Math.round(allCT.reduce((a,b)=>a+b,0)/allCT.length) : null;
                            return (
                              <div className="flex gap-3 mb-3 text-xs">
                                <span className="px-2 py-1 bg-blue-50 text-blue-700 rounded">Total Orders: <b>{totalOrders}</b>건</span>
                                {avgCT !== null && <span className="px-2 py-1 bg-purple-50 text-purple-700 rounded">평균 CT: <b>{avgCT}</b>분</span>}
                                <span className="px-2 py-1 bg-gray-50 text-gray-400 rounded">목표: 검토 중</span>
                              </div>
                            );
                          })()}
                          <ResponsiveContainer width="100%" height={260}>
                            <ComposedChart data={ctChartData} margin={{top:30,right:60,left:5,bottom:5}}>
                              <CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" vertical={false} />
                              <XAxis dataKey="name" tick={{fontSize:11}} axisLine={false} tickLine={false} />
                              <YAxis yAxisId="left" orientation="left" tick={{fontSize:10, fill:'#3b82f6'}}
                                domain={[0, ctLeftMax]} allowDecimals={false}
                                tickFormatter={v => v <= ctCountMax ? v : ''} width={28} />
                              <YAxis yAxisId="right" orientation="right" tick={{fontSize:10, fill:'#8b5cf6'}}
                                domain={[0, ctRightMax]} width={40}
                                tickFormatter={v => `${v}분`} />
                              <Tooltip
                                contentStyle={{borderRadius:8, border:'1px solid #e5e7eb', fontSize:12}}
                                formatter={(v, name) => [v === null ? '-' : name === 'Cycle Time(분)' ? `${v}분` : `${v}건`, name]} />
                              <Legend verticalAlign="bottom" wrapperStyle={{fontSize:11, paddingTop:8}} />
                              <Bar yAxisId="left" dataKey="count" name="Order 건수"
                                radius={[4,4,0,0]} maxBarSize={40} fillOpacity={0.75}
                                label={(props) => {
                                  const {x,y,width,value} = props;
                                  if (!value) return null;
                                  return <text x={x+width/2} y={y-5} fill="#1d4ed8" textAnchor="middle" fontSize={12} fontWeight={700}>{value}건</text>;
                                }}>
                                {ctChartData.map((d,i) => (
                                  <Cell key={i} fill={!d.count ? '#e5e7eb' : '#60a5fa'} />
                                ))}
                              </Bar>
                              <Line yAxisId="right" type="monotone" dataKey="ct" name="Cycle Time(분)"
                                stroke="#8b5cf6" strokeWidth={3} dot={{r:6, fill:'#fff', stroke:'#8b5cf6', strokeWidth:2.5}}
                                activeDot={{r:8}}
                                label={(props) => {
                                  const {x,y,value} = props;
                                  if (!value) return null;
                                  return <text x={x} y={y-12} fill="#7c3aed" textAnchor="middle" fontSize={11} fontWeight={700}>{value}분</text>;
                                }}
                                connectNulls={false} />
                            </ComposedChart>
                          </ResponsiveContainer>
                        </div>
                      );
                    })()}

                    {/* 입고 Cycle Time - 막대(하단25%)=입고건수, 꺾은선(상단75%)=평균시간(분) */}
                    {(() => {
                      const rcChartData = yearMonths.map((month, idx) => {
                        const md = receiveCTByMonth[month];
                        const rc = md ? parseFloat((md.reduce((a,b)=>a+b,0)/md.length).toFixed(0)) : null;
                        const count = md ? md.length : null;
                        return { name: `${idx+1}월`, rc, count };
                      });
                      const hasData = rcChartData.some(d => d.rc !== null);
                      const rcCountMax = Math.max(...rcChartData.map(d => d.count || 0), 3);
                      const rcMax      = Math.max(...rcChartData.map(d => d.rc    || 0), 60);
                      const rcLeftMax  = rcCountMax * 4;
                      const rcRightMax = Math.ceil(rcMax * 1.4 / 10) * 10 + 20;
                      return (
                        <div className="mb-8">
                          <div className="flex items-center justify-between mb-2">
                            <h4 className="text-base font-bold text-gray-700">입고 Cycle Time - 자동 집계</h4>
                            <div className="flex items-center gap-4 text-xs text-gray-400">
                              <span className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded bg-sky-400 opacity-70"></span>막대 = 입고 건수</span>
                              <span className="flex items-center gap-1"><span className="inline-block w-4 border-t-2 border-orange-400"></span>꺾은선 = 평균시간(분)</span>
                              {!hasData && <span>입고 Cycle 탭 완료 건부터 집계</span>}
                            </div>
                          </div>
                          {/* 요약 뱃지 */}
                          {(() => {
                            const totalReceives = Object.values(receiveCTByMonth).reduce((s,arr)=>s+arr.length,0);
                            const allRC = Object.values(receiveCTByMonth).flat();
                            const avgRC = allRC.length > 0 ? Math.round(allRC.reduce((a,b)=>a+b,0)/allRC.length) : null;
                            return (
                              <div className="flex gap-3 mb-3 text-xs">
                                <span className="px-2 py-1 bg-sky-50 text-sky-700 rounded">Total 입고: <b>{totalReceives}</b>건</span>
                                {avgRC !== null && <span className="px-2 py-1 bg-orange-50 text-orange-700 rounded">평균 입고시간: <b>{avgRC}</b>분</span>}
                                <span className="px-2 py-1 bg-gray-50 text-gray-400 rounded">목표: 검토 중</span>
                              </div>
                            );
                          })()}
                          <ResponsiveContainer width="100%" height={260}>
                            <ComposedChart data={rcChartData} margin={{top:30,right:60,left:5,bottom:5}}>
                              <CartesianGrid strokeDasharray="3 3" stroke="#f3f4f6" vertical={false} />
                              <XAxis dataKey="name" tick={{fontSize:11}} axisLine={false} tickLine={false} />
                              <YAxis yAxisId="left" orientation="left" tick={{fontSize:10, fill:'#0ea5e9'}}
                                domain={[0, rcLeftMax]} allowDecimals={false}
                                tickFormatter={v => v <= rcCountMax ? v : ''} width={28} />
                              <YAxis yAxisId="right" orientation="right" tick={{fontSize:10, fill:'#f97316'}}
                                domain={[0, rcRightMax]} width={40}
                                tickFormatter={v => `${v}분`} />
                              <Tooltip
                                contentStyle={{borderRadius:8, border:'1px solid #e5e7eb', fontSize:12}}
                                formatter={(v, name) => [v === null ? '-' : name === '평균 입고시간(분)' ? `${v}분` : `${v}건`, name]} />
                              <Legend verticalAlign="bottom" wrapperStyle={{fontSize:11, paddingTop:8}} />
                              <Bar yAxisId="left" dataKey="count" name="입고 건수"
                                radius={[4,4,0,0]} maxBarSize={40} fillOpacity={0.75}
                                label={(props) => {
                                  const {x,y,width,value} = props;
                                  if (!value) return null;
                                  return <text x={x+width/2} y={y-5} fill="#0369a1" textAnchor="middle" fontSize={12} fontWeight={700}>{value}건</text>;
                                }}>
                                {rcChartData.map((d,i) => (
                                  <Cell key={i} fill={!d.count ? '#e5e7eb' : '#38bdf8'} />
                                ))}
                              </Bar>
                              <Line yAxisId="right" type="monotone" dataKey="rc" name="평균 입고시간(분)"
                                stroke="#f97316" strokeWidth={3} dot={{r:6, fill:'#fff', stroke:'#f97316', strokeWidth:2.5}}
                                activeDot={{r:8}}
                                label={(props) => {
                                  const {x,y,value} = props;
                                  if (!value) return null;
                                  return <text x={x} y={y-12} fill="#ea580c" textAnchor="middle" fontSize={11} fontWeight={700}>{value}분</text>;
                                }}
                                connectNulls={false} />
                            </ComposedChart>
                          </ResponsiveContainer>
                        </div>
                      );
                    })()}
                  </div>

                  {/* 데이터 테이블 */}
                  <div className="bg-white rounded-xl shadow-sm p-6">
                    <h3 className="font-semibold mb-4 flex items-center gap-2">
                      📋 {selectedYear}년 월별 데이터
                    </h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b bg-gray-50">
                            <th className="px-3 py-2 text-left font-medium">월</th>
                            <th className="px-3 py-2 text-center font-medium">GR Qty<br/><span className="text-xs font-normal text-gray-500">(건)</span></th>
                            <th className="px-3 py-2 text-center font-medium">GR Cancel<br/><span className="text-xs font-normal text-gray-500">(건)</span></th>
                            <th className="px-3 py-2 text-center font-medium">취소율<br/><span className="text-xs font-normal text-gray-500">(%)</span></th>
                            <th className="px-3 py-2 text-center font-medium">재고 손실율<br/><span className="text-xs font-normal text-gray-500">(%)</span></th>
                            <th className="px-3 py-2 text-center font-medium">Kitting L/T<br/><span className="text-xs font-normal text-gray-500">(일)</span></th>
                            <th className="px-3 py-2 text-center font-medium">Kitting CT<br/><span className="text-xs font-normal text-gray-500">(분/건)</span></th>
                            <th className="px-3 py-2 text-center font-medium">입고 CT<br/><span className="text-xs font-normal text-gray-500">(분/건)</span></th>
                            <th className="px-3 py-2 text-center font-medium">액션</th>
                          </tr>
                        </thead>
                        <tbody>
                          {yearMonths.map((month, idx) => {
                            const monthNum = idx + 1;
                            const grVal = kpiData.grCancel[month];
                            const grQtyVal = kpiData.grCancelQty[month];
                            const grRate = (grVal !== undefined && grQtyVal) ? ((grVal / grQtyVal) * 100) : null;
                            const invVal = kpiData.inventoryAdjust[month];
                            const ltData = kittingLTByMonth[month];
                            const ltVal = ltData ? ltData.reduce((a, b) => a + b, 0) / ltData.length : null;
                            const ctData = kittingCTByMonth[month];
                            const ctVal = ctData ? ctData.reduce((a, b) => a + b, 0) / ctData.length : null;
                            const rcData = receiveCTByMonth[month];
                            const rcVal = rcData ? rcData.reduce((a, b) => a + b, 0) / rcData.length : null;
                            const rcCount = rcData ? rcData.length : null;
                            const isPast = selectedYear < new Date().getFullYear() || (isCurrentYear && monthNum <= currentMonth);
                            
                            return (
                              <tr key={month} className={`border-b ${!isPast ? 'bg-gray-50 text-gray-400' : ''}`}>
                                <td className="px-3 py-2 font-medium">{monthNum}월</td>
                                <td className="px-3 py-2 text-center">
                                  {grQtyVal !== undefined ? (
                                    <span className="text-gray-600">{grQtyVal}</span>
                                  ) : '-'}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {grVal !== undefined ? (
                                    <span className={`px-2 py-0.5 rounded ${
                                      grVal <= 2 ? 'bg-emerald-100 text-emerald-700' :
                                      grVal <= 5 ? 'bg-amber-100 text-amber-700' :
                                      'bg-red-100 text-red-700'
                                    }`}>
                                      {grVal}
                                    </span>
                                  ) : '-'}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {grRate !== null ? (
                                    <span className={`px-2 py-0.5 rounded text-xs ${
                                      grRate === 0 ? 'bg-emerald-100 text-emerald-700' :
                                      grRate <= 0.5 ? 'bg-amber-100 text-amber-700' :
                                      'bg-red-100 text-red-700'
                                    }`}>
                                      {grRate.toFixed(3)}%
                                    </span>
                                  ) : '-'}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {invVal !== undefined ? (
                                    <span className={`px-2 py-0.5 rounded ${
                                      invVal <= 0.064 ? 'bg-emerald-100 text-emerald-700' :
                                      invVal <= 0.12 ? 'bg-amber-100 text-amber-700' :
                                      'bg-red-100 text-red-700'
                                    }`}>
                                      {invVal.toFixed(3)}
                                    </span>
                                  ) : '-'}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {ltVal !== null ? (
                                    <span className={`px-2 py-0.5 rounded ${
                                      ltVal <= 3 ? 'bg-emerald-100 text-emerald-700' :
                                      ltVal <= 5 ? 'bg-amber-100 text-amber-700' :
                                      'bg-red-100 text-red-700'
                                    }`}>
                                      {ltVal.toFixed(1)}
                                    </span>
                                  ) : <span className="text-gray-400">-</span>}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {ctVal !== null ? (
                                    <span className="px-2 py-0.5 rounded bg-blue-100 text-blue-700">
                                      {ctVal.toFixed(0)}분 / {ctData.length}건
                                    </span>
                                  ) : <span className="text-gray-400">-</span>}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {rcVal !== null ? (
                                    <span className="px-2 py-0.5 rounded bg-sky-100 text-sky-700">
                                      {rcVal.toFixed(0)}분 / {rcCount}건
                                    </span>
                                  ) : <span className="text-gray-400">-</span>}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {isPast && (
                                    <button
                                      onClick={() => {
                                        setKpiInputMonth(month);
                                        setShowKpiInputModal(true);
                                      }}
                                      className="text-indigo-600 hover:text-indigo-800 text-xs"
                                    >
                                      {grVal !== undefined || invVal !== undefined ? '수정' : '입력'}
                                    </button>
                                  )}
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                        <tfoot>
                          {(() => {
                            // 연간 합계/평균 계산
                            const totalGRQty = yearMonths.reduce((s,m) => s + (kpiData.grCancelQty[m] || 0), 0);
                            const totalGRCancel = yearMonths.reduce((s,m) => s + (kpiData.grCancel[m] !== undefined ? kpiData.grCancel[m] : 0), 0);
                            const totalCancelRate = totalGRQty > 0 ? (totalGRCancel / totalGRQty * 100) : null;
                            const invVals = yearMonths.map(m => kpiData.inventoryAdjust[m]).filter(v => v !== undefined);
                            const avgInv = invVals.length > 0 ? invVals.reduce((a,b)=>a+b,0)/invVals.length : null;
                            const ltVals = Object.values(kittingLTByMonth).map(arr => arr.reduce((a,b)=>a+b,0)/arr.length);
                            const avgLT = ltVals.length > 0 ? ltVals.reduce((a,b)=>a+b,0)/ltVals.length : null;
                            const allCT = Object.values(kittingCTByMonth).flat();
                            const avgCT = allCT.length > 0 ? allCT.reduce((a,b)=>a+b,0)/allCT.length : null;
                            const totalKittingOrders = Object.values(kittingCTByMonth).reduce((s,arr)=>s+arr.length,0);
                            const allRC = Object.values(receiveCTByMonth).flat();
                            const avgRC = allRC.length > 0 ? allRC.reduce((a,b)=>a+b,0)/allRC.length : null;
                            const totalReceiveOrders = Object.values(receiveCTByMonth).reduce((s,arr)=>s+arr.length,0);
                            return (
                              <tr className="bg-indigo-50 font-medium text-sm">
                                <td className="px-3 py-2 text-gray-600">연간 합계/평균</td>
                                {/* GR Qty - 합계 */}
                                <td className="px-3 py-2 text-center">
                                  {totalGRQty > 0 ? <span className="text-blue-700">{totalGRQty}건</span> : '-'}
                                </td>
                                {/* GR Cancel - 합계 */}
                                <td className="px-3 py-2 text-center">
                                  {<span className={totalGRCancel <= 2 ? 'text-emerald-700' : 'text-red-600'}>{totalGRCancel}건</span>}
                                </td>
                                {/* 취소율 - 연간 누적 */}
                                <td className="px-3 py-2 text-center">
                                  {totalCancelRate !== null ? <span className={totalCancelRate === 0 ? 'text-emerald-700' : totalCancelRate <= 0.5 ? 'text-amber-600' : 'text-red-600'}>{totalCancelRate.toFixed(3)}%</span> : '-'}
                                </td>
                                {/* 재고 손실율 - 평균 */}
                                <td className="px-3 py-2 text-center">
                                  {avgInv !== null ? <span className={avgInv <= 0.064 ? 'text-emerald-700' : 'text-amber-600'}>{avgInv.toFixed(3)}%</span> : '-'}
                                </td>
                                {/* Kitting L/T - 전체 평균 */}
                                <td className="px-3 py-2 text-center">
                                  {avgLT !== null ? <span className={avgLT <= 3 ? 'text-emerald-700' : avgLT <= 5 ? 'text-amber-600' : 'text-red-600'}>{avgLT.toFixed(1)}일 평균</span> : '-'}
                                </td>
                                {/* Kitting CT - 전체 평균 / 총 건수 */}
                                <td className="px-3 py-2 text-center">
                                  {avgCT !== null ? <span className="text-blue-700">{Math.round(avgCT)}분 / {totalKittingOrders}건</span> : '-'}
                                </td>
                                {/* 입고 CT - 전체 평균 / 총 건수 */}
                                <td className="px-3 py-2 text-center">
                                  {avgRC !== null ? <span className="text-sky-700">{Math.round(avgRC)}분 / {totalReceiveOrders}건</span> : '-'}
                                </td>
                                <td className="px-3 py-2"></td>
                              </tr>
                            );
                          })()}
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </>
              );
            })()}
          </div>
        )}

        {/* KPI 데이터 입력 모달 */}
        {showKpiInputModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowKpiInputModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-xl shadow-xl p-6 w-full max-w-md m-4`} onClick={e => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-semibold text-lg">📊 KPI 데이터 입력</h3>
                <button onClick={() => setShowKpiInputModal(false)}><X className="w-5 h-5" /></button>
              </div>
              
              <div className="space-y-4">
                {/* 월 선택 */}
                <div>
                  <label className="block text-sm font-medium mb-1">월 선택</label>
                  <input
                    type="month"
                    value={kpiInputMonth}
                    onChange={e => setKpiInputMonth(e.target.value)}
                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}
                  />
                </div>

                {/* GR Qty + GR Cancel 나란히 */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium mb-1">
                      GR Qty (총 건수)
                    </label>
                    <input
                      type="number"
                      min="0"
                      value={kpiData.grCancelQty[kpiInputMonth] ?? ''}
                      onChange={e => setKpiData(prev => ({
                        ...prev,
                        grCancelQty: {
                          ...prev.grCancelQty,
                          [kpiInputMonth]: e.target.value === '' ? undefined : parseInt(e.target.value)
                        }
                      }))}
                      placeholder="예: 83"
                      className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">
                      GR Cancel (건수)
                      <span className="text-xs text-gray-500 ml-1">목표 2건↓</span>
                    </label>
                    <input
                      type="number"
                      min="0"
                      value={kpiData.grCancel[kpiInputMonth] ?? ''}
                      onChange={e => setKpiData(prev => ({
                        ...prev,
                        grCancel: {
                          ...prev.grCancel,
                          [kpiInputMonth]: e.target.value === '' ? undefined : parseInt(e.target.value)
                        }
                      }))}
                      placeholder="예: 0"
                      className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}
                    />
                  </div>
                </div>
                {/* 취소율 실시간 미리보기 */}
                {kpiData.grCancelQty[kpiInputMonth] > 0 && kpiData.grCancel[kpiInputMonth] !== undefined && (
                  <div className="text-xs text-blue-600 bg-blue-50 rounded px-2 py-1">
                    취소율: {((kpiData.grCancel[kpiInputMonth] / kpiData.grCancelQty[kpiInputMonth]) * 100).toFixed(3)}%
                  </div>
                )}

                {/* Inventory Adjust Cost */}
                <div>
                  <label className="block text-sm font-medium mb-1">
                    재고 손실율 (%)
                    <span className="text-xs text-gray-500 ml-2">목표: 0.064% 이하</span>
                  </label>
                  <input
                    type="number"
                    min="0"
                    step="0.001"
                    value={kpiData.inventoryAdjust[kpiInputMonth] ?? ''}
                    onChange={e => setKpiData(prev => ({
                      ...prev,
                      inventoryAdjust: {
                        ...prev.inventoryAdjust,
                        [kpiInputMonth]: e.target.value === '' ? undefined : parseFloat(e.target.value)
                      }
                    }))}
                    placeholder="예: 0.112"
                    className={`w-full px-3 py-2 border rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}
                  />
                </div>

                {/* 점수 미리보기 */}
                <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                  <p className="text-sm font-medium mb-2">점수 미리보기</p>
                  <div className="flex gap-4 text-sm">
                    <div>
                      <span className="text-gray-500">GR Cancel:</span>
                      <span className={`ml-2 font-bold ${
                        calculateKpiScore('grCancel', kpiData.grCancel[kpiInputMonth]) >= 80 ? 'text-emerald-600' :
                        calculateKpiScore('grCancel', kpiData.grCancel[kpiInputMonth]) >= 60 ? 'text-amber-600' :
                        'text-red-600'
                      }`}>
                        {calculateKpiScore('grCancel', kpiData.grCancel[kpiInputMonth]) ?? '-'}점
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-500">재고 손실율:</span>
                      <span className={`ml-2 font-bold ${
                        calculateKpiScore('inventoryAdjust', kpiData.inventoryAdjust[kpiInputMonth]) >= 80 ? 'text-emerald-600' :
                        calculateKpiScore('inventoryAdjust', kpiData.inventoryAdjust[kpiInputMonth]) >= 60 ? 'text-amber-600' :
                        'text-red-600'
                      }`}>
                        {calculateKpiScore('inventoryAdjust', kpiData.inventoryAdjust[kpiInputMonth]) ?? '-'}점
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div className="flex justify-end gap-2 mt-6">
                <button
                  onClick={() => setShowKpiInputModal(false)}
                  className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                >
                  닫기
                </button>
                <button
                  onClick={() => {
                    showToast(`${kpiInputMonth} KPI 데이터가 저장되었습니다.`, 'success');
                    setShowKpiInputModal(false);
                  }}
                  className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                >
                  저장
                </button>
              </div>
            </div>
          </div>
        )}

        {/* TO DO 리스트 */}
        {activeTab === 'todo' && (
          <div className="space-y-6">
            {/* 마감 임박 알림 배너 */}
            {showDueSoonAlert && dueSoonTodos.length > 0 && (
              <div className="bg-gradient-to-r from-red-500 to-orange-500 rounded-xl shadow-lg p-4 text-white">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-3xl">⏰</span>
                    <div>
                      <h3 className="font-bold text-lg">마감 임박 알림!</h3>
                      <p className="text-sm opacity-90">
                        {dueSoonTodos.filter(t => t.dueDate < new Date().toISOString().split('T')[0]).length > 0 && 
                          `⚠️ 기한 지남 ${dueSoonTodos.filter(t => t.dueDate < new Date().toISOString().split('T')[0]).length}개`}
                        {dueSoonTodos.filter(t => t.dueDate === new Date().toISOString().split('T')[0]).length > 0 && 
                          ` 🔴 오늘 마감 ${dueSoonTodos.filter(t => t.dueDate === new Date().toISOString().split('T')[0]).length}개`}
                      </p>
                    </div>
                  </div>
                  <button onClick={() => setShowDueSoonAlert(false)} className="text-white/80 hover:text-white">
                    <X className="w-6 h-6" />
                  </button>
                </div>
                <div className="mt-3 space-y-1">
                  {dueSoonTodos.slice(0, 3).map(todo => (
                    <div key={todo.id} className="bg-white/20 rounded px-3 py-2 text-sm flex items-center gap-2">
                      <span>{todo.priority === 'high' ? '🔴' : todo.priority === 'medium' ? '🟡' : '🟢'}</span>
                      <span className="flex-1">{todo.text}</span>
                      <span className="opacity-75">{todo.dueDate}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            <div className="bg-white rounded-xl shadow-sm p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold flex items-center gap-2">
                  <Check className="w-5 h-5" />
                  TO DO 리스트
                </h2>
                
                <div className="flex items-center gap-3">
                  {/* 뷰 전환 버튼 */}
                  <div className="flex bg-gray-100 rounded-lg p-1">
                    <button
                      onClick={() => setTodoViewMode('list')}
                      className={`flex items-center gap-1 px-3 py-1.5 rounded text-sm transition ${
                        todoViewMode === 'list' ? 'bg-white shadow text-indigo-600' : 'text-gray-600 hover:text-gray-900'
                      }`}
                    >
                      <List className="w-4 h-4" /> 리스트
                    </button>
                    <button
                      onClick={() => setTodoViewMode('calendar')}
                      className={`flex items-center gap-1 px-3 py-1.5 rounded text-sm transition ${
                        todoViewMode === 'calendar' ? 'bg-white shadow text-indigo-600' : 'text-gray-600 hover:text-gray-900'
                      }`}
                    >
                      <Calendar className="w-4 h-4" /> 캘린더
                    </button>
                  </div>
                  
                  {/* 엑셀 내보내기 */}
                  <button 
                    onClick={exportTodoList}
                    className="flex items-center gap-1 px-3 py-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
                  >
                    <Download className="w-4 h-4" /> 엑셀
                  </button>
                  
                  {/* 탭 알림 상태 */}
                  {dueSoonTodos.length > 0 ? (
                    <span className="text-sm text-orange-600 flex items-center gap-1 bg-orange-50 px-3 py-1 rounded-lg">
                      <Bell className="w-4 h-4" /> ({dueSoonTodos.length})개 알림
                    </span>
                  ) : (
                    <span className="text-sm text-green-600 flex items-center gap-1">
                      <Check className="w-4 h-4" /> 마감 임박 없음
                    </span>
                  )}
                </div>
              </div>
              
              {/* 새 할일 추가 */}
              <div className="bg-gray-50 rounded-lg p-4 mb-6">
                <div className="flex flex-wrap gap-3 items-center">
                  <input 
                    type="text" 
                    placeholder="새로운 할 일을 입력하세요..." 
                    className="flex-1 min-w-[200px] border rounded-lg px-4 py-2"
                    value={newTodo}
                    onChange={e => setNewTodo(e.target.value)}
                    onKeyPress={e => {
                      if (e.key === 'Enter' && newTodo.trim()) {
                        setTodoList([...todoList, {
                          id: Date.now(),
                          text: newTodo.trim(),
                          category: newTodoCategory,
                          priority: newTodoPriority,
                          completed: false,
                          createdAt: new Date().toISOString().split('T')[0],
                          dueDate: newTodoDueDate
                        }]);
                        setNewTodo('');
                        setNewTodoDueDate('');
                      }
                    }}
                  />
                  <select 
                    className="border rounded-lg px-3 py-2 text-sm"
                    value={newTodoCategory}
                    onChange={e => setNewTodoCategory(e.target.value)}
                  >
                    <option value="general">📋 일반</option>
                    <option value="data">📊 데이터</option>
                    <option value="process">⚙️ 프로세스</option>
                    <option value="kpi">📈 KPI</option>
                    <option value="system">💻 시스템</option>
                    <option value="idea">💡 아이디어</option>
                  </select>
                  <select 
                    className="border rounded-lg px-3 py-2 text-sm"
                    value={newTodoPriority}
                    onChange={e => setNewTodoPriority(e.target.value)}
                  >
                    <option value="high">🔴 높음</option>
                    <option value="medium">🟡 보통</option>
                    <option value="low">🟢 낮음</option>
                  </select>
                  <input 
                    type="date" 
                    className="border rounded-lg px-3 py-2 text-sm"
                    value={newTodoDueDate}
                    onChange={e => setNewTodoDueDate(e.target.value)}
                  />
                  <button 
                    className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2"
                    onClick={() => {
                      if (newTodo.trim()) {
                        setTodoList([...todoList, {
                          id: Date.now(),
                          text: newTodo.trim(),
                          category: newTodoCategory,
                          priority: newTodoPriority,
                          completed: false,
                          createdAt: new Date().toISOString().split('T')[0],
                          dueDate: newTodoDueDate
                        }]);
                        setNewTodo('');
                        setNewTodoDueDate('');
                      }
                    }}
                  >
                    <Plus className="w-4 h-4" /> 추가
                  </button>
                </div>
              </div>

              {/* 리스트 뷰 */}
              {todoViewMode === 'list' && (
                <>
                  {/* 필터 */}
                  <div className="flex gap-2 mb-4 flex-wrap">
                    {[
                      { id: 'active', label: '진행중' },
                      { id: 'all', label: '전체' },
                      { id: 'completed', label: '완료' },
                      { id: 'overdue', label: '⚠️ 기한 지남' },
                      { id: 'upcoming', label: '📅 7일 이내' },
                    ].map(f => (
                      <button 
                        key={f.id}
                        className={`px-3 py-1 rounded-lg text-sm ${todoFilter === f.id ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                        onClick={() => setTodoFilter(f.id)}
                      >
                        {f.label}
                        {f.id === 'overdue' && (() => {
                          const today = new Date().toISOString().split('T')[0];
                          const count = todoList.filter(t => !t.completed && t.dueDate && t.dueDate < today).length;
                          return count > 0 ? <span className="ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">{count}</span> : null;
                        })()}
                      </button>
                    ))}
                  </div>

                  {/* 할일 목록 */}
                  <div className="space-y-2">
                    {todoList
                      .filter(todo => {
                        const today = new Date().toISOString().split('T')[0];
                        const weekLater = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                        if (todoFilter === 'active') return !todo.completed;
                        if (todoFilter === 'completed') return todo.completed;
                        if (todoFilter === 'overdue') return !todo.completed && todo.dueDate && todo.dueDate < today;
                        if (todoFilter === 'upcoming') return !todo.completed && todo.dueDate && todo.dueDate >= today && todo.dueDate <= weekLater;
                        return true;
                      })
                      .sort((a, b) => {
                        const today = new Date().toISOString().split('T')[0];
                        const aOverdue = !a.completed && a.dueDate && a.dueDate < today;
                        const bOverdue = !b.completed && b.dueDate && b.dueDate < today;
                        if (aOverdue && !bOverdue) return -1;
                        if (!aOverdue && bOverdue) return 1;
                        const priorityOrder = { high: 0, medium: 1, low: 2 };
                        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                          return priorityOrder[a.priority] - priorityOrder[b.priority];
                        }
                        if (a.dueDate && b.dueDate) return a.dueDate.localeCompare(b.dueDate);
                        return 0;
                      })
                      .map(todo => {
                        const today = new Date().toISOString().split('T')[0];
                        const weekLater = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                        const isOverdue = !todo.completed && todo.dueDate && todo.dueDate < today;
                        const isUpcoming = !todo.completed && todo.dueDate && todo.dueDate >= today && todo.dueDate <= weekLater;
                        
                        return (
                          <div 
                            key={todo.id} 
                            className={`flex items-center gap-3 p-3 rounded-lg border ${
                              todo.completed ? 'bg-gray-50 border-gray-200' : 
                              isOverdue ? 'bg-red-50 border-red-300' :
                              isUpcoming ? 'border-orange-300' : 'border-gray-200'
                            }`}
                          >
                            <input 
                              type="checkbox" 
                              checked={todo.completed}
                              onChange={e => updateTodo(todo.id, 'completed', e.target.checked)}
                              className="w-5 h-5 rounded"
                            />
                            <input
                              type="text"
                              value={todo.text}
                              onChange={e => updateTodo(todo.id, 'text', e.target.value)}
                              className={`flex-1 bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded px-2 py-1 ${todo.completed ? 'line-through text-gray-400' : ''}`}
                            />
                            {isOverdue && <span className="text-red-500 text-sm">⚠️ 기한 지남</span>}
                            <select 
                              className={`px-2 py-1 rounded text-xs border-0 cursor-pointer ${
                                todo.category === 'data' ? 'bg-blue-100 text-blue-700' :
                                todo.category === 'process' ? 'bg-purple-100 text-purple-700' :
                                todo.category === 'kpi' ? 'bg-orange-100 text-orange-600' :
                                todo.category === 'system' ? 'bg-cyan-100 text-cyan-700' :
                                todo.category === 'idea' ? 'bg-pink-100 text-pink-700' :
                                'bg-gray-100 text-gray-700'
                              }`}
                              value={todo.category}
                              onChange={e => updateTodo(todo.id, 'category', e.target.value)}
                            >
                              <option value="general">📋 일반</option>
                              <option value="data">📊 데이터</option>
                              <option value="process">⚙️ 프로세스</option>
                              <option value="kpi">📈 KPI</option>
                              <option value="system">💻 시스템</option>
                              <option value="idea">💡 아이디어</option>
                            </select>
                            <select 
                              className="px-2 py-1 rounded text-xs border-0 cursor-pointer"
                              value={todo.priority}
                              onChange={e => updateTodo(todo.id, 'priority', e.target.value)}
                            >
                              <option value="high">🔴 높음</option>
                              <option value="medium">🟡 보통</option>
                              <option value="low">🟢 낮음</option>
                            </select>
                            <input 
                              type="date" 
                              className="border rounded px-2 py-1 text-xs"
                              value={todo.dueDate || ''}
                              onChange={e => updateTodo(todo.id, 'dueDate', e.target.value)}
                            />
                            <button 
                              onClick={() => setDeleteConfirm({ show: true, type: 'todo', id: todo.id, text: todo.text, count: 0 })}
                              className="text-red-500 hover:text-red-700 p-1"
                            >
                              <X className="w-4 h-4" />
                            </button>
                          </div>
                        );
                      })}
                  </div>

                  {/* 통계 */}
                  <div className="mt-6 pt-4 border-t flex flex-wrap justify-between gap-2 text-sm text-gray-500">
                    <span>총 {todoList.length}개</span>
                    <span>완료 {todoList.filter(t => t.completed).length}개</span>
                    <span>진행중 {todoList.filter(t => !t.completed).length}개</span>
                    <span className="text-red-500">⚠️ 기한 지남 {todoList.filter(t => !t.completed && t.dueDate && t.dueDate < new Date().toISOString().split('T')[0]).length}개</span>
                  </div>
                </>
              )}

              {/* 캘린더 뷰 */}
              {todoViewMode === 'calendar' && (
                <div className="mt-4">
                  {/* 캘린더 헤더 */}
                  <div className="flex items-center justify-between mb-4">
                    <button 
                      onClick={() => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1))}
                      className="p-2 hover:bg-gray-100 rounded-lg"
                    >
                      <ChevronLeft className="w-5 h-5" />
                    </button>
                    <h3 className="text-lg font-semibold">
                      {calendarMonth.getFullYear()}년 {calendarMonth.getMonth() + 1}월
                    </h3>
                    <button 
                      onClick={() => setCalendarMonth(new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1))}
                      className="p-2 hover:bg-gray-100 rounded-lg"
                    >
                      <ChevronRight className="w-5 h-5" />
                    </button>
                  </div>

                  {/* 요일 헤더 */}
                  <div className="grid grid-cols-7 gap-1 mb-2">
                    {['일', '월', '화', '수', '목', '금', '토'].map((day, i) => (
                      <div key={day} className={`text-center text-sm font-medium py-2 ${i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-gray-600'}`}>
                        {day}
                      </div>
                    ))}
                  </div>

                  {/* 캘린더 그리드 */}
                  <div className="grid grid-cols-7 gap-1">
                    {(() => {
                      const year = calendarMonth.getFullYear();
                      const month = calendarMonth.getMonth();
                      const firstDay = new Date(year, month, 1).getDay();
                      const lastDate = new Date(year, month + 1, 0).getDate();
                      const today = new Date().toISOString().split('T')[0];
                      
                      const days = [];
                      
                      for (let i = 0; i < firstDay; i++) {
                        days.push(<div key={`empty-${i}`} className="min-h-[100px] bg-gray-50 rounded"></div>);
                      }
                      
                      for (let date = 1; date <= lastDate; date++) {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        const dayTodos = todoList.filter(t => t.dueDate === dateStr);
                        const isToday = dateStr === today;
                        const dayOfWeek = new Date(year, month, date).getDay();
                        
                        days.push(
                          <div 
                            key={date} 
                            className={`min-h-[100px] border rounded-lg p-1 ${
                              isToday ? 'bg-indigo-50 border-indigo-300' : 'bg-white border-gray-200'
                            }`}
                          >
                            <div className={`text-sm font-medium mb-1 ${
                              isToday ? 'text-indigo-600' : 
                              dayOfWeek === 0 ? 'text-red-500' : 
                              dayOfWeek === 6 ? 'text-blue-500' : 'text-gray-700'
                            }`}>
                              {date}
                              {isToday && <span className="ml-1 text-xs bg-indigo-600 text-white px-1 rounded">오늘</span>}
                            </div>
                            <div className="space-y-0.5 overflow-y-auto max-h-[70px]">
                              {dayTodos.map(todo => (
                                <div 
                                  key={todo.id}
                                  className={`text-xs p-1 rounded truncate cursor-pointer hover:opacity-80 ${
                                    todo.completed 
                                      ? 'bg-gray-100 text-gray-400 line-through' 
                                      : todo.priority === 'high'
                                        ? 'bg-red-100 text-red-700'
                                        : todo.priority === 'medium'
                                          ? 'bg-yellow-100 text-yellow-700'
                                          : 'bg-green-100 text-green-700'
                                  }`}
                                  title="클릭하여 상세보기"
                                  onClick={() => setSelectedCalendarTodo(todo)}
                                >
                                  {todo.completed ? '✓ ' : ''}{todo.text}
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      }
                      
                      return days;
                    })()}
                  </div>

                  {/* 범례 */}
                  <div className="mt-4 flex gap-4 justify-center text-xs">
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-red-100 rounded"></span> 높음</span>
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-yellow-100 rounded"></span> 보통</span>
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-green-100 rounded"></span> 낮음</span>
                    <span className="flex items-center gap-1"><span className="w-3 h-3 bg-gray-100 rounded"></span> 완료</span>
                  </div>
                </div>
              )}
            </div>

            {/* 카테고리별 요약 */}
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              {[
                { id: 'general', label: '일반', icon: '📋', color: 'gray' },
                { id: 'data', label: '데이터', icon: '📊', color: 'blue' },
                { id: 'process', label: '프로세스', icon: '⚙️', color: 'purple' },
                { id: 'kpi', label: 'KPI', icon: '📈', color: 'orange' },
                { id: 'system', label: '시스템', icon: '💻', color: 'cyan' },
                { id: 'idea', label: '아이디어', icon: '💡', color: 'pink' },
              ].map(cat => {
                const activeTodos = todoList.filter(t => t.category === cat.id && !t.completed);
                const completedTodos = todoList.filter(t => t.category === cat.id && t.completed);
                const count = activeTodos.length;
                return (
                  <div 
                    key={cat.id} 
                    className={`bg-white rounded-xl shadow-sm p-4 text-center border-t-4 border-${cat.color}-400 cursor-pointer hover:shadow-md transition transform hover:-translate-y-1`}
                    onClick={() => setSelectedCategory({ ...cat, activeTodos, completedTodos })}
                  >
                    <div className="text-2xl mb-1">{cat.icon}</div>
                    <div className="font-medium text-gray-700">{cat.label}</div>
                    <div className={`text-2xl font-bold text-${cat.color}-600`}>{count}</div>
                    <div className="text-xs text-gray-400">진행중</div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* 공간 분석 상세 모달 */}
        {spaceAnalysisModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div className="bg-white rounded-xl shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
              {/* 고정 헤더 */}
              <div className="flex justify-between items-center p-6 border-b sticky top-0 bg-white rounded-t-xl z-10">
                <h3 className="font-semibold text-lg">
                  {spaceAnalysisModal.type === 'over' && '📦 과다 재고 모델 상세'}
                  {spaceAnalysisModal.type === 'ok' && '✅ 적정 재고 모델 상세'}
                  {spaceAnalysisModal.type === 'warning' && '⚠️ 부족 주의 모델 상세'}
                  {spaceAnalysisModal.type === 'shortage' && '🚨 부족 긴급 모델 상세'}
                  <span className="text-sm font-normal text-gray-500 ml-2">({spaceAnalysisModal.data.length}개 모델)</span>
                </h3>
                <button 
                  onClick={() => setSpaceAnalysisModal(null)}
                  className="p-2 hover:bg-gray-100 rounded-lg"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              {/* 스크롤 가능한 콘텐츠 */}
              <div className="overflow-y-auto flex-1 p-6">
                <table className="w-full text-sm">
                  <thead className={`sticky top-0 ${
                    spaceAnalysisModal.type === 'over' ? 'bg-purple-50' :
                    spaceAnalysisModal.type === 'ok' ? 'bg-emerald-50' :
                    spaceAnalysisModal.type === 'warning' ? 'bg-amber-50' : 'bg-red-50'
                  }`}>
                    <tr>
                      <th className="px-3 py-2 text-left">모델</th>
                      <th className="px-3 py-2 text-right">현재 재고</th>
                      <th className="px-3 py-2 text-right">적정 범위</th>
                      <th className="px-3 py-2 text-left">병목 자재</th>
                      <th className="px-3 py-2 text-left">제안</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {spaceAnalysisModal.data.map(item => {
                      const bottleneck = producibleUnits[item.model]?.bottleneck;
                      return (
                        <tr key={item.model} className="hover:bg-gray-50">
                          <td className="px-3 py-2 font-medium">{item.model}</td>
                          <td className="px-3 py-2 text-right font-bold">{item.current}대</td>
                          <td className="px-3 py-2 text-right text-gray-600">{item.min}~{item.max}대</td>
                          <td className="px-3 py-2 text-gray-600 text-xs">
                            {bottleneck ? `${bottleneck.material} (${bottleneck.currentStock} EA)` : '-'}
                          </td>
                          <td className="px-3 py-2">
                            {item.status === 'over' && (
                              <span className="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded">📅 발주 연기</span>
                            )}
                            {item.status === 'ok' && (
                              <span className="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs rounded">✅ 적정</span>
                            )}
                            {item.status === 'warning' && (
                              <span className="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded">⚠️ 모니터링</span>
                            )}
                            {item.status === 'shortage' && (
                              <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded">🛒 발주 필요</span>
                            )}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              
              {/* 고정 푸터 */}
              <div className="p-4 border-t bg-gray-50 rounded-b-xl">
                <button 
                  onClick={() => setSpaceAnalysisModal(null)}
                  className="w-full py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium"
                >
                  닫기
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Bin 품목 상세 모달 */}
        {binDetailModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-xl w-full max-w-4xl flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }}>
              {/* 고정 헤더 */}
              <div className="flex justify-between items-center p-6 border-b bg-white rounded-t-xl flex-shrink-0">
                <div>
                  <h3 className="font-semibold text-lg flex items-center gap-2">
                    📦 {binDetailModal.bin} 품목 상세
                    <span className={`px-2 py-0.5 text-xs rounded ${
                      (binDetailModal.data.stock / binDetailModal.BIN_CAPACITY) > 2 ? 'bg-red-500 text-white' :
                      (binDetailModal.data.stock / binDetailModal.BIN_CAPACITY) > 1.5 ? 'bg-orange-400 text-white' :
                      'bg-orange-200 text-orange-800'
                    }`}>
                      {((binDetailModal.data.stock / binDetailModal.BIN_CAPACITY) * 100).toFixed(0)}%
                    </span>
                  </h3>
                  <p className="text-sm text-gray-500 mt-1">
                    총 재고: {binDetailModal.data.stock.toLocaleString()} EA | 
                    적정: {binDetailModal.BIN_CAPACITY} EA | 
                    초과: <span className="text-orange-600 font-medium">+{(binDetailModal.data.stock - binDetailModal.BIN_CAPACITY).toLocaleString()} EA</span>
                  </p>
                </div>
                <button 
                  onClick={() => setBinDetailModal(null)}
                  className="p-2 hover:bg-gray-100 rounded-lg"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              {/* 스크롤 가능한 콘텐츠 */}
              <div className="overflow-y-auto flex-1 min-h-0">
                <table className="w-full text-sm">
                  <thead className="sticky top-0 bg-orange-50 z-10">
                    <tr>
                      <th className="px-4 py-3 text-left">Part No.</th>
                      <th className="px-4 py-3 text-left">Description</th>
                      <th className="px-4 py-3 text-right">Qty (재고)</th>
                      <th className="px-4 py-3 text-right">과적 수량</th>
                      <th className="px-4 py-3 text-right">과적률</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {binDetailModal.data.items
                      .sort((a, b) => (b.stock || 0) - (a.stock || 0))
                      .map((item, idx) => {
                        // 품목별 과적 수량 계산 (비율 기준)
                        const itemRatio = (item.stock || 0) / binDetailModal.data.stock;
                        const totalOver = binDetailModal.data.stock - binDetailModal.BIN_CAPACITY;
                        const itemOver = Math.round(itemRatio * totalOver);
                        const itemOverPercent = totalOver > 0 ? ((item.stock || 0) / binDetailModal.BIN_CAPACITY * 100).toFixed(0) : 0;
                        
                        return (
                          <tr key={idx} className="hover:bg-orange-50/50">
                            <td className="px-4 py-3 font-medium">{item.material}</td>
                            <td className="px-4 py-3 text-gray-600 truncate max-w-xs" title={item.description}>
                              {item.description?.slice(0, 35) || '-'}
                            </td>
                            <td className="px-4 py-3 text-right font-bold">{(item.stock || 0).toLocaleString()} EA</td>
                            <td className="px-4 py-3 text-right">
                              {itemOver > 0 ? (
                                <span className="text-orange-600 font-medium">+{itemOver.toLocaleString()} EA</span>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                            </td>
                            <td className="px-4 py-3 text-right">
                              <span className={`px-2 py-0.5 rounded text-xs ${
                                itemOverPercent > 100 ? 'bg-red-100 text-red-700' :
                                itemOverPercent > 50 ? 'bg-orange-100 text-orange-700' :
                                'bg-gray-100 text-gray-600'
                              }`}>
                                {itemOverPercent}%
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                  </tbody>
                </table>
              </div>
              
              {/* 고정 푸터 */}
              <div className="p-4 border-t bg-gray-50 rounded-b-xl flex-shrink-0">
                <button 
                  onClick={() => setBinDetailModal(null)}
                  className="w-full py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium"
                >
                  닫기
                </button>
              </div>
            </div>
          </div>
        )}
      </main>

      {/* 통합 데이터 관리 모달 */}
      {showDataUploadModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl flex flex-col" style={{ maxHeight: '90vh' }}>
            {/* 헤더 - 고정 */}
            <div className="flex justify-between items-center p-6 border-b flex-shrink-0">
              <h3 className="font-semibold text-xl flex items-center gap-2">
                <Database className="w-6 h-6 text-indigo-600" />
                데이터 관리
              </h3>
              <button onClick={() => setShowDataUploadModal(false)} className="p-1 hover:bg-gray-100 rounded"><X className="w-6 h-6" /></button>
            </div>
            
            {/* 컨텐츠 - 스크롤 */}
            <div className="flex-1 overflow-y-auto p-6">
            {/* 업데이트 현황 */}
            <div className="mb-6 p-4 bg-slate-50 rounded-lg">
              <p className="text-sm font-medium text-gray-700 mb-3">📊 데이터 업데이트 현황</p>
              <div className="grid grid-cols-3 gap-4 text-sm">
                <div className={`p-3 rounded-lg ${lastUpdated ? 'bg-emerald-50 border border-emerald-200' : 'bg-gray-100'}`}>
                  <p className="text-xs text-gray-500 mb-1">SAP Stock</p>
                  <p className={`font-medium ${lastUpdated ? 'text-emerald-700' : 'text-gray-400'}`}>
                    {lastUpdated ? lastUpdated.replace(/^20(\d{2})/, '$1') : '미업로드'}
                  </p>
                </div>
                <div className={`p-3 rounded-lg ${openPOLastUpdated ? 'bg-amber-50 border border-amber-200' : 'bg-gray-100'}`}>
                  <p className="text-xs text-gray-500 mb-1">Open PO</p>
                  <p className={`font-medium ${openPOLastUpdated ? 'text-amber-700' : 'text-gray-400'}`}>
                    {openPOLastUpdated ? openPOLastUpdated.replace(/^20(\d{2})/, '$1') : '미업로드'}
                  </p>
                </div>
                <div className={`p-3 rounded-lg ${bomLastUpdated ? 'bg-purple-50 border border-purple-200' : 'bg-gray-100'}`}>
                  <p className="text-xs text-gray-500 mb-1">BOM</p>
                  <p className={`font-medium ${bomLastUpdated ? 'text-purple-700' : 'text-gray-400'}`}>
                    {bomLastUpdated ? bomLastUpdated.replace(/^20(\d{2})/, '$1') : '기본값'}
                  </p>
                </div>
              </div>
            </div>

            {/* 업로드 섹션들 */}
            <div className="space-y-4">
              {/* SAP Stock 업로드 */}
              <div 
                className="border-2 border-dashed rounded-xl p-4 hover:border-emerald-400 transition"
                onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-emerald-500', 'bg-emerald-50'); }}
                onDragLeave={(e) => { e.preventDefault(); e.currentTarget.classList.remove('border-emerald-500', 'bg-emerald-50'); }}
                onDrop={(e) => {
                  e.preventDefault();
                  e.currentTarget.classList.remove('border-emerald-500', 'bg-emerald-50');
                  const file = e.dataTransfer.files[0];
                  if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    setShowDataUploadModal(false);
                    setShowUploadModal(true);
                    setTimeout(() => {
                      const input = document.getElementById('fileInput');
                      if (input) {
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        input.files = dt.files;
                        handleFileSelect({ target: { files: [file] } });
                      }
                    }, 100);
                  } else {
                    alert('xlsx 또는 xls 파일만 업로드 가능합니다.');
                  }
                }}
              >
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                      <Upload className="w-5 h-5 text-emerald-600" />
                    </div>
                    <div>
                      <p className="font-medium text-gray-800">SAP Stock 업로드</p>
                      <p className="text-xs text-gray-500">Zbindata_latest.xlsx</p>
                    </div>
                  </div>
                  <label className="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg cursor-pointer transition text-sm font-medium">
                    파일 선택
                    <input type="file" accept=".xlsx,.xls" onChange={(e) => {
                      const file = e.target.files[0];
                      if (file) {
                        setShowDataUploadModal(false);
                        setShowUploadModal(true);
                        setTimeout(() => {
                          const input = document.getElementById('fileInput');
                          if (input) {
                            const dt = new DataTransfer();
                            dt.items.add(file);
                            input.files = dt.files;
                            handleFileSelect({ target: { files: [file] } });
                          }
                        }, 100);
                      }
                    }} className="hidden" />
                  </label>
                </div>
                <p className="text-xs text-gray-400 text-center mb-2">또는 파일을 여기로 드래그하세요</p>
                <a 
                  href="https://promega-my.sharepoint.com/:f:/p/jimin_jung/IgA_AwP1xtjuS4G9pD9RQZD2AelK_uC-h4A9YaW6Jy68kuc?e=GU2XLo"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-700"
                >
                  <ExternalLink className="w-4 h-4" />
                  OneDrive 폴더 열기
                </a>
              </div>

              {/* Open PO 업로드 */}
              <div 
                className="border-2 border-dashed rounded-xl p-4 hover:border-amber-400 transition"
                onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-amber-500', 'bg-amber-50'); }}
                onDragLeave={(e) => { e.preventDefault(); e.currentTarget.classList.remove('border-amber-500', 'bg-amber-50'); }}
                onDrop={(e) => {
                  e.preventDefault();
                  e.currentTarget.classList.remove('border-amber-500', 'bg-amber-50');
                  const file = e.dataTransfer.files[0];
                  if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    parseOpenPOFile(file);
                    setShowDataUploadModal(false);
                  } else {
                    alert('xlsx 또는 xls 파일만 업로드 가능합니다.');
                  }
                }}
              >
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                      <FileSpreadsheet className="w-5 h-5 text-amber-600" />
                    </div>
                    <div>
                      <p className="font-medium text-gray-800">Open PO 업로드</p>
                      <p className="text-xs text-gray-500">납품 예정 자재 데이터</p>
                    </div>
                  </div>
                  <label className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg cursor-pointer transition text-sm font-medium">
                    파일 선택
                    <input type="file" accept=".xlsx,.xls" onChange={(e) => {
                      const file = e.target.files[0];
                      if (file) {
                        parseOpenPOFile(file);
                        setShowDataUploadModal(false);
                      }
                      e.target.value = '';
                    }} className="hidden" />
                  </label>
                </div>
                <p className="text-xs text-gray-400 text-center mb-2">또는 파일을 여기로 드래그하세요</p>
                <p className="text-xs text-gray-500">필수 컬럼: Material, Order Quantity, Order Unit, Document Number</p>
              </div>

              {/* BOM 업로드 */}
              <div 
                className="border-2 border-dashed rounded-xl p-4 hover:border-purple-400 transition"
                onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-purple-500', 'bg-purple-50'); }}
                onDragLeave={(e) => { e.preventDefault(); e.currentTarget.classList.remove('border-purple-500', 'bg-purple-50'); }}
                onDrop={(e) => {
                  e.preventDefault();
                  e.currentTarget.classList.remove('border-purple-500', 'bg-purple-50');
                  const file = e.dataTransfer.files[0];
                  if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    handleBOMFileSelect({ target: { files: [file] } });
                    setShowDataUploadModal(false);
                  } else {
                    alert('xlsx 또는 xls 파일만 업로드 가능합니다.');
                  }
                }}
              >
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                      <Package className="w-5 h-5 text-purple-600" />
                    </div>
                    <div>
                      <p className="font-medium text-gray-800">BOM 업로드</p>
                      <p className="text-xs text-gray-500">모델별 자재 소요량</p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <label className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg cursor-pointer transition text-sm font-medium">
                      파일 선택
                      <input type="file" accept=".xlsx,.xls" onChange={(e) => {
                        handleBOMFileSelect(e);
                        setShowDataUploadModal(false);
                      }} className="hidden" />
                    </label>
                  </div>
                </div>
                <p className="text-xs text-gray-400 text-center mb-2">또는 파일을 여기로 드래그하세요</p>
                <div className="text-xs text-gray-500 space-y-1">
                  <p>• 컬럼: Component number (Part No.), Comp. Qty (CUn) (수량)</p>
                  <p>• Phantom item = X 인 품목은 자동 제외</p>
                  <p>• Item category = L 인 품목만 포함 (D, T 제외)</p>
                  <p>• 시트 탭: AS/A2715 → 완제품, KB → Sub-component</p>
                  <p>• 현재: {customBomData 
                    ? `📦 완제품 ${Object.keys(customBomData).length}개 모델` + 
                      (subComponentBomData ? ` | 🔧 Sub-com ${Object.keys(subComponentBomData).length}개` : '')
                    : '기본 BOM 사용 중'}</p>
                </div>
              </div>

              {/* 무게 정보 */}
              <div className="border-2 border-dashed rounded-xl p-4 hover:border-slate-400 transition">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center">
                      <Scale className="w-5 h-5 text-slate-600" />
                    </div>
                    <div>
                      <p className="font-medium text-gray-800">무게 정보</p>
                      <p className="text-xs text-gray-500">Material별 무게(g) 관리 • {Object.keys(weightData).length}개 품목</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => { setShowDataUploadModal(false); setActiveTab('weight'); }}
                    className="px-4 py-2 bg-slate-500 hover:bg-slate-600 text-white rounded-lg transition text-sm font-medium"
                  >
                    상세 보기
                  </button>
                </div>
                <div className="text-xs text-gray-500 space-y-1">
                  <p>• Material별 무게(g) 조회/수정/추가</p>
                  <p>• Kitting 완료 시 총 무게 계산에 사용</p>
                </div>
              </div>

              {/* 재고 목록 */}
              <div className="border-2 border-dashed rounded-xl p-4 hover:border-blue-400 transition">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                      <FileSpreadsheet className="w-5 h-5 text-blue-600" />
                    </div>
                    <div>
                      <p className="font-medium text-gray-800">재고 목록</p>
                      <p className="text-xs text-gray-500">SAP 재고 현황 조회 • {inventoryData.length}개 품목</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => { setShowDataUploadModal(false); setActiveTab('inventory'); }}
                    className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition text-sm font-medium"
                  >
                    상세 보기
                  </button>
                </div>
                <div className="text-xs text-gray-500 space-y-1">
                  <p>• Material별 재고 수량, Bin 위치 조회</p>
                  <p>• 품번/품명 검색 기능</p>
                </div>
              </div>
            </div>
            </div>

            {/* 푸터 - 고정 */}
            <div className="flex justify-end p-6 border-t flex-shrink-0 bg-gray-50">
              <button 
                onClick={() => setShowDataUploadModal(false)}
                className="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Upload Modal */}
      {showUploadModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg m-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">SAP 재고 데이터 업로드</h3>
              <button onClick={() => setShowUploadModal(false)}><X className="w-5 h-5" /></button>
            </div>
            
            {/* OneDrive 폴더 열기 버튼 */}
            <div className="mb-4">
              <a 
                href="https://promega-my.sharepoint.com/:f:/p/jimin_jung/IgA_AwP1xtjuS4G9pD9RQZD2AelK_uC-h4A9YaW6Jy68kuc?e=GU2XLo"
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center justify-center gap-2 w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition font-medium"
              >
                <ExternalLink className="w-5 h-5" />
                📂 OneDrive 폴더 열기 (Zbindata_latest.xlsx)
              </a>
              <p className="text-xs text-gray-500 text-center mt-2">
                💡 폴더 열기 → 파일을 아래 영역으로 드래그 앤 드롭!
              </p>
            </div>

            <div 
              className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-indigo-400 transition cursor-pointer"
              onDrop={handleDrop}
              onDragOver={e => e.preventDefault()}
              onClick={() => document.getElementById('fileInput').click()}
            >
              {isLoading ? (
                <div className="flex flex-col items-center">
                  <RefreshCw className="w-12 h-12 text-indigo-500 animate-spin mb-4" />
                  <p className="text-gray-600">파일 처리 중...</p>
                </div>
              ) : (
                <>
                  <Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                  <p className="text-gray-600 mb-2">SAP 엑셀 파일을 드래그하거나 클릭하여 선택</p>
                  <p className="text-sm text-gray-400">지원 형식: .xlsx, .xls</p>
                </>
              )}
              <input 
                id="fileInput"
                type="file" 
                accept=".xlsx,.xls" 
                onChange={handleFileSelect}
                className="hidden" 
              />
            </div>

            {uploadError && (
              <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                {uploadError}
              </div>
            )}

            <div className="mt-6 p-4 bg-slate-50 rounded-lg">
              <p className="text-sm font-medium text-gray-700 mb-2">📋 SAP 엑셀 형식 안내</p>
              <ul className="text-xs text-gray-500 space-y-1">
                <li>• <strong>Description이 비어있는 행 (노란색)</strong>의 총 재고를 인식합니다</li>
                <li>• Storage Bin 정보는 Description이 있는 행에서 매핑합니다</li>
                <li>• Production Order Bin (숫자 시작)은 자동 제외됩니다</li>
              </ul>
            </div>

            {lastUpdated && (
              <div className="mt-4 flex justify-between items-center">
                <p className="text-sm text-gray-500">현재 데이터: {lastUpdated}</p>
                <button onClick={clearData} className="text-sm text-red-500 hover:text-red-700">데이터 초기화</button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Open PO Upload Modal */}
      {showOpenPOModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg m-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">📦 Open PO 업로드 (납품 예정 자재)</h3>
              <button onClick={() => setShowOpenPOModal(false)}><X className="w-5 h-5" /></button>
            </div>
            
            <div 
              className="border-2 border-dashed border-amber-300 rounded-xl p-8 text-center hover:border-amber-500 transition cursor-pointer bg-amber-50/30"
              onDrop={handleOpenPODrop}
              onDragOver={e => e.preventDefault()}
              onClick={() => document.getElementById('openPOFileInput').click()}
            >
              {isLoading ? (
                <div className="flex flex-col items-center">
                  <RefreshCw className="w-12 h-12 text-amber-500 animate-spin mb-4" />
                  <p className="text-gray-600">파일 처리 중...</p>
                </div>
              ) : (
                <>
                  <FileSpreadsheet className="w-12 h-12 text-amber-400 mx-auto mb-4" />
                  <p className="text-gray-600 mb-2">Open PO 엑셀 파일을 드래그하거나 클릭하여 선택</p>
                  <p className="text-sm text-gray-400">지원 형식: .xlsx, .xls</p>
                </>
              )}
              <input 
                id="openPOFileInput"
                type="file" 
                accept=".xlsx,.xls" 
                onChange={handleOpenPOFileSelect}
                className="hidden" 
              />
            </div>

            {openPOError && (
              <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                {openPOError}
              </div>
            )}

            <div className="mt-6 p-4 bg-amber-50 rounded-lg">
              <p className="text-sm font-medium text-gray-700 mb-2">📋 Open PO 엑셀 형식 안내</p>
              <ul className="text-xs text-gray-500 space-y-1">
                <li>• <strong>Still to be delivered (qty) &gt; 0</strong>인 항목만 인식됩니다</li>
                <li>• Material (M열), Short Text (N열)에서 자재 정보를 읽습니다</li>
                <li>• 동일 자재의 납품 예정 수량은 자동 합산됩니다</li>
              </ul>
            </div>

            {openPOLastUpdated && (
              <div className="mt-4 flex justify-between items-center">
                <p className="text-sm text-gray-500">현재 데이터: {openPOLastUpdated}</p>
                <div className="flex items-center gap-4">
                  <span className="text-sm text-amber-600 font-medium">{openPOData.length}개 자재</span>
                  <button 
                    onClick={() => {
                      setOpenPOData([]);
                      setOpenPOLastUpdated(null);
                      safeStorage.removeItem('pbk_open_po');
                      safeStorage.removeItem('pbk_open_po_updated');
                    }} 
                    className="text-sm text-red-500 hover:text-red-700"
                  >
                    초기화
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Pick Modal */}
      {showPickModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">새 불출 기록</h3>
              <button onClick={() => setShowPickModal(false)}><X className="w-5 h-5" /></button>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Production Order</label>
                <input type="text" placeholder="예: 1000012345" className="w-full border rounded-lg px-3 py-2"
                  value={newPick.productionOrder} onChange={e => setNewPick({...newPick, productionOrder: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Model</label>
                <select className="w-full border rounded-lg px-3 py-2" value={newPick.model} onChange={e => setNewPick({...newPick, model: e.target.value})}>
                  <option value="RSC48">RSC48</option>
                  <option value="CSC48">CSC48</option>
                  <option value="RSC16">RSC16</option>
                  <option value="CSC16">CSC16</option>
                  <option value="FSC16">FSC16</option>
                  <option value="HSM3.0">HSM3.0</option>
                  <option value="Spare Parts">Spare Parts</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">담당자</label>
                <select className="w-full border rounded-lg px-3 py-2" value={newPick.worker} onChange={e => setNewPick({...newPick, worker: e.target.value})}>
                  <option value="Z01">Z01</option>
                  <option value="Z02">Z02</option>
                  <option value="Z03">Z03</option>
                  <option value="Z04">Z04</option>
                  <option value="Z06">Z06</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Pick List 수령 시각</label>
                <input type="datetime-local" className="w-full border rounded-lg px-3 py-2"
                  onChange={e => setNewPick({...newPick, received: e.target.value.replace('T', ' ')})} />
              </div>
              <div className="flex items-center gap-3">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input 
                    type="checkbox" 
                    checked={newPick.isUrgent} 
                    onChange={e => setNewPick({...newPick, isUrgent: e.target.checked})}
                    className="w-5 h-5 text-red-600 rounded"
                  />
                  <span className="text-sm font-medium text-red-600">🚨 긴급</span>
                </label>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={() => setShowPickModal(false)} className="flex-1 px-4 py-2 border rounded-lg">취소</button>
              <button onClick={addPick} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg">추가</button>
            </div>
          </div>
        </div>
      )}

      {/* Receive Modal */}
      {showReceiveModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">새 입고 기록</h3>
              <button onClick={() => { setShowReceiveModal(false); setShowVendorSuggestions(false); }}><X className="w-5 h-5" /></button>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">No.</label>
                <input type="text" className="w-full border rounded-lg px-3 py-2 bg-gray-100" readOnly
                  value={(() => {
                    const maxNo = receiveCycles.reduce((max, r) => {
                      const num = parseInt(r.poNo) || 0;
                      return num > max ? num : max;
                    }, 0);
                    return maxNo + 1;
                  })()} />
              </div>
              <div className="relative">
                <label className="block text-sm font-medium text-gray-700 mb-1">협력업체</label>
                <input 
                  type="text" 
                  placeholder="업체명 입력 (자동완성)" 
                  className="w-full border rounded-lg px-3 py-2"
                  value={newReceive.vendor} 
                  onChange={e => {
                    setNewReceive({...newReceive, vendor: e.target.value});
                    setShowVendorSuggestions(true);
                  }}
                  onFocus={() => setShowVendorSuggestions(true)}
                  onBlur={() => setTimeout(() => setShowVendorSuggestions(false), 200)}
                />
                {showVendorSuggestions && filteredVendorSuggestions.length > 0 && (
                  <div className="absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto">
                    {filteredVendorSuggestions.map((vendor, idx) => (
                      <button
                        key={idx}
                        className="w-full text-left px-3 py-2 hover:bg-indigo-50 text-sm"
                        onClick={() => {
                          setNewReceive({...newReceive, vendor});
                          setShowVendorSuggestions(false);
                        }}
                      >
                        {vendor}
                      </button>
                    ))}
                  </div>
                )}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">납품 시각</label>
                <input type="text" className="w-full border rounded-lg px-3 py-2 bg-gray-100" readOnly
                  value={new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\. /g, '-').replace('.', '')} />
              </div>
            </div>
            <p className="text-xs text-gray-400 mt-3">💡 단축키: Ctrl+M (새 입고)</p>
            <div className="flex gap-3 mt-4">
              <button onClick={() => { setShowReceiveModal(false); setShowVendorSuggestions(false); }} className="flex-1 px-4 py-2 border rounded-lg">취소</button>
              <button onClick={addReceive} className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg">추가</button>
            </div>
          </div>
        </div>
      )}

      {/* New Material Modal */}
      {showWeightModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">신규 Material 추가</h3>
              <button onClick={() => setShowWeightModal(false)}><X className="w-5 h-5" /></button>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Material (품번) *</label>
                <input type="text" placeholder="예: 712626" className="w-full border rounded-lg px-3 py-2"
                  value={newMaterial.material} onChange={e => setNewMaterial({...newMaterial, material: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Description (품명)</label>
                <input type="text" placeholder="예: LED INDICATOR BRACKET" className="w-full border rounded-lg px-3 py-2"
                  value={newMaterial.desc} onChange={e => setNewMaterial({...newMaterial, desc: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">무게 (g)</label>
                <input type="number" step="0.1" placeholder="예: 244" className="w-full border rounded-lg px-3 py-2"
                  value={newMaterial.weight} onChange={e => setNewMaterial({...newMaterial, weight: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Storage Bin</label>
                <input type="text" placeholder="예: A1-01" className="w-full border rounded-lg px-3 py-2"
                  value={newMaterial.bin} onChange={e => setNewMaterial({...newMaterial, bin: e.target.value})} />
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={() => setShowWeightModal(false)} className="flex-1 px-4 py-2 border rounded-lg">취소</button>
              <button onClick={addNewMaterial} className="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg">추가</button>
            </div>
          </div>
        </div>
      )}

      {/* Pick 수정 모달 */}
      {editingPick && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">불출 기록 수정</h3>
              <button onClick={() => setEditingPick(null)}><X className="w-5 h-5" /></button>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Production Order</label>
                <input type="text" className="w-full border rounded-lg px-3 py-2"
                  value={editingPick.productionOrder || editingPick.orderId || ''} 
                  onChange={e => setEditingPick({...editingPick, productionOrder: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Model</label>
                <select className="w-full border rounded-lg px-3 py-2" value={editingPick.model} onChange={e => setEditingPick({...editingPick, model: e.target.value})}>
                  <option value="RSC48">RSC48</option>
                  <option value="CSC48">CSC48</option>
                  <option value="RSC16">RSC16</option>
                  <option value="CSC16">CSC16</option>
                  <option value="FSC16">FSC16</option>
                  <option value="HSM3.0">HSM3.0</option>
                  <option value="Spare Parts">Spare Parts</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">담당자</label>
                <select className="w-full border rounded-lg px-3 py-2" value={editingPick.worker || 'Z01'} onChange={e => setEditingPick({...editingPick, worker: e.target.value})}>
                  <option value="Z01">Z01</option>
                  <option value="Z02">Z02</option>
                  <option value="Z03">Z03</option>
                  <option value="Z04">Z04</option>
                  <option value="Z06">Z06</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Material Description</label>
                <input type="text" className="w-full border rounded-lg px-3 py-2"
                  value={editingPick.materialDesc || ''} 
                  onChange={e => setEditingPick({...editingPick, materialDesc: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">시작예정일</label>
                <input type="date" className="w-full border rounded-lg px-3 py-2"
                  value={editingPick.basicStartDate || ''} 
                  onChange={e => setEditingPick({...editingPick, basicStartDate: e.target.value})} />
              </div>
              <div className="flex items-center gap-3">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input 
                    type="checkbox" 
                    checked={editingPick.isUrgent || false} 
                    onChange={e => setEditingPick({...editingPick, isUrgent: e.target.checked})}
                    className="w-5 h-5 text-red-600 rounded"
                  />
                  <span className="text-sm font-medium text-red-600">🚨 긴급</span>
                </label>
              </div>
              <div className="border-t pt-4">
                <p className="text-sm font-medium text-gray-500 mb-3">⏱️ 타이머 정보</p>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">시작 시간</label>
                    <input type="datetime-local" className="w-full border rounded-lg px-3 py-2 text-sm"
                      value={editingPick.startTime ? (() => { const d=new Date(editingPick.startTime); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); })() : ''} 
                      onChange={e => setEditingPick({...editingPick, startTime: e.target.value ? new Date(e.target.value).toISOString() : null})} />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">완료 시간</label>
                    <input type="datetime-local" className="w-full border rounded-lg px-3 py-2 text-sm"
                      value={editingPick.completed ? editingPick.completed.replace(' ', 'T') : ''} 
                      onChange={e => setEditingPick({...editingPick, completed: e.target.value ? e.target.value.replace('T', ' ') : null})} />
                  </div>
                </div>
                <div className="mt-3">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Cycle Time (분)</label>
                  <input type="number" className="w-full border rounded-lg px-3 py-2"
                    value={editingPick.cycleMin || ''} 
                    onChange={e => setEditingPick({...editingPick, cycleMin: e.target.value ? parseInt(e.target.value) : null})} />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">상태</label>
                <select className="w-full border rounded-lg px-3 py-2" value={editingPick.status} onChange={e => setEditingPick({...editingPick, status: e.target.value})}>
                  <option value="waiting">대기</option>
                  <option value="in-progress">진행중</option>
                  <option value="paused">일시정지</option>
                  <option value="completed">완료</option>
                </select>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={() => setEditingPick(null)} className="flex-1 px-4 py-2 border rounded-lg">취소</button>
              <button onClick={saveEditPick} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg">저장</button>
            </div>
          </div>
        </div>
      )}

      {/* Receive 수정 모달 */}
      {editingReceive && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">입고 기록 수정</h3>
              <button onClick={() => setEditingReceive(null)}><X className="w-5 h-5" /></button>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">No.</label>
                <input type="text" className="w-full border rounded-lg px-3 py-2 bg-gray-100" readOnly
                  value={editingReceive.poNo || ''} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">협력업체</label>
                <input type="text" className="w-full border rounded-lg px-3 py-2"
                  value={editingReceive.vendor || ''} 
                  onChange={e => setEditingReceive({...editingReceive, vendor: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">납품 시각</label>
                <input type="datetime-local" className="w-full border rounded-lg px-3 py-2"
                  value={editingReceive.delivery ? (() => { const m=editingReceive.delivery.match(/(\d{4})-(\d{2})-(\d{2})[\s\-T](\d{2}):(\d{2})/); return m ? m[1]+'-'+m[2]+'-'+m[3]+'T'+m[4]+':'+m[5] : ''; })() : ''} 
                  onChange={e => { const v=e.target.value.replace('T',' '); setEditingReceive({...editingReceive, delivery: v, startTime: e.target.value ? new Date(e.target.value).toISOString() : null}); }} />
              </div>
              <div className="border-t pt-4">
                <p className="text-sm font-medium text-gray-500 mb-3">⏱️ 타이머 정보</p>
                <div className="grid grid-cols-1 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">MIGO 완료</label>
                    <input type="datetime-local" className="w-full border rounded-lg px-3 py-2 text-sm"
                      value={editingReceive.migo ? editingReceive.migo.replace(' ', 'T') : ''} 
                      onChange={e => setEditingReceive({...editingReceive, migo: e.target.value ? e.target.value.replace('T', ' ') : null})} />
                  </div>
                </div>
                <div className="mt-3">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Cycle Time (분)</label>
                  <input type="number" className="w-full border rounded-lg px-3 py-2"
                    value={editingReceive.cycleMin || ''} 
                    onChange={e => setEditingReceive({...editingReceive, cycleMin: e.target.value ? parseInt(e.target.value) : null})} />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">상태</label>
                <select className="w-full border rounded-lg px-3 py-2" value={editingReceive.status} onChange={e => setEditingReceive({...editingReceive, status: e.target.value})}>
                  <option value="waiting">대기</option>
                  <option value="in-progress">진행중</option>
                  <option value="paused">일시정지</option>
                  <option value="completed">완료</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Comments</label>
                <textarea 
                  className="w-full border rounded-lg px-3 py-2 text-sm" 
                  rows="2"
                  placeholder="지연 사유 등 메모 입력..."
                  value={editingReceive.comments || ''} 
                  onChange={e => setEditingReceive({...editingReceive, comments: e.target.value})} 
                />
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={() => setEditingReceive(null)} className="flex-1 px-4 py-2 border rounded-lg">취소</button>
              <button onClick={saveEditReceive} className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg">저장</button>
            </div>
          </div>
        </div>
      )}

      {/* 평균 Kitting 시간 상세 모달 */}
      {showPickDetailModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowPickDetailModal(false)}>
          <div className="bg-white rounded-xl shadow-xl w-full max-w-3xl flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center p-6 pb-4 border-b flex-shrink-0">
              <h3 className="font-semibold text-lg">📊 Model별 평균 Kitting 시간</h3>
              <button onClick={() => setShowPickDetailModal(false)} className="p-1 hover:bg-gray-100 rounded"><X className="w-5 h-5" /></button>
            </div>
            
            <div className="overflow-y-auto p-6" style={{ minHeight: 0 }}>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                {['RSC48', 'CSC48', 'RSC16', 'CSC16', 'FSC16', 'HSM3.0', 'Spare Parts'].map(model => {
                  const completedPicks = pickCycles.filter(p => p.model === model && p.status === 'completed' && p.cycleMin);
                  const avgTime = completedPicks.length > 0 
                    ? Math.round(completedPicks.reduce((s, p) => s + p.cycleMin, 0) / completedPicks.length) 
                    : 0;
                  const minTime = completedPicks.length > 0 ? Math.min(...completedPicks.map(p => p.cycleMin)) : 0;
                  const maxTime = completedPicks.length > 0 ? Math.max(...completedPicks.map(p => p.cycleMin)) : 0;
                
                return (
                  <div key={model} className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg p-4 text-center">
                    <p className="text-sm font-medium text-gray-600 mb-1">{model}</p>
                    <p className="text-2xl font-bold text-purple-600">{avgTime}분</p>
                    <p className="text-xs text-gray-500">완료: {completedPicks.length}건</p>
                    {completedPicks.length > 0 && (
                      <p className="text-xs text-gray-400 mt-1">
                        최소 {minTime}분 / 최대 {maxTime}분
                      </p>
                    )}
                  </div>
                );
              })}
            </div>

            <h4 className="font-medium text-gray-700 mb-3">📋 최근 완료 기록 (최근 20건)</h4>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-slate-50">
                  <tr>
                    <th className="px-3 py-2 text-left">Production Order</th>
                    <th className="px-3 py-2 text-left">Model</th>
                    <th className="px-3 py-2 text-center">완료일</th>
                    <th className="px-3 py-2 text-center">Cycle Time</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {pickCycles
                    .filter(p => p.status === 'completed' && p.cycleMin)
                    .sort((a, b) => (b.completed || '').localeCompare(a.completed || ''))
                    .slice(0, 20)
                    .map(p => (
                      <tr key={p.id}>
                        <td className="px-3 py-2 font-medium">{p.productionOrder || p.orderId}</td>
                        <td className="px-3 py-2">
                          <span className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs">{p.model}</span>
                        </td>
                        <td className="px-3 py-2 text-center text-gray-600">{p.completed}</td>
                        <td className="px-3 py-2 text-center">
                          <span className={`px-2 py-0.5 rounded text-xs ${p.cycleMin > 60 ? 'bg-red-100 text-red-700' : p.cycleMin > 45 ? 'bg-amber-100 text-yellow-600' : 'bg-emerald-100 text-blue-600'}`}>
                            {p.cycleMin}분
                          </span>
                        </td>
                      </tr>
                    ))}
                </tbody>
              </table>
              {pickCycles.filter(p => p.status === 'completed' && p.cycleMin).length === 0 && (
                <p className="text-center text-gray-400 py-8">완료된 기록이 없습니다</p>
              )}
            </div>
            </div>
          </div>
        </div>
      )}

      {/* 평균 입고시간 상세 모달 */}
      {showReceiveDetailModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowReceiveDetailModal(false)}>
          <div className="bg-white rounded-xl shadow-xl w-full max-w-3xl m-4 flex flex-col" style={{ maxHeight: '85vh' }} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center p-6 pb-4 border-b flex-shrink-0">
              <h3 className="font-semibold text-lg">📊 협력업체별 평균 입고시간</h3>
              <button onClick={() => setShowReceiveDetailModal(false)} className="p-1 hover:bg-gray-100 rounded"><X className="w-5 h-5" /></button>
            </div>
            
            <div className="p-6" style={{ overflowY: 'auto', flex: 1 }}>
              {/* 업체별 통계 */}
              <div className="mb-6">
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  {(() => {
                    const vendorStats = {};
                    receiveCycles
                      .filter(r => r.status === 'completed' && r.cycleMin && r.vendor)
                      .forEach(r => {
                        if (!vendorStats[r.vendor]) {
                          vendorStats[r.vendor] = { total: 0, count: 0, min: Infinity, max: 0 };
                        }
                        vendorStats[r.vendor].total += r.cycleMin;
                        vendorStats[r.vendor].count += 1;
                        vendorStats[r.vendor].min = Math.min(vendorStats[r.vendor].min, r.cycleMin);
                        vendorStats[r.vendor].max = Math.max(vendorStats[r.vendor].max, r.cycleMin);
                      });
                    
                    return Object.entries(vendorStats)
                      .sort((a, b) => b[1].count - a[1].count)
                      .slice(0, 9)
                      .map(([vendor, stats]) => (
                        <div key={vendor} className="bg-gradient-to-br from-slate-50 to-indigo-50 rounded-lg p-4">
                          <p className="text-sm font-medium text-gray-600 truncate mb-1" title={vendor}>{vendor}</p>
                          <p className="text-2xl font-bold text-indigo-600">{Math.round(stats.total / stats.count)}분</p>
                          <p className="text-xs text-gray-500">완료: {stats.count}건</p>
                          <p className="text-xs text-gray-400">
                            최소 {stats.min}분 / 최대 {stats.max}분
                          </p>
                        </div>
                      ));
                  })()}
                </div>
                {receiveCycles.filter(r => r.status === 'completed' && r.cycleMin).length === 0 && (
                  <p className="text-center text-gray-400 py-4">완료된 기록이 없습니다</p>
                )}
              </div>

              <h4 className="font-medium text-gray-700 mb-3">📋 최근 완료 기록 (최근 20건)</h4>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50">
                    <tr>
                      <th className="px-3 py-2 text-left">No.</th>
                      <th className="px-3 py-2 text-left">협력업체</th>
                      <th className="px-3 py-2 text-center">MIGO 완료</th>
                      <th className="px-3 py-2 text-center">Cycle Time</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {receiveCycles
                      .filter(r => r.status === 'completed' && r.cycleMin)
                      .sort((a, b) => (b.migo || '').localeCompare(a.migo || ''))
                      .slice(0, 20)
                      .map(r => (
                        <tr key={r.id}>
                          <td className="px-3 py-2 font-medium">{r.poNo}</td>
                          <td className="px-3 py-2">{r.vendor}</td>
                          <td className="px-3 py-2 text-center text-gray-600">{convertToKoreaTime(r.migo)}</td>
                          <td className="px-3 py-2 text-center">
                            <span className={`px-2 py-0.5 rounded text-xs ${r.cycleMin > 90 ? 'bg-red-100 text-red-600' : r.cycleMin > 60 ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}`}>
                              {r.cycleMin}분
                            </span>
                          </td>
                        </tr>
                      ))}
                  </tbody>
                </table>
                {receiveCycles.filter(r => r.status === 'completed' && r.cycleMin).length === 0 && (
                  <p className="text-center text-gray-400 py-8">완료된 기록이 없습니다</p>
                )}
              </div>
            </div>
            <div className="flex-shrink-0 border-t p-4 flex justify-end">
              <button onClick={() => setShowPickDetailModal(false)} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 평균 Kitting 리드타임 상세 모달 */}
      {showLeadTimeDetailModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowLeadTimeDetailModal(false)}>
          <div className="bg-white rounded-xl shadow-xl w-full max-w-4xl flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center p-6 pb-4 border-b flex-shrink-0">
              <h3 className="font-semibold text-lg">📊 Model별 평균 Kitting 리드타임</h3>
              <button onClick={() => setShowLeadTimeDetailModal(false)} className="p-1 hover:bg-gray-100 rounded"><X className="w-5 h-5" /></button>
            </div>
            
            <div className="overflow-y-auto p-6" style={{ minHeight: 0 }}>
              {/* 모델별 리드타임 요약 */}
              <div className="grid grid-cols-3 gap-4 mb-6">
                {Object.keys(MODEL_WEIGHTS).map(model => {
                  const modelKittings = kittingData.filter(k => k.model === model && k.leadTimeDays && k.leadTimeDays > 0);
                  const avgLT = modelKittings.length > 0 
                    ? (modelKittings.reduce((s, k) => s + k.leadTimeDays, 0) / modelKittings.length).toFixed(1)
                    : '-';
                  const count = modelKittings.length;
                  
                  return (
                    <div key={model} className={`p-4 rounded-xl border-l-4 ${
                      MODEL_WEIGHTS[model].series === '16' ? 'bg-purple-50 border-purple-500' :
                      MODEL_WEIGHTS[model].series === '48' ? 'bg-blue-50 border-blue-500' :
                      'bg-orange-50 border-orange-500'
                    }`}>
                      <p className="font-bold text-gray-800">{model}</p>
                      <p className="text-xs text-gray-500">{MODEL_WEIGHTS[model].code}</p>
                      <p className={`text-2xl font-bold mt-2 ${
                        avgLT === '-' ? 'text-gray-400' :
                        parseFloat(avgLT) <= 1 ? 'text-green-600' :
                        parseFloat(avgLT) <= 2 ? 'text-amber-600' :
                        'text-red-600'
                      }`}>
                        {avgLT === '-' ? '-' : `${avgLT}일`}
                      </p>
                      <p className="text-xs text-gray-500">{count}건 완료</p>
                    </div>
                  );
                })}
              </div>
              
              {/* 최근 완료 기록 */}
              <h4 className="font-medium text-gray-700 mb-3">📋 최근 완료 기록 (리드타임 기준)</h4>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-cyan-50">
                    <tr>
                      <th className="px-3 py-2 text-left">생산오더</th>
                      <th className="px-3 py-2 text-center">모델</th>
                      <th className="px-3 py-2 text-center">담당자</th>
                      <th className="px-3 py-2 text-center">시작일</th>
                      <th className="px-3 py-2 text-center">완료일</th>
                      <th className="px-3 py-2 text-center">리드타임</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {kittingData
                      .filter(k => k.status === 'completed' && k.leadTimeDays && k.leadTimeDays > 0)
                      .sort((a, b) => (b.completedAt || '').localeCompare(a.completedAt || ''))
                      .slice(0, 20)
                      .map(k => (
                        <tr key={k.id}>
                          <td className="px-3 py-2 font-medium">{k.productionOrder}</td>
                          <td className="px-3 py-2 text-center">
                            <span className={`px-2 py-0.5 rounded text-xs ${
                              MODEL_WEIGHTS[k.model]?.series === '16' ? 'bg-purple-100 text-purple-700' :
                              MODEL_WEIGHTS[k.model]?.series === '48' ? 'bg-blue-100 text-blue-700' :
                              'bg-orange-100 text-orange-700'
                            }`}>
                              {k.model}
                            </span>
                          </td>
                          <td className="px-3 py-2 text-center">{k.worker}</td>
                          <td className="px-3 py-2 text-center text-gray-600">{k.basicStartDate}</td>
                          <td className="px-3 py-2 text-center text-gray-600">{k.completedAt}</td>
                          <td className="px-3 py-2 text-center">
                            <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                              k.leadTimeDays <= 1 ? 'bg-green-100 text-green-700' :
                              k.leadTimeDays <= 2 ? 'bg-amber-100 text-amber-700' :
                              'bg-red-100 text-red-700'
                            }`}>
                              {k.leadTimeDays}일
                            </span>
                          </td>
                        </tr>
                      ))}
                  </tbody>
                </table>
                {kittingData.filter(k => k.status === 'completed' && k.leadTimeDays).length === 0 && (
                  <p className="text-center text-gray-400 py-8">완료된 기록이 없습니다</p>
                )}
              </div>
            </div>
            <div className="flex-shrink-0 border-t p-4 flex justify-end">
              <button onClick={() => setShowLeadTimeDetailModal(false)} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 랙 Bin 상세 모달 */}
      {selectedRackDetail && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <div>
                <h3 className="font-semibold text-xl flex items-center gap-2">
                  📦 {selectedRackDetail.id} 랙 Bin 상세 현황
                  <span className={`px-2 py-1 rounded text-xs ${
                    RACK_MODEL_SERIES[selectedRackDetail.id] === 'Maxwell 16' ? 'bg-blue-100 text-blue-700' :
                    RACK_MODEL_SERIES[selectedRackDetail.id] === 'Maxwell 48' ? 'bg-emerald-100 text-blue-600' :
                    RACK_MODEL_SERIES[selectedRackDetail.id] === 'HSM 3.0' ? 'bg-orange-100 text-orange-600' :
                    'bg-gray-100 text-gray-700'
                  }`}>
                    {RACK_MODEL_SERIES[selectedRackDetail.id] || '기타'}
                  </span>
                </h3>
                <p className="text-sm text-gray-500 mt-1">
                  총 {selectedRackDetail.bins}개 Bin 사용 중 / 최대 {selectedRackDetail.maxBins}개
                </p>
              </div>
              <button onClick={() => setSelectedRackDetail(null)} className="p-2 hover:bg-gray-100 rounded-lg">
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* 랙 요약 */}
            <div className="grid grid-cols-4 gap-4 mb-6">
              <div className="bg-slate-50 rounded-lg p-3 text-center">
                <p className="text-xs text-gray-500">품목 수</p>
                <p className="text-xl font-bold text-indigo-600">{selectedRackDetail.items}개</p>
              </div>
              <div className="bg-slate-50 rounded-lg p-3 text-center">
                <p className="text-xs text-gray-500">총 재고</p>
                <p className="text-xl font-bold text-emerald-600">{selectedRackDetail.stock.toLocaleString()} EA</p>
              </div>
              <div className="bg-slate-50 rounded-lg p-3 text-center">
                <p className="text-xs text-gray-500">총 무게</p>
                <p className="text-xl font-bold text-amber-600">{selectedRackDetail.weight.toFixed(1)} kg</p>
              </div>
              <div className="bg-slate-50 rounded-lg p-3 text-center">
                <p className="text-xs text-gray-500">무게 활용률</p>
                <p className={`text-xl font-bold ${
                  (selectedRackDetail.weight / selectedRackDetail.maxWeight * 100) >= 90 ? 'text-red-600' :
                  (selectedRackDetail.weight / selectedRackDetail.maxWeight * 100) >= 70 ? 'text-amber-600' :
                  'text-emerald-600'
                }`}>
                  {selectedRackDetail.maxWeight >= 99999 ? '무제한' : `${(selectedRackDetail.weight / selectedRackDetail.maxWeight * 100).toFixed(0)}%`}
                </p>
              </div>
            </div>

            {/* Bin 시각화 그리드 */}
            <div className="mb-6">
              <h4 className="font-medium text-gray-700 mb-3">🗄️ Bin 배치 현황</h4>
              <div className="grid grid-cols-6 md:grid-cols-10 gap-2">
                {(() => {
                  const rackId = selectedRackDetail.id;
                  const maxBins = selectedRackDetail.maxBins;
                  const bins = [];
                  
                  // 해당 랙의 모든 Bin 가져오기
                  const rackItems = inventoryData.filter(item => {
                    const itemRack = item.bin?.split('-')?.[0];
                    return itemRack === rackId;
                  });
                  
                  // Bin별로 그룹화
                  const binData = {};
                  rackItems.forEach(item => {
                    if (!binData[item.bin]) {
                      binData[item.bin] = { items: 0, stock: 0 };
                    }
                    binData[item.bin].items += 1;
                    binData[item.bin].stock += item.stock || 0;
                  });
                  
                  for (let i = 1; i <= maxBins; i++) {
                    const binId = `${rackId}-${String(i).padStart(2, '0')}`;
                    const data = binData[binId];
                    const isUsed = !!data;
                    
                    bins.push(
                      <div 
                        key={binId}
                        className={`p-2 rounded-lg text-center text-xs border-2 transition ${
                          isUsed 
                            ? 'bg-indigo-100 border-indigo-300 text-indigo-700' 
                            : 'bg-gray-50 border-gray-200 text-gray-400'
                        }`}
                        title={isUsed ? `${binId}: ${data.items}개 품목, ${data.stock.toLocaleString()} EA` : `${binId}: 비어있음`}
                      >
                        <p className="font-medium">{String(i).padStart(2, '0')}</p>
                        {isUsed && <p className="text-[10px] mt-0.5">{data.items}품목</p>}
                      </div>
                    );
                  }
                  return bins;
                })()}
              </div>
              <div className="flex gap-4 mt-3 text-xs">
                <span className="flex items-center gap-1">
                  <span className="w-4 h-4 rounded bg-indigo-100 border-2 border-indigo-300"></span> 사용 중
                </span>
                <span className="flex items-center gap-1">
                  <span className="w-4 h-4 rounded bg-gray-50 border-2 border-gray-200"></span> 비어있음
                </span>
              </div>
            </div>

            {/* Bin별 상세 테이블 */}
            <div>
              <h4 className="font-medium text-gray-700 mb-3">📋 Bin별 품목 상세</h4>
              <div className="overflow-x-auto max-h-[300px]">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50 sticky top-0">
                    <tr>
                      <th className="px-3 py-2 text-left">Bin</th>
                      <th className="px-3 py-2 text-left">품번</th>
                      <th className="px-3 py-2 text-left">품명</th>
                      <th className="px-3 py-2 text-center">재고</th>
                      <th className="px-3 py-2 text-center">박스 수</th>
                      <th className="px-3 py-2 text-center">공간 사용률</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {(() => {
                      const rackItems = inventoryData
                        .filter(item => {
                          const itemRack = item.bin?.split('-')?.[0];
                          return itemRack === selectedRackDetail.id || item.bin === selectedRackDetail.id;
                        })
                        .sort((a, b) => (a.bin || '').localeCompare(b.bin || ''));
                      
                      // Bin별 총 박스 수 계산
                      const binTotals = {};
                      rackItems.forEach(item => {
                        const bin = item.bin || selectedRackDetail.id;
                        if (!binTotals[bin]) binTotals[bin] = { curBoxes: 0, maxBoxes: 0 };
                        const qtyPerBox = MATERIAL_QTY_PER_BOX[item.material] || 1;
                        binTotals[bin].curBoxes += (item.stock || 0) / qtyPerBox;
                      });
                      // 각 Bin의 최대 박스 계산
                      Object.keys(binTotals).forEach(bin => {
                        const binInfo = BIN_RACK_INFO[bin] || { rackType: '경량랙', rackCount: 1 };
                        const binItems = rackItems.filter(i => i.bin === bin);
                        const binBoxTypes = binItems.map(i => MATERIAL_BOX_MAP[i.material] || 'PLASTIC-S');
                        const tc = {};
                        binBoxTypes.forEach(t => { tc[t] = (tc[t] || 0) + 1; });
                        const mainBT = Object.entries(tc).sort((a, b) => b[1] - a[1])[0]?.[0] || 'PLASTIC-S';
                        if (binInfo.maxBoxes) {
                          binTotals[bin].maxBoxes = binInfo.maxBoxes;
                        } else if (binInfo.mixed) {
                          let mx = 0;
                          binInfo.mixed.forEach(m => {
                            const s = BOXES_PER_SHELF[m.type] || BOXES_PER_SHELF['경량랙'];
                            mx += (s[mainBT] || s['PLASTIC-S'] || 2) * m.count;
                          });
                          binTotals[bin].maxBoxes = mx;
                        } else {
                          const s = BOXES_PER_SHELF[binInfo.rackType] || BOXES_PER_SHELF['경량랙'];
                          binTotals[bin].maxBoxes = (s[mainBT] || s['PLASTIC-S'] || 2) * binInfo.rackCount * (binInfo.shelves || 1);
                        }
                      });
                      
                      return rackItems.map((item, idx) => {
                        const qtyPerBox = MATERIAL_QTY_PER_BOX[item.material] || 1;
                        const boxes = (item.stock || 0) / qtyPerBox;
                        const bin = item.bin || selectedRackDetail.id;
                        const bt = binTotals[bin];
                        const binUtil = bt && bt.maxBoxes > 0 ? (bt.curBoxes / bt.maxBoxes) * 100 : 0;
                        
                        return (
                          <tr key={idx} className="hover:bg-slate-50">
                            <td className="px-3 py-2">
                              <span className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-medium">
                                {item.bin}
                              </span>
                            </td>
                            <td className="px-3 py-2 font-mono text-xs">{item.material}</td>
                            <td className="px-3 py-2 text-sm">{item.description?.slice(0, 30)}</td>
                            <td className="px-3 py-2 text-center font-medium">{item.stock?.toLocaleString()}</td>
                            <td className="px-3 py-2 text-center text-xs">{boxes.toFixed(1)}</td>
                            <td className="px-3 py-2 text-center">
                              <div className="flex items-center gap-1 justify-center">
                                <div className="w-12 bg-gray-200 rounded-full h-1.5">
                                  <div className={`h-1.5 rounded-full ${binUtil > 100 ? 'bg-red-500' : binUtil >= 80 ? 'bg-amber-500' : binUtil >= 50 ? 'bg-emerald-500' : 'bg-blue-500'}`}
                                    style={{ width: `${Math.min(binUtil, 100)}%` }} />
                                </div>
                                <span className={`text-xs font-medium ${binUtil > 100 ? 'text-red-600' : binUtil >= 80 ? 'text-amber-600' : 'text-emerald-600'}`}>
                                  {binUtil.toFixed(0)}%
                                </span>
                              </div>
                            </td>
                          </tr>
                        );
                      });
                    })()}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="mt-6 flex justify-end">
              <button 
                onClick={() => setSelectedRackDetail(null)} 
                className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 모델별 생산 가능 대수 상세 모달 */}
      {showModelDetailModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg m-4 max-h-[80vh] flex flex-col">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">
                {showModelDetailModal === 'excess' && '📦 과다 재고 모델'}
                {showModelDetailModal === 'normal' && '✅ 적정 재고 모델'}
                {showModelDetailModal === 'caution' && '⚠️ 부족 주의 모델'}
                {showModelDetailModal === 'urgent' && '🚨 부족 긴급 모델'}
              </h3>
              <button onClick={() => setShowModelDetailModal(null)}><X className="w-5 h-5" /></button>
            </div>
            <div className="overflow-y-auto flex-1">
              {(() => {
                const TARGET_STOCK = {
                  'RSC16': { min: 10, max: 30 },
                  'CSC16': { min: 5, max: 10 },
                  'FSC16': { min: 2, max: 2 },
                  'RSC48': { min: 10, max: 20 },
                  'CSC48': { min: 3, max: 10 },
                  'HSM3': { min: 1, max: 5 }
                };
                
                const modelList = Object.entries(TARGET_STOCK).map(([model, range]) => {
                  const info = MODEL_WEIGHTS[model];
                  const currentStock = inventoryData.filter(i => i.material === info?.code).reduce((sum, i) => sum + (i.stock || 0), 0);
                  let status = 'ok';
                  if (currentStock > range.max) status = 'over';
                  else if (currentStock >= range.min) status = 'ok';
                  else if (currentStock >= range.min * 0.5) status = 'warning';
                  else status = 'shortage';
                  return { model, currentStock, range, status };
                }).filter(m => {
                  if (showModelDetailModal === 'excess') return m.status === 'over';
                  if (showModelDetailModal === 'normal') return m.status === 'ok';
                  if (showModelDetailModal === 'caution') return m.status === 'warning';
                  if (showModelDetailModal === 'urgent') return m.status === 'shortage';
                  return false;
                });
                
                if (modelList.length === 0) {
                  return <p className="text-gray-500 text-center py-8">해당 상태의 모델이 없습니다.</p>;
                }
                
                return (
                  <div className="space-y-3">
                    {modelList.map((m, idx) => (
                      <div key={idx} className={`p-4 rounded-lg border ${
                        m.status === 'over' ? 'bg-purple-50 border-purple-200' :
                        m.status === 'ok' ? 'bg-emerald-50 border-emerald-200' :
                        m.status === 'warning' ? 'bg-amber-50 border-amber-200' :
                        'bg-red-50 border-red-200'
                      }`}>
                        <div className="flex justify-between items-center">
                          <span className="font-medium text-gray-800">{m.model}</span>
                          <span className="font-bold text-lg">{m.currentStock}대</span>
                        </div>
                        <p className="text-xs text-gray-500 mt-1">
                          기준: {m.range.min}~{m.range.max}대
                        </p>
                      </div>
                    ))}
                  </div>
                );
              })()}
            </div>
            <button 
              onClick={() => setShowModelDetailModal(null)}
              className="mt-4 w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg"
            >
              닫기
            </button>
          </div>
        </div>
      )}

      {/* Sub-component 생산 가능 대수 상세 모달 */}
      {showSubcomDetailModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowSubcomDetailModal(null)}>
          <div className="bg-white rounded-xl shadow-xl w-full max-w-lg flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center p-6 pb-4 border-b flex-shrink-0">
              <h3 className="font-semibold text-lg">
                {showSubcomDetailModal === 'excess' && '📦 과다 재고 Sub-component'}
                {showSubcomDetailModal === 'normal' && '✅ 적정 재고 Sub-component'}
                {showSubcomDetailModal === 'caution' && '⚠️ 부족 주의 Sub-component'}
                {showSubcomDetailModal === 'urgent' && '🚨 부족 긴급 Sub-component'}
              </h3>
              <button onClick={() => setShowSubcomDetailModal(null)} className="p-1 hover:bg-gray-100 rounded"><X className="w-5 h-5" /></button>
            </div>
            <div className="overflow-y-auto p-6" style={{ minHeight: 0 }}>
              {(() => {
                const SUBCOM_SAFETY = { min: 10, max: 50 };
                const SUBCOM_SAFETY_KB0770 = { min: 20, max: 100 };
                
                const subcomList = Object.entries(subComponentUnits).map(([name, info]) => {
                  const currentStock = inventoryData.filter(i => i.material === name).reduce((sum, i) => sum + (i.stock || 0), 0);
                  const range = name === 'KB0770' ? SUBCOM_SAFETY_KB0770 : SUBCOM_SAFETY;
                  let status = 'ok';
                  if (currentStock > range.max) status = 'over';
                  else if (currentStock >= range.min) status = 'ok';
                  else if (currentStock >= range.min * 0.5) status = 'warning';
                  else status = 'shortage';
                  return { name, currentStock, units: info.units, range, status };
                }).filter(m => {
                  if (showSubcomDetailModal === 'excess') return m.status === 'over';
                  if (showSubcomDetailModal === 'normal') return m.status === 'ok';
                  if (showSubcomDetailModal === 'caution') return m.status === 'warning';
                  if (showSubcomDetailModal === 'urgent') return m.status === 'shortage';
                  return false;
                }).sort((a, b) => a.units - b.units);
                
                if (subcomList.length === 0) {
                  return <p className="text-gray-500 text-center py-8">해당 상태의 Sub-component가 없습니다.</p>;
                }
                
                return (
                  <div className="space-y-3">
                    {subcomList.map((m, idx) => (
                      <div key={idx} className={`p-4 rounded-lg border ${
                        m.status === 'over' ? 'bg-purple-50 border-purple-200' :
                        m.status === 'ok' ? 'bg-emerald-50 border-emerald-200' :
                        m.status === 'warning' ? 'bg-amber-50 border-amber-200' :
                        'bg-red-50 border-red-200'
                      }`}>
                        <div className="flex justify-between items-center">
                          <span className="font-medium text-gray-800">{m.name}</span>
                          <span className="font-bold text-lg">{m.units}대</span>
                        </div>
                        <p className="text-xs text-gray-500 mt-1">
                          현재고: {m.currentStock}EA | 기준: {m.range.min}~{m.range.max}대
                        </p>
                      </div>
                    ))}
                  </div>
                );
              })()}
            </div>
            <div className="flex-shrink-0 border-t p-4 flex justify-end">
              <button 
                onClick={() => setShowSubcomDetailModal(null)}
                className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 온습도 Excel 내보내기 모달 */}

      {/* 부족/저재고 상세 모달 */}
      {showShortageDetailModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowShortageDetailModal(null)}>
          <div className="bg-white rounded-xl shadow-xl w-full max-w-4xl flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center p-6 pb-4 border-b flex-shrink-0">
              <h3 className="font-semibold text-lg">
                {showShortageDetailModal === 'critical' && '🚨 생산불가 자재 (0대)'}
                {showShortageDetailModal === 'high' && '⚠️ 긴급 자재 (1~4대)'}
                {showShortageDetailModal === 'withPO' && '✅ 발주 진행중 자재'}
                {showShortageDetailModal === 'noPO' && '🛒 발주 필요 자재'}
              </h3>
              <button onClick={() => setShowShortageDetailModal(null)} className="p-1 hover:bg-gray-100 rounded"><X className="w-5 h-5" /></button>
            </div>
            <div className="overflow-y-auto p-6" style={{ minHeight: 0 }}>
              {(() => {
                const stockByMaterial = {};
                const descByMaterial = {};
                inventoryData.forEach(item => {
                  stockByMaterial[item.material] = (stockByMaterial[item.material] || 0) + item.stock;
                  descByMaterial[item.material] = item.description || '';
                });
                const bomToUse = customBomData || MODEL_BOM_DATA;
                const allShortages = [];
                Object.entries(bomToUse).forEach(([model, bom]) => {
                  Object.entries(bom).forEach(([material, requiredQty]) => {
                    const currentStock = stockByMaterial[material] || 0;
                    const possibleUnits = Math.floor(currentStock / requiredQty);
                    const threshold2 = (model === 'HSM3' || model === 'HSM3.0') ? 3 : 10;
                    if (possibleUnits < threshold2 && requiredQty > 0) {
                      const openPO = openPOData.find(po => po.material === material);
                      const existingIdx = allShortages.findIndex(s => s.material === material);
                      if (existingIdx === -1) {
                        allShortages.push({ material, description: descByMaterial[material] || openPO?.description || '-', currentStock, requiredQty, possibleUnits, models: [model], openPO: openPO ? { qty: openPO.totalQty, poNumbers: openPO.poNumbers } : null, urgency: possibleUnits === 0 ? 'critical' : possibleUnits < Math.ceil(threshold2/2) ? 'high' : 'medium' });
                      } else {
                        if (!allShortages[existingIdx].models.includes(model)) allShortages[existingIdx].models.push(model);
                      }
                    }
                  });
                });
                
                let filtered = allShortages;
                if (showShortageDetailModal === 'critical') filtered = allShortages.filter(s => s.urgency === 'critical');
                else if (showShortageDetailModal === 'high') filtered = allShortages.filter(s => s.urgency === 'high');
                else if (showShortageDetailModal === 'withPO') filtered = allShortages.filter(s => s.openPO);
                else if (showShortageDetailModal === 'noPO') filtered = allShortages.filter(s => !s.openPO);
                
                filtered.sort((a, b) => a.possibleUnits - b.possibleUnits);
                
                return filtered.length > 0 ? (
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50 sticky top-0">
                      <tr>
                        <th className="px-3 py-2 text-left">품번</th>
                        <th className="px-3 py-2 text-left">품명</th>
                        <th className="px-3 py-2 text-center">현재고</th>
                        <th className="px-3 py-2 text-center">생산가능</th>
                        <th className="px-3 py-2 text-center">모델</th>
                        <th className="px-3 py-2 text-center">Open PO</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y">
                      {filtered.map((s, idx) => (
                        <tr key={idx} className="hover:bg-gray-50">
                          <td className="px-3 py-2 font-mono text-xs">{s.material}</td>
                          <td className="px-3 py-2 text-xs">{s.description?.slice(0, 35)}</td>
                          <td className="px-3 py-2 text-center font-medium">{s.currentStock}</td>
                          <td className="px-3 py-2 text-center">
                            <span className={`px-2 py-0.5 rounded text-xs font-bold ${s.urgency === 'critical' ? 'bg-red-100 text-red-700' : s.urgency === 'high' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`}>
                              {s.possibleUnits}대
                            </span>
                          </td>
                          <td className="px-3 py-2 text-center text-xs">{s.models.join(', ')}</td>
                          <td className="px-3 py-2 text-center text-xs">
                            {s.openPO ? (
                              <span className="text-green-600">✅ {s.openPO.qty}EA</span>
                            ) : (
                              <span className="text-red-500">❌ 없음</span>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                ) : (
                  <p className="text-center text-gray-400 py-8">해당 항목이 없습니다</p>
                );
              })()}
            </div>
            <div className="flex-shrink-0 border-t p-4 flex justify-end">
              <button onClick={() => setShowShortageDetailModal(null)} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {showTempHumidityExportModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">📊 온습도 데이터 Excel 저장</h3>
              <button onClick={() => setShowTempHumidityExportModal(false)}><X className="w-5 h-5" /></button>
            </div>
            
            <p className="text-gray-600 mb-6">저장할 데이터 범위를 선택하세요.</p>
            
            <div className="space-y-3">
              <button
                onClick={() => {
                  // 선택된 달만 저장
                  const [year, month] = tempHumidityMonth.split('-').map(Number);
                  const daysInMonth = new Date(year, month, 0).getDate();
                  const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                  
                  let csvContent = '\uFEFF';
                  csvContent += 'ESD Check Sheet - ' + year + '년 ' + month + '월\n';
                  csvContent += 'Equipment: NS-205B / Spec: Temp +5~40℃, Humidity 0~75%\n';
                  csvContent += 'Recorded by: ' + tempHumidityRecorder + '\n\n';
                  csvContent += '날짜,요일,온도(℃),습도(%),상태\n';
                  
                  for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = tempHumidityMonth + '-' + String(day).padStart(2, '0');
                    const date = new Date(year, month - 1, day);
                    const dayName = dayNames[date.getDay()];
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isHoliday = KR_HOLIDAYS.has(dateKey);
                    const isOff = isWeekend || isHoliday;
                    const data = tempHumidityData[dateKey];
                    
                    if (data && data.temp && data.humidity) {
                      const t = parseFloat(data.temp);
                      const h = parseFloat(data.humidity);
                      const tempOk = t >= 5 && t <= 40;
                      const humidOk = h >= 0 && h <= 75;
                      const status = tempOk && humidOk ? 'OK' : 'NG';
                      csvContent += day + ',' + dayName + ',' + data.temp + ',' + data.humidity + ',' + status + '\n';
                    } else if (isOff) {
                      csvContent += day + ',' + dayName + ',' + (isHoliday && !isWeekend ? '공휴일' : '주말') + ',' + (isHoliday && !isWeekend ? '공휴일' : '주말') + ',-\n';
                    } else {
                      csvContent += day + ',' + dayName + ',-,-,미입력\n';
                    }
                  }
                  
                  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.download = 'ESD_Check_Sheet_' + tempHumidityMonth + '.csv';
                  link.click();
                  setShowTempHumidityExportModal(false);
                }}
                className="w-full py-4 px-4 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl text-left transition"
              >
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                    <Calendar className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <p className="font-semibold text-blue-800">선택된 달만 저장</p>
                    <p className="text-sm text-blue-600">{tempHumidityMonth.replace('-', '년 ')}월 데이터</p>
                  </div>
                </div>
              </button>
              
              <button
                onClick={() => {
                  // 모든 데이터 저장
                  const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                  const allDates = Object.keys(tempHumidityData).sort();
                  
                  if (allDates.length === 0) {
                    alert('저장할 데이터가 없습니다.');
                    return;
                  }
                  
                  let csvContent = '\uFEFF';
                  csvContent += 'ESD Check Sheet - 전체 데이터\n';
                  csvContent += 'Equipment: NS-205B / Spec: Temp +5~40℃, Humidity 0~75%\n';
                  csvContent += 'Recorded by: ' + tempHumidityRecorder + '\n';
                  csvContent += '총 ' + allDates.length + '개 기록\n\n';
                  csvContent += '날짜,요일,온도(℃),습도(%),상태\n';
                  
                  allDates.forEach(dateKey => {
                    const data = tempHumidityData[dateKey];
                    const date = new Date(dateKey);
                    const dayName = dayNames[date.getDay()];
                    
                    if (data && data.temp && data.humidity) {
                      const t = parseFloat(data.temp);
                      const h = parseFloat(data.humidity);
                      const tempOk = t >= 5 && t <= 40;
                      const humidOk = h >= 0 && h <= 75;
                      const status = tempOk && humidOk ? 'OK' : 'NG';
                      csvContent += dateKey + ',' + dayName + ',' + data.temp + ',' + data.humidity + ',' + status + '\n';
                    }
                  });
                  
                  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.download = 'ESD_Check_Sheet_All_Data.csv';
                  link.click();
                  setShowTempHumidityExportModal(false);
                }}
                className="w-full py-4 px-4 bg-emerald-50 hover:bg-emerald-100 border-2 border-emerald-200 rounded-xl text-left transition"
              >
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 bg-emerald-500 rounded-lg flex items-center justify-center">
                    <Database className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <p className="font-semibold text-emerald-800">모든 데이터 저장</p>
                    <p className="text-sm text-emerald-600">총 {Object.keys(tempHumidityData).length}개 기록</p>
                  </div>
                </div>
              </button>
            </div>
            
            <button
              onClick={() => setShowTempHumidityExportModal(false)}
              className="w-full mt-4 py-2 text-gray-500 hover:text-gray-700"
            >
              취소
            </button>
          </div>
        </div>
      )}

      {/* 백업/복원 모달 */}
      {showBackupModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">📦 데이터 백업 / 복원</h3>
              <button onClick={() => { setShowBackupModal(false); setBackupData(''); }}><X className="w-5 h-5" /></button>
            </div>
            
            {/* 백업 섹션 */}
            <div className="mb-6">
              <h4 className="font-medium text-gray-800 mb-2 flex items-center gap-2">
                <Download className="w-4 h-4 text-emerald-600" /> 백업
              </h4>
              <p className="text-sm text-gray-600 mb-3">
                모든 데이터를 JSON 형식으로 백업합니다.
              </p>
              
              {!backupData ? (
                <button 
                  onClick={exportAllData}
                  className="w-full px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 flex items-center justify-center gap-2"
                >
                  <Database className="w-5 h-5" /> 백업 데이터 생성
                </button>
              ) : (
                <div className="space-y-3">
                  <div className="flex gap-2">
                    <button 
                      onClick={selectAllBackupText}
                      className="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 flex items-center justify-center gap-2"
                    >
                      <Check className="w-5 h-5" /> 전체 선택 (그 다음 Ctrl+C)
                    </button>
                    <button 
                      onClick={() => setBackupData('')}
                      className="px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                    >
                      <RefreshCw className="w-5 h-5" />
                    </button>
                  </div>
                  <div className="bg-gray-100 rounded-lg p-2">
                    <p className="text-xs text-gray-500 mb-1">📋 백업 데이터 ({(backupData.length / 1024).toFixed(1)} KB) - 아래 텍스트를 Ctrl+A → Ctrl+C로 복사하세요</p>
                    <textarea 
                      id="backup-textarea"
                      readOnly 
                      value={backupData}
                      className="w-full h-48 text-xs font-mono bg-white border rounded p-2 resize-none select-all"
                      onClick={(e) => e.target.select()}
                    />
                  </div>
                  <p className="text-xs text-blue-600 font-medium">
                    💡 복사 방법: 텍스트박스 클릭 → Ctrl+A (전체선택) → Ctrl+C (복사) → 메모장에 Ctrl+V (붙여넣기) → .json으로 저장
                  </p>
                </div>
              )}
            </div>
            
            <hr className="my-4" />
            
            {/* 복원 섹션 */}
            <div>
              <h4 className="font-medium text-gray-800 mb-2 flex items-center gap-2">
                <Upload className="w-4 h-4 text-amber-600" /> 복원
              </h4>
              <p className="text-sm text-gray-600 mb-3">
                백업한 JSON 파일을 선택하여 데이터를 복원합니다.<br/>
                <span className="text-red-500">⚠️ 현재 데이터가 덮어씌워집니다.</span>
              </p>
              <label className="w-full px-4 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 flex items-center justify-center gap-2 cursor-pointer">
                <Upload className="w-5 h-5" /> JSON 파일 선택
                <input type="file" accept=".json" onChange={(e) => { importAllData(e); setShowBackupModal(false); setBackupData(''); }} className="hidden" />
              </label>
            </div>
            
            <div className="flex justify-end mt-6">
              <button 
                onClick={() => { setShowBackupModal(false); setBackupData(''); }} 
                className="px-4 py-2 border rounded-lg"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Cycle Time 그래프 모달 */}
      {showGraphModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-5xl m-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg">📊 Cycle Time 그래프</h3>
              <button onClick={() => setShowGraphModal(false)}><X className="w-5 h-5" /></button>
            </div>
            
            {/* 기간 선택 */}
            <div className="bg-gray-50 rounded-lg p-4 mb-6">
              <div className="flex flex-wrap gap-4 items-end">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">조회 방식</label>
                  <select 
                    className="border rounded-lg px-3 py-2"
                    value={graphViewType}
                    onChange={e => setGraphViewType(e.target.value)}
                  >
                    <option value="monthly">월별 추이</option>
                    <option value="daily">일별 (특정 월)</option>
                    <option value="custom">기간 지정</option>
                  </select>
                </div>
                
                {graphViewType === 'daily' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">월 선택</label>
                    <input 
                      type="month" 
                      className="border rounded-lg px-3 py-2"
                      value={selectedMonth}
                      onChange={e => setSelectedMonth(e.target.value)}
                    />
                  </div>
                )}
                
                {graphViewType === 'custom' && (
                  <>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">시작일</label>
                      <input 
                        type="date" 
                        className="border rounded-lg px-3 py-2"
                        value={graphDateRange.start}
                        onChange={e => setGraphDateRange({...graphDateRange, start: e.target.value})}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">종료일</label>
                      <input 
                        type="date" 
                        className="border rounded-lg px-3 py-2"
                        value={graphDateRange.end}
                        onChange={e => setGraphDateRange({...graphDateRange, end: e.target.value})}
                      />
                    </div>
                  </>
                )}
              </div>
            </div>
            
            {/* 그래프 영역 */}
            {(() => {
              // 완료된 데이터만 필터링
              const completedPicks = pickCycles.filter(p => p.status === 'completed' && p.cycleMin && p.completed);
              
              let chartData = [];
              let chartTitle = '';
              
              if (graphViewType === 'monthly') {
                // 월별 데이터 집계
                const monthlyData = {};
                completedPicks.forEach(p => {
                  const month = p.completed.slice(0, 7); // YYYY-MM
                  if (!monthlyData[month]) {
                    monthlyData[month] = { total: 0, count: 0, mx48: [], mx16: [], hsm: [], spare: [] };
                  }
                  monthlyData[month].total += p.cycleMin;
                  monthlyData[month].count += 1;
                  
                  if (['RSC48', 'CSC48'].includes(p.model)) monthlyData[month].mx48.push(p.cycleMin);
                  else if (['RSC16', 'CSC16', 'FSC16'].includes(p.model)) monthlyData[month].mx16.push(p.cycleMin);
                  else if (p.model === 'HSM3.0') monthlyData[month].hsm.push(p.cycleMin);
                  else monthlyData[month].spare.push(p.cycleMin);
                });
                
                chartData = Object.entries(monthlyData)
                  .sort((a, b) => a[0].localeCompare(b[0]))
                  .map(([month, data]) => ({
                    label: month,
                    avg: Math.round(data.total / data.count),
                    count: data.count,
                    mx48: data.mx48.length ? Math.round(data.mx48.reduce((a,b) => a+b, 0) / data.mx48.length) : null,
                    mx16: data.mx16.length ? Math.round(data.mx16.reduce((a,b) => a+b, 0) / data.mx16.length) : null,
                    hsm: data.hsm.length ? Math.round(data.hsm.reduce((a,b) => a+b, 0) / data.hsm.length) : null,
                    spare: data.spare.length ? Math.round(data.spare.reduce((a,b) => a+b, 0) / data.spare.length) : null,
                  }));
                chartTitle = '월별 평균 Cycle Time 추이';
              } else if (graphViewType === 'daily') {
                // 특정 월의 일별 데이터
                const dailyData = {};
                completedPicks
                  .filter(p => p.completed.startsWith(selectedMonth))
                  .forEach(p => {
                    const day = p.completed.slice(0, 10); // YYYY-MM-DD
                    if (!dailyData[day]) {
                      dailyData[day] = { total: 0, count: 0, mx48: [], mx16: [], hsm: [], spare: [] };
                    }
                    dailyData[day].total += p.cycleMin;
                    dailyData[day].count += 1;
                    
                    if (['RSC48', 'CSC48'].includes(p.model)) dailyData[day].mx48.push(p.cycleMin);
                    else if (['RSC16', 'CSC16', 'FSC16'].includes(p.model)) dailyData[day].mx16.push(p.cycleMin);
                    else if (p.model === 'HSM3.0') dailyData[day].hsm.push(p.cycleMin);
                    else dailyData[day].spare.push(p.cycleMin);
                  });
                
                chartData = Object.entries(dailyData)
                  .sort((a, b) => a[0].localeCompare(b[0]))
                  .map(([day, data]) => ({
                    label: day.slice(5), // MM-DD
                    avg: Math.round(data.total / data.count),
                    count: data.count,
                    mx48: data.mx48.length ? Math.round(data.mx48.reduce((a,b) => a+b, 0) / data.mx48.length) : null,
                    mx16: data.mx16.length ? Math.round(data.mx16.reduce((a,b) => a+b, 0) / data.mx16.length) : null,
                    hsm: data.hsm.length ? Math.round(data.hsm.reduce((a,b) => a+b, 0) / data.hsm.length) : null,
                    spare: data.spare.length ? Math.round(data.spare.reduce((a,b) => a+b, 0) / data.spare.length) : null,
                  }));
                chartTitle = `${selectedMonth} 일별 평균 Cycle Time`;
              } else {
                // 기간 지정
                const { start, end } = graphDateRange;
                if (start && end) {
                  const dailyData = {};
                  completedPicks
                    .filter(p => {
                      const date = p.completed.slice(0, 10);
                      return date >= start && date <= end;
                    })
                    .forEach(p => {
                      const day = p.completed.slice(0, 10);
                      if (!dailyData[day]) {
                        dailyData[day] = { total: 0, count: 0, mx48: [], mx16: [], hsm: [], spare: [] };
                      }
                      dailyData[day].total += p.cycleMin;
                      dailyData[day].count += 1;
                      
                      if (['RSC48', 'CSC48'].includes(p.model)) dailyData[day].mx48.push(p.cycleMin);
                      else if (['RSC16', 'CSC16', 'FSC16'].includes(p.model)) dailyData[day].mx16.push(p.cycleMin);
                      else if (p.model === 'HSM3.0') dailyData[day].hsm.push(p.cycleMin);
                      else dailyData[day].spare.push(p.cycleMin);
                    });
                  
                  chartData = Object.entries(dailyData)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([day, data]) => ({
                      label: day.slice(5),
                      avg: Math.round(data.total / data.count),
                      count: data.count,
                      mx48: data.mx48.length ? Math.round(data.mx48.reduce((a,b) => a+b, 0) / data.mx48.length) : null,
                      mx16: data.mx16.length ? Math.round(data.mx16.reduce((a,b) => a+b, 0) / data.mx16.length) : null,
                      hsm: data.hsm.length ? Math.round(data.hsm.reduce((a,b) => a+b, 0) / data.hsm.length) : null,
                      spare: data.spare.length ? Math.round(data.spare.reduce((a,b) => a+b, 0) / data.spare.length) : null,
                    }));
                  chartTitle = `${start} ~ ${end} Cycle Time`;
                }
              }
              
              const maxValue = Math.max(...chartData.flatMap(d => [d.avg, d.mx48, d.mx16, d.hsm, d.spare].filter(v => v !== null)), 60);
              
              return (
                <div>
                  <h4 className="font-medium text-gray-700 mb-4">{chartTitle}</h4>
                  
                  {chartData.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      해당 기간에 완료된 데이터가 없습니다.
                    </div>
                  ) : (
                    <>
                      {/* 범례 */}
                      <div className="flex gap-4 mb-4 text-sm">
                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-indigo-500"></span> 전체 평균</span>
                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-green-500"></span> Maxwell 48</span>
                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-blue-500"></span> Maxwell 16</span>
                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-orange-500"></span> HSM 3.0</span>
                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-gray-400"></span> Spare Parts</span>
                      </div>
                      
                      {/* 차트 */}
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="flex items-end gap-2 h-64 overflow-x-auto pb-4">
                          {chartData.map((d, i) => (
                            <div key={i} className="flex flex-col items-center min-w-[80px]">
                              <div className="flex items-end gap-1 h-48">
                                {/* 전체 평균 바 */}
                                <div 
                                  className="w-4 bg-indigo-500 rounded-t transition-all hover:bg-indigo-600"
                                  style={{ height: `${(d.avg / maxValue) * 100}%` }}
                                  title={`전체: ${d.avg}분`}
                                />
                                {/* Maxwell 48 바 */}
                                {d.mx48 && (
                                  <div 
                                    className="w-4 bg-green-500 rounded-t transition-all hover:bg-green-600"
                                    style={{ height: `${(d.mx48 / maxValue) * 100}%` }}
                                    title={`MX48: ${d.mx48}분`}
                                  />
                                )}
                                {/* Maxwell 16 바 */}
                                {d.mx16 && (
                                  <div 
                                    className="w-4 bg-blue-500 rounded-t transition-all hover:bg-blue-600"
                                    style={{ height: `${(d.mx16 / maxValue) * 100}%` }}
                                    title={`MX16: ${d.mx16}분`}
                                  />
                                )}
                                {/* HSM 바 */}
                                {d.hsm && (
                                  <div 
                                    className="w-4 bg-orange-500 rounded-t transition-all hover:bg-orange-600"
                                    style={{ height: `${(d.hsm / maxValue) * 100}%` }}
                                    title={`HSM: ${d.hsm}분`}
                                  />
                                )}
                                {/* Spare Parts 바 */}
                                {d.spare && (
                                  <div 
                                    className="w-4 bg-gray-400 rounded-t transition-all hover:bg-gray-500"
                                    style={{ height: `${(d.spare / maxValue) * 100}%` }}
                                    title={`Spare: ${d.spare}분`}
                                  />
                                )}
                              </div>
                              <div className="text-xs text-gray-600 mt-2 font-medium">{d.label}</div>
                              <div className="text-xs text-gray-400">n={d.count}</div>
                            </div>
                          ))}
                        </div>
                        
                        {/* Y축 기준선 */}
                        <div className="flex justify-between text-xs text-gray-400 mt-2">
                          <span>0분</span>
                          <span>{Math.round(maxValue/2)}분</span>
                          <span>{maxValue}분</span>
                        </div>
                      </div>
                      
                      {/* 요약 테이블 */}
                      <div className="mt-6">
                        <h4 className="font-medium text-gray-700 mb-2">상세 데이터</h4>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm border">
                            <thead className="bg-gray-100">
                              <tr>
                                <th className="px-3 py-2 border">기간</th>
                                <th className="px-3 py-2 border">건수</th>
                                <th className="px-3 py-2 border">전체 평균</th>
                                <th className="px-3 py-2 border text-green-600">Maxwell 48</th>
                                <th className="px-3 py-2 border text-blue-600">Maxwell 16</th>
                                <th className="px-3 py-2 border text-orange-600">HSM 3.0</th>
                                <th className="px-3 py-2 border text-gray-600">Spare Parts</th>
                              </tr>
                            </thead>
                            <tbody>
                              {chartData.map((d, i) => (
                                <tr key={i} className="hover:bg-gray-50">
                                  <td className="px-3 py-2 border font-medium">{d.label}</td>
                                  <td className="px-3 py-2 border text-center">{d.count}</td>
                                  <td className="px-3 py-2 border text-center font-bold text-indigo-600">{d.avg}분</td>
                                  <td className="px-3 py-2 border text-center text-green-600">{d.mx48 ? `${d.mx48}분` : '-'}</td>
                                  <td className="px-3 py-2 border text-center text-blue-600">{d.mx16 ? `${d.mx16}분` : '-'}</td>
                                  <td className="px-3 py-2 border text-center text-orange-600">{d.hsm ? `${d.hsm}분` : '-'}</td>
                                  <td className="px-3 py-2 border text-center text-gray-600">{d.spare ? `${d.spare}분` : '-'}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              );
            })()}
            
            <div className="flex justify-end mt-6">
              <button 
                onClick={() => setShowGraphModal(false)} 
                className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 카테고리 상세 모달 */}
      {selectedCategory && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg m-4 max-h-[80vh] overflow-hidden flex flex-col">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-2">
                <span className="text-2xl">{selectedCategory.icon}</span>
                <h3 className="font-semibold text-lg">{selectedCategory.label} 카테고리</h3>
              </div>
              <button onClick={() => setSelectedCategory(null)} className="text-gray-400 hover:text-gray-600">
                <X className="w-5 h-5" />
              </button>
            </div>

            <div className="flex gap-4 mb-4">
              <div className="flex-1 bg-blue-50 rounded-lg p-3 text-center">
                <div className="text-2xl font-bold text-blue-600">{selectedCategory.activeTodos.length}</div>
                <div className="text-xs text-gray-500">진행중</div>
              </div>
              <div className="flex-1 bg-green-50 rounded-lg p-3 text-center">
                <div className="text-2xl font-bold text-green-600">{selectedCategory.completedTodos.length}</div>
                <div className="text-xs text-gray-500">완료</div>
              </div>
              <div className="flex-1 bg-gray-50 rounded-lg p-3 text-center">
                <div className="text-2xl font-bold text-gray-600">{selectedCategory.activeTodos.length + selectedCategory.completedTodos.length}</div>
                <div className="text-xs text-gray-500">전체</div>
              </div>
            </div>

            <div className="flex-1 overflow-y-auto">
              {selectedCategory.activeTodos.length > 0 && (
                <div className="mb-4">
                  <h4 className="text-sm font-medium text-gray-500 mb-2">📌 진행중 ({selectedCategory.activeTodos.length})</h4>
                  <div className="space-y-2">
                    {selectedCategory.activeTodos.map(todo => (
                      <div 
                        key={todo.id} 
                        className={`p-3 rounded-lg border-l-4 ${
                          todo.priority === 'high' ? 'bg-red-50 border-red-400' :
                          todo.priority === 'medium' ? 'bg-yellow-50 border-yellow-400' :
                          'bg-green-50 border-green-400'
                        }`}
                      >
                        <div className="flex items-start justify-between gap-2">
                          <div className="flex-1">
                            <p className="font-medium">{todo.text}</p>
                            <div className="flex gap-2 mt-1 text-xs text-gray-500">
                              <span>{todo.priority === 'high' ? '🔴 높음' : todo.priority === 'medium' ? '🟡 보통' : '🟢 낮음'}</span>
                              {todo.dueDate && <span>📅 {todo.dueDate}</span>}
                            </div>
                          </div>
                          <button
                            onClick={() => {
                              updateTodo(todo.id, 'completed', true);
                              setSelectedCategory({
                                ...selectedCategory,
                                activeTodos: selectedCategory.activeTodos.filter(t => t.id !== todo.id),
                                completedTodos: [...selectedCategory.completedTodos, {...todo, completed: true}]
                              });
                            }}
                            className="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                          >
                            완료
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {selectedCategory.completedTodos.length > 0 && (
                <div>
                  <h4 className="text-sm font-medium text-gray-500 mb-2">✅ 완료 ({selectedCategory.completedTodos.length})</h4>
                  <div className="space-y-2">
                    {selectedCategory.completedTodos.map(todo => (
                      <div key={todo.id} className="p-3 rounded-lg bg-gray-50 border-l-4 border-gray-300">
                        <div className="flex items-start justify-between gap-2">
                          <div className="flex-1">
                            <p className="text-gray-400 line-through">{todo.text}</p>
                            <div className="flex gap-2 mt-1 text-xs text-gray-400">
                              {todo.dueDate && <span>📅 {todo.dueDate}</span>}
                            </div>
                          </div>
                          <button
                            onClick={() => {
                              updateTodo(todo.id, 'completed', false);
                              setSelectedCategory({
                                ...selectedCategory,
                                completedTodos: selectedCategory.completedTodos.filter(t => t.id !== todo.id),
                                activeTodos: [...selectedCategory.activeTodos, {...todo, completed: false}]
                              });
                            }}
                            className="px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500"
                          >
                            되돌리기
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {selectedCategory.activeTodos.length === 0 && selectedCategory.completedTodos.length === 0 && (
                <div className="text-center py-8 text-gray-400">
                  <div className="text-4xl mb-2">📭</div>
                  <p>이 카테고리에 할일이 없습니다.</p>
                </div>
              )}
            </div>

            <div className="mt-4 pt-4 border-t">
              <button onClick={() => setSelectedCategory(null)} className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 캘린더 할일 상세 모달 */}
      {selectedCalendarTodo && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4">
            <div className="flex justify-between items-start mb-4">
              <div className="flex items-center gap-2">
                <span className="text-2xl">
                  {selectedCalendarTodo.priority === 'high' ? '🔴' : selectedCalendarTodo.priority === 'medium' ? '🟡' : '🟢'}
                </span>
                <h3 className="font-semibold text-lg">할일 상세</h3>
              </div>
              <button onClick={() => setSelectedCalendarTodo(null)} className="text-gray-400 hover:text-gray-600">
                <X className="w-5 h-5" />
              </button>
            </div>

            <div className={`p-4 rounded-lg mb-4 ${
              selectedCalendarTodo.completed ? 'bg-gray-100' :
              selectedCalendarTodo.priority === 'high' ? 'bg-red-50' :
              selectedCalendarTodo.priority === 'medium' ? 'bg-yellow-50' : 'bg-green-50'
            }`}>
              <p className={`text-lg ${selectedCalendarTodo.completed ? 'line-through text-gray-400' : 'font-medium'}`}>
                {selectedCalendarTodo.text}
              </p>
            </div>

            <div className="space-y-3 mb-6">
              <div className="flex justify-between items-center">
                <span className="text-gray-500">상태</span>
                <span className={`px-2 py-1 rounded text-sm ${
                  selectedCalendarTodo.completed ? 'bg-gray-200 text-gray-600' : 'bg-blue-100 text-blue-700'
                }`}>
                  {selectedCalendarTodo.completed ? '✓ 완료' : '진행중'}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-gray-500">카테고리</span>
                <span className={`px-2 py-1 rounded text-sm ${
                  selectedCalendarTodo.category === 'data' ? 'bg-blue-100 text-blue-700' :
                  selectedCalendarTodo.category === 'process' ? 'bg-purple-100 text-purple-700' :
                  selectedCalendarTodo.category === 'kpi' ? 'bg-orange-100 text-orange-600' :
                  selectedCalendarTodo.category === 'system' ? 'bg-cyan-100 text-cyan-700' :
                  selectedCalendarTodo.category === 'idea' ? 'bg-pink-100 text-pink-700' :
                  'bg-gray-100 text-gray-700'
                }`}>
                  {selectedCalendarTodo.category === 'data' ? '📊 데이터' :
                   selectedCalendarTodo.category === 'process' ? '⚙️ 프로세스' :
                   selectedCalendarTodo.category === 'kpi' ? '📈 KPI' :
                   selectedCalendarTodo.category === 'system' ? '💻 시스템' :
                   selectedCalendarTodo.category === 'idea' ? '💡 아이디어' : '📋 일반'}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-gray-500">우선순위</span>
                <span>
                  {selectedCalendarTodo.priority === 'high' ? '🔴 높음' : 
                   selectedCalendarTodo.priority === 'medium' ? '🟡 보통' : '🟢 낮음'}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-gray-500">마감일</span>
                <span className="font-medium">{selectedCalendarTodo.dueDate || '-'}</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-gray-500">생성일</span>
                <span>{selectedCalendarTodo.createdAt}</span>
              </div>
            </div>

            <div className="flex gap-3">
              <button 
                onClick={() => {
                  updateTodo(selectedCalendarTodo.id, 'completed', !selectedCalendarTodo.completed);
                  setSelectedCalendarTodo({...selectedCalendarTodo, completed: !selectedCalendarTodo.completed});
                }}
                className={`flex-1 px-4 py-2 rounded-lg font-medium ${
                  selectedCalendarTodo.completed 
                    ? 'bg-blue-600 text-white hover:bg-blue-700' 
                    : 'bg-green-600 text-white hover:bg-green-700'
                }`}
              >
                {selectedCalendarTodo.completed ? '↩️ 미완료로 변경' : '✓ 완료하기'}
              </button>
              <button 
                onClick={() => {
                  setDeleteConfirm({ show: true, type: 'todo', id: selectedCalendarTodo.id, text: selectedCalendarTodo.text, count: 0 });
                  setSelectedCalendarTodo(null);
                }}
                className="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-400"
              >
                🗑️ 삭제
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 삭제 확인 모달 */}
      {deleteConfirm.show && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm m-4">
            <div className="text-center">
              <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <AlertTriangle className="w-8 h-8 text-red-600" />
              </div>
              <h3 className="font-semibold text-lg mb-2">삭제 확인</h3>
              <p className="text-gray-600 mb-2">
                {deleteConfirm.type === 'todo' && (
                  <>"{deleteConfirm.text}" 항목을 삭제하시겠습니까?</>
                )}
                {deleteConfirm.type === 'pick' && (
                  <>선택한 <strong>{deleteConfirm.count}개</strong> 불출 기록을 삭제하시겠습니까?</>
                )}
                {deleteConfirm.type === 'receive' && (
                  <>선택한 <strong>{deleteConfirm.count}개</strong> 입고 기록을 삭제하시겠습니까?</>
                )}
                {deleteConfirm.type === 'kitting' && (
                  <>선택한 <strong>{deleteConfirm.count}개</strong> Kitting 기록을 삭제하시겠습니까?</>
                )}
              </p>
              <p className="text-sm text-red-500 mb-4">⚠️ 삭제된 데이터는 복구할 수 없습니다.</p>
              <div className="flex gap-3">
                <button 
                  onClick={() => setDeleteConfirm({ show: false, type: '', id: null, text: '', count: 0 })}
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                  취소
                </button>
                <button 
                  onClick={() => {
                    if (deleteConfirm.type === 'todo') confirmDeleteTodo();
                    else if (deleteConfirm.type === 'pick') confirmDeletePicks();
                    else if (deleteConfirm.type === 'receive') confirmDeleteReceives();
                    else if (deleteConfirm.type === 'kitting') confirmDeleteKittings();
                  }}
                  className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                >
                  삭제
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Kitting 추가 모달 */}
      {showKittingModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4">
            <h3 className="font-semibold text-lg mb-4">새 Kitting 기록</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Production Order *</label>
                <input 
                  type="text" 
                  className="w-full border rounded-lg px-3 py-2"
                  value={newKitting.productionOrder}
                  onChange={e => setNewKitting({...newKitting, productionOrder: e.target.value})}
                  placeholder="예: 1426630"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Model</label>
                <select 
                  className="w-full border rounded-lg px-3 py-2"
                  value={newKitting.model}
                  onChange={e => setNewKitting({...newKitting, model: e.target.value})}
                >
                  <option value="RSC48">RSC48</option>
                  <option value="CSC48">CSC48</option>
                  <option value="RSC16">RSC16</option>
                  <option value="CSC16">CSC16</option>
                  <option value="FSC16">FSC16</option>
                  <option value="HSM3.0">HSM3.0</option>
                  <option value="Spare Parts">Spare Parts</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">시작예정일</label>
                <input 
                  type="date" 
                  className="w-full border rounded-lg px-3 py-2"
                  value={newKitting.basicStartDate}
                  onChange={e => setNewKitting({...newKitting, basicStartDate: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">담당자</label>
                <select 
                  className="w-full border rounded-lg px-3 py-2"
                  value={newKitting.worker}
                  onChange={e => setNewKitting({...newKitting, worker: e.target.value})}
                >
                  <option value="Z01">Z01</option>
                  <option value="Z02">Z02</option>
                  <option value="Z03">Z03</option>
                  <option value="Z04">Z04</option>
                  <option value="Z06">Z06</option>
                </select>
              </div>
              <div className="flex items-center gap-2">
                <input 
                  type="checkbox" 
                  id="kitting-urgent"
                  checked={newKitting.isUrgent}
                  onChange={e => setNewKitting({...newKitting, isUrgent: e.target.checked})}
                  className="w-4 h-4"
                />
                <label htmlFor="kitting-urgent" className="text-sm">🚨 긴급</label>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button 
                onClick={() => setShowKittingModal(false)}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                취소
              </button>
              <button 
                onClick={addKitting}
                className="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700"
              >
                추가
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Kitting 수정 모달 */}
      {editingKitting && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md m-4">
            <h3 className="font-semibold text-lg mb-4">Kitting 수정</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Production Order</label>
                <input 
                  type="text" 
                  className="w-full border rounded-lg px-3 py-2"
                  value={editingKitting.productionOrder}
                  onChange={e => setEditingKitting({...editingKitting, productionOrder: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Model</label>
                <select 
                  className="w-full border rounded-lg px-3 py-2"
                  value={editingKitting.model}
                  onChange={e => setEditingKitting({...editingKitting, model: e.target.value})}
                >
                  <option value="RSC48">RSC48</option>
                  <option value="CSC48">CSC48</option>
                  <option value="RSC16">RSC16</option>
                  <option value="CSC16">CSC16</option>
                  <option value="FSC16">FSC16</option>
                  <option value="HSM3.0">HSM3.0</option>
                  <option value="Spare Parts">Spare Parts</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Material Description</label>
                <input 
                  type="text" 
                  className="w-full border rounded-lg px-3 py-2"
                  value={editingKitting.materialDesc || ''}
                  onChange={e => setEditingKitting({...editingKitting, materialDesc: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">시작예정일</label>
                <input 
                  type="date" 
                  className="w-full border rounded-lg px-3 py-2"
                  value={editingKitting.basicStartDate || ''}
                  onChange={e => setEditingKitting({...editingKitting, basicStartDate: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">완료일</label>
                <input 
                  type="date" 
                  className="w-full border rounded-lg px-3 py-2"
                  value={editingKitting.completedAt || ''}
                  onChange={e => {
                    const completedAt = e.target.value;
                    let leadTimeDays = null;
                    if (completedAt && editingKitting.basicStartDate) {
                      const start = new Date(editingKitting.basicStartDate);
                      const end = new Date(completedAt);
                      leadTimeDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                    }
                    setEditingKitting({
                      ...editingKitting, 
                      completedAt, 
                      leadTimeDays,
                      status: completedAt ? 'completed' : editingKitting.status
                    });
                  }}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">상태</label>
                <select 
                  className="w-full border rounded-lg px-3 py-2"
                  value={editingKitting.status}
                  onChange={e => setEditingKitting({...editingKitting, status: e.target.value})}
                >
                  <option value="waiting">대기</option>
                  <option value="in-progress">진행중</option>
                  <option value="completed">완료</option>
                </select>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button 
                onClick={() => setEditingKitting(null)}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                취소
              </button>
              <button 
                onClick={saveEditKitting}
                className="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700"
              >
                저장
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Kitting 그래프 모달 */}
      {showKittingGraphModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-5xl m-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <h3 className="font-semibold text-lg">📊 Kitting Lead Time 그래프</h3>
              <button onClick={() => setShowKittingGraphModal(false)} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>

            {(() => {
              // 최근 6개월 데이터 계산
              const months = [];
              for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                months.push(d.toISOString().slice(0, 7));
              }

              const chartData = months.map(month => {
                const monthData = kittingData.filter(k => 
                  k.basicStartDate?.startsWith(month) || k.completedAt?.startsWith(month)
                );
                const completed = monthData.filter(k => k.status === 'completed');
                const within3Days = completed.filter(k => k.leadTimeDays && k.leadTimeDays <= 3).length;
                const avgLeadTime = completed.length > 0
                  ? (completed.reduce((sum, k) => sum + (k.leadTimeDays || 0), 0) / completed.length).toFixed(1)
                  : 0;
                const rate = completed.length > 0 ? Math.round((within3Days / completed.length) * 100) : 0;

                // 모델별 통계
                const mx48 = completed.filter(k => ['RSC48', 'CSC48'].includes(k.model));
                const mx16 = completed.filter(k => ['RSC16', 'CSC16', 'FSC16'].includes(k.model));
                const hsm = completed.filter(k => k.model === 'HSM3.0');
                const spare = completed.filter(k => k.model === 'Spare Parts');

                return {
                  month,
                  label: `${month.split('-')[1]}월`,
                  total: monthData.length,
                  completed: completed.length,
                  avgLeadTime: parseFloat(avgLeadTime),
                  rate,
                  mx48: mx48.length,
                  mx16: mx16.length,
                  hsm: hsm.length,
                  spare: spare.length
                };
              });

              const maxCompleted = Math.max(...chartData.map(d => d.completed), 1);
              const maxRate = 100;

              return (
                <div className="space-y-6">
                  {/* 월별 완료 건수 & 3일 이내 완료율 */}
                  <div className="bg-gray-50 rounded-lg p-4">
                    <h4 className="font-medium text-gray-700 mb-4">월별 완료 건수 & 3일 이내 완료율</h4>
                    <div className="flex items-end gap-2 h-48">
                      {chartData.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col items-center">
                          <div className="w-full flex gap-1 justify-center items-end h-40">
                            {/* 완료 건수 바 */}
                            <div 
                              className="w-6 bg-teal-500 rounded-t transition-all"
                              style={{ height: `${(d.completed / maxCompleted) * 100}%` }}
                              title={`완료: ${d.completed}건`}
                            />
                            {/* 3일 이내 완료율 바 */}
                            <div 
                              className="w-6 bg-green-400 rounded-t transition-all"
                              style={{ height: `${d.rate}%` }}
                              title={`3일 이내: ${d.rate}%`}
                            />
                          </div>
                          <div className="text-xs text-gray-500 mt-2">{d.label}</div>
                          <div className="text-xs font-medium text-teal-600">{d.completed}건</div>
                          <div className="text-xs text-green-600">{d.rate}%</div>
                        </div>
                      ))}
                    </div>
                    <div className="flex justify-center gap-6 mt-4 text-sm">
                      <span className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-teal-500 rounded"></span> 완료 건수
                      </span>
                      <span className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-green-400 rounded"></span> 3일 이내 완료율
                      </span>
                    </div>
                  </div>

                  {/* 평균 Lead Time 추이 */}
                  <div className="bg-gray-50 rounded-lg p-4">
                    <h4 className="font-medium text-gray-700 mb-4">평균 Lead Time 추이 (목표: 3일 이내)</h4>
                    <div className="relative h-40">
                      {/* 3일 기준선 */}
                      <div className="absolute w-full border-t-2 border-dashed border-red-400" style={{ bottom: '60%' }}>
                        <span className="absolute right-0 -top-4 text-xs text-red-500">목표: 3일</span>
                      </div>
                      <div className="flex items-end gap-2 h-full">
                        {chartData.map((d, i) => (
                          <div key={i} className="flex-1 flex flex-col items-center">
                            <div className="w-full flex justify-center items-end h-32">
                              <div 
                                className={`w-10 rounded-t transition-all ${d.avgLeadTime <= 3 ? 'bg-green-500' : d.avgLeadTime <= 5 ? 'bg-amber-500' : 'bg-red-500'}`}
                                style={{ height: `${Math.min((d.avgLeadTime / 7) * 100, 100)}%` }}
                                title={`평균: ${d.avgLeadTime}일`}
                              />
                            </div>
                            <div className="text-xs text-gray-500 mt-2">{d.label}</div>
                            <div className={`text-sm font-bold ${d.avgLeadTime <= 3 ? 'text-green-600' : d.avgLeadTime <= 5 ? 'text-amber-600' : 'text-red-600'}`}>
                              {d.avgLeadTime}일
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* 모델별 완료 현황 */}
                  <div className="bg-gray-50 rounded-lg p-4">
                    <h4 className="font-medium text-gray-700 mb-4">모델별 완료 현황</h4>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm border">
                        <thead className="bg-gray-100">
                          <tr>
                            <th className="px-3 py-2 border">월</th>
                            <th className="px-3 py-2 border">전체 완료</th>
                            <th className="px-3 py-2 border">평균 Lead Time</th>
                            <th className="px-3 py-2 border">3일 이내율</th>
                            <th className="px-3 py-2 border text-emerald-600">Maxwell 48</th>
                            <th className="px-3 py-2 border text-blue-600">Maxwell 16</th>
                            <th className="px-3 py-2 border text-orange-600">HSM 3.0</th>
                            <th className="px-3 py-2 border text-gray-600">Spare Parts</th>
                          </tr>
                        </thead>
                        <tbody>
                          {chartData.map((d, i) => (
                            <tr key={i} className="hover:bg-gray-50">
                              <td className="px-3 py-2 border font-medium">{d.label}</td>
                              <td className="px-3 py-2 border text-center font-bold text-teal-600">{d.completed}건</td>
                              <td className={`px-3 py-2 border text-center font-bold ${d.avgLeadTime <= 3 ? 'text-green-600' : d.avgLeadTime <= 5 ? 'text-amber-600' : 'text-red-600'}`}>
                                {d.avgLeadTime}일
                              </td>
                              <td className={`px-3 py-2 border text-center ${d.rate >= 80 ? 'text-green-600' : d.rate >= 60 ? 'text-amber-600' : 'text-red-600'}`}>
                                {d.rate}%
                              </td>
                              <td className="px-3 py-2 border text-center text-emerald-600">{d.mx48}건</td>
                              <td className="px-3 py-2 border text-center text-blue-600">{d.mx16}건</td>
                              <td className="px-3 py-2 border text-center text-orange-600">{d.hsm}건</td>
                              <td className="px-3 py-2 border text-center text-gray-600">{d.spare}건</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div className="flex justify-end">
                    <button 
                      onClick={() => setShowKittingGraphModal(false)}
                      className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                    >
                      닫기
                    </button>
                  </div>
                </div>
              );
            })()}
          </div>
        </div>
      )}

      {/* 입고 Cycle 그래프 모달 */}
      {showReceiveGraphModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-5xl flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }}>
            {(() => {
              // 최근 6개월 데이터 계산
              const months = [];
              for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                months.push(d.toISOString().slice(0, 7));
              }
              
              const chartData = months.map(month => {
                const monthReceives = receiveCycles.filter(r => 
                  r.status === 'completed' && 
                  (r.migo?.startsWith(month) || r.delivery?.startsWith(month))
                );
                
                const avgTime = monthReceives.length > 0
                  ? Math.round(monthReceives.reduce((s, r) => s + (r.cycleMin || 0), 0) / monthReceives.length)
                  : 0;
                
                // 60분 이내 달성률
                const under60 = monthReceives.filter(r => r.cycleMin && r.cycleMin <= 60).length;
                const rate = monthReceives.length > 0 ? Math.round((under60 / monthReceives.length) * 100) : 0;
                
                // 협력업체별 통계
                const vendorStats = {};
                monthReceives.forEach(r => {
                  if (r.vendor) {
                    if (!vendorStats[r.vendor]) vendorStats[r.vendor] = { count: 0, totalTime: 0 };
                    vendorStats[r.vendor].count++;
                    vendorStats[r.vendor].totalTime += r.cycleMin || 0;
                  }
                });
                
                return {
                  month,
                  label: `${month.split('-')[1]}월`,
                  completed: monthReceives.length,
                  avgTime,
                  rate,
                  vendorStats
                };
              });
              
              const maxCompleted = Math.max(...chartData.map(d => d.completed), 1);
              
              return (
                <>
                  {/* 고정 헤더 */}
                  <div className="flex-shrink-0 flex justify-between items-center p-6 border-b">
                    <h3 className="font-semibold text-lg">📊 입고 Cycle Time 그래프</h3>
                    <button onClick={() => setShowReceiveGraphModal(false)}><X className="w-5 h-5" /></button>
                  </div>
                  
                  {/* 스크롤 가능한 콘텐츠 */}
                  <div className="flex-1 overflow-y-auto min-h-0 p-6">
                    <div className="space-y-6">
                      {/* 요약 카드 */}
                      <div className="grid grid-cols-4 gap-4">
                        <div className="bg-purple-50 rounded-xl p-4 text-center">
                          <p className="text-sm text-purple-600">6개월 총 입고</p>
                          <p className="text-3xl font-bold text-purple-700">{chartData.reduce((s, d) => s + d.completed, 0)}건</p>
                        </div>
                        <div className="bg-blue-50 rounded-xl p-4 text-center">
                          <p className="text-sm text-blue-600">6개월 평균 시간</p>
                          <p className="text-3xl font-bold text-blue-700">
                            {chartData.filter(d => d.completed > 0).length > 0
                              ? Math.round(chartData.filter(d => d.completed > 0).reduce((s, d) => s + d.avgTime, 0) / chartData.filter(d => d.completed > 0).length)
                              : 0}분
                          </p>
                        </div>
                        <div className="bg-emerald-50 rounded-xl p-4 text-center">
                          <p className="text-sm text-emerald-600">60분 이내 달성률</p>
                          <p className="text-3xl font-bold text-emerald-700">
                            {chartData.filter(d => d.completed > 0).length > 0
                              ? Math.round(chartData.filter(d => d.completed > 0).reduce((s, d) => s + d.rate, 0) / chartData.filter(d => d.completed > 0).length)
                              : 0}%
                          </p>
                        </div>
                        <div className="bg-orange-50 rounded-xl p-4 text-center">
                          <p className="text-sm text-orange-600">이번 달 입고</p>
                          <p className="text-3xl font-bold text-orange-700">{chartData[chartData.length - 1]?.completed || 0}건</p>
                        </div>
                      </div>
                      
                      {/* 막대 그래프 */}
                      <div className="bg-gray-50 rounded-xl p-6">
                        <h4 className="font-medium text-gray-700 mb-4">월별 입고 완료 건수 & 평균 시간</h4>
                        <div className="flex items-end justify-between h-48 gap-4">
                          {chartData.map((d, i) => (
                            <div key={i} className="flex-1 flex flex-col items-center">
                              <div className="text-sm font-bold mb-1 text-purple-600">{d.completed}건</div>
                              <div className="w-full flex flex-col items-center justify-end h-32">
                                <div 
                                  className="w-full bg-gradient-to-t from-purple-500 to-purple-400 rounded-t transition-all hover:from-purple-600 hover:to-purple-500"
                                  style={{ height: `${(d.completed / maxCompleted) * 100}%`, minHeight: d.completed > 0 ? '8px' : '0' }}
                                  title={`${d.completed}건 완료`}
                                />
                              </div>
                              <div className="text-xs text-gray-500 mt-2">{d.label}</div>
                              <div className={`text-xs font-bold mt-1 ${d.avgTime <= 60 ? 'text-green-600' : d.avgTime <= 90 ? 'text-amber-600' : 'text-red-600'}`}>
                                {d.avgTime}분
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* 60분 이내 달성률 그래프 */}
                      <div className="bg-gray-50 rounded-xl p-6">
                        <h4 className="font-medium text-gray-700 mb-4">월별 60분 이내 달성률 (목표: 80%)</h4>
                        <div className="flex items-end justify-between h-32 gap-4">
                          {chartData.map((d, i) => (
                            <div key={i} className="flex-1 flex flex-col items-center">
                              <div className={`text-sm font-bold mb-1 ${d.rate >= 80 ? 'text-green-600' : d.rate >= 60 ? 'text-amber-600' : 'text-red-600'}`}>
                                {d.rate}%
                              </div>
                              <div className="w-full flex flex-col items-center justify-end h-24 relative">
                                {/* 80% 목표선 */}
                                <div className="absolute w-full border-t-2 border-dashed border-green-400" style={{ bottom: '80%' }} />
                                <div 
                                  className={`w-full rounded-t transition-all ${d.rate >= 80 ? 'bg-green-500' : d.rate >= 60 ? 'bg-amber-500' : 'bg-red-500'}`}
                                  style={{ height: `${d.rate}%`, minHeight: d.rate > 0 ? '4px' : '0' }}
                                />
                              </div>
                              <div className="text-xs text-gray-500 mt-2">{d.label}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* 월별 상세 테이블 */}
                      <div className="bg-white border rounded-xl overflow-hidden">
                        <h4 className="font-medium text-gray-700 p-4 bg-gray-50 border-b">월별 상세 데이터</h4>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead className="bg-gray-100">
                              <tr>
                                <th className="px-3 py-2 border">월</th>
                                <th className="px-3 py-2 border">완료 건수</th>
                                <th className="px-3 py-2 border">평균 시간</th>
                                <th className="px-3 py-2 border">60분 이내율</th>
                                <th className="px-3 py-2 border">최다 업체</th>
                              </tr>
                            </thead>
                            <tbody>
                              {chartData.map((d, i) => {
                                const topVendor = Object.entries(d.vendorStats).sort((a, b) => b[1].count - a[1].count)[0];
                                return (
                                  <tr key={i} className="hover:bg-gray-50">
                                    <td className="px-3 py-2 border font-medium">{d.label}</td>
                                    <td className="px-3 py-2 border text-center font-bold text-purple-600">{d.completed}건</td>
                                    <td className={`px-3 py-2 border text-center font-bold ${d.avgTime <= 60 ? 'text-green-600' : d.avgTime <= 90 ? 'text-amber-600' : 'text-red-600'}`}>
                                      {d.avgTime}분
                                    </td>
                                    <td className={`px-3 py-2 border text-center ${d.rate >= 80 ? 'text-green-600' : d.rate >= 60 ? 'text-amber-600' : 'text-red-600'}`}>
                                      {d.rate}%
                                    </td>
                                    <td className="px-3 py-2 border text-center text-gray-600">
                                      {topVendor ? `${topVendor[0]} (${topVendor[1].count}건)` : '-'}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* 고정 푸터 */}
                  <div className="flex-shrink-0 flex justify-end p-6 border-t bg-gray-50">
                    <button 
                      onClick={() => setShowReceiveGraphModal(false)}
                      className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                    >
                      닫기
                    </button>
                  </div>
                </>
              );
            })()}
          </div>
        </div>
      )}

      {/* v15: 단축키 도움말 모달 */}
      {showShortcutHelp && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowShortcutHelp(false)}>
          <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-xl shadow-xl p-6 w-full max-w-md m-4`} onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg flex items-center gap-2">
                <Keyboard className="w-5 h-5 text-indigo-500" /> 키보드 단축키
              </h3>
              <button onClick={() => setShowShortcutHelp(false)}><X className="w-5 h-5" /></button>
            </div>
            <div className="space-y-3">
              {[
                { key: 'Ctrl + D', desc: '대시보드로 이동' },
                { key: 'Ctrl + M', desc: '새 입고 등록' },
                { key: 'Ctrl + K', desc: '새 Kitting 등록' },
                { key: 'Ctrl + B', desc: '백업/복원 열기' },
                { key: 'Ctrl + N', desc: '알림 센터 열기' },
                { key: 'Ctrl + ?', desc: '단축키 도움말 (현재)' },
                { key: 'ESC', desc: '모달 닫기' },
              ].map((item, idx) => (
                <div key={idx} className={`flex justify-between items-center py-2 px-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <span className={`font-mono text-sm px-2 py-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-white border'}`}>{item.key}</span>
                  <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{item.desc}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* v15: 알림 센터 모달 */}
      {showNotificationCenter && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowNotificationCenter(false)}>
          <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-xl shadow-xl p-6 w-full max-w-lg m-4 max-h-[80vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg flex items-center gap-2">
                <Bell className="w-5 h-5 text-indigo-500" /> 알림 센터
                {notifications.filter(n => !n.read).length > 0 && (
                  <span className="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">
                    {notifications.filter(n => !n.read).length} 새 알림
                  </span>
                )}
              </h3>
              <div className="flex items-center gap-2">
                {notifications.length > 0 && (
                  <>
                    <button 
                      onClick={markAllNotificationsAsRead}
                      className="text-xs text-blue-500 hover:text-blue-700"
                    >
                      모두 읽음
                    </button>
                    <button 
                      onClick={clearAllNotifications}
                      className="text-xs text-red-500 hover:text-red-700"
                    >
                      모두 삭제
                    </button>
                  </>
                )}
                <button onClick={() => setShowNotificationCenter(false)}><X className="w-5 h-5" /></button>
              </div>
            </div>
            <div className="flex-1 overflow-y-auto space-y-2">
              {/* 시스템 알림 (온습도, 업로드, 입고 미처리) */}
              {(() => {
                const sysAlerts = [];
                if (showTempAlert) sysAlerts.push({ id: 'sys-temp', type: 'warning', title: '🌡️ 온습도 미입력', message: '오늘의 온도/습도가 아직 입력되지 않았습니다.', action: () => { setActiveTab('temphumidity'); setShowNotificationCenter(false); } });
                if (showUploadAlert) sysAlerts.push({ id: 'sys-stock', type: 'error', title: '📊 재고 데이터 미업로드', message: 'ZBIN(Stock) 데이터를 업로드해주세요.', action: () => { setShowDataUploadModal(true); setShowNotificationCenter(false); } });
                if (showOpenPOAlert) sysAlerts.push({ id: 'sys-po', type: 'error', title: '📋 Open PO 미업로드', message: 'ME2N(Open PO) 데이터를 업로드해주세요.', action: () => { setShowOpenPOModal(true); setShowNotificationCenter(false); } });
                // 입고 미처리
                const now = new Date();
                const overdueReceives = receiveCycles.filter(r => {
                  if (r.status === 'completed') return false;
                  if (!r.startTime) return false;
                  return (now - new Date(r.startTime)) / (1000 * 60 * 60) >= 4;
                });
                if (overdueReceives.length > 0) sysAlerts.push({ id: 'sys-receive', type: 'error', title: `⚠️ 입고 미처리 ${overdueReceives.length}건`, message: `4시간 이상 MIGO 미완료: ${overdueReceives.map(r => r.vendor).join(', ')}`, action: () => { setActiveTab('receive'); setShowNotificationCenter(false); } });
                
                return sysAlerts.length > 0 ? (
                  <>
                    <p className="text-xs text-gray-400 font-medium mb-1">📌 시스템 알림</p>
                    {sysAlerts.map(a => (
                      <div key={a.id} className={`p-3 rounded-lg border cursor-pointer hover:shadow-md transition ${
                        a.type === 'error' ? 'bg-red-50 border-red-200' : 'bg-amber-50 border-amber-200'
                      }`} onClick={a.action}>
                        <p className="font-medium text-sm">{a.title}</p>
                        <p className="text-xs text-gray-600 mt-0.5">{a.message}</p>
                        <p className="text-xs text-indigo-500 mt-1">클릭하여 이동 →</p>
                      </div>
                    ))}
                    {notifications.length > 0 && <p className="text-xs text-gray-400 font-medium mt-3 mb-1">📝 일반 알림</p>}
                  </>
                ) : null;
              })()}
              
              {notifications.length === 0 && !showTempAlert && !showUploadAlert && !showOpenPOAlert ? (
                <div className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  <BellOff className="w-12 h-12 mx-auto mb-2 opacity-50" />
                  <p>알림이 없습니다</p>
                </div>
              ) : (
                notifications.map(n => (
                  <div 
                    key={n.id} 
                    className={`p-3 rounded-lg border ${
                      !n.read 
                        ? (darkMode ? 'bg-indigo-900/30 border-indigo-500' : 'bg-indigo-50 border-indigo-200') 
                        : (darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-200')
                    }`}
                  >
                    <div className="flex justify-between items-start">
                      <div className="flex items-start gap-2">
                        <span className={`mt-1 w-2 h-2 rounded-full ${
                          n.type === 'success' ? 'bg-emerald-500' :
                          n.type === 'warning' ? 'bg-amber-500' :
                          n.type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                        }`}></span>
                        <div>
                          <p className="font-medium text-sm">{n.title}</p>
                          <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{n.message}</p>
                          <p className={`text-xs mt-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            {getElapsedTimeDetail(n.timestamp)}
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-1">
                        {!n.read && (
                          <button 
                            onClick={() => markNotificationAsRead(n.id)}
                            className="text-xs text-blue-500 hover:text-blue-700"
                          >
                            읽음
                          </button>
                        )}
                        <button 
                          onClick={() => deleteNotification(n.id)}
                          className="text-gray-400 hover:text-red-500"
                        >
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      )}

      {/* v15: 데이터 히스토리 모달 */}
      {showHistoryModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowHistoryModal(false)}>
          <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-xl shadow-xl p-6 w-full max-w-lg m-4 max-h-[80vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-lg flex items-center gap-2">
                <History className="w-5 h-5 text-indigo-500" /> 데이터 업로드 히스토리
              </h3>
              <button onClick={() => setShowHistoryModal(false)}><X className="w-5 h-5" /></button>
            </div>
            <div className="flex-1 overflow-y-auto space-y-2">
              {dataHistory.length === 0 ? (
                <div className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  <Archive className="w-12 h-12 mx-auto mb-2 opacity-50" />
                  <p>업로드 히스토리가 없습니다</p>
                </div>
              ) : (
                dataHistory.map(h => (
                  <div key={h.id} className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <div className="flex justify-between items-center">
                      <div className="flex items-center gap-2">
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                          h.type === 'stock' ? 'bg-emerald-100 text-emerald-700' :
                          h.type === 'openPO' ? 'bg-amber-100 text-amber-700' :
                          h.type === 'bom' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'
                        }`}>
                          {h.type === 'stock' ? 'Stock' : h.type === 'openPO' ? 'Open PO' : h.type === 'bom' ? 'BOM' : h.type}
                        </span>
                        <span className="text-sm">{h.description}</span>
                      </div>
                      <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        {getElapsedTimeDetail(h.timestamp)}
                      </span>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      )}

      {/* v15: 공간 최적화 리포트 모달 */}
      {showSpaceOptimizationModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowSpaceOptimizationModal(false)}>
          <div 
            className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-xl shadow-xl w-full max-w-3xl flex flex-col`} 
            style={{ maxHeight: 'calc(100vh - 2rem)' }}
            onClick={e => e.stopPropagation()}
          >
            {/* 고정 헤더 */}
            <div className={`flex-shrink-0 flex justify-between items-center p-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
              <h3 className="font-semibold text-lg flex items-center gap-2">
                <Lightbulb className="w-5 h-5 text-amber-500" /> 공간 최적화 리포트
              </h3>
              <button 
                onClick={() => setShowSpaceOptimizationModal(false)}
                className={`p-2 rounded-lg hover:bg-gray-100 ${darkMode ? 'hover:bg-gray-700' : ''}`}
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            
            {/* 스크롤 가능한 컨텐츠 영역 */}
            <div className="flex-1 overflow-y-auto p-4" style={{ minHeight: 0 }}>
            {inventoryData.length === 0 ? (
              <div className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                <Database className="w-12 h-12 mx-auto mb-2 opacity-50" />
                <p>재고 데이터를 먼저 업로드해주세요</p>
              </div>
            ) : (
              <div className="space-y-4">
                {analyzeSpaceOptimization().map((suggestion, idx) => (
                  <div 
                    key={idx}
                    className={`p-4 rounded-lg border-l-4 ${
                      suggestion.priority === 'danger' ? 'bg-red-50 border-red-500' :
                      suggestion.priority === 'warning' ? 'bg-amber-50 border-amber-500' :
                      suggestion.priority === 'success' ? 'bg-emerald-50 border-emerald-500' :
                      'bg-blue-50 border-blue-500'
                    } ${darkMode ? 'bg-opacity-20' : ''}`}
                  >
                    <div className="flex items-start gap-3">
                      <div className={`p-2 rounded-full flex-shrink-0 ${
                        suggestion.priority === 'danger' ? 'bg-red-100' :
                        suggestion.priority === 'warning' ? 'bg-amber-100' :
                        suggestion.priority === 'success' ? 'bg-emerald-100' :
                        'bg-blue-100'
                      }`}>
                        {suggestion.type === 'utilization_score' ? (
                          <BarChart3 className={`w-5 h-5 ${
                            suggestion.priority === 'danger' ? 'text-red-600' :
                            suggestion.priority === 'warning' ? 'text-amber-600' :
                            suggestion.priority === 'success' ? 'text-emerald-600' :
                            'text-blue-600'
                          }`} />
                        ) : suggestion.type === 'empty_bins' ? (
                          <Package className="w-5 h-5 text-emerald-600" />
                        ) : suggestion.type === 'overloaded_bins' ? (
                          <AlertTriangle className="w-5 h-5 text-amber-600" />
                        ) : suggestion.type === 'weight_imbalance' ? (
                          <Scale className="w-5 h-5 text-amber-600" />
                        ) : suggestion.type === 'low_efficiency' ? (
                          <TrendingUp className="w-5 h-5 text-blue-600" />
                        ) : suggestion.type === 'relocation_recommendation' ? (
                          <ArrowRight className="w-5 h-5 text-indigo-600" />
                        ) : (
                          <Zap className="w-5 h-5 text-indigo-600" />
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 flex-wrap">
                          <h4 className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {suggestion.title}
                          </h4>
                          {suggestion.score !== undefined && (
                            <span className={`text-2xl font-bold ${
                              suggestion.score > 85 ? 'text-red-500' :
                              suggestion.score > 70 ? 'text-amber-500' :
                              suggestion.score > 50 ? 'text-blue-500' :
                              'text-emerald-500'
                            }`}>
                              {suggestion.score}%
                            </span>
                          )}
                        </div>
                        <p className={`text-sm mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                          {suggestion.description}
                        </p>
                        {suggestion.recommendation && (
                          <p className={`text-sm mt-1 italic ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            💡 {suggestion.recommendation}
                          </p>
                        )}
                        {suggestion.action && (
                          <p className={`text-sm mt-2 font-medium flex items-center gap-1 ${
                            suggestion.priority === 'danger' ? 'text-red-600' :
                            suggestion.priority === 'warning' ? 'text-amber-600' : 
                            'text-blue-600'
                          }`}>
                            <ArrowRight className="w-4 h-4 flex-shrink-0" /> {suggestion.action}
                          </p>
                        )}
                        
                        {/* 상세 정보 표시 */}
                        {suggestion.details && Array.isArray(suggestion.details) && suggestion.details.length > 0 && (
                          <div className="mt-3">
                            {suggestion.type === 'relocation_recommendation' ? (
                              <div className="space-y-1">
                                {suggestion.details.map((d, i) => (
                                  <div key={i} className={`text-xs p-2 rounded flex items-center gap-2 ${darkMode ? 'bg-gray-700' : 'bg-white border'}`}>
                                    <span className="font-medium text-red-500">{d.from}</span>
                                    <ArrowRight className="w-3 h-3" />
                                    <span className="font-medium text-emerald-500">{d.to}</span>
                                    <span className={`${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>({d.reason})</span>
                                  </div>
                                ))}
                              </div>
                            ) : suggestion.type === 'weight_imbalance' || suggestion.type === 'low_efficiency' ? (
                              <div className="flex flex-wrap gap-1">
                                {suggestion.details.map((d, i) => (
                                  <span key={i} className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700' : 'bg-white border'}`}>
                                    <span className="font-medium">{d.rack}</span>
                                    {d.weight && <span className="text-amber-600 ml-1">{d.weight}kg</span>}
                                    {d.efficiency !== undefined && <span className="text-blue-600 ml-1">{d.efficiency}%</span>}
                                    {d.overAvg && <span className="text-red-500 ml-1">(+{d.overAvg}%)</span>}
                                  </span>
                                ))}
                              </div>
                            ) : (
                              <div className="flex flex-wrap gap-1">
                                {suggestion.details.slice(0, 12).map((d, i) => (
                                  <span key={i} className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700' : 'bg-white border'}`}>
                                    {d.rack}-{d.bin} {d.count ? <span className="text-amber-600">({d.count}개)</span> : ''}
                                    {d.totalStock ? <span className="text-blue-600 ml-1">{d.totalStock}EA</span> : ''}
                                  </span>
                                ))}
                                {suggestion.details.length > 12 && (
                                  <span className={`text-xs px-2 py-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                    +{suggestion.details.length - 12}개 더
                                  </span>
                                )}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
                
                {/* 요약 */}
                <div className={`mt-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <h4 className="font-semibold mb-2">📊 요약</h4>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div>
                      <p className={`${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>총 품목</p>
                      <p className="font-bold">{inventoryData.length}개</p>
                    </div>
                    <div>
                      <p className={`${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>사용 중 랙</p>
                      <p className="font-bold">{rackSummary.length}개</p>
                    </div>
                    <div>
                      <p className={`${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>사용 중 Bin</p>
                      <p className="font-bold">{new Set(inventoryData.map(i => `${i.rack}-${i.bin}`)).size}개</p>
                    </div>
                    <div>
                      <p className={`${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>총 무게</p>
                      <p className="font-bold">{rackSummary.reduce((s, r) => s + r.weight, 0).toFixed(1)}kg</p>
                    </div>
                  </div>
                </div>
              </div>
            )}
            </div>
            
            {/* 고정 하단 버튼 */}
            <div className={`flex justify-end gap-2 p-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
              <button 
                onClick={() => setShowSpaceOptimizationModal(false)}
                className={`px-6 py-2 rounded-lg font-medium ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
              >
                닫기
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 엑셀 데이터 복사 모달 */}
      {exportModalData && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setExportModalData(null)}>
          <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }} onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center p-4 border-b">
              <h3 className="font-semibold text-lg">📋 데이터 내보내기 ({exportModalData.count}행)</h3>
              <button onClick={() => setExportModalData(null)} className="p-2 rounded-lg hover:bg-gray-100">
                <X className="w-5 h-5" />
              </button>
            </div>
            <div className="p-4">
              <p className="text-sm text-gray-500 mb-2">아래 텍스트를 전체 선택(Ctrl+A) → 복사(Ctrl+C) → 엑셀에 붙여넣기(Ctrl+V)</p>
              <textarea 
                readOnly 
                value={exportModalData.text} 
                className="w-full h-64 border rounded-lg p-3 text-xs font-mono bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                onFocus={e => e.target.select()}
              />
            </div>
            <div className="flex justify-end gap-2 p-4 border-t">
              <button 
                onClick={() => {
                  const textarea = document.querySelector('textarea[readOnly]');
                  if (textarea) { textarea.select(); document.execCommand('copy'); }
                }}
                className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm"
              >
                📋 전체 복사
              </button>
              <button onClick={() => setExportModalData(null)} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm">
                닫기
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


// ═══ React 앱 마운트 ═══
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(PBKWarehouseSystem));
</script>
</body>
</html>
